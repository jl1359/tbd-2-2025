This file is a merged representation of the entire codebase, combined into a single document by Repomix.

<file_summary>
This section contains a summary of this file.

<purpose>
This file contains a packed representation of the entire repository's contents.
It is designed to be easily consumable by AI systems for analysis, code review,
or other automated processes.
</purpose>

<file_format>
The content is organized as follows:
1. This summary section
2. Repository information
3. Directory structure
4. Repository files (if enabled)
5. Multiple file entries, each consisting of:
  - File path as an attribute
  - Full contents of the file
</file_format>

<usage_guidelines>
- This file should be treated as read-only. Any changes should be made to the
  original repository files, not this packed version.
- When processing this file, use the file path to distinguish
  between different files in the repository.
- Be aware that this file may contain sensitive information. Handle it with
  the same level of security as you would the original repository.
</usage_guidelines>

<notes>
- Some files may have been excluded based on .gitignore rules and Repomix's configuration
- Binary files are not included in this packed representation. Please refer to the Repository Structure section for a complete list of file paths, including binary files
- Files matching patterns in .gitignore are excluded
- Files matching default ignore patterns are excluded
- Files are sorted by Git change count (files with more changes are at the bottom)
</notes>

</file_summary>

<directory_structure>
.gitignore
backend/Dockerfile
backend/package.json
backend/prisma/schema.prisma
backend/prisma/seed.js
backend/src/app.js
backend/src/config/env.js
backend/src/config/prisma.js
backend/src/middlewares/auth.js
backend/src/middlewares/errorHandler.js
backend/src/middlewares/isAdmin.js
backend/src/modules/actividades/actividades.controller.js
backend/src/modules/actividades/actividades.routes.js
backend/src/modules/actividades/actividades.service.js
backend/src/modules/auth/auth.controller.js
backend/src/modules/auth/auth.routes.js
backend/src/modules/auth/auth.service.js
backend/src/modules/catalogos/catalogos.controller.js
backend/src/modules/catalogos/catalogos.routes.js
backend/src/modules/catalogos/catalogos.service.js
backend/src/modules/intercambios/intercambios.controller.js
backend/src/modules/intercambios/intercambios.routes.js
backend/src/modules/intercambios/intercambios.service.js
backend/src/modules/logros/logros.controller.js
backend/src/modules/logros/logros.routes.js
backend/src/modules/logros/logros.service.js
backend/src/modules/notificaciones/notificaciones.controller.js
backend/src/modules/notificaciones/notificaciones.routes.js
backend/src/modules/notificaciones/notificaciones.service.js
backend/src/modules/premium/premium.controller.js
backend/src/modules/premium/premium.routes.js
backend/src/modules/premium/premium.service.js
backend/src/modules/promociones/promociones.controller.js
backend/src/modules/promociones/promociones.routes.js
backend/src/modules/promociones/promociones.service.js
backend/src/modules/publicaciones/publicaciones.controller.js
backend/src/modules/publicaciones/publicaciones.routes.js
backend/src/modules/publicaciones/publicaciones.service.js
backend/src/modules/publicidad/publicidad.controller.js
backend/src/modules/publicidad/publicidad.routes.js
backend/src/modules/publicidad/publicidad.service.js
backend/src/modules/reportes/reportes.controller.js
backend/src/modules/reportes/reportes.routes.js
backend/src/modules/uploads/multer.js
backend/src/modules/uploads/uploads.controller.js
backend/src/modules/uploads/uploads.routes.js
backend/src/modules/uploads/uploads.service.js
backend/src/modules/usuarios/usuarios.controller.js
backend/src/modules/usuarios/usuarios.routes.js
backend/src/modules/usuarios/usuarios.service.js
backend/src/modules/wallet/wallet.controller.js
backend/src/modules/wallet/wallet.routes.js
backend/src/modules/wallet/wallet.service.js
backend/src/routes/index.js
backend/src/server.js
backend/uploads_storage/1717f8c0-ba65-48b3-80da-d06a474dd514.png
backend/uploads_storage/cb6b319f-881d-4f8a-8a5e-9f8eecd10402.png
backend/uploads_storage/d6b3b8be-16ba-41bc-b958-7ab0c3e14e38.png
backend/utils/jsonBigInt.js
docker-compose.yml
frontend/index.html
frontend/package.json
frontend/postcss.config.js
frontend/src/App.jsx
frontend/src/assets/aurela.png
frontend/src/assets/aurella.png
frontend/src/assets/hoja.png
frontend/src/assets/publicit.png
frontend/src/assets/TomCruise.png
frontend/src/components/Layout.jsx
frontend/src/components/Navbar.jsx
frontend/src/components/ProtectedRoute.jsx
frontend/src/index.css
frontend/src/main.jsx
frontend/src/pages/Actividades.jsx
frontend/src/pages/BackendLab.jsx
frontend/src/pages/ComprarCreditos.jsx
frontend/src/pages/EditarPerfil.jsx
frontend/src/pages/HistorialCompras.jsx
frontend/src/pages/Home.jsx
frontend/src/pages/IntercambioDetalle.jsx
frontend/src/pages/Intercambios.jsx
frontend/src/pages/Login.jsx
frontend/src/pages/Logros.jsx
frontend/src/pages/MisActividades.jsx
frontend/src/pages/MisPublicaciones.jsx
frontend/src/pages/Movimientos.jsx
frontend/src/pages/NotFound.jsx
frontend/src/pages/Perfil.jsx
frontend/src/pages/Premium.jsx
frontend/src/pages/Promociones.jsx
frontend/src/pages/Publicaciones.jsx
frontend/src/pages/PublicacionNueva.jsx
frontend/src/pages/Publicidad.jsx
frontend/src/pages/Register.jsx
frontend/src/pages/Reportes.jsx
frontend/src/pages/ReportesActividadesSostenibles.jsx
frontend/src/pages/ReportesCreditosGeneradosConsumidos.jsx
frontend/src/pages/ReportesDashboard.jsx
frontend/src/pages/ReportesImpactoAcumulado.jsx
frontend/src/pages/ReportesImpactoCategoria.jsx
frontend/src/pages/ReportesIngresosCreditos.jsx
frontend/src/pages/ReportesIntercambiosCategoria.jsx
frontend/src/pages/ReportesPublicacionesVsIntercambios.jsx
frontend/src/pages/ReportesRankingUsuarios.jsx
frontend/src/pages/ReportesSaldosUsuarios.jsx
frontend/src/pages/ReportesUsuarios.jsx
frontend/src/pages/ReportesUsuariosPremium.jsx
frontend/src/pages/Wallet.jsx
frontend/src/router.jsx
frontend/src/services/api.js
frontend/tailwind.config.js
frontend/vite.config.js
package.json
README.md
</directory_structure>

<files>
This section contains the contents of the repository's files.

<file path=".gitignore">
node_modules
dist
.env
.env.*
.prisma
.DS_Store
</file>

<file path="backend/Dockerfile">
# simple dev image; optional
FROM node:18-alpine
WORKDIR /app
COPY package*.json ./
RUN npm install
COPY . .
EXPOSE 4000
CMD ["npm","run","start"]
</file>

<file path="backend/package.json">
{
  "name": "backend",
  "private": true,
  "version": "0.1.0",
  "type": "module",
  "scripts": {
    "dev": "node --watch src/server.js",
    "start": "node src/server.js",
    "prisma:generate": "prisma generate",
    "prisma:migrate": "prisma migrate dev --name init",
    "prisma:deploy": "prisma migrate deploy",
    "prisma:seed": "node prisma/seed.js",
    "studio": "prisma studio"
  },
  "dependencies": {
    "@prisma/client": "^6.19.0",
    "bcryptjs": "^2.4.3",
    "cors": "^2.8.5",
    "dotenv": "^16.4.5",
    "express": "^4.21.1",
    "helmet": "^7.1.0",
    "jsonwebtoken": "^9.0.2",
    "morgan": "^1.10.1",
    "multer": "^2.0.2",
    "uuid": "^13.0.0"
  },
  "devDependencies": {
    "prisma": "^6.19.0"
  }
}
</file>

<file path="backend/prisma/schema.prisma">
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model actividad_sostenible {
  id_actividad       Int      @id @default(autoincrement())
  id_usuario         Int
  id_tipo_actividad  Int
  descripcion        String   @db.Text
  creditos_otorgados Int
  evidencia_url      String?  @db.VarChar(500)
  creado_en          DateTime @default(now()) @db.DateTime(0)

  @@index([id_tipo_actividad], map: "fk_act_tipo")
  @@index([id_usuario], map: "fk_act_usuario")
  @@index([creado_en], map: "ix_actsost_creado_en")
}

model billetera {
  id_billetera    Int               @id @default(autoincrement())
  id_usuario      Int               @unique(map: "id_usuario")
  estado          billetera_estado? @default(ACTIVA)
  saldo_creditos  BigInt?           @default(0)
  saldo_bs        Decimal?          @default(0.00) @db.Decimal(12, 2)
  cuenta_bancaria String?           @db.VarChar(100)
}

model bitacora_acceso {
  id_acceso    Int      @id @default(autoincrement())
  id_usuario   Int
  fecha        DateTime @default(now()) @db.DateTime(0)
  direccion_ip String   @db.VarChar(45)
  user_agent   String?  @db.VarChar(500)
  id_resultado Int

  @@index([id_resultado], map: "fk_bitacc_resultado")
  @@index([id_usuario, fecha], map: "ix_bitacceso_usuario_fecha")
}

model bitacora_intercambio {
  id_bitacora        Int     @id @default(autoincrement())
  id_transaccion     Int
  id_usuario_origen  Int
  id_usuario_destino Int
  cantidad_creditos  BigInt
  descripcion        String? @db.VarChar(500)

  @@index([id_usuario_destino], map: "fk_bi_usr_destino")
  @@index([id_usuario_origen], map: "fk_bi_usr_origen")
  @@index([id_transaccion], map: "ix_bitacora_trx")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model calificacion {
  id_calificacion Int     @id @default(autoincrement())
  id_usuario      Int
  id_publicacion  Int
  estrellas       Int     @db.TinyInt
  comentario      String? @db.VarChar(300)

  @@unique([id_usuario, id_publicacion], map: "id_usuario")
  @@index([id_publicacion], map: "fk_calif_publicacion")
}

model categoria {
  id_categoria Int     @id @default(autoincrement())
  nombre       String  @unique(map: "nombre") @db.VarChar(100)
  descripcion  String? @db.VarChar(255)
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model compra_creditos {
  id_compra           Int                     @id @default(autoincrement())
  id_usuario          Int
  id_paquete          Int
  monto_bs            Decimal                 @db.Decimal(12, 2)
  estado              compra_creditos_estado? @default(PENDIENTE)
  id_transaccion_pago String?                 @unique(map: "id_transaccion_pago") @db.VarChar(255)
  creado_en           DateTime                @default(now()) @db.DateTime(0)

  @@index([id_paquete], map: "fk_compra_paquete")
  @@index([id_usuario], map: "fk_compra_usuario")
  @@index([estado], map: "ix_compra_estado")
  @@index([creado_en], map: "ix_compra_creado_en")
}

model dimension_ambiental {
  id_dimension Int     @id @default(autoincrement())
  codigo       String  @unique(map: "codigo") @db.VarChar(30)
  nombre       String  @db.VarChar(100)
  unidad_base  String? @db.VarChar(20)
  descripcion  String? @db.VarChar(255)
}

model equivalencia_impacto {
  id_equivalencia    Int     @id @default(autoincrement())
  id_categoria       Int
  id_um              Int?
  co2_por_unidad     Decimal @db.Decimal(12, 6)
  agua_por_unidad    Decimal @db.Decimal(12, 6)
  energia_por_unidad Decimal @db.Decimal(12, 6)

  @@unique([id_categoria, id_um], map: "id_categoria")
  @@index([id_um], map: "fk_eq_um")
}

model evento_ambiental {
  id_evento              Int                     @id @default(autoincrement())
  id_usuario             Int
  id_dimension           Int
  fuente                 evento_ambiental_fuente
  id_fuente              Int
  categoria              String?                 @db.VarChar(100)
  valor                  Decimal                 @db.Decimal(18, 6)
  id_um                  Int?
  contaminacion_reducida Decimal?                @db.Decimal(18, 6)
  descripcion            String?                 @db.VarChar(255)

  @@index([id_dimension], map: "fk_ev_dimension")
  @@index([id_um], map: "fk_ev_um")
  @@index([id_usuario], map: "fk_ev_usuario")
}

model impacto_ambiental {
  id_impacto       Int     @id @default(autoincrement())
  id_usuario       Int
  id_transaccion   Int
  id_categoria     Int
  co2_ahorrado     Decimal @db.Decimal(12, 6)
  agua_ahorrada    Decimal @db.Decimal(12, 6)
  energia_ahorrada Decimal @db.Decimal(12, 6)
  id_periodo       Int

  @@index([id_transaccion], map: "fk_imp_tx")
  @@index([id_categoria], map: "ix_impa_categoria")
  @@index([id_periodo], map: "ix_impa_periodo")
  @@index([id_usuario, id_periodo], map: "ix_impa_usuario_periodo")
}

model logro {
  id_logro            Int     @id @default(autoincrement())
  id_tipo_logro       Int
  nombre              String  @db.VarChar(100)
  descripcion         String? @db.VarChar(255)
  meta_requerida      BigInt
  creditos_recompensa BigInt

  @@index([id_tipo_logro], map: "fk_logro_tipo")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model movimiento_creditos {
  id_movimiento      Int      @id @default(autoincrement())
  id_usuario         Int
  id_tipo_movimiento Int
  id_tipo_referencia Int
  cantidad           BigInt
  descripcion        String?  @db.VarChar(255)
  saldo_anterior     BigInt
  saldo_posterior    BigInt
  id_referencia      Int?
  creado_en          DateTime @default(now()) @db.DateTime(0)

  @@index([id_tipo_movimiento], map: "fk_mov_tipomov")
  @@index([id_movimiento], map: "ix_mov_creado")
  @@index([id_tipo_referencia], map: "ix_mov_tiporef")
  @@index([id_usuario, id_movimiento], map: "ix_mov_usuario")
  @@index([creado_en], map: "ix_mov_creado_en")
}

model paquete_creditos {
  id_paquete        Int     @id @default(autoincrement())
  nombre            String  @unique(map: "nombre") @db.VarChar(100)
  cantidad_creditos BigInt
  precio_bs         Decimal @db.Decimal(12, 2)
  activo            Boolean @default(true)
}

model periodo {
  id_periodo   Int       @id @default(autoincrement())
  nombre       String    @unique(map: "nombre") @db.VarChar(50)
  descripcion  String?   @db.VarChar(255)
  fecha_inicio DateTime? @db.Date
  fecha_fin    DateTime? @db.Date

  @@index([fecha_inicio, fecha_fin], map: "ix_periodo_rango")
}

model permiso {
  id_permiso  Int     @id @default(autoincrement())
  nombre      String  @unique(map: "nombre") @db.VarChar(100)
  descripcion String? @db.VarChar(255)
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model producto {
  id_producto  Int      @id @default(autoincrement())
  id_categoria Int
  nombre       String   @db.VarChar(255)
  descripcion  String?  @db.VarChar(255)
  precio       Decimal? @db.Decimal(12, 2)
  peso         Decimal? @db.Decimal(10, 2)

  @@index([id_categoria], map: "fk_producto_categoria")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model promocion {
  id_promocion       Int               @id @default(autoincrement())
  id_tipo_promocion  Int
  nombre             String            @db.VarChar(100)
  descripcion        String?           @db.VarChar(255)
  creditos_otorgados BigInt
  fecha_inicio       DateTime          @db.DateTime(0)
  fecha_fin          DateTime          @db.DateTime(0)
  estado             promocion_estado? @default(PROGRAMADA)

  @@index([id_tipo_promocion], map: "fk_promocion_tipo")
  @@index([estado, fecha_inicio, fecha_fin], map: "ix_promocion_activa")
}

model promocion_publicacion {
  id_promocion   Int
  id_publicacion Int

  @@id([id_promocion, id_publicacion])
  @@index([id_promocion], map: "ix_promopub_prom")
  @@index([id_publicacion], map: "ix_promopub_pub")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model publicacion {
  id_publicacion      Int                 @id @default(autoincrement())
  id_usuario          Int
  id_categoria        Int
  id_tipo_publicacion Int
  estado              publicacion_estado? @default(PUBLICADA)
  id_ubicacion        Int?
  titulo              String              @db.VarChar(200)
  descripcion         String              @db.Text
  valor_creditos      BigInt
  imagen_url          String?             @db.VarChar(500)
  creado_en           DateTime            @default(now()) @db.DateTime(0)

  @@index([id_tipo_publicacion], map: "fk_publicacion_tipopub")
  @@index([id_ubicacion], map: "fk_publicacion_ubicacion")
  @@index([id_categoria, estado], map: "ix_pub_categoria_estado")
  @@index([id_usuario, estado], map: "ix_pub_usuario_estado")
  @@index([creado_en], map: "ix_pub_creado_en")
  @@fulltext([titulo, descripcion], map: "ft_pub_titulo_desc")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model publicacion_producto {
  id_publicacion Int
  id_producto    Int
  cantidad       Decimal @db.Decimal(15, 4)
  id_um          Int

  @@id([id_publicacion, id_producto])
  @@index([id_producto], map: "fk_pprd_producto")
  @@index([id_um], map: "fk_pprd_um")
}

model publicacion_servicio {
  id_publicacion Int
  id_servicio    Int
  horario        String @db.VarChar(100)

  @@id([id_publicacion, id_servicio])
  @@index([id_servicio], map: "fk_pserv_servicio")
}

model publicidad {
  id_publicidad  Int                @id @default(autoincrement())
  id_usuario     Int
  id_ubicacion   Int
  estado         publicidad_estado? @default(PROGRAMADA)
  titulo         String             @db.VarChar(200)
  descripcion    String?            @db.VarChar(255)
  url_destino    String?            @db.VarChar(500)
  fecha_inicio   DateTime           @db.DateTime(0)
  fecha_fin      DateTime           @db.DateTime(0)
  costo_creditos BigInt

  @@index([id_ubicacion], map: "fk_publicidad_ubipub")
  @@index([id_usuario], map: "fk_publicidad_usuario")
}

model reporte_impacto {
  id_reporte             Int     @id @default(autoincrement())
  id_usuario             Int?
  id_tipo_reporte        Int
  id_periodo             Int
  total_co2_ahorrado     Decimal @db.Decimal(12, 6)
  total_agua_ahorrada    Decimal @db.Decimal(12, 6)
  total_energia_ahorrada Decimal @db.Decimal(12, 6)
  total_transacciones    BigInt
  total_usuarios_activos BigInt

  @@index([id_periodo], map: "fk_rep_periodo")
  @@index([id_usuario], map: "fk_rep_usuario")
  @@index([id_tipo_reporte, id_periodo, id_usuario], map: "ix_rep_unico_helper")
}

model resultado_acceso {
  id_resultado Int     @id @default(autoincrement())
  nombre       String  @unique(map: "nombre") @db.VarChar(50)
  descripcion  String? @db.VarChar(255)
}

model rol {
  id_rol      Int     @id @default(autoincrement())
  nombre      String  @unique(map: "nombre") @db.VarChar(50)
  descripcion String? @db.VarChar(255)
}

model rol_permiso {
  id_rol     Int
  id_permiso Int

  @@id([id_rol, id_permiso])
  @@index([id_permiso], map: "fk_rp_permiso")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model servicio {
  id_servicio  Int              @id @default(autoincrement())
  id_categoria Int
  estado       servicio_estado? @default(ACTIVO)
  nombre       String           @db.VarChar(255)
  descripcion  String?          @db.Text
  precio       Decimal?         @db.Decimal(12, 2)
  duracion_min Int?             @db.SmallInt

  @@index([id_categoria], map: "fk_servicio_categoria")
}

model signo_movimiento {
  id_signo Int    @id @default(autoincrement())
  nombre   String @unique(map: "nombre") @db.VarChar(20)
}

model signo_tipo_mov {
  id_tipo_movimiento Int
  id_signo           Int
  creado_en          DateTime? @db.DateTime(0)

  @@id([id_tipo_movimiento, id_signo])
  @@index([id_signo], map: "ix_sxtm_signo")
}

model tipo_actividad {
  id_tipo_actividad Int     @id @default(autoincrement())
  nombre            String  @unique(map: "nombre") @db.VarChar(100)
  descripcion       String? @db.VarChar(255)
}

model tipo_logro {
  id_tipo_logro Int     @id @default(autoincrement())
  nombre        String  @unique(map: "nombre") @db.VarChar(50)
  descripcion   String? @db.VarChar(255)
}

model tipo_movimiento {
  id_tipo_movimiento Int     @id @default(autoincrement())
  nombre             String  @unique(map: "nombre") @db.VarChar(50)
  descripcion        String? @db.VarChar(255)

  @@index([nombre], map: "ix_tipomov_nombre")
}

model tipo_promocion {
  id_tipo_promocion Int     @id @default(autoincrement())
  nombre            String  @unique(map: "nombre") @db.VarChar(50)
  descripcion       String? @db.VarChar(255)
}

model tipo_publicacion {
  id_tipo_publicacion Int     @id @default(autoincrement())
  nombre              String  @unique(map: "nombre") @db.VarChar(50)
  descripcion         String? @db.VarChar(255)
}

model tipo_referencia {
  id_tipo_referencia Int    @id @default(autoincrement())
  nombre             String @unique(map: "nombre") @db.VarChar(30)

  @@index([nombre], map: "ix_tiporef_nombre")
}

model tipo_reporte {
  id_tipo_reporte Int     @id @default(autoincrement())
  nombre          String  @unique(map: "nombre") @db.VarChar(50)
  descripcion     String? @db.VarChar(255)
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model transaccion {
  id_transaccion    Int                 @id @default(autoincrement())
  id_comprador      Int
  id_vendedor       Int
  id_publicacion    Int
  cantidad_creditos BigInt
  estado            transaccion_estado? @default(SOLICITADA)
  creado_en         DateTime            @default(now()) @db.DateTime(0)

  @@index([estado], map: "ix_trans_estado")
  @@index([id_comprador], map: "ix_tx_comprador")
  @@index([id_publicacion], map: "ix_tx_publicacion")
  @@index([id_vendedor], map: "ix_tx_vendedor")
  @@index([creado_en], map: "ix_tx_creado_en")
}

model ubicacion {
  id_ubicacion Int      @id @default(autoincrement())
  direccion    String   @db.VarChar(500)
  ciudad       String?  @db.VarChar(100)
  provincia    String?  @db.VarChar(100)
  latitud      Decimal? @db.Decimal(9, 6)
  longitud     Decimal? @db.Decimal(9, 6)
}

model ubicacion_publicidad {
  id_ubicacion Int     @id @default(autoincrement())
  nombre       String  @unique(map: "nombre") @db.VarChar(100)
  descripcion  String? @db.VarChar(255)
  precio_base  Decimal @db.Decimal(12, 2)
}

model unidad_medida {
  id_um   Int    @id @default(autoincrement())
  nombre  String @unique(map: "nombre") @db.VarChar(100)
  simbolo String @unique(map: "simbolo") @db.VarChar(20)
}

model usuario {
  id_usuario    Int            @id @default(autoincrement())
  id_rol        Int
  estado        usuario_estado @default(ACTIVO)
  nombre        String         @db.VarChar(100)
  apellido      String?        @db.VarChar(100)
  correo        String         @unique(map: "correo") @db.VarChar(255)
  password_hash String         @default("") @db.VarChar(255)
  telefono      String?        @db.VarChar(25)
  url_perfil    String?        @unique(map: "url_perfil") @db.VarChar(120)

  @@index([id_rol], map: "fk_usuario_rol")
}

model usuario_logro {
  id_usuario_logro Int     @id @default(autoincrement())
  id_usuario       Int
  id_logro         Int
  progreso_actual  BigInt? @default(0)

  @@unique([id_usuario, id_logro], map: "id_usuario")
  @@index([id_logro], map: "fk_ulogro_logro")
}

model suscripcion_premium {
  id_suscripcion Int                        @id @default(autoincrement())
  id_usuario     Int
  fecha_inicio   DateTime                   @default(now()) @db.DateTime(0)
  fecha_fin      DateTime?                  @db.DateTime(0)
  estado         suscripcion_premium_estado @default(ACTIVA)
  monto_bs       Decimal                    @db.Decimal(12, 2)

  @@index([fecha_inicio, fecha_fin], map: "ix_suscrip_fechas")
  @@index([id_usuario, estado], map: "ix_suscrip_usuario_estado")
}

enum billetera_estado {
  ACTIVA
  BLOQUEADA
  CERRADA
}

enum servicio_estado {
  ACTIVO
  PAUSADO
  INACTIVO
  ELIMINADO
}

enum usuario_estado {
  ACTIVO
  SUSPENDIDO
  BLOQUEADO
  ELIMINADO
}

enum evento_ambiental_fuente {
  PUBLICACION
  TRANSACCION
}

enum publicidad_estado {
  PROGRAMADA
  ACTIVA
  PAUSADA
  FINALIZADA
  CANCELADA
}

enum compra_creditos_estado {
  PENDIENTE
  APROBADO
  RECHAZADO
  FALLIDO
  REVERTIDO
}

enum publicacion_estado {
  BORRADOR
  PUBLICADA
  PAUSADA
  AGOTADA
  OCULTA
  ELIMINADA
}

enum transaccion_estado {
  SOLICITADA
  ACEPTADA
  RECHAZADA
  CANCELADA
  COMPLETADA
  ANULADA
}

enum promocion_estado {
  PROGRAMADA
  ACTIVA
  PAUSADA
  FINALIZADA
  CANCELADA
}

enum suscripcion_premium_estado {
  ACTIVA
  CANCELADA
  VENCIDA
}
</file>

<file path="backend/prisma/seed.js">
import { PrismaClient } from '@prisma/client'
import bcrypt from 'bcryptjs'
const prisma = new PrismaClient()

async function main() {
  const [adminRole, userRole] = await Promise.all([
    prisma.role.upsert({ where: { name: 'ADMIN' }, update: {}, create: { name: 'ADMIN' } }),
    prisma.role.upsert({ where: { name: 'USER' }, update: {}, create: { name: 'USER' } }),
  ])

  const passwordHash = await bcrypt.hash('demo123', 10)
  const admin = await prisma.user.upsert({
    where: { email: 'demo@demo.com' },
    update: {},
    create: { email: 'demo@demo.com', name: 'Admin Demo', passwordHash, roleId: adminRole.id }
  })

  await prisma.wallet.upsert({
    where: { userId: admin.id },
    update: {},
    create: { userId: admin.id, credits: 1000 }
  })

  console.log('Seed listo:', { admin: admin.email })
}

main().catch(e=>{console.error(e); process.exit(1)}).finally(()=>prisma.$disconnect())
</file>

<file path="backend/src/app.js">
// src/app.js

// üîß Parche global para que JSON.stringify soporte BigInt en todas las respuestas
if (typeof BigInt !== "undefined" && !BigInt.prototype.toJSON) {
  // eslint-disable-next-line no-extend-native
  BigInt.prototype.toJSON = function () {
    return Number(this);
  };
}

import express from "express";
import cors from "cors";
import morgan from "morgan";
import routes from "./routes/index.js";
import { errorHandler } from "./middlewares/errorHandler.js";

import path from "path";
import { fileURLToPath } from "url";

const app = express();

// -------------------------------------------------------------
// Necesario para rutas absolutas (uploads y archivos est√°ticos)
// -------------------------------------------------------------
const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

// -------------------------------------------------------------
// Middlewares globales
// -------------------------------------------------------------
app.use(cors());                // permitir peticiones de tu frontend
app.use(morgan("dev"));         // logs en consola
app.use(express.json());        // permite JSON en body
app.use(express.urlencoded({ extended: true })); // formularios

// -------------------------------------------------------------
// Servir archivos est√°ticos (subidas de im√°genes)
// Ruta final: http://localhost:4000/uploads/<nombre-archivo>
// -------------------------------------------------------------
app.use(
  "/uploads",
  express.static(path.join(__dirname, "..", "uploads_storage"))
);

// -------------------------------------------------------------
// Registrar todas las rutas del backend
// -------------------------------------------------------------
app.use("/api", routes);

// -------------------------------------------------------------
// Middleware para rutas no encontradas
// -------------------------------------------------------------
app.use((req, res, next) => {
  res.status(404).json({ message: "Ruta no encontrada" });
});

// -------------------------------------------------------------
// Middleware global de manejo de errores
// (Siempre debe ir al final)
// -------------------------------------------------------------
app.use(errorHandler);

export default app;
</file>

<file path="backend/src/config/env.js">
// src/config/env.js
import 'dotenv/config'

export const env = {
  NODE_ENV: process.env.NODE_ENV ?? 'development',
  PORT: Number(process.env.PORT ?? 4000),
  DATABASE_URL: process.env.DATABASE_URL,
}
</file>

<file path="backend/src/config/prisma.js">
// src/config/prisma.js
import { PrismaClient } from '@prisma/client'

export const prisma = new PrismaClient({
    log: ['query', 'error', 'warn'],
})
</file>

<file path="backend/src/middlewares/auth.js">
// src/middlewares/auth.js
import jwt from "jsonwebtoken";

// Middleware principal: requiere token v√°lido
export function authMiddleware(req, res, next) {
  const authHeader = req.headers.authorization;

  // Esperamos "Authorization: Bearer <token>"
  if (!authHeader || !authHeader.startsWith("Bearer ")) {
    return res.status(401).json({ message: "Token de autenticaci√≥n faltante" });
  }

  const token = authHeader.split(" ")[1];

  try {
    const payload = jwt.verify(token, process.env.JWT_SECRET);
    // En el payload nosotros pusimos: id_usuario, correo, rol
    req.user = payload;
    next();
  } catch (err) {
    return res
      .status(401)
      .json({ message: "Token inv√°lido o expirado" });
  }
}

// Versi√≥n opcional: si hay token lo lee, si no, deja pasar
export function optionalAuth(req, _res, next) {
  const authHeader = req.headers.authorization;
  if (!authHeader || !authHeader.startsWith("Bearer ")) {
    return next();
  }

  const token = authHeader.split(" ")[1];

  try {
    const payload = jwt.verify(token, process.env.JWT_SECRET);
    req.user = payload;
  } catch {
    // si falla, simplemente no ponemos req.user
  }
  next();
}
</file>

<file path="backend/src/middlewares/errorHandler.js">
// src/middlewares/errorHandler.js

// Middleware de manejo global de errores (SIEMPRE 4 par√°metros)
export function errorHandler(err, req, res, next) {
  console.error("‚ùå Error:", err);

  // Si ya se empez√≥ a enviar la respuesta, delega a Express
  if (res.headersSent) {
    return next(err);
  }

  const status = err.status || err.statusCode || 500;
  const message =
    err.message || "Ocurri√≥ un error inesperado en el servidor";

  const response = { message };

  // En desarrollo podemos enviar m√°s detalles
  if (process.env.NODE_ENV !== "production") {
    response.stack = err.stack;
    if (err.code) response.code = err.code;
  }

  res.status(status).json(response);
}
</file>

<file path="backend/src/middlewares/isAdmin.js">
// src/middlewares/isAdmin.js

// Middleware simple: solo ADMIN
export function isAdmin(req, res, next) {
  if (!req.user) {
    return res.status(401).json({ message: "No autenticado" });
  }

  if (req.user.rol !== "ADMIN") {
    return res.status(403).json({ message: "Acceso solo para administradores" });
  }

  next();
}

// Middleware m√°s general: aceptar varios roles
export function hasRole(...rolesPermitidos) {
  return (req, res, next) => {
    if (!req.user) {
      return res.status(401).json({ message: "No autenticado" });
    }

    if (!rolesPermitidos.includes(req.user.rol)) {
      return res.status(403).json({ message: "No tienes permisos suficientes" });
    }

    next();
  };
}
</file>

<file path="backend/src/modules/actividades/actividades.controller.js">
import {
  registrarActividadService,
  misActividadesService,
} from "./actividades.service.js";

export const registrarActividadController = async (req, res, next) => {
  try {
    const idUsuario = req.user.id_usuario;
    const { id_tipo_actividad, descripcion, creditos_otorgados, evidencia_url } = req.body;

    const result = await registrarActividadService({
      idUsuario,
      id_tipo_actividad,
      descripcion,
      creditos_otorgados,
      evidencia_url,
    });

    res.status(201).json(result);
  } catch (e) { next(e); }
};

export const misActividadesController = async (req, res, next) => {
  try { res.json(await misActividadesService(req.user.id_usuario)); }
  catch (e) { next(e); }
};
</file>

<file path="backend/src/modules/actividades/actividades.routes.js">
import { Router } from "express";
import { authMiddleware } from "../../middlewares/auth.js";
import {
  registrarActividadController,
  misActividadesController,
} from "./actividades.controller.js";

const router = Router();

router.use(authMiddleware);

router.post("/", registrarActividadController);
router.get("/mias", misActividadesController);

export default router;
</file>

<file path="backend/src/modules/actividades/actividades.service.js">
import { prisma } from "../../config/prisma.js";

export async function registrarActividadService({
  idUsuario,
  id_tipo_actividad,
  descripcion,
  creditos_otorgados,
  evidencia_url,
}) {
  if (!id_tipo_actividad || !descripcion || !creditos_otorgados) {
    const err = new Error("id_tipo_actividad, descripcion y creditos_otorgados son obligatorios");
    err.status = 400;
    throw err;
  }

  await prisma.$executeRawUnsafe(
    "CALL sp_registrar_actividad_sostenible(?, ?, ?, ?, ?)",
    idUsuario,
    id_tipo_actividad,
    descripcion,
    creditos_otorgados,
    evidencia_url || null
  );

  // devolver ultima actividad del usuario
  const [act] = await prisma.$queryRaw`
    SELECT *
    FROM ACTIVIDAD_SOSTENIBLE
    WHERE id_usuario = ${idUsuario}
    ORDER BY creado_en DESC, id_actividad DESC
    LIMIT 1
  `;
  return act;
}

export async function misActividadesService(idUsuario) {
  return prisma.$queryRaw`
    SELECT * FROM ACTIVIDAD_SOSTENIBLE
    WHERE id_usuario = ${idUsuario}
    ORDER BY creado_en DESC
  `;
}
</file>

<file path="backend/src/modules/auth/auth.controller.js">
import {
  registrarUsuarioService,
  loginService,
  obtenerPerfilService,
} from "./auth.service.js";

export async function registerController(req, res, next) {
  try {
    const { nombre, apellido, correo, password, telefono } = req.body;

    if (!nombre || !correo || !password) {
      return res
        .status(400)
        .json({ message: "nombre, correo y password son obligatorios" });
    }

    const usuario = await registrarUsuarioService({
      nombre,
      apellido,
      correo,
      password,
      telefono,
    });

    res.status(201).json({
      message: "Usuario registrado correctamente",
      usuario,
    });
  } catch (err) {
    next(err);
  }
}

export async function loginController(req, res, next) {
  try {
    const { correo, password } = req.body;

    if (!correo || !password) {
      return res
        .status(400)
        .json({ message: "correo y password son obligatorios" });
    }

    const result = await loginService({
      correo,
      password,
      ip: req.ip,
      userAgent: req.headers["user-agent"] || "",
    });

    res.json(result); // { token, usuario }
  } catch (err) {
    next(err);
  }
}

export async function meController(req, res, next) {
  try {
    const idUsuario = req.user.id_usuario;
    const perfil = await obtenerPerfilService(idUsuario);
    res.json(perfil);
  } catch (err) {
    next(err);
  }
}
</file>

<file path="backend/src/modules/auth/auth.routes.js">
import { Router } from "express";
import {
    registerController,
    loginController,
    meController,
} from "./auth.controller.js";
import { authMiddleware } from "../../middlewares/auth.js";

const router = Router();

// Registro p√∫blico (rol COMPRADOR)
router.post("/register", registerController);

// Login
router.post("/login", loginController);

// Datos del usuario logueado
router.get("/me", authMiddleware, meController);

export default router;
</file>

<file path="backend/src/modules/auth/auth.service.js">
import bcrypt from "bcryptjs";
import jwt from "jsonwebtoken";
import { prisma } from "../../config/prisma.js";

// Helper: obtener id_rol por nombre
async function getRolId(nombreRol) {
  const rows = await prisma.$queryRaw`
    SELECT id_rol FROM ROL WHERE nombre = ${nombreRol} LIMIT 1
  `;
  if (!rows.length) {
    throw new Error(`No existe el rol ${nombreRol}`);
  }
  return rows[0].id_rol;
}

// Helper: obtener id_resultado de BITACORA_ACCESO (OK / FAIL)
async function getResultadoAccesoId(nombre) {
  const rows = await prisma.$queryRaw`
    SELECT id_resultado FROM RESULTADO_ACCESO WHERE nombre = ${nombre} LIMIT 1
  `;
  if (!rows.length) {
    throw new Error(`No existe RESULTADO_ACCESO '${nombre}'`);
  }
  return rows[0].id_resultado;
}

export async function registrarUsuarioService({
  nombre,
  apellido,
  correo,
  password,
  telefono,
}) {
  // ¬øCorreo ya existe?
  const existente = await prisma.$queryRaw`
    SELECT id_usuario FROM USUARIO WHERE correo = ${correo} LIMIT 1
  `;
  if (existente.length) {
    const error = new Error("El correo ya est√° registrado");
    error.status = 409;
    throw error;
  }

  const hash = await bcrypt.hash(password, 10);
  const idRolComprador = await getRolId("COMPRADOR");

  await prisma.$queryRaw`
    INSERT INTO USUARIO (id_rol, estado, nombre, apellido, correo, password_hash, telefono, url_perfil)
    VALUES (${idRolComprador}, 'ACTIVO', ${nombre}, ${apellido || null}, ${correo},
            ${hash}, ${telefono || null}, NULL)
  `;

  // Volver a leer el usuario insertado
  const usuarioRows = await prisma.$queryRaw`
    SELECT u.id_usuario, u.nombre, u.apellido, u.correo, u.telefono, r.nombre AS rol
    FROM USUARIO u
    JOIN ROL r ON r.id_rol = u.id_rol
    WHERE u.correo = ${correo}
    LIMIT 1
  `;

  return usuarioRows[0];
}

export async function loginService({ correo, password, ip, userAgent }) {
  const usuarios = await prisma.$queryRaw`
    SELECT u.id_usuario, u.password_hash, u.nombre, u.apellido, u.correo,
           u.estado, r.nombre AS rol
    FROM USUARIO u
    JOIN ROL r ON r.id_rol = u.id_rol
    WHERE u.correo = ${correo}
    LIMIT 1
  `;

  const user = usuarios[0];
  let resultadoNombre = "FAIL";

  if (!user) {
    const idFail = await getResultadoAccesoId(resultadoNombre);
    // Podr√≠as registrar intento fallido sin usuario si quisieras
    const error = new Error("Credenciales inv√°lidas");
    error.status = 401;
    throw error;
  }

  // ===== CAMBIO IMPORTANTE: compatibilidad con hashes bcrypt y texto plano =====
  let ok = false;

  try {
    // Si parece un hash bcrypt ($2a$, $2b$, $2y$...), usamos bcrypt.compare
    if (user.password_hash && user.password_hash.startsWith("$2")) {
      ok = await bcrypt.compare(password, user.password_hash);
    } else {
      // Si NO parece hash, asumimos que est√° en texto plano (ej: '123456')
      ok = password === user.password_hash;
    }
  } catch (e) {
    // Si bcrypt truena por hash inv√°lido, hacemos fallback a texto plano
    ok = password === user.password_hash;
  }

  if (!ok) {
    const idFail = await getResultadoAccesoId(resultadoNombre);
    await prisma.$queryRaw`
      INSERT INTO BITACORA_ACCESO (id_usuario, fecha, direccion_ip, user_agent, id_resultado)
      VALUES (${user.id_usuario}, NOW(), ${ip}, ${userAgent}, ${idFail})
    `;
    const error = new Error("Credenciales inv√°lidas");
    error.status = 401;
    throw error;
  }

  // Login correcto
  resultadoNombre = "OK";
  const idOk = await getResultadoAccesoId(resultadoNombre);
  await prisma.$queryRaw`
    INSERT INTO BITACORA_ACCESO (id_usuario, fecha, direccion_ip, user_agent, id_resultado)
    VALUES (${user.id_usuario}, NOW(), ${ip}, ${userAgent}, ${idOk})
  `;

  const payload = {
    id_usuario: user.id_usuario,
    correo: user.correo,
    rol: user.rol,
  };

  const token = jwt.sign(payload, process.env.JWT_SECRET, {
    expiresIn: "2h",
  });

  // No devolver hash
  delete user.password_hash;

  return {
    token,
    usuario: {
      id_usuario: user.id_usuario,
      nombre: user.nombre,
      apellido: user.apellido,
      correo: user.correo,
      rol: user.rol,
      estado: user.estado,
    },
  };
}

export async function obtenerPerfilService(idUsuario) {
  const rows = await prisma.$queryRaw`
    SELECT u.id_usuario, u.nombre, u.apellido, u.correo, u.telefono,
           u.estado, r.nombre AS rol
    FROM USUARIO u
    JOIN ROL r ON r.id_rol = u.id_rol
    WHERE u.id_usuario = ${idUsuario}
    LIMIT 1
  `;
  if (!rows.length) {
    const err = new Error("Usuario no encontrado");
    err.status = 404;
    throw err;
  }
  return rows[0];
}
</file>

<file path="backend/src/modules/catalogos/catalogos.controller.js">
import {
  listarCategorias,
  listarUnidadesMedida,
  listarPaquetesCreditos,
  listarTiposActividad,
  listarTiposPromocion,
  listarUbicacionesPublicidad,
  listarTiposLogro,
} from "./catalogos.service.js";

export const getCategorias = async (_req, res, next) => {
  try { res.json(await listarCategorias()); } catch (e) { next(e); }
};
export const getUnidadesMedida = async (_req, res, next) => {
  try { res.json(await listarUnidadesMedida()); } catch (e) { next(e); }
};
export const getPaquetesCreditos = async (_req, res, next) => {
  try { res.json(await listarPaquetesCreditos()); } catch (e) { next(e); }
};
export const getTiposActividad = async (_req, res, next) => {
  try { res.json(await listarTiposActividad()); } catch (e) { next(e); }
};
export const getTiposPromocion = async (_req, res, next) => {
  try { res.json(await listarTiposPromocion()); } catch (e) { next(e); }
};
export const getUbicacionesPublicidad = async (_req, res, next) => {
  try { res.json(await listarUbicacionesPublicidad()); } catch (e) { next(e); }
};
export const getTiposLogro = async (_req, res, next) => {
  try { res.json(await listarTiposLogro()); } catch (e) { next(e); }
};
</file>

<file path="backend/src/modules/catalogos/catalogos.routes.js">
import { Router } from "express";
import {
  getCategorias,
  getUnidadesMedida,
  getPaquetesCreditos,
  getTiposActividad,
  getTiposPromocion,
  getUbicacionesPublicidad,
  getTiposLogro,
} from "./catalogos.controller.js";

const router = Router();

router.get("/categorias", getCategorias);
router.get("/unidades-medida", getUnidadesMedida);
router.get("/paquetes-creditos", getPaquetesCreditos);
router.get("/tipos-actividad", getTiposActividad);
router.get("/tipos-promocion", getTiposPromocion);
router.get("/ubicaciones-publicidad", getUbicacionesPublicidad);
router.get("/tipos-logro", getTiposLogro);

export default router;
</file>

<file path="backend/src/modules/catalogos/catalogos.service.js">
import { prisma } from "../../config/prisma.js";

export const listarCategorias = () =>
  prisma.$queryRaw`SELECT * FROM CATEGORIA ORDER BY nombre`;

export const listarUnidadesMedida = () =>
  prisma.$queryRaw`SELECT * FROM UNIDAD_MEDIDA ORDER BY nombre`;

export const listarPaquetesCreditos = () =>
  prisma.$queryRaw`SELECT * FROM PAQUETE_CREDITOS WHERE activo = TRUE ORDER BY cantidad_creditos`;

export const listarTiposActividad = () =>
  prisma.$queryRaw`SELECT * FROM TIPO_ACTIVIDAD ORDER BY nombre`;

export const listarTiposPromocion = () =>
  prisma.$queryRaw`SELECT * FROM TIPO_PROMOCION ORDER BY nombre`;

export const listarUbicacionesPublicidad = () =>
  prisma.$queryRaw`SELECT * FROM UBICACION_PUBLICIDAD ORDER BY nombre`;

export const listarTiposLogro = () =>
  prisma.$queryRaw`SELECT * FROM TIPO_LOGRO ORDER BY nombre`;
</file>

<file path="backend/src/modules/intercambios/intercambios.controller.js">
import {
  crearIntercambioService,
  misComprasService,
  misVentasService,
  detalleTransaccionService,
} from "./intercambios.service.js";

export const crearIntercambioController = async (req, res, next) => {
  try {
    const idComprador = req.user.id_usuario;
    const { id_publicacion, creditos } = req.body;
    const tx = await crearIntercambioService({ idComprador, id_publicacion, creditos });
    res.status(201).json({ message: "Intercambio creado", transaccion: tx });
  } catch (e) { next(e); }
};

export const misComprasController = async (req, res, next) => {
  try { res.json(await misComprasService(req.user.id_usuario)); }
  catch (e) { next(e); }
};

export const misVentasController = async (req, res, next) => {
  try { res.json(await misVentasService(req.user.id_usuario)); }
  catch (e) { next(e); }
};

export const detalleTransaccionController = async (req, res, next) => {
  try { res.json(await detalleTransaccionService(+req.params.id)); }
  catch (e) { next(e); }
};
</file>

<file path="backend/src/modules/intercambios/intercambios.routes.js">
import { Router } from "express";
import { authMiddleware } from "../../middlewares/auth.js";
import {
  crearIntercambioController,
  misComprasController,
  misVentasController,
  detalleTransaccionController,
} from "./intercambios.controller.js";

const router = Router();

router.use(authMiddleware);

router.post("/", crearIntercambioController);
router.get("/mis-compras", misComprasController);
router.get("/mis-ventas", misVentasController);
router.get("/:id", detalleTransaccionController);

export default router;
</file>

<file path="backend/src/modules/intercambios/intercambios.service.js">
import { prisma } from "../../config/prisma.js";

export async function crearIntercambioService({ idComprador, id_publicacion, creditos }) {
  if (!id_publicacion || !creditos) {
    const err = new Error("id_publicacion y creditos son obligatorios");
    err.status = 400;
    throw err;
  }

  await prisma.$executeRawUnsafe(
    "CALL sp_realizar_intercambio(?, ?, ?)",
    idComprador,
    id_publicacion,
    creditos
  );

  // La √∫ltima transacci√≥n creada
  const [tx] = await prisma.$queryRaw`
    SELECT *
    FROM TRANSACCION
    WHERE id_comprador = ${idComprador}
    ORDER BY id_transaccion DESC
    LIMIT 1
  `;
  return tx;
}

export async function misComprasService(idUsuario) {
  return prisma.$queryRaw`
    SELECT t.*, p.titulo
    FROM TRANSACCION t
    JOIN PUBLICACION p ON p.id_publicacion = t.id_publicacion
    WHERE t.id_comprador = ${idUsuario}
    ORDER BY t.creado_en DESC
  `;
}

export async function misVentasService(idUsuario) {
  return prisma.$queryRaw`
    SELECT t.*, p.titulo
    FROM TRANSACCION t
    JOIN PUBLICACION p ON p.id_publicacion = t.id_publicacion
    WHERE t.id_vendedor = ${idUsuario}
    ORDER BY t.creado_en DESC
  `;
}

export async function detalleTransaccionService(idTransaccion) {
  const [row] = await prisma.$queryRaw`
    SELECT t.*, p.titulo, p.descripcion, p.valor_creditos
    FROM TRANSACCION t
    JOIN PUBLICACION p ON p.id_publicacion = t.id_publicacion
    WHERE t.id_transaccion = ${idTransaccion}
    LIMIT 1
  `;
  if (!row) {
    const err = new Error("Transacci√≥n no encontrada");
    err.status = 404;
    throw err;
  }
  return row;
}
</file>

<file path="backend/src/modules/logros/logros.controller.js">
import {
  misLogrosService,
  listarLogrosService,
} from "./logros.service.js";

export const misLogrosController = async (req, res, next) => {
  try { res.json(await misLogrosService(req.user.id_usuario)); }
  catch (e) { next(e); }
};

export const listarLogrosController = async (_req, res, next) => {
  try { res.json(await listarLogrosService()); }
  catch (e) { next(e); }
};
</file>

<file path="backend/src/modules/logros/logros.routes.js">
import { Router } from "express";
import { authMiddleware } from "../../middlewares/auth.js";
import { isAdmin } from "../../middlewares/isAdmin.js";
import {
  misLogrosController,
  listarLogrosController,
} from "./logros.controller.js";

const router = Router();

router.use(authMiddleware);

router.get("/mios", misLogrosController);

// s√≥lo admin ve cat√°logo completo
router.get("/", isAdmin, listarLogrosController);

export default router;
</file>

<file path="backend/src/modules/logros/logros.service.js">
import { prisma } from "../../config/prisma.js";

export const listarLogrosService = () =>
  prisma.$queryRaw`
    SELECT l.*, tl.nombre AS tipo_logro
    FROM LOGRO l
    JOIN TIPO_LOGRO tl ON tl.id_tipo_logro = l.id_tipo_logro
    ORDER BY l.id_logro
  `;

export const misLogrosService = (idUsuario) =>
  prisma.$queryRaw`
    SELECT ul.*, l.nombre, l.descripcion, l.meta_requerida, l.creditos_recompensa
    FROM USUARIO_LOGRO ul
    JOIN LOGRO l ON l.id_logro = ul.id_logro
    WHERE ul.id_usuario = ${idUsuario}
    ORDER BY l.id_logro
  `;
</file>

<file path="backend/src/modules/premium/premium.controller.js">
// premium.controller.js
import {
  miPlanPremiumService,
  activarPremiumService,
} from "./premium.service.js";

export const miPlanPremiumController = async (req, res, next) => {
  try {
    res.json(await miPlanPremiumService(req.user.id_usuario));
  } catch (e) { next(e); }
};

export const activarPremiumController = async (req, res, next) => {
  try {
    const idUsuario = req.user.id_usuario;
    const data = await activarPremiumService(idUsuario);
    res.status(201).json(data);
  } catch (e) { next(e); }
};
</file>

<file path="backend/src/modules/premium/premium.routes.js">
// premium.routes.js
import { Router } from "express";
import { authMiddleware } from "../../middlewares/auth.js";
import {
  miPlanPremiumController,
  activarPremiumController,
} from "./premium.controller.js";

const router = Router();
router.use(authMiddleware);

router.get("/mi-plan", miPlanPremiumController);
router.post("/activar", activarPremiumController);

export default router;
</file>

<file path="backend/src/modules/premium/premium.service.js">
// premium.service.js
import { prisma } from "../../config/prisma.js";

export const miPlanPremiumService = (idUsuario) =>
  prisma.$queryRaw`
    SELECT *
    FROM SUSCRIPCION_PREMIUM
    WHERE id_usuario = ${idUsuario}
    ORDER BY fecha_inicio DESC
    LIMIT 1
  `;

// üëâ NUEVO / CORREGIDO
export async function activarPremiumService(idUsuario) {
  // 30 d√≠as de duraci√≥n
  const fin = new Date();
  fin.setDate(fin.getDate() + 30);

  // fecha_inicio tiene default CURRENT_TIMESTAMP, as√≠ que no es obligatorio mandarla
  await prisma.$executeRaw`
    INSERT INTO SUSCRIPCION_PREMIUM (
      id_usuario,
      fecha_fin,
      estado,
      monto_bs
    )
    VALUES (
      ${idUsuario},
      ${fin},
      'ACTIVA',      -- üëà tiene que ser ACTIVA (no ACTIVO ni VIGENTE)
      20.00          -- monto que t√∫ quieras
    )
  `;

  const [row] = await prisma.$queryRaw`
    SELECT *
    FROM SUSCRIPCION_PREMIUM
    WHERE id_usuario = ${idUsuario}
    ORDER BY fecha_inicio DESC
    LIMIT 1
  `;

  return row;
}
</file>

<file path="backend/src/modules/promociones/promociones.controller.js">
import {
  listarPromocionesService,
  crearPromocionService,
  actualizarEstadoPromocionService,
  vincularPublicacionService,
} from "./promociones.service.js";

export const listarPromocionesController = async (_req, res, next) => {
  try { res.json(await listarPromocionesService()); } catch (e) { next(e); }
};

export const crearPromocionController = async (req, res, next) => {
  try { res.status(201).json(await crearPromocionService(req.body)); }
  catch (e) { next(e); }
};

export const actualizarEstadoPromocionController = async (req, res, next) => {
  try {
    const id = +req.params.id;
    const { estado } = req.body;
    res.json(await actualizarEstadoPromocionService(id, estado));
  } catch (e) { next(e); }
};

export const vincularPublicacionController = async (req, res, next) => {
  try {
    const idPromocion = +req.params.id;
    const { id_publicacion } = req.body;
    await vincularPublicacionService(idPromocion, id_publicacion);
    res.status(201).json({ message: "Publicaci√≥n vinculada" });
  } catch (e) { next(e); }
};
</file>

<file path="backend/src/modules/promociones/promociones.routes.js">
import { Router } from "express";
import { authMiddleware } from "../../middlewares/auth.js";
import { isAdmin } from "../../middlewares/isAdmin.js";
import {
  listarPromocionesController,
  crearPromocionController,
  actualizarEstadoPromocionController,
  vincularPublicacionController,
} from "./promociones.controller.js";

const router = Router();

router.use(authMiddleware, isAdmin);

router.get("/", listarPromocionesController);
router.post("/", crearPromocionController);
router.patch("/:id/estado", actualizarEstadoPromocionController);
router.post("/:id/publicaciones", vincularPublicacionController);

export default router;
</file>

<file path="backend/src/modules/promociones/promociones.service.js">
import { prisma } from "../../config/prisma.js";

export const listarPromocionesService = () =>
  prisma.$queryRaw`
    SELECT * FROM PROMOCION
    ORDER BY fecha_inicio DESC
  `;

export async function crearPromocionService(body) {
  const {
    id_tipo_promocion,
    nombre,
    descripcion,
    creditos_otorgados,
    fecha_inicio,
    fecha_fin,
    estado = "ACTIVA",
  } = body;

  if (!id_tipo_promocion || !nombre || !creditos_otorgados || !fecha_inicio || !fecha_fin) {
    const err = new Error("Faltan datos obligatorios de promoci√≥n");
    err.status = 400;
    throw err;
  }

  await prisma.$queryRaw`
    INSERT INTO PROMOCION
      (id_tipo_promocion, nombre, descripcion, creditos_otorgados,
       fecha_inicio, fecha_fin, estado)
    VALUES
      (${id_tipo_promocion}, ${nombre}, ${descripcion || null}, ${creditos_otorgados},
       ${fecha_inicio}, ${fecha_fin}, ${estado})
  `;

  const [row] = await prisma.$queryRaw`
    SELECT * FROM PROMOCION
    WHERE id_promocion = LAST_INSERT_ID()
    LIMIT 1
  `;
  return row;
}

export async function actualizarEstadoPromocionService(idPromocion, estado) {
  await prisma.$queryRaw`
    UPDATE PROMOCION
    SET estado = ${estado}
    WHERE id_promocion = ${idPromocion}
  `;
  const [row] = await prisma.$queryRaw`
    SELECT * FROM PROMOCION
    WHERE id_promocion = ${idPromocion}
    LIMIT 1
  `;
  return row;
}

export async function vincularPublicacionService(idPromocion, idPublicacion) {
  if (!idPublicacion) {
    const err = new Error("id_publicacion es obligatorio");
    err.status = 400;
    throw err;
  }
  await prisma.$queryRaw`
    INSERT IGNORE INTO PROMOCION_PUBLICACION (id_promocion, id_publicacion)
    VALUES (${idPromocion}, ${idPublicacion})
  `;
}
</file>

<file path="backend/src/modules/publicaciones/publicaciones.controller.js">
import {
  listarPublicacionesService,
  obtenerPublicacionService,
  crearPublicacionProductoService,
  crearPublicacionServicioService,
  misPublicacionesService,
  buscarPublicacionesService,
  crearCalificacionService,
  listarCalificacionesService,
} from "./publicaciones.service.js";

export const listarPublicacionesController = async (req, res, next) => {
  try {
    const { categoria, estado } = req.query;
    res.json(await listarPublicacionesService({ categoria, estado }));
  } catch (e) { next(e); }
};

export const obtenerPublicacionController = async (req, res, next) => {
  try { res.json(await obtenerPublicacionService(+req.params.id)); }
  catch (e) { next(e); }
};

export const crearPublicacionProductoController = async (req, res, next) => {
  try {
    const idUsuario = req.user.id_usuario;
    const pub = await crearPublicacionProductoService(idUsuario, req.body);
    res.status(201).json(pub);
  } catch (e) { next(e); }
};

export const crearPublicacionServicioController = async (req, res, next) => {
  try {
    const idUsuario = req.user.id_usuario;
    const pub = await crearPublicacionServicioService(idUsuario, req.body);
    res.status(201).json(pub);
  } catch (e) { next(e); }
};

export const misPublicacionesController = async (req, res, next) => {
  try {
    const idUsuario = req.user.id_usuario;
    res.json(await misPublicacionesService(idUsuario));
  } catch (e) { next(e); }
};

export const buscarPublicacionesController = async (req, res, next) => {
  try { res.json(await buscarPublicacionesService(req.query.q || "")); }
  catch (e) { next(e); }
};

export const crearCalificacionController = async (req, res, next) => {
  try {
    const idUsuario = req.user.id_usuario;
    const idPublicacion = +req.params.id;
    const { estrellas, comentario } = req.body;
    const calif = await crearCalificacionService({
      idUsuario, idPublicacion, estrellas, comentario,
    });
    res.status(201).json(calif);
  } catch (e) { next(e); }
};

export const listarCalificacionesController = async (req, res, next) => {
  try {
    res.json(await listarCalificacionesService(+req.params.id));
  } catch (e) { next(e); }
};
</file>

<file path="backend/src/modules/publicaciones/publicaciones.routes.js">
import { Router } from "express";
import { authMiddleware } from "../../middlewares/auth.js";
import {
  listarPublicacionesController,
  obtenerPublicacionController,
  crearPublicacionProductoController,
  crearPublicacionServicioController,
  misPublicacionesController,
  buscarPublicacionesController,
  crearCalificacionController,
  listarCalificacionesController,
} from "./publicaciones.controller.js";

const router = Router();

// p√∫blicas
router.get("/", listarPublicacionesController);
router.get("/busqueda", buscarPublicacionesController);
router.get("/:id", obtenerPublicacionController);
router.get("/:id/calificaciones", listarCalificacionesController);

// protegidas
router.use(authMiddleware);

router.get("/mias/listado", misPublicacionesController);
router.post("/producto", crearPublicacionProductoController);
router.post("/servicio", crearPublicacionServicioController);
router.post("/:id/calificaciones", crearCalificacionController);

export default router;
</file>

<file path="backend/src/modules/publicaciones/publicaciones.service.js">
import { prisma } from "../../config/prisma.js";

// Listar b√°sicas (sin joins pesados)
export async function listarPublicacionesService({ categoria, estado }) {
  let where = "WHERE 1=1";
  const params = [];

  if (categoria) {
    where += " AND p.id_categoria = ?";
    params.push(parseInt(categoria, 10));
  }
  if (estado) {
    where += " AND p.estado = ?";
    params.push(estado);
  }

  const sql = `
    SELECT p.id_publicacion, p.titulo, p.descripcion, p.valor_creditos,
           p.estado, p.imagen_url, c.nombre AS categoria, u.nombre AS usuario
    FROM PUBLICACION p
    JOIN CATEGORIA c ON c.id_categoria = p.id_categoria
    JOIN USUARIO u ON u.id_usuario = p.id_usuario
    ${where}
    ORDER BY p.creado_en DESC
  `;
  // @ts-ignore
  return prisma.$queryRawUnsafe(sql, ...params);
}

export async function obtenerPublicacionService(idPublicacion) {
  const [row] = await prisma.$queryRaw`
    SELECT p.*, c.nombre AS categoria, u.nombre AS usuario
    FROM PUBLICACION p
    JOIN CATEGORIA c ON c.id_categoria = p.id_categoria
    JOIN USUARIO u ON u.id_usuario = p.id_usuario
    WHERE p.id_publicacion = ${idPublicacion}
    LIMIT 1
  `;
  if (!row) {
    const err = new Error("Publicaci√≥n no encontrada");
    err.status = 404;
    throw err;
  }
  return row;
}

export async function misPublicacionesService(idUsuario) {
  return prisma.$queryRaw`
    SELECT p.*
    FROM PUBLICACION p
    WHERE p.id_usuario = ${idUsuario}
    ORDER BY p.creado_en DESC
  `;
}

// Crear PRODUCTO + PUBLICACION + PUBLICACION_PRODUCTO
export async function crearPublicacionProductoService(idUsuario, body) {
  const {
    titulo,
    descripcion,
    id_categoria,
    valor_creditos,
    imagen_url,
    producto,         // { nombre, descripcion, precio, peso }
    cantidad,
    id_um,
  } = body;

  if (!titulo || !descripcion || !id_categoria || !valor_creditos || !producto || !cantidad || !id_um) {
    const err = new Error("Faltan datos obligatorios");
    err.status = 400;
    throw err;
  }

  return prisma.$transaction(async (tx) => {
    const prod = await tx.$queryRaw`
      INSERT INTO PRODUCTO (id_categoria, nombre, descripcion, precio, peso)
      VALUES (${id_categoria}, ${producto.nombre}, ${producto.descripcion || null},
              ${producto.precio || null}, ${producto.peso || null})
    `;

    const [newProd] = await tx.$queryRaw`
      SELECT * FROM PRODUCTO
      WHERE id_producto = LAST_INSERT_ID()
      LIMIT 1
    `;

    const tipoProducto = await tx.$queryRaw`
      SELECT id_tipo_publicacion
      FROM TIPO_PUBLICACION
      WHERE nombre = 'PRODUCTO'
      LIMIT 1
    `;
    if (!tipoProducto.length) {
      const err = new Error("No existe TIPO_PUBLICACION PRODUCTO");
      err.status = 500;
      throw err;
    }

    await tx.$queryRaw`
      INSERT INTO PUBLICACION
        (id_usuario, id_categoria, id_tipo_publicacion, titulo, descripcion, valor_creditos, imagen_url)
      VALUES
        (${idUsuario}, ${id_categoria}, ${tipoProducto[0].id_tipo_publicacion},
         ${titulo}, ${descripcion}, ${valor_creditos}, ${imagen_url || null})
    `;

    const [pub] = await tx.$queryRaw`
      SELECT * FROM PUBLICACION WHERE id_publicacion = LAST_INSERT_ID() LIMIT 1
    `;

    await tx.$queryRaw`
      INSERT INTO PUBLICACION_PRODUCTO (id_publicacion, id_producto, cantidad, id_um)
      VALUES (${pub.id_publicacion}, ${newProd.id_producto}, ${cantidad}, ${id_um})
    `;

    return pub;
  });
}

// Crear SERVICIO + PUBLICACION + PUBLICACION_SERVICIO
export async function crearPublicacionServicioService(idUsuario, body) {
  const {
    titulo,
    descripcion,
    id_categoria,
    valor_creditos,
    imagen_url,
    servicio, // { nombre, descripcion, precio, duracion_min }
    horario,
  } = body;

  if (!titulo || !descripcion || !id_categoria || !valor_creditos || !servicio || !horario) {
    const err = new Error("Faltan datos obligatorios");
    err.status = 400;
    throw err;
  }

  return prisma.$transaction(async (tx) => {
    await tx.$queryRaw`
      INSERT INTO SERVICIO (id_categoria, estado, nombre, descripcion, precio, duracion_min)
      VALUES (${id_categoria}, 'ACTIVO', ${servicio.nombre}, ${servicio.descripcion || null},
              ${servicio.precio || null}, ${servicio.duracion_min || null})
    `;

    const [serv] = await tx.$queryRaw`
      SELECT * FROM SERVICIO WHERE id_servicio = LAST_INSERT_ID() LIMIT 1
    `;

    const tipoServicio = await tx.$queryRaw`
      SELECT id_tipo_publicacion
      FROM TIPO_PUBLICACION
      WHERE nombre = 'SERVICIO'
      LIMIT 1
    `;
    if (!tipoServicio.length) {
      const err = new Error("No existe TIPO_PUBLICACION SERVICIO");
      err.status = 500;
      throw err;
    }

    await tx.$queryRaw`
      INSERT INTO PUBLICACION
        (id_usuario, id_categoria, id_tipo_publicacion, titulo, descripcion, valor_creditos, imagen_url)
      VALUES
        (${idUsuario}, ${id_categoria}, ${tipoServicio[0].id_tipo_publicacion},
         ${titulo}, ${descripcion}, ${valor_creditos}, ${imagen_url || null})
    `;

    const [pub] = await tx.$queryRaw`
      SELECT * FROM PUBLICACION WHERE id_publicacion = LAST_INSERT_ID() LIMIT 1
    `;

    await tx.$queryRaw`
      INSERT INTO PUBLICACION_SERVICIO (id_publicacion, id_servicio, horario)
      VALUES (${pub.id_publicacion}, ${serv.id_servicio}, ${horario})
    `;

    return pub;
  });
}

// B√∫squeda FULLTEXT
export async function buscarPublicacionesService(q) {
  if (!q.trim()) return [];
  return prisma.$queryRawUnsafe(
    `
    SELECT id_publicacion, titulo, descripcion, valor_creditos, imagen_url
    FROM PUBLICACION
    WHERE MATCH(titulo, descripcion) AGAINST (? IN NATURAL LANGUAGE MODE)
      AND estado = 'PUBLICADA'
    ORDER BY creado_en DESC
    `,
    q
  );
}

// Calificaciones
export async function crearCalificacionService({
  idUsuario,
  idPublicacion,
  estrellas,
  comentario,
}) {
  if (!estrellas) {
    const err = new Error("estrellas es obligatorio");
    err.status = 400;
    throw err;
  }

  await prisma.$queryRaw`
    INSERT INTO CALIFICACION (id_usuario, id_publicacion, estrellas, comentario)
    VALUES (${idUsuario}, ${idPublicacion}, ${estrellas}, ${comentario || null})
    ON DUPLICATE KEY UPDATE
      estrellas = VALUES(estrellas),
      comentario = VALUES(comentario)
  `;

  const [row] = await prisma.$queryRaw`
    SELECT * FROM CALIFICACION
    WHERE id_usuario = ${idUsuario} AND id_publicacion = ${idPublicacion}
    LIMIT 1
  `;
  return row;
}

export async function listarCalificacionesService(idPublicacion) {
  return prisma.$queryRaw`
    SELECT c.*, u.nombre
    FROM CALIFICACION c
    JOIN USUARIO u ON u.id_usuario = c.id_usuario
    WHERE c.id_publicacion = ${idPublicacion}
    ORDER BY c.id_calificacion DESC
  `;
}
</file>

<file path="backend/src/modules/publicidad/publicidad.controller.js">
// src/modules/publicidad/publicidad.controller.js

// Servicios propios del m√≥dulo PUBLICIDAD
import {
  crearPublicidadService,
  listarPublicidadActivaService,
  listarPublicidadAdminService,
} from "./publicidad.service.js";

// Servicio del m√≥dulo PUBLICACIONES (ruta correcta)
import { buscarPublicacionesService } from "../publicaciones/publicaciones.service.js";

/**
 * Convierte BigInt, Date, Prisma.Decimal, etc. en tipos JSON-safe
 */
function toPlain(value) {
  if (typeof value === "bigint") return Number(value);

  if (value instanceof Date)
    return value.toISOString().slice(0, 19).replace("T", " ");

  if (value && typeof value === "object") {
    if (typeof value.toNumber === "function") {
      return value.toNumber();
    }

    const prim = value.valueOf?.();
    if (prim != null && typeof prim !== "object") return prim;

    if (Array.isArray(value)) return value.map((v) => toPlain(v));

    const out = {};
    for (const [k, v] of Object.entries(value)) out[k] = toPlain(v);
    return out;
  }

  return value;
}

/**
 * POST /api/publicidad
 * Crear anuncio publicitario (solo admin)
 */
export const crearPublicidadController = async (req, res, next) => {
  try {
    const idUsuario = req.user.id_usuario;
    const data = await crearPublicidadService(idUsuario, req.body);
    res.status(201).json(toPlain(data));
  } catch (err) {
    next(err);
  }
};

/**
 * GET /api/publicidad/activa
 * Publicidad visible para el FRONT (solo activas y en rango)
 */
export const listarPublicidadActivaController = async (req, res, next) => {
  try {
    const data = await listarPublicidadActivaService();
    res.json(toPlain(data));
  } catch (err) {
    next(err);
  }
};

/**
 * GET /api/publicidad/admin
 * Lista TODA la publicidad (panel administrador)
 */
export const listarPublicidadAdminController = async (req, res, next) => {
  try {
    const data = await listarPublicidadAdminService();
    res.json(toPlain(data));
  } catch (err) {
    next(err);
  }
};

/**
 * GET /api/publicidad/buscar-publicaciones?q=
 * Buscar publicaciones para vincularlas a un banner
 */
export const buscarPublicacionesParaPublicidadController = async (
  req,
  res,
  next
) => {
  try {
    const q = req.query.q || "";
    const data = await buscarPublicacionesService(q);
    res.json(toPlain(data));
  } catch (err) {
    next(err);
  }
};
</file>

<file path="backend/src/modules/publicidad/publicidad.routes.js">
import { Router } from "express";
import { authMiddleware } from "../../middlewares/auth.js";
import {
  listarPublicidadActivaController,
  crearPublicidadController,
} from "./publicidad.controller.js";

const router = Router();

router.get("/", listarPublicidadActivaController);

router.use(authMiddleware);
router.post("/", crearPublicidadController);

export default router;
</file>

<file path="backend/src/modules/publicidad/publicidad.service.js">
// src/modules/publicidad/publicidad.service.js
import { prisma } from "../../config/prisma.js";

// Publicidad visible para el FRONT (activa y en rango de fechas)
export const listarPublicidadActivaService = () =>
  prisma.$queryRaw`
    SELECT p.*, u.nombre AS usuario
    FROM PUBLICIDAD p
    JOIN USUARIO u ON u.id_usuario = p.id_usuario
    WHERE p.estado = 'ACTIVA'
      AND NOW() BETWEEN p.fecha_inicio AND p.fecha_fin
    ORDER BY p.fecha_inicio DESC, p.id_publicidad DESC
  `;

// Publicidad para ADMIN (toda la publicidad)
export const listarPublicidadAdminService = () =>
  prisma.$queryRaw`
    SELECT p.*, u.nombre AS usuario
    FROM PUBLICIDAD p
    JOIN USUARIO u ON u.id_usuario = p.id_usuario
    ORDER BY p.fecha_inicio DESC, p.id_publicidad DESC
  `;

// Crear una nueva PUBLICIDAD
export const crearPublicidadService = async (idUsuario, body) => {
  const {
    id_ubicacion,
    titulo,
    descripcion,
    url_destino,
    fecha_inicio,
    fecha_fin,
    costo_creditos,
  } = body;

  if (!id_ubicacion || !titulo || !fecha_inicio || !fecha_fin || !costo_creditos) {
    const err = new Error("Faltan datos obligatorios de publicidad");
    err.status = 400;
    throw err;
  }

  // INSERT
  await prisma.$queryRaw`
    INSERT INTO PUBLICIDAD
      (id_usuario, id_ubicacion, estado, titulo, descripcion, url_destino,
       fecha_inicio, fecha_fin, costo_creditos)
    VALUES
      (
        ${idUsuario},
        ${id_ubicacion},
        'PROGRAMADA',
        ${titulo},
        ${descripcion || null},
        ${url_destino || null},
        ${fecha_inicio},
        ${fecha_fin},
        ${costo_creditos}
      )
  `;

  // Devolver el registro reci√©n creado
  const [row] = await prisma.$queryRaw`
    SELECT *
    FROM PUBLICIDAD
    WHERE id_publicidad = LAST_INSERT_ID()
    LIMIT 1
  `;
  return row;
};
</file>

<file path="backend/src/modules/reportes/reportes.controller.js">
// src/modules/reportes/reportes.controller.js
import { prisma } from '../../config/prisma.js'

function toPlain(value) {
  // BigInt primitivo
  if (typeof value === 'bigint') {
    return Number(value)
  }

  // Date -> string "YYYY-MM-DD HH:MM:SS"
  if (value instanceof Date) {
    return value.toISOString().slice(0, 19).replace('T', ' ')
  }

  // Objetos tipo Decimal u otros wrappers con valueOf()/toNumber()
  if (value && typeof value === 'object') {
    // Si tiene toNumber (ej. Prisma.Decimal)
    if (typeof value.toNumber === 'function') {
      return value.toNumber()
    }

    // valueOf devuelve primitivo (n√∫mero, string, etc.)
    const prim = value.valueOf?.()
    if (prim != null && typeof prim !== 'object') {
      return prim
    }

    // Array -> recursivo
    if (Array.isArray(value)) {
      return value.map(toPlain)
    }

    // Objeto plano: iterar propiedades
    const out = {}
    for (const [k, v] of Object.entries(value)) {
      out[k] = toPlain(v)
    }
    return out
  }

  // number, string, null, undefined, boolean
  return value
}

function normalizeResult(raw) {
  if (!raw) return []

  if (Array.isArray(raw)) {
    if (raw.length > 0 && Array.isArray(raw[0])) return raw[0]
    return raw
  }

  if (typeof raw === 'object') return [raw]

  return []
}

// Rango de fechas por defecto: √∫ltimos 30 d√≠as

function getRangoFechas(req) {
  const { desde, hasta } = req.query

  const ahora = new Date()
  const defaultHasta = ahora.toISOString().slice(0, 19).replace('T', ' ')
  const defaultDesdeDate = new Date(
    ahora.getTime() - 30 * 24 * 60 * 60 * 1000
  )
  const defaultDesde = defaultDesdeDate
    .toISOString()
    .slice(0, 19)
    .replace('T', ' ')

  return {
    desde: desde ? `${desde} 00:00:00` : defaultDesde,
    hasta: hasta ? `${hasta} 23:59:59` : defaultHasta,
  }
}

//  Mapeos de columnas f0, f1... -> nombres reales


// sp_rep_usuarios_activos:
// id_usuario, nombre, correo, primera_actividad, ultima_actividad, total_acciones
function mapUsuarioActivo(r) {
  return {
    id_usuario: r.id_usuario ?? r.f0 ?? null,
    nombre: r.nombre ?? r.f1 ?? null,
    correo: r.correo ?? r.f2 ?? null,
    primera_actividad: r.primera_actividad ?? r.f3 ?? null,
    ultima_actividad: r.ultima_actividad ?? r.f4 ?? null,
    total_acciones: r.total_acciones ?? r.f5 ?? null,
  }
}

// sp_rep_usuarios_abandonados:
// id_usuario, nombre, correo, estado
function mapUsuarioAbandonado(r) {
  return {
    id_usuario: r.id_usuario ?? r.f0 ?? null,
    nombre: r.nombre ?? r.f1 ?? null,
    correo: r.correo ?? r.f2 ?? null,
    estado: r.estado ?? r.f3 ?? null,
  }
}

// sp_rep_ingresos_creditos:
// fecha, total_creditos, total_bs
function mapIngresoCreditos(r) {
  return {
    fecha: r.fecha ?? r.f0 ?? null,
    total_creditos: r.total_creditos ?? r.f1 ?? null,
    total_bs: r.total_bs ?? r.f2 ?? null,
  }
}

// sp_rep_intercambios_por_categoria:
// categoria, total_intercambios
function mapIntercambiosCategoria(r) {
  return {
    categoria: r.categoria ?? r.f0 ?? null,
    total_intercambios: r.total_intercambios ?? r.f1 ?? null,
  }
}

// sp_rep_publicaciones_vs_intercambios:
// categoria, publicaciones, intercambios, ratio_intercambio
function mapPublicacionesVsIntercambios(r) {
  return {
    categoria: r.categoria ?? r.f0 ?? null,
    publicaciones: r.publicaciones ?? r.f1 ?? null,
    intercambios: r.intercambios ?? r.f2 ?? null,
    ratio_intercambio: r.ratio_intercambio ?? r.f3 ?? null,
  }
}

// sp_rep_impacto_acumulado:
// id_usuario, total_co2_ahorrado, total_agua_ahorrada,
// total_energia_ahorrada, total_transacciones, total_usuarios_activos
function mapImpacto(r) {
  return {
    id_usuario: r.id_usuario ?? r.f0 ?? null,
    total_co2_ahorrado: r.total_co2_ahorrado ?? r.f1 ?? null,
    total_agua_ahorrada: r.total_agua_ahorrada ?? r.f2 ?? null,
    total_energia_ahorrada: r.total_energia_ahorrada ?? r.f3 ?? null,
    total_transacciones: r.total_transacciones ?? r.f4 ?? null,
    total_usuarios_activos: r.total_usuarios_activos ?? r.f5 ?? null,
  }
}

// sp_obtener_ranking_usuarios:
// id_usuario, co2_total, agua_total, energia_total, transacciones
function mapRankingUsuarios(r) {
  return {
    id_usuario: r.id_usuario ?? r.f0 ?? null,
    co2_total: r.co2_total ?? r.f1 ?? null,
    agua_total: r.agua_total ?? r.f2 ?? null,
    energia_total: r.energia_total ?? r.f3 ?? null,
    transacciones: r.transacciones ?? r.f4 ?? null,
  }
}

// sp_rep_usuarios_premium:
// desde, hasta, total_usuarios_activos,
// usuarios_nuevos_premium, usuarios_premium_activos,
// ingresos_suscripcion_bs, porcentaje_adopcion_premium
function mapUsuariosPremium(r) {
  return {
    desde: r.desde ?? r.f0 ?? null,
    hasta: r.hasta ?? r.f1 ?? null,
    total_usuarios_activos: r.total_usuarios_activos ?? r.f2 ?? null,
    usuarios_nuevos_premium: r.usuarios_nuevos_premium ?? r.f3 ?? null,
    usuarios_premium_activos: r.usuarios_premium_activos ?? r.f4 ?? null,
    ingresos_suscripcion_bs: r.ingresos_suscripcion_bs ?? r.f5 ?? null,
    porcentaje_adopcion_premium:
      r.porcentaje_adopcion_premium ?? r.f6 ?? null,
  }
}

// Usuarios nuevos (calculados por primer login en BITACORA_ACCESO)
// id_usuario, nombre, correo, fecha_primer_login
function mapUsuariosNuevos(r) {
  return {
    id_usuario: r.id_usuario ?? r.f0 ?? null,
    nombre: r.nombre ?? r.f1 ?? null,
    correo: r.correo ?? r.f2 ?? null,
    fecha_primer_login: r.fecha_primer_login ?? r.f3 ?? null,
  }
}

// Saldos de cr√©ditos por usuario
// id_usuario, nombre, correo, saldo_creditos
function mapSaldoUsuario(r) {
  return {
    id_usuario: r.id_usuario ?? r.f0 ?? null,
    nombre: r.nombre ?? r.f1 ?? null,
    correo: r.correo ?? r.f2 ?? null,
    saldo_creditos: r.saldo_creditos ?? r.f3 ?? null,
  }
}

// Actividades sostenibles por usuario
// id_usuario, nombre, correo, total_actividades, creditos_otorgados
function mapActividadSostenible(r) {
  return {
    id_usuario: r.id_usuario ?? r.f0 ?? null,
    nombre: r.nombre ?? r.f1 ?? null,
    correo: r.correo ?? r.f2 ?? null,
    total_actividades: r.total_actividades ?? r.f3 ?? null,
    creditos_otorgados: r.creditos_otorgados ?? r.f4 ?? null,
  }
}

// Impacto ambiental por categor√≠a
// categoria, co2_total, agua_total, energia_total
function mapImpactoCategoria(r) {
  return {
    categoria: r.categoria ?? r.f0 ?? null,
    co2_total: r.co2_total ?? r.f1 ?? null,
    agua_total: r.agua_total ?? r.f2 ?? null,
    energia_total: r.energia_total ?? r.f3 ?? null,
  }
}

//   CONTROLADORES

/* C1) Usuarios activos en el rango */
export async function getUsuariosActivos(req, res, next) {
  try {
    const { desde, hasta } = getRangoFechas(req)
    const raw = await prisma.$queryRawUnsafe(
      'CALL sp_rep_usuarios_activos(?, ?)',
      desde,
      hasta
    )
    const rows = normalizeResult(raw).map(mapUsuarioActivo)
    res.json(toPlain(rows))
  } catch (err) {
    next(err)
  }
}

/* C2) Usuarios abandonados en el rango */
export async function getUsuariosAbandonados(req, res, next) {
  try {
    const { desde, hasta } = getRangoFechas(req)
    const raw = await prisma.$queryRawUnsafe(
      'CALL sp_rep_usuarios_abandonados(?, ?)',
      desde,
      hasta
    )
    const rows = normalizeResult(raw).map(mapUsuarioAbandonado)
    res.json(toPlain(rows))
  } catch (err) {
    next(err)
  }
}

/* C3) Ingresos por venta de cr√©ditos */
export async function getIngresosCreditos(req, res, next) {
  try {
    const { desde, hasta } = getRangoFechas(req)
    const raw = await prisma.$queryRawUnsafe(
      'CALL sp_rep_ingresos_creditos(?, ?)',
      desde,
      hasta
    )
    const rows = normalizeResult(raw).map(mapIngresoCreditos)
    res.json(toPlain(rows))
  } catch (err) {
    next(err)
  }
}

/* C4) Cr√©ditos generados vs consumidos */
export async function getCreditosGeneradosVsConsumidos(req, res, next) {
  try {
    const { desde, hasta } = getRangoFechas(req)
    const raw = await prisma.$queryRawUnsafe(
      'CALL sp_rep_creditos_generados_vs_consumidos(?, ?)',
      desde,
      hasta
    )

    const rows = normalizeResult(raw)
    const base = rows[0] || {}

    const creditos_generados = base.creditos_generados ?? base.f0 ?? 0
    const creditos_consumidos = base.creditos_consumidos ?? base.f1 ?? 0

    const resumen = {
      creditos_generados: Number(creditos_generados ?? 0),
      creditos_consumidos: Number(creditos_consumidos ?? 0),
      saldo_neto:
        Number(creditos_generados ?? 0) -
        Number(creditos_consumidos ?? 0),
    }

    res.json(toPlain(resumen))
  } catch (err) {
    next(err)
  }
}

/* C5) Intercambios por categor√≠a */
export async function getIntercambiosPorCategoria(req, res, next) {
  try {
    const { desde, hasta } = getRangoFechas(req)
    const raw = await prisma.$queryRawUnsafe(
      'CALL sp_rep_intercambios_por_categoria(?, ?)',
      desde,
      hasta
    )
    const rows = normalizeResult(raw).map(mapIntercambiosCategoria)
    res.json(toPlain(rows))
  } catch (err) {
    next(err)
  }
}

/* C6) Publicaciones vs intercambios por categor√≠a */
export async function getPublicacionesVsIntercambios(req, res, next) {
  try {
    const { desde, hasta } = getRangoFechas(req)
    const raw = await prisma.$queryRawUnsafe(
      'CALL sp_rep_publicaciones_vs_intercambios(?, ?)',
      desde,
      hasta
    )
    const rows = normalizeResult(raw).map(mapPublicacionesVsIntercambios)
    res.json(toPlain(rows))
  } catch (err) {
    next(err)
  }
}

/* C7) Impacto ambiental acumulado (usa TIPO_REPORTE + PERIODO) */
export async function getImpactoAcumulado(req, res, next) {
  try {
    let { idTipoReporte, idPeriodo } = req.query

    if (!idTipoReporte || !idPeriodo) {
      return res.status(400).json({
        ok: false,
        message: 'idTipoReporte e idPeriodo son requeridos',
      })
    }

    idTipoReporte = Number(idTipoReporte)
    idPeriodo = Number(idPeriodo)

    const raw = await prisma.$queryRawUnsafe(
      'CALL sp_rep_impacto_acumulado(?, ?)',
      idTipoReporte,
      idPeriodo
    )

    const rows = normalizeResult(raw).map(mapImpacto)
    res.json(toPlain(rows))
  } catch (err) {
    next(err)
  }
}

/* C8) Ranking de usuarios por impacto (top N) */
export async function getRankingUsuarios(req, res, next) {
  try {
    // opcionales: vienen por query ?idPeriodo=&limit=
    let { idPeriodo, limit } = req.query
    const pPeriodo = idPeriodo ? Number(idPeriodo) : null // el SP acepta NULL
    const pLimit = limit ? Number(limit) : 10

    const raw = await prisma.$queryRawUnsafe(
      'CALL sp_obtener_ranking_usuarios(?, ?)',
      pPeriodo,
      pLimit
    )

    const rows = normalizeResult(raw).map(mapRankingUsuarios)
    res.json(toPlain(rows))
  } catch (err) {
    next(err)
  }
}

/* C9) Reporte de usuarios premium */
export async function getUsuariosPremium(req, res, next) {
  try {
    const { desde, hasta } = getRangoFechas(req)

    const raw = await prisma.$queryRawUnsafe(
      'CALL sp_rep_usuarios_premium(?, ?)',
      desde,
      hasta
    )

    const rows = normalizeResult(raw).map(mapUsuariosPremium)
    res.json(toPlain(rows))
  } catch (err) {
    next(err)
  }
}

/* C10) Usuarios nuevos (por fecha de primer login) */
export async function getUsuariosNuevos(req, res, next) {
  try {
    const { desde, hasta } = getRangoFechas(req)

    const raw = await prisma.$queryRawUnsafe(
      `
      SELECT
        u.id_usuario,
        u.nombre,
        u.correo,
        MIN(b.fecha) AS fecha_primer_login
      FROM USUARIO u
      JOIN BITACORA_ACCESO b
        ON b.id_usuario = u.id_usuario
      GROUP BY u.id_usuario, u.nombre, u.correo
      HAVING fecha_primer_login BETWEEN ? AND ?
      ORDER BY fecha_primer_login
      `,
      desde,
      hasta
    )

    const rows = normalizeResult(raw).map(mapUsuariosNuevos)
    res.json(toPlain(rows))
  } catch (err) {
    next(err)
  }
}

/* C11) Saldos de cr√©ditos por usuario (top N opcional) */
export async function getSaldosCreditos(req, res, next) {
  try {
    const limit = req.query.limit ? Number(req.query.limit) : 50

    const raw = await prisma.$queryRawUnsafe(
      `
      SELECT
        u.id_usuario,
        u.nombre,
        u.correo,
        b.saldo_creditos
      FROM USUARIO u
      JOIN BILLETERA b
        ON b.id_usuario = u.id_usuario
      ORDER BY b.saldo_creditos DESC
      LIMIT ?
      `,
      limit
    )

    const rows = normalizeResult(raw).map(mapSaldoUsuario)
    res.json(toPlain(rows))
  } catch (err) {
    next(err)
  }
}

/* C12) Resumen de actividades sostenibles por usuario */
export async function getActividadesSostenibles(req, res, next) {
  try {
    const { desde, hasta } = getRangoFechas(req)

    const raw = await prisma.$queryRawUnsafe(
      `
      SELECT
        u.id_usuario,
        u.nombre,
        u.correo,
        COUNT(a.id_actividad) AS total_actividades,
        SUM(a.creditos_otorgados) AS creditos_otorgados
      FROM ACTIVIDAD_SOSTENIBLE a
      JOIN USUARIO u
        ON u.id_usuario = a.id_usuario
      WHERE a.creado_en BETWEEN ? AND ?
      GROUP BY u.id_usuario, u.nombre, u.correo
      ORDER BY total_actividades DESC
      `,
      desde,
      hasta
    )

    const rows = normalizeResult(raw).map(mapActividadSostenible)
    res.json(toPlain(rows))
  } catch (err) {
    next(err)
  }
}

/* C13) Impacto ambiental por categor√≠a (usa PERIODO) */
export async function getImpactoPorCategoria(req, res, next) {
  try {
    const { idPeriodo } = req.query
    if (!idPeriodo) {
      return res
        .status(400)
        .json({ ok: false, message: 'idPeriodo es requerido' })
    }

    const raw = await prisma.$queryRawUnsafe(
      `
      SELECT
        c.nombre AS categoria,
        SUM(ia.co2_ahorrado)     AS co2_total,
        SUM(ia.agua_ahorrada)    AS agua_total,
        SUM(ia.energia_ahorrada) AS energia_total
      FROM IMPACTO_AMBIENTAL ia
      JOIN TRANSACCION t
        ON t.id_transaccion = ia.id_transaccion
      JOIN PUBLICACION p
        ON p.id_publicacion = t.id_publicacion
      JOIN CATEGORIA c
        ON c.id_categoria = p.id_categoria
      WHERE ia.id_periodo = ?
      GROUP BY c.nombre
      ORDER BY co2_total DESC
      `,
      Number(idPeriodo)
    )

    const rows = normalizeResult(raw).map(mapImpactoCategoria)
    res.json(toPlain(rows))
  } catch (err) {
    next(err)
  }
}
</file>

<file path="backend/src/modules/reportes/reportes.routes.js">
// src/modules/reportes/reportes.routes.js
import { Router } from "express";
import {
  getUsuariosActivos,
  getUsuariosAbandonados,
  getIngresosCreditos,
  getCreditosGeneradosVsConsumidos,
  getIntercambiosPorCategoria,
  getPublicacionesVsIntercambios,
  getImpactoAcumulado,
  getRankingUsuarios,
  getUsuariosPremium,
  getUsuariosNuevos,
  getSaldosCreditos,
  getActividadesSostenibles,
  getImpactoPorCategoria,
} from "./reportes.controller.js";

const router = Router();

/*  REPORTES PRINCIPALES */

// ‚úî Usuarios activos
router.get("/usuarios-activos", getUsuariosActivos);

// ‚úî Usuarios abandonados
router.get("/usuarios-abandonados", getUsuariosAbandonados);

// ‚úî Ingresos por venta de cr√©ditos
router.get("/ingresos-creditos", getIngresosCreditos);

// ‚úî Cr√©ditos generados vs consumidos
router.get("/creditos-generados-consumidos", getCreditosGeneradosVsConsumidos);

// ‚úî Intercambios por categor√≠a
router.get("/intercambios-categoria", getIntercambiosPorCategoria);

// ‚úî Publicaciones vs intercambios
router.get("/publicaciones-vs-intercambios", getPublicacionesVsIntercambios);

// ‚úî Impacto ecol√≥gico acumulado
router.get("/impacto-acumulado", getImpactoAcumulado);


/* REPORTES AVANZADOS */

// ‚úî Ranking de usuarios (top N)
router.get("/ranking-usuarios", getRankingUsuarios);

// ‚úî Reporte de usuarios premium
router.get("/usuarios-premium", getUsuariosPremium);

// ‚úî Usuarios nuevos (primer login)
router.get("/usuarios-nuevos", getUsuariosNuevos);

// ‚úî Saldos de cr√©ditos (top N)
router.get("/saldos-usuarios", getSaldosCreditos);

// ‚úî Actividades sostenibles
router.get("/actividades-sostenibles", getActividadesSostenibles);

// ‚úî Impacto ambiental por categor√≠a (por per√≠odo)
router.get("/impacto-categoria", getImpactoPorCategoria);

export default router;
</file>

<file path="backend/src/modules/uploads/multer.js">
// uploads/multer.js
import multer from "multer";
import { v4 as uuid } from "uuid";
import path from "path";

const storage = multer.diskStorage({
  destination: (req, file, cb) => {
    cb(null, "uploads_storage"); // carpeta real donde iran las im√°genes
  },
  filename: (req, file, cb) => {
    const unique = uuid();
    const ext = path.extname(file.originalname);
    cb(null, unique + ext);
  },
});

export const upload = multer({ storage });
</file>

<file path="backend/src/modules/uploads/uploads.controller.js">
import { procesarArchivoService } from "./uploads.service.js";

export const subirArchivoController = async (req, res, next) => {
  try {
    if (!req.file) {
      return res.status(400).json({ message: "No enviaste ning√∫n archivo" });
    }

    const url = await procesarArchivoService(req.file);

    res.json({
      message: "Archivo subido correctamente",
      url,
    });
  } catch (err) {
    next(err);
  }
};
</file>

<file path="backend/src/modules/uploads/uploads.routes.js">
import { Router } from "express";
import { authMiddleware } from "../../middlewares/auth.js";
import { upload } from "./multer.js";
import { subirArchivoController } from "./uploads.controller.js";

const router = Router();

// Ruta protegida: requiere login
router.post("/", authMiddleware, upload.single("archivo"), subirArchivoController);

export default router;
</file>

<file path="backend/src/modules/uploads/uploads.service.js">
import path from "path";

export async function procesarArchivoService(file) {
  // URL p√∫blica final (aj√∫stala seg√∫n tu hosting)
  const url = `/uploads/${file.filename}`;

  // Puedes almacenar archivo en S3, Cloudinary o FS local.
  // Aqu√≠ usamos local para desarrollo.
  
  return url;
}
</file>

<file path="backend/src/modules/usuarios/usuarios.controller.js">
import {
  listarUsuariosService,
  crearUsuarioAdminService,
  actualizarUsuarioService,
  cambiarEstadoUsuarioService,
  obtenerHistorialUsuarioService,
} from "./usuarios.service.js";

export async function listarUsuariosController(req, res, next) {
  try {
    const usuarios = await listarUsuariosService();
    res.json(usuarios);
  } catch (err) {
    next(err);
  }
}

export async function crearUsuarioAdminController(req, res, next) {
  try {
    const usuario = await crearUsuarioAdminService(req.body);
    res.status(201).json(usuario);
  } catch (err) {
    next(err);
  }
}

export async function actualizarUsuarioController(req, res, next) {
  try {
    const id = parseInt(req.params.id, 10);
    const usuario = await actualizarUsuarioService(id, req.body);
    res.json(usuario);
  } catch (err) {
    next(err);
  }
}

export async function cambiarEstadoUsuarioController(req, res, next) {
  try {
    const id = parseInt(req.params.id, 10);
    const { estado } = req.body;
    const usuario = await cambiarEstadoUsuarioService(id, estado);
    res.json(usuario);
  } catch (err) {
    next(err);
  }
}

export async function obtenerHistorialUsuarioController(req, res, next) {
  try {
    const id = parseInt(req.params.id, 10);
    const historial = await obtenerHistorialUsuarioService(id);
    res.json(historial);
  } catch (err) {
    next(err);
  }
}
</file>

<file path="backend/src/modules/usuarios/usuarios.routes.js">
import { Router } from "express";
import { authMiddleware } from "../../middlewares/auth.js";
import { isAdmin } from "../../middlewares/isAdmin.js";
import {
  listarUsuariosController,
  crearUsuarioAdminController,
  actualizarUsuarioController,
  cambiarEstadoUsuarioController,
  obtenerHistorialUsuarioController,
} from "./usuarios.controller.js";

const router = Router();

// Todo lo de aqu√≠ requiere admin
router.use(authMiddleware, isAdmin);

// GET /api/usuarios
router.get("/", listarUsuariosController);

// POST /api/usuarios
router.post("/", crearUsuarioAdminController);

// PUT /api/usuarios/:id
router.put("/:id", actualizarUsuarioController);

// PATCH /api/usuarios/:id/estado
router.patch("/:id/estado", cambiarEstadoUsuarioController);

// GET /api/usuarios/:id/historial
router.get("/:id/historial", obtenerHistorialUsuarioController);

export default router;
</file>

<file path="backend/src/modules/usuarios/usuarios.service.js">
import bcrypt from "bcryptjs";
import { prisma } from "../../config/prisma.js";

export async function listarUsuariosService() {
  const rows = await prisma.$queryRaw`
    SELECT u.id_usuario, u.nombre, u.apellido, u.correo, u.telefono,
           u.estado, r.nombre AS rol
    FROM USUARIO u
    JOIN ROL r ON r.id_rol = u.id_rol
    ORDER BY u.id_usuario DESC
  `;
  return rows;
}

export async function crearUsuarioAdminService({
  nombre,
  apellido,
  correo,
  telefono,
  password,
  id_rol,
  estado = "ACTIVO",
}) {
  if (!nombre || !correo || !password || !id_rol) {
    const err = new Error("nombre, correo, password e id_rol son obligatorios");
    err.status = 400;
    throw err;
  }

  const existente = await prisma.$queryRaw`
    SELECT id_usuario FROM USUARIO WHERE correo = ${correo} LIMIT 1
  `;
  if (existente.length) {
    const error = new Error("El correo ya est√° registrado");
    error.status = 409;
    throw error;
  }

  const hash = await bcrypt.hash(password, 10);

  await prisma.$queryRaw`
    INSERT INTO USUARIO (id_rol, estado, nombre, apellido, correo, password_hash, telefono, url_perfil)
    VALUES (${id_rol}, ${estado}, ${nombre}, ${apellido || null}, ${correo}, ${hash},
            ${telefono || null}, NULL)
  `;

  const rows = await prisma.$queryRaw`
    SELECT u.id_usuario, u.nombre, u.apellido, u.correo, u.telefono,
           u.estado, r.nombre AS rol
    FROM USUARIO u
    JOIN ROL r ON r.id_rol = u.id_rol
    WHERE u.correo = ${correo}
    LIMIT 1
  `;
  return rows[0];
}

export async function actualizarUsuarioService(idUsuario, data) {
  const { nombre, apellido, telefono, id_rol } = data;

  await prisma.$queryRaw`
    UPDATE USUARIO
    SET nombre = COALESCE(${nombre}, nombre),
        apellido = COALESCE(${apellido}, apellido),
        telefono = COALESCE(${telefono}, telefono),
        id_rol = COALESCE(${id_rol}, id_rol)
    WHERE id_usuario = ${idUsuario}
  `;

  const rows = await prisma.$queryRaw`
    SELECT u.id_usuario, u.nombre, u.apellido, u.correo, u.telefono,
           u.estado, r.nombre AS rol
    FROM USUARIO u
    JOIN ROL r ON r.id_rol = u.id_rol
    WHERE u.id_usuario = ${idUsuario}
    LIMIT 1
  `;
  if (!rows.length) {
    const err = new Error("Usuario no encontrado");
    err.status = 404;
    throw err;
  }
  return rows[0];
}

export async function cambiarEstadoUsuarioService(idUsuario, estado) {
  if (!estado) {
    const err = new Error("estado es obligatorio");
    err.status = 400;
    throw err;
  }

  await prisma.$queryRaw`
    UPDATE USUARIO
    SET estado = ${estado}
    WHERE id_usuario = ${idUsuario}
  `;

  const rows = await prisma.$queryRaw`
    SELECT u.id_usuario, u.nombre, u.apellido, u.correo, u.telefono,
           u.estado, r.nombre AS rol
    FROM USUARIO u
    JOIN ROL r ON r.id_rol = u.id_rol
    WHERE u.id_usuario = ${idUsuario}
    LIMIT 1
  `;
  if (!rows.length) {
    const err = new Error("Usuario no encontrado");
    err.status = 404;
    throw err;
  }
  return rows[0];
}

export async function obtenerHistorialUsuarioService(idUsuario) {
  // Llama a tu SP sp_obtener_historial_usuario
  const result = await prisma.$queryRawUnsafe(
    "CALL sp_obtener_historial_usuario(?)",
    idUsuario
  );
  // En MySQL, CALL devuelve [rows, meta]; nos quedamos con rows[0]
  return result[0] || result;
}
</file>

<file path="backend/src/modules/wallet/wallet.controller.js">
import {
  obtenerMisCreditosService,
  obtenerMisMovimientosService,
  comprarCreditosService,
  obtenerMisComprasService,
} from "./wallet.service.js";

export async function getMisCreditosController(req, res, next) {
  try {
    const idUsuario = req.user.id_usuario;
    const data = await obtenerMisCreditosService(idUsuario);
    res.json(data);
  } catch (err) {
    next(err);
  }
}

export async function getMisMovimientosController(req, res, next) {
  try {
    const idUsuario = req.user.id_usuario;
    const data = await obtenerMisMovimientosService(idUsuario);
    res.json(data);
  } catch (err) {
    next(err);
  }
}

export async function postCompraCreditosController(req, res, next) {
  try {
    const idUsuario = req.user.id_usuario;
    const { idPaquete, idTransaccionPago } = req.body;

    if (!idPaquete) {
      return res.status(400).json({ message: "idPaquete es obligatorio" });
    }

    const billetera = await comprarCreditosService({
      idUsuario,
      idPaquete,
      idTransaccionPago: idTransaccionPago || null,
    });

    res.status(201).json({
      message: "Compra aprobada",
      billetera,
    });
  } catch (err) {
    next(err);
  }
}

export async function getMisComprasController(req, res, next) {
  try {
    const idUsuario = req.user.id_usuario;
    const compras = await obtenerMisComprasService(idUsuario);
    res.json(compras);
  } catch (err) {
    next(err);
  }
}
</file>

<file path="backend/src/modules/wallet/wallet.routes.js">
import { Router } from "express";
import { authMiddleware } from "../../middlewares/auth.js";
import {
  getMisCreditosController,
  getMisMovimientosController,
  postCompraCreditosController,
  getMisComprasController,
} from "./wallet.controller.js";

const router = Router();

router.use(authMiddleware);

// GET /api/wallet/mis-creditos
router.get("/mis-creditos", getMisCreditosController);

// GET /api/wallet/mis-movimientos
router.get("/mis-movimientos", getMisMovimientosController);

// POST /api/wallet/compra-creditos
router.post("/compra-creditos", postCompraCreditosController);

// GET /api/wallet/compras
router.get("/compras", getMisComprasController);

export default router;
</file>

<file path="backend/src/modules/wallet/wallet.service.js">
import { prisma } from "../../config/prisma.js";

// Helper para convertir BigInt / Decimal a Number
function toNumberSafe(value, def = 0) {
  if (value == null) return def;

  if (typeof value === "bigint") return Number(value);

  if (typeof value === "object" && typeof value.toNumber === "function") {
    return value.toNumber();
  }

  const num = Number(value);
  return Number.isNaN(num) ? def : num;
}

function normalizeBilleteraRow(row) {
  if (!row) {
    return {
      saldo_creditos: 0,
      saldo_bs: 0,
    };
  }

  return {
    saldo_creditos: toNumberSafe(row.saldo_creditos, 0),
    saldo_bs: toNumberSafe(row.saldo_bs, 0),
  };
}

export async function obtenerMisCreditosService(idUsuario) {
  const rows = await prisma.$queryRaw`
    SELECT saldo_creditos, saldo_bs
    FROM BILLETERA
    WHERE id_usuario = ${idUsuario}
    LIMIT 1
  `;

  return normalizeBilleteraRow(rows[0]);
}

export async function obtenerMisMovimientosService(idUsuario) {
  const rows = await prisma.$queryRaw`
    SELECT m.id_movimiento,
           m.cantidad,
           m.saldo_anterior,
           m.saldo_posterior,
           m.id_referencia,
           m.creado_en,
           tm.nombre AS tipo_movimiento,
           tr.nombre AS tipo_referencia
    FROM MOVIMIENTO_CREDITOS m
    JOIN TIPO_MOVIMIENTO tm ON tm.id_tipo_movimiento = m.id_tipo_movimiento
    JOIN TIPO_REFERENCIA tr ON tr.id_tipo_referencia = m.id_tipo_referencia
    WHERE m.id_usuario = ${idUsuario}
    ORDER BY m.creado_en DESC, m.id_movimiento DESC
  `;

  // si quieres, aqu√≠ tambi√©n podr√≠as normalizar BigInt, pero por ahora lo dejamos
  return rows;
}

export async function comprarCreditosService({
  idUsuario,
  idPaquete,
  idTransaccionPago,
}) {
  // Llamar al SP
  await prisma.$executeRawUnsafe(
    "CALL sp_compra_creditos_aprobar(?, ?, ?)",
    idUsuario,
    idPaquete,
    idTransaccionPago
  );

  const rows = await prisma.$queryRaw`
    SELECT saldo_creditos, saldo_bs
    FROM BILLETERA
    WHERE id_usuario = ${idUsuario}
    LIMIT 1
  `;

  return normalizeBilleteraRow(rows[0]);
}

export async function obtenerMisComprasService(idUsuario) {
  const rows = await prisma.$queryRaw`
    SELECT c.id_compra,
           c.id_paquete,
           p.nombre AS paquete,
           p.cantidad_creditos,
           c.monto_bs,
           c.estado,
           c.id_transaccion_pago,
           c.creado_en
    FROM COMPRA_CREDITOS c
    JOIN PAQUETE_CREDITOS p ON p.id_paquete = c.id_paquete
    WHERE c.id_usuario = ${idUsuario}
    ORDER BY c.creado_en DESC, c.id_compra DESC
  `;
  return rows;
}
</file>

<file path="backend/src/routes/index.js">
// src/routes/index.js
import { Router } from 'express';

import authRoutes from '../modules/auth/auth.routes.js';
import usuariosRoutes from '../modules/usuarios/usuarios.routes.js';
import catalogosRoutes from '../modules/catalogos/catalogos.routes.js';
import walletRoutes from '../modules/wallet/wallet.routes.js';
import publicacionesRoutes from '../modules/publicaciones/publicaciones.routes.js';
import intercambiosRoutes from '../modules/intercambios/intercambios.routes.js';
import actividadesRoutes from '../modules/actividades/actividades.routes.js';
import promocionesRoutes from '../modules/promociones/promociones.routes.js';
import publicidadRoutes from '../modules/publicidad/publicidad.routes.js';
import logrosRoutes from '../modules/logros/logros.routes.js';
import premiumRoutes from '../modules/premium/premium.routes.js';
import reportesRoutes from '../modules/reportes/reportes.routes.js';
import uploadsRoutes from '../modules/uploads/uploads.routes.js';

const router = Router();

// üîπ Health check (para el Home del frontend)
router.get("/health", (req, res) => {
  res.json({
    ok: true,
    message: "API Digital Barter OK",
  });
});

// Rutas de m√≥dulos
router.use('/auth', authRoutes);
router.use('/usuarios', usuariosRoutes);
router.use('/catalogos', catalogosRoutes);
router.use('/wallet', walletRoutes);
router.use('/publicaciones', publicacionesRoutes);
router.use('/intercambios', intercambiosRoutes);
router.use('/actividades-sostenibles', actividadesRoutes);
router.use('/promociones', promocionesRoutes);
router.use('/publicidad', publicidadRoutes);
router.use('/logros', logrosRoutes);
router.use('/premium', premiumRoutes);
router.use('/reportes', reportesRoutes);
router.use('/uploads', uploadsRoutes);

export default router;
</file>

<file path="backend/src/server.js">
// src/server.js
import app from './app.js'
import { env } from './config/env.js'

const PORT = env.PORT

app.listen(PORT, () => {
    console.log(`üöÄ API running on http://localhost:${PORT}`)
})
</file>

<file path="backend/utils/jsonBigInt.js">
export function toJsonSafe(value) {
  if (typeof value === "bigint") {
    return Number(value);            // <- si prefieres string: value.toString()
  }

  if (Array.isArray(value)) {
    return value.map(toJsonSafe);
  }

  if (value !== null && typeof value === "object") {
    const out = {};
    for (const key in value) {
      out[key] = toJsonSafe(value[key]);
    }
    return out;
  }

  return value;
}
</file>

<file path="docker-compose.yml">
version: "3.9"
services:
  db:
    image: mysql:8.0
    restart: unless-stopped
    environment:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_DATABASE: appdb
    ports:
      - "3306:3306"
    volumes:
      - db_data:/var/lib/mysql
      - ./infra/db/init.sql:/docker-entrypoint-initdb.d/1-init.sql
      - ./infra/db/seed.sql:/docker-entrypoint-initdb.d/2-seed.sql
  backend:
    build: ./backend
    working_dir: /app
    env_file: ./backend/.env
    depends_on:
      - db
    ports:
      - "4000:4000"
    command: sh -c "npx prisma migrate deploy && node src/server.js"
    volumes:
      - ./backend:/app
  frontend:
    build: ./frontend
    working_dir: /app
    ports:
      - "5173:5173"
    environment:
      - VITE_API_URL=http://localhost:4000/api
    command: npm run dev -- --host
    volumes:
      - ./frontend:/app
volumes:
  db_data:
</file>

<file path="frontend/index.html">
<!doctype html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <title>Digital Barter</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  </head>
  <body class="bg-gray-100">
    <div id="root"></div>
    <script type="module" src="/src/main.jsx"></script>
  </body>
</html>
</file>

<file path="frontend/package.json">
{
  "name": "frontend",
  "version": "0.0.1",
  "private": true,
  "scripts": {
    "dev": "vite",
    "build": "vite build",
    "preview": "vite preview"
  },
  "dependencies": {
    "lucide-react": "^0.555.0",
    "react": "^18.3.1",
    "react-dom": "^18.3.1",
    "react-router-dom": "^6.28.0",
    "recharts": "^3.4.1"
  },
  "devDependencies": {
    "@vitejs/plugin-react": "^4.3.4",
    "autoprefixer": "^10.4.20",
    "postcss": "^8.4.49",
    "tailwindcss": "^3.4.14",
    "vite": "^5.4.0"
  }
}
</file>

<file path="frontend/postcss.config.js">
module.exports = {
  plugins: {
    tailwindcss: {},
    autoprefixer: {}
  }
};
</file>

<file path="frontend/src/App.jsx">
import React from "react";
import AppRouter from "./router.jsx";

export default function App() {
  return <AppRouter />;
}
</file>

<file path="frontend/src/components/Layout.jsx">
import React from "react";
import Navbar from "./Navbar.jsx";

export default function Layout({ children }) {
  return (
    <div className="min-h-screen flex flex-col">
      <Navbar />
      <main className="flex-1 max-w-6xl w-full mx-auto px-4 py-4">
        {children}
      </main>
    </div>
  );
}
</file>

<file path="frontend/src/components/Navbar.jsx">
// src/components/Navbar.jsx
import React from "react";
import hoja from "../assets/hoja.png";

export default function Navbar() {
  return (
    <nav className="w-full bg-[#0b3a2c] border-b border-emerald-600 px-6 py-4 flex items-center justify-between shadow-md">
      
      {/* LOGO */}
      <div className="flex items-center gap-3 cursor-pointer"
        onClick={() => (window.location.href = "/home")}
      >
        <img src={hoja} className="w-9 h-9 drop-shadow-lg" />
        <h1 className="text-2xl font-bold text-emerald-400">
          Digital Barter
        </h1>
      </div>

      {/* BOTONES DE NAVEGACI√ìN */}
      <div className="flex items-center gap-6">

        {/* PERFIL */}
        <a
          href="/perfil"
          className="text-white hover:text-emerald-400 transition font-semibold"
        >
          Perfil
        </a>

        {/* WALLET */}
        <a
          href="/wallet"
          className="text-white hover:text-emerald-400 transition font-semibold"
        >
          Wallet
        </a>

        {/* PUBLICACIONES */}
        <a
          href="/publicaciones"
          className="text-white hover:text-emerald-400 transition font-semibold"
        >
          Publicaciones
        </a>

        {/* ACTIVIDADES */}
        <a
          href="/actividades"
          className="text-white hover:text-emerald-400 transition font-semibold"
        >
          Actividades
        </a>

        {/* PREMIUM */}
        <a
          href="/premium"
          className="text-white hover:text-yellow-400 transition font-semibold"
        >
          Premium
        </a>
        {/* INTERCAMBIOS */}
        <a
          href="/intercambios"
          className="text-white hover:text-emerald-400 transition font-semibold"
        >
          Intercambios
        </a>
        {/* PROMOCIONES (solo admin) */}
        <a
          href="/promociones"
          className="text-white hover:text-emerald-400 transition font-semibold"
        >
          Promociones
        </a>
        {/* üîé NUEVO: REPORTES */}
        <a
          href="/reportes"
          className="px-3 py-1.5 rounded-full border border-emerald-400/70 bg-emerald-500/10 text-emerald-100 text-xs font-semibold tracking-wide uppercase hover:bg-emerald-500/20 hover:border-emerald-300 transition"
        >
          Reportes
        </a>
        <a
          href="/publicidad"
          className="text-white hover:text-emerald-400 transition font-semibold"
        >
          Publicidad
        </a>

        {/* CERRAR SESI√ìN */}
        <button
          onClick={() => {
            localStorage.removeItem("token");
            window.location.href = "/login";
          }}
          className="bg-emerald-500 hover:bg-emerald-600 px-4 py-1 rounded-lg text-white font-semibold transition"
        >
          Salir
        </button>
      </div>
    </nav>
  );
}
</file>

<file path="frontend/src/components/ProtectedRoute.jsx">
import React from "react";
import { Navigate, useLocation } from "react-router-dom";

export default function ProtectedRoute({ children }) {
  const token = localStorage.getItem("token");
  const location = useLocation();

  if (!token) {
    return <Navigate to="/login" state={{ from: location }} replace />;
  }

  return children;
}
</file>

<file path="frontend/src/index.css">
@tailwind base;
@tailwind components;
@tailwind utilities;

/* estilos globales */
body {
  @apply bg-gray-100 text-gray-900;
}

.btn-primary {
  @apply inline-flex items-center justify-center px-4 py-2 rounded-md bg-blue-600 text-white text-sm font-medium hover:bg-blue-700 transition;
}

.card {
  @apply bg-white rounded-lg shadow-sm border border-gray-200 p-4;
}
</file>

<file path="frontend/src/main.jsx">
import React from "react";
import ReactDOM from "react-dom/client";
import { BrowserRouter } from "react-router-dom";
import App from "./App.jsx";
import "./index.css";

ReactDOM.createRoot(document.getElementById("root")).render(
  <React.StrictMode>
    <BrowserRouter>
      <App />
    </BrowserRouter>
  </React.StrictMode>
);
</file>

<file path="frontend/src/pages/Actividades.jsx">
// digital-barder/frontend/src/pages/Actividades.jsx
import { useState } from "react";
import { useNavigate } from "react-router-dom";
import { registrarActividadSostenible } from "../services/api";
import { ArrowLeft, Leaf, CheckCircle2 } from "lucide-react";
import hoja from "../assets/hoja.png";

export default function Actividades() {
  const navigate = useNavigate();

  const [idTipoActividad, setIdTipoActividad] = useState("");
  const [descripcion, setDescripcion] = useState("");
  const [creditos, setCreditos] = useState("");
  const [evidenciaUrl, setEvidenciaUrl] = useState("");
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState("");
  const [mensajeOk, setMensajeOk] = useState("");
  const [ultimaActividad, setUltimaActividad] = useState(null);

  async function handleSubmit(e) {
    e.preventDefault();
    setError("");
    setMensajeOk("");
    setUltimaActividad(null);

    const id_tipo_actividad = Number(idTipoActividad);
    const creditos_otorgados = Number(creditos);

    if (
      Number.isNaN(id_tipo_actividad) ||
      Number.isNaN(creditos_otorgados) ||
      !descripcion.trim()
    ) {
      setError(
        "id_tipo_actividad, descripci√≥n y cr√©ditos otorgados son obligatorios y deben ser v√°lidos."
      );
      return;
    }

    try {
      setLoading(true);

      const act = await registrarActividadSostenible({
        id_tipo_actividad,
        descripcion,
        creditos_otorgados,
        evidencia_url: evidenciaUrl || null,
      });

      setMensajeOk("Actividad registrada correctamente üå±");
      setUltimaActividad(act);

      // limpiar parcialmente
      setDescripcion("");
      setCreditos("");
      setEvidenciaUrl("");
    } catch (err) {
      console.error(err);
      setError(
        err.message || "Ocurri√≥ un error al registrar la actividad sostenible."
      );
    } finally {
      setLoading(false);
    }
  }

  return (
    <div className="min-h-screen bg-[#082b1f] text-white p-6 md:p-10">
      {/* HEADER */}
      <header className="flex items-center justify-between gap-3 mb-8">
        <div className="flex items-center gap-3">
          <button
            type="button"
            onClick={() => navigate(-1)}
            className="inline-flex items-center gap-2 rounded-full bg-black/30 px-3 py-1 text-sm hover:bg-black/40"
          >
            <ArrowLeft size={16} />
            Volver
          </button>
          <div className="flex items-center gap-2 rounded-2xl bg-emerald-900/70 px-3 py-2 text-sm">
            <Leaf size={18} className="text-emerald-300" />
            <span className="font-semibold">Actividades sostenibles</span>
          </div>
        </div>

        <div className="flex items-center gap-3">
          <button
            type="button"
            onClick={() => navigate("/actividades/mias")}
            className="px-4 py-2 rounded-lg border border-emerald-500 text-sm hover:bg-emerald-500/10 font-semibold"
          >
            Mis actividades
          </button>
          <img src={hoja} alt="logo" className="w-9 h-9 drop-shadow-md" />
        </div>
      </header>

      {/* DESCRIPCI√ìN */}
      <section className="mb-6 max-w-3xl">
        <h1 className="text-2xl font-semibold mb-2">
          Registrar actividad sostenible
        </h1>
        <p className="text-sm text-emerald-100/80">
          Aqu√≠ puedes registrar acciones ecol√≥gicas que realizaste (reciclaje,
          voluntariado, movilidad sostenible, etc.). El sistema las guardar√° en
          tu historial y te otorgar√° cr√©ditos verdes seg√∫n las reglas
          definidas por el administrador.
        </p>
      </section>

      {/* MENSAJES */}
      {error && (
        <div className="mb-4 rounded-md border border-red-400 bg-red-900/40 px-4 py-2 text-sm text-red-100">
          {error}
        </div>
      )}

      {mensajeOk && (
        <div className="mb-4 rounded-md border border-emerald-400 bg-emerald-900/40 px-4 py-2 text-sm text-emerald-100 flex items-center gap-2">
          <CheckCircle2 size={18} />
          <span>{mensajeOk}</span>
        </div>
      )}

      {/* FORMULARIO */}
      <form
        onSubmit={handleSubmit}
        className="max-w-3xl bg-[#0f3f2d] border border-emerald-700 rounded-2xl p-5 shadow-md space-y-4"
      >
        {/* id_tipo_actividad */}
        <div>
          <label className="block text-xs mb-1">
            ID tipo de actividad (id_tipo_actividad) *
          </label>
          <input
            type="number"
            value={idTipoActividad}
            onChange={(e) => setIdTipoActividad(e.target.value)}
            className="w-full rounded-lg border border-emerald-700 bg-emerald-950/80 px-3 py-2 text-sm outline-none focus:ring focus:ring-emerald-500/60"
            placeholder="Ej. 1 (Reciclaje), 2 (Movilidad sostenible), etc."
          />
          <p className="text-[11px] text-emerald-100/70 mt-1">
            Usa los IDs definidos en la tabla TIPO_ACTIVIDAD_SOSTENIBLE.
          </p>
        </div>

        {/* descripci√≥n */}
        <div>
          <label className="block text-xs mb-1">Descripci√≥n *</label>
          <textarea
            value={descripcion}
            onChange={(e) => setDescripcion(e.target.value)}
            rows={3}
            className="w-full rounded-lg border border-emerald-700 bg-emerald-950/80 px-3 py-2 text-sm outline-none focus:ring focus:ring-emerald-500/60"
            placeholder="Ej. Particip√© 3 horas en una campa√±a de reforestaci√≥n en el parque..."
          />
        </div>

        {/* cr√©ditos */}
        <div>
          <label className="block text-xs mb-1">
            Cr√©ditos otorgados (creditos_otorgados) *
          </label>
          <input
            type="number"
            value={creditos}
            onChange={(e) => setCreditos(e.target.value)}
            className="w-full rounded-lg border border-emerald-700 bg-emerald-950/80 px-3 py-2 text-sm outline-none focus:ring focus:ring-emerald-500/60"
            placeholder="Ej. 10"
          />
        </div>

        {/* evidencia_url */}
        <div>
          <label className="block text-xs mb-1">
            URL de evidencia (opcional)
          </label>
          <input
            type="url"
            value={evidenciaUrl}
            onChange={(e) => setEvidenciaUrl(e.target.value)}
            className="w-full rounded-lg border border-emerald-700 bg-emerald-950/80 px-3 py-2 text-sm outline-none focus:ring focus:ring-emerald-500/60"
            placeholder="Link a foto, drive, formulario, etc."
          />
        </div>

        <div className="pt-2 flex justify-end">
          <button
            type="submit"
            disabled={loading}
            className="px-6 py-2 rounded-lg bg-emerald-500 hover:bg-emerald-600 disabled:opacity-60 disabled:cursor-not-allowed text-sm font-semibold text-emerald-950"
          >
            {loading ? "Guardando..." : "Registrar actividad"}
          </button>
        </div>
      </form>

      {/* √öLTIMA ACTIVIDAD REGISTRADA (respuesta del backend) */}
      {ultimaActividad && (
        <section className="max-w-3xl mt-6 bg-[#0f3f2d] border border-emerald-700 rounded-2xl p-4 text-sm text-emerald-100/90">
          <p className="font-semibold mb-1">
            √öltima actividad registrada (respuesta del backend):
          </p>
          <pre className="text-xs overflow-x-auto">
            {JSON.stringify(ultimaActividad, null, 2)}
          </pre>
        </section>
      )}
    </div>
  );
}
</file>

<file path="frontend/src/pages/BackendLab.jsx">
// frontend/src/pages/BackendLab.jsx
import React, { useEffect, useState } from "react";

// Usa la misma URL base del backend que ya usas en el proyecto
const API_BASE_URL =
  import.meta.env.VITE_API_URL || "http://localhost:4000/api";

function loadToken() {
  return localStorage.getItem("token") || "";
}

export default function BackendLab() {
  const [token, setToken] = useState(loadToken());
  const [loading, setLoading] = useState(false);
  const [lastRequest, setLastRequest] = useState(null);
  const [lastResponse, setLastResponse] = useState(null);
  const [error, setError] = useState("");

  // ====== AUTH: registro / login ======
  const [regNombre, setRegNombre] = useState("Ana");
  const [regApellido, setRegApellido] = useState("Demo");
  const [regCorreo, setRegCorreo] = useState("ana.demo@example.com");
  const [regPassword, setRegPassword] = useState("ana12345");
  const [regTelefono, setRegTelefono] = useState("70000001");

  const [loginCorreo, setLoginCorreo] = useState("ana.demo@example.com");
  const [loginPassword, setLoginPassword] = useState("ana12345");

  // ====== Usuarios / historial ======
  const [userIdHistorial, setUserIdHistorial] = useState("");

  // ====== Wallet ======
  const [idPaquete, setIdPaquete] = useState("1");
  const [montoPagado, setMontoPagado] = useState("100");
  const [refPago, setRefPago] = useState("TEST-001");

  // ====== Intercambios ======
  const [idPublicacionInter, setIdPublicacionInter] = useState("");
  const [creditosInter, setCreditosInter] = useState("");

  // ====== Actividades ======
  const [idTipoAct, setIdTipoAct] = useState("1");
  const [descAct, setDescAct] = useState("Entreg√≥ 5kg de papel para reciclaje");
  const [credAct, setCredAct] = useState("10");

  // ====== Reportes ======
  const [desdeRep, setDesdeRep] = useState("2025-11-01");
  const [hastaRep, setHastaRep] = useState("2025-11-30");

  // ====== Request manual ======
  const [manualPath, setManualPath] = useState("/wallet/mis-creditos");
  const [manualMethod, setManualMethod] = useState("GET");
  const [manualBody, setManualBody] = useState("{\n  \n}");

  useEffect(() => {
    if (token) localStorage.setItem("token", token);
  }, [token]);

  async function callApi(moduleName, actionName, path, options = {}) {
    setError("");
    setLastResponse(null);

    const method = options.method || "GET";
    const bodyObj = options.body || null;

    setLastRequest({
      moduleName,
      actionName,
      method,
      url: API_BASE_URL + path,
      body: bodyObj,
    });

    try {
      setLoading(true);

      const headers = {
        "Content-Type": "application/json",
        ...(options.headers || {}),
      };

      if (token) {
        headers.Authorization = `Bearer ${token}`;
      }

      const res = await fetch(API_BASE_URL + path, {
        method,
        headers,
        body:
          bodyObj && ["POST", "PUT", "PATCH"].includes(method)
            ? JSON.stringify(bodyObj)
            : undefined,
      });

      let rawText = "";
      let data = null;
      try {
        rawText = await res.text();
        data = rawText ? JSON.parse(rawText) : null;
      } catch {
        data = rawText;
      }

      setLastResponse({
        status: res.status,
        ok: res.ok,
        data,
      });

      if (!res.ok) {
        setError(`Respuesta con error HTTP ${res.status}`);
      }
    } catch (err) {
      setError(err.message || "Error en la llamada");
    } finally {
      setLoading(false);
    }
  }

  // ====== AUTH: registro ======
  async function handleRegister(e) {
    e.preventDefault();
    await callApi("Auth", "POST /auth/register", "/auth/register", {
      method: "POST",
      body: {
        nombre: regNombre,
        apellido: regApellido,
        correo: regCorreo,
        password: regPassword,
        telefono: regTelefono,
      },
    });
  }

  // ====== AUTH: login ======
  async function handleLogin(e) {
    e.preventDefault();
    setError("");
    try {
      setLoading(true);

      const res = await fetch(API_BASE_URL + "/auth/login", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          correo: loginCorreo,
          password: loginPassword,
        }),
      });

      let raw = "";
      let data = null;
      try {
        raw = await res.text();
        data = raw ? JSON.parse(raw) : null;
      } catch {
        data = raw;
      }

      setLastRequest({
        moduleName: "Auth",
        actionName: "POST /auth/login",
        method: "POST",
        url: API_BASE_URL + "/auth/login",
        body: { correo: loginCorreo, password: "***" },
      });
      setLastResponse({
        status: res.status,
        ok: res.ok,
        data,
      });

      if (!res.ok) {
        setError(`Login fall√≥ con HTTP ${res.status}`);
        return;
      }

      if (data && data.token) {
        setToken(data.token);
      } else {
        setError("La respuesta de login no contiene token");
      }
    } catch (err) {
      setError(err.message || "Error en login");
    } finally {
      setLoading(false);
    }
  }

  // ====== REQUEST MANUAL ======
  async function handleManualCall(e) {
    e.preventDefault();
    let bodyParsed = null;
    if (manualMethod !== "GET" && manualBody.trim()) {
      try {
        bodyParsed = JSON.parse(manualBody);
      } catch {
        setError("El body manual no es JSON v√°lido");
        return;
      }
    }
    await callApi(
      "Manual",
      `${manualMethod} ${manualPath}`,
      manualPath,
      {
        method: manualMethod,
        body: bodyParsed,
      }
    );
  }

  return (
    <div className="space-y-4">
      {/* HEADER */}
      <header className="flex flex-col sm:flex-row justify-between gap-3 items-start sm:items-center">
        <div>
          <h2 className="text-xl font-semibold text-gray-900">
            Laboratorio completo de Backend
          </h2>
          <p className="text-sm text-gray-500">
            Registro, login e interacci√≥n con todos los m√≥dulos del backend para
            comprobar si las rutas responden correctamente.
          </p>
          <p className="text-xs text-gray-400 mt-1">
            API_BASE_URL: <code>{API_BASE_URL}</code>
          </p>
        </div>
        <div className="text-right text-xs">
          <p className="font-semibold">Token actual:</p>
          <p className="truncate max-w-xs text-gray-500">
            {token ? token : "(sin token)"}
          </p>
          <button
            className="mt-1 text-xs text-red-600 underline"
            onClick={() => {
              setToken("");
              localStorage.removeItem("token");
            }}
          >
            Limpiar token
          </button>
          {loading && (
            <p className="mt-1 text-emerald-600 font-medium">
              Ejecutando request...
            </p>
          )}
        </div>
      </header>

      {error && (
        <div className="bg-red-50 border-red-200 border text-red-700 text-sm px-3 py-2 rounded">
          {error}
        </div>
      )}

      {/* =========================================================
          1. AUTH: REGISTRO / LOGIN / ME
         ========================================================= */}
      <section className="card space-y-3">
        <p className="text-xs font-semibold uppercase text-gray-500">
          1. Autenticaci√≥n (Registro / Login / Perfil)
        </p>

        <div className="grid gap-3 md:grid-cols-2 text-xs">
          {/* REGISTRO */}
          <form onSubmit={handleRegister} className="space-y-2">
            <p className="font-semibold">Registro r√°pido</p>
            <div>
              <label className="block mb-1 font-medium">Nombre</label>
              <input
                type="text"
                value={regNombre}
                onChange={(e) => setRegNombre(e.target.value)}
                className="w-full border rounded px-2 py-1"
              />
            </div>
            <div>
              <label className="block mb-1 font-medium">Apellido</label>
              <input
                type="text"
                value={regApellido}
                onChange={(e) => setRegApellido(e.target.value)}
                className="w-full border rounded px-2 py-1"
              />
            </div>
            <div>
              <label className="block mb-1 font-medium">Correo</label>
              <input
                type="email"
                value={regCorreo}
                onChange={(e) => setRegCorreo(e.target.value)}
                className="w-full border rounded px-2 py-1"
              />
            </div>
            <div>
              <label className="block mb-1 font-medium">Tel√©fono</label>
              <input
                type="text"
                value={regTelefono}
                onChange={(e) => setRegTelefono(e.target.value)}
                className="w-full border rounded px-2 py-1"
              />
            </div>
            <div>
              <label className="block mb-1 font-medium">Contrase√±a</label>
              <input
                type="password"
                value={regPassword}
                onChange={(e) => setRegPassword(e.target.value)}
                className="w-full border rounded px-2 py-1"
              />
            </div>
            <button type="submit" className="btn-secondary">
              Registrar usuario
            </button>
          </form>

          {/* LOGIN */}
          <form onSubmit={handleLogin} className="space-y-2">
            <p className="font-semibold">Login</p>
            <div>
              <label className="block mb-1 font-medium">Correo</label>
              <input
                type="email"
                value={loginCorreo}
                onChange={(e) => setLoginCorreo(e.target.value)}
                className="w-full border rounded px-2 py-1"
              />
            </div>
            <div>
              <label className="block mb-1 font-medium">Contrase√±a</label>
              <input
                type="password"
                value={loginPassword}
                onChange={(e) => setLoginPassword(e.target.value)}
                className="w-full border rounded px-2 py-1"
              />
            </div>
            <button type="submit" className="btn-primary">
              Iniciar sesi√≥n
            </button>

            <div className="mt-2">
              <button
                type="button"
                className="btn-secondary"
                onClick={() =>
                  callApi("Auth", "GET /auth/me", "/auth/me")
                }
              >
                Probar /auth/me
              </button>
            </div>
          </form>
        </div>

        {/* Usuarios / historial */}
        <div className="border-t pt-2 mt-2 text-xs">
          <p className="font-semibold mb-1">Usuarios / historial</p>
          <div className="flex flex-wrap gap-2 items-end">
            <button
              className="btn-secondary"
              onClick={() =>
                callApi("Usuarios", "GET /usuarios", "/usuarios")
              }
            >
              Listar /usuarios (ADMIN)
            </button>
            <div className="flex gap-2 items-end">
              <div>
                <label className="block mb-1 font-medium">
                  ID usuario para historial:
                </label>
                <input
                  type="number"
                  value={userIdHistorial}
                  onChange={(e) => setUserIdHistorial(e.target.value)}
                  className="border rounded px-2 py-1"
                  placeholder="Ej: 1"
                />
              </div>
              <button
                className="btn-secondary"
                onClick={() =>
                  userIdHistorial &&
                  callApi(
                    "Usuarios",
                    `GET /usuarios/${userIdHistorial}/historial`,
                    `/usuarios/${userIdHistorial}/historial`
                  )
                }
              >
                Ver historial
              </button>
            </div>
          </div>
        </div>
      </section>

      {/* =========================================================
          2. CAT√ÅLOGOS
         ========================================================= */}
      <section className="card space-y-2">
        <p className="text-xs font-semibold uppercase text-gray-500">
          2. Cat√°logos
        </p>
        <div className="flex flex-wrap gap-2 text-xs">
          <button
            className="btn-secondary"
            onClick={() =>
              callApi("Cat√°logos", "GET /catalogos/categorias", "/catalogos/categorias")
            }
          >
            Categor√≠as
          </button>
          <button
            className="btn-secondary"
            onClick={() =>
              callApi(
                "Cat√°logos",
                "GET /catalogos/paquetes-creditos",
                "/catalogos/paquetes-creditos"
              )
            }
          >
            Paquetes cr√©ditos
          </button>
          <button
            className="btn-secondary"
            onClick={() =>
              callApi(
                "Cat√°logos",
                "GET /catalogos/tipos-actividad",
                "/catalogos/tipos-actividad"
              )
            }
          >
            Tipos actividad
          </button>
          <button
            className="btn-secondary"
            onClick={() =>
              callApi("Cat√°logos", "GET /catalogos/periodos", "/catalogos/periodos")
            }
          >
            Periodos
          </button>
          <button
            className="btn-secondary"
            onClick={() =>
              callApi(
                "Cat√°logos",
                "GET /catalogos/tipos-reporte",
                "/catalogos/tipos-reporte"
              )
            }
          >
            Tipos reporte
          </button>
        </div>
      </section>

      {/* =========================================================
          3. WALLET
         ========================================================= */}
      <section className="card space-y-2">
        <p className="text-xs font-semibold uppercase text-gray-500">
          3. Wallet / Billetera
        </p>
        <div className="flex flex-wrap gap-2 text-xs">
          <button
            className="btn-secondary"
            onClick={() =>
              callApi("Wallet", "GET /wallet/mis-creditos", "/wallet/mis-creditos")
            }
          >
            Mis cr√©ditos
          </button>
          <button
            className="btn-secondary"
            onClick={() =>
              callApi(
                "Wallet",
                "GET /wallet/mis-movimientos",
                "/wallet/mis-movimientos"
              )
            }
          >
            Mis movimientos
          </button>
          <button
            className="btn-secondary"
            onClick={() =>
              callApi("Wallet", "GET /wallet/compras", "/wallet/compras")
            }
          >
            Mis compras
          </button>
        </div>

        <div className="grid gap-2 md:grid-cols-4 text-xs mt-3">
          <div>
            <label className="block mb-1 font-medium">ID Paquete</label>
            <input
              type="number"
              value={idPaquete}
              onChange={(e) => setIdPaquete(e.target.value)}
              className="w-full border rounded px-2 py-1"
            />
          </div>
          <div>
            <label className="block mb-1 font-medium">Monto pagado (Bs.)</label>
            <input
              type="number"
              value={montoPagado}
              onChange={(e) => setMontoPagado(e.target.value)}
              className="w-full border rounded px-2 py-1"
            />
          </div>
          <div>
            <label className="block mb-1 font-medium">Referencia pago</label>
            <input
              type="text"
              value={refPago}
              onChange={(e) => setRefPago(e.target.value)}
              className="w-full border rounded px-2 py-1"
            />
          </div>
                    <button
            className="btn-primary w-full"
            onClick={() =>
                callApi(
                "Wallet",
                "POST /wallet/compra-creditos",
                "/wallet/compra-creditos",
                {
                    method: "POST",
                    body: {
                    idPaquete: Number(idPaquete),
                    montoPagado: Number(montoPagado),
                    referenciaPago: refPago,
                    },
                }
                )
            }
            >
            Comprar cr√©ditos
            </button>

        </div>
      </section>

      {/* =========================================================
          4. PUBLICACIONES
         ========================================================= */}
      <section className="card space-y-2">
        <p className="text-xs font-semibold uppercase text-gray-500">
          4. Publicaciones
        </p>
        <div className="flex flex-wrap gap-2 text-xs">
          <button
            className="btn-secondary"
            onClick={() =>
              callApi("Publicaciones", "GET /publicaciones", "/publicaciones")
            }
          >
            Listar /publicaciones
          </button>
          <button
            className="btn-secondary"
            onClick={() =>
              callApi(
                "Publicaciones",
                "GET /publicaciones/mias",
                "/publicaciones/mias"
              )
            }
          >
            Mis publicaciones
          </button>
          <button
            className="btn-secondary"
            onClick={() =>
              callApi(
                "Publicaciones",
                "GET /publicaciones/busqueda?q=bici",
                "/publicaciones/busqueda?q=bici"
              )
            }
          >
            Buscar (q=bici)
          </button>
        </div>
        <p className="text-xs text-gray-500 mt-1">
          ‚ö†Ô∏è Para crear publicaciones de prueba con todos los campos (producto /
          servicio) es m√°s c√≥modo usar tu Postman o el m√≥dulo de publicaciones del
          frontend final. Aqu√≠ nos enfocamos en comprobar que los listados devuelven
          datos y no rompen.
        </p>
      </section>

      {/* =========================================================
          5. INTERCAMBIOS
         ========================================================= */}
      <section className="card space-y-2">
        <p className="text-xs font-semibold uppercase text-gray-500">
          5. Intercambios
        </p>
        <div className="flex flex-wrap gap-2 text-xs">
          <button
            className="btn-secondary"
            onClick={() =>
              callApi(
                "Intercambios",
                "GET /intercambios/mis-compras",
                "/intercambios/mis-compras"
              )
            }
          >
            Mis compras
          </button>
          <button
            className="btn-secondary"
            onClick={() =>
              callApi(
                "Intercambios",
                "GET /intercambios/mis-ventas",
                "/intercambios/mis-ventas"
              )
            }
          >
            Mis ventas
          </button>
        </div>

        <div className="grid gap-2 md:grid-cols-3 text-xs mt-3">
          <div>
            <label className="block mb-1 font-medium">ID Publicaci√≥n</label>
            <input
              type="number"
              value={idPublicacionInter}
              onChange={(e) => setIdPublicacionInter(e.target.value)}
              className="w-full border rounded px-2 py-1"
            />
          </div>
          <div>
            <label className="block mb-1 font-medium">
              Cr√©ditos a intercambiar
            </label>
            <input
              type="number"
              value={creditosInter}
              onChange={(e) => setCreditosInter(e.target.value)}
              className="w-full border rounded px-2 py-1"
            />
          </div>
          <div className="flex items-end">
            <button
              className="btn-primary w-full"
              onClick={() =>
                idPublicacionInter &&
                creditosInter &&
                callApi(
                  "Intercambios",
                  "POST /intercambios",
                  "/intercambios",
                  {
                    method: "POST",
                    body: {
                      id_publicacion: Number(idPublicacionInter),
                      creditos: Number(creditosInter),
                    },
                  }
                )
              }
            >
              Crear intercambio
            </button>
          </div>
        </div>
      </section>

      {/* =========================================================
          6. ACTIVIDADES SOSTENIBLES
         ========================================================= */}
      <section className="card space-y-2">
        <p className="text-xs font-semibold uppercase text-gray-500">
          6. Actividades sostenibles
        </p>
        <div className="flex flex-wrap gap-2 text-xs">
          <button
            className="btn-secondary"
            onClick={() =>
              callApi(
                "Actividades",
                "GET /actividades-sostenibles/mias",
                "/actividades-sostenibles/mias"
              )
            }
          >
            Mis actividades
          </button>
        </div>

        <div className="grid gap-2 md:grid-cols-4 text-xs mt-3">
          <div>
            <label className="block mb-1 font-medium">ID tipo actividad</label>
            <input
              type="number"
              value={idTipoAct}
              onChange={(e) => setIdTipoAct(e.target.value)}
              className="w-full border rounded px-2 py-1"
            />
          </div>
          <div>
            <label className="block mb-1 font-medium">Cr√©ditos otorgados</label>
            <input
              type="number"
              value={credAct}
              onChange={(e) => setCredAct(e.target.value)}
              className="w-full border rounded px-2 py-1"
            />
          </div>
          <div className="md:col-span-2">
            <label className="block mb-1 font-medium">Descripci√≥n</label>
            <input
              type="text"
              value={descAct}
              onChange={(e) => setDescAct(e.target.value)}
              className="w-full border rounded px-2 py-1"
            />
          </div>
          <div className="md:col-span-4 flex justify-end">
            <button
              className="btn-primary"
              onClick={() =>
                callApi(
                  "Actividades",
                  "POST /actividades-sostenibles",
                  "/actividades-sostenibles",
                  {
                    method: "POST",
                    body: {
                      id_tipo_actividad: Number(idTipoAct),
                      descripcion: descAct,
                      creditos_otorgados: Number(credAct),
                      evidencia_url: null,
                    },
                  }
                )
              }
            >
              Registrar actividad
            </button>
          </div>
        </div>
      </section>

      {/* =========================================================
          7. PUBLICIDAD / PROMOS / LOGROS / PREMIUM
         ========================================================= */}
      <section className="card space-y-2">
        <p className="text-xs font-semibold uppercase text-gray-500">
          7. Publicidad / Promos / Logros / Premium
        </p>
        <div className="flex flex-wrap gap-2 text-xs">
          <button
            className="btn-secondary"
            onClick={() =>
              callApi("Publicidad", "GET /publicidad", "/publicidad")
            }
          >
            Publicidad activa
          </button>
          <button
            className="btn-secondary"
            onClick={() =>
              callApi(
                "Promociones",
                "GET /promociones/vigentes",
                "/promociones/vigentes"
              )
            }
          >
            Promos vigentes
          </button>
          <button
            className="btn-secondary"
            onClick={() =>
              callApi("Logros", "GET /logros/mis-logros", "/logros/mis-logros")
            }
          >
            Mis logros
          </button>
          <button
            className="btn-secondary"
            onClick={() =>
              callApi("Premium", "GET /premium/mi-plan", "/premium/mi-plan")
            }
          >
            Mi plan premium
          </button>
        </div>
      </section>

      {/* =========================================================
          8. REPORTES
         ========================================================= */}
      <section className="card space-y-2">
        <p className="text-xs font-semibold uppercase text-gray-500">
          8. Reportes (ADMIN)
        </p>

        <div className="grid gap-2 md:grid-cols-3 text-xs">
          <div>
            <label className="block mb-1 font-medium">Desde</label>
            <input
              type="date"
              value={desdeRep}
              onChange={(e) => setDesdeRep(e.target.value)}
              className="w-full border rounded px-2 py-1"
            />
          </div>
          <div>
            <label className="block mb-1 font-medium">Hasta</label>
            <input
              type="date"
              value={hastaRep}
              onChange={(e) => setHastaRep(e.target.value)}
              className="w-full border rounded px-2 py-1"
            />
          </div>
        </div>

        <div className="flex flex-wrap gap-2 text-xs mt-3">
          <button
            className="btn-secondary"
            onClick={() =>
              callApi(
                "Reportes",
                "GET /reportes/usuarios-activos",
                `/reportes/usuarios-activos?desde=${desdeRep}&hasta=${hastaRep}`
              )
            }
          >
            Usuarios activos
          </button>
          <button
            className="btn-secondary"
            onClick={() =>
              callApi(
                "Reportes",
                "GET /reportes/usuarios-abandonados",
                `/reportes/usuarios-abandonados?desde=${desdeRep}&hasta=${hastaRep}`
              )
            }
          >
            Usuarios abandonados
          </button>
          <button
            className="btn-secondary"
            onClick={() =>
              callApi(
                "Reportes",
                "GET /reportes/ingresos-creditos",
                `/reportes/ingresos-creditos?desde=${desdeRep}&hasta=${hastaRep}`
              )
            }
          >
            Ingresos cr√©ditos
          </button>
          <button
            className="btn-secondary"
            onClick={() =>
              callApi(
                "Reportes",
                "GET /reportes/creditos-generados-consumidos",
                `/reportes/creditos-generados-consumidos?desde=${desdeRep}&hasta=${hastaRep}`
              )
            }
          >
            Cr√©ditos gen. vs cons.
          </button>
          <button
            className="btn-secondary"
            onClick={() =>
              callApi(
                "Reportes",
                "GET /reportes/intercambios-categoria",
                `/reportes/intercambios-categoria?desde=${desdeRep}&hasta=${hastaRep}`
              )
            }
          >
            Intercambios x categor√≠a
          </button>
          <button
            className="btn-secondary"
            onClick={() =>
              callApi(
                "Reportes",
                "GET /reportes/publicaciones-intercambios",
                `/reportes/publicaciones-intercambios?desde=${desdeRep}&hasta=${hastaRep}`
              )
            }
          >
            Publ. vs intercambios
          </button>
          <button
            className="btn-secondary"
            onClick={() =>
                callApi(
                "Reportes",
                "GET /reportes/impacto-acumulado",
                `/reportes/impacto-acumulado?id_tipo_reporte=1&id_periodo=1`
                )
            }
            >
            Impacto acumulado
</button>

          <button
  className="btn-secondary"
  onClick={() =>
    callApi(
      "Reportes",
      "GET /reportes/ranking-usuarios",
      `/reportes/ranking-usuarios?id_periodo=1&limit=10`
    )
  }
>
  Ranking usuarios
</button>

        </div>
      </section>

      {/* =========================================================
          9. REQUEST MANUAL
         ========================================================= */}
      <section className="card space-y-2">
        <p className="text-xs font-semibold uppercase text-gray-500">
          9. Request manual (cualquier endpoint)
        </p>
        <form onSubmit={handleManualCall} className="space-y-2 text-xs">
          <div className="flex gap-2">
            <select
              value={manualMethod}
              onChange={(e) => setManualMethod(e.target.value)}
              className="border rounded px-2 py-1"
            >
              <option>GET</option>
              <option>POST</option>
              <option>PUT</option>
              <option>PATCH</option>
              <option>DELETE</option>
            </select>
            <input
              type="text"
              value={manualPath}
              onChange={(e) => setManualPath(e.target.value)}
              className="flex-1 border rounded px-2 py-1"
              placeholder="/ruta/del/endpoint"
            />
            <button type="submit" className="btn-primary">
              Ejecutar
            </button>
          </div>
          {manualMethod !== "GET" && (
            <textarea
              rows={4}
              value={manualBody}
              onChange={(e) => setManualBody(e.target.value)}
              className="w-full border rounded px-2 py-1 font-mono"
            />
          )}
        </form>
      </section>

      {/* =========================================================
          PANEL DE RESULTADOS
         ========================================================= */}
      <section className="card space-y-2">
        <p className="text-xs font-semibold uppercase text-gray-500">
          Resultado de la √∫ltima llamada
        </p>

        {lastRequest ? (
          <div className="text-xs space-y-1">
            <p>
              <span className="font-semibold">M√≥dulo:</span>{" "}
              {lastRequest.moduleName}
            </p>
            <p>
              <span className="font-semibold">Acci√≥n:</span>{" "}
              {lastRequest.actionName}
            </p>
            <p>
              <span className="font-semibold">M√©todo:</span>{" "}
              {lastRequest.method}
            </p>
            <p>
              <span className="font-semibold">URL:</span>{" "}
              <code>{lastRequest.url}</code>
            </p>
            {lastRequest.body && (
              <details className="mt-1">
                <summary className="cursor-pointer text-gray-600">
                  Body enviado
                </summary>
                <pre className="bg-gray-50 border rounded p-2 mt-1 overflow-x-auto">
{JSON.stringify(lastRequest.body, null, 2)}
                </pre>
              </details>
            )}
          </div>
        ) : (
          <p className="text-xs text-gray-400">
            A√∫n no ejecutaste ninguna llamada.
          </p>
        )}

        {lastResponse && (
          <div className="mt-3 text-xs">
            <p>
              <span className="font-semibold">Status:</span>{" "}
              {lastResponse.status}{" "}
              {lastResponse.ok ? "(OK)" : "(Error)"}
            </p>
            <details className="mt-1" open>
              <summary className="cursor-pointer text-gray-600">
                Ver JSON de respuesta
              </summary>
              <pre className="bg-gray-50 border rounded p-2 mt-1 overflow-x-auto">
{JSON.stringify(lastResponse.data, null, 2)}
              </pre>
            </details>
          </div>
        )}
      </section>
    </div>
  );
}
</file>

<file path="frontend/src/pages/ComprarCreditos.jsx">
import { useEffect, useState } from "react";
import { useNavigate } from "react-router-dom";
import { api } from "../services/api";
import { ArrowLeft, Wallet, CheckCircle } from "lucide-react";

export default function ComprarCreditos() {
  const [paquetes, setPaquetes] = useState([]);
  const [selected, setSelected] = useState(null);
  const [loading, setLoading] = useState(false);
  const [success, setSuccess] = useState(false);
  const [error, setError] = useState("");
  const navigate = useNavigate();

  // Cargar paquetes activos
  useEffect(() => {
    async function cargarPaquetes() {
      try {
        setError("");
        setSuccess(false);
        const data = await api("/catalogos/paquetes-creditos");
        // Asumimos que el backend devuelve un array simple de paquetes
        setPaquetes(Array.isArray(data) ? data : []);
      } catch (err) {
        console.error(err);
        setError("No se pudieron cargar los paquetes de cr√©ditos.");
      }
    }
    cargarPaquetes();
  }, []);

  async function comprar() {
    if (!selected) {
      setError("Debes seleccionar un paquete antes de comprar.");
      return;
    }

    const ok = window.confirm(
      `¬øConfirmas la compra del paquete "${selected.nombre}" por ${selected.precio_bs} Bs?`
    );
    if (!ok) return;

    try {
      setLoading(true);
      setError("");
      setSuccess(false);

      // üëá RUTA REAL DEL BACKEND: POST /api/wallet/compra-creditos
      //    y el controlador espera { idPaquete: ... }
      await api("/wallet/compra-creditos", {
        method: "POST",
        body: {
          idPaquete: selected.id_paquete, // üëà CAMBIO IMPORTANTE
        },
      });

      setSuccess(true);
      setSelected(null);
    } catch (err) {
      console.error(err);
      setError(
        err.message ||
          "Ocurri√≥ un error al procesar la compra de cr√©ditos."
      );
    } finally {
      setLoading(false);
    }
  }

  return (
    <div className="min-h-screen bg-gradient-to-b from-emerald-950 via-emerald-900 to-emerald-950 text-emerald-50 px-4 py-6">
      {/* HEADER */}
      <header className="mb-8 flex items-center justify-between">
        <button
          type="button"
          onClick={() => navigate(-1)}
          className="inline-flex items-center gap-2 rounded-full bg-black/30 px-3 py-1 text-sm hover:bg-black/40"
        >
          <ArrowLeft size={16} />
          Volver
        </button>

        <div className="flex items-center gap-2 rounded-2xl bg-emerald-900/70 px-3 py-2 text-sm">
          <Wallet size={18} className="text-emerald-300" />
          <span className="font-semibold">Compra de cr√©ditos</span>
        </div>
      </header>

      {/* T√çTULO Y DESCRIPCI√ìN */}
      <section className="mb-6 text-center">
        <h1 className="text-3xl font-semibold tracking-wide">
          Paquetes de Cr√©ditos
        </h1>
        <p className="mt-2 text-sm text-emerald-100/80">
          Selecciona el paquete de cr√©ditos que quieres comprar. El pago se
          registrar√° en tu billetera y se reflejar√° en tu saldo.
        </p>
      </section>

      {/* ERRORES */}
      {error && (
        <div className="mb-4 rounded-md border border-red-200 bg-red-50 px-3 py-2 text-sm text-red-700">
          {error}
        </div>
      )}

      {/* PAQUETES */}
      <section className="grid gap-4 md:grid-cols-3">
        {paquetes.map((p) => (
          <article
            key={p.id_paquete}
            onClick={() => setSelected(p)}
            className={`cursor-pointer rounded-2xl border p-4 shadow-sm transition
              ${
                selected?.id_paquete === p.id_paquete
                  ? "border-emerald-400 bg-emerald-900/80"
                  : "border-emerald-800/60 bg-emerald-950/60 hover:border-emerald-500/80"
              }`}
          >
            <p className="text-xs uppercase tracking-wide text-emerald-200/80">
              {p.nombre}
            </p>

            <p className="mt-3 text-2xl font-bold">
              {p.cantidad_creditos} cr√©ditos
            </p>

            <p className="mt-4 text-lg">
              <span className="font-semibold">
                {Number(p.precio_bs).toFixed(2)}
              </span>{" "}
              Bs
            </p>

            <button
              type="button"
              className={`mt-5 w-full rounded-2xl py-2 text-sm font-semibold
                ${
                  selected?.id_paquete === p.id_paquete
                    ? "bg-emerald-400 text-emerald-950"
                    : "bg-emerald-700/80 hover:bg-emerald-600"
                }`}
            >
              {selected?.id_paquete === p.id_paquete
                ? "Seleccionado"
                : "Seleccionar"}
            </button>
          </article>
        ))}

        {paquetes.length === 0 && !error && (
          <p className="col-span-full text-center text-sm text-emerald-100/80">
            No hay paquetes de cr√©ditos activos configurados.
          </p>
        )}
      </section>

      {/* BOT√ìN COMPRAR */}
      <div className="mt-10 flex justify-center">
        <button
          disabled={!selected || loading}
          onClick={comprar}
          className={`px-10 py-3 rounded-2xl text-lg font-semibold shadow-md
            ${
              !selected || loading
                ? "bg-gray-500 cursor-not-allowed"
                : "bg-emerald-500 hover:bg-emerald-600"
            }`}
        >
          {loading ? "Procesando..." : "Comprar paquete seleccionado"}
        </button>
      </div>

      {/* MENSAJE DE √âXITO */}
      {success && (
        <div className="mt-10 flex flex-col items-center text-center">
          <CheckCircle size={60} className="text-emerald-300" />
          <p className="mt-3 text-xl font-semibold">
            ¬°Cr√©ditos a√±adidos correctamente a tu cuenta!
          </p>
        </div>
      )}
    </div>
  );
}
</file>

<file path="frontend/src/pages/EditarPerfil.jsx">
import React, { useEffect, useState } from "react";
import { api } from "../services/api";
import hoja from "../assets/hoja.png";

export default function EditarPerfil() {
  const [usuario, setUsuario] = useState(null);

  const [nombre, setNombre] = useState("");
  const [correo, setCorreo] = useState("");
  const [telefono, setTelefono] = useState("");
  const [password, setPassword] = useState("");

  const [fotoPreview, setFotoPreview] = useState(null);
  const [fotoArchivo, setFotoArchivo] = useState(null);

  useEffect(() => {
    cargarDatos();
  }, []);

  async function cargarDatos() {
    try {
      const data = await api("/auth/me");  // ‚úÖ ESTA ES LA RUTA CORRECTA
      setUsuario(data);

      setNombre(data.nombre || "");
      setCorreo(data.correo || "");
      setTelefono(data.telefono || "");
      setFotoPreview(data.foto || null);

    } catch (error) {
      console.error("Error al cargar perfil:", error);
    }
  }

  async function guardarCambios(e) {
    e.preventDefault();

    try {
      let fotoURL = fotoPreview;

      // Si se eligi√≥ una nueva foto, subirla
      if (fotoArchivo) {
        const formData = new FormData();
        formData.append("archivo", fotoArchivo);

        const uploadRes = await api("/uploads", {
          method: "POST",
          body: formData,
        });

        fotoURL = uploadRes.url;
      }

      // Actualizar datos del usuario
      await api("/auth/me", {
        method: "PUT",
        body: {
          nombre,
          correo,
          telefono,
          foto: fotoURL,
          password: password || undefined, // si est√° vac√≠o no lo env√≠a
        },
      });

      alert("Perfil actualizado correctamente");
      window.location.href = "/perfil";

    } catch (error) {
      console.error("Error guardando perfil:", error);
      alert("Hubo un error al actualizar el perfil");
    }
  }

  if (!usuario) {
    return (
      <div className="min-h-screen bg-[#082b1f] text-white flex items-center justify-center">
        Cargando perfil...
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-[#082b1f] text-white p-6 md:p-10">

      {/* HEADER */}
      <div className="flex items-center gap-3 mb-10">
        <img src={hoja} alt="logo" className="w-12 h-12 drop-shadow-lg" />
        <h1 className="text-3xl font-bold text-emerald-400">
          Editar Perfil
        </h1>
      </div>

      {/* FORMULARIO */}
      <form
        onSubmit={guardarCambios}
        className="bg-[#0e4330] p-8 rounded-xl border border-emerald-500 shadow-xl max-w-2xl mx-auto"
      >

        {/* FOTO */}
        <div className="flex flex-col items-center mb-8">
          <img
            src={fotoPreview || "https://via.placeholder.com/120"}
            className="w-32 h-32 rounded-full object-cover border-4 border-emerald-500 shadow-lg"
          />

          <label
            className="mt-4 cursor-pointer bg-emerald-500 hover:bg-emerald-600 px-4 py-2 rounded-lg font-semibold transition"
          >
            Cambiar foto
            <input
              type="file"
              className="hidden"
              accept="image/*"
              onChange={(e) => {
                setFotoArchivo(e.target.files[0]);
                setFotoPreview(URL.createObjectURL(e.target.files[0]));
              }}
            />
          </label>
        </div>

        {/* NOMBRE */}
        <div className="mb-5">
          <label className="text-emerald-300 font-semibold">Nombre</label>
          <input
            type="text"
            value={nombre}
            onChange={(e) => setNombre(e.target.value)}
            className="w-full mt-1 bg-[#0f3f2d] text-white px-4 py-2 rounded-lg 
                       border border-emerald-500 outline-none focus:ring-2 
                       focus:ring-emerald-400"
          />
        </div>

        {/* CORREO */}
        <div className="mb-5">
          <label className="text-emerald-300 font-semibold">Correo</label>
          <input
            type="email"
            value={correo}
            onChange={(e) => setCorreo(e.target.value)}
            className="w-full mt-1 bg-[#0f3f2d] text-white px-4 py-2 rounded-lg 
                       border border-emerald-500 outline-none focus:ring-2 
                       focus:ring-emerald-400"
          />
        </div>

        {/* TELEFONO */}
        <div className="mb-5">
          <label className="text-emerald-300 font-semibold">Tel√©fono</label>
          <input
            type="text"
            value={telefono}
            onChange={(e) => setTelefono(e.target.value)}
            className="w-full mt-1 bg-[#0f3f2d] text-white px-4 py-2 rounded-lg 
                       border border-emerald-500 outline-none focus:ring-2 
                       focus:ring-emerald-400"
          />
        </div>

        {/* PASSWORD (opcional) */}
        <div className="mb-5">
          <label className="text-emerald-300 font-semibold">
            Nueva contrase√±a (opcional)
          </label>
          <input
            type="password"
            value={password}
            onChange={(e) => setPassword(e.target.value)}
            placeholder="Dejar vac√≠o si no deseas cambiarla"
            className="w-full mt-1 bg-[#0f3f2d] text-white px-4 py-2 rounded-lg 
                       border border-emerald-500 outline-none focus:ring-2 
                       focus:ring-emerald-400"
          />
        </div>

        {/* BOTONES */}
        <div className="flex justify-between mt-8">
          <a
            href="/perfil"
            className="px-5 py-2 rounded-lg bg-gray-600 hover:bg-gray-700 
                       transition font-semibold"
          >
            Cancelar
          </a>

          <button
            type="submit"
            className="px-6 py-2 rounded-lg bg-emerald-500 hover:bg-emerald-600 
                       transition font-semibold"
          >
            Guardar Cambios
          </button>
        </div>

      </form>
    </div>
  );
}
</file>

<file path="frontend/src/pages/HistorialCompras.jsx">
import React, { useEffect, useState } from "react";
import { api } from "../services/api";
import hoja from "../assets/hoja.png";

export default function HistorialCompras() {
  const [compras, setCompras] = useState([]);
  const [cargando, setCargando] = useState(true);

  useEffect(() => {
    cargarCompras();
  }, []);

  async function cargarCompras() {
    try {
      // ajusta la ruta si tu backend usa otro nombre
      const res = await api("/wallet/mis-compras-creditos");
      setCompras(res);
    } catch (err) {
      console.error("Error cargando compras:", err);
    } finally {
      setCargando(false);
    }
  }

  if (cargando) {
    return (
      <div className="min-h-screen bg-[#082b1f] text-white flex items-center justify-center">
        Cargando historial de compras...
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-[#082b1f] text-white p-6 md:p-10">
      {/* HEADER */}
      <div className="flex items-center gap-3 mb-8">
        <img src={hoja} alt="logo" className="w-10 h-10 drop-shadow-lg" />
        <h1 className="text-3xl font-bold text-emerald-400">
          Historial de Compras de Cr√©ditos
        </h1>
      </div>

      {/* TABLA */}
      <div className="bg-[#0f3f2d] border border-emerald-600 rounded-xl shadow-lg p-4 md:p-6 overflow-x-auto">
        {compras.length === 0 ? (
          <p className="opacity-80">Todav√≠a no tienes compras registradas.</p>
        ) : (
          <table className="min-w-full text-sm">
            <thead className="border-b border-emerald-600 text-emerald-300">
              <tr>
                <th className="py-2 text-left">Fecha</th>
                <th className="py-2 text-left">Paquete</th>
                <th className="py-2 text-right">Cr√©ditos</th>
                <th className="py-2 text-right">Monto (Bs)</th>
                <th className="py-2 text-left">Estado</th>
              </tr>
            </thead>
            <tbody>
              {compras.map((c, idx) => (
                <tr
                  key={idx}
                  className="border-b border-emerald-800/60 last:border-0"
                >
                  <td className="py-2 pr-4">
                    {c.fecha_compra || c.fecha || "-"}
                  </td>
                  <td className="py-2 pr-4">
                    {c.paquete || c.nombre_paquete || "Paquete"}
                  </td>
                  <td className="py-2 pr-4 text-right">
                    {c.creditos || c.creditos_compra || "‚Äî"}
                  </td>
                  <td className="py-2 pr-4 text-right">
                    {(c.monto_bs ?? c.monto) || "‚Äî"}
                  </td>
                  <td className="py-2 pr-4">
                    <span className="px-3 py-1 rounded-full bg-emerald-700/40 border border-emerald-500 text-xs uppercase tracking-wide">
                      {c.estado || "DESCONOCIDO"}
                    </span>
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        )}
      </div>
    </div>
  );
}
</file>

<file path="frontend/src/pages/Home.jsx">
import React, { useEffect, useState } from "react";
import { api } from "../services/api";
import hoja from "../assets/hoja.png";

export default function Home() {
  const [statusAPI, setStatusAPI] = useState("Cargando...");
  const [misCreditos, setMisCreditos] = useState(null);
  const [actividadReciente, setActividadReciente] = useState([]);

  useEffect(() => {
    cargarTodo();
  }, []);

  async function cargarTodo() {
    try {
      const estado = await api("/health");
      setStatusAPI(estado.message || "OK");

      const creditos = await api("/wallet/mis-creditos");
      setMisCreditos(creditos.saldo);

      const act = await api("/wallet/mis-movimientos");
      setActividadReciente(act.slice(0, 5));
    } catch (err) {
      setStatusAPI("Error conectando al backend");
    }
  }

  return (
    <div className="min-h-screen w-full bg-[#082b1f] text-white px-6 py-10">
      
      {/* ENCABEZADO */}
      <div className="flex items-center gap-3 mb-10">
        <img src={hoja} alt="logo" className="w-12 h-12 drop-shadow-lg" />
        <h1 className="text-3xl font-bold text-emerald-400 drop-shadow-md">
          Digital Barter ‚Äì Inicio
        </h1>
      </div>

      {/* ESTADO DEL SISTEMA */}
      <section className="mb-10">
        <h2 className="text-xl font-semibold text-emerald-300 mb-3">
          Estado del sistema
        </h2>

        <div className="bg-[#0f3f2d] p-5 rounded-xl border border-emerald-600 shadow-lg">
          <p className="text-lg">{statusAPI}</p>
        </div>
      </section>

      {/* RESUMEN R√ÅPIDO */}
      <section className="mb-12">
        <h2 className="text-xl font-semibold text-emerald-300 mb-4">
          Resumen r√°pido
        </h2>

        <div className="grid md:grid-cols-3 gap-6">

          {/* TARJETA CREDITOS */}
          <div className="bg-[#0e4330] p-6 rounded-xl border border-emerald-500 shadow-md hover:scale-[1.02] transition transform cursor-pointer">
            <h3 className="text-lg font-bold text-emerald-300">Mis Cr√©ditos</h3>
            <p className="text-4xl font-bold mt-2 text-emerald-400 drop-shadow-md">
              {misCreditos !== null ? misCreditos : "‚Äî"}
            </p>
          </div>

          {/* TARJETA PUBLICACIONES */}
          <a
            href="/publicaciones"
            className="bg-[#0e4330] p-6 rounded-xl border border-emerald-500 shadow-md hover:bg-[#14694c] hover:scale-[1.02] transition transform cursor-pointer"
          >
            <h3 className="text-lg font-bold text-emerald-300">Marketplace</h3>
            <p className="opacity-80 mt-1">Explora productos y servicios</p>
          </a>

          {/* TARJETA WALLET */}
          <a
            href="/wallet"
            className="bg-[#0e4330] p-6 rounded-xl border border-emerald-500 shadow-md hover:bg-[#14694c] hover:scale-[1.02] transition transform cursor-pointer"
          >
            <h3 className="text-lg font-bold text-emerald-300">Mi Wallet</h3>
            <p className="opacity-80 mt-1">Ver movimientos y saldo</p>
          </a>
        </div>
      </section>

      {/* ACTIVIDAD RECIENTE */}
      <section className="mb-20">
        <h2 className="text-xl font-semibold text-emerald-300 mb-4">
          Actividad reciente
        </h2>

        <div className="bg-[#0f3f2d] p-5 rounded-xl border border-emerald-600 shadow-lg">
          {actividadReciente.length === 0 ? (
            <p className="opacity-80">No hay actividad reciente.</p>
          ) : (
            <ul className="space-y-3">
              {actividadReciente.map((a, i) => (
                <li
                  key={i}
                  className="bg-[#0e4330] p-4 rounded-lg border border-emerald-500 shadow-md"
                >
                  <p className="text-emerald-300 font-semibold">
                    {a.tipo_movimiento}
                  </p>
                  <p className="text-sm opacity-80">{a.descripcion || "Movimiento realizado"}</p>
                  <p className="mt-1 text-emerald-400 font-bold">
                    {a.creditos} cr√©ditos
                  </p>
                </li>
              ))}
            </ul>
          )}
        </div>
      </section>

    </div>
  );
}
</file>

<file path="frontend/src/pages/IntercambioDetalle.jsx">
import { useEffect, useState } from "react";
import { useParams } from "react-router-dom";
import { getIntercambioDetalle } from "../services/api";
import { ArrowLeft, Info } from "lucide-react";

export default function IntercambioDetalle() {
  const { id } = useParams();
  const [detalle, setDetalle] = useState(null);
  const [error, setError] = useState("");

  useEffect(() => {
    cargar();
  }, []);

  async function cargar() {
    try {
      const data = await getIntercambioDetalle(id);
      setDetalle(data);
    } catch (err) {
      setError(err.message || "No se pudo cargar el detalle.");
    }
  }

  return (
    <div className="min-h-screen bg-[#082b1f] text-white p-6">
      <button
        onClick={() => (window.location.href = "/intercambios")}
        className="inline-flex items-center gap-2 px-3 py-1 bg-black/30 rounded-full text-sm hover:bg-black/40"
      >
        <ArrowLeft size={16} /> Volver
      </button>

      <h1 className="text-xl font-semibold flex items-center gap-2 mt-4">
        <Info size={20} className="text-emerald-400" />
        Detalle del intercambio #{id}
      </h1>

      {error && <p className="text-red-400 mt-4">{error}</p>}

      {detalle && (
        <div className="bg-[#0f3f2d] border border-emerald-700 p-5 rounded-xl mt-4">
          <p><strong>Producto:</strong> {detalle.titulo}</p>
          <p><strong>Descripci√≥n:</strong> {detalle.descripcion}</p>
          <p><strong>Cr√©ditos usados:</strong> {detalle.creditos}</p>
          <p><strong>Estado:</strong> {detalle.estado}</p>
          <p><strong>Fecha:</strong> {new Date(detalle.fecha).toLocaleString()}</p>
        </div>
      )}
    </div>
  );
}
</file>

<file path="frontend/src/pages/Intercambios.jsx">
// digital-barder/frontend/src/pages/Intercambios.jsx
import { useEffect, useState } from "react";
import { useNavigate } from "react-router-dom";
import { api } from "../services/api";
import { ArrowLeft, ArrowLeftRight, ShoppingBag, Store } from "lucide-react";
import hoja from "../assets/hoja.png";

export default function Intercambios() {
  const navigate = useNavigate();

  // formulario crear intercambio
  const [idPublicacion, setIdPublicacion] = useState("");
  const [creditos, setCreditos] = useState("");
  const [creando, setCreando] = useState(false);
  const [txCreada, setTxCreada] = useState(null);
  const [errorForm, setErrorForm] = useState("");

  // listas
  const [tab, setTab] = useState("compras"); // "compras" | "ventas"
  const [compras, setCompras] = useState([]);
  const [ventas, setVentas] = useState([]);
  const [loadingListas, setLoadingListas] = useState(false);
  const [errorListas, setErrorListas] = useState("");

  // cargar compras y ventas al entrar
  useEffect(() => {
    async function cargarListas() {
      try {
        setLoadingListas(true);
        setErrorListas("");

        const [respCompras, respVentas] = await Promise.all([
          api("/intercambios/mis-compras"),
          api("/intercambios/mis-ventas"),
        ]);

        setCompras(Array.isArray(respCompras) ? respCompras : []);
        setVentas(Array.isArray(respVentas) ? respVentas : []);
      } catch (err) {
        console.error(err);
        setErrorListas(
          err?.message || "No se pudieron cargar tus intercambios."
        );
      } finally {
        setLoadingListas(false);
      }
    }

    cargarListas();
  }, []);

  async function onCrearIntercambio(e) {
    e.preventDefault();
    setErrorForm("");
    setTxCreada(null);

    if (!idPublicacion || !creditos) {
      setErrorForm("id_publicacion y cr√©ditos son obligatorios.");
      return;
    }

    const id_pub = Number(idPublicacion);
    const cred = Number(creditos);

    if (Number.isNaN(id_pub) || Number.isNaN(cred) || cred <= 0) {
      setErrorForm("Verifica que el ID y los cr√©ditos sean v√°lidos.");
      return;
    }

    const ok = window.confirm(
      `¬øConfirmas el intercambio de ${cred} cr√©ditos por la publicaci√≥n #${id_pub}?`
    );
    if (!ok) return;

    try {
      setCreando(true);

      const res = await api("/intercambios", {
        method: "POST",
        body: {
          id_publicacion: id_pub,
          creditos: cred,
        },
      });

      setTxCreada(res?.transaccion || res || null);

      // refrescar listas
      try {
        const [respCompras, respVentas] = await Promise.all([
          api("/intercambios/mis-compras"),
          api("/intercambios/mis-ventas"),
        ]);
        setCompras(Array.isArray(respCompras) ? respCompras : []);
        setVentas(Array.isArray(respVentas) ? respVentas : []);
      } catch (errInner) {
        console.warn("No se pudieron refrescar las listas:", errInner);
      }
    } catch (err) {
      console.error(err);
      setErrorForm(
        err?.message ||
          "Ocurri√≥ un error al intentar realizar el intercambio. Revisa tu saldo o la publicaci√≥n."
      );
    } finally {
      setCreando(false);
    }
  }

  function renderFila(tx) {
    const id = tx.id_transaccion || tx.id_intercambio || tx.id || null;

    const creditosTx =
      tx.creditos ??
      tx.monto_creditos ??
      tx.cantidad_creditos ??
      tx.valor_creditos ??
      "-";

    const titulo =
      tx.titulo_publicacion ??
      tx.titulo ??
      tx.publicacion ??
      `Transacci√≥n #${id || "?"}`;

    const fechaStr = tx.creado_en
      ? new Date(tx.creado_en).toLocaleString()
      : tx.fecha ||
        (tx.fecha_intercambio &&
          new Date(tx.fecha_intercambio).toLocaleString()) ||
        "";

    const contraparte =
      tx.contraparte ||
      tx.usuario_contraparte ||
      tx.comprador ||
      tx.vendedor ||
      null;

    return (
      <div
        key={id || `${titulo}-${fechaStr}`}
        className="rounded-xl border border-emerald-800/60 bg-emerald-950/60 px-4 py-3 mb-3 flex flex-col md:flex-row md:items-center md:justify-between gap-2"
      >
        <div>
          <p className="font-semibold text-emerald-100">{titulo}</p>
          <p className="text-xs text-emerald-100/70">
            {fechaStr || "Sin fecha registrada"}
          </p>
          {tx.estado && (
            <p className="mt-1 inline-flex items-center text-[11px] rounded-full px-2 py-0.5 border border-emerald-400/60 text-emerald-200">
              Estado: {tx.estado}
            </p>
          )}
        </div>

        <div className="text-right">
          <p className="text-sm text-emerald-100/80">
            Cr√©ditos:{" "}
            <span className="font-semibold text-emerald-300">
              {creditosTx}
            </span>
          </p>
          {contraparte && (
            <p className="text-xs text-emerald-100/70 mt-1">
              Con: {contraparte}
            </p>
          )}
        </div>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-gradient-to-b from-emerald-950 via-emerald-900 to-emerald-950 text-emerald-50 px-4 py-6">
      {/* HEADER */}
      <header className="mb-8 flex items-center justify-between">
        <div className="flex items-center gap-3">
          <button
            type="button"
            onClick={() => navigate(-1)}
            className="inline-flex items-center gap-2 rounded-full bg-black/30 px-3 py-1 text-sm hover:bg-black/40"
          >
            <ArrowLeft size={16} />
            Volver
          </button>
          <div className="flex items-center gap-2 rounded-2xl bg-emerald-900/70 px-3 py-2 text-sm">
            <ArrowLeftRight size={18} className="text-emerald-300" />
            <span className="font-semibold">Intercambios</span>
          </div>
        </div>

        <img src={hoja} alt="logo" className="w-9 h-9 drop-shadow-md" />
      </header>

      {/* FORMULARIO CREAR INTERCAMBIO */}
      <section className="mb-10">
        <h1 className="text-2xl font-semibold mb-1">
          Realizar intercambio manual
        </h1>
        <p className="text-sm text-emerald-100/80 mb-4">
          Para pruebas: indica el ID de una publicaci√≥n y la cantidad de
          cr√©ditos. El backend ejecutar√° el procedimiento de intercambio y
          actualizar√° tu billetera.
        </p>

        <form
          onSubmit={onCrearIntercambio}
          className="grid gap-4 md:grid-cols-[1fr_1fr_auto] items-end bg-emerald-950/60 border border-emerald-800/70 rounded-2xl px-4 py-4"
        >
          <div>
            <label className="block text-xs mb-1">
              ID publicaci√≥n (id_publicacion) *
            </label>
            <input
              type="number"
              value={idPublicacion}
              onChange={(e) => setIdPublicacion(e.target.value)}
              className="w-full rounded-lg border border-emerald-700 bg-emerald-950/80 px-3 py-2 text-sm outline-none focus:ring focus:ring-emerald-500/60"
            />
          </div>

          <div>
            <label className="block text-xs mb-1">Cr√©ditos a pagar *</label>
            <input
              type="number"
              value={creditos}
              onChange={(e) => setCreditos(e.target.value)}
              className="w-full rounded-lg border border-emerald-700 bg-emerald-950/80 px-3 py-2 text-sm outline-none focus:ring focus:ring-emerald-500/60"
            />
          </div>

          <button
            type="submit"
            disabled={creando}
            className="mt-2 md:mt-0 inline-flex items-center justify-center rounded-2xl bg-emerald-500 px-6 py-2 text-sm font-semibold text-emerald-950 shadow hover:bg-emerald-400 disabled:opacity-60 disabled:cursor-not-allowed"
          >
            {creando ? "Procesando‚Ä¶" : "Realizar intercambio"}
          </button>
        </form>

        {errorForm && (
          <div className="mt-3 rounded-md border border-red-200 bg-red-50 px-3 py-2 text-sm text-red-700">
            {errorForm}
          </div>
        )}

        {txCreada && (
          <div className="mt-4 rounded-xl border border-emerald-500/70 bg-emerald-900/70 px-4 py-3 text-sm">
            <p className="font-semibold mb-1">
              Intercambio registrado correctamente ‚úÖ
            </p>
            <pre className="text-xs text-emerald-100/80 overflow-x-auto">
              {JSON.stringify(txCreada, null, 2)}
            </pre>
          </div>
        )}
      </section>

      {/* LISTAS DE COMPRAS / VENTAS */}
      <section>
        <div className="mb-4 flex items-center justify-between gap-4">
          <div className="flex gap-2 rounded-full bg-emerald-950/60 p-1 border border-emerald-800/80">
            <button
              type="button"
              onClick={() => setTab("compras")}
              className={`flex items-center gap-1 rounded-full px-4 py-1.5 text-xs font-medium ${
                tab === "compras"
                  ? "bg-emerald-500 text-emerald-950"
                  : "text-emerald-100 hover:bg-emerald-800/60"
              }`}
            >
              <ShoppingBag size={14} />
              Mis compras
            </button>
            <button
              type="button"
              onClick={() => setTab("ventas")}
              className={`flex items-center gap-1 rounded-full px-4 py-1.5 text-xs font-medium ${
                tab === "ventas"
                  ? "bg-emerald-500 text-emerald-950"
                  : "text-emerald-100 hover:bg-emerald-800/60"
              }`}
            >
              <Store size={14} />
              Mis ventas
            </button>
          </div>

          {loadingListas && (
            <p className="text-xs text-emerald-100/80">Cargando listas‚Ä¶</p>
          )}
        </div>

        {errorListas && (
          <div className="mb-4 rounded-md border border-red-200 bg-red-50 px-3 py-2 text-sm text-red-700">
            {errorListas}
          </div>
        )}

        {tab === "compras" && !errorListas && (
          <div>
            {compras.map(renderFila)}
            {compras.length === 0 && !loadingListas && (
              <p className="text-sm text-emerald-100/80">
                A√∫n no tienes compras registradas.
              </p>
            )}
          </div>
        )}

        {tab === "ventas" && !errorListas && (
          <div>
            {ventas.map(renderFila)}
            {ventas.length === 0 && !loadingListas && (
              <p className="text-sm text-emerald-100/80">
                A√∫n no tienes ventas registradas.
              </p>
            )}
          </div>
        )}
      </section>
    </div>
  );
}
</file>

<file path="frontend/src/pages/Login.jsx">
// frontend/src/pages/Login.jsx
import React, { useState, useEffect } from "react";
import { Link, useNavigate } from "react-router-dom";
import { login } from "../services/api";
import hojaLogo from "../assets/hoja.png";

// Carrusel interno (sin componente externo)
const SLIDES = [
  {
    id: 1,
    title: "Crea una cuenta en Digital Barter",
    text: "Obt√©n 5 monedas Green Credits por tu primera sesi√≥n.",
    image:
      "https://images.pexels.com/photos/3184339/pexels-photo-3184339.jpeg?auto=compress&cs=tinysrgb&w=1600",
  },
  {
    id: 2,
    title: "Intercambia productos y servicios",
    text: "Ahorra dinero mientras ayudas al planeta.",
    image:
      "https://images.pexels.com/photos/3184291/pexels-photo-3184291.jpeg?auto=compress&cs=tinysrgb&w=1600",
  },
  {
    id: 3,
    title: "Gana Green Credits",
    text: "Recibe cr√©ditos verdes por cada intercambio sostenible.",
    image:
      "https://images.pexels.com/photos/8867432/pexels-photo-8867432.jpeg?auto=compress&cs=tinysrgb&w=1600",
  },
];

const Login = () => {
  const [correo, setCorreo] = useState("");
  const [password, setPassword] = useState("");
  const [error, setError] = useState("");
  const [cargando, setCargando] = useState(false);

  const [slideIndex, setSlideIndex] = useState(0);
  const navigate = useNavigate();

  // Carrusel autom√°tico (igual que en tu login anterior)
  useEffect(() => {
    const interval = setInterval(() => {
      setSlideIndex((prev) => (prev + 1) % SLIDES.length);
    }, 5000);
    return () => clearInterval(interval);
  }, []);

  const currentSlide = SLIDES[slideIndex];

  // üëâ Aqu√≠ va la funcionalidad REAL de login (no setTimeout)
  const handleSubmit = async (e) => {
    e.preventDefault();
    setError("");

    if (!correo || !password) {
      setError("Debes ingresar correo y contrase√±a.");
      return;
    }

    try {
      setCargando(true);

      const data = await login({ correo, password });

      if (!data?.token) {
        setError("No se recibi√≥ el token de autenticaci√≥n.");
        return;
      }

      // Login correcto ‚Üí navega a /home
      navigate("/home");
    } catch (err) {
      console.error(err);
      setError(err.message || "Credenciales inv√°lidas");
    } finally {
      setCargando(false);
    }
  };

  return (
    <div
  className="min-h-screen w-full flex flex-col items-center py-2 px-6 overflow-x-hidden"
  style={{
    background: "radial-gradient(circle at center, #024023 0%, #005B30 100%)",
  }}
>

      {/* HEADER: t√≠tulo + bot√≥n Crear Cuenta (igual al del .zip) */}
      <header className="w-full max-w-6xl flex items-center justify-between mb-2">
        <div className="text-center flex-1 lg:translate-x-12 lg:translate-y-[-0px]">
          {/* Digital Barter */}
          <h1
            className="text-[#06B060] leading-tight mb-2"
            style={{
              fontFamily: '"Berlin Sans FB Demi", system-ui, sans-serif',
              fontSize: "3.7rem",
              fontWeight: 700,
              marginTop: "0.2rem",
            }}
          >
            Digital Barter
          </h1>

          {/* green credits + imagen hoja */}
          <div className="flex items-center justify-center gap-2 -mt-1">
            <h2
              className="text-[#06B060]"
              style={{
                fontFamily: '"Jaro", system-ui, sans-serif',
                fontSize: "2.0rem",
                fontWeight: 400,
              }}
            >
              green credits
            </h2>
            {/* Usamos tu hoja importada, no /images/hoja.png */}
            <img
              src={hojaLogo}
              alt="leaf icon"
              className="w-8 h-8 object-contain"
            />
          </div>
        </div>

        {/* Bot√≥n Crear Cuenta arriba a la derecha */}
        <Link to="/register" className="absolute top-4 right-4">
          <button
            type="button"
            className="bg-[#005B30] text-white text-lg rounded-lg hover:bg-[#047645] flex items-center justify-center"
            style={{
              fontFamily: '"Berlin Sans FB Demi", system-ui, sans-serif',
              fontWeight: 700,
              height: "45px",
              width: "200px",
            }}
          >
            Crear Cuenta
          </button>
        </Link>
      </header>

      {/* CONTENIDO PRINCIPAL */}
      <main className="w-full max-w-6xl flex flex-col lg:flex-row items-start lg:items-start gap-4 mt-0">
        {/* Columna izquierda: carrusel (sustituye <Carousel /> del .zip, pero con tu l√≥gica) */}
        <div className="flex justify-start w-full lg:w-2/5 lg:-translate-x-12 lg:-translate-y-25">
          <div
            className="w-full max-w-[500px] transform scale-90 lg:scale-100 overflow-hidden rounded-2xl shadow-2xl"
            style={{
              height: "450px", // misma altura que en el dise√±o
              clipPath:
                "polygon(0 0, 100% 0, 100% 100%, 0 100%)", // recorte inferior como en el .zip
            }}
          >
            <div className="relative w-full h-full">
              <img
                src={currentSlide.image}
                alt={currentSlide.title}
                className="w-full h-full object-cover"
              />
              <div className="absolute inset-0 bg-gradient-to-t from-black/70 via-black/20 to-transparent" />
              <div className="absolute inset-0 flex flex-col justify-end p-6">
                <h2 className="text-xl font-bold mb-2">
                  {currentSlide.title}
                </h2>
                <p className="text-sm text-gray-200 mb-4">
                  {currentSlide.text}
                </p>

                {/* Puntos del carrusel */}
                <div className="flex gap-2">
                  {SLIDES.map((s, idx) => (
                    <button
                      key={s.id}
                      onClick={() => setSlideIndex(idx)}
                      className={`w-3 h-3 rounded-full ${
                        idx === slideIndex
                          ? "bg-[#034828]"
                          : "bg-white/70"
                      }`}
                      aria-label={`Ir al slide ${idx + 1}`}
                    />
                  ))}
                </div>
              </div>
            </div>
          </div>
        </div>

        {/* Columna derecha: formulario (mismo layout del .zip, con tu l√≥gica de login) */}
        <div className="flex-1 flex flex-col items-center lg:items-start mt-32 lg:ml-20 lg:translate-x-20">
          <form
            onSubmit={handleSubmit}
            className="w-full space-y-4 flex flex-col items-center"
          >
            {/* Campo correo/tel√©fono */}
            <div className="space-y-3">
              <input
                type="text"
                value={correo}
                onChange={(e) => setCorreo(e.target.value)}
                placeholder="Correo electr√≥nico o n√∫mero de tel√©fono"
                className="w-[445px] rounded-xl px-4 py-3 bg-[#E9FFD9]/50 border border-[#B6E4A3] text-[#013726] placeholder:text-[#6C8A6E]"
                style={{
                  fontSize: "20px",
                  fontWeight: 500,
                }}
              />
            </div>

            {/* Campo contrase√±a */}
            <div className="space-y-3">
              <input
                type="password"
                value={password}
                onChange={(e) => setPassword(e.target.value)}
                placeholder="Contrase√±a"
                className="w-[445px] rounded-xl px-4 py-3 bg-[#E9FFD9]/50 border border-[#B6E4A3] text-[#013726] placeholder:text-[#6C8A6E]"
                style={{
                  fontSize: "20px",
                  fontWeight: 500,
                }}
              />
            </div>

            {/* ¬øHas olvidado tu contrase√±a? centrado (como en el .zip, usando <a>) */}
            <div className="text-center w-full">
              <a
                href="#"
                className="text-sm hover:text-[#06B060] font-medium"
                style={{ fontFamily: "Inter, system-ui, sans-serif" }}
                onClick={(e) => {
                  e.preventDefault();
                  alert(
                    "En el futuro aqu√≠ ir√° el flujo de recuperar contrase√±a."
                  );
                }}
              >
                ¬øHas olvidado tu contrase√±a?
              </a>
            </div>

            {/* Mensaje de error (igual l√≥gica, estilo simple) */}
            {error && (
              <p className="text-red-400 text-center text-sm font-medium">
                {error}
              </p>
            )}

            {/* Bot√≥n Iniciar Sesi√≥n */}
            <button
              type="submit"
              disabled={cargando}
              className="w-[445px] py-4 text-lg bg-[#005B30] text-white hover:bg-[#047645] flex items-center justify-center disabled:opacity-60 disabled:cursor-not-allowed"
              style={{
                fontFamily:
                  '"Berlin Sans FB Demi", "Arial Black", sans-serif',
                fontWeight: 700,
                fontSize: "22px",
                height: "50px",
                letterSpacing: "0.5px",
              }}
            >
              {cargando ? "Iniciando sesi√≥n..." : "Iniciar sesi√≥n"}
            </button>
          </form>
        </div>
      </main>

      {/* Enlace en la esquina inferior derecha (como en el .zip) */}
      <div className="absolute bottom-4 right-4 w-full text-right">
        <a
          href="#"
          className="text-base hover:text-[#06B060] font-medium"
          style={{ fontFamily: "Inter, system-ui, sans-serif" }}
          onClick={(e) => e.preventDefault()}
        >
          ¬°Un poco m√°s sobre nosotros!
        </a>
      </div>
    </div>
  );
};

export default Login;
</file>

<file path="frontend/src/pages/Logros.jsx">
// digital-barder/frontend/src/pages/Logros.jsx
import { useEffect, useMemo, useState } from "react";
import { useNavigate } from "react-router-dom";
import { getMisLogros } from "../services/api";
import { ArrowLeft, Medal, Award, Crown } from "lucide-react";
import hoja from "../assets/hoja.png";

export default function Logros() {
  const navigate = useNavigate();
  const [logros, setLogros] = useState([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState("");

  useEffect(() => {
    cargarLogros();
  }, []);

  async function cargarLogros() {
    try {
      setLoading(true);
      setError("");
      const data = await getMisLogros();
      setLogros(Array.isArray(data) ? data : []);
    } catch (err) {
      console.error(err);
      setError(err.message || "No se pudieron cargar tus logros.");
    } finally {
      setLoading(false);
    }
  }

  // Estad√≠sticas simples
  const stats = useMemo(() => {
    if (!logros.length) return { total: 0, ult: null };

    const ordenados = [...logros].sort((a, b) => {
      const fa = new Date(a.obtenido_en || a.creado_en || 0).getTime();
      const fb = new Date(b.obtenido_en || b.creado_en || 0).getTime();
      return fb - fa;
    });

    return {
      total: logros.length,
      ult: ordenados[0],
    };
  }, [logros]);

  return (
    <div className="min-h-screen bg-[#082b1f] text-white p-6 md:p-10">
      {/* HEADER */}
      <header className="flex items-center justify-between mb-8 gap-4">
        <div className="flex items-center gap-3">
          <button
            type="button"
            onClick={() => navigate(-1)}
            className="inline-flex items-center gap-2 rounded-full bg-black/30 px-3 py-1 text-sm hover:bg-black/40"
          >
            <ArrowLeft size={16} />
            Volver
          </button>
          <div className="flex items-center gap-2 rounded-2xl bg-emerald-900/70 px-3 py-2 text-sm">
            <Medal size={18} className="text-emerald-300" />
            <span className="font-semibold">Mis logros</span>
          </div>
        </div>

        <div className="flex items-center gap-3">
          <span className="text-sm text-emerald-100/80">
            Total de insignias:{" "}
            <span className="font-semibold text-emerald-300">
              {stats.total}
            </span>
          </span>
          <img src={hoja} alt="logo" className="w-9 h-9 drop-shadow-md" />
        </div>
      </header>

      {/* DESCRIPCI√ìN */}
      <section className="max-w-3xl mb-6">
        <h1 className="text-2xl font-semibold mb-2">Tus insignias verdes</h1>
        <p className="text-sm text-emerald-100/80">
          Aqu√≠ puedes ver todos los logros que has obtenido en Digital Barter:
          actividades sostenibles, intercambios, uso de la plataforma y otros
          hitos que te otorgan cr√©ditos de recompensa.
        </p>
      </section>

      {/* ERROR */}
      {error && (
        <div className="mb-4 rounded-md border border-red-400 bg-red-900/40 px-4 py-2 text-sm text-red-100">
          {error}
        </div>
      )}

      {/* CONTENIDO */}
      {loading ? (
        <div className="text-center text-emerald-100/80">
          Cargando tus logros...
        </div>
      ) : logros.length === 0 ? (
        <div className="text-center text-emerald-100/80 mt-10">
          A√∫n no has desbloqueado ning√∫n logro.  
          Participa en actividades, realiza intercambios y usa la plataforma
          para comenzar a ganar insignias.
        </div>
      ) : (
        <>
          {/* √öLTIMO LOGRO DESTACADO */}
          {stats.ult && (
            <section className="max-w-3xl mb-6 bg-[#0f3f2d] border border-emerald-700 rounded-2xl p-4 flex items-start gap-4">
              <div className="mt-1">
                <Crown size={28} className="text-yellow-300" />
              </div>
              <div>
                <p className="text-xs text-emerald-300/90 mb-1">
                  √öltimo logro obtenido
                </p>
                <h2 className="text-lg font-semibold text-emerald-200">
                  {stats.ult.nombre || "Logro reciente"}
                </h2>
                <p className="text-sm text-emerald-100/90 mt-1">
                  {stats.ult.descripcion || "Sin descripci√≥n."}
                </p>
                <p className="text-xs text-emerald-200/80 mt-2">
                  Obtenido el{" "}
                  {new Date(
                    stats.ult.obtenido_en ||
                      stats.ult.creado_en ||
                      Date.now()
                  ).toLocaleString()}
                </p>
                {typeof stats.ult.creditos_recompensa === "number" && (
                  <p className="text-xs text-emerald-200/90 mt-1">
                    Cr√©ditos de recompensa:{" "}
                    <span className="font-semibold text-emerald-300">
                      {stats.ult.creditos_recompensa} cr.
                    </span>
                  </p>
                )}
              </div>
            </section>
          )}

          {/* GRID DE LOGROS */}
          <section className="grid gap-4 md:grid-cols-3">
            {logros.map((logro, idx) => {
              const progreso =
                logro.progreso_actual ??
                logro.progreso ??
                null;
              const meta = logro.meta_requerida ?? null;
              const porcentaje =
                progreso && meta ? Math.min(100, (progreso / meta) * 100) : null;

              return (
                <article
                  key={logro.id_logro || idx}
                  className="bg-[#0f3f2d] border border-emerald-700 rounded-2xl p-4 shadow-md flex flex-col"
                >
                  {/* Icono / encabezado */}
                  <div className="flex items-center gap-2 mb-3">
                    <div className="w-10 h-10 rounded-full bg-emerald-700/40 flex items-center justify-center">
                      <Award size={20} className="text-emerald-200" />
                    </div>
                    <div>
                      <h3 className="text-sm font-semibold text-emerald-100">
                        {logro.nombre || "Logro sin nombre"}
                      </h3>
                      {logro.meta_requerida && (
                        <p className="text-[11px] text-emerald-300/90">
                          Meta: {logro.meta_requerida}
                        </p>
                      )}
                    </div>
                  </div>

                  {/* Descripci√≥n */}
                  <p className="text-xs text-emerald-100/80 flex-1">
                    {logro.descripcion || "Sin descripci√≥n."}
                  </p>

                  {/* Progreso */}
                  {porcentaje !== null && (
                    <div className="mt-3">
                      <p className="text-[11px] text-emerald-200/90 mb-1">
                        Progreso: {progreso} / {meta}
                      </p>
                      <div className="w-full h-2 rounded-full bg-emerald-900/60 overflow-hidden">
                        <div
                          className="h-full bg-emerald-400"
                          style={{ width: `${porcentaje}%` }}
                        />
                      </div>
                    </div>
                  )}

                  {/* Cr√©ditos recompensa + fecha */}
                  <div className="mt-3 text-[11px] text-emerald-200/80">
                    {typeof logro.creditos_recompensa === "number" && (
                      <p>
                        Cr√©ditos recompensa:{" "}
                        <span className="font-semibold text-emerald-300">
                          {logro.creditos_recompensa} cr.
                        </span>
                      </p>
                    )}
                    {(logro.obtenido_en || logro.creado_en) && (
                      <p className="mt-1">
                        Obtenido el{" "}
                        {new Date(
                          logro.obtenido_en || logro.creado_en
                        ).toLocaleDateString()}
                      </p>
                    )}
                  </div>
                </article>
              );
            })}
          </section>
        </>
      )}
    </div>
  );
}
</file>

<file path="frontend/src/pages/MisActividades.jsx">
// digital-barder/frontend/src/pages/MisActividades.jsx
import { useEffect, useState } from "react";
import { useNavigate } from "react-router-dom";
import { getMisActividadesSostenibles } from "../services/api";
import { ArrowLeft, Leaf } from "lucide-react";
import hoja from "../assets/hoja.png";

export default function MisActividades() {
  const navigate = useNavigate();

  const [actividades, setActividades] = useState([]);
  const [cargando, setCargando] = useState(true);
  const [error, setError] = useState("");

  useEffect(() => {
    cargarMisActividades();
  }, []);

  async function cargarMisActividades() {
    try {
      setCargando(true);
      setError("");
      const data = await getMisActividadesSostenibles();
      setActividades(Array.isArray(data) ? data : []);
    } catch (err) {
      console.error(err);
      setError(
        err.message || "No se pudo cargar tu historial de actividades."
      );
    } finally {
      setCargando(false);
    }
  }

  return (
    <div className="min-h-screen bg-[#082b1f] text-white p-6 md:p-10">
      {/* HEADER */}
      <header className="flex items-center justify-between gap-3 mb-8">
        <div className="flex items-center gap-3">
          <button
            type="button"
            onClick={() => navigate(-1)}
            className="inline-flex items-center gap-2 rounded-full bg-black/30 px-3 py-1 text-sm hover:bg-black/40"
          >
            <ArrowLeft size={16} />
            Volver
          </button>
          <div className="flex items-center gap-2 rounded-2xl bg-emerald-900/70 px-3 py-2 text-sm">
            <Leaf size={18} className="text-emerald-300" />
            <span className="font-semibold">Mis actividades</span>
          </div>
        </div>

        <button
          type="button"
          onClick={() => navigate("/actividades")}
          className="px-4 py-2 rounded-lg border border-emerald-500 text-sm hover:bg-emerald-500/10 font-semibold"
        >
          Ver actividades disponibles
        </button>
      </header>

      {/* ERROR */}
      {error && (
        <div className="mb-4 rounded-md border border-red-400 bg-red-900/40 px-4 py-2 text-sm text-red-100">
          {error}
        </div>
      )}

      {/* CONTENIDO */}
      {cargando ? (
        <div className="text-center text-emerald-100/80">
          Cargando tu historial...
        </div>
      ) : actividades.length === 0 ? (
        <div className="text-center text-emerald-100/80">
          A√∫n no has registrado actividades sostenibles.  
          Participa en alguna para empezar a ganar cr√©ditos verdes.
        </div>
      ) : (
        <div className="bg-[#0f3f2d] border border-emerald-700 rounded-xl overflow-x-auto">
          <table className="min-w-full text-sm">
            <thead className="border-b border-emerald-600 text-emerald-300">
              <tr>
                <th className="text-left py-2 px-4">Actividad</th>
                <th className="text-left py-2 px-4">Cr√©ditos</th>
                <th className="text-left py-2 px-4">Fecha</th>
                <th className="text-left py-2 px-4">Detalle</th>
              </tr>
            </thead>
            <tbody>
              {actividades.map((a, idx) => (
                <tr
                  key={a.id_actividad || a.id_participacion || idx}
                  className="border-b border-emerald-800/50 last:border-0"
                >
                  <td className="py-2 px-4">
                    {a.nombre_actividad || a.nombre || "Actividad"}
                  </td>
                  <td className="py-2 px-4">
                    {a.creditos ||
                      a.creditos_obtenidos ||
                      a.valor_creditos ||
                      "‚Äî"}
                  </td>
                  <td className="py-2 px-4">
                    {a.fecha_participacion ||
                      a.creado_en ||
                      a.fecha ||
                      "-"}
                  </td>
                  <td className="py-2 px-4">
                    {a.descripcion || a.detalle || (
                      <span className="text-emerald-100/70 text-xs">
                        Sin descripci√≥n
                      </span>
                    )}
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      )}

      <div className="mt-6 flex justify-center">
        <img src={hoja} alt="logo" className="w-10 h-10 opacity-80" />
      </div>
    </div>
  );
}
</file>

<file path="frontend/src/pages/MisPublicaciones.jsx">
// frontend/src/pages/MisPublicaciones.jsx
import { useEffect, useState } from "react";
import { api } from "../services/api";
import hoja from "../assets/hoja.png";

export default function MisPublicaciones() {
  const [publicaciones, setPublicaciones] = useState([]);
  const [cargando, setCargando] = useState(true);
  const [error, setError] = useState("");

  useEffect(() => {
    cargarMisPublicaciones();
  }, []);

  async function cargarMisPublicaciones() {
    setCargando(true);
    setError("");
    try {
      // üëá ruta EXACTA seg√∫n tu router de backend
      const data = await api("/publicaciones/mias/listado");
      setPublicaciones(Array.isArray(data) ? data : []);
    } catch (err) {
      console.error(err);
      setError(err.message || "No se pudieron cargar tus publicaciones.");
    } finally {
      setCargando(false);
    }
  }

  return (
    <div className="min-h-screen bg-[#082b1f] text-white p-6 md:p-10">
      {/* HEADER */}
      <div className="flex items-center justify-between gap-3 mb-8">
        <div className="flex items-center gap-3">
          <img src={hoja} alt="logo" className="w-10 h-10 drop-shadow-lg" />
        <div>
          <h1 className="text-3xl font-bold text-emerald-400">
            Mis publicaciones
          </h1>
          <p className="text-sm text-emerald-100/80">
            Aqu√≠ ves todo lo que has publicado en el marketplace.
          </p>
        </div>
        </div>

        <a
          href="/publicaciones"
          className="bg-emerald-500 hover:bg-emerald-600 px-4 py-2 rounded-lg font-semibold"
        >
          Ir al marketplace
        </a>
      </div>

      {/* ERROR */}
      {error && (
        <div className="mb-4 rounded-md border border-red-400 bg-red-900/40 px-4 py-2 text-sm text-red-100">
          {error}
        </div>
      )}

      {/* CONTENIDO */}
      {cargando ? (
        <div className="text-center text-emerald-100/80">Cargando...</div>
      ) : !error && publicaciones.length === 0 ? (
        <div className="text-center text-emerald-100/80">
          Todav√≠a no has creado ninguna publicaci√≥n.
        </div>
      ) : !error ? (
        <div className="bg-[#0f3f2d] border border-emerald-700 rounded-xl overflow-x-auto">
          <table className="min-w-full text-sm">
            <thead className="border-b border-emerald-600 text-emerald-300">
              <tr>
                <th className="text-left py-2 px-4">T√≠tulo</th>
                <th className="text-left py-2 px-4">Categor√≠a</th>
                <th className="text-left py-2 px-4">Cr√©ditos</th>
                <th className="text-left py-2 px-4">Estado</th>
                <th className="text-left py-2 px-4">Creado</th>
              </tr>
            </thead>
            <tbody>
              {publicaciones.map((p) => (
                <tr
                  key={p.id_publicacion}
                  className="border-b border-emerald-800/50 last:border-0"
                >
                  <td className="py-2 px-4">{p.titulo}</td>
                  <td className="py-2 px-4">
                    {p.categoria || p.id_categoria}
                  </td>
                  <td className="py-2 px-4">{p.valor_creditos} cr.</td>
                  <td className="py-2 px-4">
                    <span
                      className={`px-2 py-1 rounded-full border text-xs ${
                        p.estado === "PUBLICADA" || p.estado === "ACTIVA"
                          ? "border-emerald-400 text-emerald-300"
                          : "border-yellow-400 text-yellow-300"
                      }`}
                    >
                      {p.estado || "‚Äî"}
                    </span>
                  </td>
                  <td className="py-2 px-4">
                    {p.creado_en || p.created_at || "-"}
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      ) : null}
    </div>
  );
}
</file>

<file path="frontend/src/pages/Movimientos.jsx">
import React, { useEffect, useState } from "react";
import { api } from "../services/api";
import hoja from "../assets/hoja.png";

export default function Movimientos() {
  const [movimientos, setMovimientos] = useState([]);
  const [cargando, setCargando] = useState(true);

  useEffect(() => {
    cargarMovimientos();
  }, []);

  async function cargarMovimientos() {
    try {
      const res = await api("/wallet/mis-movimientos");
      setMovimientos(res);
    } catch (err) {
      console.error("Error cargando movimientos:", err);
    } finally {
      setCargando(false);
    }
  }

  if (cargando) {
    return (
      <div className="min-h-screen bg-[#082b1f] text-white flex items-center justify-center">
        Cargando movimientos...
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-[#082b1f] text-white p-6 md:p-10">
      {/* HEADER */}
      <div className="flex items-center gap-3 mb-8">
        <img src={hoja} alt="logo" className="w-10 h-10 drop-shadow-lg" />
        <h1 className="text-3xl font-bold text-emerald-400">
          Movimientos de Wallet
        </h1>
      </div>

      {/* TABLA */}
      <div className="bg-[#0f3f2d] border border-emerald-600 rounded-xl shadow-lg p-4 md:p-6 overflow-x-auto">
        {movimientos.length === 0 ? (
          <p className="opacity-80">Todav√≠a no tienes movimientos.</p>
        ) : (
          <table className="min-w-full text-sm">
            <thead className="border-b border-emerald-600 text-emerald-300">
              <tr>
                <th className="py-2 text-left">Fecha</th>
                <th className="py-2 text-left">Tipo</th>
                <th className="py-2 text-left">Descripci√≥n</th>
                <th className="py-2 text-right">Cr√©ditos</th>
                <th className="py-2 text-right">Saldo</th>
              </tr>
            </thead>
            <tbody>
              {movimientos.map((m, idx) => (
                <tr
                  key={idx}
                  className="border-b border-emerald-800/60 last:border-0"
                >
                  <td className="py-2 pr-4">
                    {m.fecha || m.fecha_movimiento || "-"}
                  </td>
                  <td className="py-2 pr-4">
                    {m.tipo_movimiento || m.tipo || "Movimiento"}
                  </td>
                  <td className="py-2 pr-4">
                    {m.descripcion || "‚Äî"}
                  </td>
                  <td
                    className={`py-2 pr-4 text-right font-semibold ${
                      m.creditos >= 0 ? "text-emerald-400" : "text-red-400"
                    }`}
                  >
                    {m.creditos >= 0 ? "+" : ""}
                    {m.creditos} cr
                  </td>
                  <td className="py-2 pl-4 text-right">
                    {m.saldo_resultante ?? m.saldo ?? "‚Äî"}
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        )}
      </div>
    </div>
  );
}
</file>

<file path="frontend/src/pages/NotFound.jsx">
import React from "react";
import { Link } from "react-router-dom";

export default function NotFound() {
  return (
    <div className="min-h-screen flex flex-col items-center justify-center bg-gray-100">
      <div className="bg-white px-6 py-5 rounded-lg shadow-sm border border-gray-200 text-center max-w-sm">
        <h1 className="text-3xl font-bold text-gray-900 mb-2">404</h1>
        <p className="text-sm text-gray-500 mb-4">
          La p√°gina que buscas no existe.
        </p>
        <Link to="/home" className="btn-primary">
          Volver al inicio
        </Link>
      </div>
    </div>
  );
}
</file>

<file path="frontend/src/pages/Perfil.jsx">
import React, { useEffect, useState } from "react";
import hoja from "../assets/hoja.png";
import { api } from "../services/api";
import { useNavigate } from "react-router-dom";

export default function Perfil() {
  const [usuario, setUsuario] = useState(null);
  const [creditos, setCreditos] = useState(null);

  const navigate = useNavigate();

  useEffect(() => {
    cargarDatos();
  }, []);

  async function cargarDatos() {
    try {
      const datosUsuario = await api("/auth/me");
      const wallet = await api("/wallet/mis-creditos");

      setUsuario(datosUsuario);
      setCreditos(wallet.saldo);
    } catch (err) {
      console.error("Error cargando perfil:", err);
    }
  }

  if (!usuario) {
    return (
      <div className="min-h-screen bg-[#082b1f] flex items-center justify-center text-white">
        <p>Cargando perfil...</p>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-[#082b1f] text-white p-6 md:p-10">

      {/* Header */}
      <div className="flex items-center gap-3 mb-8">
        <img src={hoja} className="w-12 h-12 drop-shadow-lg" />
        <h1 className="text-3xl font-bold text-emerald-400">Mi Perfil</h1>
      </div>

      {/* Tarjeta principal */}
      <div className="bg-[#0e4330] border border-emerald-500 rounded-xl p-6 md:p-8 shadow-xl mb-10">
        <div className="flex flex-col md:flex-row md:items-center gap-6">

          {/* Foto */}
          <div>
            <img
              src={usuario.foto || "https://via.placeholder.com/120"}
              className="w-28 h-28 rounded-full object-cover border-4 border-emerald-500 shadow-lg"
            />
          </div>

          {/* Info */}
          <div className="flex-1">
            <h2 className="text-2xl font-bold text-emerald-300">
              {usuario.nombre}
            </h2>

            <p className="opacity-90">{usuario.correo}</p>

            <p className="mt-2 text-sm">
              Estado:{" "}
              <span
                className={`font-bold ${
                  usuario.es_premium ? "text-yellow-300" : "text-emerald-300"
                }`}
              >
                {usuario.es_premium ? "Premium" : "Cuenta Normal"}
              </span>
            </p>

            <button
              onClick={() => navigate("/perfil/editar")}
              className="mt-4 bg-emerald-500 hover:bg-emerald-600 px-5 py-2 rounded-lg font-semibold transition"
            >
              Editar Perfil
            </button>
          </div>
        </div>
      </div>

      {/* Tarjetas secundarias */}
      <div className="grid md:grid-cols-3 gap-6">

        {/* Cr√©ditos */}
        <div className="bg-[#0e4330] border border-emerald-500 p-6 rounded-xl shadow-lg">
          <h3 className="text-lg font-semibold text-emerald-300">Mis Cr√©ditos</h3>
          <p className="text-4xl font-bold text-emerald-400 mt-2">
            {creditos !== null ? creditos : "‚Äî"}
          </p>
        </div>

        {/* Logros */}
        <div
          onClick={() => navigate("/logros")}
          className="bg-[#0e4330] border border-emerald-500 p-6 rounded-xl shadow-lg 
          hover:bg-[#14694c] transition cursor-pointer"
        >
          <h3 className="text-lg font-semibold text-emerald-300">Logros</h3>
          <p className="opacity-80 mt-1">Ver mis insignias ganadas</p>
        </div>

        {/* Actividades */}
        <div
          onClick={() => navigate("/actividades")}
          className="bg-[#0e4330] border border-emerald-500 p-6 rounded-xl shadow-lg
          hover:bg-[#14694c] transition cursor-pointer"
        >
          <h3 className="text-lg font-semibold text-emerald-300">
            Actividades sostenibles
          </h3>
          <p className="opacity-80 mt-1">
            Mi impacto positivo registrado
          </p>
        </div>

      </div>

      {/* Bot√≥n independiente (extra) */}
      <button
        onClick={() => navigate("/logros")}
        className="mt-6 px-6 py-3 bg-emerald-600 hover:bg-emerald-500 rounded-xl 
        text-white font-semibold shadow-md transition"
      >
        Ver logros
      </button>

    </div>
  );
}
</file>

<file path="frontend/src/pages/Premium.jsx">
// frontend/src/pages/Premium.jsx
import { useEffect, useState } from "react";
import { useNavigate } from "react-router-dom";
import { api } from "../services/api";

export default function Premium() {
  const [loadingPlan, setLoadingPlan] = useState(true);
  const [activando, setActivando] = useState(false);
  const [plan, setPlan] = useState(null);
  const [error, setError] = useState("");
  const [mensaje, setMensaje] = useState("");
  const navigate = useNavigate();

  // Cargar plan premium actual
  useEffect(() => {
    async function cargarPlan() {
      try {
        setError("");
        setMensaje("");
        setLoadingPlan(true);

        const data = await api("/premium/mi-plan");

        // miPlanPremiumService devuelve una FILA; por seguridad,
        // soportamos tambi√©n que pueda venir como array de 1 elemento.
        let row = null;
        if (Array.isArray(data)) row = data[0] || null;
        else if (data && Object.keys(data).length > 0) row = data;

        setPlan(row);
      } catch (err) {
        console.error(err);
        setError("No se pudo cargar la informaci√≥n de tu plan premium.");
        setPlan(null);
      } finally {
        setLoadingPlan(false);
      }
    }

    cargarPlan();
  }, []);

  // En tu BD el valor "activo" es ACTIVA
  const esPremium = !!plan && plan.estado === "ACTIVA";
  const esVencida = !!plan && plan.estado === "VENCIDA";
  const esCancelada = !!plan && plan.estado === "CANCELADA";

  function formatearFecha(fecha) {
    if (!fecha) return "‚Äî";
    const d = new Date(fecha);
    if (Number.isNaN(d.getTime())) return fecha;
    return d.toLocaleDateString("es-BO", {
      year: "numeric",
      month: "short",
      day: "2-digit",
    });
  }

  async function activarPremium() {
    try {
      setError("");
      setMensaje("");
      setActivando(true);

      const nuevaSubscripcion = await api("/premium/activar", {
        method: "POST",
      });

      // Actualizamos el plan con lo que devuelva el backend
      setPlan(nuevaSubscripcion);
      setMensaje("¬°Listo! Ahora eres usuario Premium üåø");
    } catch (err) {
      console.error(err);
      setError(
        err.message ||
          "Ocurri√≥ un error al activar tu plan premium. Intenta de nuevo."
      );
    } finally {
      setActivando(false);
    }
  }

  return (
    <div className="min-h-screen bg-gradient-to-b from-emerald-950 via-emerald-900 to-emerald-950 text-emerald-50 px-4 py-6">
      {/* HEADER */}
      <header className="mb-8 flex items-center justify-between">
        <button
          type="button"
          onClick={() => navigate(-1)}
          className="inline-flex items-center gap-2 rounded-full bg-black/30 px-3 py-1 text-sm hover:bg-black/40"
        >
          <span className="text-lg">‚Üê</span>
          Volver
        </button>

        <div className="rounded-full bg-emerald-700/80 px-4 py-1.5 text-sm font-semibold shadow">
          Plan Premium
        </div>
      </header>

      {/* T√çTULO */}
      <section className="mb-6 space-y-2">
        <h1 className="text-3xl font-semibold tracking-wide">
          Haz crecer tu impacto con{" "}
          <span className="text-emerald-300">Premium</span>
        </h1>
        <p className="max-w-3xl text-sm text-emerald-100/80">
          Con la suscripci√≥n premium obtienes m√°s visibilidad en el marketplace,
          beneficios especiales y reportes avanzados de tu impacto ambiental.
        </p>
      </section>

      {/* MENSAJES GLOBALES */}
      {error && (
        <div className="mb-4 rounded-md border border-red-500/60 bg-red-900/40 px-4 py-2 text-sm text-red-100">
          {error}
        </div>
      )}
      {mensaje && (
        <div className="mb-4 rounded-md border border-emerald-400/60 bg-emerald-900/40 px-4 py-2 text-sm text-emerald-100">
          {mensaje}
        </div>
      )}

      {/* CONTENIDO PRINCIPAL */}
      <div className="grid gap-6 lg:grid-cols-2">
        {/* PANEL IZQUIERDO: ESTADO / CONVERSI√ìN A PREMIUM */}
        <section className="rounded-3xl border border-emerald-700/70 bg-emerald-950/40 p-6 shadow-lg">
          {loadingPlan && (
            <p className="text-sm text-emerald-100/80">
              Cargando estado de tu plan premium‚Ä¶
            </p>
          )}

          {!loadingPlan && !esPremium && !esVencida && !esCancelada && (
            <>
              <h2 className="text-xl font-semibold mb-2">
                A√∫n no eres usuario premium
              </h2>
              <p className="text-sm text-emerald-100/80 mb-4">
                Activa tu suscripci√≥n para desbloquear beneficios exclusivos
                dentro de Digital Barter.
              </p>

              <ul className="mb-6 ml-4 list-disc space-y-1 text-sm text-emerald-100/90">
                <li>Mayor visibilidad para tus publicaciones.</li>
                <li>Acceso a reportes avanzados y m√©tricas de impacto.</li>
                <li>Insignia especial en tu perfil y en el marketplace.</li>
              </ul>

              <button
                type="button"
                onClick={activarPremium}
                disabled={activando}
                className="rounded-full bg-emerald-500 px-6 py-2 text-sm font-semibold text-emerald-950 shadow hover:bg-emerald-400 disabled:opacity-60 disabled:cursor-not-allowed"
              >
                {activando ? "Activando..." : "Convertirme en usuario Premium"}
              </button>
            </>
          )}

          {!loadingPlan && esPremium && (
            <>
              <h2 className="text-xl font-semibold mb-2">
                ¬°Ya eres usuario Premium! üåø
              </h2>
              <p className="text-sm text-emerald-100/80 mb-4">
                Tu cuenta tiene una suscripci√≥n premium activa.
              </p>

              <div className="space-y-2 text-sm text-emerald-100/90">
                <p>
                  <span className="font-semibold">Estado:</span>{" "}
                  {plan.estado || "ACTIVA"}
                </p>
                <p>
                  <span className="font-semibold">Fecha inicio:</span>{" "}
                  {formatearFecha(plan.fecha_inicio)}
                </p>
                <p>
                  <span className="font-semibold">Fecha fin:</span>{" "}
                  {formatearFecha(plan.fecha_fin)}
                </p>
                <p>
                  <span className="font-semibold">Monto:</span>{" "}
                  {plan.monto_bs != null
                    ? Number(plan.monto_bs).toFixed(2)
                    : "‚Äî"}{" "}
                  Bs
                </p>
              </div>

              <p className="mt-5 text-xs text-emerald-200/70">
                Estos datos provienen de tu √∫ltima fila en la tabla{" "}
                <span className="font-mono">SUSCRIPCION_PREMIUM</span>.
              </p>
            </>
          )}

          {!loadingPlan && (esVencida || esCancelada) && !esPremium && (
            <>
              <h2 className="text-xl font-semibold mb-2">
                Tu plan premium ya no est√° activo
              </h2>
              <p className="text-sm text-emerald-100/80 mb-4">
                Estado actual:{" "}
                <span className="font-semibold">{plan.estado}</span>. Puedes
                activar nuevamente tu suscripci√≥n para seguir disfrutando de los
                beneficios premium.
              </p>

              <div className="space-y-2 text-sm text-emerald-100/90 mb-4">
                <p>
                  <span className="font-semibold">√öltimo inicio:</span>{" "}
                  {formatearFecha(plan.fecha_inicio)}
                </p>
                <p>
                  <span className="font-semibold">√öltimo fin:</span>{" "}
                  {formatearFecha(plan.fecha_fin)}
                </p>
              </div>

              <button
                type="button"
                onClick={activarPremium}
                disabled={activando}
                className="rounded-full bg-emerald-500 px-6 py-2 text-sm font-semibold text-emerald-950 shadow hover:bg-emerald-400 disabled:opacity-60 disabled:cursor-not-allowed"
              >
                {activando ? "Reactivando..." : "Volver a ser usuario Premium"}
              </button>
            </>
          )}
        </section>

        {/* PANEL DERECHO: BENEFICIOS / INFO */}
        <aside className="rounded-3xl border border-emerald-700/70 bg-emerald-950/30 p-6 shadow-lg">
          <h2 className="text-xl font-semibold mb-3">¬øQu√© incluye Premium?</h2>
          <ul className="ml-4 list-disc space-y-2 text-sm text-emerald-100/90">
            <li>Prioridad en el listado de publicaciones del marketplace.</li>
            <li>Mayor l√≠mite para registrar actividades sostenibles al mes.</li>
            <li>Acceso a reportes especiales y estad√≠sticas detalladas.</li>
            <li>Soporte preferencial dentro de la plataforma.</li>
          </ul>

        </aside>
      </div>
    </div>
  );
}
</file>

<file path="frontend/src/pages/Promociones.jsx">
// digital-barder/frontend/src/pages/Promociones.jsx
import { useEffect, useState } from "react";
import {
  getPromociones,
  crearPromocion,
  cambiarEstadoPromocion,
  vincularPublicacionPromocion,
} from "../services/api";
import { useNavigate } from "react-router-dom";
import {
  ArrowLeft,
  Tag,
  Percent,
  Gift,
  Link2,
  ToggleLeft,
  ToggleRight,
} from "lucide-react";
import hoja from "../assets/hoja.png";

export default function Promociones() {
  const navigate = useNavigate();

  const [promociones, setPromociones] = useState([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState("");
  const [mensajeOk, setMensajeOk] = useState("");

  // formulario nueva promo
  const [idTipoPromo, setIdTipoPromo] = useState("");
  const [nombre, setNombre] = useState("");
  const [descripcion, setDescripcion] = useState("");
  const [creditos, setCreditos] = useState("");
  const [fechaInicio, setFechaInicio] = useState("");
  const [fechaFin, setFechaFin] = useState("");

  // vincular publicaci√≥n
  const [promoSeleccionada, setPromoSeleccionada] = useState(null);
  const [idPublicacionVincular, setIdPublicacionVincular] = useState("");

  useEffect(() => {
    cargarPromociones();
  }, []);

  async function cargarPromociones() {
    try {
      setLoading(true);
      setError("");
      const data = await getPromociones();
      setPromociones(Array.isArray(data) ? data : []);
    } catch (err) {
      console.error(err);
      setError(err.message || "No se pudieron cargar las promociones.");
    } finally {
      setLoading(false);
    }
  }

  async function handleCrearPromocion(e) {
    e.preventDefault();
    setError("");
    setMensajeOk("");

    const id_tipo_promocion = Number(idTipoPromo || 0);
    const creditos_otorgados = Number(creditos || 0);

    if (!id_tipo_promocion || !nombre.trim() || !fechaInicio || !fechaFin) {
      setError(
        "id_tipo_promocion, nombre, fecha de inicio y fecha fin son obligatorios."
      );
      return;
    }

    try {
      await crearPromocion({
        id_tipo_promocion,
        nombre,
        descripcion,
        creditos_otorgados,
        fecha_inicio: fechaInicio,
        fecha_fin: fechaFin,
      });

      setMensajeOk("Promoci√≥n creada correctamente.");
      // limpiar
      setIdTipoPromo("");
      setNombre("");
      setDescripcion("");
      setCreditos("");
      setFechaInicio("");
      setFechaFin("");

      await cargarPromociones();
    } catch (err) {
      console.error(err);
      setError(
        err.message || "Ocurri√≥ un error al crear la promoci√≥n."
      );
    }
  }

  async function handleToggleEstado(promo) {
    const nuevoEstado = promo.estado === "ACTIVA" ? "INACTIVA" : "ACTIVA";

    const ok = window.confirm(
      `¬øDeseas cambiar el estado de la promoci√≥n "${promo.nombre}" a ${nuevoEstado}?`
    );
    if (!ok) return;

    try {
      setError("");
      setMensajeOk("");
      await cambiarEstadoPromocion(promo.id_promocion, nuevoEstado);
      setMensajeOk("Estado actualizado correctamente.");
      await cargarPromociones();
    } catch (err) {
      console.error(err);
      setError(
        err.message || "No se pudo actualizar el estado de la promoci√≥n."
      );
    }
  }

  async function handleVincularPublicacion(e) {
    e.preventDefault();
    if (!promoSeleccionada || !idPublicacionVincular.trim()) return;

    try {
      setError("");
      setMensajeOk("");
      await vincularPublicacionPromocion(
        promoSeleccionada.id_promocion,
        Number(idPublicacionVincular)
      );
      setMensajeOk("Publicaci√≥n vinculada a la promoci√≥n.");
      setIdPublicacionVincular("");
    } catch (err) {
      console.error(err);
      setError(
        err.message || "No se pudo vincular la publicaci√≥n a la promoci√≥n."
      );
    }
  }

  return (
    <div className="min-h-screen bg-[#082b1f] text-white p-6 md:p-10">
      {/* HEADER */}
      <header className="flex items-center justify-between gap-4 mb-8">
        <div className="flex items-center gap-3">
          <button
            type="button"
            onClick={() => navigate(-1)}
            className="inline-flex items-center gap-2 rounded-full bg-black/30 px-3 py-1 text-sm hover:bg-black/40"
          >
            <ArrowLeft size={16} />
            Volver
          </button>

          <div className="flex items-center gap-2 rounded-2xl bg-emerald-900/70 px-3 py-2 text-sm">
            <Tag size={18} className="text-emerald-300" />
            <span className="font-semibold">Gesti√≥n de promociones</span>
          </div>
        </div>

        <div className="flex items-center gap-3">
          <span className="text-sm text-emerald-100/80">
            Total:{" "}
            <span className="font-semibold text-emerald-300">
              {promociones.length}
            </span>
          </span>
          <img src={hoja} alt="logo" className="w-9 h-9 drop-shadow-md" />
        </div>
      </header>

      {/* MENSAJES */}
      {error && (
        <div className="mb-4 rounded-md border border-red-400 bg-red-900/40 px-4 py-2 text-sm text-red-100">
          {error}
        </div>
      )}

      {mensajeOk && (
        <div className="mb-4 rounded-md border border-emerald-400 bg-emerald-900/40 px-4 py-2 text-sm text-emerald-100">
          {mensajeOk}
        </div>
      )}

      {/* CONTENIDO: LISTADO + FORMULARIO */}
      <div className="grid gap-6 lg:grid-cols-[2fr,1.5fr]">

        {/* LISTADO DE PROMOCIONES */}
        <section className="bg-[#0f3f2d] border border-emerald-700 rounded-2xl p-4 md:p-5 shadow-md">
          <h2 className="text-lg font-semibold text-emerald-200 flex items-center gap-2 mb-3">
            <Percent size={18} className="text-emerald-300" />
            Promociones configuradas
          </h2>

          {loading ? (
            <p className="text-emerald-100/80 text-sm">Cargando promociones...</p>
          ) : promociones.length === 0 ? (
            <p className="text-emerald-100/80 text-sm">
              No hay promociones registradas.
            </p>
          ) : (
            <div className="space-y-3 max-h-[480px] overflow-y-auto pr-1">
              {promociones.map((promo) => (
                <article
                  key={promo.id_promocion}
                  className={`rounded-xl border p-3 text-sm flex flex-col gap-2 cursor-pointer ${
                    promoSeleccionada?.id_promocion === promo.id_promocion
                      ? "border-emerald-400 bg-emerald-900/50"
                      : "border-emerald-700/70 bg-emerald-900/30 hover:border-emerald-500/80"
                  }`}
                  onClick={() => setPromoSeleccionada(promo)}
                >
                  <div className="flex items-center justify-between gap-3">
                    <div>
                      <p className="text-xs text-emerald-300/80">
                        ID #{promo.id_promocion}
                      </p>
                      <h3 className="font-semibold text-emerald-100">
                        {promo.nombre}
                      </h3>
                    </div>

                    <button
                      type="button"
                      onClick={(e) => {
                        e.stopPropagation();
                        handleToggleEstado(promo);
                      }}
                      className="inline-flex items-center gap-1 px-3 py-1 rounded-full border border-emerald-500/70 text-xs"
                    >
                      {promo.estado === "ACTIVA" ? (
                        <>
                          <ToggleRight size={16} className="text-emerald-300" />
                          <span>Activa</span>
                        </>
                      ) : (
                        <>
                          <ToggleLeft size={16} className="text-emerald-300" />
                          <span>Inactiva</span>
                        </>
                      )}
                    </button>
                  </div>

                  <p className="text-emerald-100/80 text-xs">
                    {promo.descripcion || "Sin descripci√≥n."}
                  </p>

                  <div className="flex flex-wrap gap-3 text-[11px] text-emerald-200/90">
                    {typeof promo.creditos_otorgados === "number" && (
                      <span className="px-2 py-0.5 rounded-full bg-emerald-800/60 border border-emerald-600/80">
                        +{promo.creditos_otorgados} cr.
                      </span>
                    )}

                    {promo.fecha_inicio && (
                      <span>
                        Inicio:{" "}
                        {new Date(promo.fecha_inicio).toLocaleDateString()}
                      </span>
                    )}
                    {promo.fecha_fin && (
                      <span>
                        Fin:{" "}
                        {new Date(promo.fecha_fin).toLocaleDateString()}
                      </span>
                    )}
                  </div>
                </article>
              ))}
            </div>
          )}
        </section>

        {/* FORMULARIO NUEVA PROMO + VINCULAR PUBLICACI√ìN */}
        <section className="space-y-4">
          {/* NUEVA PROMO */}
          <div className="bg-[#0f3f2d] border border-emerald-700 rounded-2xl p-4 md:p-5 shadow-md">
            <h2 className="text-lg font-semibold text-emerald-200 flex items-center gap-2 mb-3">
              <Gift size={18} className="text-emerald-300" />
              Crear nueva promoci√≥n
            </h2>

            <form onSubmit={handleCrearPromocion} className="space-y-3 text-sm">
              <div>
                <label className="block text-xs mb-1">
                  ID tipo de promoci√≥n (id_tipo_promocion) *
                </label>
                <input
                  type="number"
                  value={idTipoPromo}
                  onChange={(e) => setIdTipoPromo(e.target.value)}
                  className="w-full rounded-lg border border-emerald-700 bg-emerald-950/80 px-3 py-2 text-sm outline-none focus:ring focus:ring-emerald-500/60"
                  placeholder="Ej. 1 (descuento), 2 (bonus cr√©ditos)..."
                />
              </div>

              <div>
                <label className="block text-xs mb-1">Nombre *</label>
                <input
                  type="text"
                  value={nombre}
                  onChange={(e) => setNombre(e.target.value)}
                  className="w-full rounded-lg border border-emerald-700 bg-emerald-950/80 px-3 py-2 text-sm outline-none focus:ring focus:ring-emerald-500/60"
                  placeholder="Ej. Promo bienvenida, 2x1 en cr√©ditos..."
                />
              </div>

              <div>
                <label className="block text-xs mb-1">Descripci√≥n</label>
                <textarea
                  value={descripcion}
                  onChange={(e) => setDescripcion(e.target.value)}
                  rows={2}
                  className="w-full rounded-lg border border-emerald-700 bg-emerald-950/80 px-3 py-2 text-sm outline-none focus:ring focus:ring-emerald-500/60"
                  placeholder="Explica las condiciones de la promoci√≥n..."
                />
              </div>

              <div>
                <label className="block text-xs mb-1">
                  Cr√©ditos otorgados (opcional)
                </label>
                <input
                  type="number"
                  value={creditos}
                  onChange={(e) => setCreditos(e.target.value)}
                  className="w-full rounded-lg border border-emerald-700 bg-emerald-950/80 px-3 py-2 text-sm outline-none focus:ring focus:ring-emerald-500/60"
                  placeholder="Ej. 10"
                />
              </div>

              <div className="grid grid-cols-2 gap-3">
                <div>
                  <label className="block text-xs mb-1">Fecha inicio *</label>
                  <input
                    type="date"
                    value={fechaInicio}
                    onChange={(e) => setFechaInicio(e.target.value)}
                    className="w-full rounded-lg border border-emerald-700 bg-emerald-950/80 px-3 py-2 text-sm outline-none focus:ring focus:ring-emerald-500/60"
                  />
                </div>
                <div>
                  <label className="block text-xs mb-1">Fecha fin *</label>
                  <input
                    type="date"
                    value={fechaFin}
                    onChange={(e) => setFechaFin(e.target.value)}
                    className="w-full rounded-lg border border-emerald-700 bg-emerald-950/80 px-3 py-2 text-sm outline-none focus:ring focus:ring-emerald-500/60"
                  />
                </div>
              </div>

              <div className="pt-2 flex justify-end">
                <button
                  type="submit"
                  className="px-6 py-2 rounded-lg bg-emerald-500 hover:bg-emerald-600 text-sm font-semibold text-emerald-950"
                >
                  Guardar promoci√≥n
                </button>
              </div>
            </form>
          </div>

          {/* VINCULAR PUBLICACI√ìN */}
          <div className="bg-[#0f3f2d] border border-emerald-700 rounded-2xl p-4 md:p-5 shadow-md">
            <h2 className="text-sm font-semibold text-emerald-200 flex items-center gap-2 mb-3">
              <Link2 size={16} className="text-emerald-300" />
              Vincular publicaci√≥n a promoci√≥n
            </h2>

            {promoSeleccionada ? (
              <>
                <p className="text-xs text-emerald-100/90 mb-2">
                  Promoci√≥n seleccionada:{" "}
                  <span className="font-semibold">{promoSeleccionada.nombre}</span>{" "}
                  (ID #{promoSeleccionada.id_promocion})
                </p>

                <form
                  onSubmit={handleVincularPublicacion}
                  className="flex flex-col sm:flex-row gap-2 text-sm"
                >
                  <input
                    type="number"
                    value={idPublicacionVincular}
                    onChange={(e) => setIdPublicacionVincular(e.target.value)}
                    className="flex-1 rounded-lg border border-emerald-700 bg-emerald-950/80 px-3 py-2 text-sm outline-none focus:ring focus:ring-emerald-500/60"
                    placeholder="ID de publicaci√≥n"
                  />
                  <button
                    type="submit"
                    className="px-4 py-2 rounded-lg bg-emerald-500 hover:bg-emerald-600 text-sm font-semibold text-emerald-950"
                  >
                    Vincular
                  </button>
                </form>
              </>
            ) : (
              <p className="text-xs text-emerald-100/80">
                Primero selecciona una promoci√≥n del listado para poder
                vincularle publicaciones.
              </p>
            )}
          </div>
        </section>
      </div>
    </div>
  );
}
</file>

<file path="frontend/src/pages/Publicaciones.jsx">
// digital-barder/frontend/src/pages/Publicaciones.jsx
import { useEffect, useState } from "react";
import { api } from "../services/api";
import hoja from "../assets/hoja.png";
import { crearIntercambio } from "../services/api";

export default function Publicaciones() {
  const [publicaciones, setPublicaciones] = useState([]);
  const [cargando, setCargando] = useState(true);
  const [error, setError] = useState("");
  const [filtroTexto, setFiltroTexto] = useState("");
  const [filtroCategoria, setFiltroCategoria] = useState("TODAS");

  useEffect(() => {
    cargarPublicaciones();
  }, []);

  async function cargarPublicaciones() {
    try {
      setError("");
      setCargando(true);
      // usa el listado general, filtrado por estado ACTIVA
      const data = await api("/publicaciones");
      setPublicaciones(Array.isArray(data) ? data : []);
    } catch (err) {
      console.error(err);
      setError("No se pudieron cargar las publicaciones.");
    } finally {
      setCargando(false);
    }
  }

  // armar lista de categor√≠as distintas
  const categorias = [
    "TODAS",
    ...Array.from(
      new Set(
        publicaciones
          .map((p) => p.categoria)
          .filter(Boolean)
      )
    ),
  ];

  const filtradas = publicaciones.filter((p) => {
    const texto = filtroTexto.trim().toLowerCase();
    const coincideTexto =
      !texto ||
      (p.titulo || "").toLowerCase().includes(texto) ||
      (p.descripcion || "").toLowerCase().includes(texto);

    const categoriaPub = p.categoria || "OTROS";
    const coincideCategoria =
      filtroCategoria === "TODAS" || filtroCategoria === categoriaPub;

    return coincideTexto && coincideCategoria;
  });

  async function handleIntercambiar(pub) {
  const creditos = pub.valor_creditos; // viene del backend en la card

  const ok = window.confirm(
    `¬øQuieres intercambiar ${creditos} cr√©ditos por "${pub.titulo}"?`
  );
  if (!ok) return;

  try {
    await crearIntercambio({
      id_publicacion: pub.id_publicacion,
      creditos,
    });
    alert("Intercambio realizado correctamente ‚úÖ");
    // opcional: navigate("/intercambios");
  } catch (err) {
    console.error(err);
    alert(
      err.message ||
        "Ocurri√≥ un error al realizar el intercambio. Revisa tu saldo."
    );
  }
}

  return (
    <div className="min-h-screen bg-[#082b1f] text-white p-6 md:p-10">
      {/* HEADER */}
      <div className="flex items-center justify-between gap-3 mb-8">
        <div className="flex items-center gap-3">
          <img src={hoja} alt="logo" className="w-10 h-10 drop-shadow-lg" />
          <h1 className="text-3xl font-bold text-emerald-400">
            Marketplace
          </h1>
        </div>

        {/* luego puedes cambiar href a /publicaciones/nueva */}
        <a
            href="/publicaciones/nueva"
            className="bg-emerald-500 hover:bg-emerald-600 px-4 py-2 rounded-lg font-semibold"
            >
            Crear publicaci√≥n
        </a>
        <a
            href="/publicaciones/mias"
            className="bg-emerald-500 hover:bg-emerald-600 px-4 py-2 rounded-lg font-semibold"
            >
            Mis publicaciones
            </a>
      </div>

      {/* FILTROS */}
      <div className="bg-[#0f3f2d] border border-emerald-600 rounded-xl p-4 mb-6 flex flex-col md:flex-row gap-4 md:items-center">
        <div className="flex-1">
          <label className="block text-sm text-emerald-200 mb-1">
            Buscar
          </label>
          <input
            type="text"
            value={filtroTexto}
            onChange={(e) => setFiltroTexto(e.target.value)}
            placeholder="T√≠tulo o descripci√≥n..."
            className="w-full bg-[#0e4330] border border-emerald-600 rounded-lg px-3 py-2 outline-none focus:ring-2 focus:ring-emerald-400"
          />
        </div>

        <div className="w-full md:w-64">
          <label className="block text-sm text-emerald-200 mb-1">
            Categor√≠a
          </label>
          <select
            value={filtroCategoria}
            onChange={(e) => setFiltroCategoria(e.target.value)}
            className="w-full bg-[#0e4330] border border-emerald-600 rounded-lg px-3 py-2 outline-none focus:ring-2 focus:ring-emerald-400"
          >
            {categorias.map((c) => (
              <option key={c} value={c}>
                {c === "TODAS" ? "Todas las categor√≠as" : c}
              </option>
            ))}
          </select>
        </div>
      </div>

      {/* ERRORES */}
      {error && (
        <div className="mb-4 rounded-md border border-red-400 bg-red-900/40 px-4 py-2 text-sm text-red-100">
          {error}
        </div>
      )}

      {/* LISTA DE PUBLICACIONES */}
      {cargando ? (
        <div className="text-center text-emerald-100/80">Cargando...</div>
      ) : filtradas.length === 0 ? (
        <div className="text-center text-emerald-100/80">
          No se encontraron publicaciones activas con los filtros actuales.
        </div>
      ) : (
        <div className="grid gap-5 md:grid-cols-3">
          {filtradas.map((p) => (
            <article
              key={p.id_publicacion}
              className="bg-[#0f3f2d] border border-emerald-700 rounded-xl p-4 shadow-md flex flex-col"
            >
              {/* Imagen si viene */}
              {p.imagen_url && (
                <img
                  src={p.imagen_url}
                  alt={p.titulo}
                  className="w-full h-40 object-cover rounded-lg mb-3"
                />
              )}

              <h2 className="text-lg font-semibold text-emerald-200">
                {p.titulo}
              </h2>

              <p className="text-xs text-emerald-300/80 mt-1">
                {p.categoria || "Sin categor√≠a"} ¬∑ {p.usuario}
              </p>

              <p className="mt-2 text-sm text-emerald-100/90 line-clamp-3">
                {p.descripcion || "Sin descripci√≥n"}
              </p>

              <div className="mt-3 flex items-center justify-between text-sm">
                <span className="font-semibold text-emerald-300">
                  {p.valor_creditos} cr.
                </span>
                <span
                  className={`text-xs px-2 py-1 rounded-full border ${
                    p.estado === "ACTIVA"
                      ? "border-emerald-400 text-emerald-300"
                      : "border-yellow-400 text-yellow-300"
                  }`}
                >
                  {p.estado}
                </span>
              </div>

              <button
                type="button"
                className="mt-4 w-full rounded-lg bg-emerald-500 hover:bg-emerald-600 py-2 text-sm font-semibold"
                onClick={() =>
                  alert(
                    "Aqu√≠ m√°s adelante podemos abrir el detalle o flujo de intercambio."
                  )
                }
              >
                Ver detalle
              </button>
             <button
                onClick={() => handleIntercambiar(pub.id_publicacion)}
                className="mt-3 w-full bg-emerald-500 hover:bg-emerald-600 text-emerald-950 font-semibold py-2 rounded-xl"
                >
                Intercambiar
            </button>

            </article>
          ))}
        </div>
      )}
    </div>
  );
}
</file>

<file path="frontend/src/pages/PublicacionNueva.jsx">
import { useState } from "react";
import { useNavigate } from "react-router-dom";
import { api } from "../services/api";
import hoja from "../assets/hoja.png";

export default function PublicacionNueva() {
  const [tipo, setTipo] = useState("PRODUCTO"); // PRODUCTO | SERVICIO
  const [titulo, setTitulo] = useState("");
  const [descripcion, setDescripcion] = useState("");
  const [idCategoria, setIdCategoria] = useState("");
  const [costoCreditos, setCostoCreditos] = useState("");
  const [cantidad, setCantidad] = useState("");
  const [horario, setHorario] = useState("A convenir");

  const [imagenFile, setImagenFile] = useState(null);
  const [imagenPreview, setImagenPreview] = useState(null);

  const [loading, setLoading] = useState(false);
  const [mensajeError, setMensajeError] = useState("");
  const [mensajeOk, setMensajeOk] = useState("");

  const navigate = useNavigate();

  async function manejarSubmit(e) {
    e.preventDefault();
    setMensajeError("");
    setMensajeOk("");

    if (!titulo.trim() || !descripcion.trim() || !idCategoria || !costoCreditos) {
      setMensajeError("T√≠tulo, descripci√≥n, categor√≠a y cr√©ditos son obligatorios.");
      return;
    }

    try {
      setLoading(true);

      // 1) Subir imagen si se seleccion√≥
      let imagenURL = null;
      if (imagenFile) {
        const formData = new FormData();
        formData.append("archivo", imagenFile);

        const resUpload = await api("/uploads", {
          method: "POST",
          body: formData,
        });

        imagenURL = resUpload.url || resUpload.imagen_url || null;
      }

      // 2) Construir body seg√∫n tipo (usando nombres EXACTOS del backend)
      const base = {
        titulo: titulo.trim(),
        descripcion: descripcion.trim(),
        id_categoria: Number(idCategoria),
        valor_creditos: Number(costoCreditos), // nombre del campo en PUBLICACION
        imagen_url: imagenURL,
      };

      let endpoint = "";
      let body = {};

      if (tipo === "PRODUCTO") {
        endpoint = "/publicaciones/producto";

        body = {
          ...base,
          producto: {
            nombre: titulo.trim(),
            descripcion: descripcion.trim(),
            precio: null,
            peso: null,
          },
          cantidad: Number(cantidad || 1), // requerido
          id_um: 1, // unidad gen√©rica; en tu BD ser√° la UM con id=1
        };
      } else {
        endpoint = "/publicaciones/servicio";

        body = {
          ...base,
          servicio: {
            nombre: titulo.trim(),
            descripcion: descripcion.trim(),
            precio: null,
            duracion_min: null,
          },
          horario: horario || "A convenir", // requerido por el backend
        };
      }

      await api(endpoint, {
        method: "POST",
        body,
      });

      setMensajeOk("Publicaci√≥n creada correctamente üéâ");

      // limpiar formulario
      setTitulo("");
      setDescripcion("");
      setIdCategoria("");
      setCostoCreditos("");
      setCantidad("");
      setHorario("A convenir");
      setImagenFile(null);
      setImagenPreview(null);

      // redirigir a "Mis publicaciones"
      setTimeout(() => {
        navigate("/publicaciones/mias");
      }, 1200);
    } catch (err) {
      console.error(err);
      setMensajeError(
        err.message || "Ocurri√≥ un error al crear la publicaci√≥n."
      );
    } finally {
      setLoading(false);
    }
  }

  return (
    <div className="min-h-screen bg-[#082b1f] text-white p-6 md:p-10">
      {/* HEADER */}
      <div className="flex items-center justify-between gap-3 mb-8">
        <div className="flex items-center gap-3">
          <img src={hoja} alt="logo" className="w-10 h-10 drop-shadow-lg" />
          <div>
            <h1 className="text-3xl font-bold text-emerald-400">
              Nueva publicaci√≥n
            </h1>
            <p className="text-sm text-emerald-100/80">
              Publica un producto o servicio para intercambiar con cr√©ditos verdes.
            </p>
          </div>
        </div>

        <button
          type="button"
          onClick={() => navigate(-1)}
          className="px-4 py-2 rounded-lg border border-emerald-500 text-sm hover:bg-emerald-500/10"
        >
          Volver
        </button>
      </div>

      {/* MENSAJES */}
      {mensajeError && (
        <div className="mb-4 rounded-md border border-red-400 bg-red-900/40 px-4 py-2 text-sm text-red-100">
          {mensajeError}
        </div>
      )}

      {mensajeOk && (
        <div className="mb-4 rounded-md border border-emerald-400 bg-emerald-900/40 px-4 py-2 text-sm text-emerald-100">
          {mensajeOk}
        </div>
      )}

      {/* FORMULARIO */}
      <form
        onSubmit={manejarSubmit}
        className="bg-[#0f3f2d] border border-emerald-700 rounded-xl p-6 md:p-8 max-w-3xl mx-auto space-y-6"
      >
        {/* Tipo */}
        <div>
          <span className="block text-sm font-semibold text-emerald-200 mb-2">
            Tipo de publicaci√≥n
          </span>
          <div className="flex gap-3">
            <button
              type="button"
              onClick={() => setTipo("PRODUCTO")}
              className={`flex-1 py-2 rounded-lg border text-sm font-semibold
                ${
                  tipo === "PRODUCTO"
                    ? "bg-emerald-500 text-black border-emerald-400"
                    : "bg-[#0e4330] border-emerald-700 hover:border-emerald-500"
                }`}
            >
              Producto
            </button>
            <button
              type="button"
              onClick={() => setTipo("SERVICIO")}
              className={`flex-1 py-2 rounded-lg border text-sm font-semibold
                ${
                  tipo === "SERVICIO"
                    ? "bg-emerald-500 text-black border-emerald-400"
                    : "bg-[#0e4330] border-emerald-700 hover:border-emerald-500"
                }`}
            >
              Servicio
            </button>
          </div>
        </div>

        {/* T√≠tulo */}
        <div>
          <label className="block text-sm text-emerald-200 mb-1">
            T√≠tulo *
          </label>
          <input
            type="text"
            value={titulo}
            onChange={(e) => setTitulo(e.target.value)}
            className="w-full bg-[#0e4330] border border-emerald-600 rounded-lg px-3 py-2 outline-none focus:ring-2 focus:ring-emerald-400"
            placeholder="Ej. Sudadera, Clases de ingl√©s..."
          />
        </div>

        {/* Descripci√≥n */}
        <div>
          <label className="block text-sm text-emerald-200 mb-1">
            Descripci√≥n *
          </label>
          <textarea
            value={descripcion}
            onChange={(e) => setDescripcion(e.target.value)}
            rows={4}
            className="w-full bg-[#0e4330] border border-emerald-600 rounded-lg px-3 py-2 outline-none focus:ring-2 focus:ring-emerald-400 resize-y"
            placeholder="Describe brevemente el producto o servicio..."
          />
        </div>

        {/* Categor√≠a + Cr√©ditos */}
        <div className="grid gap-4 md:grid-cols-2">
          <div>
            <label className="block text-sm text-emerald-200 mb-1">
              ID categor√≠a *
            </label>
            <input
              type="number"
              value={idCategoria}
              onChange={(e) => setIdCategoria(e.target.value)}
              className="w-full bg-[#0e4330] border border-emerald-600 rounded-lg px-3 py-2 outline-none focus:ring-2 focus:ring-emerald-400"
              placeholder="Ej. 1 (Ropa), 2 (Servicios)..."
            />
          </div>

          <div>
            <label className="block text-sm text-emerald-200 mb-1">
              Costo en cr√©ditos *
            </label>
            <input
              type="number"
              min="1"
              value={costoCreditos}
              onChange={(e) => setCostoCreditos(e.target.value)}
              className="w-full bg-[#0e4330] border border-emerald-600 rounded-lg px-3 py-2 outline-none focus:ring-2 focus:ring-emerald-400"
              placeholder="Ej. 100"
            />
          </div>
        </div>

        {/* Cantidad / Horario */}
        {tipo === "PRODUCTO" ? (
          <div>
            <label className="block text-sm text-emerald-200 mb-1">
              Cantidad disponible
            </label>
            <input
              type="number"
              min="1"
              value={cantidad}
              onChange={(e) => setCantidad(e.target.value)}
              className="w-full bg-[#0e4330] border border-emerald-600 rounded-lg px-3 py-2 outline-none focus:ring-2 focus:ring-emerald-400"
              placeholder="Por defecto 1"
            />
          </div>
        ) : (
          <div>
            <label className="block text-sm text-emerald-200 mb-1">
              Horario (para el servicio)
            </label>
            <input
              type="text"
              value={horario}
              onChange={(e) => setHorario(e.target.value)}
              className="w-full bg-[#0e4330] border border-emerald-600 rounded-lg px-3 py-2 outline-none focus:ring-2 focus:ring-emerald-400"
              placeholder="Ej. Fines de semana por la tarde"
            />
          </div>
        )}

        {/* Imagen */}
        <div>
          <label className="block text-sm text-emerald-200 mb-1">
            Imagen (opcional)
          </label>
          <input
            type="file"
            accept="image/*"
            onChange={(e) => {
              const file = e.target.files?.[0];
              setImagenFile(file || null);
              setImagenPreview(file ? URL.createObjectURL(file) : null);
            }}
            className="block w-full text-sm text-emerald-100 file:mr-4 file:rounded-lg file:border-0 file:bg-emerald-500 file:px-3 file:py-1 file:text-sm file:font-semibold hover:file:bg-emerald-600"
          />

          {imagenPreview && (
            <img
              src={imagenPreview}
              alt="Previsualizaci√≥n"
              className="mt-3 w-40 h-32 object-cover rounded-lg border border-emerald-600"
            />
          )}
        </div>

        {/* BOTONES */}
        <div className="flex justify-end gap-3 pt-4">
          <button
            type="button"
            onClick={() => navigate("/publicaciones/mias")}
            className="px-4 py-2 rounded-lg border border-emerald-500 text-sm hover:bg-emerald-500/10"
          >
            Cancelar
          </button>
          <button
            type="submit"
            disabled={loading}
            className={`px-5 py-2 rounded-lg text-sm font-semibold
              ${
                loading
                  ? "bg-gray-500 cursor-not-allowed"
                  : "bg-emerald-500 hover:bg-emerald-600"
              }`}
          >
            {loading ? "Guardando..." : "Publicar"}
          </button>
        </div>
      </form>
    </div>
  );
}
</file>

<file path="frontend/src/pages/Publicidad.jsx">
// digital-barder/frontend/src/pages/Publicidad.jsx
import { useEffect, useState } from "react";
import { useNavigate } from "react-router-dom";
import { getPublicidadActiva, crearPublicidad } from "../services/api";
import {
  ArrowLeft,
  Megaphone,
  Monitor,
  CalendarRange,
  ExternalLink,
  Coins,
} from "lucide-react";
import hoja from "../assets/hoja.png";

export default function Publicidad() {
  const navigate = useNavigate();

  const [anuncios, setAnuncios] = useState([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState("");
  const [mensajeOk, setMensajeOk] = useState("");

  // formulario nueva publicidad
  const [idUbicacion, setIdUbicacion] = useState("");
  const [titulo, setTitulo] = useState("");
  const [descripcion, setDescripcion] = useState("");
  const [urlDestino, setUrlDestino] = useState("");
  const [fechaInicio, setFechaInicio] = useState("");
  const [fechaFin, setFechaFin] = useState("");
  const [costoCreditos, setCostoCreditos] = useState("");

  useEffect(() => {
    cargarPublicidad();
  }, []);

  async function cargarPublicidad() {
    try {
      setLoading(true);
      setError("");
      const data = await getPublicidadActiva();
      setAnuncios(Array.isArray(data) ? data : []);
    } catch (err) {
      console.error(err);
      setError(
        err.message || "No se pudo cargar la publicidad activa."
      );
    } finally {
      setLoading(false);
    }
  }

  async function handleCrearPublicidad(e) {
    e.preventDefault();
    setError("");
    setMensajeOk("");

    const id_ubicacion = Number(idUbicacion || 0);
    const costo_creditos = Number(costoCreditos || 0);

    if (!id_ubicacion || !titulo.trim() || !fechaInicio || !fechaFin || !costo_creditos) {
      setError(
        "id_ubicacion, t√≠tulo, fecha inicio, fecha fin y costo en cr√©ditos son obligatorios."
      );
      return;
    }

    try {
      await crearPublicidad({
        id_ubicacion,
        titulo,
        descripcion,
        url_destino: urlDestino || null,
        fecha_inicio: fechaInicio,
        fecha_fin: fechaFin,
        costo_creditos,
      });

      setMensajeOk("Publicidad creada correctamente.");
      // limpiar
      setIdUbicacion("");
      setTitulo("");
      setDescripcion("");
      setUrlDestino("");
      setFechaInicio("");
      setFechaFin("");
      setCostoCreditos("");

      await cargarPublicidad();
    } catch (err) {
      console.error(err);
      setError(
        err.message || "Ocurri√≥ un error al crear la publicidad."
      );
    }
  }

  return (
    <div className="min-h-screen bg-[#082b1f] text-white p-6 md:p-10">
      {/* HEADER */}
      <header className="flex items-center justify-between gap-4 mb-8">
        <div className="flex items-center gap-3">
          <button
            type="button"
            onClick={() => navigate(-1)}
            className="inline-flex items-center gap-2 rounded-full bg-black/30 px-3 py-1 text-sm hover:bg-black/40"
          >
            <ArrowLeft size={16} />
            Volver
          </button>

          <div className="flex items-center gap-2 rounded-2xl bg-emerald-900/70 px-3 py-2 text-sm">
            <Megaphone size={18} className="text-emerald-300" />
            <span className="font-semibold">Gesti√≥n de publicidad</span>
          </div>
        </div>

        <div className="flex items-center gap-3">
          <span className="text-sm text-emerald-100/80 flex items-center gap-1">
            <Monitor size={16} className="text-emerald-300" />
            Activos:{" "}
            <span className="font-semibold text-emerald-300">
              {anuncios.length}
            </span>
          </span>
          <img src={hoja} alt="logo" className="w-9 h-9 drop-shadow-md" />
        </div>
      </header>

      {/* MENSAJES */}
      {error && (
        <div className="mb-4 rounded-md border border-red-400 bg-red-900/40 px-4 py-2 text-sm text-red-100">
          {error}
        </div>
      )}

      {mensajeOk && (
        <div className="mb-4 rounded-md border border-emerald-400 bg-emerald-900/40 px-4 py-2 text-sm text-emerald-100">
          {mensajeOk}
        </div>
      )}

      {/* CONTENIDO: LISTADO + FORMULARIO */}
      <div className="grid gap-6 lg:grid-cols-[2fr,1.5fr]">
        {/* LISTADO DE PUBLICIDAD ACTIVA */}
        <section className="bg-[#0f3f2d] border border-emerald-700 rounded-2xl p-4 md:p-5 shadow-md">
          <h2 className="text-lg font-semibold text-emerald-200 flex items-center gap-2 mb-3">
            <Monitor size={18} className="text-emerald-300" />
            Publicidad activa
          </h2>

          {loading ? (
            <p className="text-emerald-100/80 text-sm">
              Cargando anuncios...
            </p>
          ) : anuncios.length === 0 ? (
            <p className="text-emerald-100/80 text-sm">
              No hay publicidad activa en este momento.
            </p>
          ) : (
            <div className="space-y-3 max-h-[480px] overflow-y-auto pr-1">
              {anuncios.map((ad) => (
                <article
                  key={ad.id_publicidad}
                  className="rounded-xl border border-emerald-700/70 bg-emerald-900/30 p-3 text-sm flex flex-col gap-2"
                >
                  <div className="flex items-center justify-between gap-3">
                    <div>
                      <p className="text-xs text-emerald-300/80">
                        ID #{ad.id_publicidad} ¬∑ {ad.usuario || "Usuario"}
                      </p>
                      <h3 className="font-semibold text-emerald-100">
                        {ad.titulo}
                      </h3>
                    </div>

                    {typeof ad.costo_creditos === "number" && (
                      <div className="flex items-center gap-1 text-[11px] px-2 py-1 rounded-full bg-emerald-800/70 border border-emerald-500/70">
                        <Coins size={14} className="text-emerald-300" />
                        <span>{ad.costo_creditos} cr.</span>
                      </div>
                    )}
                  </div>

                  {ad.descripcion && (
                    <p className="text-emerald-100/80 text-xs">
                      {ad.descripcion}
                    </p>
                  )}

                  <div className="flex flex-wrap gap-3 text-[11px] text-emerald-200/80 mt-1">
                    {ad.fecha_inicio && (
                      <span>
                        Inicio:{" "}
                        {new Date(ad.fecha_inicio).toLocaleDateString()}
                      </span>
                    )}
                    {ad.fecha_fin && (
                      <span>
                        Fin: {new Date(ad.fecha_fin).toLocaleDateString()}
                      </span>
                    )}
                    {ad.id_ubicacion && (
                      <span>Ubicaci√≥n #{ad.id_ubicacion}</span>
                    )}
                  </div>

                  {ad.url_destino && (
                    <a
                      href={ad.url_destino}
                      target="_blank"
                      rel="noopener noreferrer"
                      className="mt-2 inline-flex items-center gap-1 text-xs text-emerald-300 hover:text-emerald-100"
                    >
                      <ExternalLink size={14} />
                      Ver destino
                    </a>
                  )}
                </article>
              ))}
            </div>
          )}
        </section>

        {/* FORMULARIO NUEVA PUBLICIDAD */}
        <section className="bg-[#0f3f2d] border border-emerald-700 rounded-2xl p-4 md:p-5 shadow-md">
          <h2 className="text-lg font-semibold text-emerald-200 flex items-center gap-2 mb-3">
            <Megaphone size={18} className="text-emerald-300" />
            Crear nueva publicidad
          </h2>

          <p className="text-xs text-emerald-100/80 mb-3">
            Esta campa√±a descontar√° cr√©ditos de la billetera del usuario que la
            publica, seg√∫n el costo configurado y la ubicaci√≥n seleccionada.
          </p>

          <form onSubmit={handleCrearPublicidad} className="space-y-3 text-sm">
            {/* id_ubicacion */}
            <div>
              <label className="block text-xs mb-1">
                ID de ubicaci√≥n (id_ubicacion) *
              </label>
              <input
                type="number"
                value={idUbicacion}
                onChange={(e) => setIdUbicacion(e.target.value)}
                className="w-full rounded-lg border border-emerald-700 bg-emerald-950/80 px-3 py-2 text-sm outline-none focus:ring focus:ring-emerald-500/60"
                placeholder="Ej. 1 (header), 2 (sidebar), 3 (dashboard)..."
              />
            </div>

            {/* t√≠tulo */}
            <div>
              <label className="block text-xs mb-1">T√≠tulo *</label>
              <input
                type="text"
                value={titulo}
                onChange={(e) => setTitulo(e.target.value)}
                className="w-full rounded-lg border border-emerald-700 bg-emerald-950/80 px-3 py-2 text-sm outline-none focus:ring focus:ring-emerald-500/60"
                placeholder="Ej. Promociona tu ecoservicio aqu√≠"
              />
            </div>

            {/* descripci√≥n */}
            <div>
              <label className="block text-xs mb-1">Descripci√≥n</label>
              <textarea
                value={descripcion}
                onChange={(e) => setDescripcion(e.target.value)}
                rows={3}
                className="w-full rounded-lg border border-emerald-700 bg-emerald-950/80 px-3 py-2 text-sm outline-none focus:ring focus:ring-emerald-500/60"
                placeholder="Describe brevemente el anuncio o campa√±a..."
              />
            </div>

            {/* url_destino */}
            <div>
              <label className="block text-xs mb-1">
                URL de destino (opcional)
              </label>
              <input
                type="url"
                value={urlDestino}
                onChange={(e) => setUrlDestino(e.target.value)}
                className="w-full rounded-lg border border-emerald-700 bg-emerald-950/80 px-3 py-2 text-sm outline-none focus:ring focus:ring-emerald-500/60"
                placeholder="https://ejemplo.com/mi-campa√±a"
              />
            </div>

            {/* costo_creditos */}
            <div>
              <label className="block text-xs mb-1">
                Costo en cr√©ditos (costo_creditos) *
              </label>
              <input
                type="number"
                value={costoCreditos}
                onChange={(e) => setCostoCreditos(e.target.value)}
                className="w-full rounded-lg border border-emerald-700 bg-emerald-950/80 px-3 py-2 text-sm outline-none focus:ring focus:ring-emerald-500/60"
                placeholder="Ej. 50"
              />
            </div>

            {/* fechas */}
            <div className="grid grid-cols-2 gap-3">
              <div>
                <label className="block text-xs mb-1">Fecha inicio *</label>
                <input
                  type="date"
                  value={fechaInicio}
                  onChange={(e) => setFechaInicio(e.target.value)}
                  className="w-full rounded-lg border border-emerald-700 bg-emerald-950/80 px-3 py-2 text-sm outline-none focus:ring focus:ring-emerald-500/60"
                />
              </div>
              <div>
                <label className="block text-xs mb-1">Fecha fin *</label>
                <input
                  type="date"
                  value={fechaFin}
                  onChange={(e) => setFechaFin(e.target.value)}
                  className="w-full rounded-lg border border-emerald-700 bg-emerald-950/80 px-3 py-2 text-sm outline-none focus:ring focus:ring-emerald-500/60"
                />
              </div>
            </div>

            <div className="pt-2 flex justify-end">
              <button
                type="submit"
                className="px-6 py-2 rounded-lg bg-emerald-500 hover:bg-emerald-600 text-sm font-semibold text-emerald-950"
              >
                Guardar publicidad
              </button>
            </div>
          </form>
        </section>
      </div>
    </div>
  );
}
</file>

<file path="frontend/src/pages/Register.jsx">
// frontend/src/pages/Register.jsx
import React, { useState, useEffect } from "react";
import { Link, useNavigate } from "react-router-dom";
import { register } from "../services/api";
import hojaLogo from "../assets/hoja.png";
import aurella from '../assets/aurella.png';
import aurela from '../assets/aurela.png';
const SLIDES = [
  {
    id: 1,
    
    image:
      aurela,
  },
  {
    id: 2,
    
    image:
      aurella,
  },
  {
    id: 3,
    title: "Impacto ambiental positivo",
    text: "Reduce CO‚ÇÇ, agua y energ√≠a con cada intercambio.",
    image:
      "https://images.pexels.com/photos/286763/pexels-photo-286763.jpeg?auto=compress&cs=tinysrgb&w=1600",
  },
];

export default function Register() {
  const [nombre, setNombre] = useState("");
  const [apellidos, setApellidos] = useState("");
  const [correo, setCorreo] = useState("");
  const [telefono, setTelefono] = useState("");
  const [password, setPassword] = useState("");
  const [password2, setPassword2] = useState("");

  const [dia, setDia] = useState("22");
  const [mes, setMes] = useState("sept.");
  const [anio, setAnio] = useState("2025");
  const [genero, setGenero] = useState("Hombre");
  const [tipoUsuario, setTipoUsuario] = useState("Emprendedor");

  const [error, setError] = useState("");
  const [ok, setOk] = useState("");
  const [loading, setLoading] = useState(false);
  const [slideIndex, setSlideIndex] = useState(0);

  const navigate = useNavigate();

  useEffect(() => {
    const id = setInterval(
      () => setSlideIndex((prev) => (prev + 1) % SLIDES.length),
      5000
    );
    return () => clearInterval(id);
  }, []);

  const currentSlide = SLIDES[slideIndex];

  const dias = Array.from({ length: 31 }, (_, i) => String(i + 1));
  const anios = Array.from({ length: 80 }, (_, i) => String(2025 - i));

  async function handleSubmit(e) {
    e.preventDefault();
    setError("");
    setOk("");

    if (!nombre || !correo || !password || !password2) {
      setError("Nombre, correo y contrase√±as son obligatorios.");
      return;
    }

    if (password !== password2) {
      setError("Las contrase√±as no coinciden.");
      return;
    }

    try {
      setLoading(true);
      await register({
        nombre,
        apellido: apellidos,
        correo,
        password,
        telefono: telefono || undefined,
      });

      setOk("Cuenta creada correctamente. Ahora puedes iniciar sesi√≥n.");
      navigate("/login");
    } catch (err) {
      console.error(err);
      setError(err.message || "No se pudo registrar el usuario.");
    } finally {
      setLoading(false);
    }
  }

  return (
    <div className="min-h-screen bg-gradient-to-br from-[#012b20] via-[#013726] to-[#011711] text-white flex flex-col">
      {/* NAVBAR SUPERIOR */}
      <header className="flex items-center justify-between px-10 py-4">
        <div className="flex items-center gap-3">
          <div className="flex items-center justify-center w-10 h-10 rounded-full bg-white/10">
            <img
              src={hojaLogo}
              alt="Logo Digital Barter"
              className="w-7 h-7 object-contain"
            />
          </div>
          <div>
            <h1 className="text-2xl font-black leading-tight tracking-tight">
              Digital Barter
            </h1>
            <p className="text-sm text-green-300 font-semibold flex items-center gap-1">
              green credits
              <span className="inline-block w-2 h-2 rounded-full bg-green-400" />
            </p>
          </div>
        </div>

        <Link
          to="/login"
          className="px-5 py-2 rounded-full bg-white text-green-900 font-semibold text-sm hover:bg-gray-100 transition"
        >
          Iniciar sesi√≥n
        </Link>
      </header>

      {/* CONTENIDO PRINCIPAL */}
      <main className="flex-1 flex items-center justify-center gap-19 px-4 lg:px-12 pb-6">
        {/* PANEL IZQUIERDO: CARRUSEL ADELGAZADO */}
        <section className="flex-1 max-w-md bg-black/10 rounded-2xl overflow-hidden shadow-xl ">
          <div className="relative h-[580px]">
            <img
              src={currentSlide.image}
              alt={currentSlide.title}
              className="w-full h-full object"
            />
            <div className="absolute inset-0 bg-gradient-to-t from-black/70 via-black/20 to-transparent" />
            <div className="absolute inset-0 flex flex-col justify-end p-6">
              <h2 className="text-xl font-bold mb-2">{currentSlide.title}</h2>
              <p className="text-base text-gray-200 mb-4">{currentSlide.text}</p>
              <div className="flex gap-2">
                {SLIDES.map((s, idx) => (
                  <button
                    key={s.id}
                    onClick={() => setSlideIndex(idx)}
                    className={`w-2.5 h-2.5 rounded-full ${
                      idx === slideIndex ? "bg-white" : "bg-white/40"
                    }`}
                  />
                ))}
              </div>
            </div>
          </div>
        </section>

        {/* PANEL DERECHO: FORM REGISTRO EXPANDIDO */}
        <section className="w-full max-w-2xl rounded-3xl p-8">
          <h1
            className="text-center mb-8"
            style={{
              fontFamily: '"Berlin Sans FB Demi", system-ui, sans-serif',
              fontSize: "2.8rem",
              fontWeight: 700,
              letterSpacing: "0.08em",
              color: "#FFFFFF",
            }}
          >
            Crea una Cuenta
          </h1>

          {error && (
            <div className="mb-4 bg-red-500/20 border border-red-400 text-sm px-3 py-2 rounded-lg text-white">
              {error}
            </div>
          )}
          {ok && (
            <div className="mb-4 bg-green-500/20 border border-green-400 text-sm px-3 py-2 rounded-lg text-white">
              {ok}
            </div>
          )}

          <form onSubmit={handleSubmit} className="space-y-4">
            {/* Nombre / Apellidos */}
            <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
              <input
                type="text"
                value={nombre}
                onChange={(e) => setNombre(e.target.value)}
                placeholder="Nombre"
                className="w-full h-[60px] rounded-lg bg-[#E9FFD9] text-[#013726] px-4 text-[16px] font-medium border-none shadow placeholder-[#013726]/60"
              />
              <input
                type="text"
                value={apellidos}
                onChange={(e) => setApellidos(e.target.value)}
                placeholder="Apellidos"
                className="w-full h-[60px] rounded-lg bg-[#E9FFD9] text-[#013726] px-4 text-[16px] font-medium border-none shadow placeholder-[#013726]/60"
              />
            </div>

            {/* Fecha de nacimiento */}
            <div className="grid grid-cols-3 gap-3">
              <div className="flex flex-col">
                <label className="text-xs mb-1 text-gray-200 flex items-center gap-1">
                  Fecha de nacimiento
                  <span className="text-[0.7rem] w-4 h-4 rounded-full border border-gray-300 flex items-center justify-center">
                    ?
                  </span>
                </label>
                <select
                  value={dia}
                  onChange={(e) => setDia(e.target.value)}
                  className="w-full h-[60px] rounded-lg bg-[#E9FFD9] text-[#013726] px-4 text-[16px] font-medium border-none shadow"
                >
                  {dias.map((d) => (
                    <option key={d} value={d}>
                      {d}
                    </option>
                  ))}
                </select>
              </div>

              <div className="flex flex-col">
                <label className="text-xs mb-1 text-transparent select-none">
                  .
                </label>
                <select
                  value={mes}
                  onChange={(e) => setMes(e.target.value)}
                  className="w-full h-[60px] rounded-lg bg-[#E9FFD9] text-[#013726] px-4 text-[16px] font-medium border-none shadow"
                >
                  <option>ene.</option>
                  <option>feb.</option>
                  <option>mar.</option>
                  <option>abr.</option>
                  <option>may.</option>
                  <option>jun.</option>
                  <option>jul.</option>
                  <option>ago.</option>
                  <option>sept.</option>
                  <option>oct.</option>
                  <option>nov.</option>
                  <option>dic.</option>
                </select>
              </div>

              <div className="flex flex-col">
                <label className="text-xs mb-1 text-transparent select-none">
                  .
                </label>
                <select
                  value={anio}
                  onChange={(e) => setAnio(e.target.value)}
                  className="w-full h-[60px] rounded-lg bg-[#E9FFD9] text-[#013726] px-4 text-[16px] font-medium border-none shadow"
                >
                  {anios.map((a) => (
                    <option key={a} value={a}>
                      {a}
                    </option>
                  ))}
                </select>
              </div>
            </div>

            {/* G√©nero + Tipo Usuario */}
            <div className="grid grid-cols-3 gap-3">
              {/* G√©nero */}
              <div className="flex flex-col col-span-2">
                <label className="text-xs mb-1 text-gray-200 flex items-center gap-1">
                  G√©nero
                  <span className="text-[0.7rem] w-4 h-4 rounded-full border border-gray-300 flex items-center justify-center">
                    ?
                  </span>
                </label>
                <div className="grid grid-cols-2 gap-2">
                  <button
                    type="button"
                    onClick={() => setGenero("Hombre")}
                    className={`w-full h-[60px] rounded-lg flex items-center justify-between px-4 text-sm font-medium ${
                      genero === "Hombre"
                        ? "bg-[#E9FFD9] text-[#013726]"
                        : "bg-[#0b3a25] text-gray-100 border border-white/20"
                    }`}
                  >
                    <span>Hombre</span>
                    <span
                      className={`w-5 h-5 rounded-full ml-3 border flex items-center justify-center ${
                        genero === "Hombre"
                          ? "border-[#013726] bg-[#0fd46e]"
                          : "border-gray-300 bg-transparent"
                      }`}
                    >
                      {genero === "Hombre" && (
                        <span className="w-2.5 h-2.5 rounded-full bg-[#013726]" />
                      )}
                    </span>
                  </button>

                  <button
                    type="button"
                    onClick={() => setGenero("Mujer")}
                    className={`w-full h-[60px] rounded-lg flex items-center justify-between px-4 text-sm font-medium ${
                      genero === "Mujer"
                        ? "bg-[#E9FFD9] text-[#013726]"
                        : "bg-[#0b3a25] text-gray-100 border border-white/20"
                    }`}
                  >
                    <span>Mujer</span>
                    <span
                      className={`w-5 h-5 rounded-full ml-3 border flex items-center justify-center ${
                        genero === "Mujer"
                          ? "border-[#013726] bg-[#0fd46e]"
                          : "border-gray-300 bg-transparent"
                      }`}
                    >
                      {genero === "Mujer" && (
                        <span className="w-2.5 h-2.5 rounded-full bg-[#013726]" />
                      )}
                    </span>
                  </button>
                </div>
              </div>

              {/* Tipo Usuario */}
              <div className="flex flex-col">
                <label className="text-xs mb-1 text-gray-200">
                  Tipo Usuario
                </label>
                <select
                  value={tipoUsuario}
                  onChange={(e) => setTipoUsuario(e.target.value)}
                  className="w-full h-[60px] rounded-lg bg-[#E9FFD9] text-[#013726] px-4 text-[16px] font-medium border-none shadow"
                >
                  <option>Emprendedor</option>
                  <option>Consumidor</option>
                  <option>Ambos</option>
                </select>
              </div>
            </div>

            {/* Correo */}
            <input
              type="text"
              value={correo}
              onChange={(e) => setCorreo(e.target.value)}
              placeholder="N√∫mero de m√≥vil o correo electr√≥nico"
              className="w-full h-[60px] rounded-lg bg-[#E9FFD9] text-[#013726] px-4 text-[16px] font-medium border-none shadow placeholder-[#013726]/60"
            />

            {/* Contrase√±as */}
            <input
              type="password"
              value={password}
              onChange={(e) => setPassword(e.target.value)}
              placeholder="Contrase√±a"
              className="w-full h-[60px] rounded-lg bg-[#E9FFD9] text-[#013726] px-4 text-[16px] font-medium border-none shadow placeholder-[#013726]/60"
            />

            <input
              type="password"
              value={password2}
              onChange={(e) => setPassword2(e.target.value)}
              placeholder="Confirmar contrase√±a"
              className="w-full h-[60px] rounded-lg bg-[#E9FFD9] text-[#013726] px-4 text-[16px] font-medium border-none shadow placeholder-[#013726]/60"
            />

            {/* Bot√≥n Registrar */}
            <div className="flex flex-col items-center gap-3 pt-2">
              <button
                type="submit"
                disabled={loading}
                className="w-64 h-[52px] bg-[#0b7a35] hover:bg-[#0cb652] disabled:opacity-60 disabled:cursor-not-allowed text-white rounded-lg text-lg transition-colors"
                style={{
                  fontFamily:
                    '"Berlin Sans FB Demi", "Arial Black", sans-serif',
                  fontWeight: 700,
                }}
              >
                {loading ? "Registrando..." : "Registrar"}
              </button>

              <p className="text-xs text-gray-200">
                ¬øYa tienes una cuenta?{" "}
                <Link to="/login" className="underline text-[#E9FFD9] hover:text-white transition-colors">
                  Inicia sesi√≥n
                </Link>
              </p>
            </div>
          </form>
        </section>
      </main>

      {/* FOOTER MOVIDO A LA DERECHA INFERIOR */}
      <footer className="text-xs text-gray-300 pb-4 pr-6 self-end">
        ¬°Un poco m√°s sobre nosotros!
      </footer>
    </div>
  );
}
</file>

<file path="frontend/src/pages/Reportes.jsx">
// frontend/src/pages/Reportes.jsx
import React from "react";
import { Link } from "react-router-dom";
import hoja from "../assets/hoja.png";

const reportesList = [
  {
    path: "/reportes/usuarios",
    title: "Usuarios activos y abandonados",
    description: "Qui√©nes est√°n usando la plataforma y qui√©nes no.",
    categoria: "Usuarios",
  },
  {
    path: "/reportes/ingresos-creditos",
    title: "Ingresos por venta de cr√©ditos",
    description: "Cr√©ditos vendidos e ingresos en bolivianos.",
    categoria: "Finanzas",
  },
  {
    path: "/reportes/creditos-generados-consumidos",
    title: "Cr√©ditos generados vs consumidos",
    description: "Balance global de cr√©ditos generados y consumidos.",
    categoria: "Cr√©ditos",
  },
  {
    path: "/reportes/intercambios-categoria",
    title: "Intercambios por categor√≠a",
    description: "Qu√© categor√≠as tienen m√°s movimiento en los intercambios.",
    categoria: "Intercambios",
  },
  {
    path: "/reportes/publicaciones-intercambios",
    title: "Publicaciones vs intercambios",
    description:
      "Relaci√≥n entre lo publicado y lo que realmente se intercambia.",
    categoria: "Intercambios",
  },
  {
    path: "/reportes/impacto-acumulado",
    title: "Impacto ambiental acumulado",
    description: "CO‚ÇÇ, agua y energ√≠a ahorrados en un per√≠odo.",
    categoria: "Impacto ambiental",
  },
  {
    path: "/reportes/ranking-usuarios",
    title: "Ranking de usuarios por impacto",
    description: "Top de usuarios seg√∫n su impacto ambiental.",
    categoria: "Usuarios",
  },
  {
    path: "/reportes/usuarios-premium",
    title: "Usuarios Premium",
    description: "Adopci√≥n, actividad e ingresos por suscripciones premium.",
    categoria: "Premium",
  },
  {
    path: "/reportes/saldos-usuarios",
    title: "Saldos de cr√©ditos por usuario",
    description: "Cr√©ditos disponibles actualmente en las billeteras.",
    categoria: "Cr√©ditos",
  },
  {
    path: "/reportes/actividades-sostenibles",
    title: "Actividades sostenibles",
    description: "Acciones ecol√≥gicas registradas por los usuarios.",
    categoria: "Actividades",
  },
  {
    path: "/reportes/impacto-categoria",
    title: "Impacto ambiental por categor√≠a",
    description: "Impacto ecol√≥gico agrupado por categor√≠a de publicaci√≥n.",
    categoria: "Impacto ambiental",
  },
];

export default function Reportes() {
  return (
    <div className="min-h-screen bg-[#082b1f] text-emerald-50 px-4 py-8 md:px-8">
      {/* HEADER */}
      <header className="max-w-6xl mx-auto mb-8 flex flex-col gap-4 md:flex-row md:items-center md:justify-between">
        <div className="flex items-center gap-3">
          <div className="w-10 h-10 rounded-full bg-emerald-500/10 border border-emerald-400/70 flex items-center justify-center overflow-hidden">
            <img
              src={hoja}
              alt="Reportes Digital Barder"
              className="w-8 h-8 object-contain drop-shadow-[0_0_8px_rgba(16,185,129,0.8)]"
            />
          </div>
          <div>
            <h1 className="text-2xl md:text-3xl font-bold text-emerald-300">
              Reportes y anal√≠ticas
            </h1>
            <p className="text-sm text-emerald-100/80">
              Explora los reportes clave de usuarios, cr√©ditos, intercambios e
              impacto ambiental.
            </p>
          </div>
        </div>
      </header>

      {/* CONTENIDO */}
      <main className="max-w-6xl mx-auto">
        <section>
          <h2 className="text-lg font-semibold text-emerald-200 mb-1">
            Tipos de reportes disponibles
          </h2>
          <p className="text-sm text-emerald-100/80 mb-4">
            Haz clic en cualquiera de los reportes para ver tablas detalladas,
            filtros por fecha y m√©tricas espec√≠ficas.
          </p>

          <div className="grid gap-4 md:grid-cols-2 xl:grid-cols-3">
            {reportesList.map((rep) => (
              <Link
                key={rep.path}
                to={rep.path}
                className="group rounded-2xl border border-emerald-700 bg-[#0f3f2d] p-4 shadow-lg hover:border-emerald-400 hover:bg-[#14533b] transition flex flex-col justify-between"
              >
                <div>
                  <p className="text-[11px] uppercase tracking-wide text-emerald-300/90 mb-1">
                    {rep.categoria}
                  </p>
                  <h3 className="text-base font-semibold text-emerald-50">
                    {rep.title}
                  </h3>
                  <p className="mt-1 text-sm text-emerald-100/80">
                    {rep.description}
                  </p>
                </div>

                <span className="mt-3 inline-flex items-center gap-1 text-[11px] font-semibold text-emerald-200 group-hover:text-emerald-50">
                  Ver reporte detallado
                  <span aria-hidden className="translate-y-[1px]">
                    ‚Üí
                  </span>
                </span>
              </Link>
            ))}
          </div>
        </section>
      </main>
    </div>
  );
}
</file>

<file path="frontend/src/pages/ReportesActividadesSostenibles.jsx">
import React, { useEffect, useMemo, useState } from "react";
import {
  BarChart,
  Bar,
  XAxis,
  YAxis,
  Tooltip,
  ResponsiveContainer,
  PieChart,
  Pie,
  Legend,
  Cell,
} from "recharts";
import { getReporteActividadesSostenibles } from "../services/api";
import hoja from "../assets/hoja.png";

function hoyISO() {
  return new Date().toISOString().slice(0, 10);
}

function hace30DiasISO() {
  const d = new Date(Date.now() - 30 * 24 * 60 * 60 * 1000);
  return d.toISOString().slice(0, 10);
}

export default function ReportesActividadesSostenibles() {
  const [desde, setDesde] = useState(hace30DiasISO());
  const [hasta, setHasta] = useState(hoyISO());
  const [datos, setDatos] = useState([]);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState("");

  async function cargar() {
    try {
      setLoading(true);
      setError("");
      const res = await getReporteActividadesSostenibles({ desde, hasta });
      setDatos(Array.isArray(res) ? res : []);
    } catch (e) {
      console.error(e);
      setError("Error cargando actividades sostenibles");
      setDatos([]);
    } finally {
      setLoading(false);
    }
  }

  useEffect(() => {
    cargar();
  }, []);

  function handleSubmit(e) {
    e.preventDefault();
    cargar();
  }

  // M√âTRICAS
  const metrics = useMemo(() => {
    if (!datos.length) {
      return {
        totalUsuarios: 0,
        totalActividades: 0,
        totalCreditos: 0,
        promedioCreditos: 0,
        topUsuario: null,
      };
    }

    const totalUsuarios = datos.length;
    const totalActividades = datos.reduce(
      (acc, it) => acc + Number(it.total_actividades || 0),
      0
    );
    const totalCreditos = datos.reduce(
      (acc, it) => acc + Number(it.creditos_otorgados || 0),
      0
    );
    const promedioCreditos =
      totalUsuarios ? totalCreditos / totalUsuarios : 0;

    const top = datos.reduce(
      (best, it) =>
        Number(it.creditos_otorgados || 0) >
        Number(best?.creditos_otorgados || 0)
          ? it
          : best,
      null
    );

    return {
      totalUsuarios,
      totalActividades,
      totalCreditos,
      promedioCreditos,
      topUsuario: top,
    };
  }, [datos]);

  // DATA GR√ÅFICOS
  const dataBarActividades = datos.map((d) => ({
    nombre: d.nombre,
    actividades: Number(d.total_actividades) || 0,
  }));

  const dataPieTop5 = (() => {
    const top5 = [...datos]
      .sort(
        (a, b) =>
          Number(b.creditos_otorgados || 0) -
          Number(a.creditos_otorgados || 0)
      )
      .slice(0, 5);

    return top5.map((u) => ({
      name: u.nombre,
      value: Number(u.creditos_otorgados) || 0,
    }));
  })();

  // PALETA PARA PIECHART
  const COLORS = ["#047857", "#0d9488", "#1e3a8a", "#6d28d9", "#0f766e"];

  return (
    <div
      className="min-h-screen p-8"
      style={{
        background: "linear-gradient(to bottom right, #f0fdf4, #d1fae5)",
        backgroundImage: `url(${hoja})`,
        backgroundRepeat: "no-repeat",
        backgroundPosition: "top right",
        backgroundSize: "160px",
      }}
    >
      <div className="max-w-6xl mx-auto space-y-8">
        
        {/* HEADER */}
        <header className="flex flex-col md:flex-row justify-between items-start md:items-end gap-6">
          <div className="flex items-center gap-4">
            <div className="w-16 h-16 rounded-full bg-white shadow-md flex items-center justify-center border border-emerald-700/20">
              <img src={hoja} className="w-10 h-10" />
            </div>

            <div>
              <h1 className="text-3xl font-extrabold text-emerald-800 drop-shadow">
                Reporte de Actividades Sostenibles
              </h1>
              <p className="text-sm text-emerald-700/80">
                Informe y an√°lisis avanzado por usuario
              </p>
            </div>
          </div>

          <form
            onSubmit={handleSubmit}
            className="flex gap-4 bg-white/60 px-4 py-3 rounded-xl shadow backdrop-blur"
          >
            <div className="flex flex-col text-sm">
              <label className="font-semibold text-emerald-900">Desde</label>
              <input
                type="date"
                value={desde}
                onChange={(e) => setDesde(e.target.value)}
                className="border rounded px-2 py-1 text-sm shadow-sm"
              />
            </div>

            <div className="flex flex-col text-sm">
              <label className="font-semibold text-emerald-900">Hasta</label>
              <input
                type="date"
                value={hasta}
                onChange={(e) => setHasta(e.target.value)}
                className="border rounded px-2 py-1 text-sm shadow-sm"
              />
            </div>

            <button
              type="submit"
              className="bg-emerald-700 hover:bg-emerald-800 text-white px-4 py-2 rounded-lg font-semibold shadow-md"
            >
              {loading ? "Cargando‚Ä¶" : "Actualizar"}
            </button>
          </form>
        </header>

        {error && (
          <div className="bg-red-100 text-red-700 border border-red-300 px-4 py-2 rounded-lg shadow-sm">
            {error}
          </div>
        )}

        {/* M√âTRICAS */}
        <section className="grid md:grid-cols-4 gap-6">
          {[
            {
              label: "Usuarios con actividades",
              value: metrics.totalUsuarios,
            },
            {
              label: "Total de actividades",
              value: metrics.totalActividades,
            },
            {
              label: "Total cr√©ditos otorgados",
              value: metrics.totalCreditos,
            },
            {
              label: "Promedio por usuario",
              value: metrics.promedioCreditos.toFixed(1),
            },
          ].map((m, i) => (
            <div
              key={i}
              className="bg-white shadow-md border border-emerald-200/40 rounded-xl p-4 hover:shadow-lg transition"
            >
              <p className="text-xs font-semibold text-emerald-800 uppercase tracking-wide">
                {m.label}
              </p>
              <p className="mt-2 text-3xl font-extrabold text-emerald-900 drop-shadow">
                {m.value}
              </p>
            </div>
          ))}
        </section>

        {/* GR√ÅFICOS */}
        <section className="grid lg:grid-cols-2 gap-6">
          {/* BARRAS */}
          <div className="bg-white rounded-xl border border-emerald-200/40 shadow p-4">
            <h2 className="text-lg font-bold text-emerald-800 mb-2">
              Actividades por Usuario
            </h2>

            <div className="h-72">
              <ResponsiveContainer>
                <BarChart data={dataBarActividades}>
                  <XAxis dataKey="nombre" hide />
                  <YAxis allowDecimals={false} />
                  <Tooltip />
                  <Bar dataKey="actividades" fill="#065f46" radius={[8, 8, 0, 0]} />
                </BarChart>
              </ResponsiveContainer>
            </div>
          </div>

          {/* PIE */}
          <div className="bg-white rounded-xl border border-emerald-200/40 shadow p-4">
            <h2 className="text-lg font-bold text-emerald-800 mb-2">
              Top 5 por Cr√©ditos Otorgados
            </h2>

            <div className="h-72">
              <ResponsiveContainer>
                <PieChart>
                  <Pie
                    data={dataPieTop5}
                    cx="50%"
                    cy="50%"
                    outerRadius={90}
                    label
                    dataKey="value"
                  >
                    {COLORS.map((col, i) => (
                      <Cell key={i} fill={col} />
                    ))}
                  </Pie>
                  <Tooltip />
                  <Legend />
                </PieChart>
              </ResponsiveContainer>
            </div>
          </div>
        </section>

        {/* TABLA */}
        <section className="bg-white border border-emerald-200/40 rounded-xl shadow-md">
          <div className="px-4 py-3 border-b bg-emerald-50 rounded-t-xl">
            <h2 className="font-semibold text-emerald-900">Detalle por Usuario</h2>
          </div>

          <div className="overflow-x-auto">
            <table className="min-w-full text-sm">
              <thead className="bg-slate-100">
                <tr>
                  <th className="px-3 py-2 text-left">Usuario</th>
                  <th className="px-3 py-2 text-left">Correo</th>
                  <th className="px-3 py-2 text-right">Actividades</th>
                  <th className="px-3 py-2 text-right">Cr√©ditos</th>
                </tr>
              </thead>
              <tbody>
                {datos.map((a, i) => (
                  <tr key={i} className="border-t">
                    <td className="px-3 py-2">{a.nombre}</td>
                    <td className="px-3 py-2">{a.correo}</td>
                    <td className="px-3 py-2 text-right">{a.total_actividades}</td>
                    <td className="px-3 py-2 text-right">{a.creditos_otorgados}</td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        </section>
      </div>
    </div>
  );
}
</file>

<file path="frontend/src/pages/ReportesCreditosGeneradosConsumidos.jsx">
// src/pages/ReportesCreditosGenerados.jsx
import React, { useEffect, useMemo, useState } from "react";
import {
  BarChart,
  Bar,
  XAxis,
  YAxis,
  Tooltip,
  ResponsiveContainer,
  PieChart,
  Pie,
  Cell,
  Legend,
} from "recharts";
import { getReporteCreditosGeneradosVsConsumidos } from "../services/api";
import hoja from "../assets/hoja.png";

function hoyISO() {
  return new Date().toISOString().slice(0, 10);
}

function hace30DiasISO() {
  const d = new Date(Date.now() - 30 * 24 * 60 * 60 * 1000);
  return d.toISOString().slice(0, 10);
}

export default function ReportesCreditosGenerados() {
  const [desde, setDesde] = useState(hace30DiasISO());
  const [hasta, setHasta] = useState(hoyISO());
  const [resumen, setResumen] = useState(null);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState("");

  async function cargar() {
    try {
      setLoading(true);
      setError("");
      const res = await getReporteCreditosGeneradosVsConsumidos({
        desde,
        hasta,
      });
      setResumen(res || null);
    } catch (e) {
      console.error(e);
      setError("Error cargando resumen de cr√©ditos");
      setResumen(null);
    } finally {
      setLoading(false);
    }
  }

  useEffect(() => {
    cargar();
  }, []);

  function handleSubmit(e) {
    e.preventDefault();
    cargar();
  }

  // =======================
  // M√âTRICAS DERIVADAS
  // =======================
  const metrics = useMemo(() => {
    if (!resumen) {
      return {
        generados: 0,
        consumidos: 0,
        saldo: 0,
        tasaConsumo: 0,
        estado: "Sin datos",
      };
    }

    const generados = Number(resumen.creditos_generados || 0);
    const consumidos = Number(resumen.creditos_consumidos || 0);
    const saldo = Number(resumen.saldo_neto || generados - consumidos);
    const tasaConsumo =
      generados > 0 ? (consumidos / generados) * 100 : 0;

    let estado = "Equilibrado";
    if (saldo > 0 && tasaConsumo < 70) estado = "Sostenible";
    else if (saldo < 0 || tasaConsumo > 90) estado = "En riesgo";

    return { generados, consumidos, saldo, tasaConsumo, estado };
  }, [resumen]);

  // =======================
  // DATOS PARA GR√ÅFICOS
  // =======================
  const barData = useMemo(() => {
    if (!resumen) return [];
    return [
      { name: "Generados", valor: metrics.generados },
      { name: "Consumidos", valor: metrics.consumidos },
    ];
  }, [resumen, metrics.generados, metrics.consumidos]);

  const pieData = useMemo(() => {
    if (!resumen) return [];
    const total = metrics.generados + metrics.consumidos;
    if (total === 0) return [];
    return [
      { name: "Generados", value: metrics.generados },
      { name: "Consumidos", value: metrics.consumidos },
    ];
  }, [resumen, metrics.generados, metrics.consumidos]);

  const COLORS = ["#047857", "#1e3a8a"];

  return (
    <div
      className="min-h-screen p-8"
      style={{
        background: "linear-gradient(to bottom right, #f0fdf4, #d1fae5)",
        backgroundImage: `url(${hoja})`,
        backgroundRepeat: "no-repeat",
        backgroundPosition: "top right",
        backgroundSize: "160px",
      }}
    >
      <div className="max-w-6xl mx-auto space-y-8">
        {/* HEADER */}
        <header className="flex flex-col md:flex-row justify-between items-start md:items-end gap-6">
          <div className="flex items-center gap-4">
            <div className="w-16 h-16 rounded-full bg-white shadow-md flex items-center justify-center border border-emerald-700/20">
              <img src={hoja} alt="Cr√©ditos verdes" className="w-10 h-10" />
            </div>
            <div>
              <h1 className="text-3xl font-extrabold text-emerald-800 drop-shadow">
                Cr√©ditos generados vs consumidos
              </h1>
              <p className="text-sm text-emerald-700/80">
                Resumen global de cr√©ditos emitidos, gastados y saldo neto en el
                periodo seleccionado.
              </p>
            </div>
          </div>

          <form
            onSubmit={handleSubmit}
            className="flex flex-wrap gap-4 bg-white/70 px-4 py-3 rounded-xl shadow backdrop-blur"
          >
            <div className="flex flex-col text-sm">
              <label className="font-semibold text-emerald-900">Desde</label>
              <input
                type="date"
                value={desde}
                onChange={(e) => setDesde(e.target.value)}
                className="border rounded px-2 py-1 text-sm shadow-sm"
              />
            </div>
            <div className="flex flex-col text-sm">
              <label className="font-semibold text-emerald-900">Hasta</label>
              <input
                type="date"
                value={hasta}
                onChange={(e) => setHasta(e.target.value)}
                className="border rounded px-2 py-1 text-sm shadow-sm"
              />
            </div>
            <button
              type="submit"
              className="bg-emerald-700 hover:bg-emerald-800 text-white px-4 py-2 rounded-lg font-semibold shadow-md"
            >
              {loading ? "Cargando‚Ä¶" : "Actualizar"}
            </button>
          </form>
        </header>

        {error && (
          <div className="bg-red-100 text-red-700 border border-red-300 px-4 py-2 rounded-lg shadow-sm">
            {error}
          </div>
        )}

        {/* M√âTRICAS PRINCIPALES */}
        <section className="grid md:grid-cols-4 gap-6">
          <div className="bg-white shadow-md border border-emerald-200/40 rounded-xl p-4 hover:shadow-lg transition">
            <p className="text-xs font-semibold text-emerald-800 uppercase tracking-wide">
              Cr√©ditos generados
            </p>
            <p className="mt-2 text-3xl font-extrabold text-emerald-900 drop-shadow">
              {metrics.generados}
            </p>
          </div>

          <div className="bg-white shadow-md border border-emerald-200/40 rounded-xl p-4 hover:shadow-lg transition">
            <p className="text-xs font-semibold text-emerald-800 uppercase tracking-wide">
              Cr√©ditos consumidos
            </p>
            <p className="mt-2 text-3xl font-extrabold text-emerald-900 drop-shadow">
              {metrics.consumidos}
            </p>
          </div>

          <div className="bg-white shadow-md border border-emerald-200/40 rounded-xl p-4 hover:shadow-lg transition">
            <p className="text-xs font-semibold text-emerald-800 uppercase tracking-wide">
              Saldo neto
            </p>
            <p className="mt-2 text-3xl font-extrabold text-emerald-900 drop-shadow">
              {metrics.saldo}
            </p>
          </div>

          <div className="bg-white shadow-md border border-emerald-200/40 rounded-xl p-4 hover:shadow-lg transition">
            <p className="text-xs font-semibold text-emerald-800 uppercase tracking-wide">
              Tasa de consumo
            </p>
            <p className="mt-2 text-3xl font-extrabold text-emerald-900 drop-shadow">
              {metrics.tasaConsumo.toFixed(1)}%
            </p>
            <p className="mt-1 text-xs text-emerald-700/80">
              Estado:{" "}
              <span className="font-semibold">
                {metrics.estado}
              </span>
            </p>
          </div>
        </section>

        {/* DASHBOARDS */}
        <section className="grid lg:grid-cols-2 gap-6">
          {/* BARRAS */}
          <div className="bg-white rounded-xl border border-emerald-200/40 shadow p-4">
            <h2 className="text-lg font-bold text-emerald-800 mb-2">
              Comparaci√≥n de cr√©ditos
            </h2>
            <p className="text-xs text-emerald-700/80 mb-3">
              Comparaci√≥n directa entre cr√©ditos generados y consumidos.
            </p>
            <div className="h-72">
              {barData.length > 0 ? (
                <ResponsiveContainer>
                  <BarChart data={barData}>
                    <XAxis dataKey="name" />
                    <YAxis allowDecimals={false} />
                    <Tooltip />
                    <Bar dataKey="valor" radius={[8, 8, 0, 0]}>
                      {barData.map((entry, index) => (
                        <Cell
                          key={`cell-${index}`}
                          fill={index === 0 ? COLORS[0] : COLORS[1]}
                        />
                      ))}
                    </Bar>
                  </BarChart>
                </ResponsiveContainer>
              ) : (
                <div className="h-full flex items-center justify-center text-xs text-gray-400">
                  Sin datos para mostrar el gr√°fico.
                </div>
              )}
            </div>
          </div>

          {/* PIE */}
          <div className="bg-white rounded-xl border border-emerald-200/40 shadow p-4">
            <h2 className="text-lg font-bold text-emerald-800 mb-2">
              Distribuci√≥n generados vs consumidos
            </h2>
            <p className="text-xs text-emerald-700/80 mb-3">
              Proporci√≥n de cr√©ditos generados frente a los consumidos.
            </p>
            <div className="h-72">
              {pieData.length > 0 ? (
                <ResponsiveContainer>
                  <PieChart>
                    <Pie
                      data={pieData}
                      cx="50%"
                      cy="50%"
                      outerRadius={90}
                      label
                      dataKey="value"
                    >
                      {pieData.map((entry, index) => (
                        <Cell
                          key={`slice-${index}`}
                          fill={COLORS[index % COLORS.length]}
                        />
                      ))}
                    </Pie>
                    <Tooltip />
                    <Legend />
                  </PieChart>
                </ResponsiveContainer>
              ) : (
                <div className="h-full flex items-center justify-center text-xs text-gray-400">
                  Sin datos para mostrar el gr√°fico.
                </div>
              )}
            </div>
          </div>
        </section>

        {/* RESUMEN DETALLADO */}
        <section className="bg-white border border-emerald-200/40 rounded-xl shadow-md">
          <div className="px-4 py-3 border-b bg-emerald-50 rounded-t-xl">
            <h2 className="font-semibold text-emerald-900">
              Resumen detallado del periodo
            </h2>
          </div>
          <div className="px-4 py-4 text-sm">
            {resumen ? (
              <ul className="space-y-1 text-emerald-900">
                <li>
                  <span className="font-semibold">Cr√©ditos generados:</span>{" "}
                  {metrics.generados}
                </li>
                <li>
                  <span className="font-semibold">Cr√©ditos consumidos:</span>{" "}
                  {metrics.consumidos}
                </li>
                <li>
                  <span className="font-semibold">Saldo neto:</span>{" "}
                  {metrics.saldo}
                </li>
                <li>
                  <span className="font-semibold">Tasa de consumo:</span>{" "}
                  {metrics.tasaConsumo.toFixed(1)}%
                </li>
                <li>
                  <span className="font-semibold">Estado global:</span>{" "}
                  {metrics.estado}
                </li>
              </ul>
            ) : (
              <p className="text-gray-500">
                Sin datos de cr√©ditos generados/consumidos para el rango
                seleccionado.
              </p>
            )}
          </div>
        </section>
      </div>
    </div>
  );
}
</file>

<file path="frontend/src/pages/ReportesDashboard.jsx">
import { useEffect, useState, useMemo } from "react";
import {
  getReporteUsuariosActivos,
  getReporteIngresosCreditos,
  getReporteCreditosGeneradosVsConsumidos,
  getReporteIntercambiosCategoria,
  getReportePublicacionesVsIntercambios,
  getReporteImpactoAcumulado,
} from "../services/api";

import {
  ResponsiveContainer,
  BarChart,
  Bar,
  XAxis,
  YAxis,
  CartesianGrid,
  Tooltip,
  Legend,
} from "recharts";

/* Utilidades */
function hoyISO() {
  return new Date().toISOString().slice(0, 10);
}

function hace30DiasISO() {
  const d = new Date(Date.now() - 30 * 24 * 60 * 60 * 1000);
  return d.toISOString().slice(0, 10);
}

const nf = new Intl.NumberFormat("es-BO");

export default function ReportesDashboard() {
  const [desde, setDesde] = useState(hace30DiasISO());
  const [hasta, setHasta] = useState(hoyISO());

  const [usuariosActivos, setUsuariosActivos] = useState([]);
  const [ingresos, setIngresos] = useState([]);
  const [intercambiosCat, setIntercambiosCat] = useState([]);
  const [pubVsInt, setPubVsInt] = useState([]);
  const [credResumen, setCredResumen] = useState(null);
  const [impacto, setImpacto] = useState([]);

  const [tipoReporte, setTipoReporte] = useState("2"); // mensual
  const [idPeriodo, setIdPeriodo] = useState("1");

  const [loading, setLoading] = useState(false);
  const [loadingImpacto, setLoadingImpacto] = useState(false);
  const [error, setError] = useState("");

/*     Carga de datos*/

  async function cargarDatosBasicos() {
    try {
      setLoading(true);
      setError("");

      const [activos, ing, cgvc, interc, pubInt] = await Promise.all([
        getReporteUsuariosActivos({ desde, hasta }),
        getReporteIngresosCreditos({ desde, hasta }),
        getReporteCreditosGeneradosVsConsumidos({ desde, hasta }),
        getReporteIntercambiosCategoria({ desde, hasta }),
        getReportePublicacionesVsIntercambios({ desde, hasta }),
      ]);

      setUsuariosActivos(Array.isArray(activos) ? activos : []);
      setIngresos(Array.isArray(ing) ? ing : []);
      setIntercambiosCat(Array.isArray(interc) ? interc : []);
      setPubVsInt(Array.isArray(pubInt) ? pubInt : []);
      setCredResumen(cgvc || null);
    } catch (e) {
      console.error(e);
      setError("Error cargando datos de reportes");
      setUsuariosActivos([]);
      setIngresos([]);
      setIntercambiosCat([]);
      setPubVsInt([]);
      setCredResumen(null);
    } finally {
      setLoading(false);
    }
  }

  async function cargarImpacto() {
    try {
      setLoadingImpacto(true);
      setError("");

      const datos = await getReporteImpactoAcumulado({
        idTipoReporte: tipoReporte,
        idPeriodo,
      });

      setImpacto(Array.isArray(datos) ? datos : []);
    } catch (e) {
      console.error(e);
      setError("Error cargando impacto ambiental");
      setImpacto([]);
    } finally {
      setLoadingImpacto(false);
    }
  }

  function onSubmitRango(e) {
    e.preventDefault();
    cargarDatosBasicos();
  }

  useEffect(() => {
    cargarDatosBasicos();
  }, []);

  /* Datos preparados para gr√°ficos */

  // Ingresos por d√≠a
  const ingresosChartData = useMemo(
    () =>
      ingresos.map((r) => ({
        fecha: r.fecha?.slice(0, 10) || "",
        total_bs: Number(r.total_bs ?? 0),
        total_creditos: Number(r.total_creditos ?? 0),
      })),
    [ingresos]
  );

  // Intercambios por categor√≠a
  const intercambiosChartData = useMemo(
    () =>
      intercambiosCat.map((c) => ({
        categoria: c.categoria,
        total_intercambios: Number(c.total_intercambios ?? 0),
      })),
    [intercambiosCat]
  );

  // Publicaciones vs intercambios
  const pubVsIntChartData = useMemo(
    () =>
      pubVsInt.map((p) => ({
        categoria: p.categoria,
        publicaciones: Number(p.publicaciones ?? 0),
        intercambios: Number(p.intercambios ?? 0),
      })),
    [pubVsInt]
  );

  // Cr√©ditos generados/consumidos/saldo
  const credChartData = useMemo(() => {
    if (!credResumen) return [];
    return [
      {
        nombre: "Generados",
        valor: Number(credResumen.creditos_generados ?? 0),
      },
      {
        nombre: "Consumidos",
        valor: Number(credResumen.creditos_consumidos ?? 0),
      },
      {
        nombre: "Saldo neto",
        valor: Number(credResumen.saldo_neto ?? 0),
      },
    ];
  }, [credResumen]);

  // Impacto ambiental por usuario
  const impactoChartData = useMemo(
    () =>
      impacto.map((r) => ({
        usuario: r.id_usuario ?? "GLOBAL",
        co2: Number(r.total_co2_ahorrado ?? 0),
        agua: Number(r.total_agua_ahorrada ?? 0),
        energia: Number(r.total_energia_ahorrada ?? 0),
      })),
    [impacto]
  );

  return (
    <div className="min-h-screen bg-slate-100 px-4 py-6 lg:px-8">
      {/* HEADER */}
      <header className="mb-6 flex flex-col gap-4 border-b border-slate-200 pb-4 md:flex-row md:items-end md:justify-between">
        <div>
          <h1 className="text-2xl font-semibold text-slate-900">
            Dashboard de reportes
          </h1>
          <p className="mt-1 text-sm text-slate-500">
            Actividad del sistema, cr√©ditos e impacto ambiental.
          </p>
          <p className="mt-1 text-xs text-slate-400">
            Rango seleccionado:{" "}
            <span className="font-medium text-slate-600">{desde}</span> ‚Äì{" "}
            <span className="font-medium text-slate-600">{hasta}</span>
          </p>
        </div>

        <form
          onSubmit={onSubmitRango}
          className="flex flex-wrap items-end gap-3 rounded-lg bg-white px-4 py-3 shadow-sm"
        >
          <div className="flex flex-col text-xs">
            <label className="mb-1 font-medium text-slate-600">Desde</label>
            <input
              type="date"
              value={desde}
              onChange={(e) => setDesde(e.target.value)}
              className="rounded-md border border-slate-300 px-2 py-1 text-sm focus:border-emerald-500 focus:outline-none focus:ring-1 focus:ring-emerald-500"
            />
          </div>

          <div className="flex flex-col text-xs">
            <label className="mb-1 font-medium text-slate-600">Hasta</label>
            <input
              type="date"
              value={hasta}
              onChange={(e) => setHasta(e.target.value)}
              className="rounded-md border border-slate-300 px-2 py-1 text-sm focus:border-emerald-500 focus:outline-none focus:ring-1 focus:ring-emerald-500"
            />
          </div>

          <button
            type="submit"
            className="inline-flex items-center rounded-md bg-emerald-600 px-3 py-1.5 text-sm font-medium text-white shadow-sm hover:bg-emerald-700 focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:ring-offset-1"
          >
            {loading ? "Cargando‚Ä¶" : "Actualizar datos"}
          </button>
        </form>
      </header>

      {error && (
        <div className="mb-4 rounded-md border border-red-200 bg-red-50 px-3 py-2 text-sm text-red-700">
          {error}
        </div>
      )}

      {/* 1) RESUMEN R√ÅPIDO */}
      <section className="mb-6 space-y-2">
        <h2 className="text-sm font-semibold text-slate-800">
          Resumen general
        </h2>
        <div className="grid gap-4 text-sm md:grid-cols-3">
          <div className="rounded-lg border border-slate-200 bg-white p-4 shadow-sm">
            <p className="text-xs font-medium uppercase tracking-wide text-slate-500">
              Usuarios activos
            </p>
            <p className="mt-2 text-3xl font-semibold text-slate-900">
              {nf.format(usuariosActivos.length)}
            </p>
            <p className="mt-2 text-xs text-slate-500">
              Usuarios con actividad en el rango.
            </p>
          </div>

          <div className="rounded-lg border border-slate-200 bg-white p-4 shadow-sm">
            <p className="text-xs font-medium uppercase tracking-wide text-slate-500">
              D√≠as con ingresos
            </p>
            <p className="mt-2 text-3xl font-semibold text-slate-900">
              {nf.format(ingresosChartData.length)}
            </p>
            <p className="mt-2 text-xs text-slate-500">
              D√≠as con ventas de cr√©ditos registradas.
            </p>
          </div>

          <div className="rounded-lg border border-slate-200 bg-white p-4 shadow-sm">
            <p className="text-xs font-medium uppercase tracking-wide text-slate-500">
              Categor√≠as con intercambios
            </p>
            <p className="mt-2 text-3xl font-semibold text-slate-900">
              {nf.format(intercambiosChartData.length)}
            </p>
            <p className="mt-2 text-xs text-slate-500">
              Categor√≠as en las que hubo al menos un intercambio.
            </p>
          </div>
        </div>
      </section>

      {/* 2) INGRESOS POR D√çA */}
      <section className="mb-6 space-y-2">
        <div>
          <h2 className="text-sm font-semibold text-slate-800">
            Ingresos por venta de cr√©ditos
          </h2>
          <p className="text-xs text-slate-500">
            Monto total diario en bolivianos.
          </p>
        </div>

        <div className="h-80 w-full rounded-lg border border-slate-200 bg-white p-4 shadow-sm">
          {ingresosChartData.length > 0 ? (
            <ResponsiveContainer width="100%" height="100%">
              <BarChart
                data={ingresosChartData}
                margin={{ top: 12, right: 16, left: 0, bottom: 8 }}
              >
                <CartesianGrid strokeDasharray="3 3" stroke="#e5e7eb" />
                <XAxis
                  dataKey="fecha"
                  tick={{ fontSize: 11, fill: "#6b7280" }}
                  tickLine={false}
                />
                <YAxis
                  tick={{ fontSize: 11, fill: "#6b7280" }}
                  tickLine={false}
                />
                <Tooltip />
                <Legend />
                <Bar
                  dataKey="total_bs"
                  name="Monto (Bs)"
                  fill="#22c55e"
                  radius={[6, 6, 0, 0]}
                  barSize={30}
                />
              </BarChart>
            </ResponsiveContainer>
          ) : (
            <div className="flex h-full w-full items-center justify-center text-xs text-slate-400">
              Sin datos de ingresos en el rango.
            </div>
          )}
        </div>
      </section>

      {/* 3) CR√âDITOS GENERADOS / CONSUMIDOS */}
      <section className="mb-6 space-y-2">
        <div>
          <h2 className="text-sm font-semibold text-slate-800">
            Cr√©ditos generados vs consumidos
          </h2>
          <p className="text-xs text-slate-500">
            Resumen global de cr√©ditos y saldo neto.
          </p>
        </div>

        <div className="h-80 w-full rounded-lg border border-slate-200 bg-white p-4 shadow-sm">
          {credChartData.length > 0 ? (
            <ResponsiveContainer width="100%" height="100%">
              <BarChart
                data={credChartData}
                margin={{ top: 12, right: 16, left: 0, bottom: 8 }}
              >
                <CartesianGrid strokeDasharray="3 3" stroke="#e5e7eb" />
                <XAxis
                  dataKey="nombre"
                  tick={{ fontSize: 11, fill: "#6b7280" }}
                  tickLine={false}
                />
                <YAxis
                  tick={{ fontSize: 11, fill: "#6b7280" }}
                  tickLine={false}
                />
                <Tooltip />
                <Bar
                  dataKey="valor"
                  name="Cr√©ditos"
                  fill="#22c55e"
                  radius={[6, 6, 0, 0]}
                  barSize={40}
                />
              </BarChart>
            </ResponsiveContainer>
          ) : (
            <div className="flex h-full w-full items-center justify-center text-xs text-slate-400">
              Sin datos de cr√©ditos para el rango.
            </div>
          )}
        </div>
      </section>

      {/* 4) INTERCAMBIOS POR CATEGOR√çA */}
      <section className="mb-6 space-y-2">
        <div>
          <h2 className="text-sm font-semibold text-slate-800">
            Intercambios por categor√≠a
          </h2>
          <p className="text-xs text-slate-500">
            Total de intercambios registrados por categor√≠a.
          </p>
        </div>

        <div className="h-80 w-full rounded-lg border border-slate-200 bg-white p-4 shadow-sm">
          {intercambiosChartData.length > 0 ? (
            <ResponsiveContainer width="100%" height="100%">
              <BarChart
                data={intercambiosChartData}
                margin={{ top: 12, right: 16, left: 0, bottom: 40 }}
              >
                <CartesianGrid strokeDasharray="3 3" stroke="#e5e7eb" />
                <XAxis
                  dataKey="categoria"
                  tick={{ fontSize: 10, fill: "#6b7280" }}
                  tickLine={false}
                  interval={0}
                  angle={-20}
                  textAnchor="end"
                  height={50}
                />
                <YAxis
                  tick={{ fontSize: 11, fill: "#6b7280" }}
                  tickLine={false}
                />
                <Tooltip />
                <Bar
                  dataKey="total_intercambios"
                  name="Intercambios"
                  fill="#22c55e"
                  radius={[6, 6, 0, 0]}
                  barSize={30}
                />
              </BarChart>
            </ResponsiveContainer>
          ) : (
            <div className="flex h-full w-full items-center justify-center text-xs text-slate-400">
              No hay intercambios en el rango.
            </div>
          )}
        </div>
      </section>

      {/* 5) PUBLICACIONES VS INTERCAMBIOS */}
      <section className="mb-6 space-y-2">
        <div>
          <h2 className="text-sm font-semibold text-slate-800">
            Publicaciones vs intercambios
          </h2>
          <p className="text-xs text-slate-500">
            Comparaci√≥n por categor√≠a entre publicaciones e intercambios.
          </p>
        </div>

        <div className="h-80 w-full rounded-lg border border-slate-200 bg-white p-4 shadow-sm">
          {pubVsIntChartData.length > 0 ? (
            <ResponsiveContainer width="100%" height="100%">
              <BarChart
                data={pubVsIntChartData}
                margin={{ top: 12, right: 16, left: 0, bottom: 40 }}
              >
                <CartesianGrid strokeDasharray="3 3" stroke="#e5e7eb" />
                <XAxis
                  dataKey="categoria"
                  tick={{ fontSize: 10, fill: "#6b7280" }}
                  tickLine={false}
                  interval={0}
                  angle={-20}
                  textAnchor="end"
                  height={50}
                />
                <YAxis
                  tick={{ fontSize: 11, fill: "#6b7280" }}
                  tickLine={false}
                />
                <Tooltip />
                <Legend />
                <Bar
                  dataKey="publicaciones"
                  name="Publicaciones"
                  fill="#22c55e"
                  radius={[6, 6, 0, 0]}
                  barSize={26}
                />
                <Bar
                  dataKey="intercambios"
                  name="Intercambios"
                  fill="#16a34a"
                  radius={[6, 6, 0, 0]}
                  barSize={26}
                />
              </BarChart>
            </ResponsiveContainer>
          ) : (
            <div className="flex h-full w-full items-center justify-center text-xs text-slate-400">
              Sin datos de publicaciones/intercambios.
            </div>
          )}
        </div>
      </section>

      {/* 6) IMPACTO AMBIENTAL */}
      <section className="mb-2 space-y-3">
        <div className="flex flex-col gap-3 md:flex-row md:items-end md:justify-between">
          <div>
            <h2 className="text-sm font-semibold text-slate-800">
              Impacto ambiental acumulado
            </h2>
            <p className="text-xs text-slate-500">
              CO‚ÇÇ ahorrado por usuario seg√∫n el per√≠odo seleccionado.
            </p>
          </div>

          <div className="flex flex-wrap items-end gap-3 rounded-lg bg-white px-4 py-3 text-sm shadow-sm">
            <div className="flex flex-col">
              <label className="mb-1 text-xs font-medium text-slate-600">
                Tipo de per√≠odo
              </label>
              <select
                value={tipoReporte}
                onChange={(e) => setTipoReporte(e.target.value)}
                className="w-32 rounded-md border border-slate-300 px-2 py-1 text-sm focus:border-emerald-500 focus:outline-none focus:ring-1 focus:ring-emerald-500"
              >
                <option value="1">Diario</option>
                <option value="2">Mensual</option>
                <option value="3">Anual</option>
              </select>
            </div>

            <div className="flex flex-col">
              <label className="mb-1 text-xs font-medium text-slate-600">
                ID per√≠odo
              </label>
              <input
                type="number"
                min="1"
                value={idPeriodo}
                onChange={(e) => setIdPeriodo(e.target.value)}
                className="w-24 rounded-md border border-slate-300 px-2 py-1 text-sm focus:border-emerald-500 focus:outline-none focus:ring-1 focus:ring-emerald-500"
              />
            </div>

            <button
              type="button"
              onClick={cargarImpacto}
              className="inline-flex items-center rounded-md bg-emerald-600 px-3 py-1.5 text-sm font-medium text-white shadow-sm hover:bg-emerald-700 focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:ring-offset-1"
            >
              {loadingImpacto ? "Cargando‚Ä¶" : "Actualizar"}
            </button>
          </div>
        </div>

        <div className="h-80 w-full rounded-lg border border-slate-200 bg-white p-4 shadow-sm">
          {impactoChartData.length > 0 ? (
            <ResponsiveContainer width="100%" height="100%">
              <BarChart
                data={impactoChartData}
                margin={{ top: 12, right: 16, left: 0, bottom: 8 }}
              >
                <CartesianGrid strokeDasharray="3 3" stroke="#e5e7eb" />
                <XAxis
                  dataKey="usuario"
                  tick={{ fontSize: 10, fill: "#6b7280" }}
                  tickLine={false}
                />
                <YAxis
                  tick={{ fontSize: 11, fill: "#6b7280" }}
                  tickLine={false}
                />
                <Tooltip />
                <Legend />
                <Bar
                  dataKey="co2"
                  name="CO‚ÇÇ (kg)"
                  fill="#22c55e"
                  radius={[6, 6, 0, 0]}
                  barSize={30}
                />
                
                <Bar dataKey="agua" name="Agua (L)" fill="#0ea5e9" radius={[6,6,0,0]} />
                <Bar dataKey="energia" name="Energ√≠a (kWh)" fill="#eab308" radius={[6,6,0,0]} />
                
              </BarChart>
            </ResponsiveContainer>
          ) : (
            <div className="flex h-full w-full items-center justify-center text-xs text-slate-400">
              Sin datos de impacto para ese per√≠odo.
            </div>
          )}
        </div>
      </section>
    </div>
  );
}
</file>

<file path="frontend/src/pages/ReportesImpactoAcumulado.jsx">
// src/pages/ReportesImpactoAcumulado.jsx
import React, { useMemo, useState } from "react";
import { getReporteImpactoAcumulado } from "../services/api";
import {
  BarChart,
  Bar,
  XAxis,
  YAxis,
  Tooltip,
  ResponsiveContainer,
  PieChart,
  Pie,
  Legend,
  Cell,
} from "recharts";
import hoja from "../assets/hoja.png";

export default function ReportesImpactoAcumulado() {
  const [tipoReporte, setTipoReporte] = useState("1"); // 1=Mensual
  const [idPeriodo, setIdPeriodo] = useState("1");
  const [datos, setDatos] = useState([]);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState("");

  async function cargar() {
    try {
      setLoading(true);
      setError("");
      const res = await getReporteImpactoAcumulado({
        idTipoReporte: tipoReporte,
        idPeriodo,
      });
      setDatos(Array.isArray(res) ? res : []);
    } catch (e) {
      console.error(e);
      setError("Error cargando impacto acumulado");
      setDatos([]);
    } finally {
      setLoading(false);
    }
  }

  // ===============================
  // M√âTRICAS GLOBALES
  // ===============================
  const metrics = useMemo(() => {
    if (!datos.length) {
      return {
        co2: 0,
        agua: 0,
        energia: 0,
        transacciones: 0,
        usuariosActivos: 0,
      };
    }

    // Sumatoria global
    const total = datos.reduce(
      (acc, r) => {
        acc.co2 += Number(r.total_co2_ahorrado || 0);
        acc.agua += Number(r.total_agua_ahorrada || 0);
        acc.energia += Number(r.total_energia_ahorrada || 0);
        acc.transacciones += Number(r.total_transacciones || 0);
        acc.usuariosActivos += Number(r.total_usuarios_activos || 0);
        return acc;
      },
      { co2: 0, agua: 0, energia: 0, transacciones: 0, usuariosActivos: 0 }
    );

    return total;
  }, [datos]);

  // ===============================
  // GR√ÅFICOS
  // ===============================
  const barDatos = [
    { name: "CO‚ÇÇ (kg)", valor: metrics.co2 },
    { name: "Agua (L)", valor: metrics.agua },
    { name: "Energ√≠a (kWh)", valor: metrics.energia },
  ];

  const pieDatos = [
    { name: "CO‚ÇÇ", value: metrics.co2 },
    { name: "Agua", value: metrics.agua },
    { name: "Energ√≠a", value: metrics.energia },
  ];

  const COLORS = ["#047857", "#1e3a8a", "#0d9488"];

  // ===============================
  // UI
  // ===============================
  return (
    <div
      className="min-h-screen p-8"
      style={{
        background: "linear-gradient(to bottom right, #f0fdf4, #d1fae5)",
        backgroundImage: `url(${hoja})`,
        backgroundRepeat: "no-repeat",
        backgroundPosition: "top right",
        backgroundSize: "160px",
      }}
    >
      <div className="max-w-6xl mx-auto space-y-8">
        {/* HEADER */}
        <header className="flex flex-col md:flex-row justify-between items-start md:items-end gap-6">
          <div className="flex items-center gap-4">
            <div className="w-16 h-16 rounded-full bg-white shadow-md flex items-center justify-center border border-emerald-700/20">
              <img src={hoja} alt="Hoja" className="w-10 h-10" />
            </div>
            <div>
              <h1 className="text-3xl font-extrabold text-emerald-800 drop-shadow">
                Impacto ambiental acumulado
              </h1>
              <p className="text-sm text-emerald-700/80">
                Datos provenientes de la tabla REPORTE_IMPACTO seg√∫n per√≠odo.
              </p>
            </div>
          </div>

          <div className="flex flex-wrap gap-4 bg-white/70 px-4 py-3 rounded-xl shadow backdrop-blur text-sm">
            <div className="flex flex-col">
              <label className="font-semibold text-emerald-900">
                Tipo de reporte
              </label>
              <select
                value={tipoReporte}
                onChange={(e) => setTipoReporte(e.target.value)}
                className="border rounded px-2 py-1 text-sm shadow-sm"
              >
                <option value="1">Mensual</option>
                <option value="2">Diario</option>
                <option value="3">Anual</option>
              </select>
            </div>

            <div className="flex flex-col">
              <label className="font-semibold text-emerald-900">
                ID per√≠odo
              </label>
              <input
                type="number"
                min="1"
                value={idPeriodo}
                onChange={(e) => setIdPeriodo(e.target.value)}
                className="border rounded px-2 py-1 text-sm shadow-sm w-24"
              />
            </div>

            <button
              onClick={cargar}
              className="bg-emerald-700 hover:bg-emerald-800 text-white px-4 py-2 rounded-lg font-semibold shadow-md"
            >
              {loading ? "Cargando‚Ä¶" : "Actualizar"}
            </button>
          </div>
        </header>

        {error && (
          <div className="bg-red-100 text-red-700 border border-red-300 px-4 py-2 rounded-lg shadow-sm">
            {error}
          </div>
        )}

        {/* M√âTRICAS PRINCIPALES */}
        <section className="grid md:grid-cols-5 gap-6">
          <div className="bg-white shadow-md border border-emerald-200/40 rounded-xl p-4">
            <p className="text-xs uppercase font-semibold text-emerald-700">
              CO‚ÇÇ Ahorrado
            </p>
            <p className="text-3xl font-extrabold text-emerald-900 mt-2">
              {metrics.co2.toLocaleString()}
            </p>
          </div>

          <div className="bg-white shadow-md border border-emerald-200/40 rounded-xl p-4">
            <p className="text-xs uppercase font-semibold text-blue-700">
              Agua Ahorrada
            </p>
            <p className="text-3xl font-extrabold text-blue-900 mt-2">
              {metrics.agua.toLocaleString()}
            </p>
          </div>

          <div className="bg-white shadow-md border border-emerald-200/40 rounded-xl p-4">
            <p className="text-xs uppercase font-semibold text-teal-700">
              Energ√≠a Ahorrada
            </p>
            <p className="text-3xl font-extrabold text-teal-900 mt-2">
              {metrics.energia.toLocaleString()}
            </p>
          </div>

          <div className="bg-white shadow-md border border-emerald-200/40 rounded-xl p-4">
            <p className="text-xs uppercase font-semibold text-slate-700">
              Transacciones
            </p>
            <p className="text-3xl font-extrabold text-slate-900 mt-2">
              {metrics.transacciones.toLocaleString()}
            </p>
          </div>

          <div className="bg-white shadow-md border border-emerald-200/40 rounded-xl p-4">
            <p className="text-xs uppercase font-semibold text-emerald-700">
              Usuarios activos
            </p>
            <p className="text-3xl font-extrabold text-emerald-900 mt-2">
              {metrics.usuariosActivos.toLocaleString()}
            </p>
          </div>
        </section>

        {/* GR√ÅFICOS */}
        <section className="grid lg:grid-cols-2 gap-6">
          {/* BARRAS */}
          <div className="bg-white rounded-xl shadow border border-emerald-200/40 p-4">
            <h2 className="text-lg font-semibold text-emerald-900 mb-2">
              Impacto ambiental (acumulado)
            </h2>
            <p className="text-xs mb-3 text-emerald-700/80">
              Comparaci√≥n total entre CO‚ÇÇ, Agua y Energ√≠a ahorrados.
            </p>

            <div className="h-72">
              <ResponsiveContainer>
                <BarChart data={barDatos}>
                  <XAxis dataKey="name" />
                  <YAxis allowDecimals={false} />
                  <Tooltip />
                  <Bar dataKey="valor" radius={[8, 8, 0, 0]}>
                    {barDatos.map((entry, index) => (
                      <Cell
                        key={index}
                        fill={COLORS[index % COLORS.length]}
                      />
                    ))}
                  </Bar>
                </BarChart>
              </ResponsiveContainer>
            </div>
          </div>

          {/* PIE */}
          <div className="bg-white rounded-xl shadow border border-emerald-200/40 p-4">
            <h2 className="text-lg font-semibold text-emerald-900 mb-2">
              Distribuci√≥n del impacto
            </h2>
            <p className="text-xs mb-3 text-emerald-700/80">
              Proporci√≥n de los distintos tipos de impacto ambiental.
            </p>

            <div className="h-72">
              <ResponsiveContainer>
                <PieChart>
                  <Pie
                    data={pieDatos}
                    cx="50%"
                    cy="50%"
                    outerRadius={90}
                    label
                    dataKey="value"
                  >
                    {pieDatos.map((entry, index) => (
                      <Cell
                        key={`slice-${index}`}
                        fill={COLORS[index % COLORS.length]}
                      />
                    ))}
                  </Pie>
                  <Tooltip />
                  <Legend />
                </PieChart>
              </ResponsiveContainer>
            </div>
          </div>
        </section>

        {/* TABLA DETALLADA */}
        <section className="bg-white shadow border border-emerald-200/40 rounded-xl">
          <div className="px-4 py-3 border-b bg-emerald-50 rounded-t-xl">
            <h2 className="font-semibold text-emerald-900">
              Detalle de impacto por usuario/per√≠odo
            </h2>
          </div>

          <div className="overflow-x-auto">
            <table className="min-w-full text-sm">
              <thead className="bg-slate-100">
                <tr>
                  <th className="px-3 py-2 text-left">Usuario (ID)</th>
                  <th className="px-3 py-2 text-right">CO‚ÇÇ (kg)</th>
                  <th className="px-3 py-2 text-right">Agua (L)</th>
                  <th className="px-3 py-2 text-right">Energ√≠a (kWh)</th>
                  <th className="px-3 py-2 text-right">Transacciones</th>
                  <th className="px-3 py-2 text-right">Usuarios activos</th>
                </tr>
              </thead>

              <tbody>
                {datos.map((r, i) => (
                  <tr key={i} className="border-t">
                    <td className="px-3 py-2">{r.id_usuario ?? "GLOBAL"}</td>
                    <td className="px-3 py-2 text-right">
                      {r.total_co2_ahorrado}
                    </td>
                    <td className="px-3 py-2 text-right">
                      {r.total_agua_ahorrada}
                    </td>
                    <td className="px-3 py-2 text-right">
                      {r.total_energia_ahorrada}
                    </td>
                    <td className="px-3 py-2 text-right">
                      {r.total_transacciones}
                    </td>
                    <td className="px-3 py-2 text-right">
                      {r.total_usuarios_activos}
                    </td>
                  </tr>
                ))}

                {datos.length === 0 && (
                  <tr>
                    <td
                      className="px-3 py-4 text-center text-gray-400"
                      colSpan={6}
                    >
                      Sin datos en REPORTE_IMPACTO para ese per√≠odo.
                    </td>
                  </tr>
                )}
              </tbody>
            </table>
          </div>
        </section>
      </div>
    </div>
  );
}
</file>

<file path="frontend/src/pages/ReportesImpactoCategoria.jsx">
// src/pages/ReportesImpactoCategoria.jsx
import React, { useMemo, useState } from "react";
import { getReporteImpactoPorCategoria } from "../services/api";
import {
  BarChart,
  Bar,
  XAxis,
  YAxis,
  Tooltip,
  ResponsiveContainer,
  PieChart,
  Pie,
  Legend,
  Cell,
} from "recharts";
import hoja from "../assets/hoja.png";

export default function ReportesImpactoCategoria() {
  const [idPeriodo, setIdPeriodo] = useState("1");
  const [datos, setDatos] = useState([]);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState("");

  async function cargar() {
    try {
      setLoading(true);
      setError("");
      const res = await getReporteImpactoPorCategoria({ idPeriodo });
      setDatos(Array.isArray(res) ? res : []);
    } catch (e) {
      console.error(e);
      setError("Error cargando impacto por categor√≠a");
      setDatos([]);
    } finally {
      setLoading(false);
    }
  }

  // =========================
  // M√âTRICAS GLOBALES
  // =========================
  const metrics = useMemo(() => {
    if (!datos.length) {
      return {
        totalCo2: 0,
        totalAgua: 0,
        totalEnergia: 0,
        categorias: 0,
        topCategoria: null,
      };
    }

    const totalCo2 = datos.reduce(
      (acc, c) => acc + Number(c.co2_total || 0),
      0
    );
    const totalAgua = datos.reduce(
      (acc, c) => acc + Number(c.agua_total || 0),
      0
    );
    const totalEnergia = datos.reduce(
      (acc, c) => acc + Number(c.energia_total || 0),
      0
    );
    const categorias = datos.length;

    const topCategoria = datos.reduce(
      (best, c) =>
        Number(c.co2_total || 0) +
          Number(c.agua_total || 0) +
          Number(c.energia_total || 0) >
        (Number(best?.co2_total || 0) +
          Number(best?.agua_total || 0) +
          Number(best?.energia_total || 0))
          ? c
          : best,
      null
    );

    return { totalCo2, totalAgua, totalEnergia, categorias, topCategoria };
  }, [datos]);

  // =========================
  // DATOS PARA GR√ÅFICOS
  // =========================
  const barData = useMemo(
    () =>
      datos.map((c) => ({
        categoria: c.categoria,
        co2: Number(c.co2_total || 0),
        agua: Number(c.agua_total || 0),
        energia: Number(c.energia_total || 0),
      })),
    [datos]
  );

  const pieData = useMemo(() => {
    if (!datos.length) return [];
    return datos.map((c) => ({
      name: c.categoria,
      value:
        Number(c.co2_total || 0) +
        Number(c.agua_total || 0) +
        Number(c.energia_total || 0),
    }));
  }, [datos]);

  const COLORS = ["#047857", "#1e3a8a", "#0d9488", "#6d28d9", "#f59e0b"];

  return (
    <div
      className="min-h-screen p-8"
      style={{
        background: "linear-gradient(to bottom right, #f0fdf4, #d1fae5)",
        backgroundImage: `url(${hoja})`,
        backgroundRepeat: "no-repeat",
        backgroundPosition: "top right",
        backgroundSize: "160px",
      }}
    >
      <div className="max-w-6xl mx-auto space-y-8">
        {/* HEADER */}
        <header className="flex flex-col md:flex-row md:items-end md:justify-between gap-6">
          <div className="flex items-center gap-4">
            <div className="w-16 h-16 rounded-full bg-white shadow-md flex items-center justify-center border border-emerald-700/20">
              <img src={hoja} alt="Hoja" className="w-10 h-10" />
            </div>
            <div>
              <h1 className="text-3xl font-extrabold text-emerald-800 drop-shadow">
                Impacto ambiental por categor√≠a
              </h1>
              <p className="text-sm text-emerald-700/80">
                Suma de CO‚ÇÇ, agua y energ√≠a ahorrada por cada categor√≠a
                (IMPACTO_AMBIENTAL).
              </p>
            </div>
          </div>

          <div className="flex flex-wrap gap-4 items-end text-sm bg-white/70 px-4 py-3 rounded-xl shadow backdrop-blur">
            <div className="flex flex-col">
              <label className="mb-1 font-semibold text-emerald-900">
                ID per√≠odo
              </label>
              <input
                type="number"
                min="1"
                value={idPeriodo}
                onChange={(e) => setIdPeriodo(e.target.value)}
                className="border rounded px-2 py-1 text-sm w-24 shadow-sm"
              />
            </div>
            <button
              type="button"
              onClick={cargar}
              className="bg-emerald-700 hover:bg-emerald-800 text-white px-4 py-2 rounded-lg text-sm font-semibold shadow-md"
            >
              {loading ? "Cargando‚Ä¶" : "Actualizar"}
            </button>
          </div>
        </header>

        {error && (
          <div className="bg-red-100 border border-red-300 text-red-700 text-sm px-4 py-2 rounded-lg shadow-sm">
            {error}
          </div>
        )}

        {/* KPIs */}
        <section className="grid md:grid-cols-4 gap-6">
          <div className="bg-white shadow-md border border-emerald-200/40 rounded-xl p-4">
            <p className="text-xs font-semibold text-emerald-700 uppercase">
              CO‚ÇÇ total (kg)
            </p>
            <p className="mt-2 text-3xl font-extrabold text-emerald-900">
              {metrics.totalCo2.toLocaleString()}
            </p>
          </div>

          <div className="bg-white shadow-md border border-blue-200/60 rounded-xl p-4">
            <p className="text-xs font-semibold text-blue-700 uppercase">
              Agua total (L)
            </p>
            <p className="mt-2 text-3xl font-extrabold text-blue-900">
              {metrics.totalAgua.toLocaleString()}
            </p>
          </div>

          <div className="bg-white shadow-md border border-teal-200/60 rounded-xl p-4">
            <p className="text-xs font-semibold text-teal-700 uppercase">
              Energ√≠a total (kWh)
            </p>
            <p className="mt-2 text-3xl font-extrabold text-teal-900">
              {metrics.totalEnergia.toLocaleString()}
            </p>
          </div>

          <div className="bg-white shadow-md border border-emerald-200/40 rounded-xl p-4">
            <p className="text-xs font-semibold text-slate-700 uppercase">
              Categor√≠as registradas
            </p>
            <p className="mt-2 text-3xl font-extrabold text-slate-900">
              {metrics.categorias}
            </p>
            {metrics.topCategoria && (
              <p className="mt-1 text-[11px] text-emerald-700/80">
                Mayor impacto:{" "}
                <span className="font-semibold">
                  {metrics.topCategoria.categoria}
                </span>
              </p>
            )}
          </div>
        </section>

        {/* GR√ÅFICOS */}
        <section className="grid lg:grid-cols-2 gap-6">
          {/* Barras */}
          <div className="bg-white rounded-xl border border-emerald-200/40 shadow p-4">
            <h2 className="text-lg font-semibold text-emerald-900 mb-2">
              Impacto por categor√≠a (CO‚ÇÇ, Agua, Energ√≠a)
            </h2>
            <p className="text-xs text-emerald-700/80 mb-3">
              Comparaci√≥n de indicadores ambientales por categor√≠a.
            </p>

            <div className="h-72">
              {barData.length > 0 ? (
                <ResponsiveContainer>
                  <BarChart data={barData}>
                    <XAxis dataKey="categoria" hide />
                    <YAxis />
                    <Tooltip />
                    <Legend />
                    <Bar dataKey="co2" name="CO‚ÇÇ (kg)" fill="#047857" />
                    <Bar dataKey="agua" name="Agua (L)" fill="#1e3a8a" />
                    <Bar dataKey="energia" name="Energ√≠a (kWh)" fill="#0d9488" />
                  </BarChart>
                </ResponsiveContainer>
              ) : (
                <div className="h-full flex items-center justify-center text-xs text-gray-400">
                  Sin datos para mostrar el gr√°fico.
                </div>
              )}
            </div>
          </div>

          {/* Pie */}
          <div className="bg-white rounded-xl border border-emerald-200/40 shadow p-4">
            <h2 className="text-lg font-semibold text-emerald-900 mb-2">
              Distribuci√≥n de impacto por categor√≠a
            </h2>
            <p className="text-xs text-emerald-700/80 mb-3">
              Proporci√≥n del impacto ambiental total por categor√≠a (CO‚ÇÇ + Agua +
              Energ√≠a).
            </p>

            <div className="h-72">
              {pieData.length > 0 ? (
                <ResponsiveContainer>
                  <PieChart>
                    <Pie
                      data={pieData}
                      cx="50%"
                      cy="50%"
                      outerRadius={90}
                      label
                      dataKey="value"
                    >
                      {pieData.map((entry, index) => (
                        <Cell
                          key={`slice-${index}`}
                          fill={COLORS[index % COLORS.length]}
                        />
                      ))}
                    </Pie>
                    <Tooltip />
                    <Legend />
                  </PieChart>
                </ResponsiveContainer>
              ) : (
                <div className="h-full flex items-center justify-center text-xs text-gray-400">
                  Sin datos para mostrar el gr√°fico.
                </div>
              )}
            </div>
          </div>
        </section>

        {/* TABLA DETALLADA */}
        <section className="bg-white border border-emerald-200/40 rounded-xl shadow">
          <div className="px-4 py-3 border-b bg-emerald-50 rounded-t-xl">
            <h2 className="font-semibold text-emerald-900">
              Detalle de impacto por categor√≠a
            </h2>
          </div>

          <div className="overflow-x-auto">
            <table className="min-w-full text-sm">
              <thead className="bg-slate-100">
                <tr>
                  <th className="px-3 py-2 text-left">Categor√≠a</th>
                  <th className="px-3 py-2 text-right">CO‚ÇÇ total (kg)</th>
                  <th className="px-3 py-2 text-right">Agua total (L)</th>
                  <th className="px-3 py-2 text-right">Energ√≠a total (kWh)</th>
                </tr>
              </thead>
              <tbody>
                {datos.map((c, i) => (
                  <tr key={i} className="border-t">
                    <td className="px-3 py-2">{c.categoria}</td>
                    <td className="px-3 py-2 text-right">
                      {c.co2_total}
                    </td>
                    <td className="px-3 py-2 text-right">
                      {c.agua_total}
                    </td>
                    <td className="px-3 py-2 text-right">
                      {c.energia_total}
                    </td>
                  </tr>
                ))}
                {datos.length === 0 && (
                  <tr>
                    <td
                      className="px-3 py-4 text-center text-gray-400"
                      colSpan={4}
                    >
                      Sin impacto registrado para ese per√≠odo.
                    </td>
                  </tr>
                )}
              </tbody>
            </table>
          </div>
        </section>
      </div>
    </div>
  );
}
</file>

<file path="frontend/src/pages/ReportesIngresosCreditos.jsx">
// src/pages/ReportesIngresosCreditos.jsx
import React, { useEffect, useMemo, useState } from "react";
import { getReporteIngresosCreditos } from "../services/api";
import {
  BarChart,
  Bar,
  XAxis,
  YAxis,
  Tooltip,
  ResponsiveContainer,
  LineChart,
  Line,
  Legend,
} from "recharts";
import hoja from "../assets/hoja.png";

function hoyISO() {
  return new Date().toISOString().slice(0, 10);
}

function hace30DiasISO() {
  const d = new Date(Date.now() - 30 * 24 * 60 * 60 * 1000);
  return d.toISOString().slice(0, 10);
}

export default function ReportesIngresosCreditos() {
  const [desde, setDesde] = useState(hace30DiasISO());
  const [hasta, setHasta] = useState(hoyISO());
  const [datos, setDatos] = useState([]);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState("");

  async function cargar() {
    try {
      setLoading(true);
      setError("");
      const res = await getReporteIngresosCreditos({ desde, hasta });
      setDatos(Array.isArray(res) ? res : []);
    } catch (e) {
      console.error(e);
      setError("Error cargando ingresos por cr√©ditos");
      setDatos([]);
    } finally {
      setLoading(false);
    }
  }

  useEffect(() => {
    cargar();
  }, []);

  function handleSubmit(e) {
    e.preventDefault();
    cargar();
  }

  // =========================
  // M√âTRICAS
  // =========================
  const metrics = useMemo(() => {
    if (!datos.length) {
      return {
        totalCreditos: 0,
        totalBs: 0,
        diasConVentas: 0,
        promedioTicket: 0,
      };
    }

    const totalCreditos = datos.reduce(
      (acc, r) => acc + Number(r.total_creditos || 0),
      0
    );
    const totalBs = datos.reduce(
      (acc, r) => acc + Number(r.total_bs || 0),
      0
    );
    const diasConVentas = datos.filter(
      (r) => Number(r.total_bs || 0) > 0
    ).length;
    const promedioTicket =
      diasConVentas > 0 ? totalBs / diasConVentas : 0;

    return { totalCreditos, totalBs, diasConVentas, promedioTicket };
  }, [datos]);

  // =========================
  // DATOS GR√ÅFICOS
  // =========================
  const chartData = useMemo(
    () =>
      datos.map((r) => ({
        fecha: r.fecha,
        creditos: Number(r.total_creditos || 0),
        monto: Number(r.total_bs || 0),
      })),
    [datos]
  );

  return (
    <div
      className="min-h-screen p-8"
      style={{
        background: "linear-gradient(to bottom right, #f0fdf4, #d1fae5)",
        backgroundImage: `url(${hoja})`,
        backgroundRepeat: "no-repeat",
        backgroundPosition: "top right",
        backgroundSize: "160px",
      }}
    >
      <div className="max-w-6xl mx-auto space-y-8">
        {/* HEADER */}
        <header className="flex flex-col md:flex-row md:items-end md:justify-between gap-6">
          <div className="flex items-center gap-4">
            <div className="w-16 h-16 rounded-full bg-white shadow-md flex items-center justify-center border border-emerald-700/20">
              <img src={hoja} alt="Cr√©ditos verdes" className="w-10 h-10" />
            </div>
            <div>
              <h1 className="text-3xl font-extrabold text-emerald-800 drop-shadow">
                Ingresos por venta de cr√©ditos
              </h1>
              <p className="text-sm text-emerald-700/80">
                Cr√©ditos vendidos y monto recaudado por d√≠a en el rango
                seleccionado.
              </p>
            </div>
          </div>

          <form
            onSubmit={handleSubmit}
            className="flex flex-wrap gap-4 items-end bg-white/70 px-4 py-3 rounded-xl shadow backdrop-blur text-sm"
          >
            <div className="flex flex-col">
              <label className="mb-1 font-semibold text-emerald-900">
                Desde
              </label>
              <input
                type="date"
                value={desde}
                onChange={(e) => setDesde(e.target.value)}
                className="border rounded px-2 py-1 text-sm shadow-sm"
              />
            </div>
            <div className="flex flex-col">
              <label className="mb-1 font-semibold text-emerald-900">
                Hasta
              </label>
              <input
                type="date"
                value={hasta}
                onChange={(e) => setHasta(e.target.value)}
                className="border rounded px-2 py-1 text-sm shadow-sm"
              />
            </div>
            <button
              type="submit"
              className="bg-emerald-700 hover:bg-emerald-800 text-white px-4 py-2 rounded-lg font-semibold shadow-md"
            >
              {loading ? "Cargando‚Ä¶" : "Actualizar"}
            </button>
          </form>
        </header>

        {error && (
          <div className="bg-red-100 border border-red-300 text-red-700 text-sm px-4 py-2 rounded-lg shadow-sm">
            {error}
          </div>
        )}

        {/* KPIs */}
        <section className="grid md:grid-cols-4 gap-6">
          <div className="bg-white shadow-md border border-emerald-200/40 rounded-xl p-4">
            <p className="text-xs font-semibold text-emerald-700 uppercase">
              Cr√©ditos vendidos
            </p>
            <p className="mt-2 text-3xl font-extrabold text-emerald-900">
              {metrics.totalCreditos.toLocaleString()}
            </p>
          </div>

          <div className="bg-white shadow-md border border-blue-200/60 rounded-xl p-4">
            <p className="text-xs font-semibold text-blue-700 uppercase">
              Monto total (Bs)
            </p>
            <p className="mt-2 text-3xl font-extrabold text-blue-900">
              {metrics.totalBs.toLocaleString(undefined, {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2,
              })}
            </p>
          </div>

          <div className="bg-white shadow-md border border-teal-200/60 rounded-xl p-4">
            <p className="text-xs font-semibold text-teal-700 uppercase">
              D√≠as con ventas
            </p>
            <p className="mt-2 text-3xl font-extrabold text-teal-900">
              {metrics.diasConVentas}
            </p>
          </div>

          <div className="bg-white shadow-md border border-emerald-200/40 rounded-xl p-4">
            <p className="text-xs font-semibold text-slate-700 uppercase">
              Ticket promedio (Bs/d√≠a)
            </p>
            <p className="mt-2 text-3xl font-extrabold text-slate-900">
              {metrics.promedioTicket.toLocaleString(undefined, {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2,
              })}
            </p>
          </div>
        </section>

        {/* GR√ÅFICOS */}
        <section className="grid lg:grid-cols-2 gap-6">
          {/* Cr√©ditos por d√≠a (barras) */}
          <div className="bg-white rounded-xl border border-emerald-200/40 shadow p-4">
            <h2 className="text-lg font-semibold text-emerald-900 mb-2">
              Cr√©ditos vendidos por d√≠a
            </h2>
            <p className="text-xs text-emerald-700/80 mb-3">
              Distribuci√≥n de cr√©ditos vendidos en el periodo.
            </p>
            <div className="h-72">
              {chartData.length > 0 ? (
                <ResponsiveContainer>
                  <BarChart data={chartData}>
                    <XAxis dataKey="fecha" hide />
                    <YAxis allowDecimals={false} />
                    <Tooltip />
                    <Bar
                      dataKey="creditos"
                      name="Cr√©ditos"
                      radius={[8, 8, 0, 0]}
                      fill="#047857"
                    />
                  </BarChart>
                </ResponsiveContainer>
              ) : (
                <div className="h-full flex items-center justify-center text-xs text-gray-400">
                  Sin datos para mostrar el gr√°fico.
                </div>
              )}
            </div>
          </div>

          {/* Monto por d√≠a (l√≠nea) */}
          <div className="bg-white rounded-xl border border-emerald-200/40 shadow p-4">
            <h2 className="text-lg font-semibold text-emerald-900 mb-2">
              Monto recaudado por d√≠a
            </h2>
            <p className="text-xs text-emerald-700/80 mb-3">
              Evoluci√≥n del ingreso por ventas de cr√©ditos.
            </p>
            <div className="h-72">
              {chartData.length > 0 ? (
                <ResponsiveContainer>
                  <LineChart data={chartData}>
                    <XAxis dataKey="fecha" hide />
                    <YAxis />
                    <Tooltip />
                    <Legend />
                    <Line
                      type="monotone"
                      dataKey="monto"
                      name="Monto (Bs)"
                      stroke="#1e3a8a"
                      strokeWidth={2}
                      dot={false}
                    />
                  </LineChart>
                </ResponsiveContainer>
              ) : (
                <div className="h-full flex items-center justify-center text-xs text-gray-400">
                  Sin datos para mostrar el gr√°fico.
                </div>
              )}
            </div>
          </div>
        </section>

        {/* TABLA DETALLADA */}
        <section className="bg-white border border-emerald-200/40 rounded-xl shadow">
          <div className="px-4 py-3 border-b bg-emerald-50 rounded-t-xl">
            <h2 className="font-semibold text-emerald-900">
              Detalle diario de ingresos
            </h2>
          </div>

          <div className="overflow-x-auto">
            <table className="min-w-full text-sm">
              <thead className="bg-slate-100">
                <tr>
                  <th className="px-3 py-2 text-left">Fecha</th>
                  <th className="px-3 py-2 text-right">Cr√©ditos</th>
                  <th className="px-3 py-2 text-right">Monto (Bs)</th>
                </tr>
              </thead>
              <tbody>
                {datos.map((r, i) => (
                  <tr key={i} className="border-t">
                    <td className="px-3 py-2">{r.fecha}</td>
                    <td className="px-3 py-2 text-right">
                      {r.total_creditos}
                    </td>
                    <td className="px-3 py-2 text-right">{r.total_bs}</td>
                  </tr>
                ))}
                {datos.length === 0 && (
                  <tr>
                    <td
                      className="px-3 py-4 text-center text-gray-400"
                      colSpan={3}
                    >
                      Sin compras de cr√©ditos en el rango.
                    </td>
                  </tr>
                )}
              </tbody>
            </table>
          </div>
        </section>
      </div>
    </div>
  );
}
</file>

<file path="frontend/src/pages/ReportesIntercambiosCategoria.jsx">
// src/pages/ReportesIntercambiosCategoria.jsx
import React, { useEffect, useMemo, useState } from "react";
import { getReporteIntercambiosCategoria } from "../services/api";
import {
  BarChart,
  Bar,
  XAxis,
  YAxis,
  Tooltip,
  ResponsiveContainer,
  PieChart,
  Pie,
  Legend,
  Cell,
} from "recharts";
import hoja from "../assets/hoja.png";

function hoyISO() {
  return new Date().toISOString().slice(0, 10);
}

function hace30DiasISO() {
  const d = new Date(Date.now() - 30 * 24 * 60 * 60 * 1000);
  return d.toISOString().slice(0, 10);
}

export default function ReportesIntercambiosCategoria() {
  const [desde, setDesde] = useState(hace30DiasISO());
  const [hasta, setHasta] = useState(hoyISO());
  const [datos, setDatos] = useState([]);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState("");

  async function cargar() {
    try {
      setLoading(true);
      setError("");
      const res = await getReporteIntercambiosCategoria({ desde, hasta });
      setDatos(Array.isArray(res) ? res : []);
    } catch (e) {
      console.error(e);
      setError("Error cargando intercambios por categor√≠a");
      setDatos([]);
    } finally {
      setLoading(false);
    }
  }

  useEffect(() => {
    cargar();
  }, []);

  function handleSubmit(e) {
    e.preventDefault();
    cargar();
  }

  // =========================
  // M√âTRICAS
  // =========================
  const metrics = useMemo(() => {
    if (!datos.length) {
      return {
        totalIntercambios: 0,
        categorias: 0,
        promedioPorCategoria: 0,
        topCategoria: null,
      };
    }

    const totalIntercambios = datos.reduce(
      (acc, c) => acc + Number(c.total_intercambios || 0),
      0
    );
    const categorias = datos.length;
    const promedioPorCategoria =
      categorias > 0 ? totalIntercambios / categorias : 0;

    const topCategoria = datos.reduce(
      (best, c) =>
        Number(c.total_intercambios || 0) >
        Number(best?.total_intercambios || 0)
          ? c
          : best,
      null
    );

    return { totalIntercambios, categorias, promedioPorCategoria, topCategoria };
  }, [datos]);

  // =========================
  // DATOS GR√ÅFICOS
  // =========================
  const barData = useMemo(
    () =>
      datos.map((c) => ({
        categoria: c.categoria,
        intercambios: Number(c.total_intercambios || 0),
      })),
    [datos]
  );

  const pieData = useMemo(
    () =>
      datos.map((c) => ({
        name: c.categoria,
        value: Number(c.total_intercambios || 0),
      })),
    [datos]
  );

  const COLORS = ["#047857", "#1e3a8a", "#0d9488", "#6d28d9", "#f59e0b"];

  return (
    <div
      className="min-h-screen p-8"
      style={{
        background: "linear-gradient(to bottom right, #f0fdf4, #d1fae5)",
        backgroundImage: `url(${hoja})`,
        backgroundRepeat: "no-repeat",
        backgroundPosition: "top right",
        backgroundSize: "160px",
      }}
    >
      <div className="max-w-6xl mx-auto space-y-8">
        {/* HEADER */}
        <header className="flex flex-col md:flex-row md:items-end md:justify-between gap-6">
          <div className="flex items-center gap-4">
            <div className="w-16 h-16 rounded-full bg-white shadow-md flex items-center justify-center border border-emerald-700/20">
              <img src={hoja} alt="Hoja" className="w-10 h-10" />
            </div>
            <div>
              <h1 className="text-3xl font-extrabold text-emerald-800 drop-shadow">
                Intercambios por categor√≠a
              </h1>
              <p className="text-sm text-emerald-700/80">
                N√∫mero de intercambios agrupados por categor√≠a de publicaci√≥n.
              </p>
            </div>
          </div>

          <form
            onSubmit={handleSubmit}
            className="flex flex-wrap gap-4 items-end bg-white/70 px-4 py-3 rounded-xl shadow backdrop-blur text-sm"
          >
            <div className="flex flex-col">
              <label className="mb-1 font-semibold text-emerald-900">
                Desde
              </label>
              <input
                type="date"
                value={desde}
                onChange={(e) => setDesde(e.target.value)}
                className="border rounded px-2 py-1 text-sm shadow-sm"
              />
            </div>
            <div className="flex flex-col">
              <label className="mb-1 font-semibold text-emerald-900">
                Hasta
              </label>
              <input
                type="date"
                value={hasta}
                onChange={(e) => setHasta(e.target.value)}
                className="border rounded px-2 py-1 text-sm shadow-sm"
              />
            </div>
            <button
              type="submit"
              className="bg-emerald-700 hover:bg-emerald-800 text-white px-4 py-2 rounded-lg font-semibold shadow-md"
            >
              {loading ? "Cargando‚Ä¶" : "Actualizar"}
            </button>
          </form>
        </header>

        {error && (
          <div className="bg-red-100 border border-red-300 text-red-700 text-sm px-4 py-2 rounded-lg shadow-sm">
            {error}
          </div>
        )}

        {/* KPIs */}
        <section className="grid md:grid-cols-4 gap-6">
          <div className="bg-white shadow-md border border-emerald-200/40 rounded-xl p-4">
            <p className="text-xs font-semibold text-emerald-700 uppercase">
              Intercambios totales
            </p>
            <p className="mt-2 text-3xl font-extrabold text-emerald-900">
              {metrics.totalIntercambios.toLocaleString()}
            </p>
          </div>

          <div className="bg-white shadow-md border border-slate-200/60 rounded-xl p-4">
            <p className="text-xs font-semibold text-slate-700 uppercase">
              Categor√≠as con actividad
            </p>
            <p className="mt-2 text-3xl font-extrabold text-slate-900">
              {metrics.categorias}
            </p>
          </div>

          <div className="bg-white shadow-md border border-teal-200/60 rounded-xl p-4">
            <p className="text-xs font-semibold text-teal-700 uppercase">
              Promedio x categor√≠a
            </p>
            <p className="mt-2 text-3xl font-extrabold text-teal-900">
              {metrics.promedioPorCategoria.toFixed(1)}
            </p>
          </div>

          <div className="bg-white shadow-md border border-emerald-200/60 rounded-xl p-4">
            <p className="text-xs font-semibold text-emerald-700 uppercase">
              Categor√≠a m√°s activa
            </p>
            {metrics.topCategoria ? (
              <>
                <p className="mt-2 text-base font-semibold text-emerald-900">
                  {metrics.topCategoria.categoria}
                </p>
                <p className="text-xs text-emerald-700/80">
                  {metrics.topCategoria.total_intercambios} intercambios
                </p>
              </>
            ) : (
              <p className="mt-2 text-sm text-emerald-700/80">
                Sin datos en el rango.
              </p>
            )}
          </div>
        </section>

        {/* GR√ÅFICOS */}
        <section className="grid lg:grid-cols-2 gap-6">
          {/* Barras */}
          <div className="bg-white rounded-xl border border-emerald-200/40 shadow p-4">
            <h2 className="text-lg font-semibold text-emerald-900 mb-2">
              Intercambios por categor√≠a
            </h2>
            <p className="text-xs text-emerald-700/80 mb-3">
              Comparaci√≥n de volumen de intercambios entre categor√≠as.
            </p>

            <div className="h-72">
              {barData.length > 0 ? (
                <ResponsiveContainer>
                  <BarChart data={barData}>
                    <XAxis dataKey="categoria" hide />
                    <YAxis allowDecimals={false} />
                    <Tooltip />
                    <Bar
                      dataKey="intercambios"
                      name="Intercambios"
                      radius={[8, 8, 0, 0]}
                      fill="#047857"
                    />
                  </BarChart>
                </ResponsiveContainer>
              ) : (
                <div className="h-full flex items-center justify-center text-xs text-gray-400">
                  Sin datos para mostrar el gr√°fico.
                </div>
              )}
            </div>
          </div>

          {/* Pie */}
          <div className="bg-white rounded-xl border border-emerald-200/40 shadow p-4">
            <h2 className="text-lg font-semibold text-emerald-900 mb-2">
              Distribuci√≥n de intercambios
            </h2>
            <p className="text-xs text-emerald-700/80 mb-3">
              Proporci√≥n de intercambios por categor√≠a dentro del periodo.
            </p>

            <div className="h-72">
              {pieData.length > 0 ? (
                <ResponsiveContainer>
                  <PieChart>
                    <Pie
                      data={pieData}
                      cx="50%"
                      cy="50%"
                      outerRadius={90}
                      label
                      dataKey="value"
                    >
                      {pieData.map((entry, index) => (
                        <Cell
                          key={`slice-${index}`}
                          fill={COLORS[index % COLORS.length]}
                        />
                      ))}
                    </Pie>
                    <Tooltip />
                    <Legend />
                  </PieChart>
                </ResponsiveContainer>
              ) : (
                <div className="h-full flex items-center justify-center text-xs text-gray-400">
                  Sin datos para mostrar el gr√°fico.
                </div>
              )}
            </div>
          </div>
        </section>

        {/* TABLA DETALLADA */}
        <section className="bg-white border border-emerald-200/40 rounded-xl shadow">
          <div className="px-4 py-3 border-b bg-emerald-50 rounded-t-xl">
            <h2 className="font-semibold text-emerald-900">
              Detalle por categor√≠a
            </h2>
          </div>

          <div className="overflow-x-auto">
            <table className="min-w-full text-sm">
              <thead className="bg-slate-100">
                <tr>
                  <th className="px-3 py-2 text-left">Categor√≠a</th>
                  <th className="px-3 py-2 text-right">Intercambios</th>
                </tr>
              </thead>
              <tbody>
                {datos.map((c, i) => (
                  <tr key={i} className="border-t">
                    <td className="px-3 py-2">{c.categoria}</td>
                    <td className="px-3 py-2 text-right">
                      {c.total_intercambios}
                    </td>
                  </tr>
                ))}
                {datos.length === 0 && (
                  <tr>
                    <td
                      className="px-3 py-4 text-center text-gray-400"
                      colSpan={2}
                    >
                      No hay intercambios en el rango.
                    </td>
                  </tr>
                )}
              </tbody>
            </table>
          </div>
        </section>
      </div>
    </div>
  );
}
</file>

<file path="frontend/src/pages/ReportesPublicacionesVsIntercambios.jsx">
// src/pages/ReportesPublicacionesIntercambios.jsx
import React, { useEffect, useMemo, useState } from "react";
import { getReportePublicacionesVsIntercambios } from "../services/api";
import {
  BarChart,
  Bar,
  XAxis,
  YAxis,
  Tooltip,
  ResponsiveContainer,
  PieChart,
  Pie,
  Legend,
  Cell,
} from "recharts";
import hoja from "../assets/hoja.png";

function hoyISO() {
  return new Date().toISOString().slice(0, 10);
}

function hace30DiasISO() {
  const d = new Date(Date.now() - 30 * 24 * 60 * 60 * 1000);
  return d.toISOString().slice(0, 10);
}

export default function ReportesPublicacionesIntercambios() {
  const [desde, setDesde] = useState(hace30DiasISO());
  const [hasta, setHasta] = useState(hoyISO());
  const [datos, setDatos] = useState([]);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState("");

  async function cargar() {
    try {
      setLoading(true);
      setError("");
      const res = await getReportePublicacionesVsIntercambios({
        desde,
        hasta,
      });
      setDatos(Array.isArray(res) ? res : []);
    } catch (e) {
      console.error(e);
      setError("Error cargando publicaciones vs intercambios");
      setDatos([]);
    } finally {
      setLoading(false);
    }
  }

  useEffect(() => {
    cargar();
  }, []);

  function handleSubmit(e) {
    e.preventDefault();
    cargar();
  }

  // ======================
  // M√âTRICAS
  // ======================
  const metrics = useMemo(() => {
    if (!datos.length) {
      return {
        totalPublicaciones: 0,
        totalIntercambios: 0,
        categorias: 0,
        promedioRatio: 0,
        mejorCategoria: null,
      };
    }

    const totalPublicaciones = datos.reduce(
      (acc, p) => acc + Number(p.publicaciones || 0),
      0
    );
    const totalIntercambios = datos.reduce(
      (acc, p) => acc + Number(p.intercambios || 0),
      0
    );
    const categorias = datos.length;

    const ratiosNumericos = datos
      .map((p) => Number(p.ratio_intercambio ?? 0))
      .filter((r) => !Number.isNaN(r));

    const promedioRatio =
      ratiosNumericos.length > 0
        ? ratiosNumericos.reduce((a, b) => a + b, 0) / ratiosNumericos.length
        : 0;

    const mejorCategoria = datos.reduce(
      (best, p) =>
        Number(p.ratio_intercambio ?? 0) >
        Number(best?.ratio_intercambio ?? 0)
          ? p
          : best,
      null
    );

    return {
      totalPublicaciones,
      totalIntercambios,
      categorias,
      promedioRatio,
      mejorCategoria,
    };
  }, [datos]);

  // ======================
  // DATOS GR√ÅFICOS
  // ======================
  const barData = useMemo(
    () =>
      datos.map((p) => ({
        categoria: p.categoria,
        publicaciones: Number(p.publicaciones || 0),
        intercambios: Number(p.intercambios || 0),
      })),
    [datos]
  );

  const pieData = useMemo(
    () =>
      datos.map((p) => ({
        name: p.categoria,
        value: Number(p.intercambios || 0),
      })),
    [datos]
  );

  const COLORS = ["#047857", "#1e3a8a", "#0d9488", "#6d28d9", "#f59e0b"];

  return (
    <div
      className="min-h-screen p-8"
      style={{
        background: "linear-gradient(to bottom right, #f0fdf4, #d1fae5)",
        backgroundImage: `url(${hoja})`,
        backgroundRepeat: "no-repeat",
        backgroundPosition: "top right",
        backgroundSize: "160px",
      }}
    >
      <div className="max-w-6xl mx-auto space-y-8">
        {/* HEADER */}
        <header className="flex flex-col md:flex-row md:items-end md:justify-between gap-6">
          <div className="flex items-center gap-4">
            <div className="w-16 h-16 rounded-full bg-white shadow-md flex items-center justify-center border border-emerald-700/20">
              <img src={hoja} alt="Hoja" className="w-10 h-10" />
            </div>
            <div>
              <h1 className="text-3xl font-extrabold text-emerald-800 drop-shadow">
                Publicaciones vs intercambios por categor√≠a
              </h1>
              <p className="text-sm text-emerald-700/80">
                Relaci√≥n entre publicaciones creadas y las que se concretan
                como intercambio.
              </p>
            </div>
          </div>

          <form
            onSubmit={handleSubmit}
            className="flex flex-wrap gap-4 items-end bg-white/70 px-4 py-3 rounded-xl shadow backdrop-blur text-sm"
          >
            <div className="flex flex-col">
              <label className="mb-1 font-semibold text-emerald-900">
                Desde
              </label>
              <input
                type="date"
                value={desde}
                onChange={(e) => setDesde(e.target.value)}
                className="border rounded px-2 py-1 text-sm shadow-sm"
              />
            </div>
            <div className="flex flex-col">
              <label className="mb-1 font-semibold text-emerald-900">
                Hasta
              </label>
              <input
                type="date"
                value={hasta}
                onChange={(e) => setHasta(e.target.value)}
                className="border rounded px-2 py-1 text-sm shadow-sm"
              />
            </div>
            <button
              type="submit"
              className="bg-emerald-700 hover:bg-emerald-800 text-white px-4 py-2 rounded-lg font-semibold shadow-md"
            >
              {loading ? "Cargando‚Ä¶" : "Actualizar"}
            </button>
          </form>
        </header>

        {error && (
          <div className="bg-red-100 border border-red-300 text-red-700 text-sm px-4 py-2 rounded-lg shadow-sm">
            {error}
          </div>
        )}

        {/* KPIs */}
        <section className="grid md:grid-cols-4 gap-6">
          <div className="bg-white shadow-md border border-emerald-200/40 rounded-xl p-4">
            <p className="text-xs font-semibold text-emerald-700 uppercase">
              Publicaciones totales
            </p>
            <p className="mt-2 text-3xl font-extrabold text-emerald-900">
              {metrics.totalPublicaciones.toLocaleString()}
            </p>
          </div>

          <div className="bg-white shadow-md border border-teal-200/60 rounded-xl p-4">
            <p className="text-xs font-semibold text-teal-700 uppercase">
              Intercambios totales
            </p>
            <p className="mt-2 text-3xl font-extrabold text-teal-900">
              {metrics.totalIntercambios.toLocaleString()}
            </p>
          </div>

          <div className="bg-white shadow-md border border-slate-200/60 rounded-xl p-4">
            <p className="text-xs font-semibold text-slate-700 uppercase">
              Categor√≠as activas
            </p>
            <p className="mt-2 text-3xl font-extrabold text-slate-900">
              {metrics.categorias}
            </p>
          </div>

          <div className="bg-white shadow-md border border-emerald-200/60 rounded-xl p-4">
            <p className="text-xs font-semibold text-emerald-700 uppercase">
              Ratio promedio
            </p>
            <p className="mt-2 text-3xl font-extrabold text-emerald-900">
              {metrics.promedioRatio.toFixed(2)}
            </p>
            {metrics.mejorCategoria && (
              <p className="mt-1 text-[11px] text-emerald-700/80">
                Mejor categor√≠a:{" "}
                <span className="font-semibold">
                  {metrics.mejorCategoria.categoria} (
                  {metrics.mejorCategoria.ratio_intercambio})
                </span>
              </p>
            )}
          </div>
        </section>

        {/* GR√ÅFICOS */}
        <section className="grid lg:grid-cols-2 gap-6">
          {/* Barras: publicaciones vs intercambios */}
          <div className="bg-white rounded-xl border border-emerald-200/40 shadow p-4">
            <h2 className="text-lg font-semibold text-emerald-900 mb-2">
              Publicaciones vs intercambios por categor√≠a
            </h2>
            <p className="text-xs text-emerald-700/80 mb-3">
              Comparaci√≥n del volumen de publicaciones frente a intercambios
              concretados.
            </p>

            <div className="h-72">
              {barData.length > 0 ? (
                <ResponsiveContainer>
                  <BarChart data={barData}>
                    <XAxis dataKey="categoria" hide />
                    <YAxis allowDecimals={false} />
                    <Tooltip />
                    <Legend />
                    <Bar
                      dataKey="publicaciones"
                      name="Publicaciones"
                      fill="#1e3a8a"
                      radius={[8, 8, 0, 0]}
                    />
                    <Bar
                      dataKey="intercambios"
                      name="Intercambios"
                      fill="#047857"
                      radius={[8, 8, 0, 0]}
                    />
                  </BarChart>
                </ResponsiveContainer>
              ) : (
                <div className="h-full flex items-center justify-center text-xs text-gray-400">
                  Sin datos para mostrar el gr√°fico.
                </div>
              )}
            </div>
          </div>

          {/* Pie: distribuci√≥n de intercambios */}
          <div className="bg-white rounded-xl border border-emerald-200/40 shadow p-4">
            <h2 className="text-lg font-semibold text-emerald-900 mb-2">
              Distribuci√≥n de intercambios por categor√≠a
            </h2>
            <p className="text-xs text-emerald-700/80 mb-3">
              Proporci√≥n de intercambios por categor√≠a en el periodo.
            </p>

            <div className="h-72">
              {pieData.length > 0 ? (
                <ResponsiveContainer>
                  <PieChart>
                    <Pie
                      data={pieData}
                      cx="50%"
                      cy="50%"
                      outerRadius={90}
                      label
                      dataKey="value"
                    >
                      {pieData.map((entry, index) => (
                        <Cell
                          key={`slice-${index}`}
                          fill={COLORS[index % COLORS.length]}
                        />
                      ))}
                    </Pie>
                    <Tooltip />
                    <Legend />
                  </PieChart>
                </ResponsiveContainer>
              ) : (
                <div className="h-full flex items-center justify-center text-xs text-gray-400">
                  Sin datos para mostrar el gr√°fico.
                </div>
              )}
            </div>
          </div>
        </section>

        {/* TABLA DETALLADA */}
        <section className="bg-white border border-emerald-200/40 rounded-xl shadow">
          <div className="px-4 py-3 border-b bg-emerald-50 rounded-t-xl">
            <h2 className="font-semibold text-emerald-900">
              Detalle por categor√≠a
            </h2>
          </div>

          <div className="overflow-x-auto">
            <table className="min-w-full text-sm">
              <thead className="bg-slate-100">
                <tr>
                  <th className="px-3 py-2 text-left">Categor√≠a</th>
                  <th className="px-3 py-2 text-right">Publicaciones</th>
                  <th className="px-3 py-2 text-right">Intercambios</th>
                  <th className="px-3 py-2 text-right">Ratio</th>
                </tr>
              </thead>
              <tbody>
                {datos.map((p, i) => (
                  <tr key={i} className="border-t">
                    <td className="px-3 py-2">{p.categoria}</td>
                    <td className="px-3 py-2 text-right">
                      {p.publicaciones}
                    </td>
                    <td className="px-3 py-2 text-right">
                      {p.intercambios}
                    </td>
                    <td className="px-3 py-2 text-right">
                      {p.ratio_intercambio ?? "-"}
                    </td>
                  </tr>
                ))}
                {datos.length === 0 && (
                  <tr>
                    <td
                      className="px-3 py-4 text-center text-gray-400"
                      colSpan={4}
                    >
                      Sin datos para el rango.
                    </td>
                  </tr>
                )}
              </tbody>
            </table>
          </div>
        </section>
      </div>
    </div>
  );
}
</file>

<file path="frontend/src/pages/ReportesRankingUsuarios.jsx">
// src/pages/ReportesRankingUsuarios.jsx
import React, { useMemo, useState } from "react";
import { getReporteRankingUsuarios } from "../services/api";
import {
  BarChart,
  Bar,
  XAxis,
  YAxis,
  Tooltip,
  ResponsiveContainer,
  Legend,
} from "recharts";
import hoja from "../assets/hoja.png";

export default function ReportesRankingUsuarios() {
  const [idPeriodo, setIdPeriodo] = useState("");
  const [limit, setLimit] = useState(10);
  const [datos, setDatos] = useState([]);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState("");

  async function cargar() {
    try {
      setLoading(true);
      setError("");
      const res = await getReporteRankingUsuarios({ idPeriodo, limit });
      setDatos(Array.isArray(res) ? res : []);
    } catch (e) {
      console.error(e);
      setError("Error cargando ranking de usuarios");
      setDatos([]);
    } finally {
      setLoading(false);
    }
  }

  // =========================
  // M√âTRICAS GLOBALES
  // =========================
  const metrics = useMemo(() => {
    if (!datos.length) {
      return {
        totalCo2: 0,
        totalAgua: 0,
        totalEnergia: 0,
        totalTransacciones: 0,
        usuarios: 0,
        topUsuario: null,
      };
    }

    const totalCo2 = datos.reduce(
      (acc, r) => acc + Number(r.co2_total || 0),
      0
    );
    const totalAgua = datos.reduce(
      (acc, r) => acc + Number(r.agua_total || 0),
      0
    );
    const totalEnergia = datos.reduce(
      (acc, r) => acc + Number(r.energia_total || 0),
      0
    );
    const totalTransacciones = datos.reduce(
      (acc, r) => acc + Number(r.transacciones || 0),
      0
    );
    const usuarios = datos.length;

    const topUsuario = datos.reduce(
      (best, r) => {
        const impacto =
          Number(r.co2_total || 0) +
          Number(r.agua_total || 0) +
          Number(r.energia_total || 0);
        const bestImpacto =
          Number(best?.co2_total || 0) +
          Number(best?.agua_total || 0) +
          Number(best?.energia_total || 0);
        return impacto > bestImpacto ? r : best;
      },
      null
    );

    return {
      totalCo2,
      totalAgua,
      totalEnergia,
      totalTransacciones,
      usuarios,
      topUsuario,
    };
  }, [datos]);

  // =========================
  // DATOS PARA GR√ÅFICOS
  // =========================
  const chartImpacto = useMemo(
    () =>
      datos.map((r) => ({
        usuario: `U${r.id_usuario}`,
        impacto:
          Number(r.co2_total || 0) +
          Number(r.agua_total || 0) +
          Number(r.energia_total || 0),
      })),
    [datos]
  );

  const chartTransacciones = useMemo(
    () =>
      datos.map((r) => ({
        usuario: `U${r.id_usuario}`,
        transacciones: Number(r.transacciones || 0),
      })),
    [datos]
  );

  return (
    <div
      className="min-h-screen p-8"
      style={{
        background: "linear-gradient(to bottom right, #f0fdf4, #d1fae5)",
        backgroundImage: `url(${hoja})`,
        backgroundRepeat: "no-repeat",
        backgroundPosition: "top right",
        backgroundSize: "160px",
      }}
    >
      <div className="max-w-6xl mx-auto space-y-8">
        {/* HEADER */}
        <header className="flex flex-col md:flex-row md:items-end md:justify-between gap-6">
          <div className="flex items-center gap-4">
            <div className="w-16 h-16 rounded-full bg-white shadow-md flex items-center justify-center border border-emerald-700/20">
              <img src={hoja} alt="Hoja" className="w-10 h-10" />
            </div>
            <div>
              <h1 className="text-3xl font-extrabold text-emerald-800 drop-shadow">
                Ranking de usuarios por impacto
              </h1>
              <p className="text-sm text-emerald-700/80">
                Usuarios ordenados por impacto ambiental (CO‚ÇÇ, agua, energ√≠a).
              </p>
            </div>
          </div>

          <div className="flex flex-wrap gap-4 items-end text-sm bg-white/70 px-4 py-3 rounded-xl shadow backdrop-blur">
            <div className="flex flex-col">
              <label className="mb-1 font-semibold text-emerald-900">
                ID per√≠odo (opcional)
              </label>
              <input
                type="number"
                min="1"
                value={idPeriodo}
                onChange={(e) => setIdPeriodo(e.target.value)}
                className="border rounded px-2 py-1 text-sm w-24 shadow-sm"
                placeholder="ej. 1"
              />
            </div>

            <div className="flex flex-col">
              <label className="mb-1 font-semibold text-emerald-900">
                Top N
              </label>
              <input
                type="number"
                min="1"
                value={limit}
                onChange={(e) => setLimit(Number(e.target.value) || 1)}
                className="border rounded px-2 py-1 text-sm w-20 shadow-sm"
              />
            </div>

            <button
              type="button"
              onClick={cargar}
              className="bg-emerald-700 hover:bg-emerald-800 text-white px-4 py-2 rounded-lg text-sm font-semibold shadow-md"
            >
              {loading ? "Cargando‚Ä¶" : "Actualizar"}
            </button>
          </div>
        </header>

        {error && (
          <div className="bg-red-100 border border-red-300 text-red-700 text-sm px-4 py-2 rounded-lg shadow-sm">
            {error}
          </div>
        )}

        {/* KPIs */}
        <section className="grid md:grid-cols-5 gap-6">
          <div className="bg-white shadow-md border border-emerald-200/40 rounded-xl p-4">
            <p className="text-xs font-semibold text-emerald-700 uppercase">
              CO‚ÇÇ total (kg)
            </p>
            <p className="mt-2 text-3xl font-extrabold text-emerald-900">
              {metrics.totalCo2.toLocaleString()}
            </p>
          </div>

          <div className="bg-white shadow-md border border-blue-200/60 rounded-xl p-4">
            <p className="text-xs font-semibold text-blue-700 uppercase">
              Agua total (L)
            </p>
            <p className="mt-2 text-3xl font-extrabold text-blue-900">
              {metrics.totalAgua.toLocaleString()}
            </p>
          </div>

          <div className="bg-white shadow-md border border-teal-200/60 rounded-xl p-4">
            <p className="text-xs font-semibold text-teal-700 uppercase">
              Energ√≠a total (kWh)
            </p>
            <p className="mt-2 text-3xl font-extrabold text-teal-900">
              {metrics.totalEnergia.toLocaleString()}
            </p>
          </div>

          <div className="bg-white shadow-md border border-slate-200/60 rounded-xl p-4">
            <p className="text-xs font-semibold text-slate-700 uppercase">
              Transacciones
            </p>
            <p className="mt-2 text-3xl font-extrabold text-slate-900">
              {metrics.totalTransacciones.toLocaleString()}
            </p>
          </div>

          <div className="bg-white shadow-md border border-emerald-200/40 rounded-xl p-4">
            <p className="text-xs font-semibold text-emerald-700 uppercase">
              Usuarios en ranking
            </p>
            <p className="mt-2 text-3xl font-extrabold text-emerald-900">
              {metrics.usuarios}
            </p>
            {metrics.topUsuario && (
              <p className="mt-1 text-[11px] text-emerald-700/80">
                Top 1:{" "}
                <span className="font-semibold">
                  U{metrics.topUsuario.id_usuario}
                </span>
              </p>
            )}
          </div>
        </section>

        {/* GR√ÅFICOS */}
        <section className="grid lg:grid-cols-2 gap-6">
          {/* Impacto total por usuario */}
          <div className="bg-white rounded-xl border border-emerald-200/40 shadow p-4">
            <h2 className="text-lg font-semibold text-emerald-900 mb-2">
              Impacto ambiental total por usuario
            </h2>
            <p className="text-xs text-emerald-700/80 mb-3">
              Suma de CO‚ÇÇ, agua y energ√≠a por usuario en el ranking.
            </p>

            <div className="h-72">
              {chartImpacto.length > 0 ? (
                <ResponsiveContainer>
                  <BarChart data={chartImpacto}>
                    <XAxis dataKey="usuario" />
                    <YAxis />
                    <Tooltip />
                    <Bar
                      dataKey="impacto"
                      name="Impacto total (unidades combinadas)"
                      fill="#047857"
                      radius={[8, 8, 0, 0]}
                    />
                  </BarChart>
                </ResponsiveContainer>
              ) : (
                <div className="h-full flex items-center justify-center text-xs text-gray-400">
                  Sin datos para mostrar el gr√°fico.
                </div>
              )}
            </div>
          </div>

          {/* Transacciones por usuario */}
          <div className="bg-white rounded-xl border border-emerald-200/40 shadow p-4">
            <h2 className="text-lg font-semibold text-emerald-900 mb-2">
              Transacciones por usuario
            </h2>
            <p className="text-xs text-emerald-700/80 mb-3">
              Volumen de transacciones de los usuarios en el ranking.
            </p>

            <div className="h-72">
              {chartTransacciones.length > 0 ? (
                <ResponsiveContainer>
                  <BarChart data={chartTransacciones}>
                    <XAxis dataKey="usuario" />
                    <YAxis allowDecimals={false} />
                    <Tooltip />
                    <Legend />
                    <Bar
                      dataKey="transacciones"
                      name="Transacciones"
                      fill="#1e3a8a"
                      radius={[8, 8, 0, 0]}
                    />
                  </BarChart>
                </ResponsiveContainer>
              ) : (
                <div className="h-full flex items-center justify-center text-xs text-gray-400">
                  Sin datos para mostrar el gr√°fico.
                </div>
              )}
            </div>
          </div>
        </section>

        {/* TABLA DETALLADA */}
        <section className="bg-white border border-emerald-200/40 rounded-xl shadow">
          <div className="px-4 py-3 border-b bg-emerald-50 rounded-t-xl">
            <h2 className="font-semibold text-emerald-900">
              Detalle del ranking de usuarios
            </h2>
          </div>

          <div className="overflow-x-auto">
            <table className="min-w-full text-sm">
              <thead className="bg-slate-100">
                <tr>
                  <th className="px-3 py-2 text-left">Usuario (ID)</th>
                  <th className="px-3 py-2 text-right">CO‚ÇÇ total (kg)</th>
                  <th className="px-3 py-2 text-right">Agua total (L)</th>
                  <th className="px-3 py-2 text-right">Energ√≠a total (kWh)</th>
                  <th className="px-3 py-2 text-right">Transacciones</th>
                </tr>
              </thead>
              <tbody>
                {datos.map((r, i) => (
                  <tr key={i} className="border-t">
                    <td className="px-3 py-2">U{r.id_usuario}</td>
                    <td className="px-3 py-2 text-right">
                      {r.co2_total}
                    </td>
                    <td className="px-3 py-2 text-right">
                      {r.agua_total}
                    </td>
                    <td className="px-3 py-2 text-right">
                      {r.energia_total}
                    </td>
                    <td className="px-3 py-2 text-right">
                      {r.transacciones}
                    </td>
                  </tr>
                ))}
                {datos.length === 0 && (
                  <tr>
                    <td
                      className="px-3 py-4 text-center text-gray-400"
                      colSpan={5}
                    >
                      Sin datos de ranking para los filtros actuales.
                    </td>
                  </tr>
                )}
              </tbody>
            </table>
          </div>
        </section>
      </div>
    </div>
  );
}
</file>

<file path="frontend/src/pages/ReportesSaldosUsuarios.jsx">
// src/pages/ReportesSaldosUsuarios.jsx
import React, { useEffect, useMemo, useState } from "react";
import { getReporteSaldosUsuarios } from "../services/api";
import {
  BarChart,
  Bar,
  XAxis,
  YAxis,
  Tooltip,
  ResponsiveContainer,
  PieChart,
  Pie,
  Legend,
  Cell,
} from "recharts";
import hoja from "../assets/hoja.png";

export default function ReportesSaldosUsuarios() {
  const [limit, setLimit] = useState(20);
  const [datos, setDatos] = useState([]);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState("");

  async function cargar() {
    try {
      setLoading(true);
      setError("");
      const res = await getReporteSaldosUsuarios({ limit });
      setDatos(Array.isArray(res) ? res : []);
    } catch (e) {
      console.error(e);
      setError("Error cargando saldos de usuarios");
      setDatos([]);
    } finally {
      setLoading(false);
    }
  }

  useEffect(() => {
    cargar();
  }, []);

  // =========================
  // M√âTRICAS
  // =========================
  const metrics = useMemo(() => {
    if (!datos.length) {
      return {
        totalUsuarios: 0,
        totalSaldo: 0,
        promedioSaldo: 0,
        topUsuario: null,
      };
    }

    const totalUsuarios = datos.length;
    const totalSaldo = datos.reduce(
      (acc, u) => acc + Number(u.saldo_creditos || 0),
      0
    );
    const promedioSaldo =
      totalUsuarios > 0 ? totalSaldo / totalUsuarios : 0;

    const topUsuario = datos.reduce(
      (best, u) =>
        Number(u.saldo_creditos || 0) >
        Number(best?.saldo_creditos || 0)
          ? u
          : best,
      null
    );

    return { totalUsuarios, totalSaldo, promedioSaldo, topUsuario };
  }, [datos]);

  // =========================
  // DATOS GR√ÅFICOS
  // =========================
  const barData = useMemo(
    () =>
      datos.map((u, index) => ({
        etiqueta: `U${index + 1}`,
        nombre: u.nombre,
        saldo: Number(u.saldo_creditos || 0),
      })),
    [datos]
  );

  const pieData = useMemo(
    () =>
      datos.map((u) => ({
        name: u.nombre,
        value: Number(u.saldo_creditos || 0),
      })),
    [datos]
  );

  const COLORS = ["#047857", "#1e3a8a", "#0d9488", "#6d28d9", "#f59e0b"];

  return (
    <div
      className="min-h-screen p-8"
      style={{
        background: "linear-gradient(to bottom right, #f0fdf4, #d1fae5)",
        backgroundImage: `url(${hoja})`,
        backgroundRepeat: "no-repeat",
        backgroundPosition: "top right",
        backgroundSize: "160px",
      }}
    >
      <div className="max-w-6xl mx-auto space-y-8">
        {/* HEADER */}
        <header className="flex flex-col md:flex-row md:items-end md:justify-between gap-6">
          <div className="flex items-center gap-4">
            <div className="w-16 h-16 rounded-full bg-white shadow-md flex items-center justify-center border border-emerald-700/20">
              <img src={hoja} alt="Hoja" className="w-10 h-10" />
            </div>
            <div>
              <h1 className="text-3xl font-extrabold text-emerald-800 drop-shadow">
                Saldos de cr√©ditos por usuario
              </h1>
              <p className="text-sm text-emerald-700/80">
                Top de usuarios con mayor saldo en su billetera.
              </p>
            </div>
          </div>

          <div className="flex flex-wrap gap-4 items-end text-sm bg-white/70 px-4 py-3 rounded-xl shadow backdrop-blur">
            <div className="flex flex-col">
              <label className="mb-1 font-semibold text-emerald-900">
                Top N
              </label>
              <input
                type="number"
                min="1"
                value={limit}
                onChange={(e) =>
                  setLimit(Math.max(1, Number(e.target.value) || 1))
                }
                className="border rounded px-2 py-1 text-sm w-20 shadow-sm"
              />
            </div>
            <button
              type="button"
              onClick={cargar}
              className="bg-emerald-700 hover:bg-emerald-800 text-white px-4 py-2 rounded-lg text-sm font-semibold shadow-md"
            >
              {loading ? "Cargando‚Ä¶" : "Actualizar"}
            </button>
          </div>
        </header>

        {error && (
          <div className="bg-red-100 border border-red-300 text-red-700 text-sm px-4 py-2 rounded-lg shadow-sm">
            {error}
          </div>
        )}

        {/* KPIs */}
        <section className="grid md:grid-cols-3 gap-6">
          <div className="bg-white shadow-md border border-emerald-200/40 rounded-xl p-4">
            <p className="text-xs font-semibold text-emerald-700 uppercase">
              Usuarios en el ranking
            </p>
            <p className="mt-2 text-3xl font-extrabold text-emerald-900">
              {metrics.totalUsuarios}
            </p>
          </div>

          <div className="bg-white shadow-md border border-blue-200/60 rounded-xl p-4">
            <p className="text-xs font-semibold text-blue-700 uppercase">
              Saldo total (cr√©ditos)
            </p>
            <p className="mt-2 text-3xl font-extrabold text-blue-900">
              {metrics.totalSaldo.toLocaleString()}
            </p>
          </div>

          <div className="bg-white shadow-md border border-teal-200/60 rounded-xl p-4">
            <p className="text-xs font-semibold text-teal-700 uppercase">
              Saldo promedio
            </p>
            <p className="mt-2 text-3xl font-extrabold text-teal-900">
              {metrics.promedioSaldo.toFixed(1)}
            </p>
          </div>
        </section>

        {/* Usuario Top */}
        <section className="grid md:grid-cols-3 gap-6">
          <div className="md:col-span-3 bg-white shadow-md border border-emerald-200/40 rounded-xl p-4 flex flex-col md:flex-row md:items-center md:justify-between gap-4">
            <div>
              <p className="text-xs font-semibold text-emerald-700 uppercase">
                Usuario con mayor saldo
              </p>
              {metrics.topUsuario ? (
                <>
                  <p className="mt-1 text-lg font-bold text-emerald-900">
                    {metrics.topUsuario.nombre}
                  </p>
                  <p className="text-xs text-slate-700">
                    {metrics.topUsuario.correo}
                  </p>
                </>
              ) : (
                <p className="mt-1 text-sm text-emerald-700/80">
                  No hay datos para mostrar.
                </p>
              )}
            </div>
            {metrics.topUsuario && (
              <div className="text-right">
                <p className="text-xs font-semibold text-slate-700 uppercase">
                  Saldo cr√©ditos
                </p>
                <p className="mt-1 text-3xl font-extrabold text-emerald-900">
                  {Number(
                    metrics.topUsuario.saldo_creditos || 0
                  ).toLocaleString()}
                </p>
              </div>
            )}
          </div>
        </section>

        {/* GR√ÅFICOS */}
        <section className="grid lg:grid-cols-2 gap-6">
          {/* Barras */}
          <div className="bg-white rounded-xl border border-emerald-200/40 shadow p-4">
            <h2 className="text-lg font-semibold text-emerald-900 mb-2">
              Saldos por usuario
            </h2>
            <p className="text-xs text-emerald-700/80 mb-3">
              Comparaci√≥n del saldo de cr√©ditos entre los usuarios del top.
            </p>

            <div className="h-72">
              {barData.length > 0 ? (
                <ResponsiveContainer>
                  <BarChart data={barData}>
                    <XAxis dataKey="etiqueta" />
                    <YAxis />
                    <Tooltip
                      formatter={(value, name, props) => [
                        value,
                        props.payload.nombre,
                      ]}
                    />
                    <Bar
                      dataKey="saldo"
                      name="Saldo cr√©ditos"
                      fill="#047857"
                      radius={[8, 8, 0, 0]}
                    />
                  </BarChart>
                </ResponsiveContainer>
              ) : (
                <div className="h-full flex items-center justify-center text-xs text-gray-400">
                  Sin datos para mostrar el gr√°fico.
                </div>
              )}
            </div>
          </div>

          {/* Pie */}
          <div className="bg-white rounded-xl border border-emerald-200/40 shadow p-4">
            <h2 className="text-lg font-semibold text-emerald-900 mb-2">
              Distribuci√≥n de saldos
            </h2>
            <p className="text-xs text-emerald-700/80 mb-3">
              Proporci√≥n del saldo total que concentra cada usuario.
            </p>

            <div className="h-72">
              {pieData.length > 0 ? (
                <ResponsiveContainer>
                  <PieChart>
                    <Pie
                      data={pieData}
                      cx="50%"
                      cy="50%"
                      outerRadius={90}
                      label
                      dataKey="value"
                    >
                      {pieData.map((entry, index) => (
                        <Cell
                          key={`slice-${index}`}
                          fill={COLORS[index % COLORS.length]}
                        />
                      ))}
                    </Pie>
                    <Tooltip />
                    <Legend />
                  </PieChart>
                </ResponsiveContainer>
              ) : (
                <div className="h-full flex items-center justify-center text-xs text-gray-400">
                  Sin datos para mostrar el gr√°fico.
                </div>
              )}
            </div>
          </div>
        </section>

        {/* TABLA DETALLADA */}
        <section className="bg-white border border-emerald-200/40 rounded-xl shadow">
          <div className="px-4 py-3 border-b bg-emerald-50 rounded-t-xl">
            <h2 className="font-semibold text-emerald-900">
              Detalle de saldos por usuario
            </h2>
          </div>

          <div className="overflow-x-auto">
            <table className="min-w-full text-sm">
              <thead className="bg-slate-100">
                <tr>
                  <th className="px-3 py-2 text-left">Usuario</th>
                  <th className="px-3 py-2 text-left">Correo</th>
                  <th className="px-3 py-2 text-right">Saldo cr√©ditos</th>
                </tr>
              </thead>
              <tbody>
                {datos.map((u, i) => (
                  <tr key={i} className="border-t">
                    <td className="px-3 py-2">{u.nombre}</td>
                    <td className="px-3 py-2">{u.correo}</td>
                    <td className="px-3 py-2 text-right">
                      {u.saldo_creditos}
                    </td>
                  </tr>
                ))}
                {datos.length === 0 && (
                  <tr>
                    <td
                      className="px-3 py-4 text-center text-gray-400"
                      colSpan={3}
                    >
                      Sin datos de saldos para mostrar.
                    </td>
                  </tr>
                )}
              </tbody>
            </table>
          </div>
        </section>
      </div>
    </div>
  );
}
</file>

<file path="frontend/src/pages/ReportesUsuarios.jsx">
// src/pages/ReportesUsuarios.jsx
import React, { useEffect, useMemo, useState } from "react";
import {
  getReporteUsuariosActivos,
  getReporteUsuariosAbandonados,
  getReporteUsuariosNuevos,
} from "../services/api";
import {
  BarChart,
  Bar,
  XAxis,
  YAxis,
  Tooltip,
  ResponsiveContainer,
  Legend,
} from "recharts";
import hoja from "../assets/hoja.png";

function hoyISO() {
  return new Date().toISOString().slice(0, 10);
}

function hace30DiasISO() {
  const d = new Date(Date.now() - 30 * 24 * 60 * 60 * 1000);
  return d.toISOString().slice(0, 10);
}

export default function ReportesUsuarios() {
  const [desde, setDesde] = useState(hace30DiasISO());
  const [hasta, setHasta] = useState(hoyISO());

  const [activos, setActivos] = useState([]);
  const [abandonados, setAbandonados] = useState([]);
  const [nuevos, setNuevos] = useState([]);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState("");

  async function cargar() {
    try {
      setLoading(true);
      setError("");
      const [a, b, n] = await Promise.all([
        getReporteUsuariosActivos({ desde, hasta }),
        getReporteUsuariosAbandonados({ desde, hasta }),
        getReporteUsuariosNuevos({ desde, hasta }),
      ]);
      setActivos(Array.isArray(a) ? a : []);
      setAbandonados(Array.isArray(b) ? b : []);
      setNuevos(Array.isArray(n) ? n : []);
    } catch (e) {
      console.error(e);
      setError("Error cargando reportes de usuarios");
      setActivos([]);
      setAbandonados([]);
      setNuevos([]);
    } finally {
      setLoading(false);
    }
  }

  useEffect(() => {
    cargar();
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, []);

  function handleSubmit(e) {
    e.preventDefault();
    cargar();
  }

  // =========================
  // M√âTRICAS
  // =========================
  const metrics = useMemo(() => {
    const totalActivos = activos.length;
    const totalAbandonados = abandonados.length;
    const totalNuevos = nuevos.length;
    const totalUsuariosPeriodo =
      totalActivos + totalAbandonados + totalNuevos;

    const tasaRetencion =
      totalUsuariosPeriodo > 0
        ? (totalActivos / totalUsuariosPeriodo) * 100
        : 0;
    const tasaAbandono =
      totalUsuariosPeriodo > 0
        ? (totalAbandonados / totalUsuariosPeriodo) * 100
        : 0;

    return {
      totalActivos,
      totalAbandonados,
      totalNuevos,
      totalUsuariosPeriodo,
      tasaRetencion,
      tasaAbandono,
    };
  }, [activos, abandonados, nuevos]);

  const chartResumen = useMemo(
    () => [
      { tipo: "Activos", cantidad: metrics.totalActivos },
      { tipo: "Abandonados", cantidad: metrics.totalAbandonados },
      { tipo: "Nuevos", cantidad: metrics.totalNuevos },
    ],
    [metrics.totalActivos, metrics.totalAbandonados, metrics.totalNuevos]
  );

  return (
    <div
      className="min-h-screen p-8"
      style={{
        background: "linear-gradient(to bottom right, #f0fdf4, #d1fae5)",
        backgroundImage: `url(${hoja})`,
        backgroundRepeat: "no-repeat",
        backgroundPosition: "top right",
        backgroundSize: "160px",
      }}
    >
      <div className="max-w-6xl mx-auto space-y-8">
        {/* HEADER */}
        <header className="flex flex-col md:flex-row md:items-end md:justify-between gap-6">
          <div className="flex items-center gap-4">
            <div className="w-16 h-16 rounded-full bg-white shadow-md flex items-center justify-center border border-emerald-700/20">
              <img src={hoja} alt="Hoja" className="w-10 h-10" />
            </div>
            <div>
              <h1 className="text-3xl font-extrabold text-emerald-800 drop-shadow">
                Reporte de usuarios
              </h1>
              <p className="text-sm text-emerald-700/80">
                Usuarios activos, abandonados y nuevos (primer login) en el
                rango seleccionado.
              </p>
            </div>
          </div>

          <form
            onSubmit={handleSubmit}
            className="flex flex-wrap gap-4 items-end bg-white/70 px-4 py-3 rounded-xl shadow backdrop-blur text-sm"
          >
            <div className="flex flex-col">
              <label className="mb-1 font-semibold text-emerald-900">
                Desde
              </label>
              <input
                type="date"
                value={desde}
                onChange={(e) => setDesde(e.target.value)}
                className="border rounded px-2 py-1 text-sm shadow-sm"
              />
            </div>
            <div className="flex flex-col">
              <label className="mb-1 font-semibold text-emerald-900">
                Hasta
              </label>
              <input
                type="date"
                value={hasta}
                onChange={(e) => setHasta(e.target.value)}
                className="border rounded px-2 py-1 text-sm shadow-sm"
              />
            </div>
            <button
              type="submit"
              className="bg-emerald-700 hover:bg-emerald-800 text-white px-4 py-2 rounded-lg font-semibold shadow-md"
            >
              {loading ? "Cargando‚Ä¶" : "Actualizar"}
            </button>
          </form>
        </header>

        {error && (
          <div className="bg-red-100 border border-red-300 text-red-700 text-sm px-4 py-2 rounded-lg shadow-sm">
            {error}
          </div>
        )}

        {/* KPIs */}
        <section className="grid md:grid-cols-4 gap-6">
          <div className="bg-white shadow-md border border-emerald-200/40 rounded-xl p-4">
            <p className="text-xs font-semibold text-emerald-700 uppercase">
              Usuarios activos
            </p>
            <p className="mt-2 text-3xl font-extrabold text-emerald-900">
              {metrics.totalActivos}
            </p>
          </div>

          <div className="bg-white shadow-md border border-slate-200/60 rounded-xl p-4">
            <p className="text-xs font-semibold text-slate-700 uppercase">
              Usuarios abandonados
            </p>
            <p className="mt-2 text-3xl font-extrabold text-slate-900">
              {metrics.totalAbandonados}
            </p>
          </div>

          <div className="bg-white shadow-md border border-blue-200/60 rounded-xl p-4">
            <p className="text-xs font-semibold text-blue-700 uppercase">
              Usuarios nuevos
            </p>
            <p className="mt-2 text-3xl font-extrabold text-blue-900">
              {metrics.totalNuevos}
            </p>
          </div>

          <div className="bg-white shadow-md border border-emerald-200/60 rounded-xl p-4">
            <p className="text-xs font-semibold text-emerald-700 uppercase">
              Tasa de retenci√≥n
            </p>
            <p className="mt-2 text-3xl font-extrabold text-emerald-900">
              {metrics.tasaRetencion.toFixed(1)}%
            </p>
            <p className="text-[11px] text-emerald-700/80 mt-1">
              Abandono: {metrics.tasaAbandono.toFixed(1)}%
            </p>
          </div>
        </section>

        {/* Gr√°fico resumen */}
        <section className="grid lg:grid-cols-2 gap-6">
          <div className="bg-white rounded-xl border border-emerald-200/40 shadow p-4">
            <h2 className="text-lg font-semibold text-emerald-900 mb-2">
              Distribuci√≥n de usuarios por tipo
            </h2>
            <p className="text-xs text-emerald-700/80 mb-3">
              Comparaci√≥n entre usuarios activos, abandonados y nuevos.
            </p>
            <div className="h-72">
              <ResponsiveContainer>
                <BarChart data={chartResumen}>
                  <XAxis dataKey="tipo" />
                  <YAxis allowDecimals={false} />
                  <Tooltip />
                  <Legend />
                  <Bar
                    dataKey="cantidad"
                    name="Usuarios"
                    fill="#047857"
                    radius={[8, 8, 0, 0]}
                  />
                </BarChart>
              </ResponsiveContainer>
            </div>
          </div>

          <div className="bg-white rounded-xl border border-emerald-200/40 shadow p-4 flex flex-col justify-center">
            <h2 className="text-lg font-semibold text-emerald-900 mb-2">
              Resumen del periodo
            </h2>
            <ul className="text-sm text-emerald-900 space-y-1">
              <li>
                <span className="font-semibold">Total usuarios en an√°lisis: </span>
                {metrics.totalUsuariosPeriodo}
              </li>
              <li>
                <span className="font-semibold">Activos: </span>
                {metrics.totalActivos}
              </li>
              <li>
                <span className="font-semibold">Abandonados: </span>
                {metrics.totalAbandonados}
              </li>
              <li>
                <span className="font-semibold">Nuevos: </span>
                {metrics.totalNuevos}
              </li>
              <li>
                <span className="font-semibold">Tasa de retenci√≥n: </span>
                {metrics.tasaRetencion.toFixed(1)}%
              </li>
              <li>
                <span className="font-semibold">Tasa de abandono: </span>
                {metrics.tasaAbandono.toFixed(1)}%
              </li>
            </ul>
          </div>
        </section>

        {/* Usuarios activos */}
        <section className="space-y-2 bg-white border border-emerald-200/40 rounded-xl shadow">
          <div className="px-4 py-3 border-b bg-emerald-50 rounded-t-xl">
            <h2 className="font-semibold text-emerald-900">
              Usuarios activos ({activos.length})
            </h2>
          </div>
          <div className="overflow-x-auto">
            <table className="min-w-full text-xs">
              <thead className="bg-slate-100">
                <tr>
                  <th className="px-2 py-1 text-left">Usuario</th>
                  <th className="px-2 py-1 text-left">Correo</th>
                  <th className="px-2 py-1 text-right">Primera actividad</th>
                  <th className="px-2 py-1 text-right">√öltima actividad</th>
                  <th className="px-2 py-1 text-right">Total acciones</th>
                </tr>
              </thead>
              <tbody>
                {activos.map((u, i) => (
                  <tr key={i} className="border-t">
                    <td className="px-2 py-1">{u.nombre}</td>
                    <td className="px-2 py-1">{u.correo}</td>
                    <td className="px-2 py-1 text-right">
                      {u.primera_actividad || "-"}
                    </td>
                    <td className="px-2 py-1 text-right">
                      {u.ultima_actividad || "-"}
                    </td>
                    <td className="px-2 py-1 text-right">
                      {u.total_acciones}
                    </td>
                  </tr>
                ))}
                {activos.length === 0 && (
                  <tr>
                    <td
                      className="px-2 py-2 text-center text-gray-400"
                      colSpan={5}
                    >
                      Sin datos en el rango.
                    </td>
                  </tr>
                )}
              </tbody>
            </table>
          </div>
        </section>

        {/* Usuarios abandonados */}
        <section className="space-y-2 bg-white border border-emerald-200/40 rounded-xl shadow">
          <div className="px-4 py-3 border-b bg-emerald-50 rounded-t-xl">
            <h2 className="font-semibold text-emerald-900">
              Usuarios abandonados ({abandonados.length})
            </h2>
          </div>
          <div className="overflow-x-auto">
            <table className="min-w-full text-xs">
              <thead className="bg-slate-100">
                <tr>
                  <th className="px-2 py-1 text-left">Usuario</th>
                  <th className="px-2 py-1 text-left">Correo</th>
                  <th className="px-2 py-1 text-right">Estado</th>
                </tr>
              </thead>
              <tbody>
                {abandonados.map((u, i) => (
                  <tr key={i} className="border-t">
                    <td className="px-2 py-1">{u.nombre}</td>
                    <td className="px-2 py-1">{u.correo}</td>
                    <td className="px-2 py-1 text-right">{u.estado}</td>
                  </tr>
                ))}
                {abandonados.length === 0 && (
                  <tr>
                    <td
                      className="px-2 py-2 text-center text-gray-400"
                      colSpan={3}
                    >
                      Sin datos en el rango.
                    </td>
                  </tr>
                )}
              </tbody>
            </table>
          </div>
        </section>

        {/* Usuarios nuevos */}
        <section className="space-y-2 bg-white border border-emerald-200/40 rounded-xl shadow">
          <div className="px-4 py-3 border-b bg-emerald-50 rounded-t-xl">
            <h2 className="font-semibold text-emerald-900">
              Usuarios nuevos (primer login) ({nuevos.length})
            </h2>
          </div>
          <div className="overflow-x-auto">
            <table className="min-w-full text-xs">
              <thead className="bg-slate-100">
                <tr>
                  <th className="px-2 py-1 text-left">Usuario</th>
                  <th className="px-2 py-1 text-left">Correo</th>
                  <th className="px-2 py-1 text-right">Fecha primer login</th>
                </tr>
              </thead>
              <tbody>
                {nuevos.map((u, i) => (
                  <tr key={i} className="border-t">
                    <td className="px-2 py-1">{u.nombre}</td>
                    <td className="px-2 py-1">{u.correo}</td>
                    <td className="px-2 py-1 text-right">
                      {u.fecha_primer_login}
                    </td>
                  </tr>
                ))}
                {nuevos.length === 0 && (
                  <tr>
                    <td
                      className="px-2 py-2 text-center text-gray-400"
                      colSpan={3}
                    >
                      Sin usuarios nuevos en el rango.
                    </td>
                  </tr>
                )}
              </tbody>
            </table>
          </div>
        </section>
      </div>
    </div>
  );
}
</file>

<file path="frontend/src/pages/ReportesUsuariosPremium.jsx">
// src/pages/ReportesUsuariosPremium.jsx
import React, { useEffect, useMemo, useState } from "react";
import { getReporteUsuariosPremium } from "../services/api";
import {
  BarChart,
  Bar,
  XAxis,
  YAxis,
  Tooltip,
  ResponsiveContainer,
  Legend,
  LineChart,
  Line,
} from "recharts";
import hoja from "../assets/hoja.png";

function hoyISO() {
  return new Date().toISOString().slice(0, 10);
}

function hace30DiasISO() {
  const d = new Date(Date.now() - 30 * 24 * 60 * 60 * 1000);
  return d.toISOString().slice(0, 10);
}

export default function ReportesUsuariosPremium() {
  const [desde, setDesde] = useState(hace30DiasISO());
  const [hasta, setHasta] = useState(hoyISO());
  const [datos, setDatos] = useState([]);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState("");

  async function cargar() {
    try {
      setLoading(true);
      setError("");
      const res = await getReporteUsuariosPremium({ desde, hasta });
      setDatos(Array.isArray(res) ? res : []);
    } catch (e) {
      console.error(e);
      setError("Error cargando reporte de usuarios premium");
      setDatos([]);
    } finally {
      setLoading(false);
    }
  }

  useEffect(() => {
    cargar();
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, []);

  function handleSubmit(e) {
    e.preventDefault();
    cargar();
  }

  // =========================
  // M√âTRICAS GLOBALES
  // =========================
  const metrics = useMemo(() => {
    if (!datos.length) {
      return {
        totalUsuariosActivos: 0,
        totalNuevosPremium: 0,
        totalPremiumActivos: 0,
        ingresosTotales: 0,
        adopcionPromedio: 0,
        periodos: 0,
      };
    }

    const totalUsuariosActivos = datos.reduce(
      (acc, r) => acc + Number(r.total_usuarios_activos || 0),
      0
    );
    const totalNuevosPremium = datos.reduce(
      (acc, r) => acc + Number(r.usuarios_nuevos_premium || 0),
      0
    );
    const totalPremiumActivos = datos.reduce(
      (acc, r) => acc + Number(r.usuarios_premium_activos || 0),
      0
    );
    const ingresosTotales = datos.reduce(
      (acc, r) => acc + Number(r.ingresos_suscripcion_bs || 0),
      0
    );

    const porcentajes = datos
      .map((r) => Number(r.porcentaje_adopcion_premium || 0))
      .filter((v) => !Number.isNaN(v));

    const adopcionPromedio =
      porcentajes.length > 0
        ? porcentajes.reduce((a, b) => a + b, 0) / porcentajes.length
        : 0;

    return {
      totalUsuariosActivos,
      totalNuevosPremium,
      totalPremiumActivos,
      ingresosTotales,
      adopcionPromedio,
      periodos: datos.length,
    };
  }, [datos]);

  // =========================
  // DATOS PARA GR√ÅFICOS
  // =========================
  const chartPorPeriodo = useMemo(
    () =>
      datos.map((r, i) => ({
        label: r.desde && r.hasta ? `${r.desde} ‚Üí ${r.hasta}` : `Periodo ${i + 1}`,
        usuariosActivos: Number(r.total_usuarios_activos || 0),
        nuevosPremium: Number(r.usuarios_nuevos_premium || 0),
        premiumActivos: Number(r.usuarios_premium_activos || 0),
        ingresos: Number(r.ingresos_suscripcion_bs || 0),
        adopcion: Number(r.porcentaje_adopcion_premium || 0),
      })),
    [datos]
  );

  return (
    <div
      className="min-h-screen p-8"
      style={{
        background: "linear-gradient(to bottom right, #f0fdf4, #d1fae5)",
        backgroundImage: `url(${hoja})`,
        backgroundRepeat: "no-repeat",
        backgroundPosition: "top right",
        backgroundSize: "160px",
      }}
    >
      <div className="max-w-6xl mx-auto space-y-8">
        {/* HEADER */}
        <header className="flex flex-col md:flex-row md:items-end md:justify-between gap-6">
          <div className="flex items-center gap-4">
            <div className="w-16 h-16 rounded-full bg-white shadow-md flex items-center justify-center border border-emerald-700/20">
              <img src={hoja} alt="Premium verde" className="w-10 h-10" />
            </div>
            <div>
              <h1 className="text-3xl font-extrabold text-emerald-800 drop-shadow">
                Usuarios premium
              </h1>
              <p className="text-sm text-emerald-700/80">
                Adopci√≥n del plan premium e ingresos por suscripci√≥n en el
                rango seleccionado.
              </p>
            </div>
          </div>

          <form
            onSubmit={handleSubmit}
            className="flex flex-wrap gap-4 items-end bg-white/70 px-4 py-3 rounded-xl shadow backdrop-blur text-sm"
          >
            <div className="flex flex-col">
              <label className="mb-1 font-semibold text-emerald-900">
                Desde
              </label>
              <input
                type="date"
                value={desde}
                onChange={(e) => setDesde(e.target.value)}
                className="border rounded px-2 py-1 text-sm shadow-sm"
              />
            </div>
            <div className="flex flex-col">
              <label className="mb-1 font-semibold text-emerald-900">
                Hasta
              </label>
              <input
                type="date"
                value={hasta}
                onChange={(e) => setHasta(e.target.value)}
                className="border rounded px-2 py-1 text-sm shadow-sm"
              />
            </div>
            <button
              type="submit"
              className="bg-emerald-700 hover:bg-emerald-800 text-white px-4 py-2 rounded-lg font-semibold shadow-md"
            >
              {loading ? "Cargando‚Ä¶" : "Actualizar"}
            </button>
          </form>
        </header>

        {error && (
          <div className="bg-red-100 border border-red-300 text-red-700 text-sm px-4 py-2 rounded-lg shadow-sm">
            {error}
          </div>
        )}

        {/* KPIs */}
        <section className="grid md:grid-cols-4 gap-6">
          <div className="bg-white shadow-md border border-emerald-200/40 rounded-xl p-4">
            <p className="text-xs font-semibold text-emerald-700 uppercase">
              Premium activos
            </p>
            <p className="mt-2 text-3xl font-extrabold text-emerald-900">
              {metrics.totalPremiumActivos.toLocaleString()}
            </p>
            <p className="text-[11px] text-emerald-700/80 mt-1">
              Suma de usuarios premium activos en los periodos.
            </p>
          </div>

          <div className="bg-white shadow-md border border-teal-200/60 rounded-xl p-4">
            <p className="text-xs font-semibold text-teal-700 uppercase">
              Nuevos premium
            </p>
            <p className="mt-2 text-3xl font-extrabold text-teal-900">
              {metrics.totalNuevosPremium.toLocaleString()}
            </p>
            <p className="text-[11px] text-teal-700/80 mt-1">
              Nuevas altas de premium en el periodo.
            </p>
          </div>

          <div className="bg-white shadow-md border border-blue-200/60 rounded-xl p-4">
            <p className="text-xs font-semibold text-blue-700 uppercase">
              Ingresos por suscripci√≥n (Bs)
            </p>
            <p className="mt-2 text-3xl font-extrabold text-blue-900">
              {metrics.ingresosTotales.toLocaleString(undefined, {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2,
              })}
            </p>
          </div>

          <div className="bg-white shadow-md border border-emerald-200/60 rounded-xl p-4">
            <p className="text-xs font-semibold text-emerald-700 uppercase">
              Adopci√≥n promedio premium
            </p>
            <p className="mt-2 text-3xl font-extrabold text-emerald-900">
              {metrics.adopcionPromedio.toFixed(1)}%
            </p>
            <p className="text-[11px] text-emerald-700/80 mt-1">
              Promedio de % adopci√≥n en los periodos.
            </p>
          </div>
        </section>

        {/* GR√ÅFICO INGRESOS + ADOPCI√ìN */}
        <section className="grid lg:grid-cols-2 gap-6">
          <div className="bg-white rounded-xl border border-emerald-200/40 shadow p-4">
            <h2 className="text-lg font-semibold text-emerald-900 mb-2">
              Ingresos por suscripciones premium
            </h2>
            <p className="text-xs text-emerald-700/80 mb-3">
              Evoluci√≥n de los ingresos por periodo en el rango seleccionado.
            </p>

            <div className="h-72">
              {chartPorPeriodo.length > 0 ? (
                <ResponsiveContainer>
                  <BarChart data={chartPorPeriodo}>
                    <XAxis dataKey="label" hide />
                    <YAxis />
                    <Tooltip />
                    <Bar
                      dataKey="ingresos"
                      name="Ingresos (Bs)"
                      fill="#1e3a8a"
                      radius={[8, 8, 0, 0]}
                    />
                  </BarChart>
                </ResponsiveContainer>
              ) : (
                <div className="h-full flex items-center justify-center text-xs text-gray-400">
                  Sin datos para mostrar el gr√°fico.
                </div>
              )}
            </div>
          </div>

          <div className="bg-white rounded-xl border border-emerald-200/40 shadow p-4">
            <h2 className="text-lg font-semibold text-emerald-900 mb-2">
              Adopci√≥n premium vs usuarios activos
            </h2>
            <p className="text-xs text-emerald-700/80 mb-3">
              Relaci√≥n entre usuarios activos y porcentaje de adopci√≥n premium.
            </p>

            <div className="h-72">
              {chartPorPeriodo.length > 0 ? (
                <ResponsiveContainer>
                  <LineChart data={chartPorPeriodo}>
                    <XAxis dataKey="label" hide />
                    <YAxis yAxisId="left" />
                    <YAxis
                      yAxisId="right"
                      orientation="right"
                      tickFormatter={(v) => `${v}%`}
                    />
                    <Tooltip />
                    <Legend />
                    <Bar
                      yAxisId="left"
                      dataKey="usuariosActivos"
                      name="Usuarios activos"
                      fill="#047857"
                      radius={[8, 8, 0, 0]}
                    />
                    <Line
                      yAxisId="right"
                      type="monotone"
                      dataKey="adopcion"
                      name="% adopci√≥n premium"
                      stroke="#f59e0b"
                      strokeWidth={2}
                      dot={false}
                    />
                  </LineChart>
                </ResponsiveContainer>
              ) : (
                <div className="h-full flex items-center justify-center text-xs text-gray-400">
                  Sin datos para mostrar el gr√°fico.
                </div>
              )}
            </div>
          </div>
        </section>

        {/* TABLA DETALLADA */}
        <section className="bg-white border border-emerald-200/40 rounded-xl shadow">
          <div className="px-4 py-3 border-b bg-emerald-50 rounded-t-xl">
            <h2 className="font-semibold text-emerald-900">
              Detalle de adopci√≥n premium por periodo
            </h2>
          </div>

          <div className="overflow-x-auto">
            <table className="min-w-full text-sm">
              <thead className="bg-slate-100">
                <tr>
                  <th className="px-2 py-1 text-left">Desde</th>
                  <th className="px-2 py-1 text-left">Hasta</th>
                  <th className="px-2 py-1 text-right">Usuarios activos</th>
                  <th className="px-2 py-1 text-right">Nuevos premium</th>
                  <th className="px-2 py-1 text-right">Premium activos</th>
                  <th className="px-2 py-1 text-right">Ingresos (Bs)</th>
                  <th className="px-2 py-1 text-right">% adopci√≥n</th>
                </tr>
              </thead>
              <tbody>
                {datos.map((r, i) => (
                  <tr key={i} className="border-t">
                    <td className="px-2 py-1">{r.desde}</td>
                    <td className="px-2 py-1">{r.hasta}</td>
                    <td className="px-2 py-1 text-right">
                      {r.total_usuarios_activos}
                    </td>
                    <td className="px-2 py-1 text-right">
                      {r.usuarios_nuevos_premium}
                    </td>
                    <td className="px-2 py-1 text-right">
                      {r.usuarios_premium_activos}
                    </td>
                    <td className="px-2 py-1 text-right">
                      {r.ingresos_suscripcion_bs}
                    </td>
                    <td className="px-2 py-1 text-right">
                      {r.porcentaje_adopcion_premium}%
                    </td>
                  </tr>
                ))}
                {datos.length === 0 && (
                  <tr>
                    <td
                      className="px-2 py-2 text-center text-gray-400"
                      colSpan={7}
                    >
                      Sin datos de suscripciones premium en el rango.
                    </td>
                  </tr>
                )}
              </tbody>
            </table>
          </div>
        </section>
      </div>
    </div>
  );
}
</file>

<file path="frontend/src/pages/Wallet.jsx">
import React, { useEffect, useState } from "react";
import { useNavigate } from "react-router-dom";
import { api } from "../services/api";
import hoja from "../assets/hoja.png";

export default function Wallet() {
  const [saldo, setSaldo] = useState(0);
  const [bloqueado, setBloqueado] = useState(0);
  const [movimientos, setMovimientos] = useState([]);
  const [cargando, setCargando] = useState(true);
  const [error, setError] = useState("");
  const navigate = useNavigate();

  useEffect(() => {
    cargarDatos();
  }, []);

  async function cargarDatos() {
    try {
      setCargando(true);
      setError("");

      const [resCreditos, resMovs] = await Promise.all([
        api("/wallet/mis-creditos"),
        api("/wallet/mis-movimientos"),
      ]);

      // üëá AQU√ç usamos saldo_creditos que viene del backend
      const saldoDisponible =
        resCreditos?.saldo_creditos ??
        resCreditos?.saldo ??
        resCreditos?.creditos ??
        0;

      const saldoBloqueado =
        resCreditos?.saldo_bloqueado ??
        resCreditos?.bloqueado ??
        0;

      setSaldo(saldoDisponible);
      setBloqueado(saldoBloqueado);

      setMovimientos(
        Array.isArray(resMovs) ? resMovs.slice(0, 10) : []
      );
    } catch (err) {
      console.error("Error cargando wallet:", err);
      setError(err.message || "Error al cargar la informaci√≥n de la wallet.");
    } finally {
      setCargando(false);
    }
  }

  if (cargando) {
    return (
      <div className="min-h-screen bg-[#082b1f] text-white flex items-center justify-center">
        Cargando wallet...
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-[#082b1f] text-white p-6 md:p-10">
      {/* HEADER */}
      <div className="flex items-center gap-3 mb-8">
        <img src={hoja} alt="logo" className="w-10 h-10 drop-shadow-lg" />
        <h1 className="text-3xl font-bold text-emerald-400">Mi Wallet</h1>
      </div>

      {/* ERROR */}
      {error && (
        <div className="mb-4 rounded-md border border-red-400 bg-red-900/40 px-4 py-2 text-sm text-red-100">
          {error}
        </div>
      )}

      {/* TARJETAS RESUMEN */}
      <div className="grid gap-6 md:grid-cols-3 mb-10">
        {/* Cr√©ditos disponibles */}
        <div className="rounded-2xl border border-emerald-700 bg-[#0f3f2d] p-6 shadow-lg">
          <p className="text-emerald-200 text-sm mb-2">Cr√©ditos disponibles</p>
          <p className="text-4xl font-bold text-emerald-300">{saldo}</p>
        </div>

        {/* Cr√©ditos bloqueados */}
        <div className="rounded-2xl border border-emerald-700 bg-[#0f3f2d] p-6 shadow-lg">
          <p className="text-emerald-200 text-sm mb-2">Cr√©ditos bloqueados</p>
          <p className="text-4xl font-bold text-yellow-300">{bloqueado}</p>
        </div>

        {/* Acciones r√°pidas */}
        <div className="rounded-2xl border border-emerald-700 bg-[#0f3f2d] p-6 shadow-lg flex flex-col gap-3">
          <p className="text-emerald-200 text-sm mb-2">Acciones r√°pidas</p>

          <button
            onClick={() => navigate("/comprar-creditos")}
            className="w-full rounded-xl bg-emerald-500 hover:bg-emerald-600 py-2 text-sm font-semibold"
          >
            Comprar cr√©ditos
          </button>

          <button
            onClick={() => navigate("/wallet/movimientos")}
            className="w-full rounded-xl bg-[#0f3f2d] border border-emerald-500 hover:bg-emerald-700 py-2 text-sm font-semibold"
          >
            Ver movimientos
          </button>

          <button
            onClick={() => navigate("/wallet/compras")}
            className="w-full rounded-xl bg-[#0f3f2d] border border-emerald-500 hover:bg-emerald-700 py-2 text-sm font-semibold"
          >
            Historial de compras
          </button>
        </div>
      </div>

      {/* √öLTIMOS MOVIMIENTOS */}
      <section className="rounded-2xl border border-emerald-700 bg-[#0f3f2d] p-6 shadow-lg">
        <h2 className="text-xl font-semibold text-emerald-300 mb-4">
          √öltimos movimientos
        </h2>

        {movimientos.length === 0 ? (
          <p className="text-sm text-emerald-100/80">
            A√∫n no tienes movimientos en tu wallet.
          </p>
        ) : (
          <div className="flex flex-col gap-3">
            {movimientos.map((m) => (
              <div
                key={m.id_movimiento}
                className="flex items-center justify-between rounded-xl border border-emerald-700 bg-[#0e3a2a] px-4 py-3"
              >
                <div>
                  <p className="font-semibold text-emerald-200">
                    {m.tipo_movimiento || "MOVIMIENTO"}
                  </p>
                  <p className="text-xs text-emerald-100/70">
                    {m.tipo_referencia || "Sin descripci√≥n"}
                  </p>
                  <p className="text-[11px] text-emerald-100/60 mt-1">
                    {m.creado_en
                      ? new Date(m.creado_en).toLocaleString()
                      : ""}
                  </p>
                </div>

                <div className="text-right">
                  <p
                    className={`font-semibold ${
                      m.cantidad >= 0 ? "text-emerald-300" : "text-red-300"
                    }`}
                  >
                    {m.cantidad >= 0 ? "+" : ""}
                    {m.cantidad} cr.
                  </p>
                  <p className="text-[11px] text-emerald-100/60 mt-1">
                    Saldo: {m.saldo_posterior ?? m.saldo_posterior ?? "-"} cr.
                  </p>
                </div>
              </div>
            ))}
          </div>
        )}
      </section>
    </div>
  );
}
</file>

<file path="frontend/src/router.jsx">
// frontend/src/router.jsx
import React from "react";
import { Routes, Route, Navigate } from "react-router-dom";
import ProtectedRoute from "./components/ProtectedRoute.jsx";
import Layout from "./components/Layout.jsx";

// P√°ginas base
import Login from "./pages/Login.jsx";
import Register from "./pages/Register.jsx";
import Home from "./pages/Home.jsx";
import NotFound from "./pages/NotFound.jsx";

// Perfil
import Perfil from "./pages/Perfil.jsx";
import EditarPerfil from "./pages/EditarPerfil.jsx";

// Wallet
import ComprarCreditos from "./pages/ComprarCreditos.jsx";
import Movimientos from "./pages/Movimientos.jsx";
import HistorialCompras from "./pages/HistorialCompras.jsx";

import Wallet from "./pages/Wallet.jsx";

import Publicaciones from "./pages/Publicaciones.jsx";
import MisPublicaciones from "./pages/MisPublicaciones.jsx";

import PublicacionNueva from "./pages/PublicacionNueva.jsx";

import Intercambios from "./pages/Intercambios.jsx";

import Actividades from "./pages/Actividades.jsx";
import MisActividades from "./pages/MisActividades.jsx";

import Premium from "./pages/Premium.jsx";

import Logros from "./pages/Logros.jsx";
import Promociones from "./pages/Promociones.jsx";

// Reportes men√∫ principal
import Reportes from "./pages/Reportes.jsx";
import Publicidad from "./pages/Publicidad.jsx";


// Reportes individuales
import ReportesUsuarios from "./pages/ReportesUsuarios.jsx";
import ReportesIngresosCreditos from "./pages/ReportesIngresosCreditos.jsx";
import ReportesCreditosGeneradosConsumidos from "./pages/ReportesCreditosGeneradosConsumidos.jsx";
import ReportesIntercambiosCategoria from "./pages/ReportesIntercambiosCategoria.jsx";
import ReportesPublicacionesVsIntercambios from "./pages/ReportesPublicacionesVsIntercambios.jsx";
import ReportesImpactoAcumulado from "./pages/ReportesImpactoAcumulado.jsx";
import ReportesRankingUsuarios from "./pages/ReportesRankingUsuarios.jsx";
import ReportesUsuariosPremium from "./pages/ReportesUsuariosPremium.jsx";
import ReportesSaldosUsuarios from "./pages/ReportesSaldosUsuarios.jsx";
import ReportesActividadesSostenibles from "./pages/ReportesActividadesSostenibles.jsx";
import ReportesImpactoCategoria from "./pages/ReportesImpactoCategoria.jsx";

// Backend lab
import BackendLab from "./pages/BackendLab.jsx";

export default function AppRouter() {
  return (
    <Routes>
      {/* Redirige ra√≠z a login */}
      <Route path="/" element={<Navigate to="/login" replace />} />

      {/* RUTAS P√öBLICAS */}
      <Route path="/login" element={<Login />} />
      <Route path="/register" element={<Register />} />

      {/* ------------------------------- */}
      {/*         RUTAS PROTEGIDAS        */}
      {/* ------------------------------- */}

      {/* HOME */}
      <Route
        path="/home"
        element={
          <ProtectedRoute>
            <Layout>
              <Home />
            </Layout>
          </ProtectedRoute>
        }
      />

      {/* PERFIL */}
      <Route
        path="/perfil"
        element={
          <ProtectedRoute>
            <Layout>
              <Perfil />
            </Layout>
          </ProtectedRoute>
        }
      />

      {/* EDITAR PERFIL (NUEVO, FUNCIONAL) */}
      <Route
        path="/perfil/editar"
        element={
          <ProtectedRoute>
            <Layout>
              <EditarPerfil />
            </Layout>
          </ProtectedRoute>
        }
      />

        <Route
          path="/wallet"
          element={
            <ProtectedRoute>
              <Wallet />
            </ProtectedRoute>
          }
        />
            {/* WALLET */}
      <Route
        path="/comprar-creditos"
        element={
          <ProtectedRoute>
            <Layout>
              <ComprarCreditos />
            </Layout>
          </ProtectedRoute>
        }
      />

      <Route
        path="/wallet/movimientos"
        element={
          <ProtectedRoute>
            <Layout>
              <Movimientos />
            </Layout>
          </ProtectedRoute>
        }
      />

      <Route
        path="/wallet/compras"
        element={
          <ProtectedRoute>
            <Layout>
              <HistorialCompras />
            </Layout>
          </ProtectedRoute>
        }
      />

      <Route
        path="/publicaciones"
        element={
          <ProtectedRoute>
            <Layout>
              <Publicaciones />
            </Layout>
          </ProtectedRoute>
        }
      />

      <Route
        path="/publicaciones/mias"
        element={
          <ProtectedRoute>
            <Layout>
              <MisPublicaciones />
            </Layout>
          </ProtectedRoute>
        }
      />

      <Route
        path="/publicaciones/nueva"
        element={
          <ProtectedRoute>
            <Layout>
              <PublicacionNueva />
            </Layout>
          </ProtectedRoute>
        }
      />

      <Route
        path="/intercambios"
        element={
          <ProtectedRoute>
            <Layout>
              <Intercambios />
            </Layout>
          </ProtectedRoute>
        }
      />

      <Route
        path="/actividades"
        element={
          <ProtectedRoute>
            <Layout>
              <Actividades />
            </Layout>
          </ProtectedRoute>
        }
      />

      <Route
        path="/actividades/mias"
        element={
          <ProtectedRoute>
            <Layout>
              <MisActividades />
            </Layout>
          </ProtectedRoute>
        }
      />

    <Route
      path="/premium"
      element={
        <ProtectedRoute>
          <Layout>
            <Premium />
          </Layout>
        </ProtectedRoute>
      }
    />
      <Route
      path="/logros"
      element={
        <ProtectedRoute>
          <Layout>
            <Logros />
          </Layout>
        </ProtectedRoute>
      }
    />
    <Route
      path="/promociones"
      element={
        <ProtectedRoute>
          <Layout>
            <Promociones />
          </Layout>
        </ProtectedRoute>
      }
    />

      <Route
        path="/publicidad"
        element={
          <ProtectedRoute>
            <Layout>
              <Publicidad />
            </Layout>
          </ProtectedRoute>
        }
      />

      {/* REPORTES */}
      <Route
        path="/reportes"
        element={
          <ProtectedRoute>
            <Layout>
              <Reportes />
            </Layout>
          </ProtectedRoute>
        }
      />

      {/* REPORTES INDIVIDUALES */}
      <Route
        path="/reportes/usuarios"
        element={
          <ProtectedRoute>
            <Layout>
              <ReportesUsuarios />
            </Layout>
          </ProtectedRoute>
        }
      />

      <Route
        path="/reportes/ingresos-creditos"
        element={
          <ProtectedRoute>
            <Layout>
              <ReportesIngresosCreditos />
            </Layout>
          </ProtectedRoute>
        }
      />

      <Route
        path="/reportes/creditos-generados-consumidos"
        element={
          <ProtectedRoute>
            <Layout>
              <ReportesCreditosGeneradosConsumidos />
            </Layout>
          </ProtectedRoute>
        }
      />

      <Route
        path="/reportes/intercambios-categoria"
        element={
          <ProtectedRoute>
            <Layout>
              <ReportesIntercambiosCategoria />
            </Layout>
          </ProtectedRoute>
        }
      />

      <Route
        path="/reportes/publicaciones-intercambios"
        element={
          <ProtectedRoute>
            <Layout>
              <ReportesPublicacionesVsIntercambios />
            </Layout>
          </ProtectedRoute>
        }
      />

      <Route
        path="/reportes/impacto-acumulado"
        element={
          <ProtectedRoute>
            <Layout>
              <ReportesImpactoAcumulado />
            </Layout>
          </ProtectedRoute>
        }
      />

      <Route
        path="/reportes/ranking-usuarios"
        element={
          <ProtectedRoute>
            <Layout>
              <ReportesRankingUsuarios />
            </Layout>
          </ProtectedRoute>
        }
      />

      <Route
        path="/reportes/usuarios-premium"
        element={
          <ProtectedRoute>
            <Layout>
              <ReportesUsuariosPremium />
            </Layout>
          </ProtectedRoute>
        }
      />

      <Route
        path="/reportes/saldos-usuarios"
        element={
          <ProtectedRoute>
            <Layout>
              <ReportesSaldosUsuarios />
            </Layout>
          </ProtectedRoute>
        }
      />

      <Route
        path="/reportes/actividades-sostenibles"
        element={
          <ProtectedRoute>
            <Layout>
              <ReportesActividadesSostenibles />
            </Layout>
          </ProtectedRoute>
        }
      />

      <Route
        path="/reportes/impacto-categoria"
        element={
          <ProtectedRoute>
            <Layout>
              <ReportesImpactoCategoria />
            </Layout>
          </ProtectedRoute>
        }
      />

      {/* LABORATORIO BACKEND */}
      <Route
        path="/backend-lab"
        element={
          <ProtectedRoute>
            <Layout>
              <BackendLab />
            </Layout>
          </ProtectedRoute>
        }
      />

      {/* 404 */}
      <Route path="*" element={<NotFound />} />
    </Routes>
  );
}
</file>

<file path="frontend/src/services/api.js">
// frontend/src/services/api.js
const API_URL = import.meta.env.VITE_API_URL ?? "http://localhost:4000/api";

function authHeaders() {
  const token = localStorage.getItem("token");
  if (!token) return {};
  return {
    Authorization: `Bearer ${token}`,
  };
}

export async function api(path, { method = "GET", body, headers = {} } = {}) {
  const isJsonBody = body && !(body instanceof FormData);

  const res = await fetch(`${API_URL}${path}`, {
    method,
    headers: {
      ...(isJsonBody ? { "Content-Type": "application/json" } : {}),
      ...authHeaders(),
      ...headers,
    },
    body: isJsonBody ? JSON.stringify(body) : body,
  });

  const text = await res.text();

  if (!res.ok) {
    let message =
      res.statusText || `Error HTTP ${res.status}` || "Error en la solicitud";

    if (text) {
      try {
        const parsed = JSON.parse(text);
        if (parsed && parsed.message) {
          message = parsed.message;
        }
      } catch {
        message = text;
      }
    }

    throw new Error(message);
  }

  if (!text) {
    return null;
  }

  try {
    return JSON.parse(text);
  } catch {
    console.warn("Respuesta no JSON para", path, "=>", text);
    return text;
  }
}

export async function login({ correo, password }) {
  const data = await api("/auth/login", {
    method: "POST",
    body: { correo, password },
  });

  if (data?.token) {
    localStorage.setItem("token", data.token);
    if (data.usuario) {
      localStorage.setItem("usuario", JSON.stringify(data.usuario));
    }
  }

  return data;
}

export function logout() {
  localStorage.removeItem("token");
  localStorage.removeItem("usuario");
}

export async function getHealth() {
  return api("/health");
}

function buildRangeQuery(desde, hasta) {
  const params = new URLSearchParams();
  if (desde) params.append("desde", desde);
  if (hasta) params.append("hasta", hasta);
  const qs = params.toString();
  return qs ? `?${qs}` : "";
}

export async function register({ nombre, apellido, correo, password, telefono }) {
  return api("/auth/register", {
    method: "POST",
    body: { nombre, apellido, correo, password, telefono },
  });
}

//REPORTES

// Usuarios activos
export function getReporteUsuariosActivos({ desde, hasta } = {}) {
  return api(`/reportes/usuarios-activos${buildRangeQuery(desde, hasta)}`);
}

// Usuarios abandonados
export function getReporteUsuariosAbandonados({ desde, hasta } = {}) {
  return api(`/reportes/usuarios-abandonados${buildRangeQuery(desde, hasta)}`);
}

// Ingresos por venta de cr√©ditos
export function getReporteIngresosCreditos({ desde, hasta } = {}) {
  return api(`/reportes/ingresos-creditos${buildRangeQuery(desde, hasta)}`);
}

// Cr√©ditos generados vs consumidos
export function getReporteCreditosGeneradosVsConsumidos({ desde, hasta } = {}) {
  return api(
    `/reportes/creditos-generados-consumidos${buildRangeQuery(desde, hasta)}`
  );
}

// Intercambios por categor√≠a
export function getReporteIntercambiosCategoria({ desde, hasta } = {}) {
  return api(
    `/reportes/intercambios-categoria${buildRangeQuery(desde, hasta)}`
  );
}

// Publicaciones vs intercambios
export function getReportePublicacionesVsIntercambios({ desde, hasta } = {}) {
  return api(
    `/reportes/publicaciones-vs-intercambios${buildRangeQuery(desde, hasta)}`
  );
}

// Impacto acumulado (REPORTE_IMPACTO)
export function getReporteImpactoAcumulado({ idTipoReporte, idPeriodo }) {
  const params = new URLSearchParams();
  if (idTipoReporte != null) params.append("idTipoReporte", idTipoReporte);
  if (idPeriodo != null) params.append("idPeriodo", idPeriodo);
  const qs = params.toString();
  return api(`/reportes/impacto-acumulado?${qs}`);
}

//REPORTES 

// Ranking de usuarios por impacto
export function getReporteRankingUsuarios({ idPeriodo = null, limit = 10 } = {}) {
  const params = new URLSearchParams();
  if (idPeriodo != null && idPeriodo !== "") {
    params.append("idPeriodo", idPeriodo);
  }
  if (limit != null) {
    params.append("limit", String(limit));
  }
  const qs = params.toString();
  return api(`/reportes/ranking-usuarios?${qs}`);
}

// Usuarios premium
export function getReporteUsuariosPremium({ desde, hasta } = {}) {
  return api(`/reportes/usuarios-premium${buildRangeQuery(desde, hasta)}`);
}

// Usuarios nuevos (primer login)
export function getReporteUsuariosNuevos({ desde, hasta } = {}) {
  return api(`/reportes/usuarios-nuevos${buildRangeQuery(desde, hasta)}`);
}

// Saldos de cr√©ditos por usuario (top N)
export function getReporteSaldosUsuarios({ limit = 20 } = {}) {
  const params = new URLSearchParams();
  params.append("limit", String(limit));
  const qs = params.toString();
  return api(`/reportes/saldos-usuarios?${qs}`);
}

// Actividades sostenibles por usuario
export function getReporteActividadesSostenibles({ desde, hasta } = {}) {
  return api(
    `/reportes/actividades-sostenibles${buildRangeQuery(desde, hasta)}`
  );
}

// Impacto ambiental por categor√≠a
export function getReporteImpactoPorCategoria({ idPeriodo }) {
  const params = new URLSearchParams();
  if (idPeriodo != null) params.append("idPeriodo", idPeriodo);
  const qs = params.toString();
  return api(`/reportes/impacto-categoria?${qs}`);
}
// ================= WALLET / CR√âDITOS =================

// Saldo de cr√©ditos del usuario logueado
// GET /api/wallet/mis-creditos
export function getMisCreditos() {
  return api("/wallet/mis-creditos");
}

// Movimientos de la billetera
// GET /api/wallet/mis-movimientos
export function getMisMovimientos() {
  return api("/wallet/mis-movimientos");
}

// Paquetes de cr√©ditos disponibles
// GET /api/catalogos/paquetes-creditos  (ajusta si tu ruta es otra)
export function getPaquetesCreditos() {
  return api("/catalogos/paquetes-creditos");
}

// Registrar compra de un paquete de cr√©ditos
// POST /api/wallet/compra-creditos
export function crearCompraCreditos({ idPaquete, idTransaccionPago = null }) {
  return api("/wallet/compra-creditos", {
    method: "POST",
    body: {
      idPaquete,
      idTransaccionPago,
    },
  });
}

// Historial de compras de cr√©ditos
// GET /api/wallet/compras
export function getMisComprasCreditos() {
  return api("/wallet/compras");
}

// ================= INTERCAMBIOS =================

// Crear un intercambio (comprar una publicaci√≥n con cr√©ditos)
// body: { id_publicacion, creditos }
export function crearIntercambio({ id_publicacion, creditos }) {
  return api("/intercambios", {
    method: "POST",
    body: { id_publicacion, creditos },
  });
}

// Listar mis compras (donde yo soy el comprador)
export function getMisComprasIntercambios() {
  return api("/intercambios/mis-compras");
}

// Listar mis ventas (donde yo soy el vendedor)
export function getMisVentasIntercambios() {
  return api("/intercambios/mis-ventas");
}

// Detalle de una transacci√≥n individual
export function getDetalleTransaccion(idTransaccion) {
  return api(`/intercambios/${idTransaccion}`);
}
// =============== ACTIVIDADES SOSTENIBLES ===============

// Registrar una nueva actividad sostenible del usuario actual
export function registrarActividadSostenible({
  id_tipo_actividad,
  descripcion,
  creditos_otorgados,
  evidencia_url,
}) {
  return api("/actividades-sostenibles", {
    method: "POST",
    body: {
      id_tipo_actividad,
      descripcion,
      creditos_otorgados,
      evidencia_url,
    },
  });
}

// Obtener MIS actividades sostenibles (historial)
export function getMisActividadesSostenibles() {
  return api("/actividades-sostenibles/mias");
}

// =============== LOGROS ===============

// Lista de logros ganados por el usuario actual
export function getMisLogros() {
  return api("/logros/mios");
}
// =============== PROMOCIONES ===============

// Listar todas las promociones (admin)
export function getPromociones() {
  return api("/promociones");
}

// Crear una nueva promoci√≥n
export function crearPromocion(body) {
  return api("/promociones", {
    method: "POST",
    body,
  });
}

// Cambiar estado de una promoci√≥n (ACTIVA / INACTIVA / etc.)
export function cambiarEstadoPromocion(id_promocion, estado) {
  return api(`/promociones/${id_promocion}/estado`, {
    method: "PATCH",
    body: { estado },
  });
}

// Vincular una publicaci√≥n a una promoci√≥n
export function vincularPublicacionPromocion(id_promocion, id_publicacion) {
  return api(`/promociones/${id_promocion}/publicaciones`, {
    method: "POST",
    body: { id_publicacion },
  });
}
// =============== PUBLICIDAD ===============

// Listar publicidad activa (usa GET /api/publicidad)
export function getPublicidadActiva() {
  return api("/publicidad");          // üëà AQU√ç EL CAMBIO
}

// Crear una nueva campa√±a de publicidad
export function crearPublicidad(body) {
  return api("/publicidad", {
    method: "POST",
    body,
  });
}
</file>

<file path="frontend/tailwind.config.js">
/** @type {import('tailwindcss').Config} */
module.exports = {
  content: [
    "./index.html",
    "./src/**/*.{js,jsx,ts,tsx}"
  ],
  theme: {
    extend: {}
  },
  plugins: []
};
</file>

<file path="frontend/vite.config.js">
import { defineConfig } from "vite";
import react from "@vitejs/plugin-react";

export default defineConfig({
  plugins: [react()],
  server: {
    port: 5173
  }
});
</file>

<file path="package.json">
{
  "name": "iu-db-monorepo",
  "private": true,
  "version": "0.1.0",
  "scripts": {
    "dev": "npm-run-all --parallel dev:front dev:back",
    "dev:front": "npm --prefix frontend run dev",
    "dev:back": "npm --prefix backend run dev",
    "build": "npm-run-all build:front build:back",
    "build:front": "npm --prefix frontend run build",
    "build:back": "npm --prefix backend run build",
    "db:migrate": "npm --prefix backend run prisma:migrate",
    "db:seed": "npm --prefix backend run prisma:seed"
  },
  "devDependencies": {
    "npm-run-all": "^4.1.5"
  }
}
</file>

<file path="README.md">
# Monorepo: UI + API + DB (React + Vite + Tailwind / Node + Express + Prisma / MySQL)

## Dev r√°pido
```bash
# en la ra√≠z
npm install
npm run dev
```

## Requisitos
- Node 18+
- Docker (opcional para DB)

## Estructura
- `frontend/` React + Vite + Tailwind
- `backend/`  Node + Express + Prisma (MySQL)
- `infra/db/` SQL de init y seeds
</file>

</files>
