This file is a merged representation of the entire codebase, combined into a single document by Repomix.

<file_summary>
This section contains a summary of this file.

<purpose>
This file contains a packed representation of the entire repository's contents.
It is designed to be easily consumable by AI systems for analysis, code review,
or other automated processes.
</purpose>

<file_format>
The content is organized as follows:
1. This summary section
2. Repository information
3. Directory structure
4. Repository files (if enabled)
5. Multiple file entries, each consisting of:
  - File path as an attribute
  - Full contents of the file
</file_format>

<usage_guidelines>
- This file should be treated as read-only. Any changes should be made to the
  original repository files, not this packed version.
- When processing this file, use the file path to distinguish
  between different files in the repository.
- Be aware that this file may contain sensitive information. Handle it with
  the same level of security as you would the original repository.
</usage_guidelines>

<notes>
- Some files may have been excluded based on .gitignore rules and Repomix's configuration
- Binary files are not included in this packed representation. Please refer to the Repository Structure section for a complete list of file paths, including binary files
- Files matching patterns in .gitignore are excluded
- Files matching default ignore patterns are excluded
- Files are sorted by Git change count (files with more changes are at the bottom)
</notes>

</file_summary>

<directory_structure>
.gitignore
backend/Dockerfile
backend/package.json
backend/prisma/schema.prisma
backend/prisma/seed.js
backend/repomix-output.xml
backend/src/app.js
backend/src/config/env.js
backend/src/config/prisma.js
backend/src/middlewares/auth.js
backend/src/middlewares/errorHandler.js
backend/src/middlewares/isAdmin.js
backend/src/modules/actividades/actividades.controller.js
backend/src/modules/actividades/actividades.routes.js
backend/src/modules/actividades/actividades.service.js
backend/src/modules/auth/auth.controller.js
backend/src/modules/auth/auth.routes.js
backend/src/modules/auth/auth.service.js
backend/src/modules/bitacoras/bitacoras.controller.js
backend/src/modules/bitacoras/bitacoras.routes.js
backend/src/modules/bitacoras/bitacoras.service.js
backend/src/modules/catalogos/catalogos.controller.js
backend/src/modules/catalogos/catalogos.routes.js
backend/src/modules/catalogos/catalogos.service.js
backend/src/modules/intercambios/intercambios.controller.js
backend/src/modules/intercambios/intercambios.routes.js
backend/src/modules/intercambios/intercambios.service.js
backend/src/modules/logros/logros.controller.js
backend/src/modules/logros/logros.routes.js
backend/src/modules/logros/logros.service.js
backend/src/modules/premium/premium.controller.js
backend/src/modules/premium/premium.routes.js
backend/src/modules/premium/premium.service.js
backend/src/modules/promociones/promociones.controller.js
backend/src/modules/promociones/promociones.routes.js
backend/src/modules/promociones/promociones.service.js
backend/src/modules/publicaciones/publicaciones.controller.js
backend/src/modules/publicaciones/publicaciones.routes.js
backend/src/modules/publicaciones/publicaciones.service.js
backend/src/modules/publicidad/publicidad.controller.js
backend/src/modules/publicidad/publicidad.routes.js
backend/src/modules/publicidad/publicidad.service.js
backend/src/modules/reportes/reportes.controller.js
backend/src/modules/reportes/reportes.routes.js
backend/src/modules/uploads/multer.js
backend/src/modules/uploads/uploads.controller.js
backend/src/modules/uploads/uploads.routes.js
backend/src/modules/uploads/uploads.service.js
backend/src/modules/usuarios/usuarios.controller.js
backend/src/modules/usuarios/usuarios.routes.js
backend/src/modules/usuarios/usuarios.service.js
backend/src/modules/wallet/wallet.controller.js
backend/src/modules/wallet/wallet.routes.js
backend/src/modules/wallet/wallet.service.js
backend/src/routes/index.js
backend/src/server.js
backend/uploads_storage/1717f8c0-ba65-48b3-80da-d06a474dd514.png
backend/uploads_storage/1814c878-9e38-43ac-b657-1ed3a8e7acd7.png
backend/uploads_storage/5ec162af-5dcc-410f-9c9b-e75890e67e71.png
backend/uploads_storage/cb6b319f-881d-4f8a-8a5e-9f8eecd10402.png
backend/uploads_storage/d6b3b8be-16ba-41bc-b958-7ab0c3e14e38.png
backend/uploads_storage/fc1090e9-4161-4b16-bd33-44e34e431740.png
backend/utils/jsonBigInt.js
docker-compose.yml
frontend/index.html
frontend/package.json
frontend/postcss.config.js
frontend/src/App.jsx
frontend/src/assets/aurela.png
frontend/src/assets/aurella.png
frontend/src/assets/hoja.png
frontend/src/assets/publicit.png
frontend/src/assets/TomCruise.png
frontend/src/components/Layout.jsx
frontend/src/components/Navbar.jsx
frontend/src/components/ProtectedRoute.jsx
frontend/src/index.css
frontend/src/main.jsx
frontend/src/pages/Actividades.jsx
frontend/src/pages/ActividadesAdmin.jsx
frontend/src/pages/BackendLab.jsx
frontend/src/pages/ComprarCreditos.jsx
frontend/src/pages/EditarPerfil.jsx
frontend/src/pages/HistorialCompras.jsx
frontend/src/pages/Home.jsx
frontend/src/pages/IntercambioDetalle.jsx
frontend/src/pages/Intercambios.jsx
frontend/src/pages/Login.jsx
frontend/src/pages/Logros.jsx
frontend/src/pages/MisActividades.jsx
frontend/src/pages/MisPublicaciones.jsx
frontend/src/pages/Movimientos.jsx
frontend/src/pages/NotFound.jsx
frontend/src/pages/Perfil.jsx
frontend/src/pages/Premium.jsx
frontend/src/pages/Promociones.jsx
frontend/src/pages/Publicaciones.jsx
frontend/src/pages/PublicacionNueva.jsx
frontend/src/pages/Publicidad.jsx
frontend/src/pages/Register.jsx
frontend/src/pages/Reportes.jsx
frontend/src/pages/ReportesActividadesSostenibles.jsx
frontend/src/pages/ReportesCreditosGeneradosConsumidos.jsx
frontend/src/pages/ReportesImpactoAcumulado.jsx
frontend/src/pages/ReportesImpactoCategoria.jsx
frontend/src/pages/ReportesIngresosCreditos.jsx
frontend/src/pages/ReportesIntercambiosCategoria.jsx
frontend/src/pages/ReportesPublicacionesVsIntercambios.jsx
frontend/src/pages/ReportesRankingUsuarios.jsx
frontend/src/pages/ReportesSaldosUsuarios.jsx
frontend/src/pages/ReportesUsuarios.jsx
frontend/src/pages/ReportesUsuariosPremium.jsx
frontend/src/pages/Wallet.jsx
frontend/src/router.jsx
frontend/src/services/api.js
frontend/tailwind.config.js
frontend/vite.config.js
package.json
README.md
</directory_structure>

<files>
This section contains the contents of the repository's files.

<file path=".gitignore">
node_modules
dist
.env
.env.*
.prisma
.DS_Store
</file>

<file path="backend/Dockerfile">
# simple dev image; optional
FROM node:18-alpine
WORKDIR /app
COPY package*.json ./
RUN npm install
COPY . .
EXPOSE 4000
CMD ["npm","run","start"]
</file>

<file path="backend/package.json">
{
  "name": "backend",
  "private": true,
  "version": "0.1.0",
  "type": "module",
  "scripts": {
    "dev": "node --watch src/server.js",
    "start": "node src/server.js",
    "prisma:generate": "prisma generate",
    "prisma:migrate": "prisma migrate dev --name init",
    "prisma:deploy": "prisma migrate deploy",
    "prisma:seed": "node prisma/seed.js",
    "studio": "prisma studio"
  },
  "dependencies": {
    "@prisma/client": "^6.19.0",
    "bcryptjs": "^2.4.3",
    "cors": "^2.8.5",
    "dotenv": "^16.4.5",
    "express": "^4.21.1",
    "helmet": "^7.1.0",
    "jsonwebtoken": "^9.0.2",
    "morgan": "^1.10.1",
    "multer": "^2.0.2",
    "uuid": "^13.0.0"
  },
  "devDependencies": {
    "prisma": "^6.19.0"
  }
}
</file>

<file path="backend/prisma/schema.prisma">
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model actividad_sostenible {
  id_actividad       Int      @id @default(autoincrement())
  id_usuario         Int
  id_tipo_actividad  Int
  descripcion        String   @db.Text
  creditos_otorgados Int
  evidencia_url      String?  @db.VarChar(500)
  creado_en          DateTime @default(now()) @db.DateTime(0)

  @@index([id_tipo_actividad], map: "fk_act_tipo")
  @@index([id_usuario], map: "fk_act_usuario")
  @@index([creado_en], map: "ix_actsost_creado_en")
}

model billetera {
  id_billetera    Int               @id @default(autoincrement())
  id_usuario      Int               @unique(map: "id_usuario")
  estado          billetera_estado? @default(ACTIVA)
  saldo_creditos  BigInt?           @default(0)
  saldo_bs        Decimal?          @default(0.00) @db.Decimal(12, 2)
  cuenta_bancaria String?           @db.VarChar(100)
}

model bitacora_acceso {
  id_acceso    Int      @id @default(autoincrement())
  id_usuario   Int
  fecha        DateTime @default(now()) @db.DateTime(0)
  direccion_ip String   @db.VarChar(45)
  user_agent   String?  @db.VarChar(500)
  id_resultado Int

  @@index([id_resultado], map: "fk_bitacc_resultado")
  @@index([id_usuario, fecha], map: "ix_bitacceso_usuario_fecha")
}

model bitacora_intercambio {
  id_bitacora        Int     @id @default(autoincrement())
  id_transaccion     Int
  id_usuario_origen  Int
  id_usuario_destino Int
  cantidad_creditos  BigInt
  descripcion        String? @db.VarChar(500)

  @@index([id_usuario_destino], map: "fk_bi_usr_destino")
  @@index([id_usuario_origen], map: "fk_bi_usr_origen")
  @@index([id_transaccion], map: "ix_bitacora_trx")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model calificacion {
  id_calificacion Int     @id @default(autoincrement())
  id_usuario      Int
  id_publicacion  Int
  estrellas       Int     @db.TinyInt
  comentario      String? @db.VarChar(300)

  @@unique([id_usuario, id_publicacion], map: "id_usuario")
  @@index([id_publicacion], map: "fk_calif_publicacion")
}

model categoria {
  id_categoria Int     @id @default(autoincrement())
  nombre       String  @unique(map: "nombre") @db.VarChar(100)
  descripcion  String? @db.VarChar(255)
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model compra_creditos {
  id_compra           Int                     @id @default(autoincrement())
  id_usuario          Int
  id_paquete          Int
  monto_bs            Decimal                 @db.Decimal(12, 2)
  estado              compra_creditos_estado? @default(PENDIENTE)
  id_transaccion_pago String?                 @unique(map: "id_transaccion_pago") @db.VarChar(255)
  creado_en           DateTime                @default(now()) @db.DateTime(0)

  @@index([id_paquete], map: "fk_compra_paquete")
  @@index([id_usuario], map: "fk_compra_usuario")
  @@index([estado], map: "ix_compra_estado")
  @@index([creado_en], map: "ix_compra_creado_en")
}

model dimension_ambiental {
  id_dimension Int     @id @default(autoincrement())
  codigo       String  @unique(map: "codigo") @db.VarChar(30)
  nombre       String  @db.VarChar(100)
  unidad_base  String? @db.VarChar(20)
  descripcion  String? @db.VarChar(255)
}

model equivalencia_impacto {
  id_equivalencia    Int     @id @default(autoincrement())
  id_categoria       Int
  id_um              Int?
  co2_por_unidad     Decimal @db.Decimal(12, 6)
  agua_por_unidad    Decimal @db.Decimal(12, 6)
  energia_por_unidad Decimal @db.Decimal(12, 6)

  @@unique([id_categoria, id_um], map: "id_categoria")
  @@index([id_um], map: "fk_eq_um")
}

model evento_ambiental {
  id_evento              Int                     @id @default(autoincrement())
  id_usuario             Int
  id_dimension           Int
  fuente                 evento_ambiental_fuente
  id_fuente              Int
  categoria              String?                 @db.VarChar(100)
  valor                  Decimal                 @db.Decimal(18, 6)
  id_um                  Int?
  contaminacion_reducida Decimal?                @db.Decimal(18, 6)
  descripcion            String?                 @db.VarChar(255)

  @@index([id_dimension], map: "fk_ev_dimension")
  @@index([id_um], map: "fk_ev_um")
  @@index([id_usuario], map: "fk_ev_usuario")
}

model impacto_ambiental {
  id_impacto       Int     @id @default(autoincrement())
  id_usuario       Int
  id_transaccion   Int
  id_categoria     Int
  co2_ahorrado     Decimal @db.Decimal(12, 6)
  agua_ahorrada    Decimal @db.Decimal(12, 6)
  energia_ahorrada Decimal @db.Decimal(12, 6)
  id_periodo       Int

  @@index([id_transaccion], map: "fk_imp_tx")
  @@index([id_categoria], map: "ix_impa_categoria")
  @@index([id_periodo], map: "ix_impa_periodo")
  @@index([id_usuario, id_periodo], map: "ix_impa_usuario_periodo")
}

model logro {
  id_logro            Int     @id @default(autoincrement())
  id_tipo_logro       Int
  nombre              String  @db.VarChar(100)
  descripcion         String? @db.VarChar(255)
  meta_requerida      BigInt
  creditos_recompensa BigInt

  @@index([id_tipo_logro], map: "fk_logro_tipo")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model movimiento_creditos {
  id_movimiento      Int      @id @default(autoincrement())
  id_usuario         Int
  id_tipo_movimiento Int
  id_tipo_referencia Int
  cantidad           BigInt
  descripcion        String?  @db.VarChar(255)
  saldo_anterior     BigInt
  saldo_posterior    BigInt
  id_referencia      Int?
  creado_en          DateTime @default(now()) @db.DateTime(0)

  @@index([id_tipo_movimiento], map: "fk_mov_tipomov")
  @@index([id_movimiento], map: "ix_mov_creado")
  @@index([id_tipo_referencia], map: "ix_mov_tiporef")
  @@index([id_usuario, id_movimiento], map: "ix_mov_usuario")
  @@index([creado_en], map: "ix_mov_creado_en")
}

model paquete_creditos {
  id_paquete        Int     @id @default(autoincrement())
  nombre            String  @unique(map: "nombre") @db.VarChar(100)
  cantidad_creditos BigInt
  precio_bs         Decimal @db.Decimal(12, 2)
  activo            Boolean @default(true)
}

model periodo {
  id_periodo   Int       @id @default(autoincrement())
  nombre       String    @unique(map: "nombre") @db.VarChar(50)
  descripcion  String?   @db.VarChar(255)
  fecha_inicio DateTime? @db.Date
  fecha_fin    DateTime? @db.Date

  @@index([fecha_inicio, fecha_fin], map: "ix_periodo_rango")
}

model permiso {
  id_permiso  Int     @id @default(autoincrement())
  nombre      String  @unique(map: "nombre") @db.VarChar(100)
  descripcion String? @db.VarChar(255)
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model producto {
  id_producto  Int      @id @default(autoincrement())
  id_categoria Int
  nombre       String   @db.VarChar(255)
  descripcion  String?  @db.VarChar(255)
  precio       Decimal? @db.Decimal(12, 2)
  peso         Decimal? @db.Decimal(10, 2)

  @@index([id_categoria], map: "fk_producto_categoria")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model promocion {
  id_promocion       Int               @id @default(autoincrement())
  id_tipo_promocion  Int
  nombre             String            @db.VarChar(100)
  descripcion        String?           @db.VarChar(255)
  creditos_otorgados BigInt
  fecha_inicio       DateTime          @db.DateTime(0)
  fecha_fin          DateTime          @db.DateTime(0)
  estado             promocion_estado? @default(PROGRAMADA)

  @@index([id_tipo_promocion], map: "fk_promocion_tipo")
  @@index([estado, fecha_inicio, fecha_fin], map: "ix_promocion_activa")
}

model promocion_publicacion {
  id_promocion   Int
  id_publicacion Int

  @@id([id_promocion, id_publicacion])
  @@index([id_promocion], map: "ix_promopub_prom")
  @@index([id_publicacion], map: "ix_promopub_pub")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model publicacion {
  id_publicacion      Int                 @id @default(autoincrement())
  id_usuario          Int
  id_categoria        Int
  id_tipo_publicacion Int
  estado              publicacion_estado? @default(PUBLICADA)
  id_ubicacion        Int?
  titulo              String              @db.VarChar(200)
  descripcion         String              @db.Text
  valor_creditos      BigInt
  imagen_url          String?             @db.VarChar(500)
  creado_en           DateTime            @default(now()) @db.DateTime(0)

  @@index([id_tipo_publicacion], map: "fk_publicacion_tipopub")
  @@index([id_ubicacion], map: "fk_publicacion_ubicacion")
  @@index([id_categoria, estado], map: "ix_pub_categoria_estado")
  @@index([id_usuario, estado], map: "ix_pub_usuario_estado")
  @@index([creado_en], map: "ix_pub_creado_en")
  @@fulltext([titulo, descripcion], map: "ft_pub_titulo_desc")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model publicacion_producto {
  id_publicacion Int
  id_producto    Int
  cantidad       Decimal @db.Decimal(15, 4)
  id_um          Int

  @@id([id_publicacion, id_producto])
  @@index([id_producto], map: "fk_pprd_producto")
  @@index([id_um], map: "fk_pprd_um")
}

model publicacion_servicio {
  id_publicacion Int
  id_servicio    Int
  horario        String @db.VarChar(100)

  @@id([id_publicacion, id_servicio])
  @@index([id_servicio], map: "fk_pserv_servicio")
}

model publicidad {
  id_publicidad  Int                @id @default(autoincrement())
  id_usuario     Int
  id_ubicacion   Int
  estado         publicidad_estado? @default(PROGRAMADA)
  titulo         String             @db.VarChar(200)
  descripcion    String?            @db.VarChar(255)
  url_destino    String?            @db.VarChar(500)
  fecha_inicio   DateTime           @db.DateTime(0)
  fecha_fin      DateTime           @db.DateTime(0)
  costo_creditos BigInt

  @@index([id_ubicacion], map: "fk_publicidad_ubipub")
  @@index([id_usuario], map: "fk_publicidad_usuario")
}

model reporte_impacto {
  id_reporte             Int     @id @default(autoincrement())
  id_usuario             Int?
  id_tipo_reporte        Int
  id_periodo             Int
  total_co2_ahorrado     Decimal @db.Decimal(12, 6)
  total_agua_ahorrada    Decimal @db.Decimal(12, 6)
  total_energia_ahorrada Decimal @db.Decimal(12, 6)
  total_transacciones    BigInt
  total_usuarios_activos BigInt

  @@index([id_periodo], map: "fk_rep_periodo")
  @@index([id_usuario], map: "fk_rep_usuario")
  @@index([id_tipo_reporte, id_periodo, id_usuario], map: "ix_rep_unico_helper")
}

model resultado_acceso {
  id_resultado Int     @id @default(autoincrement())
  nombre       String  @unique(map: "nombre") @db.VarChar(50)
  descripcion  String? @db.VarChar(255)
}

model rol {
  id_rol      Int     @id @default(autoincrement())
  nombre      String  @unique(map: "nombre") @db.VarChar(50)
  descripcion String? @db.VarChar(255)
}

model rol_permiso {
  id_rol     Int
  id_permiso Int

  @@id([id_rol, id_permiso])
  @@index([id_permiso], map: "fk_rp_permiso")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model servicio {
  id_servicio  Int              @id @default(autoincrement())
  id_categoria Int
  estado       servicio_estado? @default(ACTIVO)
  nombre       String           @db.VarChar(255)
  descripcion  String?          @db.Text
  precio       Decimal?         @db.Decimal(12, 2)
  duracion_min Int?             @db.SmallInt

  @@index([id_categoria], map: "fk_servicio_categoria")
}

model signo_movimiento {
  id_signo Int    @id @default(autoincrement())
  nombre   String @unique(map: "nombre") @db.VarChar(20)
}

model signo_tipo_mov {
  id_tipo_movimiento Int
  id_signo           Int
  creado_en          DateTime? @db.DateTime(0)

  @@id([id_tipo_movimiento, id_signo])
  @@index([id_signo], map: "ix_sxtm_signo")
}

model tipo_actividad {
  id_tipo_actividad Int     @id @default(autoincrement())
  nombre            String  @unique(map: "nombre") @db.VarChar(100)
  descripcion       String? @db.VarChar(255)
}

model tipo_logro {
  id_tipo_logro Int     @id @default(autoincrement())
  nombre        String  @unique(map: "nombre") @db.VarChar(50)
  descripcion   String? @db.VarChar(255)
}

model tipo_movimiento {
  id_tipo_movimiento Int     @id @default(autoincrement())
  nombre             String  @unique(map: "nombre") @db.VarChar(50)
  descripcion        String? @db.VarChar(255)

  @@index([nombre], map: "ix_tipomov_nombre")
}

model tipo_promocion {
  id_tipo_promocion Int     @id @default(autoincrement())
  nombre            String  @unique(map: "nombre") @db.VarChar(50)
  descripcion       String? @db.VarChar(255)
}

model tipo_publicacion {
  id_tipo_publicacion Int     @id @default(autoincrement())
  nombre              String  @unique(map: "nombre") @db.VarChar(50)
  descripcion         String? @db.VarChar(255)
}

model tipo_referencia {
  id_tipo_referencia Int    @id @default(autoincrement())
  nombre             String @unique(map: "nombre") @db.VarChar(30)

  @@index([nombre], map: "ix_tiporef_nombre")
}

model tipo_reporte {
  id_tipo_reporte Int     @id @default(autoincrement())
  nombre          String  @unique(map: "nombre") @db.VarChar(50)
  descripcion     String? @db.VarChar(255)
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model transaccion {
  id_transaccion    Int                 @id @default(autoincrement())
  id_comprador      Int
  id_vendedor       Int
  id_publicacion    Int
  cantidad_creditos BigInt
  estado            transaccion_estado? @default(SOLICITADA)
  creado_en         DateTime            @default(now()) @db.DateTime(0)

  @@index([estado], map: "ix_trans_estado")
  @@index([id_comprador], map: "ix_tx_comprador")
  @@index([id_publicacion], map: "ix_tx_publicacion")
  @@index([id_vendedor], map: "ix_tx_vendedor")
  @@index([creado_en], map: "ix_tx_creado_en")
}

model ubicacion {
  id_ubicacion Int      @id @default(autoincrement())
  direccion    String   @db.VarChar(500)
  ciudad       String?  @db.VarChar(100)
  provincia    String?  @db.VarChar(100)
  latitud      Decimal? @db.Decimal(9, 6)
  longitud     Decimal? @db.Decimal(9, 6)
}

model ubicacion_publicidad {
  id_ubicacion Int     @id @default(autoincrement())
  nombre       String  @unique(map: "nombre") @db.VarChar(100)
  descripcion  String? @db.VarChar(255)
  precio_base  Decimal @db.Decimal(12, 2)
}

model unidad_medida {
  id_um   Int    @id @default(autoincrement())
  nombre  String @unique(map: "nombre") @db.VarChar(100)
  simbolo String @unique(map: "simbolo") @db.VarChar(20)
}

model usuario {
  id_usuario    Int            @id @default(autoincrement())
  id_rol        Int
  estado        usuario_estado @default(ACTIVO)
  nombre        String         @db.VarChar(100)
  apellido      String?        @db.VarChar(100)
  correo        String         @unique(map: "correo") @db.VarChar(255)
  password_hash String         @default("") @db.VarChar(255)
  telefono      String?        @db.VarChar(25)
  url_perfil    String?        @unique(map: "url_perfil") @db.VarChar(120)

  @@index([id_rol], map: "fk_usuario_rol")
}

model usuario_logro {
  id_usuario_logro Int     @id @default(autoincrement())
  id_usuario       Int
  id_logro         Int
  progreso_actual  BigInt? @default(0)

  @@unique([id_usuario, id_logro], map: "id_usuario")
  @@index([id_logro], map: "fk_ulogro_logro")
}

model suscripcion_premium {
  id_suscripcion Int                        @id @default(autoincrement())
  id_usuario     Int
  fecha_inicio   DateTime                   @default(now()) @db.DateTime(0)
  fecha_fin      DateTime?                  @db.DateTime(0)
  estado         suscripcion_premium_estado @default(ACTIVA)
  monto_bs       Decimal                    @db.Decimal(12, 2)

  @@index([fecha_inicio, fecha_fin], map: "ix_suscrip_fechas")
  @@index([id_usuario, estado], map: "ix_suscrip_usuario_estado")
}

enum billetera_estado {
  ACTIVA
  BLOQUEADA
  CERRADA
}

enum servicio_estado {
  ACTIVO
  PAUSADO
  INACTIVO
  ELIMINADO
}

enum usuario_estado {
  ACTIVO
  SUSPENDIDO
  BLOQUEADO
  ELIMINADO
}

enum evento_ambiental_fuente {
  PUBLICACION
  TRANSACCION
}

enum publicidad_estado {
  PROGRAMADA
  ACTIVA
  PAUSADA
  FINALIZADA
  CANCELADA
}

enum compra_creditos_estado {
  PENDIENTE
  APROBADO
  RECHAZADO
  FALLIDO
  REVERTIDO
}

enum publicacion_estado {
  BORRADOR
  PUBLICADA
  PAUSADA
  AGOTADA
  OCULTA
  ELIMINADA
}

enum transaccion_estado {
  SOLICITADA
  ACEPTADA
  RECHAZADA
  CANCELADA
  COMPLETADA
  ANULADA
}

enum promocion_estado {
  PROGRAMADA
  ACTIVA
  PAUSADA
  FINALIZADA
  CANCELADA
}

enum suscripcion_premium_estado {
  ACTIVA
  CANCELADA
  VENCIDA
}
</file>

<file path="backend/prisma/seed.js">
import { PrismaClient } from '@prisma/client'
import bcrypt from 'bcryptjs'
const prisma = new PrismaClient()

async function main() {
  const [adminRole, userRole] = await Promise.all([
    prisma.role.upsert({ where: { name: 'ADMIN' }, update: {}, create: { name: 'ADMIN' } }),
    prisma.role.upsert({ where: { name: 'USER' }, update: {}, create: { name: 'USER' } }),
  ])

  const passwordHash = await bcrypt.hash('demo123', 10)
  const admin = await prisma.user.upsert({
    where: { email: 'demo@demo.com' },
    update: {},
    create: { email: 'demo@demo.com', name: 'Admin Demo', passwordHash, roleId: adminRole.id }
  })

  await prisma.wallet.upsert({
    where: { userId: admin.id },
    update: {},
    create: { userId: admin.id, credits: 1000 }
  })

  console.log('Seed listo:', { admin: admin.email })
}

main().catch(e=>{console.error(e); process.exit(1)}).finally(()=>prisma.$disconnect())
</file>

<file path="backend/repomix-output.xml">
This file is a merged representation of the entire codebase, combined into a single document by Repomix.

<file_summary>
This section contains a summary of this file.

<purpose>
This file contains a packed representation of the entire repository's contents.
It is designed to be easily consumable by AI systems for analysis, code review,
or other automated processes.
</purpose>

<file_format>
The content is organized as follows:
1. This summary section
2. Repository information
3. Directory structure
4. Repository files (if enabled)
5. Multiple file entries, each consisting of:
  - File path as an attribute
  - Full contents of the file
</file_format>

<usage_guidelines>
- This file should be treated as read-only. Any changes should be made to the
  original repository files, not this packed version.
- When processing this file, use the file path to distinguish
  between different files in the repository.
- Be aware that this file may contain sensitive information. Handle it with
  the same level of security as you would the original repository.
</usage_guidelines>

<notes>
- Some files may have been excluded based on .gitignore rules and Repomix's configuration
- Binary files are not included in this packed representation. Please refer to the Repository Structure section for a complete list of file paths, including binary files
- Files matching patterns in .gitignore are excluded
- Files matching default ignore patterns are excluded
- Files are sorted by Git change count (files with more changes are at the bottom)
</notes>

</file_summary>

<directory_structure>
Dockerfile
package.json
prisma/schema.prisma
prisma/seed.js
src/app.js
src/config/env.js
src/config/prisma.js
src/middlewares/auth.js
src/middlewares/errorHandler.js
src/middlewares/isAdmin.js
src/modules/actividades/actividades.controller.js
src/modules/actividades/actividades.routes.js
src/modules/actividades/actividades.service.js
src/modules/auth/auth.controller.js
src/modules/auth/auth.routes.js
src/modules/auth/auth.service.js
src/modules/bitacoras/bitacoras.controller.js
src/modules/bitacoras/bitacoras.routes.js
src/modules/bitacoras/bitacoras.service.js
src/modules/catalogos/catalogos.controller.js
src/modules/catalogos/catalogos.routes.js
src/modules/catalogos/catalogos.service.js
src/modules/intercambios/intercambios.controller.js
src/modules/intercambios/intercambios.routes.js
src/modules/intercambios/intercambios.service.js
src/modules/logros/logros.controller.js
src/modules/logros/logros.routes.js
src/modules/logros/logros.service.js
src/modules/premium/premium.controller.js
src/modules/premium/premium.routes.js
src/modules/premium/premium.service.js
src/modules/promociones/promociones.controller.js
src/modules/promociones/promociones.routes.js
src/modules/promociones/promociones.service.js
src/modules/publicaciones/publicaciones.controller.js
src/modules/publicaciones/publicaciones.routes.js
src/modules/publicaciones/publicaciones.service.js
src/modules/publicidad/publicidad.controller.js
src/modules/publicidad/publicidad.routes.js
src/modules/publicidad/publicidad.service.js
src/modules/reportes/reportes.controller.js
src/modules/reportes/reportes.routes.js
src/modules/reportes/reportes.service.js
src/modules/uploads/multer.js
src/modules/uploads/uploads.controller.js
src/modules/uploads/uploads.routes.js
src/modules/uploads/uploads.service.js
src/modules/usuarios/usuarios.controller.js
src/modules/usuarios/usuarios.routes.js
src/modules/usuarios/usuarios.service.js
src/modules/wallet/wallet.controller.js
src/modules/wallet/wallet.routes.js
src/modules/wallet/wallet.service.js
src/routes/index.js
src/server.js
uploads_storage/1717f8c0-ba65-48b3-80da-d06a474dd514.png
uploads_storage/cb6b319f-881d-4f8a-8a5e-9f8eecd10402.png
uploads_storage/d6b3b8be-16ba-41bc-b958-7ab0c3e14e38.png
utils/jsonBigInt.js
</directory_structure>

<files>
This section contains the contents of the repository's files.

<file path="Dockerfile">
# simple dev image; optional
FROM node:18-alpine
WORKDIR /app
COPY package*.json ./
RUN npm install
COPY . .
EXPOSE 4000
CMD ["npm","run","start"]
</file>

<file path="package.json">
{
  "name": "backend",
  "private": true,
  "version": "0.1.0",
  "type": "module",
  "scripts": {
    "dev": "node --watch src/server.js",
    "start": "node src/server.js",
    "prisma:generate": "prisma generate",
    "prisma:migrate": "prisma migrate dev --name init",
    "prisma:deploy": "prisma migrate deploy",
    "prisma:seed": "node prisma/seed.js",
    "studio": "prisma studio"
  },
  "dependencies": {
    "@prisma/client": "^6.19.0",
    "bcryptjs": "^2.4.3",
    "cors": "^2.8.5",
    "dotenv": "^16.4.5",
    "express": "^4.21.1",
    "helmet": "^7.1.0",
    "jsonwebtoken": "^9.0.2",
    "morgan": "^1.10.1",
    "multer": "^2.0.2",
    "uuid": "^13.0.0"
  },
  "devDependencies": {
    "prisma": "^6.19.0"
  }
}
</file>

<file path="prisma/schema.prisma">
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model actividad_sostenible {
  id_actividad       Int      @id @default(autoincrement())
  id_usuario         Int
  id_tipo_actividad  Int
  descripcion        String   @db.Text
  creditos_otorgados Int
  evidencia_url      String?  @db.VarChar(500)
  creado_en          DateTime @default(now()) @db.DateTime(0)

  @@index([id_tipo_actividad], map: "fk_act_tipo")
  @@index([id_usuario], map: "fk_act_usuario")
  @@index([creado_en], map: "ix_actsost_creado_en")
}

model billetera {
  id_billetera    Int               @id @default(autoincrement())
  id_usuario      Int               @unique(map: "id_usuario")
  estado          billetera_estado? @default(ACTIVA)
  saldo_creditos  BigInt?           @default(0)
  saldo_bs        Decimal?          @default(0.00) @db.Decimal(12, 2)
  cuenta_bancaria String?           @db.VarChar(100)
}

model bitacora_acceso {
  id_acceso    Int      @id @default(autoincrement())
  id_usuario   Int
  fecha        DateTime @default(now()) @db.DateTime(0)
  direccion_ip String   @db.VarChar(45)
  user_agent   String?  @db.VarChar(500)
  id_resultado Int

  @@index([id_resultado], map: "fk_bitacc_resultado")
  @@index([id_usuario, fecha], map: "ix_bitacceso_usuario_fecha")
}

model bitacora_intercambio {
  id_bitacora        Int     @id @default(autoincrement())
  id_transaccion     Int
  id_usuario_origen  Int
  id_usuario_destino Int
  cantidad_creditos  BigInt
  descripcion        String? @db.VarChar(500)

  @@index([id_usuario_destino], map: "fk_bi_usr_destino")
  @@index([id_usuario_origen], map: "fk_bi_usr_origen")
  @@index([id_transaccion], map: "ix_bitacora_trx")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model calificacion {
  id_calificacion Int     @id @default(autoincrement())
  id_usuario      Int
  id_publicacion  Int
  estrellas       Int     @db.TinyInt
  comentario      String? @db.VarChar(300)

  @@unique([id_usuario, id_publicacion], map: "id_usuario")
  @@index([id_publicacion], map: "fk_calif_publicacion")
}

model categoria {
  id_categoria Int     @id @default(autoincrement())
  nombre       String  @unique(map: "nombre") @db.VarChar(100)
  descripcion  String? @db.VarChar(255)
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model compra_creditos {
  id_compra           Int                     @id @default(autoincrement())
  id_usuario          Int
  id_paquete          Int
  monto_bs            Decimal                 @db.Decimal(12, 2)
  estado              compra_creditos_estado? @default(PENDIENTE)
  id_transaccion_pago String?                 @unique(map: "id_transaccion_pago") @db.VarChar(255)
  creado_en           DateTime                @default(now()) @db.DateTime(0)

  @@index([id_paquete], map: "fk_compra_paquete")
  @@index([id_usuario], map: "fk_compra_usuario")
  @@index([estado], map: "ix_compra_estado")
  @@index([creado_en], map: "ix_compra_creado_en")
}

model dimension_ambiental {
  id_dimension Int     @id @default(autoincrement())
  codigo       String  @unique(map: "codigo") @db.VarChar(30)
  nombre       String  @db.VarChar(100)
  unidad_base  String? @db.VarChar(20)
  descripcion  String? @db.VarChar(255)
}

model equivalencia_impacto {
  id_equivalencia    Int     @id @default(autoincrement())
  id_categoria       Int
  id_um              Int?
  co2_por_unidad     Decimal @db.Decimal(12, 6)
  agua_por_unidad    Decimal @db.Decimal(12, 6)
  energia_por_unidad Decimal @db.Decimal(12, 6)

  @@unique([id_categoria, id_um], map: "id_categoria")
  @@index([id_um], map: "fk_eq_um")
}

model evento_ambiental {
  id_evento              Int                     @id @default(autoincrement())
  id_usuario             Int
  id_dimension           Int
  fuente                 evento_ambiental_fuente
  id_fuente              Int
  categoria              String?                 @db.VarChar(100)
  valor                  Decimal                 @db.Decimal(18, 6)
  id_um                  Int?
  contaminacion_reducida Decimal?                @db.Decimal(18, 6)
  descripcion            String?                 @db.VarChar(255)

  @@index([id_dimension], map: "fk_ev_dimension")
  @@index([id_um], map: "fk_ev_um")
  @@index([id_usuario], map: "fk_ev_usuario")
}

model impacto_ambiental {
  id_impacto       Int     @id @default(autoincrement())
  id_usuario       Int
  id_transaccion   Int
  id_categoria     Int
  co2_ahorrado     Decimal @db.Decimal(12, 6)
  agua_ahorrada    Decimal @db.Decimal(12, 6)
  energia_ahorrada Decimal @db.Decimal(12, 6)
  id_periodo       Int

  @@index([id_transaccion], map: "fk_imp_tx")
  @@index([id_categoria], map: "ix_impa_categoria")
  @@index([id_periodo], map: "ix_impa_periodo")
  @@index([id_usuario, id_periodo], map: "ix_impa_usuario_periodo")
}

model logro {
  id_logro            Int     @id @default(autoincrement())
  id_tipo_logro       Int
  nombre              String  @db.VarChar(100)
  descripcion         String? @db.VarChar(255)
  meta_requerida      BigInt
  creditos_recompensa BigInt

  @@index([id_tipo_logro], map: "fk_logro_tipo")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model movimiento_creditos {
  id_movimiento      Int      @id @default(autoincrement())
  id_usuario         Int
  id_tipo_movimiento Int
  id_tipo_referencia Int
  cantidad           BigInt
  descripcion        String?  @db.VarChar(255)
  saldo_anterior     BigInt
  saldo_posterior    BigInt
  id_referencia      Int?
  creado_en          DateTime @default(now()) @db.DateTime(0)

  @@index([id_tipo_movimiento], map: "fk_mov_tipomov")
  @@index([id_movimiento], map: "ix_mov_creado")
  @@index([id_tipo_referencia], map: "ix_mov_tiporef")
  @@index([id_usuario, id_movimiento], map: "ix_mov_usuario")
  @@index([creado_en], map: "ix_mov_creado_en")
}

model paquete_creditos {
  id_paquete        Int     @id @default(autoincrement())
  nombre            String  @unique(map: "nombre") @db.VarChar(100)
  cantidad_creditos BigInt
  precio_bs         Decimal @db.Decimal(12, 2)
  activo            Boolean @default(true)
}

model periodo {
  id_periodo   Int       @id @default(autoincrement())
  nombre       String    @unique(map: "nombre") @db.VarChar(50)
  descripcion  String?   @db.VarChar(255)
  fecha_inicio DateTime? @db.Date
  fecha_fin    DateTime? @db.Date

  @@index([fecha_inicio, fecha_fin], map: "ix_periodo_rango")
}

model permiso {
  id_permiso  Int     @id @default(autoincrement())
  nombre      String  @unique(map: "nombre") @db.VarChar(100)
  descripcion String? @db.VarChar(255)
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model producto {
  id_producto  Int      @id @default(autoincrement())
  id_categoria Int
  nombre       String   @db.VarChar(255)
  descripcion  String?  @db.VarChar(255)
  precio       Decimal? @db.Decimal(12, 2)
  peso         Decimal? @db.Decimal(10, 2)

  @@index([id_categoria], map: "fk_producto_categoria")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model promocion {
  id_promocion       Int               @id @default(autoincrement())
  id_tipo_promocion  Int
  nombre             String            @db.VarChar(100)
  descripcion        String?           @db.VarChar(255)
  creditos_otorgados BigInt
  fecha_inicio       DateTime          @db.DateTime(0)
  fecha_fin          DateTime          @db.DateTime(0)
  estado             promocion_estado? @default(PROGRAMADA)

  @@index([id_tipo_promocion], map: "fk_promocion_tipo")
  @@index([estado, fecha_inicio, fecha_fin], map: "ix_promocion_activa")
}

model promocion_publicacion {
  id_promocion   Int
  id_publicacion Int

  @@id([id_promocion, id_publicacion])
  @@index([id_promocion], map: "ix_promopub_prom")
  @@index([id_publicacion], map: "ix_promopub_pub")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model publicacion {
  id_publicacion      Int                 @id @default(autoincrement())
  id_usuario          Int
  id_categoria        Int
  id_tipo_publicacion Int
  estado              publicacion_estado? @default(PUBLICADA)
  id_ubicacion        Int?
  titulo              String              @db.VarChar(200)
  descripcion         String              @db.Text
  valor_creditos      BigInt
  imagen_url          String?             @db.VarChar(500)
  creado_en           DateTime            @default(now()) @db.DateTime(0)

  @@index([id_tipo_publicacion], map: "fk_publicacion_tipopub")
  @@index([id_ubicacion], map: "fk_publicacion_ubicacion")
  @@index([id_categoria, estado], map: "ix_pub_categoria_estado")
  @@index([id_usuario, estado], map: "ix_pub_usuario_estado")
  @@index([creado_en], map: "ix_pub_creado_en")
  @@fulltext([titulo, descripcion], map: "ft_pub_titulo_desc")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model publicacion_producto {
  id_publicacion Int
  id_producto    Int
  cantidad       Decimal @db.Decimal(15, 4)
  id_um          Int

  @@id([id_publicacion, id_producto])
  @@index([id_producto], map: "fk_pprd_producto")
  @@index([id_um], map: "fk_pprd_um")
}

model publicacion_servicio {
  id_publicacion Int
  id_servicio    Int
  horario        String @db.VarChar(100)

  @@id([id_publicacion, id_servicio])
  @@index([id_servicio], map: "fk_pserv_servicio")
}

model publicidad {
  id_publicidad  Int                @id @default(autoincrement())
  id_usuario     Int
  id_ubicacion   Int
  estado         publicidad_estado? @default(PROGRAMADA)
  titulo         String             @db.VarChar(200)
  descripcion    String?            @db.VarChar(255)
  url_destino    String?            @db.VarChar(500)
  fecha_inicio   DateTime           @db.DateTime(0)
  fecha_fin      DateTime           @db.DateTime(0)
  costo_creditos BigInt

  @@index([id_ubicacion], map: "fk_publicidad_ubipub")
  @@index([id_usuario], map: "fk_publicidad_usuario")
}

model reporte_impacto {
  id_reporte             Int     @id @default(autoincrement())
  id_usuario             Int?
  id_tipo_reporte        Int
  id_periodo             Int
  total_co2_ahorrado     Decimal @db.Decimal(12, 6)
  total_agua_ahorrada    Decimal @db.Decimal(12, 6)
  total_energia_ahorrada Decimal @db.Decimal(12, 6)
  total_transacciones    BigInt
  total_usuarios_activos BigInt

  @@index([id_periodo], map: "fk_rep_periodo")
  @@index([id_usuario], map: "fk_rep_usuario")
  @@index([id_tipo_reporte, id_periodo, id_usuario], map: "ix_rep_unico_helper")
}

model resultado_acceso {
  id_resultado Int     @id @default(autoincrement())
  nombre       String  @unique(map: "nombre") @db.VarChar(50)
  descripcion  String? @db.VarChar(255)
}

model rol {
  id_rol      Int     @id @default(autoincrement())
  nombre      String  @unique(map: "nombre") @db.VarChar(50)
  descripcion String? @db.VarChar(255)
}

model rol_permiso {
  id_rol     Int
  id_permiso Int

  @@id([id_rol, id_permiso])
  @@index([id_permiso], map: "fk_rp_permiso")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model servicio {
  id_servicio  Int              @id @default(autoincrement())
  id_categoria Int
  estado       servicio_estado? @default(ACTIVO)
  nombre       String           @db.VarChar(255)
  descripcion  String?          @db.Text
  precio       Decimal?         @db.Decimal(12, 2)
  duracion_min Int?             @db.SmallInt

  @@index([id_categoria], map: "fk_servicio_categoria")
}

model signo_movimiento {
  id_signo Int    @id @default(autoincrement())
  nombre   String @unique(map: "nombre") @db.VarChar(20)
}

model signo_tipo_mov {
  id_tipo_movimiento Int
  id_signo           Int
  creado_en          DateTime? @db.DateTime(0)

  @@id([id_tipo_movimiento, id_signo])
  @@index([id_signo], map: "ix_sxtm_signo")
}

model tipo_actividad {
  id_tipo_actividad Int     @id @default(autoincrement())
  nombre            String  @unique(map: "nombre") @db.VarChar(100)
  descripcion       String? @db.VarChar(255)
}

model tipo_logro {
  id_tipo_logro Int     @id @default(autoincrement())
  nombre        String  @unique(map: "nombre") @db.VarChar(50)
  descripcion   String? @db.VarChar(255)
}

model tipo_movimiento {
  id_tipo_movimiento Int     @id @default(autoincrement())
  nombre             String  @unique(map: "nombre") @db.VarChar(50)
  descripcion        String? @db.VarChar(255)

  @@index([nombre], map: "ix_tipomov_nombre")
}

model tipo_promocion {
  id_tipo_promocion Int     @id @default(autoincrement())
  nombre            String  @unique(map: "nombre") @db.VarChar(50)
  descripcion       String? @db.VarChar(255)
}

model tipo_publicacion {
  id_tipo_publicacion Int     @id @default(autoincrement())
  nombre              String  @unique(map: "nombre") @db.VarChar(50)
  descripcion         String? @db.VarChar(255)
}

model tipo_referencia {
  id_tipo_referencia Int    @id @default(autoincrement())
  nombre             String @unique(map: "nombre") @db.VarChar(30)

  @@index([nombre], map: "ix_tiporef_nombre")
}

model tipo_reporte {
  id_tipo_reporte Int     @id @default(autoincrement())
  nombre          String  @unique(map: "nombre") @db.VarChar(50)
  descripcion     String? @db.VarChar(255)
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model transaccion {
  id_transaccion    Int                 @id @default(autoincrement())
  id_comprador      Int
  id_vendedor       Int
  id_publicacion    Int
  cantidad_creditos BigInt
  estado            transaccion_estado? @default(SOLICITADA)
  creado_en         DateTime            @default(now()) @db.DateTime(0)

  @@index([estado], map: "ix_trans_estado")
  @@index([id_comprador], map: "ix_tx_comprador")
  @@index([id_publicacion], map: "ix_tx_publicacion")
  @@index([id_vendedor], map: "ix_tx_vendedor")
  @@index([creado_en], map: "ix_tx_creado_en")
}

model ubicacion {
  id_ubicacion Int      @id @default(autoincrement())
  direccion    String   @db.VarChar(500)
  ciudad       String?  @db.VarChar(100)
  provincia    String?  @db.VarChar(100)
  latitud      Decimal? @db.Decimal(9, 6)
  longitud     Decimal? @db.Decimal(9, 6)
}

model ubicacion_publicidad {
  id_ubicacion Int     @id @default(autoincrement())
  nombre       String  @unique(map: "nombre") @db.VarChar(100)
  descripcion  String? @db.VarChar(255)
  precio_base  Decimal @db.Decimal(12, 2)
}

model unidad_medida {
  id_um   Int    @id @default(autoincrement())
  nombre  String @unique(map: "nombre") @db.VarChar(100)
  simbolo String @unique(map: "simbolo") @db.VarChar(20)
}

model usuario {
  id_usuario    Int            @id @default(autoincrement())
  id_rol        Int
  estado        usuario_estado @default(ACTIVO)
  nombre        String         @db.VarChar(100)
  apellido      String?        @db.VarChar(100)
  correo        String         @unique(map: "correo") @db.VarChar(255)
  password_hash String         @default("") @db.VarChar(255)
  telefono      String?        @db.VarChar(25)
  url_perfil    String?        @unique(map: "url_perfil") @db.VarChar(120)

  @@index([id_rol], map: "fk_usuario_rol")
}

model usuario_logro {
  id_usuario_logro Int     @id @default(autoincrement())
  id_usuario       Int
  id_logro         Int
  progreso_actual  BigInt? @default(0)

  @@unique([id_usuario, id_logro], map: "id_usuario")
  @@index([id_logro], map: "fk_ulogro_logro")
}

model suscripcion_premium {
  id_suscripcion Int                        @id @default(autoincrement())
  id_usuario     Int
  fecha_inicio   DateTime                   @default(now()) @db.DateTime(0)
  fecha_fin      DateTime?                  @db.DateTime(0)
  estado         suscripcion_premium_estado @default(ACTIVA)
  monto_bs       Decimal                    @db.Decimal(12, 2)

  @@index([fecha_inicio, fecha_fin], map: "ix_suscrip_fechas")
  @@index([id_usuario, estado], map: "ix_suscrip_usuario_estado")
}

enum billetera_estado {
  ACTIVA
  BLOQUEADA
  CERRADA
}

enum servicio_estado {
  ACTIVO
  PAUSADO
  INACTIVO
  ELIMINADO
}

enum usuario_estado {
  ACTIVO
  SUSPENDIDO
  BLOQUEADO
  ELIMINADO
}

enum evento_ambiental_fuente {
  PUBLICACION
  TRANSACCION
}

enum publicidad_estado {
  PROGRAMADA
  ACTIVA
  PAUSADA
  FINALIZADA
  CANCELADA
}

enum compra_creditos_estado {
  PENDIENTE
  APROBADO
  RECHAZADO
  FALLIDO
  REVERTIDO
}

enum publicacion_estado {
  BORRADOR
  PUBLICADA
  PAUSADA
  AGOTADA
  OCULTA
  ELIMINADA
}

enum transaccion_estado {
  SOLICITADA
  ACEPTADA
  RECHAZADA
  CANCELADA
  COMPLETADA
  ANULADA
}

enum promocion_estado {
  PROGRAMADA
  ACTIVA
  PAUSADA
  FINALIZADA
  CANCELADA
}

enum suscripcion_premium_estado {
  ACTIVA
  CANCELADA
  VENCIDA
}
</file>

<file path="prisma/seed.js">
import { PrismaClient } from '@prisma/client'
import bcrypt from 'bcryptjs'
const prisma = new PrismaClient()

async function main() {
  const [adminRole, userRole] = await Promise.all([
    prisma.role.upsert({ where: { name: 'ADMIN' }, update: {}, create: { name: 'ADMIN' } }),
    prisma.role.upsert({ where: { name: 'USER' }, update: {}, create: { name: 'USER' } }),
  ])

  const passwordHash = await bcrypt.hash('demo123', 10)
  const admin = await prisma.user.upsert({
    where: { email: 'demo@demo.com' },
    update: {},
    create: { email: 'demo@demo.com', name: 'Admin Demo', passwordHash, roleId: adminRole.id }
  })

  await prisma.wallet.upsert({
    where: { userId: admin.id },
    update: {},
    create: { userId: admin.id, credits: 1000 }
  })

  console.log('Seed listo:', { admin: admin.email })
}

main().catch(e=>{console.error(e); process.exit(1)}).finally(()=>prisma.$disconnect())
</file>

<file path="src/app.js">
// src/app.js

// ðŸ”§ Parche global para que JSON.stringify soporte BigInt en todas las respuestas
if (typeof BigInt !== "undefined" && !BigInt.prototype.toJSON) {
  // eslint-disable-next-line no-extend-native
  BigInt.prototype.toJSON = function () {
    return Number(this);
  };
}

import express from "express";
import cors from "cors";
import morgan from "morgan";
import routes from "./routes/index.js";
import { errorHandler } from "./middlewares/errorHandler.js";

import path from "path";
import { fileURLToPath } from "url";

const app = express();

// -------------------------------------------------------------
// Necesario para rutas absolutas (uploads y archivos estÃ¡ticos)
// -------------------------------------------------------------
const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

// -------------------------------------------------------------
// Middlewares globales
// -------------------------------------------------------------
app.use(cors());                // permitir peticiones de tu frontend
app.use(morgan("dev"));         // logs en consola
app.use(express.json());        // permite JSON en body
app.use(express.urlencoded({ extended: true })); // formularios

// -------------------------------------------------------------
// Servir archivos estÃ¡ticos (subidas de imÃ¡genes)
// Ruta final: http://localhost:4000/uploads/<nombre-archivo>
// -------------------------------------------------------------
app.use(
  "/uploads",
  express.static(path.join(__dirname, "..", "uploads_storage"))
);

// -------------------------------------------------------------
// Registrar todas las rutas del backend
// -------------------------------------------------------------
app.use("/api", routes);

// -------------------------------------------------------------
// Middleware para rutas no encontradas
// -------------------------------------------------------------
app.use((req, res, next) => {
  res.status(404).json({ message: "Ruta no encontrada" });
});

// -------------------------------------------------------------
// Middleware global de manejo de errores
// (Siempre debe ir al final)
// -------------------------------------------------------------
app.use(errorHandler);

export default app;
</file>

<file path="src/config/env.js">
// src/config/env.js
import 'dotenv/config'

export const env = {
  NODE_ENV: process.env.NODE_ENV ?? 'development',
  PORT: Number(process.env.PORT ?? 4000),
  DATABASE_URL: process.env.DATABASE_URL,
}
</file>

<file path="src/config/prisma.js">
// src/config/prisma.js
import { PrismaClient } from '@prisma/client'

export const prisma = new PrismaClient({
    log: ['query', 'error', 'warn'],
})
</file>

<file path="src/middlewares/auth.js">
// src/middlewares/auth.js
import jwt from "jsonwebtoken";

// Middleware principal: requiere token vÃ¡lido
export function authMiddleware(req, res, next) {
  const authHeader = req.headers.authorization;

  // Esperamos "Authorization: Bearer <token>"
  if (!authHeader || !authHeader.startsWith("Bearer ")) {
    return res.status(401).json({ message: "Token de autenticaciÃ³n faltante" });
  }

  const token = authHeader.split(" ")[1];

  try {
    const payload = jwt.verify(token, process.env.JWT_SECRET);
    // En el payload nosotros pusimos: id_usuario, correo, rol
    req.user = payload;
    next();
  } catch (err) {
    return res
      .status(401)
      .json({ message: "Token invÃ¡lido o expirado" });
  }
}

// VersiÃ³n opcional: si hay token lo lee, si no, deja pasar
export function optionalAuth(req, _res, next) {
  const authHeader = req.headers.authorization;
  if (!authHeader || !authHeader.startsWith("Bearer ")) {
    return next();
  }

  const token = authHeader.split(" ")[1];

  try {
    const payload = jwt.verify(token, process.env.JWT_SECRET);
    req.user = payload;
  } catch {
    // si falla, simplemente no ponemos req.user
  }
  next();
}
</file>

<file path="src/middlewares/errorHandler.js">
// src/middlewares/errorHandler.js

// Middleware de manejo global de errores (SIEMPRE 4 parÃ¡metros)
export function errorHandler(err, req, res, next) {
  console.error("âŒ Error:", err);

  // Si ya se empezÃ³ a enviar la respuesta, delega a Express
  if (res.headersSent) {
    return next(err);
  }

  const status = err.status || err.statusCode || 500;
  const message =
    err.message || "OcurriÃ³ un error inesperado en el servidor";

  const response = { message };

  // En desarrollo podemos enviar mÃ¡s detalles
  if (process.env.NODE_ENV !== "production") {
    response.stack = err.stack;
    if (err.code) response.code = err.code;
  }

  res.status(status).json(response);
}
</file>

<file path="src/middlewares/isAdmin.js">
// src/middlewares/isAdmin.js

// Middleware simple: solo ADMIN
export function isAdmin(req, res, next) {
  if (!req.user) {
    return res.status(401).json({ message: "No autenticado" });
  }

  if (req.user.rol !== "ADMIN") {
    return res.status(403).json({ message: "Acceso solo para administradores" });
  }

  next();
}

// Middleware mÃ¡s general: aceptar varios roles
export function hasRole(...rolesPermitidos) {
  return (req, res, next) => {
    if (!req.user) {
      return res.status(401).json({ message: "No autenticado" });
    }

    if (!rolesPermitidos.includes(req.user.rol)) {
      return res.status(403).json({ message: "No tienes permisos suficientes" });
    }

    next();
  };
}
</file>

<file path="src/modules/actividades/actividades.controller.js">
import {
  registrarActividadService,
  misActividadesService,
  listarActividadesAdminService,
} from "./actividades.service.js";

/**
 * Registrar nueva actividad sostenible (usuario logueado)
 */
export const registrarActividadController = async (req, res, next) => {
  try {
    const idUsuario = req.user.id_usuario;
    const {
      id_tipo_actividad,
      descripcion,
      creditos_otorgados,
      evidencia_url,
    } = req.body;

    const result = await registrarActividadService({
      idUsuario,
      id_tipo_actividad,
      descripcion,
      creditos_otorgados,
      evidencia_url,
    });

    res.status(201).json({
      message: "Actividad registrada correctamente",
      actividad: result,
    });
  } catch (e) {
    next(e);
  }
};

/**
 * Listar SOLO mis actividades (usuario logueado)
 */
export const misActividadesController = async (req, res, next) => {
  try {
    const idUsuario = req.user.id_usuario;
    const actividades = await misActividadesService(idUsuario);
    res.json(actividades);
  } catch (e) {
    next(e);
  }
};

/**
 * Listar actividades para ADMIN, con filtros opcionales:
 *  - ?id_usuario=...
 *  - ?id_tipo_actividad=...
 *  - ?desde=YYYY-MM-DD
 *  - ?hasta=YYYY-MM-DD
 */
export const listarActividadesAdminController = async (req, res, next) => {
  try {
    const { id_usuario, id_tipo_actividad, desde, hasta } = req.query;

    const filtros = {
      id_usuario: id_usuario ? Number(id_usuario) : undefined,
      id_tipo_actividad: id_tipo_actividad
        ? Number(id_tipo_actividad)
        : undefined,
      desde: desde || undefined,
      hasta: hasta || undefined,
    };

    const actividades = await listarActividadesAdminService(filtros);

    res.json({
      message: "Listado de actividades sostenibles",
      filtros,
      data: actividades,
    });
  } catch (e) {
    next(e);
  }
};
</file>

<file path="src/modules/actividades/actividades.routes.js">
import { Router } from "express";
import { authMiddleware } from "../../middlewares/auth.js";
import { isAdmin } from "../../middlewares/isAdmin.js";
import {
  registrarActividadController,
  misActividadesController,
  listarActividadesAdminController,
} from "./actividades.controller.js";

const router = Router();

// Todas las rutas requieren estar logueado
router.use(authMiddleware);

// Registrar actividad sostenible (usuario)
router.post("/", registrarActividadController);

// Ver MIS actividades
router.get("/mias", misActividadesController);

// Listado ADMIN de actividades con filtros
router.get("/admin", isAdmin, listarActividadesAdminController);

export default router;
</file>

<file path="src/modules/actividades/actividades.service.js">
import { prisma } from "../../config/prisma.js";

export async function registrarActividadService({
  idUsuario,
  id_tipo_actividad,
  descripcion,
  creditos_otorgados,
  evidencia_url,
}) {
  if (!id_tipo_actividad || !descripcion || creditos_otorgados == null) {
    const err = new Error(
      "id_tipo_actividad, descripcion y creditos_otorgados son obligatorios"
    );
    err.status = 400;
    throw err;
  }

  const creditosNum = Number(creditos_otorgados);
  if (!Number.isFinite(creditosNum) || creditosNum <= 0) {
    const err = new Error("creditos_otorgados debe ser un nÃºmero mayor a 0");
    err.status = 400;
    throw err;
  }

  // Llamar SP que encapsula la lÃ³gica de negocio
  await prisma.$executeRawUnsafe(
    "CALL sp_registrar_actividad_sostenible(?, ?, ?, ?, ?)",
    idUsuario,
    id_tipo_actividad,
    descripcion,
    creditosNum,
    evidencia_url || null
  );

  // devolver la Ãºltima actividad del usuario (reciente)
  const [act] = await prisma.$queryRaw`
    SELECT *
    FROM ACTIVIDAD_SOSTENIBLE
    WHERE id_usuario = ${idUsuario}
    ORDER BY creado_en DESC, id_actividad DESC
    LIMIT 1
  `;
  return act;
}

export async function misActividadesService(idUsuario) {
  return prisma.$queryRaw`
    SELECT *
    FROM ACTIVIDAD_SOSTENIBLE
    WHERE id_usuario = ${idUsuario}
    ORDER BY creado_en DESC
  `;
}

/**
 * Listado ADMIN con filtros opcionales:
 *  - id_usuario
 *  - id_tipo_actividad
 *  - desde / hasta (sobre columna creado_en)
 *
 * VersiÃ³n pro: incluye nombre de usuario y nombre del tipo de actividad.
 */
export async function listarActividadesAdminService({
  id_usuario,
  id_tipo_actividad,
  desde,
  hasta,
}) {
  let sql = `
    SELECT
      a.*,
      u.nombre       AS nombre_usuario,
      u.correo       AS correo_usuario,
      ta.nombre      AS nombre_tipo_actividad
    FROM ACTIVIDAD_SOSTENIBLE a
    JOIN USUARIO u
      ON u.id_usuario = a.id_usuario
    JOIN TIPO_ACTIVIDAD ta
      ON ta.id_tipo_actividad = a.id_tipo_actividad
    WHERE 1=1
  `;
  const params = [];

  if (id_usuario) {
    sql += " AND a.id_usuario = ?";
    params.push(id_usuario);
  }

  if (id_tipo_actividad) {
    sql += " AND a.id_tipo_actividad = ?";
    params.push(id_tipo_actividad);
  }

  if (desde) {
    sql += " AND DATE(a.creado_en) >= ?";
    params.push(desde);
  }

  if (hasta) {
    sql += " AND DATE(a.creado_en) <= ?";
    params.push(hasta);
  }

  sql += " ORDER BY a.creado_en DESC, a.id_actividad DESC";

  return prisma.$queryRawUnsafe(sql, ...params);
}
</file>

<file path="src/modules/auth/auth.controller.js">
import {
  registrarUsuarioService,
  loginService,
  obtenerPerfilService,
  actualizarPerfilService,
  cambiarPasswordService,
} from "./auth.service.js";

/**
 * POST /api/auth/register
 * Registro pÃºblico (rol USUARIO)
 */
export async function registerController(req, res, next) {
  try {
    const { nombre, apellido, correo, password, telefono } = req.body;

    if (!nombre || !correo || !password) {
      return res
        .status(400)
        .json({ message: "nombre, correo y password son obligatorios" });
    }

    const usuario = await registrarUsuarioService({
      nombre,
      apellido,
      correo,
      password,
      telefono,
    });

    res.status(201).json({
      message: "Usuario registrado correctamente",
      usuario,
    });
  } catch (err) {
    next(err);
  }
}

/**
 * POST /api/auth/login
 */
export async function loginController(req, res, next) {
  try {
    const { correo, password } = req.body;

    if (!correo || !password) {
      return res
        .status(400)
        .json({ message: "correo y password son obligatorios" });
    }

    const result = await loginService({
      correo,
      password,
      ip: req.ip,
      userAgent: req.headers["user-agent"] || "",
    });

    res.json(result); // { token, usuario }
  } catch (err) {
    next(err);
  }
}

/**
 * GET /api/auth/me
 * Perfil del usuario actual
 */
export async function meController(req, res, next) {
  try {
    const idUsuario = req.user.id_usuario;
    const perfil = await obtenerPerfilService(idUsuario);
    res.json(perfil);
  } catch (err) {
    next(err);
  }
}

/**
 * PUT /api/auth/me
 * Actualizar perfil del usuario logueado
 * Campos permitidos: nombre, apellido, telefono, url_perfil
 */
export async function updateProfileController(req, res, next) {
  try {
    const idUsuario = req.user.id_usuario;
    const { nombre, apellido, telefono, url_perfil } = req.body;

    if (
      nombre === undefined &&
      apellido === undefined &&
      telefono === undefined &&
      url_perfil === undefined
    ) {
      return res
        .status(400)
        .json({ message: "No se enviÃ³ ningÃºn campo para actualizar" });
    }

    const usuarioActualizado = await actualizarPerfilService(idUsuario, {
      nombre,
      apellido,
      telefono,
      url_perfil,
    });

    return res.json({
      message: "Perfil actualizado correctamente",
      usuario: usuarioActualizado,
    });
  } catch (err) {
    next(err);
  }
}

/**
 * PATCH /api/auth/me/password
 * Cambiar contraseÃ±a del usuario logueado
 * Body: { password_actual, password_nueva }
 */
export async function changePasswordController(req, res, next) {
  try {
    const idUsuario = req.user.id_usuario;
    const { password_actual, password_nueva } = req.body;

    if (!password_actual || !password_nueva) {
      return res.status(400).json({
        message: "password_actual y password_nueva son obligatorios",
      });
    }

    if (password_nueva.length < 6) {
      return res.status(400).json({
        message: "La nueva contraseÃ±a debe tener al menos 6 caracteres",
      });
    }

    await cambiarPasswordService(idUsuario, password_actual, password_nueva);

    return res.json({
      message: "ContraseÃ±a actualizada correctamente",
    });
  } catch (err) {
    next(err);
  }
}
</file>

<file path="src/modules/auth/auth.routes.js">
import { Router } from "express";
import {
  registerController,
  loginController,
  meController,
  updateProfileController,
  changePasswordController,
} from "./auth.controller.js";
import { authMiddleware } from "../../middlewares/auth.js";

const router = Router();

// Registro pÃºblico
router.post("/register", registerController);

// Login
router.post("/login", loginController);

// Datos del usuario logueado
router.get("/me", authMiddleware, meController);

// Actualizar perfil del usuario logueado
router.put("/me", authMiddleware, updateProfileController);

// Cambiar contraseÃ±a del usuario logueado
router.patch("/me/password", authMiddleware, changePasswordController);

export default router;
</file>

<file path="src/modules/auth/auth.service.js">
import bcrypt from "bcryptjs";
import jwt from "jsonwebtoken";
import { prisma } from "../../config/prisma.js";

// Helper: obtener id_rol por nombre
async function getRolId(nombreRol) {
  const rows = await prisma.$queryRaw`
    SELECT id_rol FROM ROL WHERE nombre = ${nombreRol} LIMIT 1
  `;
  if (!rows.length) {
    throw new Error(`No existe el rol ${nombreRol}`);
  }
  return rows[0].id_rol;
}

// Helper: obtener id_resultado de BITACORA_ACCESO (OK / FAIL)
async function getResultadoAccesoId(nombre) {
  const rows = await prisma.$queryRaw`
    SELECT id_resultado FROM RESULTADO_ACCESO WHERE nombre = ${nombre} LIMIT 1
  `;
  if (!rows.length) {
    throw new Error(`No existe RESULTADO_ACCESO '${nombre}'`);
  }
  return rows[0].id_resultado;
}

/**
 * Registro de usuario
 */
export async function registrarUsuarioService({
  nombre,
  apellido,
  correo,
  password,
  telefono,
}) {
  // Â¿Correo ya existe?
  const existente = await prisma.$queryRaw`
    SELECT id_usuario FROM USUARIO WHERE correo = ${correo} LIMIT 1
  `;
  if (existente.length) {
    const error = new Error("El correo ya estÃ¡ registrado");
    error.status = 409;
    throw error;
  }

  const hash = await bcrypt.hash(password, 10);
  const idRolUsuario = await getRolId("USUARIO");

  await prisma.$queryRaw`
    INSERT INTO USUARIO (id_rol, estado, nombre, apellido, correo, password_hash, telefono, url_perfil)
    VALUES (${idRolUsuario}, 'ACTIVO', ${nombre}, ${apellido || null}, ${correo},
            ${hash}, ${telefono || null}, NULL)
  `;

  // Volver a leer el usuario insertado
  const usuarioRows = await prisma.$queryRaw`
    SELECT u.id_usuario, u.nombre, u.apellido, u.correo, u.telefono, r.nombre AS rol, u.estado
    FROM USUARIO u
    JOIN ROL r ON r.id_rol = u.id_rol
    WHERE u.correo = ${correo}
    LIMIT 1
  `;

  return usuarioRows[0];
}

/**
 * Login + bitÃ¡cora de acceso + JWT
 */
export async function loginService({ correo, password, ip, userAgent }) {
  const usuarios = await prisma.$queryRaw`
    SELECT u.id_usuario, u.password_hash, u.nombre, u.apellido, u.correo,
           u.estado, r.nombre AS rol
    FROM USUARIO u
    JOIN ROL r ON r.id_rol = u.id_rol
    WHERE u.correo = ${correo}
    LIMIT 1
  `;

  const user = usuarios[0];

  if (!user) {
    // AquÃ­ podrÃ­as registrar bitÃ¡cora sin usuario, si quisieras
    const error = new Error("Credenciales invÃ¡lidas");
    error.status = 401;
    throw error;
  }

  // ===== compatibilidad con hashes bcrypt y texto plano =====
  let ok = false;

  try {
    // Si parece un hash bcrypt ($2a$, $2b$, $2y$...), usamos bcrypt.compare
    if (user.password_hash && user.password_hash.startsWith("$2")) {
      ok = await bcrypt.compare(password, user.password_hash);
    } else {
      // Si NO parece hash, asumimos que estÃ¡ en texto plano (ej: '123456')
      ok = password === user.password_hash;
    }
  } catch (e) {
    // Si bcrypt truena por hash invÃ¡lido, hacemos fallback a texto plano
    ok = password === user.password_hash;
  }

  const resultadoNombre = ok ? "OK" : "FAIL";
  const idResultado = await getResultadoAccesoId(resultadoNombre);

  // Registrar en BITACORA_ACCESO (solo si tenemos usuario)
  await prisma.$queryRaw`
    INSERT INTO BITACORA_ACCESO (id_usuario, fecha, direccion_ip, user_agent, id_resultado)
    VALUES (${user.id_usuario}, NOW(), ${ip}, ${userAgent}, ${idResultado})
  `;

  if (!ok) {
    const error = new Error("Credenciales invÃ¡lidas");
    error.status = 401;
    throw error;
  }

  const payload = {
    id_usuario: user.id_usuario,
    correo: user.correo,
    rol: user.rol,
  };

  const token = jwt.sign(payload, process.env.JWT_SECRET, {
    expiresIn: "2h",
  });

  return {
    token,
    usuario: {
      id_usuario: user.id_usuario,
      nombre: user.nombre,
      apellido: user.apellido,
      correo: user.correo,
      rol: user.rol,
      estado: user.estado,
    },
  };
}

/**
 * Perfil de usuario por id
 */
export async function obtenerPerfilService(idUsuario) {
  const rows = await prisma.$queryRaw`
    SELECT u.id_usuario, u.nombre, u.apellido, u.correo, u.telefono,
           u.estado, u.url_perfil, r.nombre AS rol
    FROM USUARIO u
    JOIN ROL r ON r.id_rol = u.id_rol
    WHERE u.id_usuario = ${idUsuario}
    LIMIT 1
  `;
  if (!rows.length) {
    const err = new Error("Usuario no encontrado");
    err.status = 404;
    throw err;
  }
  return rows[0];
}

/**
 * Actualizar perfil de un usuario
 * (no borra campos si no se envÃ­an)
 */
export async function actualizarPerfilService(idUsuario, datos) {
  const { nombre, apellido, telefono, url_perfil } = datos;

  // 1) Obtener valores actuales
  const currentRows = await prisma.$queryRaw`
    SELECT id_usuario, nombre, apellido, telefono, url_perfil, id_rol, estado, correo
    FROM USUARIO
    WHERE id_usuario = ${idUsuario}
    LIMIT 1
  `;

  if (!currentRows.length) {
    const err = new Error("Usuario no encontrado");
    err.status = 404;
    throw err;
  }

  const current = currentRows[0];

  // 2) Mezclar valores nuevos con actuales
  const nuevoNombre = nombre !== undefined ? nombre : current.nombre;
  const nuevoApellido = apellido !== undefined ? apellido : current.apellido;
  const nuevoTelefono = telefono !== undefined ? telefono : current.telefono;
  const nuevaUrlPerfil =
    url_perfil !== undefined ? url_perfil : current.url_perfil;

  // 3) Actualizar
  await prisma.$queryRaw`
    UPDATE USUARIO
    SET
      nombre = ${nuevoNombre},
      apellido = ${nuevoApellido},
      telefono = ${nuevoTelefono},
      url_perfil = ${nuevaUrlPerfil}
    WHERE id_usuario = ${idUsuario}
  `;

  // 4) Devolver datos actualizados + rol
  const rows = await prisma.$queryRaw`
    SELECT u.id_usuario, u.nombre, u.apellido, u.correo, u.telefono,
           u.estado, u.url_perfil, r.nombre AS rol
    FROM USUARIO u
    JOIN ROL r ON r.id_rol = u.id_rol
    WHERE u.id_usuario = ${idUsuario}
    LIMIT 1
  `;

  return rows[0];
}

/**
 * Cambiar contraseÃ±a de un usuario
 */
export async function cambiarPasswordService(
  idUsuario,
  passwordActual,
  passwordNueva
) {
  const rows = await prisma.$queryRaw`
    SELECT password_hash
    FROM USUARIO
    WHERE id_usuario = ${idUsuario}
    LIMIT 1
  `;

  if (!rows.length) {
    const err = new Error("Usuario no encontrado");
    err.status = 404;
    throw err;
  }

  const { password_hash } = rows[0];

  let ok = false;

  try {
    if (password_hash && password_hash.startsWith("$2")) {
      ok = await bcrypt.compare(passwordActual, password_hash);
    } else {
      ok = passwordActual === password_hash;
    }
  } catch (e) {
    ok = passwordActual === password_hash;
  }

  if (!ok) {
    const err = new Error("La contraseÃ±a actual es incorrecta");
    err.status = 400;
    throw err;
  }

  const nuevoHash = await bcrypt.hash(passwordNueva, 10);

  await prisma.$queryRaw`
    UPDATE USUARIO
    SET password_hash = ${nuevoHash}
    WHERE id_usuario = ${idUsuario}
  `;

  return true;
}
</file>

<file path="src/modules/bitacoras/bitacoras.controller.js">
// src/modules/bitacoras/bitacoras.controller.js
import {
  listarAccesosService,
  listarBitacoraIntercambiosService,
} from "./bitacoras.service.js";

function toInt(v, def = null) {
  const n = Number(v);
  return Number.isNaN(n) ? def : n;
}

/**
 * GET /api/bitacoras/accesos
 * Admin: lista accesos (con paginaciÃ³n y filtro opcional por idUsuario)
 */
export async function getAccesosController(req, res, next) {
  try {
    const { page, pageSize, idUsuario } = req.query;

    const result = await listarAccesosService({
      page: toInt(page, 1),
      pageSize: toInt(pageSize, 20),
      idUsuario: idUsuario ? toInt(idUsuario) : null,
    });

    res.json(result);
  } catch (err) {
    next(err);
  }
}

/**
 * GET /api/bitacoras/mis-accesos
 * Usuario normal: ve solo sus propios accesos
 */
export async function getMisAccesosController(req, res, next) {
  try {
    const { page, pageSize } = req.query;
    const idUsuario = req.user.id_usuario;

    const result = await listarAccesosService({
      page: toInt(page, 1),
      pageSize: toInt(pageSize, 20),
      idUsuario,
    });

    res.json(result);
  } catch (err) {
    next(err);
  }
}

/**
 * GET /api/bitacoras/intercambios
 * Admin: bitÃ¡cora de intercambios.
 * Filtros opcionales: ?idTransaccion=&idUsuario=
 */
export async function getBitacoraIntercambiosController(req, res, next) {
  try {
    const { page, pageSize, idTransaccion, idUsuario } = req.query;

    const result = await listarBitacoraIntercambiosService({
      page: toInt(page, 1),
      pageSize: toInt(pageSize, 20),
      idTransaccion: idTransaccion ? toInt(idTransaccion) : null,
      idUsuario: idUsuario ? toInt(idUsuario) : null,
    });

    res.json(result);
  } catch (err) {
    next(err);
  }
}
</file>

<file path="src/modules/bitacoras/bitacoras.routes.js">
// src/modules/bitacoras/bitacoras.routes.js
import { Router } from "express";
import { authMiddleware } from "../../middlewares/auth.js";
import { isAdmin } from "../../middlewares/isAdmin.js";
import {
  getAccesosController,
  getMisAccesosController,
  getBitacoraIntercambiosController,
} from "./bitacoras.controller.js";

const router = Router();

// Todas requieren login
router.use(authMiddleware);

// Admin: ver todos los accesos
router.get("/accesos", isAdmin, getAccesosController);

// Usuario: ver solo sus accesos
router.get("/mis-accesos", getMisAccesosController);

// Admin: bitÃ¡cora de intercambios
router.get("/intercambios", isAdmin, getBitacoraIntercambiosController);

export default router;
</file>

<file path="src/modules/bitacoras/bitacoras.service.js">
// src/modules/bitacoras/bitacoras.service.js
import { prisma } from "../../config/prisma.js";

/**
 * Listar accesos (BITACORA_ACCESO) con paginaciÃ³n.
 * Si se envÃ­a idUsuario, filtra por ese usuario.
 */
export async function listarAccesosService({
  page = 1,
  pageSize = 20,
  idUsuario = null,
}) {
  const limit = Math.max(1, Math.min(Number(pageSize) || 20, 100));
  const pageNum = Math.max(Number(page) || 1, 1);
  const offset = (pageNum - 1) * limit;

  let where = "WHERE 1=1";
  const params = [];

  if (idUsuario) {
    where += " AND b.id_usuario = ?";
    params.push(Number(idUsuario));
  }

  const countSql = `
    SELECT COUNT(*) AS total
    FROM BITACORA_ACCESO b
    ${where}
  `;
  const [countRow] = await prisma.$queryRawUnsafe(countSql, ...params);
  const total = Number(countRow?.total || 0);

  const dataSql = `
    SELECT
      b.id_acceso AS id_bitacora,
      b.id_usuario,
      u.nombre,
      u.correo,
      b.fecha,
      b.direccion_ip,
      b.user_agent,
      r.nombre AS resultado
    FROM BITACORA_ACCESO b
    JOIN USUARIO u ON u.id_usuario = b.id_usuario
    JOIN RESULTADO_ACCESO r ON r.id_resultado = b.id_resultado
    ${where}
    ORDER BY b.fecha DESC, b.id_acceso DESC
    LIMIT ? OFFSET ?
  `;
  const data = await prisma.$queryRawUnsafe(
    dataSql,
    ...params,
    limit,
    offset
  );

  return {
    page: pageNum,
    pageSize: limit,
    total,
    data,
  };
}

/**
 * BitÃ¡cora de intercambios (BITACORA_INTERCAMBIO) con paginaciÃ³n.
 * Opcional: filtrar por idTransaccion o idUsuario (origen/destino).
 */
export async function listarBitacoraIntercambiosService({
  page = 1,
  pageSize = 20,
  idTransaccion = null,
  idUsuario = null,
}) {
  const limit = Math.max(1, Math.min(Number(pageSize) || 20, 100));
  const pageNum = Math.max(Number(page) || 1, 1);
  const offset = (pageNum - 1) * limit;

  let where = "WHERE 1=1";
  const params = [];

  if (idTransaccion) {
    where += " AND bi.id_transaccion = ?";
    params.push(Number(idTransaccion));
  }

  if (idUsuario) {
    where +=
      " AND (bi.id_usuario_origen = ? OR bi.id_usuario_destino = ?)";
    params.push(Number(idUsuario), Number(idUsuario));
  }

  const countSql = `
    SELECT COUNT(*) AS total
    FROM BITACORA_INTERCAMBIO bi
    ${where}
  `;
  const [countRow] = await prisma.$queryRawUnsafe(countSql, ...params);
  const total = Number(countRow?.total || 0);

  const dataSql = `
    SELECT
      bi.id_bitacora,
      bi.id_transaccion,
      bi.id_usuario_origen,
      uo.nombre  AS usuario_origen,
      bi.id_usuario_destino,
      ud.nombre  AS usuario_destino,
      bi.cantidad_creditos,
      bi.descripcion,
      t.estado   AS estado_transaccion,
      t.creado_en AS fecha_transaccion
    FROM BITACORA_INTERCAMBIO bi
    JOIN TRANSACCION t
      ON t.id_transaccion = bi.id_transaccion
    JOIN USUARIO uo
      ON uo.id_usuario = bi.id_usuario_origen
    JOIN USUARIO ud
      ON ud.id_usuario = bi.id_usuario_destino
    ${where}
    ORDER BY bi.id_bitacora DESC
    LIMIT ? OFFSET ?
  `;
  const data = await prisma.$queryRawUnsafe(
    dataSql,
    ...params,
    limit,
    offset
  );

  return {
    page: pageNum,
    pageSize: limit,
    total,
    data,
  };
}
</file>

<file path="src/modules/catalogos/catalogos.controller.js">
import {
  listarCategorias,
  listarUnidadesMedida,
  listarPaquetesCreditos,
  listarTiposActividad,
  listarTiposPromocion,
  listarUbicacionesPublicidad,
  listarTiposLogro,
  // Opcional (para admin â€“ CRUD)
  crearCatalogoService,
  editarCatalogoService,
} from "./catalogos.service.js";

// Helper para respuestas limpias
function ok(res, data) {
  return res.json({ ok: true, data });
}

/* =======================
   CATÃLOGOS PÃšBLICOS
   ======================= */

export const getCategorias = async (_req, res, next) => {
  try {
    ok(res, await listarCategorias());
  } catch (e) {
    next(e);
  }
};

export const getUnidadesMedida = async (_req, res, next) => {
  try {
    ok(res, await listarUnidadesMedida());
  } catch (e) {
    next(e);
  }
};

export const getPaquetesCreditos = async (_req, res, next) => {
  try {
    ok(res, await listarPaquetesCreditos());
  } catch (e) {
    next(e);
  }
};

export const getTiposActividad = async (_req, res, next) => {
  try {
    ok(res, await listarTiposActividad());
  } catch (e) {
    next(e);
  }
};

export const getTiposPromocion = async (_req, res, next) => {
  try {
    ok(res, await listarTiposPromocion());
  } catch (e) {
    next(e);
  }
};

export const getUbicacionesPublicidad = async (_req, res, next) => {
  try {
    ok(res, await listarUbicacionesPublicidad());
  } catch (e) {
    next(e);
  }
};

export const getTiposLogro = async (_req, res, next) => {
  try {
    ok(res, await listarTiposLogro());
  } catch (e) {
    next(e);
  }
};

/* =======================
   OPCIONAL: ADMIN â€“ CRUD
   ======================= */

export const crearCatalogoController = async (req, res, next) => {
  try {
    const { tabla, nombre } = req.body;
    const result = await crearCatalogoService(tabla, nombre);
    res
      .status(201)
      .json({ ok: true, message: "Creado correctamente", data: result });
  } catch (e) {
    next(e);
  }
};

export const editarCatalogoController = async (req, res, next) => {
  try {
    const { tabla, id, nombre } = req.body;
    const result = await editarCatalogoService(tabla, id, nombre);
    res.json({ ok: true, message: "Actualizado correctamente", data: result });
  } catch (e) {
    next(e);
  }
};
</file>

<file path="src/modules/catalogos/catalogos.routes.js">
import { Router } from "express";
import {
  getCategorias,
  getUnidadesMedida,
  getPaquetesCreditos,
  getTiposActividad,
  getTiposPromocion,
  getUbicacionesPublicidad,
  getTiposLogro,
  // CRUD opcional solo admin
  crearCatalogoController,
  editarCatalogoController,
} from "./catalogos.controller.js";

import { authMiddleware } from "../../middlewares/auth.js";
import { isAdmin } from "../../middlewares/isAdmin.js";

const router = Router();

/* =======================
   RUTAS PÃšBLICAS
   ======================= */
router.get("/categorias", getCategorias);
router.get("/unidades-medida", getUnidadesMedida);
router.get("/paquetes-creditos", getPaquetesCreditos);
router.get("/tipos-actividad", getTiposActividad);
router.get("/tipos-promocion", getTiposPromocion);
router.get("/ubicaciones-publicidad", getUbicacionesPublicidad);
router.get("/tipos-logro", getTiposLogro);

/* =======================
   RUTAS ADMIN (OPCIONALES)
   ======================= */
router.use(authMiddleware, isAdmin);

router.post("/admin/crear", crearCatalogoController);
router.put("/admin/editar", editarCatalogoController);

export default router;
</file>

<file path="src/modules/catalogos/catalogos.service.js">
import { prisma } from "../../config/prisma.js";

/* =======================
   LISTADOS
   ======================= */

export const listarCategorias = () =>
  prisma.$queryRaw`SELECT * FROM CATEGORIA ORDER BY nombre`;

export const listarUnidadesMedida = () =>
  prisma.$queryRaw`SELECT * FROM UNIDAD_MEDIDA ORDER BY nombre`;

export const listarPaquetesCreditos = () =>
  prisma.$queryRaw`SELECT * FROM PAQUETE_CREDITOS WHERE activo = TRUE ORDER BY cantidad_creditos`;

export const listarTiposActividad = () =>
  prisma.$queryRaw`SELECT * FROM TIPO_ACTIVIDAD ORDER BY nombre`;

export const listarTiposPromocion = () =>
  prisma.$queryRaw`SELECT * FROM TIPO_PROMOCION ORDER BY nombre`;

export const listarUbicacionesPublicidad = () =>
  prisma.$queryRaw`SELECT * FROM UBICACION_PUBLICIDAD ORDER BY nombre`;

export const listarTiposLogro = () =>
  prisma.$queryRaw`SELECT * FROM TIPO_LOGRO ORDER BY nombre`;

/* =======================
   CRUD OPCIONAL (ADMIN)
   ======================= */

/**
 * Solo catÃ¡logos "simples" (id, nombre, descripcion opcional)
 * que admiten INSERT(nombre) sin campos extra obligatorios.
 */
const tablasPermitidas = {
  categoria: {
    tabla: "CATEGORIA",
    idCol: "id_categoria",
  },
  tipo_actividad: {
    tabla: "TIPO_ACTIVIDAD",
    idCol: "id_tipo_actividad",
  },
  tipo_promocion: {
    tabla: "TIPO_PROMOCION",
    idCol: "id_tipo_promocion",
  },
  tipo_logro: {
    tabla: "TIPO_LOGRO",
    idCol: "id_tipo_logro",
  },
  // NOTA:
  // UNIDAD_MEDIDA y UBICACION_PUBLICIDAD quedan solo lectura,
  // porque requieren mÃ¡s campos (simbolo, precio_base, etc.).
};

/**
 * Crear registro en catÃ¡logo genÃ©rico (ADMIN)
 */
export async function crearCatalogoService(tabla, nombre) {
  const meta = tablasPermitidas[tabla];
  if (!meta) {
    const err = new Error("CatÃ¡logo no permitido para creaciÃ³n genÃ©rica");
    err.status = 400;
    throw err;
  }

  if (!nombre) {
    const err = new Error("El nombre es obligatorio");
    err.status = 400;
    throw err;
  }

  await prisma.$queryRawUnsafe(
    `INSERT INTO ${meta.tabla} (nombre) VALUES (?)`,
    nombre
  );

  // devolver el Ãºltimo creado (por nombre)
  const [row] = await prisma.$queryRawUnsafe(
    `SELECT * FROM ${meta.tabla} WHERE nombre = ? ORDER BY ${meta.idCol} DESC LIMIT 1`,
    nombre
  );

  return row || { tabla: meta.tabla, nombre };
}

/**
 * Editar registro en catÃ¡logo genÃ©rico (ADMIN)
 */
export async function editarCatalogoService(tabla, id, nombre) {
  const meta = tablasPermitidas[tabla];
  if (!meta) {
    const err = new Error("CatÃ¡logo no permitido para ediciÃ³n genÃ©rica");
    err.status = 400;
    throw err;
  }

  if (!id || !nombre) {
    const err = new Error("id y nombre son obligatorios");
    err.status = 400;
    throw err;
  }

  await prisma.$queryRawUnsafe(
    `UPDATE ${meta.tabla} SET nombre = ? WHERE ${meta.idCol} = ?`,
    nombre,
    id
  );

  const [row] = await prisma.$queryRawUnsafe(
    `SELECT * FROM ${meta.tabla} WHERE ${meta.idCol} = ? LIMIT 1`,
    id
  );

  return row || { tabla: meta.tabla, id, nombre };
}
</file>

<file path="src/modules/intercambios/intercambios.controller.js">
import {
  crearIntercambioService,
  misComprasService,
  misVentasService,
  detalleTransaccionService,
} from "./intercambios.service.js";

export const crearIntercambioController = async (req, res, next) => {
  try {
    const idComprador = req.user.id_usuario;
    const { id_publicacion, creditos } = req.body;

    const tx = await crearIntercambioService({
      idComprador,
      id_publicacion,
      creditos,
    });

    res
      .status(201)
      .json({ message: "Intercambio creado correctamente", transaccion: tx });
  } catch (e) {
    next(e);
  }
};

export const misComprasController = async (req, res, next) => {
  try {
    const compras = await misComprasService(req.user.id_usuario);
    res.json(compras);
  } catch (e) {
    next(e);
  }
};

export const misVentasController = async (req, res, next) => {
  try {
    const ventas = await misVentasService(req.user.id_usuario);
    res.json(ventas);
  } catch (e) {
    next(e);
  }
};

export const detalleTransaccionController = async (req, res, next) => {
  try {
    const id = Number(req.params.id);
    if (!Number.isFinite(id)) {
      return res.status(400).json({ message: "ID de transacciÃ³n invÃ¡lido" });
    }

    const detalle = await detalleTransaccionService(id);
    res.json(detalle);
  } catch (e) {
    next(e);
  }
};
</file>

<file path="src/modules/intercambios/intercambios.routes.js">
import { Router } from "express";
import { authMiddleware } from "../../middlewares/auth.js";
import {
  crearIntercambioController,
  misComprasController,
  misVentasController,
  detalleTransaccionController,
} from "./intercambios.controller.js";

const router = Router();

// Todas las rutas requieren estar logueado
router.use(authMiddleware);

// Crear nuevo intercambio
router.post("/", crearIntercambioController);

// Ver mis compras
router.get("/mis-compras", misComprasController);

// Ver mis ventas
router.get("/mis-ventas", misVentasController);

// Detalle de una transacciÃ³n
router.get("/:id", detalleTransaccionController);

export default router;
</file>

<file path="src/modules/intercambios/intercambios.service.js">
import { prisma } from "../../config/prisma.js";

export async function crearIntercambioService({
  idComprador,
  id_publicacion,
  creditos,
}) {
  if (!id_publicacion || creditos == null) {
    const err = new Error("id_publicacion y creditos son obligatorios");
    err.status = 400;
    throw err;
  }

  const creditosNum = Number(creditos);
  if (!Number.isFinite(creditosNum) || creditosNum <= 0) {
    const err = new Error("creditos debe ser un nÃºmero mayor a 0");
    err.status = 400;
    throw err;
  }

  // Llamar SP que encapsula toda la lÃ³gica de negocio
  await prisma.$executeRawUnsafe(
    "CALL sp_realizar_intercambio(?, ?, ?)",
    idComprador,
    id_publicacion,
    creditosNum
  );

  // Ãšltima transacciÃ³n creada por el comprador (mÃ¡s reciente)
  const [tx] = await prisma.$queryRaw`
    SELECT t.*, p.titulo
    FROM TRANSACCION t
    JOIN PUBLICACION p ON p.id_publicacion = t.id_publicacion
    WHERE t.id_comprador = ${idComprador}
    ORDER BY t.creado_en DESC, t.id_transaccion DESC
    LIMIT 1
  `;

  return tx;
}

export async function misComprasService(idUsuario) {
  return prisma.$queryRaw`
    SELECT t.*, p.titulo
    FROM TRANSACCION t
    JOIN PUBLICACION p ON p.id_publicacion = t.id_publicacion
    WHERE t.id_comprador = ${idUsuario}
    ORDER BY t.creado_en DESC
  `;
}

export async function misVentasService(idUsuario) {
  return prisma.$queryRaw`
    SELECT t.*, p.titulo
    FROM TRANSACCION t
    JOIN PUBLICACION p ON p.id_publicacion = t.id_publicacion
    WHERE t.id_vendedor = ${idUsuario}
    ORDER BY t.creado_en DESC
  `;
}

export async function detalleTransaccionService(idTransaccion) {
  const [row] = await prisma.$queryRaw`
    SELECT
      t.*,
      p.titulo,
      p.descripcion,
      p.valor_creditos
    FROM TRANSACCION t
    JOIN PUBLICACION p ON p.id_publicacion = t.id_publicacion
    WHERE t.id_transaccion = ${idTransaccion}
    LIMIT 1
  `;

  if (!row) {
    const err = new Error("TransacciÃ³n no encontrada");
    err.status = 404;
    throw err;
  }

  return row;
}
</file>

<file path="src/modules/logros/logros.controller.js">
import {
  misLogrosService,
  listarLogrosService,
} from "./logros.service.js";

export const misLogrosController = async (req, res, next) => {
  try {
    const idUsuario = req.user.id_usuario;
    const logros = await misLogrosService(idUsuario);
    res.json(logros);
  } catch (e) {
    next(e);
  }
};

/**
 * Listado completo de logros (solo admin)
 * Soporta filtro opcional:
 *   GET /api/logros?id_tipo_logro=1
 */
export const listarLogrosController = async (req, res, next) => {
  try {
    const idTipo = req.query.id_tipo_logro
      ? Number(req.query.id_tipo_logro)
      : undefined;

    if (idTipo !== undefined && !Number.isFinite(idTipo)) {
      return res.status(400).json({ message: "id_tipo_logro invÃ¡lido" });
    }

    const logros = await listarLogrosService(idTipo);
    res.json({
      message: "Listado de logros",
      filtro: idTipo ? { id_tipo_logro: idTipo } : null,
      data: logros,
    });
  } catch (e) {
    next(e);
  }
};
</file>

<file path="src/modules/logros/logros.routes.js">
import { Router } from "express";
import { authMiddleware } from "../../middlewares/auth.js";
import { isAdmin } from "../../middlewares/isAdmin.js";
import {
  misLogrosController,
  listarLogrosController,
} from "./logros.controller.js";

const router = Router();

// Todas las rutas requieren estar logueado
router.use(authMiddleware);

// Ver mis logros (usuario normal)
router.get("/mios", misLogrosController);

// CatÃ¡logo completo de logros (solo admin, con filtro opcional)
router.get("/", isAdmin, listarLogrosController);

export default router;
</file>

<file path="src/modules/logros/logros.service.js">
import { prisma } from "../../config/prisma.js";

/**
 * Listar catÃ¡logo de logros (opcionalmente filtrado por tipo)
 * @param {number | undefined} idTipoLogro
 */
export const listarLogrosService = (idTipoLogro) => {
  if (idTipoLogro) {
    return prisma.$queryRaw`
      SELECT l.*, tl.nombre AS tipo_logro
      FROM LOGRO l
      JOIN TIPO_LOGRO tl ON tl.id_tipo_logro = l.id_tipo_logro
      WHERE l.id_tipo_logro = ${idTipoLogro}
      ORDER BY l.id_logro
    `;
  }

  // Sin filtro
  return prisma.$queryRaw`
    SELECT l.*, tl.nombre AS tipo_logro
    FROM LOGRO l
    JOIN TIPO_LOGRO tl ON tl.id_tipo_logro = l.id_tipo_logro
    ORDER BY l.id_logro
  `;
};

/**
 * Logros del usuario actual (catÃ¡logo + progreso)
 */
export const misLogrosService = (idUsuario) =>
  prisma.$queryRaw`
    SELECT
      ul.*,
      l.nombre,
      l.descripcion,
      l.meta_requerida,
      l.creditos_recompensa
    FROM USUARIO_LOGRO ul
    JOIN LOGRO l ON l.id_logro = ul.id_logro
    WHERE ul.id_usuario = ${idUsuario}
    ORDER BY l.id_logro
  `;
</file>

<file path="src/modules/premium/premium.controller.js">
// premium.controller.js
import {
  miPlanPremiumService,
  activarPremiumService,
} from "./premium.service.js";

export const miPlanPremiumController = async (req, res, next) => {
  try {
    const idUsuario = req.user.id_usuario;
    const plan = await miPlanPremiumService(idUsuario);
    res.json(plan);
  } catch (e) {
    next(e);
  }
};

export const activarPremiumController = async (req, res, next) => {
  try {
    const idUsuario = req.user.id_usuario;
    const data = await activarPremiumService(idUsuario);
    res
      .status(201)
      .json({ message: "SuscripciÃ³n premium activada correctamente", data });
  } catch (e) {
    next(e);
  }
};
</file>

<file path="src/modules/premium/premium.routes.js">
// premium.routes.js
import { Router } from "express";
import { authMiddleware } from "../../middlewares/auth.js";
import {
  miPlanPremiumController,
  activarPremiumController,
} from "./premium.controller.js";

const router = Router();

// Todas las rutas premium requieren estar autenticado
router.use(authMiddleware);

// Ver mi plan premium actual (la suscripciÃ³n mÃ¡s reciente)
router.get("/mi-plan", miPlanPremiumController);

// Activar premium (30 dÃ­as)
router.post("/activar", activarPremiumController);

export default router;
</file>

<file path="src/modules/premium/premium.service.js">
// premium.service.js
import { prisma } from "../../config/prisma.js";

/**
 * Devuelve la suscripciÃ³n premium mÃ¡s reciente del usuario,
 * o null si no tiene.
 */
export const miPlanPremiumService = async (idUsuario) => {
  const rows = await prisma.$queryRaw`
    SELECT *
    FROM SUSCRIPCION_PREMIUM
    WHERE id_usuario = ${idUsuario}
    ORDER BY fecha_inicio DESC
    LIMIT 1
  `;
  return rows[0] || null;
};

/**
 * Activa una suscripciÃ³n premium de 30 dÃ­as.
 * - Cierra suscripciones ACTIVA previas (las marca como VENCIDA).
 * - Crea una nueva suscripciÃ³n ACTIVA con monto fijo.
 */
export async function activarPremiumService(idUsuario) {
  // 1) Â¿Ya tiene una suscripciÃ³n ACTIVA que aÃºn no venciÃ³?
  const [activa] = await prisma.$queryRaw`
    SELECT *
    FROM SUSCRIPCION_PREMIUM
    WHERE id_usuario = ${idUsuario}
      AND estado = 'ACTIVA'
      AND (fecha_fin IS NULL OR fecha_fin > NOW())
    ORDER BY fecha_inicio DESC
    LIMIT 1
  `;

  if (activa) {
    const err = new Error(
      "Ya tienes una suscripciÃ³n premium activa actualmente"
    );
    err.status = 400;
    throw err;
  }

  // 2) Cerrar cualquier ACTIVA â€œviejaâ€ que quedÃ³ sin fecha_fin coherente
  await prisma.$executeRaw`
    UPDATE SUSCRIPCION_PREMIUM
    SET estado = 'VENCIDA',
        fecha_fin = IFNULL(fecha_fin, NOW())
    WHERE id_usuario = ${idUsuario}
      AND estado = 'ACTIVA'
      AND fecha_inicio <= NOW()
  `;

  // 3) Crear nueva suscripciÃ³n de 30 dÃ­as
  const fin = new Date();
  fin.setDate(fin.getDate() + 30);

  const monto = 20.0; // ðŸ’° aquÃ­ puedes parametrizar el precio si despuÃ©s tienes planes distintos

  await prisma.$executeRaw`
    INSERT INTO SUSCRIPCION_PREMIUM (
      id_usuario,
      fecha_fin,
      estado,
      monto_bs
    )
    VALUES (
      ${idUsuario},
      ${fin},
      'ACTIVA',
      ${monto}
    )
  `;

  // 4) Devolver la suscripciÃ³n reciÃ©n creada
  const [row] = await prisma.$queryRaw`
    SELECT *
    FROM SUSCRIPCION_PREMIUM
    WHERE id_usuario = ${idUsuario}
    ORDER BY fecha_inicio DESC
    LIMIT 1
  `;

  return row;
}
</file>

<file path="src/modules/promociones/promociones.controller.js">
import {
  listarPromocionesService,
  crearPromocionService,
  actualizarEstadoPromocionService,
  vincularPublicacionService,
} from "./promociones.service.js";

export const listarPromocionesController = async (_req, res, next) => {
  try {
    const promos = await listarPromocionesService();
    res.json(promos);
  } catch (e) {
    next(e);
  }
};

export const crearPromocionController = async (req, res, next) => {
  try {
    const promo = await crearPromocionService(req.body);
    res.status(201).json(promo);
  } catch (e) {
    next(e);
  }
};

export const actualizarEstadoPromocionController = async (req, res, next) => {
  try {
    const id = Number(req.params.id);
    if (!Number.isFinite(id)) {
      return res.status(400).json({ message: "ID de promociÃ³n invÃ¡lido" });
    }

    const { estado } = req.body;
    const promo = await actualizarEstadoPromocionService(id, estado);

    res.json({
      message: "Estado de promociÃ³n actualizado",
      data: promo,
    });
  } catch (e) {
    next(e);
  }
};

export const vincularPublicacionController = async (req, res, next) => {
  try {
    const idPromocion = Number(req.params.id);
    if (!Number.isFinite(idPromocion)) {
      return res.status(400).json({ message: "ID de promociÃ³n invÃ¡lido" });
    }

    const { id_publicacion } = req.body;
    await vincularPublicacionService(idPromocion, id_publicacion);

    res.status(201).json({ message: "PublicaciÃ³n vinculada correctamente" });
  } catch (e) {
    next(e);
  }
};
</file>

<file path="src/modules/promociones/promociones.routes.js">
import { Router } from "express";
import { authMiddleware } from "../../middlewares/auth.js";
import { isAdmin } from "../../middlewares/isAdmin.js";
import {
  listarPromocionesController,
  crearPromocionController,
  actualizarEstadoPromocionController,
  vincularPublicacionController,
} from "./promociones.controller.js";

const router = Router();

// Todo el mÃ³dulo de promociones es solo ADMIN
router.use(authMiddleware, isAdmin);

// Listar promociones
router.get("/", listarPromocionesController);

// Crear nueva promociÃ³n
router.post("/", crearPromocionController);

// Cambiar estado de promociÃ³n
router.patch("/:id/estado", actualizarEstadoPromocionController);

// Vincular publicaciÃ³n a promociÃ³n (dispara bono vÃ­a trigger)
router.post("/:id/publicaciones", vincularPublicacionController);

export default router;
</file>

<file path="src/modules/promociones/promociones.service.js">
import { prisma } from "../../config/prisma.js";

/**
 * Listar promociones (panel admin).
 * MÃ¡s adelante podrÃ­as agregar filtros:
 *   - por estado (?estado=ACTIVA)
 *   - por rango de fechas (?desde, ?hasta)
 */
export const listarPromocionesService = () =>
  prisma.$queryRaw`
    SELECT *
    FROM PROMOCION
    ORDER BY fecha_inicio DESC
  `;

// Valores vÃ¡lidos segÃºn ENUM de la BD
const ESTADOS_VALIDOS = [
  "PROGRAMADA",
  "ACTIVA",
  "PAUSADA",
  "FINALIZADA",
  "CANCELADA",
];

export async function crearPromocionService(body) {
  const {
    id_tipo_promocion,
    nombre,
    descripcion,
    creditos_otorgados,
    fecha_inicio,
    fecha_fin,
    estado = "PROGRAMADA", // ðŸ‘‰ mejor default coherente con la BD
  } = body;

  if (
    !id_tipo_promocion ||
    !nombre ||
    !creditos_otorgados ||
    !fecha_inicio ||
    !fecha_fin
  ) {
    const err = new Error("Faltan datos obligatorios de promociÃ³n");
    err.status = 400;
    throw err;
  }

  // Validar estado (si viene)
  if (estado && !ESTADOS_VALIDOS.includes(estado)) {
    const err = new Error("Estado de promociÃ³n invÃ¡lido");
    err.status = 400;
    throw err;
  }

  // Validar fechas mÃ­nimamente
  const ini = new Date(fecha_inicio);
  const fin = new Date(fecha_fin);
  if (!(ini instanceof Date && !isNaN(ini)) || !(fin instanceof Date && !isNaN(fin))) {
    const err = new Error("fecha_inicio o fecha_fin invÃ¡lidas");
    err.status = 400;
    throw err;
  }
  if (fin <= ini) {
    const err = new Error("fecha_fin debe ser mayor a fecha_inicio");
    err.status = 400;
    throw err;
  }

  await prisma.$queryRaw`
    INSERT INTO PROMOCION (
      id_tipo_promocion,
      nombre,
      descripcion,
      creditos_otorgados,
      fecha_inicio,
      fecha_fin,
      estado
    )
    VALUES (
      ${id_tipo_promocion},
      ${nombre},
      ${descripcion || null},
      ${creditos_otorgados},
      ${fecha_inicio},
      ${fecha_fin},
      ${estado}
    )
  `;

  const [row] = await prisma.$queryRaw`
    SELECT *
    FROM PROMOCION
    WHERE id_promocion = LAST_INSERT_ID()
    LIMIT 1
  `;

  return row;
}

export async function actualizarEstadoPromocionService(idPromocion, estado) {
  if (!ESTADOS_VALIDOS.includes(estado)) {
    const err = new Error("Estado de promociÃ³n invÃ¡lido");
    err.status = 400;
    throw err;
  }

  await prisma.$queryRaw`
    UPDATE PROMOCION
    SET estado = ${estado}
    WHERE id_promocion = ${idPromocion}
  `;

  const [row] = await prisma.$queryRaw`
    SELECT *
    FROM PROMOCION
    WHERE id_promocion = ${idPromocion}
    LIMIT 1
  `;

  if (!row) {
    const err = new Error("PromociÃ³n no encontrada");
    err.status = 404;
    throw err;
  }

  return row;
}

export async function vincularPublicacionService(idPromocion, idPublicacion) {
  if (!idPublicacion) {
    const err = new Error("id_publicacion es obligatorio");
    err.status = 400;
    throw err;
  }

  await prisma.$queryRaw`
    INSERT IGNORE INTO PROMOCION_PUBLICACION (id_promocion, id_publicacion)
    VALUES (${idPromocion}, ${idPublicacion})
  `;

  // El trigger trg_promopub_after_ins_bono se encarga del bono de crÃ©ditos
}
</file>

<file path="src/modules/publicaciones/publicaciones.controller.js">
import {
  listarPublicacionesService,
  obtenerPublicacionService,
  crearPublicacionProductoService,
  crearPublicacionServicioService,
  misPublicacionesService,
  buscarPublicacionesService,
  crearCalificacionService,
  listarCalificacionesService,
  actualizarPublicacionService,
  cambiarEstadoPublicacionService,
  eliminarPublicacionService,
} from "./publicaciones.service.js";

export const listarPublicacionesController = async (req, res, next) => {
  try {
    const { categoria, estado, page, pageSize } = req.query;

    const pageNum = page ? Number(page) : undefined;
    const pageSizeNum = pageSize ? Number(pageSize) : undefined;

    const data = await listarPublicacionesService({
      categoria,
      estado,
      page: pageNum,
      pageSize: pageSizeNum,
    });

    res.json(data);
  } catch (e) {
    next(e);
  }
};

export const obtenerPublicacionController = async (req, res, next) => {
  try {
    const id = Number(req.params.id);
    if (!Number.isFinite(id)) {
      return res.status(400).json({ message: "ID de publicaciÃ³n invÃ¡lido" });
    }
    const pub = await obtenerPublicacionService(id);
    res.json(pub);
  } catch (e) {
    next(e);
  }
};

export const crearPublicacionProductoController = async (req, res, next) => {
  try {
    const idUsuario = req.user.id_usuario;
    const pub = await crearPublicacionProductoService(idUsuario, req.body);
    res.status(201).json(pub);
  } catch (e) {
    next(e);
  }
};

export const crearPublicacionServicioController = async (req, res, next) => {
  try {
    const idUsuario = req.user.id_usuario;
    const pub = await crearPublicacionServicioService(idUsuario, req.body);
    res.status(201).json(pub);
  } catch (e) {
    next(e);
  }
};

export const misPublicacionesController = async (req, res, next) => {
  try {
    const idUsuario = req.user.id_usuario;
    const pubs = await misPublicacionesService(idUsuario);
    res.json(pubs);
  } catch (e) {
    next(e);
  }
};

export const buscarPublicacionesController = async (req, res, next) => {
  try {
    const q = req.query.q || "";
    const result = await buscarPublicacionesService(q);
    res.json(result);
  } catch (e) {
    next(e);
  }
};

export const crearCalificacionController = async (req, res, next) => {
  try {
    const idUsuario = req.user.id_usuario;
    const idPublicacion = Number(req.params.id);

    if (!Number.isFinite(idPublicacion)) {
      return res.status(400).json({ message: "ID de publicaciÃ³n invÃ¡lido" });
    }

    const { estrellas, comentario } = req.body;
    const calif = await crearCalificacionService({
      idUsuario,
      idPublicacion,
      estrellas,
      comentario,
    });

    res.status(201).json(calif);
  } catch (e) {
    next(e);
  }
};

export const listarCalificacionesController = async (req, res, next) => {
  try {
    const idPublicacion = Number(req.params.id);
    if (!Number.isFinite(idPublicacion)) {
      return res.status(400).json({ message: "ID de publicaciÃ³n invÃ¡lido" });
    }

    const califs = await listarCalificacionesService(idPublicacion);
    res.json(califs);
  } catch (e) {
    next(e);
  }
};

/* ============================================================
   NUEVO: Editar, cambiar estado y eliminar publicaciÃ³n
   ============================================================ */

/**
 * PUT /api/publicaciones/:id
 * Permite al dueÃ±o (o ADMIN) actualizar datos bÃ¡sicos de la publicaciÃ³n.
 */
export const actualizarPublicacionController = async (req, res, next) => {
  try {
    const idPublicacion = Number(req.params.id);
    if (!Number.isFinite(idPublicacion)) {
      return res.status(400).json({ message: "ID de publicaciÃ³n invÃ¡lido" });
    }

    const idUsuario = req.user.id_usuario;
    const rol = req.user.rol;

    const pub = await actualizarPublicacionService(
      idUsuario,
      rol,
      idPublicacion,
      req.body
    );

    res.json({
      message: "PublicaciÃ³n actualizada correctamente",
      publicacion: pub,
    });
  } catch (e) {
    next(e);
  }
};

/**
 * PATCH /api/publicaciones/:id/estado
 * Cambia el estado de la publicaciÃ³n (BORRADOR, PUBLICADA, PAUSADA, AGOTADA, OCULTA, ELIMINADA)
 */
export const cambiarEstadoPublicacionController = async (req, res, next) => {
  try {
    const idPublicacion = Number(req.params.id);
    if (!Number.isFinite(idPublicacion)) {
      return res.status(400).json({ message: "ID de publicaciÃ³n invÃ¡lido" });
    }

    const { estado } = req.body;
    const idUsuario = req.user.id_usuario;
    const rol = req.user.rol;

    const pub = await cambiarEstadoPublicacionService(
      idUsuario,
      rol,
      idPublicacion,
      estado
    );

    res.json({
      message: "Estado de publicaciÃ³n actualizado",
      publicacion: pub,
    });
  } catch (e) {
    next(e);
  }
};

/**
 * DELETE /api/publicaciones/:id
 * EliminaciÃ³n lÃ³gica â†’ se marca estado = 'ELIMINADA'
 */
export const eliminarPublicacionController = async (req, res, next) => {
  try {
    const idPublicacion = Number(req.params.id);
    if (!Number.isFinite(idPublicacion)) {
      return res.status(400).json({ message: "ID de publicaciÃ³n invÃ¡lido" });
    }

    const idUsuario = req.user.id_usuario;
    const rol = req.user.rol;

    const pub = await eliminarPublicacionService(idUsuario, rol, idPublicacion);

    res.json({
      message: "PublicaciÃ³n eliminada (estado = ELIMINADA)",
      publicacion: pub,
    });
  } catch (e) {
    next(e);
  }
};
</file>

<file path="src/modules/publicaciones/publicaciones.routes.js">
import { Router } from "express";
import { authMiddleware } from "../../middlewares/auth.js";
import {
  listarPublicacionesController,
  obtenerPublicacionController,
  crearPublicacionProductoController,
  crearPublicacionServicioController,
  misPublicacionesController,
  buscarPublicacionesController,
  crearCalificacionController,
  listarCalificacionesController,
  actualizarPublicacionController,
  cambiarEstadoPublicacionController,
  eliminarPublicacionController,
} from "./publicaciones.controller.js";

const router = Router();

/* ====== RUTAS PÃšBLICAS ====== */
// PaginaciÃ³n opcional: ?page=1&pageSize=12
router.get("/", listarPublicacionesController);
router.get("/busqueda", buscarPublicacionesController);

// OJO: la mÃ¡s especÃ­fica primero
router.get("/:id/calificaciones", listarCalificacionesController);
router.get("/:id", obtenerPublicacionController);

/* ====== RUTAS PROTEGIDAS (requieren login) ====== */
router.use(authMiddleware);

// Mis publicaciones
router.get("/mias/listado", misPublicacionesController);

// Crear publicaciones
router.post("/producto", crearPublicacionProductoController);
router.post("/servicio", crearPublicacionServicioController);

// Calificar publicaciÃ³n
router.post("/:id/calificaciones", crearCalificacionController);

// NUEVOS: editar / estado / eliminar
router.put("/:id", actualizarPublicacionController);
router.patch("/:id/estado", cambiarEstadoPublicacionController);
router.delete("/:id", eliminarPublicacionController);

export default router;
</file>

<file path="src/modules/publicaciones/publicaciones.service.js">
import { prisma } from "../../config/prisma.js";

const ESTADOS_PUBLICACION = [
  "BORRADOR",
  "PUBLICADA",
  "PAUSADA",
  "AGOTADA",
  "OCULTA",
  "ELIMINADA",
];

/* ============================================================
   LISTADO + PAGINACIÃ“N
   ============================================================ */

// Si NO mandas page/pageSize â†’ devuelve array simple (compatibilidad)
// Si mandas page â†’ devuelve { items, total, page, pageSize }
export async function listarPublicacionesService({
  categoria,
  estado,
  page,
  pageSize,
}) {
  let where = "WHERE 1=1";
  const params = [];

  if (categoria) {
    const catNum = Number(categoria);
    if (Number.isFinite(catNum)) {
      where += " AND p.id_categoria = ?";
      params.push(catNum);
    }
  }

  if (estado) {
    where += " AND p.estado = ?";
    params.push(estado);
  }

  const baseFrom = `
    FROM PUBLICACION p
    JOIN CATEGORIA c ON c.id_categoria = p.id_categoria
    JOIN USUARIO u   ON u.id_usuario   = p.id_usuario
    ${where}
  `;

  // Sin paginaciÃ³n â†’ comportamiento anterior
  if (!page) {
    const sql = `
      SELECT
        p.id_publicacion,
        p.titulo,
        p.descripcion,
        p.valor_creditos,
        p.estado,
        p.imagen_url,
        c.nombre AS categoria,
        u.nombre AS usuario
      ${baseFrom}
      ORDER BY p.creado_en DESC
    `;
    return prisma.$queryRawUnsafe(sql, ...params);
  }

  // Con paginaciÃ³n
  const currentPage = Math.max(Number(page) || 1, 1);
  const size = Math.max(Number(pageSize) || 10, 1);
  const offset = (currentPage - 1) * size;

  // total
  const [countRow] = await prisma.$queryRawUnsafe(
    `SELECT COUNT(*) AS total ${baseFrom}`,
    ...params
  );
  const total = Number(countRow?.total || 0);

  // items
  const paramsWithLimit = [...params, offset, size];
  const itemsSql = `
    SELECT
      p.id_publicacion,
      p.titulo,
      p.descripcion,
      p.valor_creditos,
      p.estado,
      p.imagen_url,
      c.nombre AS categoria,
      u.nombre AS usuario
    ${baseFrom}
    ORDER BY p.creado_en DESC
    LIMIT ?, ?
  `;
  const items = await prisma.$queryRawUnsafe(itemsSql, ...paramsWithLimit);

  return {
    items,
    total,
    page: currentPage,
    pageSize: size,
    totalPages: Math.ceil(total / size),
  };
}

/* ============================================================
   BÃSICOS
   ============================================================ */

export async function obtenerPublicacionService(idPublicacion) {
  const [row] = await prisma.$queryRaw`
    SELECT
      p.*,
      c.nombre AS categoria,
      u.nombre AS usuario
    FROM PUBLICACION p
    JOIN CATEGORIA c ON c.id_categoria = p.id_categoria
    JOIN USUARIO u   ON u.id_usuario   = p.id_usuario
    WHERE p.id_publicacion = ${idPublicacion}
    LIMIT 1
  `;
  if (!row) {
    const err = new Error("PublicaciÃ³n no encontrada");
    err.status = 404;
    throw err;
  }
  return row;
}

export async function misPublicacionesService(idUsuario) {
  return prisma.$queryRaw`
    SELECT *
    FROM PUBLICACION
    WHERE id_usuario = ${idUsuario}
    ORDER BY creado_en DESC
  `;
}

/* ============================================================
   CREAR PRODUCTO / SERVICIO
   ============================================================ */

// Crear PRODUCTO + PUBLICACION + PUBLICACION_PRODUCTO
export async function crearPublicacionProductoService(idUsuario, body) {
  const {
    titulo,
    descripcion,
    id_categoria,
    valor_creditos,
    imagen_url,
    producto, // { nombre, descripcion, precio, peso }
    cantidad,
    id_um,
  } = body;

  if (
    !titulo ||
    !descripcion ||
    !id_categoria ||
    !valor_creditos ||
    !producto ||
    !cantidad ||
    !id_um
  ) {
    const err = new Error("Faltan datos obligatorios");
    err.status = 400;
    throw err;
  }

  return prisma.$transaction(async (tx) => {
    // 1) Producto
    await tx.$queryRaw`
      INSERT INTO PRODUCTO (id_categoria, nombre, descripcion, precio, peso)
      VALUES (
        ${id_categoria},
        ${producto.nombre},
        ${producto.descripcion || null},
        ${producto.precio || null},
        ${producto.peso || null}
      )
    `;

    const [newProd] = await tx.$queryRaw`
      SELECT *
      FROM PRODUCTO
      WHERE id_producto = LAST_INSERT_ID()
      LIMIT 1
    `;

    // 2) Tipo de publicaciÃ³n PRODUCTO
    const tipoProducto = await tx.$queryRaw`
      SELECT id_tipo_publicacion
      FROM TIPO_PUBLICACION
      WHERE nombre = 'PRODUCTO'
      LIMIT 1
    `;
    if (!tipoProducto.length) {
      const err = new Error("No existe TIPO_PUBLICACION PRODUCTO");
      err.status = 500;
      throw err;
    }

    // 3) PublicaciÃ³n
    await tx.$queryRaw`
      INSERT INTO PUBLICACION (
        id_usuario,
        id_categoria,
        id_tipo_publicacion,
        titulo,
        descripcion,
        valor_creditos,
        imagen_url
      )
      VALUES (
        ${idUsuario},
        ${id_categoria},
        ${tipoProducto[0].id_tipo_publicacion},
        ${titulo},
        ${descripcion},
        ${valor_creditos},
        ${imagen_url || null}
      )
    `;

    const [pub] = await tx.$queryRaw`
      SELECT *
      FROM PUBLICACION
      WHERE id_publicacion = LAST_INSERT_ID()
      LIMIT 1
    `;

    // 4) RelaciÃ³n PUBLICACION_PRODUCTO
    await tx.$queryRaw`
      INSERT INTO PUBLICACION_PRODUCTO (id_publicacion, id_producto, cantidad, id_um)
      VALUES (
        ${pub.id_publicacion},
        ${newProd.id_producto},
        ${cantidad},
        ${id_um}
      )
    `;

    return pub;
  });
}

// Crear SERVICIO + PUBLICACION + PUBLICACION_SERVICIO
export async function crearPublicacionServicioService(idUsuario, body) {
  const {
    titulo,
    descripcion,
    id_categoria,
    valor_creditos,
    imagen_url,
    servicio, // { nombre, descripcion, precio, duracion_min }
    horario,
  } = body;

  if (!titulo || !descripcion || !id_categoria || !valor_creditos || !servicio || !horario) {
    const err = new Error("Faltan datos obligatorios");
    err.status = 400;
    throw err;
  }

  return prisma.$transaction(async (tx) => {
    // 1) Servicio
    await tx.$queryRaw`
      INSERT INTO SERVICIO (id_categoria, estado, nombre, descripcion, precio, duracion_min)
      VALUES (
        ${id_categoria},
        'ACTIVO',
        ${servicio.nombre},
        ${servicio.descripcion || null},
        ${servicio.precio || null},
        ${servicio.duracion_min || null}
      )
    `;

    const [serv] = await tx.$queryRaw`
      SELECT *
      FROM SERVICIO
      WHERE id_servicio = LAST_INSERT_ID()
      LIMIT 1
    `;

    // 2) Tipo de publicaciÃ³n SERVICIO
    const tipoServicio = await tx.$queryRaw`
      SELECT id_tipo_publicacion
      FROM TIPO_PUBLICACION
      WHERE nombre = 'SERVICIO'
      LIMIT 1
    `;
    if (!tipoServicio.length) {
      const err = new Error("No existe TIPO_PUBLICACION SERVICIO");
      err.status = 500;
      throw err;
    }

    // 3) PublicaciÃ³n
    await tx.$queryRaw`
      INSERT INTO PUBLICACION (
        id_usuario,
        id_categoria,
        id_tipo_publicacion,
        titulo,
        descripcion,
        valor_creditos,
        imagen_url
      )
      VALUES (
        ${idUsuario},
        ${id_categoria},
        ${tipoServicio[0].id_tipo_publicacion},
        ${titulo},
        ${descripcion},
        ${valor_creditos},
        ${imagen_url || null}
      )
    `;

    const [pub] = await tx.$queryRaw`
      SELECT *
      FROM PUBLICACION
      WHERE id_publicacion = LAST_INSERT_ID()
      LIMIT 1
    `;

    // 4) RelaciÃ³n PUBLICACION_SERVICIO
    await tx.$queryRaw`
      INSERT INTO PUBLICACION_SERVICIO (id_publicacion, id_servicio, horario)
      VALUES (
        ${pub.id_publicacion},
        ${serv.id_servicio},
        ${horario}
      )
    `;

    return pub;
  });
}

/* ============================================================
   BÃšSQUEDA FULLTEXT
   ============================================================ */

export async function buscarPublicacionesService(q) {
  if (!q.trim()) return [];

  return prisma.$queryRawUnsafe(
    `
      SELECT
        id_publicacion,
        titulo,
        descripcion,
        valor_creditos,
        imagen_url
      FROM PUBLICACION
      WHERE MATCH(titulo, descripcion) AGAINST (? IN NATURAL LANGUAGE MODE)
        AND estado = 'PUBLICADA'
      ORDER BY creado_en DESC
    `,
    q
  );
}

/* ============================================================
   CALIFICACIONES
   ============================================================ */

export async function crearCalificacionService({
  idUsuario,
  idPublicacion,
  estrellas,
  comentario,
}) {
  if (!estrellas) {
    const err = new Error("estrellas es obligatorio");
    err.status = 400;
    throw err;
  }

  await prisma.$queryRaw`
    INSERT INTO CALIFICACION (id_usuario, id_publicacion, estrellas, comentario)
    VALUES (${idUsuario}, ${idPublicacion}, ${estrellas}, ${comentario || null})
    ON DUPLICATE KEY UPDATE
      estrellas  = VALUES(estrellas),
      comentario = VALUES(comentario)
  `;

  const [row] = await prisma.$queryRaw`
    SELECT *
    FROM CALIFICACION
    WHERE id_usuario = ${idUsuario}
      AND id_publicacion = ${idPublicacion}
    LIMIT 1
  `;
  return row;
}

export async function listarCalificacionesService(idPublicacion) {
  return prisma.$queryRaw`
    SELECT c.*, u.nombre
    FROM CALIFICACION c
    JOIN USUARIO u ON u.id_usuario = c.id_usuario
    WHERE c.id_publicacion = ${idPublicacion}
    ORDER BY c.id_calificacion DESC
  `;
}

/* ============================================================
   NUEVO: EDITAR / ESTADO / ELIMINAR
   ============================================================ */

// Helper: verificar que el usuario sea dueÃ±o o ADMIN
async function assertPuedeEditar(idUsuario, rol, idPublicacion) {
  const [row] = await prisma.$queryRaw`
    SELECT id_usuario
    FROM PUBLICACION
    WHERE id_publicacion = ${idPublicacion}
    LIMIT 1
  `;
  if (!row) {
    const err = new Error("PublicaciÃ³n no encontrada");
    err.status = 404;
    throw err;
  }

  const esAdmin = rol === "ADMIN";
  if (!esAdmin && row.id_usuario !== idUsuario) {
    const err = new Error("No tienes permiso para modificar esta publicaciÃ³n");
    err.status = 403;
    throw err;
  }
}

export async function actualizarPublicacionService(
  idUsuario,
  rol,
  idPublicacion,
  datos
) {
  await assertPuedeEditar(idUsuario, rol, idPublicacion);

  const {
    titulo,
    descripcion,
    id_categoria,
    valor_creditos,
    imagen_url,
  } = datos;

  // No obligo a mandar todo, actualizo solo lo que viene definido
  await prisma.$queryRaw`
    UPDATE PUBLICACION
    SET
      titulo        = COALESCE(${titulo}, titulo),
      descripcion   = COALESCE(${descripcion}, descripcion),
      id_categoria  = COALESCE(${id_categoria}, id_categoria),
      valor_creditos= COALESCE(${valor_creditos}, valor_creditos),
      imagen_url    = COALESCE(${imagen_url}, imagen_url)
    WHERE id_publicacion = ${idPublicacion}
  `;

  return obtenerPublicacionService(idPublicacion);
}

export async function cambiarEstadoPublicacionService(
  idUsuario,
  rol,
  idPublicacion,
  estado
) {
  if (!estado || !ESTADOS_PUBLICACION.includes(estado)) {
    const err = new Error(
      `Estado invÃ¡lido. Permitidos: ${ESTADOS_PUBLICACION.join(", ")}`
    );
    err.status = 400;
    throw err;
  }

  await assertPuedeEditar(idUsuario, rol, idPublicacion);

  await prisma.$queryRaw`
    UPDATE PUBLICACION
    SET estado = ${estado}
    WHERE id_publicacion = ${idPublicacion}
  `;

  return obtenerPublicacionService(idPublicacion);
}

export async function eliminarPublicacionService(
  idUsuario,
  rol,
  idPublicacion
) {
  // EliminaciÃ³n lÃ³gica â‰ˆ estado = 'ELIMINADA'
  return cambiarEstadoPublicacionService(
    idUsuario,
    rol,
    idPublicacion,
    "ELIMINADA"
  );
}
</file>

<file path="src/modules/publicidad/publicidad.controller.js">
// src/modules/publicidad/publicidad.controller.js
import {
  crearPublicidadService,
  listarPublicidadActivaService,
  listarPublicidadAdminService,
  cambiarEstadoPublicidadService,
  eliminarPublicidadService,
} from "./publicidad.service.js";

import { buscarPublicacionesService } from "../publicaciones/publicaciones.service.js";

function toPlain(value) {
  if (typeof value === "bigint") return Number(value);
  if (value instanceof Date)
    return value.toISOString().slice(0, 19).replace("T", " ");

  if (value && typeof value === "object") {
    if (typeof value.toNumber === "function") return value.toNumber();
    if (Array.isArray(value)) return value.map(toPlain);

    const out = {};
    for (const [k, v] of Object.entries(value)) out[k] = toPlain(v);
    return out;
  }
  return value;
}

/* =====================================================
   PUBLICAS
===================================================== */
export const listarPublicidadActivaController = async (req, res, next) => {
  try {
    const data = await listarPublicidadActivaService();
    res.json(toPlain(data));
  } catch (err) {
    next(err);
  }
};

/* =====================================================
   ADMIN
===================================================== */
export const crearPublicidadController = async (req, res, next) => {
  try {
    const idUsuario = req.user.id_usuario;
    const data = await crearPublicidadService(idUsuario, req.body);
    res.status(201).json(toPlain(data));
  } catch (err) {
    next(err);
  }
};

export const listarPublicidadAdminController = async (req, res, next) => {
  try {
    const data = await listarPublicidadAdminService();
    res.json(toPlain(data));
  } catch (err) {
    next(err);
  }
};

export const buscarPublicacionesParaPublicidadController = async (
  req,
  res,
  next
) => {
  try {
    const q = req.query.q || "";
    const data = await buscarPublicacionesService(q);
    res.json(toPlain(data));
  } catch (err) {
    next(err);
  }
};

/* =====================================================
   NUEVO: CAMBIAR ESTADO
===================================================== */
export const cambiarEstadoPublicidadController = async (req, res, next) => {
  try {
    const idPublicidad = Number(req.params.id);
    const { estado } = req.body;

    const data = await cambiarEstadoPublicidadService(idPublicidad, estado);
    res.json({
      message: "Estado actualizado correctamente",
      publicidad: toPlain(data),
    });
  } catch (err) {
    next(err);
  }
};

/* =====================================================
   NUEVO: ELIMINAR (LOGICO)
===================================================== */
export const eliminarPublicidadController = async (req, res, next) => {
  try {
    const idPublicidad = Number(req.params.id);
    const data = await eliminarPublicidadService(idPublicidad);

    res.json({
      message: "Publicidad eliminada (estado = 'ELIMINADA')",
      publicidad: toPlain(data),
    });
  } catch (err) {
    next(err);
  }
};
</file>

<file path="src/modules/publicidad/publicidad.routes.js">
// src/modules/publicidad/publicidad.routes.js
import { Router } from "express";
import { authMiddleware } from "../../middlewares/auth.js";
import { isAdmin } from "../../middlewares/isAdmin.js";

import {
  listarPublicidadActivaController,
  crearPublicidadController,
  listarPublicidadAdminController,
  buscarPublicacionesParaPublicidadController,
  cambiarEstadoPublicidadController,
  eliminarPublicidadController,
} from "./publicidad.controller.js";

const router = Router();

/* ===========================
   PUBLICA
=========================== */
router.get("/activa", listarPublicidadActivaController);

/* ===========================
   SOLO ADMIN
=========================== */
router.use(authMiddleware, isAdmin);

router.get("/admin", listarPublicidadAdminController);

router.get("/buscar-publicaciones", buscarPublicacionesParaPublicidadController);

router.post("/", crearPublicidadController);

router.patch("/:id/estado", cambiarEstadoPublicidadController);

router.delete("/:id", eliminarPublicidadController);

export default router;
</file>

<file path="src/modules/publicidad/publicidad.service.js">
// src/modules/publicidad/publicidad.service.js
import { prisma } from "../../config/prisma.js";

const ESTADOS = ["PROGRAMADA", "ACTIVA", "PAUSADA", "FINALIZADA", "CANCELADA", "ELIMINADA"];

export const listarPublicidadActivaService = () =>
  prisma.$queryRaw`
    SELECT p.*, u.nombre AS usuario
    FROM PUBLICIDAD p
    JOIN USUARIO u ON u.id_usuario = p.id_usuario
    WHERE p.estado = 'ACTIVA'
      AND NOW() BETWEEN p.fecha_inicio AND p.fecha_fin
    ORDER BY p.fecha_inicio DESC, p.id_publicidad DESC
  `;

export const listarPublicidadAdminService = () =>
  prisma.$queryRaw`
    SELECT p.*, u.nombre AS usuario
    FROM PUBLICIDAD p
    JOIN USUARIO u ON u.id_usuario = p.id_usuario
    ORDER BY p.fecha_inicio DESC, p.id_publicidad DESC
  `;

export const crearPublicidadService = async (idUsuario, body) => {
  const {
    id_ubicacion,
    titulo,
    descripcion,
    url_destino,
    fecha_inicio,
    fecha_fin,
    costo_creditos,
  } = body;

  if (!id_ubicacion || !titulo || !fecha_inicio || !fecha_fin || !costo_creditos) {
    const err = new Error("Faltan datos obligatorios de publicidad");
    err.status = 400;
    throw err;
  }

  await prisma.$queryRaw`
    INSERT INTO PUBLICIDAD (
      id_usuario, id_ubicacion, estado,
      titulo, descripcion, url_destino,
      fecha_inicio, fecha_fin, costo_creditos
    )
    VALUES (
      ${idUsuario}, ${id_ubicacion}, 'PROGRAMADA',
      ${titulo}, ${descripcion || null}, ${url_destino || null},
      ${fecha_inicio}, ${fecha_fin}, ${costo_creditos}
    )
  `;

  const [row] = await prisma.$queryRaw`
    SELECT *
    FROM PUBLICIDAD
    WHERE id_publicidad = LAST_INSERT_ID()
    LIMIT 1
  `;
  return row;
};

/* =====================================================
   NUEVO: CAMBIAR ESTADO
===================================================== */
export const cambiarEstadoPublicidadService = async (idPublicidad, estado) => {
  if (!ESTADOS.includes(estado)) {
    const err = new Error(`Estado invÃ¡lido. Permitidos: ${ESTADOS.join(", ")}`);
    err.status = 400;
    throw err;
  }

  await prisma.$queryRaw`
    UPDATE PUBLICIDAD
    SET estado = ${estado}
    WHERE id_publicidad = ${idPublicidad}
  `;

  const [row] = await prisma.$queryRaw`
    SELECT *
    FROM PUBLICIDAD
    WHERE id_publicidad = ${idPublicidad}
    LIMIT 1
  `;

  return row;
};

/* =====================================================
   NUEVO: ELIMINAR (LOGICO)
===================================================== */
export const eliminarPublicidadService = async (idPublicidad) => {
  return cambiarEstadoPublicidadService(idPublicidad, "ELIMINADA");
};
</file>

<file path="src/modules/reportes/reportes.controller.js">
// backend/src/modules/reportes/reportes.controller.js
import {
  usuariosActivosReporte,
  usuariosAbandonadosReporte,
  ingresosCreditosReporte,
  creditosGeneradosVsConsumidosReporte,
  intercambiosPorCategoriaReporte,
  publicacionesVsIntercambiosReporte,
  impactoAcumuladoReporte,
  rankingUsuariosReporte,
  usuariosPremiumReporte,
  usuariosNuevosReporte,
  saldosCreditosReporte,
  actividadesSosteniblesReporte,
  impactoPorCategoriaReporte,
} from "./reportes.service.js";

/**
 * Helper para leer fechas (?desde=yyyy-mm-dd&hasta=yyyy-mm-dd)
 * y poner valores por defecto si no mandan nada.
 */
function getRangoFechas(query) {
  const { desde, hasta } = query;

  const hoy = new Date();
  const inicioMes = new Date(hoy.getFullYear(), hoy.getMonth(), 1);

  return {
    desde: desde || inicioMes.toISOString().slice(0, 10),
    hasta: hasta || hoy.toISOString().slice(0, 10),
  };
}

// C1) Usuarios activos
export async function getUsuariosActivos(req, res, next) {
  try {
    const rango = getRangoFechas(req.query);
    const data = await usuariosActivosReporte(rango);
    res.json(data);
  } catch (err) {
    next(err);
  }
}

// C2) Usuarios abandonados
export async function getUsuariosAbandonados(req, res, next) {
  try {
    const rango = getRangoFechas(req.query);
    const data = await usuariosAbandonadosReporte(rango);
    res.json(data);
  } catch (err) {
    next(err);
  }
}

// C3) Ingresos por compra de crÃ©ditos
export async function getIngresosCreditos(req, res, next) {
  try {
    const rango = getRangoFechas(req.query);
    const data = await ingresosCreditosReporte(rango);
    res.json(data);
  } catch (err) {
    next(err);
  }
}

// C4) CrÃ©ditos generados vs consumidos
export async function getCreditosGeneradosVsConsumidos(req, res, next) {
  try {
    const rango = getRangoFechas(req.query);
    const data = await creditosGeneradosVsConsumidosReporte(rango);
    res.json(data);
  } catch (err) {
    next(err);
  }
}

// C5) Intercambios por categorÃ­a
export async function getIntercambiosPorCategoria(req, res, next) {
  try {
    const rango = getRangoFechas(req.query);
    const data = await intercambiosPorCategoriaReporte(rango);
    res.json(data);
  } catch (err) {
    next(err);
  }
}

// C6) Publicaciones vs intercambios
export async function getPublicacionesVsIntercambios(req, res, next) {
  try {
    const rango = getRangoFechas(req.query);
    const data = await publicacionesVsIntercambiosReporte(rango);
    res.json(data);
  } catch (err) {
    next(err);
  }
}

// C7) Impacto acumulado
export async function getImpactoAcumulado(req, res, next) {
  try {
    // Soporta tanto camelCase (frontend) como snake_case (pantalla de pruebas)
    const idTipoReporte = Number(
      req.query.idTipoReporte ?? req.query.id_tipo_reporte
    );
    const idPeriodo = Number(
      req.query.idPeriodo ?? req.query.id_periodo
    );

    if (!idTipoReporte || !idPeriodo) {
      return res
        .status(400)
        .json({ message: "idTipoReporte e idPeriodo son obligatorios" });
    }

    const data = await impactoAcumuladoReporte({ idTipoReporte, idPeriodo });
    res.json(data);
  } catch (err) {
    next(err);
  }
}

// C8) Ranking de usuarios
export async function getRankingUsuarios(req, res, next) {
  try {
    const idPeriodo = req.query.idPeriodo ?? req.query.id_periodo ?? null;
    const limit = Number(req.query.limit) || 10;

    const data = await rankingUsuariosReporte({ idPeriodo, limit });
    res.json(data);
  } catch (err) {
    next(err);
  }
}


// C9) Usuarios premium
export async function getUsuariosPremium(req, res, next) {
  try {
    const rango = getRangoFechas(req.query);
    const data = await usuariosPremiumReporte(rango);
    res.json(data);
  } catch (err) {
    next(err);
  }
}

// C10) Usuarios nuevos
export async function getUsuariosNuevos(req, res, next) {
  try {
    const rango = getRangoFechas(req.query);
    const data = await usuariosNuevosReporte(rango);
    res.json(data);
  } catch (err) {
    next(err);
  }
}

// C11) Saldos de crÃ©ditos
export async function getSaldosCreditos(req, res, next) {
  try {
    const limit = Number(req.query.limit) || 10;
    const data = await saldosCreditosReporte({ limit });
    res.json(data);
  } catch (err) {
    next(err);
  }
}

// C12) Actividades sostenibles
export async function getActividadesSostenibles(req, res, next) {
  try {
    const rango = getRangoFechas(req.query);
    const data = await actividadesSosteniblesReporte(rango);
    res.json(data);
  } catch (err) {
    next(err);
  }
}

// C13) Impacto ambiental por categorÃ­a (por perÃ­odo)
export async function getImpactoPorCategoria(req, res, next) {
  try {
    const idPeriodo = Number(req.query.idPeriodo);
    if (!idPeriodo) {
      return res
        .status(400)
        .json({ message: "idPeriodo es obligatorio (query param)" });
    }

    const data = await impactoPorCategoriaReporte({ idPeriodo });
    res.json(data);
  } catch (err) {
    next(err);
  }
}
</file>

<file path="src/modules/reportes/reportes.routes.js">
import { Router } from "express";
import { authMiddleware } from "../../middlewares/auth.js";
import { isAdmin } from "../../middlewares/isAdmin.js";
import {
  getUsuariosActivos,
  getUsuariosAbandonados,
  getIngresosCreditos,
  getCreditosGeneradosVsConsumidos,
  getIntercambiosPorCategoria,
  getPublicacionesVsIntercambios,
  getImpactoAcumulado,
  getRankingUsuarios,
  getUsuariosPremium,
  getUsuariosNuevos,
  getSaldosCreditos,
  getActividadesSostenibles,
  getImpactoPorCategoria,
} from "./reportes.controller.js";

const router = Router();

// Todo el mÃ³dulo de reportes SOLO para admins
router.use(authMiddleware, isAdmin);

/*  REPORTES PRINCIPALES */

// âœ” Usuarios activos
router.get("/usuarios-activos", getUsuariosActivos);

// âœ” Usuarios abandonados
router.get("/usuarios-abandonados", getUsuariosAbandonados);

// âœ” Ingresos por venta de crÃ©ditos
router.get("/ingresos-creditos", getIngresosCreditos);

// âœ” CrÃ©ditos generados vs consumidos
router.get("/creditos-generados-consumidos", getCreditosGeneradosVsConsumidos);

// âœ” Intercambios por categorÃ­a
router.get("/intercambios-categoria", getIntercambiosPorCategoria);

// âœ” Publicaciones vs intercambios
router.get("/publicaciones-vs-intercambios", getPublicacionesVsIntercambios);

// âœ” Impacto ecolÃ³gico acumulado
router.get("/impacto-acumulado", getImpactoAcumulado);

/* REPORTES AVANZADOS */

// âœ” Ranking de usuarios (top N)
router.get("/ranking-usuarios", getRankingUsuarios);

// âœ” Reporte de usuarios premium
router.get("/usuarios-premium", getUsuariosPremium);

// âœ” Usuarios nuevos (primer login)
router.get("/usuarios-nuevos", getUsuariosNuevos);

// âœ” Saldos de crÃ©ditos (top N)
router.get("/saldos-usuarios", getSaldosCreditos);

// âœ” Actividades sostenibles
router.get("/actividades-sostenibles", getActividadesSostenibles);

// âœ” Impacto ambiental por categorÃ­a (por perÃ­odo)
router.get("/impacto-categoria", getImpactoPorCategoria);

export default router;
</file>

<file path="src/modules/reportes/reportes.service.js">
// backend/src/modules/reportes/reportes.service.js
import { prisma } from "../../config/prisma.js";

/**
 * Helpers
 */
function toPlain(value) {
  if (typeof value === "bigint") return Number(value);

  if (value instanceof Date) {
    return value.toISOString().slice(0, 19).replace("T", " ");
  }

  if (value && typeof value === "object") {
    if (typeof value.toNumber === "function") return value.toNumber();

    const prim = value.valueOf?.();
    if (prim != null && typeof prim !== "object") return prim;

    if (Array.isArray(value)) return value.map((v) => toPlain(v));

    const out = {};
    for (const [k, v] of Object.entries(value)) out[k] = toPlain(v);
    return out;
  }

  return value;
}

/**
 * Normaliza el resultado de CALL sp_xxx(...)
 */
function normalizeResult(raw) {
  if (!raw) return [];
  if (Array.isArray(raw)) {
    if (Array.isArray(raw[0])) return raw[0];
    return raw;
  }
  return raw;
}

/**
 * Mapeos (ya estaban en tu controller)
 */

function mapUsuarioActivo(r) {
  return {
    id_usuario: r.id_usuario ?? r.f0 ?? null,
    nombre: r.nombre ?? r.f1 ?? null,
    correo: r.correo ?? r.f2 ?? null,
    ultimo_login: r.ultimo_login ?? r.f3 ?? null,
    cantidad_logins: r.cantidad_logins ?? r.f4 ?? null,
  };
}

function mapUsuarioAbandonado(r) {
  return {
    id_usuario: r.id_usuario ?? r.f0 ?? null,
    nombre: r.nombre ?? r.f1 ?? null,
    correo: r.correo ?? r.f2 ?? null,
    ultimo_login: r.ultimo_login ?? r.f3 ?? null,
    dias_sin_login: r.dias_sin_login ?? r.f4 ?? null,
  };
}

function mapIngresoCreditos(r) {
  return {
    fecha: r.fecha ?? r.f0 ?? null,
    total_creditos: r.total_creditos ?? r.f1 ?? null,
    total_monto: r.total_monto ?? r.f2 ?? null,
  };
}

function mapIntercambiosCategoria(r) {
  return {
    id_categoria: r.id_categoria ?? r.f0 ?? null,
    categoria: r.categoria ?? r.f1 ?? null,
    cantidad_intercambios: r.cantidad_intercambios ?? r.f2 ?? null,
  };
}

function mapPublicacionesVsIntercambios(r) {
  return {
    fecha: r.fecha ?? r.f0 ?? null,
    publicaciones: r.publicaciones ?? r.f1 ?? null,
    intercambios: r.intercambios ?? r.f2 ?? null,
  };
}

function mapImpacto(r) {
  return {
    co2_total: r.co2_total ?? r.f0 ?? null,
    agua_total: r.agua_total ?? r.f1 ?? null,
    energia_total: r.energia_total ?? r.f2 ?? null,
  };
}

function mapRankingUsuarios(r) {
  return {
    id_usuario: r.id_usuario ?? r.f0 ?? null,
    nombre: r.nombre ?? r.f1 ?? null,
    co2_total: r.co2_total ?? r.f2 ?? null,
    agua_total: r.agua_total ?? r.f3 ?? null,
    energia_total: r.energia_total ?? r.f4 ?? null,
    transacciones: r.transacciones ?? r.f5 ?? null,
  };
}

function mapUsuariosPremium(r) {
  return {
    id_usuario: r.id_usuario ?? r.f0 ?? null,
    nombre: r.nombre ?? r.f1 ?? null,
    correo: r.correo ?? r.f2 ?? null,
    fecha_primer_pago: r.fecha_primer_pago ?? r.f3 ?? null,
    total_pagado: r.total_pagado ?? r.f4 ?? null,
  };
}

function mapUsuariosNuevos(r) {
  return {
    id_usuario: r.id_usuario ?? r.f0 ?? null,
    nombre: r.nombre ?? r.f1 ?? null,
    correo: r.correo ?? r.f2 ?? null,
    fecha_primer_login: r.fecha_primer_login ?? r.f3 ?? null,
    cantidad_logins: r.cantidad_logins ?? r.f4 ?? null,
  };
}

function mapSaldoUsuario(r) {
  return {
    id_usuario: r.id_usuario ?? r.f0 ?? null,
    nombre: r.nombre ?? r.f1 ?? null,
    correo: r.correo ?? r.f2 ?? null,
    saldo_creditos: r.saldo_creditos ?? r.f3 ?? null,
  };
}

function mapActividadSostenible(r) {
  return {
    id_usuario: r.id_usuario ?? r.f0 ?? null,
    nombre: r.nombre ?? r.f1 ?? null,
    correo: r.correo ?? r.f2 ?? null,
    cantidad_actividades: r.cantidad_actividades ?? r.f3 ?? null,
    co2_total: r.co2_total ?? r.f4 ?? null,
    agua_total: r.agua_total ?? r.f5 ?? null,
    energia_total: r.energia_total ?? r.f6 ?? null,
  };
}

function mapImpactoCategoria(r) {
  return {
    id_categoria: r.id_categoria ?? r.f0 ?? null,
    categoria: r.categoria ?? r.f1 ?? null,
    co2_total: r.co2_total ?? r.f2 ?? null,
    agua_total: r.agua_total ?? r.f3 ?? null,
    energia_total: r.energia_total ?? r.f4 ?? null,
  };
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   SERVICES (una funciÃ³n por cada endpoint)
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */

// C1) Usuarios activos
export async function usuariosActivosReporte({ desde, hasta }) {
  const raw =
    await prisma.$queryRaw`CALL sp_rep_usuarios_activos(${desde}, ${hasta})`;

  const rows = normalizeResult(raw).map(mapUsuarioActivo);
  return toPlain(rows);
}

// C2) Usuarios abandonados
export async function usuariosAbandonadosReporte({ desde, hasta }) {
  const raw =
    await prisma.$queryRaw`CALL sp_rep_usuarios_abandonados(${desde}, ${hasta})`;

  const rows = normalizeResult(raw).map(mapUsuarioAbandonado);
  return toPlain(rows);
}

// C3) Ingresos por compra de crÃ©ditos
export async function ingresosCreditosReporte({ desde, hasta }) {
  const raw =
    await prisma.$queryRaw`CALL sp_rep_ingresos_creditos(${desde}, ${hasta})`;

  const rows = normalizeResult(raw).map(mapIngresoCreditos);
  return toPlain(rows);
}

// C4) CrÃ©ditos generados vs consumidos
export async function creditosGeneradosVsConsumidosReporte({ desde, hasta }) {
  const raw =
    await prisma.$queryRaw`CALL sp_rep_creditos_generados_vs_consumidos(${desde}, ${hasta})`;

  const rows = normalizeResult(raw).map(mapIngresoCreditos);
  return toPlain(rows);
}

// C5) Intercambios por categorÃ­a
export async function intercambiosPorCategoriaReporte({ desde, hasta }) {
  const raw =
    await prisma.$queryRaw`CALL sp_rep_intercambios_por_categoria(${desde}, ${hasta})`;

  const rows = normalizeResult(raw).map(mapIntercambiosCategoria);
  return toPlain(rows);
}

// C6) Publicaciones vs intercambios
export async function publicacionesVsIntercambiosReporte({ desde, hasta }) {
  const raw =
    await prisma.$queryRaw`CALL sp_rep_publicaciones_vs_intercambios(${desde}, ${hasta})`;

  const rows = normalizeResult(raw).map(mapPublicacionesVsIntercambios);
  return toPlain(rows);
}

// C7) Impacto acumulado (usa SP sp_generar_reporte_impacto)
export async function impactoAcumuladoReporte({ idTipoReporte, idPeriodo }) {
  const tipo = Number(idTipoReporte) || 1;
  const periodo = Number(idPeriodo) || 1;

  const raw =
    await prisma.$queryRaw`CALL sp_generar_reporte_impacto(${tipo}, ${periodo}, NULL)`;

  const rows = normalizeResult(raw).map(mapImpacto);
  return toPlain(rows);
}

// C8) Ranking de usuarios (SP basado en IMPACTO_AMBIENTAL)
export async function rankingUsuariosReporte({ idPeriodo = null, limit = 10 }) {
  const periodo = idPeriodo != null ? Number(idPeriodo) : null;
  const top = Number(limit) || 10;

  let raw;
  if (periodo) {
    raw =
      await prisma.$queryRaw`CALL sp_obtener_ranking_usuarios(${periodo}, ${top})`;
  } else {
    // Si el SP soporta periodo NULL para "todos los periodos"
    raw =
      await prisma.$queryRaw`CALL sp_obtener_ranking_usuarios(${null}, ${top})`;
  }

  const rows = normalizeResult(raw).map(mapRankingUsuarios);
  return toPlain(rows);
}

// C9) Usuarios premium
export async function usuariosPremiumReporte({ desde, hasta }) {
  const raw =
    await prisma.$queryRaw`CALL sp_rep_usuarios_premium(${desde}, ${hasta})`;

  const rows = normalizeResult(raw).map(mapUsuariosPremium);
  return toPlain(rows);
}

// C10) Usuarios nuevos (primer login)
export async function usuariosNuevosReporte({ desde, hasta }) {
  const raw = await prisma.$queryRawUnsafe(
    `
    SELECT 
      u.id_usuario,
      u.nombre,
      u.correo,
      MIN(ba.fecha_hora) AS fecha_primer_login,
      COUNT(*) AS cantidad_logins
    FROM BITACORA_ACCESO ba
    JOIN USUARIO u ON u.id_usuario = ba.id_usuario
    GROUP BY u.id_usuario, u.nombre, u.correo
    HAVING fecha_primer_login BETWEEN ? AND ?
    ORDER BY fecha_primer_login ASC
  `,
    desde,
    hasta
  );

  const rows = normalizeResult(raw).map(mapUsuariosNuevos);
  return toPlain(rows);
}

// C11) Saldos de crÃ©ditos
export async function saldosCreditosReporte({ limit = 20 }) {
  const top = Number(limit) || 20;

  const raw = await prisma.$queryRawUnsafe(
    `
    SELECT 
      u.id_usuario,
      u.nombre,
      u.correo,
      b.saldo_creditos
    FROM USUARIO u
    JOIN BILLETERA b ON b.id_usuario = u.id_usuario
    ORDER BY b.saldo_creditos DESC
    LIMIT ?
  `,
    top
  );

  const rows = normalizeResult(raw).map(mapSaldoUsuario);
  return toPlain(rows);
}

// C12) Actividades sostenibles
export async function actividadesSosteniblesReporte({ desde, hasta }) {
  const raw = await prisma.$queryRawUnsafe(
    `
    SELECT 
      u.id_usuario,
      u.nombre,
      u.correo,
      COUNT(*) AS cantidad_actividades,
      SUM(a.co2_ahorrado) AS co2_total,
      SUM(a.agua_ahorrada) AS agua_total,
      SUM(a.energia_ahorrada) AS energia_total
    FROM ACTIVIDAD_SOSTENIBLE a
    JOIN USUARIO u ON u.id_usuario = a.id_usuario
    WHERE a.fecha BETWEEN ? AND ?
    GROUP BY u.id_usuario, u.nombre, u.correo
    ORDER BY cantidad_actividades DESC
  `,
    desde,
    hasta
  );

  const rows = normalizeResult(raw).map(mapActividadSostenible);
  return toPlain(rows);
}

// C13) Impacto ambiental por categorÃ­a (por perÃ­odo)
export async function impactoPorCategoriaReporte({ idPeriodo }) {
  const periodo = Number(idPeriodo);

  const raw = await prisma.$queryRawUnsafe(
    `
    SELECT 
      c.id_categoria,
      c.nombre AS categoria,
      SUM(ia.co2_ahorrado) AS co2_total,
      SUM(ia.agua_ahorrada) AS agua_total,
      SUM(ia.energia_ahorrada) AS energia_total
    FROM IMPACTO_AMBIENTAL ia
    JOIN TRANSACCION t ON t.id_transaccion = ia.id_transaccion
    JOIN PUBLICACION p ON p.id_publicacion = t.id_publicacion
    JOIN CATEGORIA c ON c.id_categoria = p.id_categoria
    WHERE ia.id_periodo = ?
    GROUP BY c.id_categoria, c.nombre
    ORDER BY co2_total DESC
  `,
    periodo
  );

  const rows = normalizeResult(raw).map(mapImpactoCategoria);
  return toPlain(rows);
}
</file>

<file path="src/modules/uploads/multer.js">
import multer from "multer";
import { v4 as uuid } from "uuid";
import path from "path";

const storage = multer.diskStorage({
  destination: (_req, _file, cb) => {
    // Carpeta fÃ­sica donde se guardan los archivos
    cb(null, "uploads_storage");
  },
  filename: (_req, file, cb) => {
    const unique = uuid();
    const ext = path.extname(file.originalname);
    cb(null, unique + ext);
  },
});

export const upload = multer({ storage });
</file>

<file path="src/modules/uploads/uploads.controller.js">
import { procesarArchivoService } from "./uploads.service.js";

export const subirArchivoController = async (req, res, next) => {
  try {
    if (!req.file) {
      return res
        .status(400)
        .json({ message: "No enviaste ningÃºn archivo" });
    }

    const data = await procesarArchivoService(req.file);

    res.json({
      message: "Archivo subido correctamente",
      data,
    });
  } catch (err) {
    next(err);
  }
};
</file>

<file path="src/modules/uploads/uploads.routes.js">
import { Router } from "express";
import { authMiddleware } from "../../middlewares/auth.js";
import { upload } from "./multer.js";
import { subirArchivoController } from "./uploads.controller.js";

const router = Router();

// Ruta protegida: requiere login
router.post("/", authMiddleware, upload.single("archivo"), subirArchivoController);

export default router;
</file>

<file path="src/modules/uploads/uploads.service.js">
import path from "path";

export async function procesarArchivoService(file) {
  // Ruta interna donde se guardÃ³ fÃ­sicamente
  const diskPath = path.join("uploads_storage", file.filename);
  // URL pÃºblica (el frontend usarÃ¡ esto)
  const url = `/uploads/${file.filename}`;

  // AquÃ­ podrÃ­as:
  // - Guardar info en BD
  // - Subir a S3 / Cloudinary
  // - Registrar logs, etc.

  return {
    url,
    path: diskPath,
    originalName: file.originalname,
    size: file.size,
    mimetype: file.mimetype,
  };
}
</file>

<file path="src/modules/usuarios/usuarios.controller.js">
// src/modules/usuarios/usuarios.controller.js

import {
  listarUsuariosService,
  crearUsuarioAdminService,
  actualizarUsuarioService,
  cambiarEstadoUsuarioService,
  obtenerHistorialUsuarioService,
} from "./usuarios.service.js";

export async function listarUsuariosController(req, res, next) {
  try {
    const usuarios = await listarUsuariosService();
    res.json(usuarios);
  } catch (err) {
    next(err);
  }
}

export async function crearUsuarioAdminController(req, res, next) {
  try {
    const usuario = await crearUsuarioAdminService(req.body);
    res.status(201).json(usuario);
  } catch (err) {
    next(err);
  }
}

export async function actualizarUsuarioController(req, res, next) {
  try {
    const id = parseInt(req.params.id, 10);
    const usuario = await actualizarUsuarioService(id, req.body);
    res.json(usuario);
  } catch (err) {
    next(err);
  }
}

export async function cambiarEstadoUsuarioController(req, res, next) {
  try {
    const id = parseInt(req.params.id, 10);
    const { estado } = req.body;
    const usuario = await cambiarEstadoUsuarioService(id, estado);
    res.json(usuario);
  } catch (err) {
    next(err);
  }
}

export async function obtenerHistorialUsuarioController(req, res, next) {
  try {
    const id = parseInt(req.params.id, 10);
    const historial = await obtenerHistorialUsuarioService(id);
    res.json(historial);
  } catch (err) {
    next(err);
  }
}
</file>

<file path="src/modules/usuarios/usuarios.routes.js">
// src/modules/usuarios/usuarios.routes.js
import { Router } from "express";
import { authMiddleware } from "../../middlewares/auth.js";
import { isAdmin } from "../../middlewares/isAdmin.js";
import {
  listarUsuariosController,
  crearUsuarioAdminController,
  actualizarUsuarioController,
  cambiarEstadoUsuarioController,
  obtenerHistorialUsuarioController,
} from "./usuarios.controller.js";

const router = Router();

// Todo lo de aquÃ­ requiere admin
router.use(authMiddleware, isAdmin);

// GET /api/usuarios
router.get("/", listarUsuariosController);

// POST /api/usuarios
router.post("/", crearUsuarioAdminController);

// PUT /api/usuarios/:id
router.put("/:id", actualizarUsuarioController);

// PATCH /api/usuarios/:id/estado
router.patch("/:id/estado", cambiarEstadoUsuarioController);

// GET /api/usuarios/:id/historial
router.get("/:id/historial", obtenerHistorialUsuarioController);

export default router;
</file>

<file path="src/modules/usuarios/usuarios.service.js">
// src/modules/usuarios/usuarios.service.js
import bcrypt from "bcryptjs";
import { prisma } from "../../config/prisma.js";

export async function listarUsuariosService() {
  const rows = await prisma.$queryRaw`
    SELECT u.id_usuario, u.nombre, u.apellido, u.correo, u.telefono,
           u.estado, r.nombre AS rol
    FROM USUARIO u
    JOIN ROL r ON r.id_rol = u.id_rol
    ORDER BY u.id_usuario DESC
  `;
  return rows;
}

export async function crearUsuarioAdminService({
  nombre,
  apellido,
  correo,
  telefono,
  password,
  id_rol,
  estado = "ACTIVO",
}) {
  if (!nombre || !correo || !password || !id_rol) {
    const err = new Error("nombre, correo, password e id_rol son obligatorios");
    err.status = 400;
    throw err;
  }

  const existente = await prisma.$queryRaw`
    SELECT id_usuario FROM USUARIO WHERE correo = ${correo} LIMIT 1
  `;
  if (existente.length) {
    const error = new Error("El correo ya estÃ¡ registrado");
    error.status = 409;
    throw error;
  }

  const hash = await bcrypt.hash(password, 10);

  await prisma.$queryRaw`
    INSERT INTO USUARIO (id_rol, estado, nombre, apellido, correo, password_hash, telefono, url_perfil)
    VALUES (${id_rol}, ${estado}, ${nombre}, ${apellido || null}, ${correo}, ${hash},
            ${telefono || null}, NULL)
  `;

  const rows = await prisma.$queryRaw`
    SELECT u.id_usuario, u.nombre, u.apellido, u.correo, u.telefono,
           u.estado, r.nombre AS rol
    FROM USUARIO u
    JOIN ROL r ON r.id_rol = u.id_rol
    WHERE u.correo = ${correo}
    LIMIT 1
  `;
  return rows[0];
}

export async function actualizarUsuarioService(idUsuario, data) {
  const { nombre, apellido, telefono, id_rol } = data;

  // Normalizar undefined â†’ null para que COALESCE funcione como "no cambiar"
  const nombreParam = nombre === undefined ? null : nombre;
  const apellidoParam = apellido === undefined ? null : apellido;
  const telefonoParam = telefono === undefined ? null : telefono;
  const rolParam = id_rol === undefined ? null : id_rol;

  await prisma.$queryRaw`
    UPDATE USUARIO
    SET nombre  = COALESCE(${nombreParam}, nombre),
        apellido = COALESCE(${apellidoParam}, apellido),
        telefono = COALESCE(${telefonoParam}, telefono),
        id_rol   = COALESCE(${rolParam}, id_rol)
    WHERE id_usuario = ${idUsuario}
  `;

  const rows = await prisma.$queryRaw`
    SELECT u.id_usuario, u.nombre, u.apellido, u.correo, u.telefono,
           u.estado, r.nombre AS rol
    FROM USUARIO u
    JOIN ROL r ON r.id_rol = u.id_rol
    WHERE u.id_usuario = ${idUsuario}
    LIMIT 1
  `;
  if (!rows.length) {
    const err = new Error("Usuario no encontrado");
    err.status = 404;
    throw err;
  }
  return rows[0];
}

export async function cambiarEstadoUsuarioService(idUsuario, estado) {
  if (!estado) {
    const err = new Error("estado es obligatorio");
    err.status = 400;
    throw err;
  }

  await prisma.$queryRaw`
    UPDATE USUARIO
    SET estado = ${estado}
    WHERE id_usuario = ${idUsuario}
  `;

  const rows = await prisma.$queryRaw`
    SELECT u.id_usuario, u.nombre, u.apellido, u.correo, u.telefono,
           u.estado, r.nombre AS rol
    FROM USUARIO u
    JOIN ROL r ON r.id_rol = u.id_rol
    WHERE u.id_usuario = ${idUsuario}
    LIMIT 1
  `;
  if (!rows.length) {
    const err = new Error("Usuario no encontrado");
    err.status = 404;
    throw err;
  }
  return rows[0];
}

export async function obtenerHistorialUsuarioService(idUsuario) {
  // Llama a tu SP sp_obtener_historial_usuario
  const [rows] = await prisma.$queryRawUnsafe(
    "CALL sp_obtener_historial_usuario(?)",
    idUsuario
  );
  // rows ya es el primer resultset del CALL
  return rows;
}
</file>

<file path="src/modules/wallet/wallet.controller.js">
import {
  obtenerMisCreditosService,
  obtenerMisMovimientosService,
  comprarCreditosService,
  obtenerMisComprasService,
} from "./wallet.service.js";

export async function getMisCreditosController(req, res, next) {
  try {
    const idUsuario = req.user.id_usuario;
    const data = await obtenerMisCreditosService(idUsuario);
    res.json(data);
  } catch (err) {
    next(err);
  }
}

export async function getMisMovimientosController(req, res, next) {
  try {
    const idUsuario = req.user.id_usuario;
    const data = await obtenerMisMovimientosService(idUsuario);
    res.json(data);
  } catch (err) {
    next(err);
  }
}

export async function postCompraCreditosController(req, res, next) {
  try {
    const idUsuario = req.user.id_usuario;
    const { idPaquete, idTransaccionPago } = req.body;

    if (!idPaquete) {
      return res.status(400).json({ message: "idPaquete es obligatorio" });
    }

    const billetera = await comprarCreditosService({
      idUsuario,
      idPaquete,
      idTransaccionPago: idTransaccionPago || null,
    });

    res.status(201).json({
      message: "Compra aprobada",
      billetera,
    });
  } catch (err) {
    next(err);
  }
}

export async function getMisComprasController(req, res, next) {
  try {
    const idUsuario = req.user.id_usuario;
    const compras = await obtenerMisComprasService(idUsuario);
    res.json(compras);
  } catch (err) {
    next(err);
  }
}
</file>

<file path="src/modules/wallet/wallet.routes.js">
import { Router } from "express";
import { authMiddleware } from "../../middlewares/auth.js";
import {
  getMisCreditosController,
  getMisMovimientosController,
  postCompraCreditosController,
  getMisComprasController,
} from "./wallet.controller.js";

const router = Router();

router.use(authMiddleware);

// GET /api/wallet/mis-creditos
router.get("/mis-creditos", getMisCreditosController);

// GET /api/wallet/mis-movimientos
router.get("/mis-movimientos", getMisMovimientosController);

// POST /api/wallet/compra-creditos
router.post("/compra-creditos", postCompraCreditosController);

// GET /api/wallet/compras
router.get("/compras", getMisComprasController);

export default router;
</file>

<file path="src/modules/wallet/wallet.service.js">
// backend/src/modules/wallet/wallet.service.js
import { prisma } from "../../config/prisma.js";

// =======================================
// Helper: convertir BigInt / Decimal a Number
// =======================================
function toNumberSafe(value, def = 0) {
  if (value == null) return def;

  if (typeof value === "bigint") return Number(value);

  if (typeof value === "object" && typeof value.toNumber === "function") {
    return value.toNumber();
  }

  const num = Number(value);
  return Number.isNaN(num) ? def : num;
}

// =======================================
// Normalizadores
// =======================================

// Saldo de billetera
function normalizeBilleteraRow(row) {
  if (!row) {
    return {
      saldo_creditos: 0,
      saldo_bs: 0,
      saldo: 0,
      creditos: 0,
      saldo_bloqueado: 0,
      bloqueado: 0,
    };
  }

  const saldoCreditos = toNumberSafe(row.saldo_creditos, 0);
  const saldoBs = toNumberSafe(row.saldo_bs, 0);
  const saldoBloqueado = toNumberSafe(row.saldo_bloqueado ?? 0, 0);

  return {
    // nombres originales de la consulta
    saldo_creditos: saldoCreditos,
    saldo_bs: saldoBs,

    // alias que usan Home, Perfil y Wallet en el front
    saldo: saldoCreditos,
    creditos: saldoCreditos,
    saldo_bloqueado: saldoBloqueado,
    bloqueado: saldoBloqueado,
  };
}

// Movimiento de crÃ©ditos
function normalizeMovimientoRow(row) {
  if (!row) return row;

  const cantidad = toNumberSafe(row.cantidad, 0);

  return {
    ...row,
    cantidad,
    creditos: cantidad, // el front muestra a.creditos en Home
    saldo_anterior: toNumberSafe(row.saldo_anterior, 0),
    saldo_posterior: toNumberSafe(row.saldo_posterior, 0),
    // creado_en queda como Date y Express lo serializa a ISO
  };
}

// Compra de paquete de crÃ©ditos
function normalizeCompraRow(row) {
  if (!row) return row;

  const cant = toNumberSafe(row.cantidad_creditos, 0);
  const monto = toNumberSafe(row.monto_bs, 0);

  return {
    ...row,
    cantidad_creditos: cant,
    creditos: cant,          // para tablas que leen c.creditos
    creditos_compra: cant,   // para tablas que leen c.creditos_compra
    monto_bs: monto,
    monto,                   // alias genÃ©rico
  };
}

// =======================================
// Servicios pÃºblicos del mÃ³dulo
// =======================================

// Saldo actual de la billetera del usuario logueado
export async function obtenerMisCreditosService(idUsuario) {
  const rows = await prisma.$queryRaw`
    SELECT saldo_creditos, saldo_bs
    FROM BILLETERA
    WHERE id_usuario = ${idUsuario}
    LIMIT 1
  `;

  return normalizeBilleteraRow(rows[0]);
}

// Movimientos de la billetera del usuario
export async function obtenerMisMovimientosService(idUsuario) {
  const rows = await prisma.$queryRaw`
    SELECT m.id_movimiento,
           m.cantidad,
           m.saldo_anterior,
           m.saldo_posterior,
           m.id_referencia,
           m.creado_en,
           tm.nombre AS tipo_movimiento,
           tr.nombre AS tipo_referencia
    FROM MOVIMIENTO_CREDITOS m
    JOIN TIPO_MOVIMIENTO tm ON tm.id_tipo_movimiento = m.id_tipo_movimiento
    JOIN TIPO_REFERENCIA tr ON tr.id_tipo_referencia = m.id_tipo_referencia
    WHERE m.id_usuario = ${idUsuario}
    ORDER BY m.creado_en DESC, m.id_movimiento DESC
  `;

  return rows.map(normalizeMovimientoRow);
}

// Compra de un paquete de crÃ©ditos (llama al SP y devuelve la billetera actualizada)
export async function comprarCreditosService({
  idUsuario,
  idPaquete,
  idTransaccionPago,
}) {
  // SP: sp_compra_creditos_aprobar(p_id_usuario, p_id_paquete, p_id_transaccion_pago)
  await prisma.$executeRawUnsafe(
    "CALL sp_compra_creditos_aprobar(?, ?, ?)",
    idUsuario,
    idPaquete,
    idTransaccionPago
  );

  const rows = await prisma.$queryRaw`
    SELECT saldo_creditos, saldo_bs
    FROM BILLETERA
    WHERE id_usuario = ${idUsuario}
    LIMIT 1
  `;

  return normalizeBilleteraRow(rows[0]);
}

// Historial de compras de paquetes de crÃ©ditos
export async function obtenerMisComprasService(idUsuario) {
  const rows = await prisma.$queryRaw`
    SELECT c.id_compra,
           c.id_paquete,
           p.nombre AS paquete,
           p.cantidad_creditos,
           c.monto_bs,
           c.estado,
           c.id_transaccion_pago,
           c.creado_en
    FROM COMPRA_CREDITOS c
    JOIN PAQUETE_CREDITOS p ON p.id_paquete = c.id_paquete
    WHERE c.id_usuario = ${idUsuario}
    ORDER BY c.creado_en DESC, c.id_compra DESC
  `;

  return rows.map(normalizeCompraRow);
}
</file>

<file path="src/routes/index.js">
// src/routes/index.js
import { Router } from "express";

import authRoutes from "../modules/auth/auth.routes.js";
import usuariosRoutes from "../modules/usuarios/usuarios.routes.js";
import catalogosRoutes from "../modules/catalogos/catalogos.routes.js";
import walletRoutes from "../modules/wallet/wallet.routes.js";
import publicacionesRoutes from "../modules/publicaciones/publicaciones.routes.js";
import intercambiosRoutes from "../modules/intercambios/intercambios.routes.js";
import actividadesRoutes from "../modules/actividades/actividades.routes.js";
import promocionesRoutes from "../modules/promociones/promociones.routes.js";
import publicidadRoutes from "../modules/publicidad/publicidad.routes.js";
import logrosRoutes from "../modules/logros/logros.routes.js";
import premiumRoutes from "../modules/premium/premium.routes.js";
import reportesRoutes from "../modules/reportes/reportes.routes.js";
import uploadsRoutes from "../modules/uploads/uploads.routes.js";

// â¬‡ï¸ NUEVO
import bitacorasRoutes from "../modules/bitacoras/bitacoras.routes.js";

const router = Router();

router.get("/health", (req, res) => {
  res.json({ ok: true, message: "API Digital Barter OK" });
});

// MÃ³dulos
router.use("/auth", authRoutes);
router.use("/usuarios", usuariosRoutes);
router.use("/catalogos", catalogosRoutes);
router.use("/wallet", walletRoutes);
router.use("/publicaciones", publicacionesRoutes);
router.use("/intercambios", intercambiosRoutes);
router.use("/actividades-sostenibles", actividadesRoutes);
router.use("/promociones", promocionesRoutes);
router.use("/publicidad", publicidadRoutes);
router.use("/logros", logrosRoutes);
router.use("/premium", premiumRoutes);
router.use("/reportes", reportesRoutes);
router.use("/uploads", uploadsRoutes);

// â¬‡ï¸ NUEVO: bitÃ¡coras
router.use("/bitacoras", bitacorasRoutes);

export default router;
</file>

<file path="src/server.js">
// src/server.js
import app from './app.js'
import { env } from './config/env.js'

const PORT = env.PORT

app.listen(PORT, () => {
    console.log(`ðŸš€ API running on http://localhost:${PORT}`)
})
</file>

<file path="utils/jsonBigInt.js">
export function toJsonSafe(value) {
  if (typeof value === "bigint") {
    return Number(value);            // <- si prefieres string: value.toString()
  }

  if (Array.isArray(value)) {
    return value.map(toJsonSafe);
  }

  if (value !== null && typeof value === "object") {
    const out = {};
    for (const key in value) {
      out[key] = toJsonSafe(value[key]);
    }
    return out;
  }

  return value;
}
</file>

</files>
</file>

<file path="backend/src/app.js">
// src/app.js

// ðŸ”§ Parche global para que JSON.stringify soporte BigInt en todas las respuestas
if (typeof BigInt !== "undefined" && !BigInt.prototype.toJSON) {
  // eslint-disable-next-line no-extend-native
  BigInt.prototype.toJSON = function () {
    return Number(this);
  };
}

import express from "express";
import cors from "cors";
import morgan from "morgan";
import routes from "./routes/index.js";
import { errorHandler } from "./middlewares/errorHandler.js";

import path from "path";
import { fileURLToPath } from "url";

const app = express();

// -------------------------------------------------------------
// Necesario para rutas absolutas (uploads y archivos estÃ¡ticos)
// -------------------------------------------------------------
const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

// -------------------------------------------------------------
// Middlewares globales
// -------------------------------------------------------------
app.use(cors());                // permitir peticiones de tu frontend
app.use(morgan("dev"));         // logs en consola
app.use(express.json());        // permite JSON en body
app.use(express.urlencoded({ extended: true })); // formularios

// -------------------------------------------------------------
// Servir archivos estÃ¡ticos (subidas de imÃ¡genes)
// Ruta final: http://localhost:4000/uploads/<nombre-archivo>
// -------------------------------------------------------------
app.use(
  "/uploads",
  express.static(path.join(__dirname, "..", "uploads_storage"))
);

// -------------------------------------------------------------
// Registrar todas las rutas del backend
// -------------------------------------------------------------
app.use("/api", routes);

// -------------------------------------------------------------
// Middleware para rutas no encontradas
// -------------------------------------------------------------
app.use((req, res, next) => {
  res.status(404).json({ message: "Ruta no encontrada" });
});

// -------------------------------------------------------------
// Middleware global de manejo de errores
// (Siempre debe ir al final)
// -------------------------------------------------------------
app.use(errorHandler);

export default app;
</file>

<file path="backend/src/config/env.js">
// src/config/env.js
import 'dotenv/config'

export const env = {
  NODE_ENV: process.env.NODE_ENV ?? 'development',
  PORT: Number(process.env.PORT ?? 4000),
  DATABASE_URL: process.env.DATABASE_URL,
}
</file>

<file path="backend/src/config/prisma.js">
// src/config/prisma.js
import { PrismaClient } from '@prisma/client'

export const prisma = new PrismaClient({
    log: ['query', 'error', 'warn'],
})
</file>

<file path="backend/src/middlewares/auth.js">
// src/middlewares/auth.js
import jwt from "jsonwebtoken";

// Middleware principal: requiere token vÃ¡lido
export function authMiddleware(req, res, next) {
  const authHeader = req.headers.authorization;

  // Esperamos "Authorization: Bearer <token>"
  if (!authHeader || !authHeader.startsWith("Bearer ")) {
    return res.status(401).json({ message: "Token de autenticaciÃ³n faltante" });
  }

  const token = authHeader.split(" ")[1];

  try {
    const payload = jwt.verify(token, process.env.JWT_SECRET);
    // En el payload nosotros pusimos: id_usuario, correo, rol
    req.user = payload;
    next();
  } catch (err) {
    return res
      .status(401)
      .json({ message: "Token invÃ¡lido o expirado" });
  }
}

// VersiÃ³n opcional: si hay token lo lee, si no, deja pasar
export function optionalAuth(req, _res, next) {
  const authHeader = req.headers.authorization;
  if (!authHeader || !authHeader.startsWith("Bearer ")) {
    return next();
  }

  const token = authHeader.split(" ")[1];

  try {
    const payload = jwt.verify(token, process.env.JWT_SECRET);
    req.user = payload;
  } catch {
    // si falla, simplemente no ponemos req.user
  }
  next();
}
</file>

<file path="backend/src/middlewares/errorHandler.js">
// src/middlewares/errorHandler.js

// Middleware de manejo global de errores (SIEMPRE 4 parÃ¡metros)
export function errorHandler(err, req, res, next) {
  console.error("âŒ Error:", err);

  // Si ya se empezÃ³ a enviar la respuesta, delega a Express
  if (res.headersSent) {
    return next(err);
  }

  const status = err.status || err.statusCode || 500;
  const message =
    err.message || "OcurriÃ³ un error inesperado en el servidor";

  const response = { message };

  // En desarrollo podemos enviar mÃ¡s detalles
  if (process.env.NODE_ENV !== "production") {
    response.stack = err.stack;
    if (err.code) response.code = err.code;
  }

  res.status(status).json(response);
}
</file>

<file path="backend/src/middlewares/isAdmin.js">
// src/middlewares/isAdmin.js

// Middleware simple: solo ADMIN
export function isAdmin(req, res, next) {
  if (!req.user) {
    return res.status(401).json({ message: "No autenticado" });
  }

  if (req.user.rol !== "ADMIN") {
    return res.status(403).json({ message: "Acceso solo para administradores" });
  }

  next();
}

// Middleware mÃ¡s general: aceptar varios roles
export function hasRole(...rolesPermitidos) {
  return (req, res, next) => {
    if (!req.user) {
      return res.status(401).json({ message: "No autenticado" });
    }

    if (!rolesPermitidos.includes(req.user.rol)) {
      return res.status(403).json({ message: "No tienes permisos suficientes" });
    }

    next();
  };
}
</file>

<file path="backend/src/modules/actividades/actividades.controller.js">
// backend/src/modules/actividades/actividades.controller.js
import {
  registrarActividadService,
  misActividadesService,
  listarActividadesAdminService,
  aprobarActividadService,
  rechazarActividadService,
} from "./actividades.service.js";

/**
 * Registrar nueva actividad sostenible (usuario logueado)
 */
export const registrarActividadController = async (req, res, next) => {
  try {
    const idUsuario = req.user.id_usuario;
    const {
      id_tipo_actividad,
      descripcion,
      creditos_otorgados,
      evidencia_url,
    } = req.body;

    const result = await registrarActividadService({
      idUsuario,
      id_tipo_actividad,
      descripcion,
      creditos_otorgados,
      evidencia_url,
    });

    res.status(201).json({
      message: "Actividad registrada correctamente",
      actividad: result,
    });
  } catch (e) {
    next(e);
  }
};

/**
 * Listar SOLO mis actividades (usuario logueado)
 */
export const misActividadesController = async (req, res, next) => {
  try {
    const idUsuario = req.user.id_usuario;
    const actividades = await misActividadesService(idUsuario);
    res.json(actividades);
  } catch (e) {
    next(e);
  }
};

/**
 * Listar actividades para ADMIN, con filtros opcionales:
 *  - ?id_usuario=...
 *  - ?id_tipo_actividad=...
 *  - ?desde=YYYY-MM-DD
 *  - ?hasta=YYYY-MM-DD
 */
export const listarActividadesAdminController = async (req, res, next) => {
  try {
    const { id_usuario, id_tipo_actividad, desde, hasta } = req.query;

    const filtros = {
      id_usuario: id_usuario ? Number(id_usuario) : undefined,
      id_tipo_actividad: id_tipo_actividad
        ? Number(id_tipo_actividad)
        : undefined,
      desde: desde || undefined,
      hasta: hasta || undefined,
    };

    const actividades = await listarActividadesAdminService(filtros);

    res.json({
      message: "Listado de actividades sostenibles",
      filtros,
      data: actividades,
    });
  } catch (e) {
    next(e);
  }
};

/**
 * Aprobar actividad sostenible (ADMIN)
 * PATCH /api/actividades-sostenibles/:id/aprobar
 */
export const aprobarActividadController = async (req, res, next) => {
  try {
    const idAdmin = req.user.id_usuario;
    const idActividad = Number(req.params.id);

    if (!idActividad || Number.isNaN(idActividad)) {
      return res.status(400).json({ message: "ID de actividad invÃ¡lido" });
    }

    const actividad = await aprobarActividadService({ idActividad, idAdmin });

    res.json({
      message: "Actividad aprobada correctamente",
      actividad,
    });
  } catch (e) {
    next(e);
  }
};

/**
 * Rechazar actividad sostenible (ADMIN)
 * PATCH /api/actividades-sostenibles/:id/rechazar
 */
export const rechazarActividadController = async (req, res, next) => {
  try {
    const idAdmin = req.user.id_usuario;
    const idActividad = Number(req.params.id);

    if (!idActividad || Number.isNaN(idActividad)) {
      return res.status(400).json({ message: "ID de actividad invÃ¡lido" });
    }

    const actividad = await rechazarActividadService({ idActividad, idAdmin });

    res.json({
      message: "Actividad rechazada correctamente",
      actividad,
    });
  } catch (e) {
    next(e);
  }
};
</file>

<file path="backend/src/modules/actividades/actividades.routes.js">
import { Router } from "express";
import { authMiddleware } from "../../middlewares/auth.js";
import { isAdmin } from "../../middlewares/isAdmin.js";
import {
  registrarActividadController,
  misActividadesController,
  listarActividadesAdminController,
  aprobarActividadController,
  rechazarActividadController,
} from "./actividades.controller.js";

const router = Router();

router.use(authMiddleware);

router.post("/", registrarActividadController);            // POST /api/actividades-sostenibles
router.get("/mias", misActividadesController);             // GET  /api/actividades-sostenibles/mias
router.get("/admin", isAdmin, listarActividadesAdminController); // GET /api/actividades-sostenibles/admin

router.patch("/:id/aprobar", isAdmin, aprobarActividadController);   // PATCH /api/actividades-sostenibles/:id/aprobar
router.patch("/:id/rechazar", isAdmin, rechazarActividadController); // PATCH /api/actividades-sostenibles/:id/rechazar

export default router;
</file>

<file path="backend/src/modules/actividades/actividades.service.js">
import { prisma } from "../../config/prisma.js";

export async function registrarActividadService({
  idUsuario,
  id_tipo_actividad,
  descripcion,
  creditos_otorgados,
  evidencia_url,
}) {
  if (!id_tipo_actividad || !descripcion || creditos_otorgados == null) {
    const err = new Error(
      "id_tipo_actividad, descripcion y creditos_otorgados son obligatorios"
    );
    err.status = 400;
    throw err;
  }

  const creditosNum = Number(creditos_otorgados);
  if (!Number.isFinite(creditosNum) || creditosNum <= 0) {
    const err = new Error("creditos_otorgados debe ser un nÃºmero mayor a 0");
    err.status = 400;
    throw err;
  }

  // Llamar SP que encapsula la lÃ³gica de negocio
  await prisma.$executeRawUnsafe(
    "CALL sp_registrar_actividad_sostenible(?, ?, ?, ?, ?)",
    idUsuario,
    id_tipo_actividad,
    descripcion,
    creditosNum,
    evidencia_url || null
  );

  // devolver la Ãºltima actividad del usuario (reciente)
  const [act] = await prisma.$queryRaw`
    SELECT *
    FROM ACTIVIDAD_SOSTENIBLE
    WHERE id_usuario = ${idUsuario}
    ORDER BY creado_en DESC, id_actividad DESC
    LIMIT 1
  `;
  return act;
}

export async function misActividadesService(idUsuario) {
  return prisma.$queryRaw`
    SELECT *
    FROM ACTIVIDAD_SOSTENIBLE
    WHERE id_usuario = ${idUsuario}
    ORDER BY creado_en DESC
  `;
}

/**
 * Listado ADMIN con filtros opcionales:
 *  - id_usuario
 *  - id_tipo_actividad
 *  - desde / hasta (sobre columna creado_en)
 *
 * VersiÃ³n pro: incluye nombre de usuario y nombre del tipo de actividad.
 */
export async function listarActividadesAdminService({
  id_usuario,
  id_tipo_actividad,
  desde,
  hasta,
}) {
  let sql = `
    SELECT
      a.*,
      u.nombre       AS nombre_usuario,
      u.correo       AS correo_usuario,
      ta.nombre      AS nombre_tipo_actividad
    FROM ACTIVIDAD_SOSTENIBLE a
    JOIN USUARIO u
      ON u.id_usuario = a.id_usuario
    JOIN TIPO_ACTIVIDAD ta
      ON ta.id_tipo_actividad = a.id_tipo_actividad
    WHERE 1=1
  `;
  const params = [];

  if (id_usuario) {
    sql += " AND a.id_usuario = ?";
    params.push(id_usuario);
  }

  if (id_tipo_actividad) {
    sql += " AND a.id_tipo_actividad = ?";
    params.push(id_tipo_actividad);
  }

  if (desde) {
    sql += " AND DATE(a.creado_en) >= ?";
    params.push(desde);
  }

  if (hasta) {
    sql += " AND DATE(a.creado_en) <= ?";
    params.push(hasta);
  }

  sql += " ORDER BY a.creado_en DESC, a.id_actividad DESC";

  return prisma.$queryRawUnsafe(sql, ...params);
}
export async function aprobarActividadService({ idActividad, idAdmin }) {
  // Llamar al SP que APRUEBA la actividad y otorga crÃ©ditos
  await prisma.$executeRawUnsafe(
    "CALL sp_aprobar_actividad_sostenible(?, ?)",
    idActividad,
    idAdmin
  );

  // Devolver la actividad actualizada
  const [act] = await prisma.$queryRaw`
    SELECT *
    FROM ACTIVIDAD_SOSTENIBLE
    WHERE id_actividad = ${idActividad}
  `;
  return act;
}

export async function rechazarActividadService({ idActividad, idAdmin }) {
  // Llamar al SP que marca la actividad como RECHAZADA
  await prisma.$executeRawUnsafe(
    "CALL sp_rechazar_actividad_sostenible(?, ?)",
    idActividad,
    idAdmin
  );

  const [act] = await prisma.$queryRaw`
    SELECT *
    FROM ACTIVIDAD_SOSTENIBLE
    WHERE id_actividad = ${idActividad}
  `;
  return act;
}
</file>

<file path="backend/src/modules/auth/auth.controller.js">
import {
  registrarUsuarioService,
  loginService,
  obtenerPerfilService,
  actualizarPerfilService,
  cambiarPasswordService,
} from "./auth.service.js";

/**
 * POST /api/auth/register
 * Registro pÃºblico (rol USUARIO)
 */
export async function registerController(req, res, next) {
  try {
    const { nombre, apellido, correo, password, telefono } = req.body;

    if (!nombre || !correo || !password) {
      return res
        .status(400)
        .json({ message: "nombre, correo y password son obligatorios" });
    }

    const usuario = await registrarUsuarioService({
      nombre,
      apellido,
      correo,
      password,
      telefono,
    });

    res.status(201).json({
      message: "Usuario registrado correctamente",
      usuario,
    });
  } catch (err) {
    next(err);
  }
}

/**
 * POST /api/auth/login
 */
export async function loginController(req, res, next) {
  try {
    const { correo, password } = req.body;

    if (!correo || !password) {
      return res
        .status(400)
        .json({ message: "correo y password son obligatorios" });
    }

    const result = await loginService({
      correo,
      password,
      ip: req.ip,
      userAgent: req.headers["user-agent"] || "",
    });

    res.json(result); // { token, usuario }
  } catch (err) {
    next(err);
  }
}

/**
 * GET /api/auth/me
 * Perfil del usuario actual
 */
export async function meController(req, res, next) {
  try {
    const idUsuario = req.user.id_usuario;
    const perfil = await obtenerPerfilService(idUsuario);
    res.json(perfil);
  } catch (err) {
    next(err);
  }
}

/**
 * PUT /api/auth/me
 * Actualizar perfil del usuario logueado
 * Campos permitidos: nombre, apellido, telefono, url_perfil
 */
export async function updateProfileController(req, res, next) {
  try {
    const idUsuario = req.user.id_usuario;
    const { nombre, apellido, telefono, url_perfil } = req.body;

    if (
      nombre === undefined &&
      apellido === undefined &&
      telefono === undefined &&
      url_perfil === undefined
    ) {
      return res
        .status(400)
        .json({ message: "No se enviÃ³ ningÃºn campo para actualizar" });
    }

    const usuarioActualizado = await actualizarPerfilService(idUsuario, {
      nombre,
      apellido,
      telefono,
      url_perfil,
    });

    return res.json({
      message: "Perfil actualizado correctamente",
      usuario: usuarioActualizado,
    });
  } catch (err) {
    next(err);
  }
}

/**
 * PATCH /api/auth/me/password
 * Cambiar contraseÃ±a del usuario logueado
 * Body: { password_actual, password_nueva }
 */
export async function changePasswordController(req, res, next) {
  try {
    const idUsuario = req.user.id_usuario;
    const { password_actual, password_nueva } = req.body;

    if (!password_actual || !password_nueva) {
      return res.status(400).json({
        message: "password_actual y password_nueva son obligatorios",
      });
    }

    if (password_nueva.length < 6) {
      return res.status(400).json({
        message: "La nueva contraseÃ±a debe tener al menos 6 caracteres",
      });
    }

    await cambiarPasswordService(idUsuario, password_actual, password_nueva);

    return res.json({
      message: "ContraseÃ±a actualizada correctamente",
    });
  } catch (err) {
    next(err);
  }
}
</file>

<file path="backend/src/modules/auth/auth.routes.js">
import { Router } from "express";
import {
  registerController,
  loginController,
  meController,
  updateProfileController,
  changePasswordController,
} from "./auth.controller.js";
import { authMiddleware } from "../../middlewares/auth.js";

const router = Router();

// Registro pÃºblico
router.post("/register", registerController);

// Login
router.post("/login", loginController);

// Datos del usuario logueado
router.get("/me", authMiddleware, meController);

// Actualizar perfil del usuario logueado
router.put("/me", authMiddleware, updateProfileController);

// Cambiar contraseÃ±a del usuario logueado
router.patch("/me/password", authMiddleware, changePasswordController);

export default router;
</file>

<file path="backend/src/modules/auth/auth.service.js">
import bcrypt from "bcryptjs";
import jwt from "jsonwebtoken";
import { prisma } from "../../config/prisma.js";

// Helper: obtener id_rol por nombre
async function getRolId(nombreRol) {
  const rows = await prisma.$queryRaw`
    SELECT id_rol FROM ROL WHERE nombre = ${nombreRol} LIMIT 1
  `;
  if (!rows.length) {
    throw new Error(`No existe el rol ${nombreRol}`);
  }
  return rows[0].id_rol;
}

// Helper: obtener id_resultado de BITACORA_ACCESO (OK / FAIL)
async function getResultadoAccesoId(nombre) {
  const rows = await prisma.$queryRaw`
    SELECT id_resultado FROM RESULTADO_ACCESO WHERE nombre = ${nombre} LIMIT 1
  `;
  if (!rows.length) {
    throw new Error(`No existe RESULTADO_ACCESO '${nombre}'`);
  }
  return rows[0].id_resultado;
}

/**
 * Registro de usuario
 */
export async function registrarUsuarioService({
  nombre,
  apellido,
  correo,
  password,
  telefono,
}) {
  // Â¿Correo ya existe?
  const existente = await prisma.$queryRaw`
    SELECT id_usuario FROM USUARIO WHERE correo = ${correo} LIMIT 1
  `;
  if (existente.length) {
    const error = new Error("El correo ya estÃ¡ registrado");
    error.status = 409;
    throw error;
  }

  const hash = await bcrypt.hash(password, 10);
  const idRolUsuario = await getRolId("USUARIO");

  await prisma.$queryRaw`
    INSERT INTO USUARIO (id_rol, estado, nombre, apellido, correo, password_hash, telefono, url_perfil)
    VALUES (${idRolUsuario}, 'ACTIVO', ${nombre}, ${apellido || null}, ${correo},
            ${hash}, ${telefono || null}, NULL)
  `;

  // Volver a leer el usuario insertado
  const usuarioRows = await prisma.$queryRaw`
    SELECT u.id_usuario, u.nombre, u.apellido, u.correo, u.telefono, r.nombre AS rol, u.estado
    FROM USUARIO u
    JOIN ROL r ON r.id_rol = u.id_rol
    WHERE u.correo = ${correo}
    LIMIT 1
  `;

  return usuarioRows[0];
}

/**
 * Login + bitÃ¡cora de acceso + JWT
 */
export async function loginService({ correo, password, ip, userAgent }) {
  const usuarios = await prisma.$queryRaw`
    SELECT u.id_usuario, u.password_hash, u.nombre, u.apellido, u.correo,
           u.estado, r.nombre AS rol
    FROM USUARIO u
    JOIN ROL r ON r.id_rol = u.id_rol
    WHERE u.correo = ${correo}
    LIMIT 1
  `;

  const user = usuarios[0];

  if (!user) {
    // AquÃ­ podrÃ­as registrar bitÃ¡cora sin usuario, si quisieras
    const error = new Error("Credenciales invÃ¡lidas");
    error.status = 401;
    throw error;
  }

  // ===== compatibilidad con hashes bcrypt y texto plano =====
  let ok = false;

  try {
    // Si parece un hash bcrypt ($2a$, $2b$, $2y$...), usamos bcrypt.compare
    if (user.password_hash && user.password_hash.startsWith("$2")) {
      ok = await bcrypt.compare(password, user.password_hash);
    } else {
      // Si NO parece hash, asumimos que estÃ¡ en texto plano (ej: '123456')
      ok = password === user.password_hash;
    }
  } catch (e) {
    // Si bcrypt truena por hash invÃ¡lido, hacemos fallback a texto plano
    ok = password === user.password_hash;
  }

  const resultadoNombre = ok ? "OK" : "FAIL";
  const idResultado = await getResultadoAccesoId(resultadoNombre);

  // Registrar en BITACORA_ACCESO (solo si tenemos usuario)
  await prisma.$queryRaw`
    INSERT INTO BITACORA_ACCESO (id_usuario, fecha, direccion_ip, user_agent, id_resultado)
    VALUES (${user.id_usuario}, NOW(), ${ip}, ${userAgent}, ${idResultado})
  `;

  if (!ok) {
    const error = new Error("Credenciales invÃ¡lidas");
    error.status = 401;
    throw error;
  }

  const payload = {
    id_usuario: user.id_usuario,
    correo: user.correo,
    rol: user.rol,
  };

  const token = jwt.sign(payload, process.env.JWT_SECRET, {
    expiresIn: "2h",
  });

  return {
    token,
    usuario: {
      id_usuario: user.id_usuario,
      nombre: user.nombre,
      apellido: user.apellido,
      correo: user.correo,
      rol: user.rol,
      estado: user.estado,
    },
  };
}

/**
 * Perfil de usuario por id
 */
export async function obtenerPerfilService(idUsuario) {
  const rows = await prisma.$queryRaw`
    SELECT u.id_usuario, u.nombre, u.apellido, u.correo, u.telefono,
           u.estado, u.url_perfil, r.nombre AS rol
    FROM USUARIO u
    JOIN ROL r ON r.id_rol = u.id_rol
    WHERE u.id_usuario = ${idUsuario}
    LIMIT 1
  `;
  if (!rows.length) {
    const err = new Error("Usuario no encontrado");
    err.status = 404;
    throw err;
  }
  return rows[0];
}

/**
 * Actualizar perfil de un usuario
 * (no borra campos si no se envÃ­an)
 */
export async function actualizarPerfilService(idUsuario, datos) {
  const { nombre, apellido, telefono, url_perfil } = datos;

  // 1) Obtener valores actuales
  const currentRows = await prisma.$queryRaw`
    SELECT id_usuario, nombre, apellido, telefono, url_perfil, id_rol, estado, correo
    FROM USUARIO
    WHERE id_usuario = ${idUsuario}
    LIMIT 1
  `;

  if (!currentRows.length) {
    const err = new Error("Usuario no encontrado");
    err.status = 404;
    throw err;
  }

  const current = currentRows[0];

  // 2) Mezclar valores nuevos con actuales
  const nuevoNombre = nombre !== undefined ? nombre : current.nombre;
  const nuevoApellido = apellido !== undefined ? apellido : current.apellido;
  const nuevoTelefono = telefono !== undefined ? telefono : current.telefono;
  const nuevaUrlPerfil =
    url_perfil !== undefined ? url_perfil : current.url_perfil;

  // 3) Actualizar
  await prisma.$queryRaw`
    UPDATE USUARIO
    SET
      nombre = ${nuevoNombre},
      apellido = ${nuevoApellido},
      telefono = ${nuevoTelefono},
      url_perfil = ${nuevaUrlPerfil}
    WHERE id_usuario = ${idUsuario}
  `;

  // 4) Devolver datos actualizados + rol
  const rows = await prisma.$queryRaw`
    SELECT u.id_usuario, u.nombre, u.apellido, u.correo, u.telefono,
           u.estado, u.url_perfil, r.nombre AS rol
    FROM USUARIO u
    JOIN ROL r ON r.id_rol = u.id_rol
    WHERE u.id_usuario = ${idUsuario}
    LIMIT 1
  `;

  return rows[0];
}

/**
 * Cambiar contraseÃ±a de un usuario
 */
export async function cambiarPasswordService(
  idUsuario,
  passwordActual,
  passwordNueva
) {
  const rows = await prisma.$queryRaw`
    SELECT password_hash
    FROM USUARIO
    WHERE id_usuario = ${idUsuario}
    LIMIT 1
  `;

  if (!rows.length) {
    const err = new Error("Usuario no encontrado");
    err.status = 404;
    throw err;
  }

  const { password_hash } = rows[0];

  let ok = false;

  try {
    if (password_hash && password_hash.startsWith("$2")) {
      ok = await bcrypt.compare(passwordActual, password_hash);
    } else {
      ok = passwordActual === password_hash;
    }
  } catch (e) {
    ok = passwordActual === password_hash;
  }

  if (!ok) {
    const err = new Error("La contraseÃ±a actual es incorrecta");
    err.status = 400;
    throw err;
  }

  const nuevoHash = await bcrypt.hash(passwordNueva, 10);

  await prisma.$queryRaw`
    UPDATE USUARIO
    SET password_hash = ${nuevoHash}
    WHERE id_usuario = ${idUsuario}
  `;

  return true;
}
</file>

<file path="backend/src/modules/bitacoras/bitacoras.controller.js">
// src/modules/bitacoras/bitacoras.controller.js
import {
  listarAccesosService,
  listarBitacoraIntercambiosService,
} from "./bitacoras.service.js";

function toInt(v, def = null) {
  const n = Number(v);
  return Number.isNaN(n) ? def : n;
}

/**
 * GET /api/bitacoras/accesos
 * Admin: lista accesos (con paginaciÃ³n y filtro opcional por idUsuario)
 */
export async function getAccesosController(req, res, next) {
  try {
    const { page, pageSize, idUsuario } = req.query;

    const result = await listarAccesosService({
      page: toInt(page, 1),
      pageSize: toInt(pageSize, 20),
      idUsuario: idUsuario ? toInt(idUsuario) : null,
    });

    res.json(result);
  } catch (err) {
    next(err);
  }
}

/**
 * GET /api/bitacoras/mis-accesos
 * Usuario normal: ve solo sus propios accesos
 */
export async function getMisAccesosController(req, res, next) {
  try {
    const { page, pageSize } = req.query;
    const idUsuario = req.user.id_usuario;

    const result = await listarAccesosService({
      page: toInt(page, 1),
      pageSize: toInt(pageSize, 20),
      idUsuario,
    });

    res.json(result);
  } catch (err) {
    next(err);
  }
}

/**
 * GET /api/bitacoras/intercambios
 * Admin: bitÃ¡cora de intercambios.
 * Filtros opcionales: ?idTransaccion=&idUsuario=
 */
export async function getBitacoraIntercambiosController(req, res, next) {
  try {
    const { page, pageSize, idTransaccion, idUsuario } = req.query;

    const result = await listarBitacoraIntercambiosService({
      page: toInt(page, 1),
      pageSize: toInt(pageSize, 20),
      idTransaccion: idTransaccion ? toInt(idTransaccion) : null,
      idUsuario: idUsuario ? toInt(idUsuario) : null,
    });

    res.json(result);
  } catch (err) {
    next(err);
  }
}
</file>

<file path="backend/src/modules/bitacoras/bitacoras.routes.js">
// src/modules/bitacoras/bitacoras.routes.js
import { Router } from "express";
import { authMiddleware } from "../../middlewares/auth.js";
import { isAdmin } from "../../middlewares/isAdmin.js";
import {
  getAccesosController,
  getMisAccesosController,
  getBitacoraIntercambiosController,
} from "./bitacoras.controller.js";

const router = Router();

// Todas requieren login
router.use(authMiddleware);

// Admin: ver todos los accesos
router.get("/accesos", isAdmin, getAccesosController);

// Usuario: ver solo sus accesos
router.get("/mis-accesos", getMisAccesosController);

// Admin: bitÃ¡cora de intercambios
router.get("/intercambios", isAdmin, getBitacoraIntercambiosController);

export default router;
</file>

<file path="backend/src/modules/bitacoras/bitacoras.service.js">
// src/modules/bitacoras/bitacoras.service.js
import { prisma } from "../../config/prisma.js";

/**
 * Listar accesos (BITACORA_ACCESO) con paginaciÃ³n.
 * Si se envÃ­a idUsuario, filtra por ese usuario.
 */
export async function listarAccesosService({
  page = 1,
  pageSize = 20,
  idUsuario = null,
}) {
  const limit = Math.max(1, Math.min(Number(pageSize) || 20, 100));
  const pageNum = Math.max(Number(page) || 1, 1);
  const offset = (pageNum - 1) * limit;

  let where = "WHERE 1=1";
  const params = [];

  if (idUsuario) {
    where += " AND b.id_usuario = ?";
    params.push(Number(idUsuario));
  }

  const countSql = `
    SELECT COUNT(*) AS total
    FROM BITACORA_ACCESO b
    ${where}
  `;
  const [countRow] = await prisma.$queryRawUnsafe(countSql, ...params);
  const total = Number(countRow?.total || 0);

  const dataSql = `
    SELECT
      b.id_acceso AS id_bitacora,
      b.id_usuario,
      u.nombre,
      u.correo,
      b.fecha,
      b.direccion_ip,
      b.user_agent,
      r.nombre AS resultado
    FROM BITACORA_ACCESO b
    JOIN USUARIO u ON u.id_usuario = b.id_usuario
    JOIN RESULTADO_ACCESO r ON r.id_resultado = b.id_resultado
    ${where}
    ORDER BY b.fecha DESC, b.id_acceso DESC
    LIMIT ? OFFSET ?
  `;
  const data = await prisma.$queryRawUnsafe(
    dataSql,
    ...params,
    limit,
    offset
  );

  return {
    page: pageNum,
    pageSize: limit,
    total,
    data,
  };
}

/**
 * BitÃ¡cora de intercambios (BITACORA_INTERCAMBIO) con paginaciÃ³n.
 * Opcional: filtrar por idTransaccion o idUsuario (origen/destino).
 */
export async function listarBitacoraIntercambiosService({
  page = 1,
  pageSize = 20,
  idTransaccion = null,
  idUsuario = null,
}) {
  const limit = Math.max(1, Math.min(Number(pageSize) || 20, 100));
  const pageNum = Math.max(Number(page) || 1, 1);
  const offset = (pageNum - 1) * limit;

  let where = "WHERE 1=1";
  const params = [];

  if (idTransaccion) {
    where += " AND bi.id_transaccion = ?";
    params.push(Number(idTransaccion));
  }

  if (idUsuario) {
    where +=
      " AND (bi.id_usuario_origen = ? OR bi.id_usuario_destino = ?)";
    params.push(Number(idUsuario), Number(idUsuario));
  }

  const countSql = `
    SELECT COUNT(*) AS total
    FROM BITACORA_INTERCAMBIO bi
    ${where}
  `;
  const [countRow] = await prisma.$queryRawUnsafe(countSql, ...params);
  const total = Number(countRow?.total || 0);

  const dataSql = `
    SELECT
      bi.id_bitacora,
      bi.id_transaccion,
      bi.id_usuario_origen,
      uo.nombre  AS usuario_origen,
      bi.id_usuario_destino,
      ud.nombre  AS usuario_destino,
      bi.cantidad_creditos,
      bi.descripcion,
      t.estado   AS estado_transaccion,
      t.creado_en AS fecha_transaccion
    FROM BITACORA_INTERCAMBIO bi
    JOIN TRANSACCION t
      ON t.id_transaccion = bi.id_transaccion
    JOIN USUARIO uo
      ON uo.id_usuario = bi.id_usuario_origen
    JOIN USUARIO ud
      ON ud.id_usuario = bi.id_usuario_destino
    ${where}
    ORDER BY bi.id_bitacora DESC
    LIMIT ? OFFSET ?
  `;
  const data = await prisma.$queryRawUnsafe(
    dataSql,
    ...params,
    limit,
    offset
  );

  return {
    page: pageNum,
    pageSize: limit,
    total,
    data,
  };
}
</file>

<file path="backend/src/modules/catalogos/catalogos.controller.js">
import {
  listarCategorias,
  listarUnidadesMedida,
  listarPaquetesCreditos,
  listarTiposActividad,
  listarTiposPromocion,
  listarUbicacionesPublicidad,
  listarTiposLogro,
  // Opcional (para admin â€“ CRUD)
  crearCatalogoService,
  editarCatalogoService,
} from "./catalogos.service.js";

// Helper para respuestas limpias
function ok(res, data) {
  return res.json({ ok: true, data });
}

/* =======================
   CATÃLOGOS PÃšBLICOS
   ======================= */

export const getCategorias = async (_req, res, next) => {
  try {
    ok(res, await listarCategorias());
  } catch (e) {
    next(e);
  }
};

export const getUnidadesMedida = async (_req, res, next) => {
  try {
    ok(res, await listarUnidadesMedida());
  } catch (e) {
    next(e);
  }
};

export const getPaquetesCreditos = async (_req, res, next) => {
  try {
    ok(res, await listarPaquetesCreditos());
  } catch (e) {
    next(e);
  }
};

export const getTiposActividad = async (_req, res, next) => {
  try {
    ok(res, await listarTiposActividad());
  } catch (e) {
    next(e);
  }
};

export const getTiposPromocion = async (_req, res, next) => {
  try {
    ok(res, await listarTiposPromocion());
  } catch (e) {
    next(e);
  }
};

export const getUbicacionesPublicidad = async (_req, res, next) => {
  try {
    ok(res, await listarUbicacionesPublicidad());
  } catch (e) {
    next(e);
  }
};

export const getTiposLogro = async (_req, res, next) => {
  try {
    ok(res, await listarTiposLogro());
  } catch (e) {
    next(e);
  }
};

/* =======================
   OPCIONAL: ADMIN â€“ CRUD
   ======================= */

export const crearCatalogoController = async (req, res, next) => {
  try {
    const { tabla, nombre } = req.body;
    const result = await crearCatalogoService(tabla, nombre);
    res
      .status(201)
      .json({ ok: true, message: "Creado correctamente", data: result });
  } catch (e) {
    next(e);
  }
};

export const editarCatalogoController = async (req, res, next) => {
  try {
    const { tabla, id, nombre } = req.body;
    const result = await editarCatalogoService(tabla, id, nombre);
    res.json({ ok: true, message: "Actualizado correctamente", data: result });
  } catch (e) {
    next(e);
  }
};
</file>

<file path="backend/src/modules/catalogos/catalogos.routes.js">
import { Router } from "express";
import {
  getCategorias,
  getUnidadesMedida,
  getPaquetesCreditos,
  getTiposActividad,
  getTiposPromocion,
  getUbicacionesPublicidad,
  getTiposLogro,
  // CRUD opcional solo admin
  crearCatalogoController,
  editarCatalogoController,
} from "./catalogos.controller.js";

import { authMiddleware } from "../../middlewares/auth.js";
import { isAdmin } from "../../middlewares/isAdmin.js";

const router = Router();

/* =======================
   RUTAS PÃšBLICAS
   ======================= */
router.get("/categorias", getCategorias);
router.get("/unidades-medida", getUnidadesMedida);
router.get("/paquetes-creditos", getPaquetesCreditos);
router.get("/tipos-actividad", getTiposActividad);
router.get("/tipos-promocion", getTiposPromocion);
router.get("/ubicaciones-publicidad", getUbicacionesPublicidad);
router.get("/tipos-logro", getTiposLogro);

/* =======================
   RUTAS ADMIN (OPCIONALES)
   ======================= */
router.use(authMiddleware, isAdmin);

router.post("/admin/crear", crearCatalogoController);
router.put("/admin/editar", editarCatalogoController);

export default router;
</file>

<file path="backend/src/modules/catalogos/catalogos.service.js">
import { prisma } from "../../config/prisma.js";

/* =======================
   LISTADOS
   ======================= */

export const listarCategorias = () =>
  prisma.$queryRaw`SELECT * FROM CATEGORIA ORDER BY nombre`;

export const listarUnidadesMedida = () =>
  prisma.$queryRaw`SELECT * FROM UNIDAD_MEDIDA ORDER BY nombre`;

export const listarPaquetesCreditos = () =>
  prisma.$queryRaw`SELECT * FROM PAQUETE_CREDITOS WHERE activo = TRUE ORDER BY cantidad_creditos`;

export const listarTiposActividad = () =>
  prisma.$queryRaw`SELECT * FROM TIPO_ACTIVIDAD ORDER BY nombre`;

export const listarTiposPromocion = () =>
  prisma.$queryRaw`SELECT * FROM TIPO_PROMOCION ORDER BY nombre`;

export const listarUbicacionesPublicidad = () =>
  prisma.$queryRaw`SELECT * FROM UBICACION_PUBLICIDAD ORDER BY nombre`;

export const listarTiposLogro = () =>
  prisma.$queryRaw`SELECT * FROM TIPO_LOGRO ORDER BY nombre`;

/* =======================
   CRUD OPCIONAL (ADMIN)
   ======================= */

/**
 * Solo catÃ¡logos "simples" (id, nombre, descripcion opcional)
 * que admiten INSERT(nombre) sin campos extra obligatorios.
 */
const tablasPermitidas = {
  categoria: {
    tabla: "CATEGORIA",
    idCol: "id_categoria",
  },
  tipo_actividad: {
    tabla: "TIPO_ACTIVIDAD",
    idCol: "id_tipo_actividad",
  },
  tipo_promocion: {
    tabla: "TIPO_PROMOCION",
    idCol: "id_tipo_promocion",
  },
  tipo_logro: {
    tabla: "TIPO_LOGRO",
    idCol: "id_tipo_logro",
  },
  // NOTA:
  // UNIDAD_MEDIDA y UBICACION_PUBLICIDAD quedan solo lectura,
  // porque requieren mÃ¡s campos (simbolo, precio_base, etc.).
};

/**
 * Crear registro en catÃ¡logo genÃ©rico (ADMIN)
 */
export async function crearCatalogoService(tabla, nombre) {
  const meta = tablasPermitidas[tabla];
  if (!meta) {
    const err = new Error("CatÃ¡logo no permitido para creaciÃ³n genÃ©rica");
    err.status = 400;
    throw err;
  }

  if (!nombre) {
    const err = new Error("El nombre es obligatorio");
    err.status = 400;
    throw err;
  }

  await prisma.$queryRawUnsafe(
    `INSERT INTO ${meta.tabla} (nombre) VALUES (?)`,
    nombre
  );

  // devolver el Ãºltimo creado (por nombre)
  const [row] = await prisma.$queryRawUnsafe(
    `SELECT * FROM ${meta.tabla} WHERE nombre = ? ORDER BY ${meta.idCol} DESC LIMIT 1`,
    nombre
  );

  return row || { tabla: meta.tabla, nombre };
}

/**
 * Editar registro en catÃ¡logo genÃ©rico (ADMIN)
 */
export async function editarCatalogoService(tabla, id, nombre) {
  const meta = tablasPermitidas[tabla];
  if (!meta) {
    const err = new Error("CatÃ¡logo no permitido para ediciÃ³n genÃ©rica");
    err.status = 400;
    throw err;
  }

  if (!id || !nombre) {
    const err = new Error("id y nombre son obligatorios");
    err.status = 400;
    throw err;
  }

  await prisma.$queryRawUnsafe(
    `UPDATE ${meta.tabla} SET nombre = ? WHERE ${meta.idCol} = ?`,
    nombre,
    id
  );

  const [row] = await prisma.$queryRawUnsafe(
    `SELECT * FROM ${meta.tabla} WHERE ${meta.idCol} = ? LIMIT 1`,
    id
  );

  return row || { tabla: meta.tabla, id, nombre };
}
</file>

<file path="backend/src/modules/intercambios/intercambios.controller.js">
import {
  crearIntercambioService,
  misComprasService,
  misVentasService,
  detalleTransaccionService,
} from "./intercambios.service.js";

export const crearIntercambioController = async (req, res, next) => {
  try {
    const idComprador = req.user.id_usuario;
    const { id_publicacion, creditos } = req.body;

    const tx = await crearIntercambioService({
      idComprador,
      id_publicacion,
      creditos,
    });

    res
      .status(201)
      .json({ message: "Intercambio creado correctamente", transaccion: tx });
  } catch (e) {
    next(e);
  }
};

export const misComprasController = async (req, res, next) => {
  try {
    const compras = await misComprasService(req.user.id_usuario);
    res.json(compras);
  } catch (e) {
    next(e);
  }
};

export const misVentasController = async (req, res, next) => {
  try {
    const ventas = await misVentasService(req.user.id_usuario);
    res.json(ventas);
  } catch (e) {
    next(e);
  }
};

export const detalleTransaccionController = async (req, res, next) => {
  try {
    const id = Number(req.params.id);
    if (!Number.isFinite(id)) {
      return res.status(400).json({ message: "ID de transacciÃ³n invÃ¡lido" });
    }

    const detalle = await detalleTransaccionService(id);
    res.json(detalle);
  } catch (e) {
    next(e);
  }
};
</file>

<file path="backend/src/modules/intercambios/intercambios.routes.js">
import { Router } from "express";
import { authMiddleware } from "../../middlewares/auth.js";
import {
  crearIntercambioController,
  misComprasController,
  misVentasController,
  detalleTransaccionController,
} from "./intercambios.controller.js";

const router = Router();

// Todas las rutas requieren estar logueado
router.use(authMiddleware);

// Crear nuevo intercambio
router.post("/", crearIntercambioController);

// Ver mis compras
router.get("/mis-compras", misComprasController);

// Ver mis ventas
router.get("/mis-ventas", misVentasController);

// Detalle de una transacciÃ³n
router.get("/:id", detalleTransaccionController);

export default router;
</file>

<file path="backend/src/modules/intercambios/intercambios.service.js">
import { prisma } from "../../config/prisma.js";

export async function crearIntercambioService({
  idComprador,
  id_publicacion,
  creditos,
}) {
  if (!id_publicacion || creditos == null) {
    const err = new Error("id_publicacion y creditos son obligatorios");
    err.status = 400;
    throw err;
  }

  const creditosNum = Number(creditos);
  if (!Number.isFinite(creditosNum) || creditosNum <= 0) {
    const err = new Error("creditos debe ser un nÃºmero mayor a 0");
    err.status = 400;
    throw err;
  }

  // Llamar SP que encapsula toda la lÃ³gica de negocio
  await prisma.$executeRawUnsafe(
    "CALL sp_realizar_intercambio(?, ?, ?)",
    idComprador,
    id_publicacion,
    creditosNum
  );

  // Ãšltima transacciÃ³n creada por el comprador (mÃ¡s reciente)
  const [tx] = await prisma.$queryRaw`
    SELECT t.*, p.titulo
    FROM TRANSACCION t
    JOIN PUBLICACION p ON p.id_publicacion = t.id_publicacion
    WHERE t.id_comprador = ${idComprador}
    ORDER BY t.creado_en DESC, t.id_transaccion DESC
    LIMIT 1
  `;

  return tx;
}

export async function misComprasService(idUsuario) {
  return prisma.$queryRaw`
    SELECT t.*, p.titulo
    FROM TRANSACCION t
    JOIN PUBLICACION p ON p.id_publicacion = t.id_publicacion
    WHERE t.id_comprador = ${idUsuario}
    ORDER BY t.creado_en DESC
  `;
}

export async function misVentasService(idUsuario) {
  return prisma.$queryRaw`
    SELECT t.*, p.titulo
    FROM TRANSACCION t
    JOIN PUBLICACION p ON p.id_publicacion = t.id_publicacion
    WHERE t.id_vendedor = ${idUsuario}
    ORDER BY t.creado_en DESC
  `;
}

export async function detalleTransaccionService(idTransaccion) {
  const [row] = await prisma.$queryRaw`
    SELECT
      t.*,
      p.titulo,
      p.descripcion,
      p.valor_creditos
    FROM TRANSACCION t
    JOIN PUBLICACION p ON p.id_publicacion = t.id_publicacion
    WHERE t.id_transaccion = ${idTransaccion}
    LIMIT 1
  `;

  if (!row) {
    const err = new Error("TransacciÃ³n no encontrada");
    err.status = 404;
    throw err;
  }

  return row;
}
</file>

<file path="backend/src/modules/logros/logros.controller.js">
import {
  misLogrosService,
  listarLogrosService,
} from "./logros.service.js";

export const misLogrosController = async (req, res, next) => {
  try {
    const idUsuario = req.user.id_usuario;
    const logros = await misLogrosService(idUsuario);
    res.json(logros);
  } catch (e) {
    next(e);
  }
};

/**
 * Listado completo de logros (solo admin)
 * Soporta filtro opcional:
 *   GET /api/logros?id_tipo_logro=1
 */
export const listarLogrosController = async (req, res, next) => {
  try {
    const idTipo = req.query.id_tipo_logro
      ? Number(req.query.id_tipo_logro)
      : undefined;

    if (idTipo !== undefined && !Number.isFinite(idTipo)) {
      return res.status(400).json({ message: "id_tipo_logro invÃ¡lido" });
    }

    const logros = await listarLogrosService(idTipo);
    res.json({
      message: "Listado de logros",
      filtro: idTipo ? { id_tipo_logro: idTipo } : null,
      data: logros,
    });
  } catch (e) {
    next(e);
  }
};
</file>

<file path="backend/src/modules/logros/logros.routes.js">
import { Router } from "express";
import { authMiddleware } from "../../middlewares/auth.js";
import { isAdmin } from "../../middlewares/isAdmin.js";
import {
  misLogrosController,
  listarLogrosController,
} from "./logros.controller.js";

const router = Router();

// Todas las rutas requieren estar logueado
router.use(authMiddleware);

// Ver mis logros (usuario normal)
router.get("/mios", misLogrosController);

// CatÃ¡logo completo de logros (solo admin, con filtro opcional)
router.get("/", isAdmin, listarLogrosController);

export default router;
</file>

<file path="backend/src/modules/logros/logros.service.js">
import { prisma } from "../../config/prisma.js";

/**
 * Listar catÃ¡logo de logros (opcionalmente filtrado por tipo)
 * @param {number | undefined} idTipoLogro
 */
export const listarLogrosService = (idTipoLogro) => {
  if (idTipoLogro) {
    return prisma.$queryRaw`
      SELECT l.*, tl.nombre AS tipo_logro
      FROM LOGRO l
      JOIN TIPO_LOGRO tl ON tl.id_tipo_logro = l.id_tipo_logro
      WHERE l.id_tipo_logro = ${idTipoLogro}
      ORDER BY l.id_logro
    `;
  }

  // Sin filtro
  return prisma.$queryRaw`
    SELECT l.*, tl.nombre AS tipo_logro
    FROM LOGRO l
    JOIN TIPO_LOGRO tl ON tl.id_tipo_logro = l.id_tipo_logro
    ORDER BY l.id_logro
  `;
};

/**
 * Logros del usuario actual (catÃ¡logo + progreso)
 */
export const misLogrosService = (idUsuario) =>
  prisma.$queryRaw`
    SELECT
      ul.*,
      l.nombre,
      l.descripcion,
      l.meta_requerida,
      l.creditos_recompensa
    FROM USUARIO_LOGRO ul
    JOIN LOGRO l ON l.id_logro = ul.id_logro
    WHERE ul.id_usuario = ${idUsuario}
    ORDER BY l.id_logro
  `;
</file>

<file path="backend/src/modules/premium/premium.controller.js">
// premium.controller.js
import {
  miPlanPremiumService,
  activarPremiumService,
} from "./premium.service.js";

export const miPlanPremiumController = async (req, res, next) => {
  try {
    const idUsuario = req.user.id_usuario;
    const plan = await miPlanPremiumService(idUsuario);
    res.json(plan);
  } catch (e) {
    next(e);
  }
};

export const activarPremiumController = async (req, res, next) => {
  try {
    const idUsuario = req.user.id_usuario;
    const data = await activarPremiumService(idUsuario);
    res
      .status(201)
      .json({ message: "SuscripciÃ³n premium activada correctamente", data });
  } catch (e) {
    next(e);
  }
};
</file>

<file path="backend/src/modules/premium/premium.routes.js">
// premium.routes.js
import { Router } from "express";
import { authMiddleware } from "../../middlewares/auth.js";
import {
  miPlanPremiumController,
  activarPremiumController,
} from "./premium.controller.js";

const router = Router();

// Todas las rutas premium requieren estar autenticado
router.use(authMiddleware);

// Ver mi plan premium actual (la suscripciÃ³n mÃ¡s reciente)
router.get("/mi-plan", miPlanPremiumController);

// Activar premium (30 dÃ­as)
router.post("/activar", activarPremiumController);

export default router;
</file>

<file path="backend/src/modules/premium/premium.service.js">
// premium.service.js
import { prisma } from "../../config/prisma.js";

/**
 * Devuelve la suscripciÃ³n premium mÃ¡s reciente del usuario,
 * o null si no tiene.
 */
export const miPlanPremiumService = async (idUsuario) => {
  const rows = await prisma.$queryRaw`
    SELECT *
    FROM SUSCRIPCION_PREMIUM
    WHERE id_usuario = ${idUsuario}
    ORDER BY fecha_inicio DESC
    LIMIT 1
  `;
  return rows[0] || null;
};

/**
 * Activa una suscripciÃ³n premium de 30 dÃ­as.
 * - Cierra suscripciones ACTIVA previas (las marca como VENCIDA).
 * - Crea una nueva suscripciÃ³n ACTIVA con monto fijo.
 */
export async function activarPremiumService(idUsuario) {
  // 1) Â¿Ya tiene una suscripciÃ³n ACTIVA que aÃºn no venciÃ³?
  const [activa] = await prisma.$queryRaw`
    SELECT *
    FROM SUSCRIPCION_PREMIUM
    WHERE id_usuario = ${idUsuario}
      AND estado = 'ACTIVA'
      AND (fecha_fin IS NULL OR fecha_fin > NOW())
    ORDER BY fecha_inicio DESC
    LIMIT 1
  `;

  if (activa) {
    const err = new Error(
      "Ya tienes una suscripciÃ³n premium activa actualmente"
    );
    err.status = 400;
    throw err;
  }

  // 2) Cerrar cualquier ACTIVA â€œviejaâ€ que quedÃ³ sin fecha_fin coherente
  await prisma.$executeRaw`
    UPDATE SUSCRIPCION_PREMIUM
    SET estado = 'VENCIDA',
        fecha_fin = IFNULL(fecha_fin, NOW())
    WHERE id_usuario = ${idUsuario}
      AND estado = 'ACTIVA'
      AND fecha_inicio <= NOW()
  `;

  // 3) Crear nueva suscripciÃ³n de 30 dÃ­as
  const fin = new Date();
  fin.setDate(fin.getDate() + 30);

  const monto = 20.0; // ðŸ’° aquÃ­ puedes parametrizar el precio si despuÃ©s tienes planes distintos

  await prisma.$executeRaw`
    INSERT INTO SUSCRIPCION_PREMIUM (
      id_usuario,
      fecha_fin,
      estado,
      monto_bs
    )
    VALUES (
      ${idUsuario},
      ${fin},
      'ACTIVA',
      ${monto}
    )
  `;

  // 4) Devolver la suscripciÃ³n reciÃ©n creada
  const [row] = await prisma.$queryRaw`
    SELECT *
    FROM SUSCRIPCION_PREMIUM
    WHERE id_usuario = ${idUsuario}
    ORDER BY fecha_inicio DESC
    LIMIT 1
  `;

  return row;
}
</file>

<file path="backend/src/modules/promociones/promociones.controller.js">
import {
  listarPromocionesService,
  crearPromocionService,
  actualizarEstadoPromocionService,
  vincularPublicacionService,
} from "./promociones.service.js";

export const listarPromocionesController = async (_req, res, next) => {
  try {
    const promos = await listarPromocionesService();
    res.json(promos);
  } catch (e) {
    next(e);
  }
};

export const crearPromocionController = async (req, res, next) => {
  try {
    const promo = await crearPromocionService(req.body);
    res.status(201).json(promo);
  } catch (e) {
    next(e);
  }
};

export const actualizarEstadoPromocionController = async (req, res, next) => {
  try {
    const id = Number(req.params.id);
    if (!Number.isFinite(id)) {
      return res.status(400).json({ message: "ID de promociÃ³n invÃ¡lido" });
    }

    const { estado } = req.body;
    const promo = await actualizarEstadoPromocionService(id, estado);

    res.json({
      message: "Estado de promociÃ³n actualizado",
      data: promo,
    });
  } catch (e) {
    next(e);
  }
};

export const vincularPublicacionController = async (req, res, next) => {
  try {
    const idPromocion = Number(req.params.id);
    if (!Number.isFinite(idPromocion)) {
      return res.status(400).json({ message: "ID de promociÃ³n invÃ¡lido" });
    }

    const { id_publicacion } = req.body;
    await vincularPublicacionService(idPromocion, id_publicacion);

    res.status(201).json({ message: "PublicaciÃ³n vinculada correctamente" });
  } catch (e) {
    next(e);
  }
};
</file>

<file path="backend/src/modules/promociones/promociones.routes.js">
import { Router } from "express";
import { authMiddleware } from "../../middlewares/auth.js";
import { isAdmin } from "../../middlewares/isAdmin.js";
import {
  listarPromocionesController,
  crearPromocionController,
  actualizarEstadoPromocionController,
  vincularPublicacionController,
} from "./promociones.controller.js";

const router = Router();

// Todo el mÃ³dulo de promociones es solo ADMIN
router.use(authMiddleware, isAdmin);

// Listar promociones
router.get("/", listarPromocionesController);

// Crear nueva promociÃ³n
router.post("/", crearPromocionController);

// Cambiar estado de promociÃ³n
router.patch("/:id/estado", actualizarEstadoPromocionController);

// Vincular publicaciÃ³n a promociÃ³n (dispara bono vÃ­a trigger)
router.post("/:id/publicaciones", vincularPublicacionController);

export default router;
</file>

<file path="backend/src/modules/promociones/promociones.service.js">
import { prisma } from "../../config/prisma.js";

/**
 * Listar promociones (panel admin).
 * MÃ¡s adelante podrÃ­as agregar filtros:
 *   - por estado (?estado=ACTIVA)
 *   - por rango de fechas (?desde, ?hasta)
 */
export const listarPromocionesService = () =>
  prisma.$queryRaw`
    SELECT *
    FROM PROMOCION
    ORDER BY fecha_inicio DESC
  `;

// Valores vÃ¡lidos segÃºn ENUM de la BD
const ESTADOS_VALIDOS = [
  "PROGRAMADA",
  "ACTIVA",
  "PAUSADA",
  "FINALIZADA",
  "CANCELADA",
];

export async function crearPromocionService(body) {
  const {
    id_tipo_promocion,
    nombre,
    descripcion,
    creditos_otorgados,
    fecha_inicio,
    fecha_fin,
    estado = "PROGRAMADA", // ðŸ‘‰ mejor default coherente con la BD
  } = body;

  if (
    !id_tipo_promocion ||
    !nombre ||
    !creditos_otorgados ||
    !fecha_inicio ||
    !fecha_fin
  ) {
    const err = new Error("Faltan datos obligatorios de promociÃ³n");
    err.status = 400;
    throw err;
  }

  // Validar estado (si viene)
  if (estado && !ESTADOS_VALIDOS.includes(estado)) {
    const err = new Error("Estado de promociÃ³n invÃ¡lido");
    err.status = 400;
    throw err;
  }

  // Validar fechas mÃ­nimamente
  const ini = new Date(fecha_inicio);
  const fin = new Date(fecha_fin);
  if (!(ini instanceof Date && !isNaN(ini)) || !(fin instanceof Date && !isNaN(fin))) {
    const err = new Error("fecha_inicio o fecha_fin invÃ¡lidas");
    err.status = 400;
    throw err;
  }
  if (fin <= ini) {
    const err = new Error("fecha_fin debe ser mayor a fecha_inicio");
    err.status = 400;
    throw err;
  }

  await prisma.$queryRaw`
    INSERT INTO PROMOCION (
      id_tipo_promocion,
      nombre,
      descripcion,
      creditos_otorgados,
      fecha_inicio,
      fecha_fin,
      estado
    )
    VALUES (
      ${id_tipo_promocion},
      ${nombre},
      ${descripcion || null},
      ${creditos_otorgados},
      ${fecha_inicio},
      ${fecha_fin},
      ${estado}
    )
  `;

  const [row] = await prisma.$queryRaw`
    SELECT *
    FROM PROMOCION
    WHERE id_promocion = LAST_INSERT_ID()
    LIMIT 1
  `;

  return row;
}

export async function actualizarEstadoPromocionService(idPromocion, estado) {
  if (!ESTADOS_VALIDOS.includes(estado)) {
    const err = new Error("Estado de promociÃ³n invÃ¡lido");
    err.status = 400;
    throw err;
  }

  await prisma.$queryRaw`
    UPDATE PROMOCION
    SET estado = ${estado}
    WHERE id_promocion = ${idPromocion}
  `;

  const [row] = await prisma.$queryRaw`
    SELECT *
    FROM PROMOCION
    WHERE id_promocion = ${idPromocion}
    LIMIT 1
  `;

  if (!row) {
    const err = new Error("PromociÃ³n no encontrada");
    err.status = 404;
    throw err;
  }

  return row;
}

export async function vincularPublicacionService(idPromocion, idPublicacion) {
  if (!idPublicacion) {
    const err = new Error("id_publicacion es obligatorio");
    err.status = 400;
    throw err;
  }

  await prisma.$queryRaw`
    INSERT IGNORE INTO PROMOCION_PUBLICACION (id_promocion, id_publicacion)
    VALUES (${idPromocion}, ${idPublicacion})
  `;

  // El trigger trg_promopub_after_ins_bono se encarga del bono de crÃ©ditos
}
</file>

<file path="backend/src/modules/publicaciones/publicaciones.controller.js">
import {
  listarPublicacionesService,
  obtenerPublicacionService,
  crearPublicacionProductoService,
  crearPublicacionServicioService,
  misPublicacionesService,
  buscarPublicacionesService,
  crearCalificacionService,
  listarCalificacionesService,
  actualizarPublicacionService,
  cambiarEstadoPublicacionService,
  eliminarPublicacionService,
} from "./publicaciones.service.js";

export const listarPublicacionesController = async (req, res, next) => {
  try {
    const { categoria, estado, page, pageSize } = req.query;

    const pageNum = page ? Number(page) : undefined;
    const pageSizeNum = pageSize ? Number(pageSize) : undefined;

    const data = await listarPublicacionesService({
      categoria,
      estado,
      page: pageNum,
      pageSize: pageSizeNum,
    });

    res.json(data);
  } catch (e) {
    next(e);
  }
};

export const obtenerPublicacionController = async (req, res, next) => {
  try {
    const id = Number(req.params.id);
    if (!Number.isFinite(id)) {
      return res.status(400).json({ message: "ID de publicaciÃ³n invÃ¡lido" });
    }
    const pub = await obtenerPublicacionService(id);
    res.json(pub);
  } catch (e) {
    next(e);
  }
};

export const crearPublicacionProductoController = async (req, res, next) => {
  try {
    const idUsuario = req.user.id_usuario;
    const pub = await crearPublicacionProductoService(idUsuario, req.body);
    res.status(201).json(pub);
  } catch (e) {
    next(e);
  }
};

export const crearPublicacionServicioController = async (req, res, next) => {
  try {
    const idUsuario = req.user.id_usuario;
    const pub = await crearPublicacionServicioService(idUsuario, req.body);
    res.status(201).json(pub);
  } catch (e) {
    next(e);
  }
};

export const misPublicacionesController = async (req, res, next) => {
  try {
    const idUsuario = req.user.id_usuario;
    const pubs = await misPublicacionesService(idUsuario);
    res.json(pubs);
  } catch (e) {
    next(e);
  }
};

export const buscarPublicacionesController = async (req, res, next) => {
  try {
    const q = req.query.q || "";
    const result = await buscarPublicacionesService(q);
    res.json(result);
  } catch (e) {
    next(e);
  }
};

export const crearCalificacionController = async (req, res, next) => {
  try {
    const idUsuario = req.user.id_usuario;
    const idPublicacion = Number(req.params.id);

    if (!Number.isFinite(idPublicacion)) {
      return res.status(400).json({ message: "ID de publicaciÃ³n invÃ¡lido" });
    }

    const { estrellas, comentario } = req.body;
    const calif = await crearCalificacionService({
      idUsuario,
      idPublicacion,
      estrellas,
      comentario,
    });

    res.status(201).json(calif);
  } catch (e) {
    next(e);
  }
};

export const listarCalificacionesController = async (req, res, next) => {
  try {
    const idPublicacion = Number(req.params.id);
    if (!Number.isFinite(idPublicacion)) {
      return res.status(400).json({ message: "ID de publicaciÃ³n invÃ¡lido" });
    }

    const califs = await listarCalificacionesService(idPublicacion);
    res.json(califs);
  } catch (e) {
    next(e);
  }
};

/* ============================================================
   NUEVO: Editar, cambiar estado y eliminar publicaciÃ³n
   ============================================================ */

/**
 * PUT /api/publicaciones/:id
 * Permite al dueÃ±o (o ADMIN) actualizar datos bÃ¡sicos de la publicaciÃ³n.
 */
export const actualizarPublicacionController = async (req, res, next) => {
  try {
    const idPublicacion = Number(req.params.id);
    if (!Number.isFinite(idPublicacion)) {
      return res.status(400).json({ message: "ID de publicaciÃ³n invÃ¡lido" });
    }

    const idUsuario = req.user.id_usuario;
    const rol = req.user.rol;

    const pub = await actualizarPublicacionService(
      idUsuario,
      rol,
      idPublicacion,
      req.body
    );

    res.json({
      message: "PublicaciÃ³n actualizada correctamente",
      publicacion: pub,
    });
  } catch (e) {
    next(e);
  }
};

/**
 * PATCH /api/publicaciones/:id/estado
 * Cambia el estado de la publicaciÃ³n (BORRADOR, PUBLICADA, PAUSADA, AGOTADA, OCULTA, ELIMINADA)
 */
export const cambiarEstadoPublicacionController = async (req, res, next) => {
  try {
    const idPublicacion = Number(req.params.id);
    if (!Number.isFinite(idPublicacion)) {
      return res.status(400).json({ message: "ID de publicaciÃ³n invÃ¡lido" });
    }

    const { estado } = req.body;
    const idUsuario = req.user.id_usuario;
    const rol = req.user.rol;

    const pub = await cambiarEstadoPublicacionService(
      idUsuario,
      rol,
      idPublicacion,
      estado
    );

    res.json({
      message: "Estado de publicaciÃ³n actualizado",
      publicacion: pub,
    });
  } catch (e) {
    next(e);
  }
};

/**
 * DELETE /api/publicaciones/:id
 * EliminaciÃ³n lÃ³gica â†’ se marca estado = 'ELIMINADA'
 */
export const eliminarPublicacionController = async (req, res, next) => {
  try {
    const idPublicacion = Number(req.params.id);
    if (!Number.isFinite(idPublicacion)) {
      return res.status(400).json({ message: "ID de publicaciÃ³n invÃ¡lido" });
    }

    const idUsuario = req.user.id_usuario;
    const rol = req.user.rol;

    const pub = await eliminarPublicacionService(idUsuario, rol, idPublicacion);

    res.json({
      message: "PublicaciÃ³n eliminada (estado = ELIMINADA)",
      publicacion: pub,
    });
  } catch (e) {
    next(e);
  }
};
</file>

<file path="backend/src/modules/publicaciones/publicaciones.routes.js">
import { Router } from "express";
import { authMiddleware } from "../../middlewares/auth.js";
import {
  listarPublicacionesController,
  obtenerPublicacionController,
  crearPublicacionProductoController,
  crearPublicacionServicioController,
  misPublicacionesController,
  buscarPublicacionesController,
  crearCalificacionController,
  listarCalificacionesController,
  actualizarPublicacionController,
  cambiarEstadoPublicacionController,
  eliminarPublicacionController,
} from "./publicaciones.controller.js";

const router = Router();

/* ====== RUTAS PÃšBLICAS ====== */
// PaginaciÃ³n opcional: ?page=1&pageSize=12
router.get("/", listarPublicacionesController);
router.get("/busqueda", buscarPublicacionesController);

// OJO: la mÃ¡s especÃ­fica primero
router.get("/:id/calificaciones", listarCalificacionesController);
router.get("/:id", obtenerPublicacionController);

/* ====== RUTAS PROTEGIDAS (requieren login) ====== */
router.use(authMiddleware);

// Mis publicaciones
router.get("/mias/listado", misPublicacionesController);

// Crear publicaciones
router.post("/producto", crearPublicacionProductoController);
router.post("/servicio", crearPublicacionServicioController);

// Calificar publicaciÃ³n
router.post("/:id/calificaciones", crearCalificacionController);

// NUEVOS: editar / estado / eliminar
router.put("/:id", actualizarPublicacionController);
router.patch("/:id/estado", cambiarEstadoPublicacionController);
router.delete("/:id", eliminarPublicacionController);

export default router;
</file>

<file path="backend/src/modules/publicaciones/publicaciones.service.js">
import { prisma } from "../../config/prisma.js";

const ESTADOS_PUBLICACION = [
  "BORRADOR",
  "PUBLICADA",
  "PAUSADA",
  "AGOTADA",
  "OCULTA",
  "ELIMINADA",
];

/* ============================================================
   LISTADO + PAGINACIÃ“N
   ============================================================ */

// Si NO mandas page/pageSize â†’ devuelve array simple (compatibilidad)
// Si mandas page â†’ devuelve { items, total, page, pageSize }
export async function listarPublicacionesService({
  categoria,
  estado,
  page,
  pageSize,
}) {
  let where = "WHERE 1=1";
  const params = [];

  if (categoria) {
    const catNum = Number(categoria);
    if (Number.isFinite(catNum)) {
      where += " AND p.id_categoria = ?";
      params.push(catNum);
    }
  }

  if (estado) {
    where += " AND p.estado = ?";
    params.push(estado);
  }

  const baseFrom = `
    FROM PUBLICACION p
    JOIN CATEGORIA c ON c.id_categoria = p.id_categoria
    JOIN USUARIO u   ON u.id_usuario   = p.id_usuario
    ${where}
  `;

  // Sin paginaciÃ³n â†’ comportamiento anterior
  if (!page) {
    const sql = `
      SELECT
        p.id_publicacion,
        p.titulo,
        p.descripcion,
        p.valor_creditos,
        p.estado,
        p.imagen_url,
        c.nombre AS categoria,
        u.nombre AS usuario
      ${baseFrom}
      ORDER BY p.creado_en DESC
    `;
    return prisma.$queryRawUnsafe(sql, ...params);
  }

  // Con paginaciÃ³n
  const currentPage = Math.max(Number(page) || 1, 1);
  const size = Math.max(Number(pageSize) || 10, 1);
  const offset = (currentPage - 1) * size;

  // total
  const [countRow] = await prisma.$queryRawUnsafe(
    `SELECT COUNT(*) AS total ${baseFrom}`,
    ...params
  );
  const total = Number(countRow?.total || 0);

  // items
  const paramsWithLimit = [...params, offset, size];
  const itemsSql = `
    SELECT
      p.id_publicacion,
      p.titulo,
      p.descripcion,
      p.valor_creditos,
      p.estado,
      p.imagen_url,
      c.nombre AS categoria,
      u.nombre AS usuario
    ${baseFrom}
    ORDER BY p.creado_en DESC
    LIMIT ?, ?
  `;
  const items = await prisma.$queryRawUnsafe(itemsSql, ...paramsWithLimit);

  return {
    items,
    total,
    page: currentPage,
    pageSize: size,
    totalPages: Math.ceil(total / size),
  };
}

/* ============================================================
   BÃSICOS
   ============================================================ */

export async function obtenerPublicacionService(idPublicacion) {
  const [row] = await prisma.$queryRaw`
    SELECT
      p.*,
      c.nombre AS categoria,
      u.nombre AS usuario
    FROM PUBLICACION p
    JOIN CATEGORIA c ON c.id_categoria = p.id_categoria
    JOIN USUARIO u   ON u.id_usuario   = p.id_usuario
    WHERE p.id_publicacion = ${idPublicacion}
    LIMIT 1
  `;
  if (!row) {
    const err = new Error("PublicaciÃ³n no encontrada");
    err.status = 404;
    throw err;
  }
  return row;
}

export async function misPublicacionesService(idUsuario) {
  return prisma.$queryRaw`
    SELECT *
    FROM PUBLICACION
    WHERE id_usuario = ${idUsuario}
    ORDER BY creado_en DESC
  `;
}

/* ============================================================
   CREAR PRODUCTO / SERVICIO
   ============================================================ */

// Crear PRODUCTO + PUBLICACION + PUBLICACION_PRODUCTO
export async function crearPublicacionProductoService(idUsuario, body) {
  const {
    titulo,
    descripcion,
    id_categoria,
    valor_creditos,
    imagen_url,
    producto, // { nombre, descripcion, precio, peso }
    cantidad,
    id_um,
  } = body;

  if (
    !titulo ||
    !descripcion ||
    !id_categoria ||
    !valor_creditos ||
    !producto ||
    !cantidad ||
    !id_um
  ) {
    const err = new Error("Faltan datos obligatorios");
    err.status = 400;
    throw err;
  }

  return prisma.$transaction(async (tx) => {
    // 1) Producto
    await tx.$queryRaw`
      INSERT INTO PRODUCTO (id_categoria, nombre, descripcion, precio, peso)
      VALUES (
        ${id_categoria},
        ${producto.nombre},
        ${producto.descripcion || null},
        ${producto.precio || null},
        ${producto.peso || null}
      )
    `;

    const [newProd] = await tx.$queryRaw`
      SELECT *
      FROM PRODUCTO
      WHERE id_producto = LAST_INSERT_ID()
      LIMIT 1
    `;

    // 2) Tipo de publicaciÃ³n PRODUCTO
    const tipoProducto = await tx.$queryRaw`
      SELECT id_tipo_publicacion
      FROM TIPO_PUBLICACION
      WHERE nombre = 'PRODUCTO'
      LIMIT 1
    `;
    if (!tipoProducto.length) {
      const err = new Error("No existe TIPO_PUBLICACION PRODUCTO");
      err.status = 500;
      throw err;
    }

    // 3) PublicaciÃ³n
    await tx.$queryRaw`
      INSERT INTO PUBLICACION (
        id_usuario,
        id_categoria,
        id_tipo_publicacion,
        titulo,
        descripcion,
        valor_creditos,
        imagen_url
      )
      VALUES (
        ${idUsuario},
        ${id_categoria},
        ${tipoProducto[0].id_tipo_publicacion},
        ${titulo},
        ${descripcion},
        ${valor_creditos},
        ${imagen_url || null}
      )
    `;

    const [pub] = await tx.$queryRaw`
      SELECT *
      FROM PUBLICACION
      WHERE id_publicacion = LAST_INSERT_ID()
      LIMIT 1
    `;

    // 4) RelaciÃ³n PUBLICACION_PRODUCTO
    await tx.$queryRaw`
      INSERT INTO PUBLICACION_PRODUCTO (id_publicacion, id_producto, cantidad, id_um)
      VALUES (
        ${pub.id_publicacion},
        ${newProd.id_producto},
        ${cantidad},
        ${id_um}
      )
    `;

    return pub;
  });
}

// Crear SERVICIO + PUBLICACION + PUBLICACION_SERVICIO
export async function crearPublicacionServicioService(idUsuario, body) {
  const {
    titulo,
    descripcion,
    id_categoria,
    valor_creditos,
    imagen_url,
    servicio, // { nombre, descripcion, precio, duracion_min }
    horario,
  } = body;

  if (!titulo || !descripcion || !id_categoria || !valor_creditos || !servicio || !horario) {
    const err = new Error("Faltan datos obligatorios");
    err.status = 400;
    throw err;
  }

  return prisma.$transaction(async (tx) => {
    // 1) Servicio
    await tx.$queryRaw`
      INSERT INTO SERVICIO (id_categoria, estado, nombre, descripcion, precio, duracion_min)
      VALUES (
        ${id_categoria},
        'ACTIVO',
        ${servicio.nombre},
        ${servicio.descripcion || null},
        ${servicio.precio || null},
        ${servicio.duracion_min || null}
      )
    `;

    const [serv] = await tx.$queryRaw`
      SELECT *
      FROM SERVICIO
      WHERE id_servicio = LAST_INSERT_ID()
      LIMIT 1
    `;

    // 2) Tipo de publicaciÃ³n SERVICIO
    const tipoServicio = await tx.$queryRaw`
      SELECT id_tipo_publicacion
      FROM TIPO_PUBLICACION
      WHERE nombre = 'SERVICIO'
      LIMIT 1
    `;
    if (!tipoServicio.length) {
      const err = new Error("No existe TIPO_PUBLICACION SERVICIO");
      err.status = 500;
      throw err;
    }

    // 3) PublicaciÃ³n
    await tx.$queryRaw`
      INSERT INTO PUBLICACION (
        id_usuario,
        id_categoria,
        id_tipo_publicacion,
        titulo,
        descripcion,
        valor_creditos,
        imagen_url
      )
      VALUES (
        ${idUsuario},
        ${id_categoria},
        ${tipoServicio[0].id_tipo_publicacion},
        ${titulo},
        ${descripcion},
        ${valor_creditos},
        ${imagen_url || null}
      )
    `;

    const [pub] = await tx.$queryRaw`
      SELECT *
      FROM PUBLICACION
      WHERE id_publicacion = LAST_INSERT_ID()
      LIMIT 1
    `;

    // 4) RelaciÃ³n PUBLICACION_SERVICIO
    await tx.$queryRaw`
      INSERT INTO PUBLICACION_SERVICIO (id_publicacion, id_servicio, horario)
      VALUES (
        ${pub.id_publicacion},
        ${serv.id_servicio},
        ${horario}
      )
    `;

    return pub;
  });
}

/* ============================================================
   BÃšSQUEDA FULLTEXT
   ============================================================ */

export async function buscarPublicacionesService(q) {
  if (!q.trim()) return [];

  return prisma.$queryRawUnsafe(
    `
      SELECT
        id_publicacion,
        titulo,
        descripcion,
        valor_creditos,
        imagen_url
      FROM PUBLICACION
      WHERE MATCH(titulo, descripcion) AGAINST (? IN NATURAL LANGUAGE MODE)
        AND estado = 'PUBLICADA'
      ORDER BY creado_en DESC
    `,
    q
  );
}

/* ============================================================
   CALIFICACIONES
   ============================================================ */

export async function crearCalificacionService({
  idUsuario,
  idPublicacion,
  estrellas,
  comentario,
}) {
  if (!estrellas) {
    const err = new Error("estrellas es obligatorio");
    err.status = 400;
    throw err;
  }

  await prisma.$queryRaw`
    INSERT INTO CALIFICACION (id_usuario, id_publicacion, estrellas, comentario)
    VALUES (${idUsuario}, ${idPublicacion}, ${estrellas}, ${comentario || null})
    ON DUPLICATE KEY UPDATE
      estrellas  = VALUES(estrellas),
      comentario = VALUES(comentario)
  `;

  const [row] = await prisma.$queryRaw`
    SELECT *
    FROM CALIFICACION
    WHERE id_usuario = ${idUsuario}
      AND id_publicacion = ${idPublicacion}
    LIMIT 1
  `;
  return row;
}

export async function listarCalificacionesService(idPublicacion) {
  return prisma.$queryRaw`
    SELECT c.*, u.nombre
    FROM CALIFICACION c
    JOIN USUARIO u ON u.id_usuario = c.id_usuario
    WHERE c.id_publicacion = ${idPublicacion}
    ORDER BY c.id_calificacion DESC
  `;
}

/* ============================================================
   NUEVO: EDITAR / ESTADO / ELIMINAR
   ============================================================ */

// Helper: verificar que el usuario sea dueÃ±o o ADMIN
async function assertPuedeEditar(idUsuario, rol, idPublicacion) {
  const [row] = await prisma.$queryRaw`
    SELECT id_usuario
    FROM PUBLICACION
    WHERE id_publicacion = ${idPublicacion}
    LIMIT 1
  `;
  if (!row) {
    const err = new Error("PublicaciÃ³n no encontrada");
    err.status = 404;
    throw err;
  }

  const esAdmin = rol === "ADMIN";
  if (!esAdmin && row.id_usuario !== idUsuario) {
    const err = new Error("No tienes permiso para modificar esta publicaciÃ³n");
    err.status = 403;
    throw err;
  }
}

export async function actualizarPublicacionService(
  idUsuario,
  rol,
  idPublicacion,
  datos
) {
  await assertPuedeEditar(idUsuario, rol, idPublicacion);

  const {
    titulo,
    descripcion,
    id_categoria,
    valor_creditos,
    imagen_url,
  } = datos;

  // No obligo a mandar todo, actualizo solo lo que viene definido
  await prisma.$queryRaw`
    UPDATE PUBLICACION
    SET
      titulo        = COALESCE(${titulo}, titulo),
      descripcion   = COALESCE(${descripcion}, descripcion),
      id_categoria  = COALESCE(${id_categoria}, id_categoria),
      valor_creditos= COALESCE(${valor_creditos}, valor_creditos),
      imagen_url    = COALESCE(${imagen_url}, imagen_url)
    WHERE id_publicacion = ${idPublicacion}
  `;

  return obtenerPublicacionService(idPublicacion);
}

export async function cambiarEstadoPublicacionService(
  idUsuario,
  rol,
  idPublicacion,
  estado
) {
  if (!estado || !ESTADOS_PUBLICACION.includes(estado)) {
    const err = new Error(
      `Estado invÃ¡lido. Permitidos: ${ESTADOS_PUBLICACION.join(", ")}`
    );
    err.status = 400;
    throw err;
  }

  await assertPuedeEditar(idUsuario, rol, idPublicacion);

  await prisma.$queryRaw`
    UPDATE PUBLICACION
    SET estado = ${estado}
    WHERE id_publicacion = ${idPublicacion}
  `;

  return obtenerPublicacionService(idPublicacion);
}

export async function eliminarPublicacionService(
  idUsuario,
  rol,
  idPublicacion
) {
  // EliminaciÃ³n lÃ³gica â‰ˆ estado = 'ELIMINADA'
  return cambiarEstadoPublicacionService(
    idUsuario,
    rol,
    idPublicacion,
    "ELIMINADA"
  );
}
</file>

<file path="backend/src/modules/publicidad/publicidad.controller.js">
// src/modules/publicidad/publicidad.controller.js
import {
  crearPublicidadService,
  listarPublicidadActivaService,
  listarPublicidadAdminService,
  cambiarEstadoPublicidadService,
  eliminarPublicidadService,
} from "./publicidad.service.js";

import { buscarPublicacionesService } from "../publicaciones/publicaciones.service.js";

function toPlain(value) {
  if (typeof value === "bigint") return Number(value);
  if (value instanceof Date)
    return value.toISOString().slice(0, 19).replace("T", " ");

  if (value && typeof value === "object") {
    if (typeof value.toNumber === "function") return value.toNumber();
    if (Array.isArray(value)) return value.map(toPlain);

    const out = {};
    for (const [k, v] of Object.entries(value)) out[k] = toPlain(v);
    return out;
  }
  return value;
}

/* =====================================================
   PUBLICAS
===================================================== */
export const listarPublicidadActivaController = async (req, res, next) => {
  try {
    const data = await listarPublicidadActivaService();
    res.json(toPlain(data));
  } catch (err) {
    next(err);
  }
};

/* =====================================================
   ADMIN
===================================================== */
export const crearPublicidadController = async (req, res, next) => {
  try {
    const idUsuario = req.user.id_usuario;
    const data = await crearPublicidadService(idUsuario, req.body);
    res.status(201).json(toPlain(data));
  } catch (err) {
    next(err);
  }
};

export const listarPublicidadAdminController = async (req, res, next) => {
  try {
    const data = await listarPublicidadAdminService();
    res.json(toPlain(data));
  } catch (err) {
    next(err);
  }
};

export const buscarPublicacionesParaPublicidadController = async (
  req,
  res,
  next
) => {
  try {
    const q = req.query.q || "";
    const data = await buscarPublicacionesService(q);
    res.json(toPlain(data));
  } catch (err) {
    next(err);
  }
};

/* =====================================================
   NUEVO: CAMBIAR ESTADO
===================================================== */
export const cambiarEstadoPublicidadController = async (req, res, next) => {
  try {
    const idPublicidad = Number(req.params.id);
    const { estado } = req.body;

    const data = await cambiarEstadoPublicidadService(idPublicidad, estado);
    res.json({
      message: "Estado actualizado correctamente",
      publicidad: toPlain(data),
    });
  } catch (err) {
    next(err);
  }
};

/* =====================================================
   NUEVO: ELIMINAR (LOGICO)
===================================================== */
export const eliminarPublicidadController = async (req, res, next) => {
  try {
    const idPublicidad = Number(req.params.id);
    const data = await eliminarPublicidadService(idPublicidad);

    res.json({
      message: "Publicidad eliminada (estado = 'ELIMINADA')",
      publicidad: toPlain(data),
    });
  } catch (err) {
    next(err);
  }
};
</file>

<file path="backend/src/modules/publicidad/publicidad.routes.js">
// src/modules/publicidad/publicidad.routes.js
import { Router } from "express";
import { authMiddleware } from "../../middlewares/auth.js";
import { isAdmin } from "../../middlewares/isAdmin.js";

import {
  listarPublicidadActivaController,
  crearPublicidadController,
  listarPublicidadAdminController,
  buscarPublicacionesParaPublicidadController,
  cambiarEstadoPublicidadController,
  eliminarPublicidadController,
} from "./publicidad.controller.js";

const router = Router();

/* ===========================
   PUBLICA
=========================== */
router.get("/activa", listarPublicidadActivaController);

/* ===========================
   SOLO ADMIN
=========================== */
router.use(authMiddleware, isAdmin);

router.get("/admin", listarPublicidadAdminController);

router.get("/buscar-publicaciones", buscarPublicacionesParaPublicidadController);

router.post("/", crearPublicidadController);

router.patch("/:id/estado", cambiarEstadoPublicidadController);

router.delete("/:id", eliminarPublicidadController);

export default router;
</file>

<file path="backend/src/modules/publicidad/publicidad.service.js">
// src/modules/publicidad/publicidad.service.js
import { prisma } from "../../config/prisma.js";

const ESTADOS = ["PROGRAMADA", "ACTIVA", "PAUSADA", "FINALIZADA", "CANCELADA", "ELIMINADA"];

export const listarPublicidadActivaService = () =>
  prisma.$queryRaw`
    SELECT p.*, u.nombre AS usuario
    FROM PUBLICIDAD p
    JOIN USUARIO u ON u.id_usuario = p.id_usuario
    WHERE p.estado = 'ACTIVA'
      AND NOW() BETWEEN p.fecha_inicio AND p.fecha_fin
    ORDER BY p.fecha_inicio DESC, p.id_publicidad DESC
  `;

export const listarPublicidadAdminService = () =>
  prisma.$queryRaw`
    SELECT p.*, u.nombre AS usuario
    FROM PUBLICIDAD p
    JOIN USUARIO u ON u.id_usuario = p.id_usuario
    ORDER BY p.fecha_inicio DESC, p.id_publicidad DESC
  `;

export const crearPublicidadService = async (idUsuario, body) => {
  const {
    id_ubicacion,
    titulo,
    descripcion,
    url_destino,
    fecha_inicio,
    fecha_fin,
    costo_creditos,
  } = body;

  if (!id_ubicacion || !titulo || !fecha_inicio || !fecha_fin || !costo_creditos) {
    const err = new Error("Faltan datos obligatorios de publicidad");
    err.status = 400;
    throw err;
  }

  await prisma.$queryRaw`
    INSERT INTO PUBLICIDAD (
      id_usuario, id_ubicacion, estado,
      titulo, descripcion, url_destino,
      fecha_inicio, fecha_fin, costo_creditos
    )
    VALUES (
      ${idUsuario}, ${id_ubicacion}, 'PROGRAMADA',
      ${titulo}, ${descripcion || null}, ${url_destino || null},
      ${fecha_inicio}, ${fecha_fin}, ${costo_creditos}
    )
  `;

  const [row] = await prisma.$queryRaw`
    SELECT *
    FROM PUBLICIDAD
    WHERE id_publicidad = LAST_INSERT_ID()
    LIMIT 1
  `;
  return row;
};

/* =====================================================
   NUEVO: CAMBIAR ESTADO
===================================================== */
export const cambiarEstadoPublicidadService = async (idPublicidad, estado) => {
  if (!ESTADOS.includes(estado)) {
    const err = new Error(`Estado invÃ¡lido. Permitidos: ${ESTADOS.join(", ")}`);
    err.status = 400;
    throw err;
  }

  await prisma.$queryRaw`
    UPDATE PUBLICIDAD
    SET estado = ${estado}
    WHERE id_publicidad = ${idPublicidad}
  `;

  const [row] = await prisma.$queryRaw`
    SELECT *
    FROM PUBLICIDAD
    WHERE id_publicidad = ${idPublicidad}
    LIMIT 1
  `;

  return row;
};

/* =====================================================
   NUEVO: ELIMINAR (LOGICO)
===================================================== */
export const eliminarPublicidadService = async (idPublicidad) => {
  return cambiarEstadoPublicidadService(idPublicidad, "ELIMINADA");
};
</file>

<file path="backend/src/modules/reportes/reportes.controller.js">
// src/modules/reportes/reportes.controller.js
import { prisma } from "../../config/prisma.js";

function toPlain(value) {
  if (typeof value === "bigint") return Number(value);

  if (value instanceof Date) {
    return value.toISOString().slice(0, 19).replace("T", " ");
  }

  if (value && typeof value === "object") {
    if (typeof value.toNumber === "function") return value.toNumber();

    const prim = value.valueOf?.();
    if (prim != null && typeof prim !== "object") return prim;

    if (Array.isArray(value)) return value.map(toPlain);

    const out = {};
    for (const [k, v] of Object.entries(value)) out[k] = toPlain(v);
    return out;
  }

  return value;
}

function normalizeResult(raw) {
  if (!raw) return [];

  if (Array.isArray(raw)) {
    if (raw.length > 0 && Array.isArray(raw[0])) return raw[0];
    return raw;
  }

  if (typeof raw === "object") return [raw];

  return [];
}

function getRangoFechas(req) {
  const { desde, hasta } = req.query;

  const ahora = new Date();
  const defaultHasta = ahora.toISOString().slice(0, 19).replace("T", " ");
  const defaultDesdeDate = new Date(
    ahora.getTime() - 30 * 24 * 60 * 60 * 1000
  );
  const defaultDesde = defaultDesdeDate
    .toISOString()
    .slice(0, 19)
    .replace("T", " ");

  return {
    desde: desde ? `${desde} 00:00:00` : defaultDesde,
    hasta: hasta ? `${hasta} 23:59:59` : defaultHasta,
  };
}

// mapeos...

function mapUsuarioActivo(r) {
  return {
    id_usuario: r.id_usuario ?? r.f0 ?? null,
    nombre: r.nombre ?? r.f1 ?? null,
    correo: r.correo ?? r.f2 ?? null,
    primera_actividad: r.primera_actividad ?? r.f3 ?? null,
    ultima_actividad: r.ultima_actividad ?? r.f4 ?? null,
    total_acciones: r.total_acciones ?? r.f5 ?? null,
  };
}

function mapUsuarioAbandonado(r) {
  return {
    id_usuario: r.id_usuario ?? r.f0 ?? null,
    nombre: r.nombre ?? r.f1 ?? null,
    correo: r.correo ?? r.f2 ?? null,
    estado: r.estado ?? r.f3 ?? null,
  };
}

function mapIngresoCreditos(r) {
  return {
    fecha: r.fecha ?? r.f0 ?? null,
    total_creditos: r.total_creditos ?? r.f1 ?? null,
    total_bs: r.total_bs ?? r.f2 ?? null,
  };
}

function mapIntercambiosCategoria(r) {
  return {
    categoria: r.categoria ?? r.f0 ?? null,
    total_intercambios: r.total_intercambios ?? r.f1 ?? null,
  };
}

function mapPublicacionesVsIntercambios(r) {
  return {
    categoria: r.categoria ?? r.f0 ?? null,
    publicaciones: r.publicaciones ?? r.f1 ?? null,
    intercambios: r.intercambios ?? r.f2 ?? null,
    ratio_intercambio: r.ratio_intercambio ?? r.f3 ?? null,
  };
}

function mapImpacto(r) {
  return {
    // si algÃºn dÃ­a el SP devuelve id_usuario con nombre, lo usas;
    // si no, cae al f0 o null
    id_usuario: r.id_usuario ?? r.f0 ?? null,

    // COâ‚‚, agua y energÃ­a
    total_co2_ahorrado: Number(
      r.total_co2_ahorrado ?? r.f4 ?? 0
    ),
    total_agua_ahorrada: Number(
      r.total_agua_ahorrada ?? r.f5 ?? 0
    ),
    total_energia_ahorrada: Number(
      r.total_energia_ahorrada ?? r.f6 ?? 0
    ),

    // transacciones y usuarios activos
    total_transacciones: Number(
      r.total_transacciones ?? r.f2 ?? 0
    ),
    total_usuarios_activos: Number(
      r.total_usuarios_activos ?? r.f3 ?? 0
    ),
  };
}

function mapRankingUsuarios(r) {
  return {
    id_usuario: r.id_usuario ?? r.f0 ?? null,
    co2_total: r.co2_total ?? r.f1 ?? null,
    agua_total: r.agua_total ?? r.f2 ?? null,
    energia_total: r.energia_total ?? r.f3 ?? null,
    transacciones: r.transacciones ?? r.f4 ?? null,
  };
}

function mapUsuariosPremium(r) {
  return {
    desde: r.desde ?? r.f0 ?? null,
    hasta: r.hasta ?? r.f1 ?? null,
    total_usuarios_activos: r.total_usuarios_activos ?? r.f2 ?? null,
    usuarios_nuevos_premium: r.usuarios_nuevos_premium ?? r.f3 ?? null,
    usuarios_premium_activos: r.usuarios_premium_activos ?? r.f4 ?? null,
    ingresos_suscripcion_bs: r.ingresos_suscripcion_bs ?? r.f5 ?? null,
    porcentaje_adopcion_premium:
      r.porcentaje_adopcion_premium ?? r.f6 ?? null,
  };
}

function mapUsuariosNuevos(r) {
  return {
    id_usuario: r.id_usuario ?? r.f0 ?? null,
    nombre: r.nombre ?? r.f1 ?? null,
    correo: r.correo ?? r.f2 ?? null,
    fecha_primer_login: r.fecha_primer_login ?? r.f3 ?? null,
  };
}

function mapSaldoUsuario(r) {
  return {
    id_usuario: r.id_usuario ?? r.f0 ?? null,
    nombre: r.nombre ?? r.f1 ?? null,
    correo: r.correo ?? r.f2 ?? null,
    saldo_creditos: r.saldo_creditos ?? r.f3 ?? null,
  };
}

function mapActividadSostenible(r) {
  return {
    id_usuario: r.id_usuario ?? r.f0 ?? null,
    nombre: r.nombre ?? r.f1 ?? null,
    correo: r.correo ?? r.f2 ?? null,
    total_actividades: r.total_actividades ?? r.f3 ?? null,
    creditos_otorgados: r.creditos_otorgados ?? r.f4 ?? null,
  };
}

function mapImpactoCategoria(r) {
  return {
    categoria: r.categoria ?? r.f0 ?? null,
    co2_total: r.co2_total ?? r.f1 ?? null,
    agua_total: r.agua_total ?? r.f2 ?? null,
    energia_total: r.energia_total ?? r.f3 ?? null,
  };
}

// C1) Usuarios activos
export async function getUsuariosActivos(req, res, next) {
  try {
    const { desde, hasta } = getRangoFechas(req);
    const raw = await prisma.$queryRawUnsafe(
      "CALL sp_rep_usuarios_activos(?, ?)",
      desde,
      hasta
    );
    const rows = normalizeResult(raw).map(mapUsuarioActivo);
    res.json(toPlain(rows));
  } catch (err) {
    next(err);
  }
}

// C2) Usuarios abandonados
export async function getUsuariosAbandonados(req, res, next) {
  try {
    const { desde, hasta } = getRangoFechas(req);
    const raw = await prisma.$queryRawUnsafe(
      "CALL sp_rep_usuarios_abandonados(?, ?)",
      desde,
      hasta
    );
    const rows = normalizeResult(raw).map(mapUsuarioAbandonado);
    res.json(toPlain(rows));
  } catch (err) {
    next(err);
  }
}

// C3) Ingresos crÃ©ditos
export async function getIngresosCreditos(req, res, next) {
  try {
    const { desde, hasta } = getRangoFechas(req);
    const raw = await prisma.$queryRawUnsafe(
      "CALL sp_rep_ingresos_creditos(?, ?)",
      desde,
      hasta
    );
    const rows = normalizeResult(raw).map(mapIngresoCreditos);
    res.json(toPlain(rows));
  } catch (err) {
    next(err);
  }
}

// C4) CrÃ©ditos generados vs consumidos
export async function getCreditosGeneradosVsConsumidos(req, res, next) {
  try {
    const { desde, hasta } = getRangoFechas(req);
    const raw = await prisma.$queryRawUnsafe(
      "CALL sp_rep_creditos_generados_vs_consumidos(?, ?)",
      desde,
      hasta
    );

    const rows = normalizeResult(raw);
    const base = rows[0] || {};

    const creditos_generados = base.creditos_generados ?? base.f0 ?? 0;
    const creditos_consumidos = base.creditos_consumidos ?? base.f1 ?? 0;

    const resumen = {
      creditos_generados: Number(creditos_generados ?? 0),
      creditos_consumidos: Number(creditos_consumidos ?? 0),
      saldo_neto:
        Number(creditos_generados ?? 0) - Number(creditos_consumidos ?? 0),
    };

    res.json(toPlain(resumen));
  } catch (err) {
    next(err);
  }
}

// C5) Intercambios por categorÃ­a
export async function getIntercambiosPorCategoria(req, res, next) {
  try {
    const { desde, hasta } = getRangoFechas(req);
    const raw = await prisma.$queryRawUnsafe(
      "CALL sp_rep_intercambios_por_categoria(?, ?)",
      desde,
      hasta
    );
    const rows = normalizeResult(raw).map(mapIntercambiosCategoria);
    res.json(toPlain(rows));
  } catch (err) {
    next(err);
  }
}

// C6) Publicaciones vs intercambios
export async function getPublicacionesVsIntercambios(req, res, next) {
  try {
    const { desde, hasta } = getRangoFechas(req);
    const raw = await prisma.$queryRawUnsafe(
      "CALL sp_rep_publicaciones_vs_intercambios(?, ?)",
      desde,
      hasta
    );
    const rows = normalizeResult(raw).map(mapPublicacionesVsIntercambios);
    res.json(toPlain(rows));
  } catch (err) {
    next(err);
  }
}

// C7) Impacto ambiental acumulado (usa sp_generar_reporte_impacto)
// C7) Impacto ambiental acumulado (TOTAL HISTÃ“RICO)
export async function getImpactoAcumulado(req, res, next) {
  try {
    let { idTipoReporte } = req.query;

    if (!idTipoReporte) {
      return res.status(400).json({
        ok: false,
        message: "idTipoReporte es requerido",
      });
    }

    idTipoReporte = Number(idTipoReporte);

    // TOTAL HISTÃ“RICO: suma TODOS los perÃ­odos de ese tipo de reporte
    const raw = await prisma.$queryRawUnsafe(
      `
      SELECT
        NULL AS id_usuario,
        SUM(total_co2_ahorrado)     AS total_co2_ahorrado,
        SUM(total_agua_ahorrada)    AS total_agua_ahorrada,
        SUM(total_energia_ahorrada) AS total_energia_ahorrada,
        SUM(total_transacciones)    AS total_transacciones,
        SUM(total_usuarios_activos) AS total_usuarios_activos
      FROM REPORTE_IMPACTO
      WHERE id_tipo_reporte = ?
      `,
      idTipoReporte
    );

    const rows = normalizeResult(raw).map((r) => ({
      id_usuario: null,
      total_co2_ahorrado: Number(r.total_co2_ahorrado ?? 0),
      total_agua_ahorrada: Number(r.total_agua_ahorrada ?? 0),
      total_energia_ahorrada: Number(r.total_energia_ahorrada ?? 0),
      total_transacciones: Number(r.total_transacciones ?? 0),
      total_usuarios_activos: Number(r.total_usuarios_activos ?? 0),
    }));

    res.json(toPlain(rows));
  } catch (err) {
    next(err);
  }
}


// C8) Ranking usuarios
export async function getRankingUsuarios(req, res, next) {
  try {
    let { idPeriodo, limit } = req.query;
    const pPeriodo = idPeriodo ? Number(idPeriodo) : null;
    const pLimit = limit ? Number(limit) : 10;

    const raw = await prisma.$queryRawUnsafe(
      "CALL sp_obtener_ranking_usuarios(?, ?)",
      pPeriodo,
      pLimit
    );

    const rows = normalizeResult(raw).map(mapRankingUsuarios);
    res.json(toPlain(rows));
  } catch (err) {
    next(err);
  }
}

// C9) Usuarios premium
export async function getUsuariosPremium(req, res, next) {
  try {
    const { desde, hasta } = getRangoFechas(req);
    const raw = await prisma.$queryRawUnsafe(
      "CALL sp_rep_usuarios_premium(?, ?)",
      desde,
      hasta
    );
    const rows = normalizeResult(raw).map(mapUsuariosPremium);
    res.json(toPlain(rows));
  } catch (err) {
    next(err);
  }
}

// C10) Usuarios nuevos
export async function getUsuariosNuevos(req, res, next) {
  try {
    const { desde, hasta } = getRangoFechas(req);
    const raw = await prisma.$queryRawUnsafe(
      `
      SELECT
        u.id_usuario,
        u.nombre,
        u.correo,
        MIN(b.fecha) AS fecha_primer_login
      FROM USUARIO u
      JOIN BITACORA_ACCESO b
        ON b.id_usuario = u.id_usuario
      GROUP BY u.id_usuario, u.nombre, u.correo
      HAVING fecha_primer_login BETWEEN ? AND ?
      ORDER BY fecha_primer_login
      `,
      desde,
      hasta
    );

    const rows = normalizeResult(raw).map(mapUsuariosNuevos);
    res.json(toPlain(rows));
  } catch (err) {
    next(err);
  }
}

// C11) Saldos crÃ©ditos
export async function getSaldosCreditos(req, res, next) {
  try {
    const limit = req.query.limit ? Number(req.query.limit) : 50;

    const raw = await prisma.$queryRawUnsafe(
      `
      SELECT
        u.id_usuario,
        u.nombre,
        u.correo,
        b.saldo_creditos
      FROM USUARIO u
      JOIN BILLETERA b
        ON b.id_usuario = u.id_usuario
      ORDER BY b.saldo_creditos DESC
      LIMIT ?
      `,
      limit
    );

    const rows = normalizeResult(raw).map(mapSaldoUsuario);
    res.json(toPlain(rows));
  } catch (err) {
    next(err);
  }
}

// C12) Actividades sostenibles
export async function getActividadesSostenibles(req, res, next) {
  try {
    const { desde, hasta } = getRangoFechas(req);

    const raw = await prisma.$queryRawUnsafe(
      `
      SELECT
        u.id_usuario,
        u.nombre,
        u.correo,
        COUNT(a.id_actividad) AS total_actividades,
        SUM(a.creditos_otorgados) AS creditos_otorgados
      FROM ACTIVIDAD_SOSTENIBLE a
      JOIN USUARIO u
        ON u.id_usuario = a.id_usuario
      WHERE a.creado_en BETWEEN ? AND ?
      GROUP BY u.id_usuario, u.nombre, u.correo
      ORDER BY total_actividades DESC
      `,
      desde,
      hasta
    );

    const rows = normalizeResult(raw).map(mapActividadSostenible);
    res.json(toPlain(rows));
  } catch (err) {
    next(err);
  }
}

// C13) Impacto por categorÃ­a
export async function getImpactoPorCategoria(req, res, next) {
  try {
    const { idPeriodo } = req.query;
    if (!idPeriodo) {
      return res
        .status(400)
        .json({ ok: false, message: "idPeriodo es requerido" });
    }

    const raw = await prisma.$queryRawUnsafe(
      `
      SELECT
        c.nombre AS categoria,
        SUM(ia.co2_ahorrado)     AS co2_total,
        SUM(ia.agua_ahorrada)    AS agua_total,
        SUM(ia.energia_ahorrada) AS energia_total
      FROM IMPACTO_AMBIENTAL ia
      JOIN TRANSACCION t
        ON t.id_transaccion = ia.id_transaccion
      JOIN PUBLICACION p
        ON p.id_publicacion = t.id_publicacion
      JOIN CATEGORIA c
        ON c.id_categoria = p.id_categoria
      WHERE ia.id_periodo = ?
      GROUP BY c.nombre
      ORDER BY co2_total DESC
      `,
      Number(idPeriodo)
    );

    const rows = normalizeResult(raw).map(mapImpactoCategoria);
    res.json(toPlain(rows));
  } catch (err) {
    next(err);
  }
}
</file>

<file path="backend/src/modules/reportes/reportes.routes.js">
import { Router } from "express";
import { authMiddleware } from "../../middlewares/auth.js";
import { isAdmin } from "../../middlewares/isAdmin.js";
import {
  getUsuariosActivos,
  getUsuariosAbandonados,
  getIngresosCreditos,
  getCreditosGeneradosVsConsumidos,
  getIntercambiosPorCategoria,
  getPublicacionesVsIntercambios,
  getImpactoAcumulado,
  getRankingUsuarios,
  getUsuariosPremium,
  getUsuariosNuevos,
  getSaldosCreditos,
  getActividadesSostenibles,
  getImpactoPorCategoria,
} from "./reportes.controller.js";

const router = Router();

// Todo el mÃ³dulo de reportes SOLO para admins
router.use(authMiddleware, isAdmin);

/*  REPORTES PRINCIPALES */

// âœ” Usuarios activos
router.get("/usuarios-activos", getUsuariosActivos);

// âœ” Usuarios abandonados
router.get("/usuarios-abandonados", getUsuariosAbandonados);

// âœ” Ingresos por venta de crÃ©ditos
router.get("/ingresos-creditos", getIngresosCreditos);

// âœ” CrÃ©ditos generados vs consumidos
router.get("/creditos-generados-consumidos", getCreditosGeneradosVsConsumidos);

// âœ” Intercambios por categorÃ­a
router.get("/intercambios-categoria", getIntercambiosPorCategoria);

// âœ” Publicaciones vs intercambios
router.get("/publicaciones-vs-intercambios", getPublicacionesVsIntercambios);

// âœ” Impacto ecolÃ³gico acumulado
router.get("/impacto-acumulado", getImpactoAcumulado);

/* REPORTES AVANZADOS */

// âœ” Ranking de usuarios (top N)
router.get("/ranking-usuarios", getRankingUsuarios);

// âœ” Reporte de usuarios premium
router.get("/usuarios-premium", getUsuariosPremium);

// âœ” Usuarios nuevos (primer login)
router.get("/usuarios-nuevos", getUsuariosNuevos);

// âœ” Saldos de crÃ©ditos (top N)
router.get("/saldos-usuarios", getSaldosCreditos);

// âœ” Actividades sostenibles
router.get("/actividades-sostenibles", getActividadesSostenibles);

// âœ” Impacto ambiental por categorÃ­a (por perÃ­odo)
router.get("/impacto-categoria", getImpactoPorCategoria);

export default router;
</file>

<file path="backend/src/modules/uploads/multer.js">
import multer from "multer";
import { v4 as uuid } from "uuid";
import path from "path";

const storage = multer.diskStorage({
  destination: (_req, _file, cb) => {
    // Carpeta fÃ­sica donde se guardan los archivos
    cb(null, "uploads_storage");
  },
  filename: (_req, file, cb) => {
    const unique = uuid();
    const ext = path.extname(file.originalname);
    cb(null, unique + ext);
  },
});

export const upload = multer({ storage });
</file>

<file path="backend/src/modules/uploads/uploads.controller.js">
import { procesarArchivoService } from "./uploads.service.js";

export const subirArchivoController = async (req, res, next) => {
  try {
    if (!req.file) {
      return res
        .status(400)
        .json({ message: "No enviaste ningÃºn archivo" });
    }

    const data = await procesarArchivoService(req.file);

    res.json({
      message: "Archivo subido correctamente",
      data,
    });
  } catch (err) {
    next(err);
  }
};
</file>

<file path="backend/src/modules/uploads/uploads.routes.js">
import { Router } from "express";
import { authMiddleware } from "../../middlewares/auth.js";
import { upload } from "./multer.js";
import { subirArchivoController } from "./uploads.controller.js";

const router = Router();

// Ruta protegida: requiere login
router.post("/", authMiddleware, upload.single("archivo"), subirArchivoController);

export default router;
</file>

<file path="backend/src/modules/uploads/uploads.service.js">
import path from "path";

export async function procesarArchivoService(file) {
  // Ruta interna donde se guardÃ³ fÃ­sicamente
  const diskPath = path.join("uploads_storage", file.filename);
  // URL pÃºblica (el frontend usarÃ¡ esto)
  const url = `/uploads/${file.filename}`;

  // AquÃ­ podrÃ­as:
  // - Guardar info en BD
  // - Subir a S3 / Cloudinary
  // - Registrar logs, etc.

  return {
    url,
    path: diskPath,
    originalName: file.originalname,
    size: file.size,
    mimetype: file.mimetype,
  };
}
</file>

<file path="backend/src/modules/usuarios/usuarios.controller.js">
// src/modules/usuarios/usuarios.controller.js

import {
  listarUsuariosService,
  crearUsuarioAdminService,
  actualizarUsuarioService,
  cambiarEstadoUsuarioService,
  obtenerHistorialUsuarioService,
} from "./usuarios.service.js";

export async function listarUsuariosController(req, res, next) {
  try {
    const usuarios = await listarUsuariosService();
    res.json(usuarios);
  } catch (err) {
    next(err);
  }
}

export async function crearUsuarioAdminController(req, res, next) {
  try {
    const usuario = await crearUsuarioAdminService(req.body);
    res.status(201).json(usuario);
  } catch (err) {
    next(err);
  }
}

export async function actualizarUsuarioController(req, res, next) {
  try {
    const id = parseInt(req.params.id, 10);
    const usuario = await actualizarUsuarioService(id, req.body);
    res.json(usuario);
  } catch (err) {
    next(err);
  }
}

export async function cambiarEstadoUsuarioController(req, res, next) {
  try {
    const id = parseInt(req.params.id, 10);
    const { estado } = req.body;
    const usuario = await cambiarEstadoUsuarioService(id, estado);
    res.json(usuario);
  } catch (err) {
    next(err);
  }
}

export async function obtenerHistorialUsuarioController(req, res, next) {
  try {
    const id = parseInt(req.params.id, 10);
    const historial = await obtenerHistorialUsuarioService(id);
    res.json(historial);
  } catch (err) {
    next(err);
  }
}
</file>

<file path="backend/src/modules/usuarios/usuarios.routes.js">
// src/modules/usuarios/usuarios.routes.js
import { Router } from "express";
import { authMiddleware } from "../../middlewares/auth.js";
import { isAdmin } from "../../middlewares/isAdmin.js";
import {
  listarUsuariosController,
  crearUsuarioAdminController,
  actualizarUsuarioController,
  cambiarEstadoUsuarioController,
  obtenerHistorialUsuarioController,
} from "./usuarios.controller.js";

const router = Router();

// Todo lo de aquÃ­ requiere admin
router.use(authMiddleware, isAdmin);

// GET /api/usuarios
router.get("/", listarUsuariosController);

// POST /api/usuarios
router.post("/", crearUsuarioAdminController);

// PUT /api/usuarios/:id
router.put("/:id", actualizarUsuarioController);

// PATCH /api/usuarios/:id/estado
router.patch("/:id/estado", cambiarEstadoUsuarioController);

// GET /api/usuarios/:id/historial
router.get("/:id/historial", obtenerHistorialUsuarioController);

export default router;
</file>

<file path="backend/src/modules/usuarios/usuarios.service.js">
// src/modules/usuarios/usuarios.service.js
import bcrypt from "bcryptjs";
import { prisma } from "../../config/prisma.js";

export async function listarUsuariosService() {
  const rows = await prisma.$queryRaw`
    SELECT u.id_usuario, u.nombre, u.apellido, u.correo, u.telefono,
           u.estado, r.nombre AS rol
    FROM USUARIO u
    JOIN ROL r ON r.id_rol = u.id_rol
    ORDER BY u.id_usuario DESC
  `;
  return rows;
}

export async function crearUsuarioAdminService({
  nombre,
  apellido,
  correo,
  telefono,
  password,
  id_rol,
  estado = "ACTIVO",
}) {
  if (!nombre || !correo || !password || !id_rol) {
    const err = new Error("nombre, correo, password e id_rol son obligatorios");
    err.status = 400;
    throw err;
  }

  const existente = await prisma.$queryRaw`
    SELECT id_usuario FROM USUARIO WHERE correo = ${correo} LIMIT 1
  `;
  if (existente.length) {
    const error = new Error("El correo ya estÃ¡ registrado");
    error.status = 409;
    throw error;
  }

  const hash = await bcrypt.hash(password, 10);

  await prisma.$queryRaw`
    INSERT INTO USUARIO (id_rol, estado, nombre, apellido, correo, password_hash, telefono, url_perfil)
    VALUES (${id_rol}, ${estado}, ${nombre}, ${apellido || null}, ${correo}, ${hash},
            ${telefono || null}, NULL)
  `;

  const rows = await prisma.$queryRaw`
    SELECT u.id_usuario, u.nombre, u.apellido, u.correo, u.telefono,
           u.estado, r.nombre AS rol
    FROM USUARIO u
    JOIN ROL r ON r.id_rol = u.id_rol
    WHERE u.correo = ${correo}
    LIMIT 1
  `;
  return rows[0];
}

export async function actualizarUsuarioService(idUsuario, data) {
  const { nombre, apellido, telefono, id_rol } = data;

  // Normalizar undefined â†’ null para que COALESCE funcione como "no cambiar"
  const nombreParam = nombre === undefined ? null : nombre;
  const apellidoParam = apellido === undefined ? null : apellido;
  const telefonoParam = telefono === undefined ? null : telefono;
  const rolParam = id_rol === undefined ? null : id_rol;

  await prisma.$queryRaw`
    UPDATE USUARIO
    SET nombre  = COALESCE(${nombreParam}, nombre),
        apellido = COALESCE(${apellidoParam}, apellido),
        telefono = COALESCE(${telefonoParam}, telefono),
        id_rol   = COALESCE(${rolParam}, id_rol)
    WHERE id_usuario = ${idUsuario}
  `;

  const rows = await prisma.$queryRaw`
    SELECT u.id_usuario, u.nombre, u.apellido, u.correo, u.telefono,
           u.estado, r.nombre AS rol
    FROM USUARIO u
    JOIN ROL r ON r.id_rol = u.id_rol
    WHERE u.id_usuario = ${idUsuario}
    LIMIT 1
  `;
  if (!rows.length) {
    const err = new Error("Usuario no encontrado");
    err.status = 404;
    throw err;
  }
  return rows[0];
}

export async function cambiarEstadoUsuarioService(idUsuario, estado) {
  if (!estado) {
    const err = new Error("estado es obligatorio");
    err.status = 400;
    throw err;
  }

  await prisma.$queryRaw`
    UPDATE USUARIO
    SET estado = ${estado}
    WHERE id_usuario = ${idUsuario}
  `;

  const rows = await prisma.$queryRaw`
    SELECT u.id_usuario, u.nombre, u.apellido, u.correo, u.telefono,
           u.estado, r.nombre AS rol
    FROM USUARIO u
    JOIN ROL r ON r.id_rol = u.id_rol
    WHERE u.id_usuario = ${idUsuario}
    LIMIT 1
  `;
  if (!rows.length) {
    const err = new Error("Usuario no encontrado");
    err.status = 404;
    throw err;
  }
  return rows[0];
}

export async function obtenerHistorialUsuarioService(idUsuario) {
  // Llama a tu SP sp_obtener_historial_usuario
  const [rows] = await prisma.$queryRawUnsafe(
    "CALL sp_obtener_historial_usuario(?)",
    idUsuario
  );
  // rows ya es el primer resultset del CALL
  return rows;
}
</file>

<file path="backend/src/modules/wallet/wallet.controller.js">
import {
  obtenerMisCreditosService,
  obtenerMisMovimientosService,
  comprarCreditosService,
  obtenerMisComprasService,
} from "./wallet.service.js";

export async function getMisCreditosController(req, res, next) {
  try {
    const idUsuario = req.user.id_usuario;
    const data = await obtenerMisCreditosService(idUsuario);
    res.json(data);
  } catch (err) {
    next(err);
  }
}

export async function getMisMovimientosController(req, res, next) {
  try {
    const idUsuario = req.user.id_usuario;
    const data = await obtenerMisMovimientosService(idUsuario);
    res.json(data);
  } catch (err) {
    next(err);
  }
}

export async function postCompraCreditosController(req, res, next) {
  try {
    const idUsuario = req.user.id_usuario;
    const { idPaquete, idTransaccionPago } = req.body;

    if (!idPaquete) {
      return res.status(400).json({ message: "idPaquete es obligatorio" });
    }

    const billetera = await comprarCreditosService({
      idUsuario,
      idPaquete,
      idTransaccionPago: idTransaccionPago || null,
    });

    res.status(201).json({
      message: "Compra aprobada",
      billetera,
    });
  } catch (err) {
    next(err);
  }
}

export async function getMisComprasController(req, res, next) {
  try {
    const idUsuario = req.user.id_usuario;
    const compras = await obtenerMisComprasService(idUsuario);
    res.json(compras);
  } catch (err) {
    next(err);
  }
}
</file>

<file path="backend/src/modules/wallet/wallet.routes.js">
import { Router } from "express";
import { authMiddleware } from "../../middlewares/auth.js";
import {
  getMisCreditosController,
  getMisMovimientosController,
  postCompraCreditosController,
  getMisComprasController,
} from "./wallet.controller.js";

const router = Router();

router.use(authMiddleware);

// GET /api/wallet/mis-creditos
router.get("/mis-creditos", getMisCreditosController);

// GET /api/wallet/mis-movimientos
router.get("/mis-movimientos", getMisMovimientosController);

// POST /api/wallet/compra-creditos
router.post("/compra-creditos", postCompraCreditosController);

// GET /api/wallet/compras
router.get("/compras", getMisComprasController);

export default router;
</file>

<file path="backend/src/modules/wallet/wallet.service.js">
// backend/src/modules/wallet/wallet.service.js
import { prisma } from "../../config/prisma.js";

// =======================================
// Helper: convertir BigInt / Decimal a Number
// =======================================
function toNumberSafe(value, def = 0) {
  if (value == null) return def;

  if (typeof value === "bigint") return Number(value);

  if (typeof value === "object" && typeof value.toNumber === "function") {
    return value.toNumber();
  }

  const num = Number(value);
  return Number.isNaN(num) ? def : num;
}

// =======================================
// Normalizadores
// =======================================

// Saldo de billetera
function normalizeBilleteraRow(row) {
  if (!row) {
    return {
      saldo_creditos: 0,
      saldo_bs: 0,
      saldo: 0,
      creditos: 0,
      saldo_bloqueado: 0,
      bloqueado: 0,
    };
  }

  const saldoCreditos = toNumberSafe(row.saldo_creditos, 0);
  const saldoBs = toNumberSafe(row.saldo_bs, 0);
  const saldoBloqueado = toNumberSafe(row.saldo_bloqueado ?? 0, 0);

  return {
    // nombres originales de la consulta
    saldo_creditos: saldoCreditos,
    saldo_bs: saldoBs,

    // alias que usan Home, Perfil y Wallet en el front
    saldo: saldoCreditos,
    creditos: saldoCreditos,
    saldo_bloqueado: saldoBloqueado,
    bloqueado: saldoBloqueado,
  };
}

// Movimiento de crÃ©ditos
function normalizeMovimientoRow(row) {
  if (!row) return row;

  const cantidad = toNumberSafe(row.cantidad, 0);

  return {
    ...row,
    cantidad,
    creditos: cantidad, // el front muestra a.creditos en Home
    saldo_anterior: toNumberSafe(row.saldo_anterior, 0),
    saldo_posterior: toNumberSafe(row.saldo_posterior, 0),
    // creado_en queda como Date y Express lo serializa a ISO
  };
}

// Compra de paquete de crÃ©ditos
function normalizeCompraRow(row) {
  if (!row) return row;

  const cant = toNumberSafe(row.cantidad_creditos, 0);
  const monto = toNumberSafe(row.monto_bs, 0);

  return {
    ...row,
    cantidad_creditos: cant,
    creditos: cant,          // para tablas que leen c.creditos
    creditos_compra: cant,   // para tablas que leen c.creditos_compra
    monto_bs: monto,
    monto,                   // alias genÃ©rico
  };
}

// =======================================
// Servicios pÃºblicos del mÃ³dulo
// =======================================

// Saldo actual de la billetera del usuario logueado
export async function obtenerMisCreditosService(idUsuario) {
  const rows = await prisma.$queryRaw`
    SELECT saldo_creditos, saldo_bs
    FROM BILLETERA
    WHERE id_usuario = ${idUsuario}
    LIMIT 1
  `;

  return normalizeBilleteraRow(rows[0]);
}

// Movimientos de la billetera del usuario
export async function obtenerMisMovimientosService(idUsuario) {
  const rows = await prisma.$queryRaw`
    SELECT m.id_movimiento,
           m.cantidad,
           m.saldo_anterior,
           m.saldo_posterior,
           m.id_referencia,
           m.creado_en,
           tm.nombre AS tipo_movimiento,
           tr.nombre AS tipo_referencia
    FROM MOVIMIENTO_CREDITOS m
    JOIN TIPO_MOVIMIENTO tm ON tm.id_tipo_movimiento = m.id_tipo_movimiento
    JOIN TIPO_REFERENCIA tr ON tr.id_tipo_referencia = m.id_tipo_referencia
    WHERE m.id_usuario = ${idUsuario}
    ORDER BY m.creado_en DESC, m.id_movimiento DESC
  `;

  return rows.map(normalizeMovimientoRow);
}

// Compra de un paquete de crÃ©ditos (llama al SP y devuelve la billetera actualizada)
export async function comprarCreditosService({
  idUsuario,
  idPaquete,
  idTransaccionPago,
}) {
  // SP: sp_compra_creditos_aprobar(p_id_usuario, p_id_paquete, p_id_transaccion_pago)
  await prisma.$executeRawUnsafe(
    "CALL sp_compra_creditos_aprobar(?, ?, ?)",
    idUsuario,
    idPaquete,
    idTransaccionPago
  );

  const rows = await prisma.$queryRaw`
    SELECT saldo_creditos, saldo_bs
    FROM BILLETERA
    WHERE id_usuario = ${idUsuario}
    LIMIT 1
  `;

  return normalizeBilleteraRow(rows[0]);
}

// Historial de compras de paquetes de crÃ©ditos
export async function obtenerMisComprasService(idUsuario) {
  const rows = await prisma.$queryRaw`
    SELECT c.id_compra,
           c.id_paquete,
           p.nombre AS paquete,
           p.cantidad_creditos,
           c.monto_bs,
           c.estado,
           c.id_transaccion_pago,
           c.creado_en
    FROM COMPRA_CREDITOS c
    JOIN PAQUETE_CREDITOS p ON p.id_paquete = c.id_paquete
    WHERE c.id_usuario = ${idUsuario}
    ORDER BY c.creado_en DESC, c.id_compra DESC
  `;

  return rows.map(normalizeCompraRow);
}
</file>

<file path="backend/src/routes/index.js">
// src/routes/index.js
import { Router } from "express";

import authRoutes from "../modules/auth/auth.routes.js";
import usuariosRoutes from "../modules/usuarios/usuarios.routes.js";
import catalogosRoutes from "../modules/catalogos/catalogos.routes.js";
import walletRoutes from "../modules/wallet/wallet.routes.js";
import publicacionesRoutes from "../modules/publicaciones/publicaciones.routes.js";
import intercambiosRoutes from "../modules/intercambios/intercambios.routes.js";
import actividadesRoutes from "../modules/actividades/actividades.routes.js";
import promocionesRoutes from "../modules/promociones/promociones.routes.js";
import publicidadRoutes from "../modules/publicidad/publicidad.routes.js";
import logrosRoutes from "../modules/logros/logros.routes.js";
import premiumRoutes from "../modules/premium/premium.routes.js";
import reportesRoutes from "../modules/reportes/reportes.routes.js";
import uploadsRoutes from "../modules/uploads/uploads.routes.js";

// â¬‡ï¸ NUEVO
import bitacorasRoutes from "../modules/bitacoras/bitacoras.routes.js";

const router = Router();

router.get("/health", (req, res) => {
  res.json({ ok: true, message: "API Digital Barter OK" });
});

// MÃ³dulos
router.use("/auth", authRoutes);
router.use("/usuarios", usuariosRoutes);
router.use("/catalogos", catalogosRoutes);
router.use("/wallet", walletRoutes);
router.use("/publicaciones", publicacionesRoutes);
router.use("/intercambios", intercambiosRoutes);
router.use("/actividades-sostenibles", actividadesRoutes);
router.use("/promociones", promocionesRoutes);
router.use("/publicidad", publicidadRoutes);
router.use("/logros", logrosRoutes);
router.use("/premium", premiumRoutes);
router.use("/reportes", reportesRoutes);
router.use("/uploads", uploadsRoutes);

// â¬‡ï¸ NUEVO: bitÃ¡coras
router.use("/bitacoras", bitacorasRoutes);

export default router;
</file>

<file path="backend/src/server.js">
// src/server.js
import app from './app.js'
import { env } from './config/env.js'

const PORT = env.PORT

app.listen(PORT, () => {
    console.log(`ðŸš€ API running on http://localhost:${PORT}`)
})
</file>

<file path="backend/utils/jsonBigInt.js">
export function toJsonSafe(value) {
  if (typeof value === "bigint") {
    return Number(value);            // <- si prefieres string: value.toString()
  }

  if (Array.isArray(value)) {
    return value.map(toJsonSafe);
  }

  if (value !== null && typeof value === "object") {
    const out = {};
    for (const key in value) {
      out[key] = toJsonSafe(value[key]);
    }
    return out;
  }

  return value;
}
</file>

<file path="docker-compose.yml">
version: "3.9"
services:
  db:
    image: mysql:8.0
    restart: unless-stopped
    environment:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_DATABASE: appdb
    ports:
      - "3306:3306"
    volumes:
      - db_data:/var/lib/mysql
      - ./infra/db/init.sql:/docker-entrypoint-initdb.d/1-init.sql
      - ./infra/db/seed.sql:/docker-entrypoint-initdb.d/2-seed.sql
  backend:
    build: ./backend
    working_dir: /app
    env_file: ./backend/.env
    depends_on:
      - db
    ports:
      - "4000:4000"
    command: sh -c "npx prisma migrate deploy && node src/server.js"
    volumes:
      - ./backend:/app
  frontend:
    build: ./frontend
    working_dir: /app
    ports:
      - "5173:5173"
    environment:
      - VITE_API_URL=http://localhost:4000/api
    command: npm run dev -- --host
    volumes:
      - ./frontend:/app
volumes:
  db_data:
</file>

<file path="frontend/index.html">
<!doctype html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <title>Digital Barter</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  </head>
  <body class="bg-gray-100">
    <div id="root"></div>
    <script type="module" src="/src/main.jsx"></script>
  </body>
</html>
</file>

<file path="frontend/package.json">
{
  "name": "frontend",
  "version": "0.0.1",
  "private": true,
  "scripts": {
    "dev": "vite",
    "build": "vite build",
    "preview": "vite preview"
  },
  "dependencies": {
    "lucide-react": "^0.555.0",
    "react": "^18.3.1",
    "react-dom": "^18.3.1",
    "react-router-dom": "^6.28.0",
    "recharts": "^3.4.1"
  },
  "devDependencies": {
    "@vitejs/plugin-react": "^4.3.4",
    "autoprefixer": "^10.4.20",
    "postcss": "^8.4.49",
    "tailwindcss": "^3.4.14",
    "vite": "^5.4.0"
  }
}
</file>

<file path="frontend/postcss.config.js">
module.exports = {
  plugins: {
    tailwindcss: {},
    autoprefixer: {}
  }
};
</file>

<file path="frontend/src/App.jsx">
import React from "react";
import AppRouter from "./router.jsx";

export default function App() {
  return <AppRouter />;
}
</file>

<file path="frontend/src/components/Layout.jsx">
import React from "react";
import Navbar from "./Navbar.jsx";

export default function Layout({ children }) {
  return (
    <div className="min-h-screen flex flex-col">
      <Navbar />
      <main className="flex-1 max-w-6xl w-full mx-auto px-4 py-4">
        {children}
      </main>
    </div>
  );
}
</file>

<file path="frontend/src/components/Navbar.jsx">
// src/components/Navbar.jsx
import React from "react";
import hoja from "../assets/hoja.png";

export default function Navbar() {
  return (
    <nav className="w-full bg-[#0b3a2c] border-b border-emerald-600 px-6 py-4 flex items-center justify-between shadow-md">
      
      {/* LOGO */}
      <div className="flex items-center gap-3 cursor-pointer"
        onClick={() => (window.location.href = "/home")}
      >
        <img src={hoja} className="w-9 h-9 drop-shadow-lg" />
        <h1 className="text-2xl font-bold text-emerald-400">
          Digital Barter
        </h1>
      </div>

      {/* BOTONES DE NAVEGACIÃ“N */}
      <div className="flex items-center gap-6">

        {/* PERFIL */}
        <a
          href="/perfil"
          className="text-white hover:text-emerald-400 transition font-semibold"
        >
          Perfil
        </a>

        {/* WALLET */}
        <a
          href="/wallet"
          className="text-white hover:text-emerald-400 transition font-semibold"
        >
          Billetera
        </a>

        {/* PUBLICACIONES */}
        <a
          href="/publicaciones"
          className="text-white hover:text-emerald-400 transition font-semibold"
        >
          Publicaciones
        </a>

        {/* ACTIVIDADES */}
        <a
          href="/actividades"
          className="text-white hover:text-emerald-400 transition font-semibold"
        >
          Actividades
        </a>

        {/* PREMIUM */}
        <a
          href="/premium"
          className="text-white hover:text-yellow-400 transition font-semibold"
        >
          Premium
        </a>
        {/* INTERCAMBIOS */}
        <a
          href="/intercambios"
          className="text-white hover:text-emerald-400 transition font-semibold"
        >
          Intercambios
        </a>
        {/* PROMOCIONES (solo admin) */}
        <a
          href="/promociones"
          className="text-white hover:text-emerald-400 transition font-semibold"
        >
          Promociones
        </a>
        {/* ðŸ”Ž NUEVO: REPORTES */}
        <a
          href="/reportes"
          className="px-3 py-1.5 rounded-full border border-emerald-400/70 bg-emerald-500/10 text-emerald-100 text-xs font-semibold tracking-wide uppercase hover:bg-emerald-500/20 hover:border-emerald-300 transition"
        >
          Reportes
        </a>
        <a
          href="/publicidad"
          className="text-white hover:text-emerald-400 transition font-semibold"
        >
          Publicidad
        </a>

        {/* CERRAR SESIÃ“N */}
        <button
          onClick={() => {
            localStorage.removeItem("token");
            window.location.href = "/login";
          }}
          className="bg-emerald-500 hover:bg-emerald-600 px-4 py-1 rounded-lg text-white font-semibold transition"
        >
          Salir
        </button>
      </div>
    </nav>
  );
}
</file>

<file path="frontend/src/components/ProtectedRoute.jsx">
import React from "react";
import { Navigate, useLocation } from "react-router-dom";

export default function ProtectedRoute({ children }) {
  const token = localStorage.getItem("token");
  const location = useLocation();

  if (!token) {
    return <Navigate to="/login" state={{ from: location }} replace />;
  }

  return children;
}
</file>

<file path="frontend/src/index.css">
@tailwind base;
@tailwind components;
@tailwind utilities;

/* estilos globales */
body {
  @apply bg-gray-100 text-gray-900;
}

.btn-primary {
  @apply inline-flex items-center justify-center px-4 py-2 rounded-md bg-blue-600 text-white text-sm font-medium hover:bg-blue-700 transition;
}

.card {
  @apply bg-white rounded-lg shadow-sm border border-gray-200 p-4;
}
</file>

<file path="frontend/src/main.jsx">
import React from "react";
import ReactDOM from "react-dom/client";
import { BrowserRouter } from "react-router-dom";
import App from "./App.jsx";
import "./index.css";

ReactDOM.createRoot(document.getElementById("root")).render(
  <React.StrictMode>
    <BrowserRouter>
      <App />
    </BrowserRouter>
  </React.StrictMode>
);
</file>

<file path="frontend/src/pages/Actividades.jsx">
// digital-barder/frontend/src/pages/Actividades.jsx
import { useState } from "react";
import { useNavigate } from "react-router-dom";
import { registrarActividadSostenible } from "../services/api";
import { ArrowLeft, Leaf, CheckCircle2 } from "lucide-react";
import hoja from "../assets/hoja.png";

// Lista fija basada en la tabla TIPO_ACTIVIDAD de la BD
const TIPOS_ACTIVIDAD = [
  { id: 1, nombre: "RECICLAJE" },
  { id: 2, nombre: "Reciclaje de PlÃ¡stico" },
  { id: 3, nombre: "Reciclaje de Papel" },
  { id: 4, nombre: "Reciclaje de ElectrÃ³nicos" },
  { id: 5, nombre: "Limpieza de Parques" },
  { id: 6, nombre: "Limpieza de Calles" },
  { id: 7, nombre: "ReforestaciÃ³n" },
  { id: 8, nombre: "EducaciÃ³n Ambiental" },
  { id: 9, nombre: "Compostaje" },
  { id: 10, nombre: "Transporte Sostenible" },
  { id: 11, nombre: "Reciclaje de Vidrio" },
];

export default function Actividades() {
  const navigate = useNavigate();

  const [idTipoActividad, setIdTipoActividad] = useState("");
  const [descripcion, setDescripcion] = useState("");
  const [creditos, setCreditos] = useState("");
  const [evidenciaUrl, setEvidenciaUrl] = useState("");
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState("");
  const [mensajeOk, setMensajeOk] = useState("");
  const [ultimaActividad, setUltimaActividad] = useState(null);

  async function handleSubmit(e) {
    e.preventDefault();
    setError("");
    setMensajeOk("");
    setUltimaActividad(null);

    const id_tipo_actividad = Number(idTipoActividad);
    const creditos_otorgados = Number(creditos);

    if (
      Number.isNaN(id_tipo_actividad) ||
      Number.isNaN(creditos_otorgados) ||
      !descripcion.trim()
    ) {
      setError(
        "Tipo de actividad, descripciÃ³n y crÃ©ditos otorgados son obligatorios y deben ser vÃ¡lidos."
      );
      return;
    }

    try {
      setLoading(true);

      const act = await registrarActividadSostenible({
        id_tipo_actividad,
        descripcion,
        creditos_otorgados,
        evidencia_url: evidenciaUrl || null,
      });

      setMensajeOk("Actividad registrada correctamente ðŸŒ±");
      setUltimaActividad(act);

      // limpiar parcialmente
      setDescripcion("");
      setCreditos("");
      setEvidenciaUrl("");
    } catch (err) {
      console.error(err);
      setError(
        err.message || "OcurriÃ³ un error al registrar la actividad sostenible."
      );
    } finally {
      setLoading(false);
    }
  }

  return (
    <div className="min-h-screen bg-[#082b1f] text-white p-6 md:p-10">
      {/* HEADER */}
      <header className="flex items-center justify-between gap-3 mb-8">
        <div className="flex items-center gap-3">
          <button
            type="button"
            onClick={() => navigate(-1)}
            className="inline-flex items-center gap-2 rounded-full bg-black/30 px-3 py-1 text-sm hover:bg-black/40"
          >
            <ArrowLeft size={16} />
            Volver
          </button>
          <div className="flex items-center gap-2 rounded-2xl bg-emerald-900/70 px-3 py-2 text-sm">
            <Leaf size={18} className="text-emerald-300" />
            <span className="font-semibold">Actividades sostenibles</span>
          </div>
        </div>

        <div className="flex items-center gap-3">
          <button
            type="button"
            onClick={() => navigate("/actividades/mias")}
            className="px-4 py-2 rounded-lg border border-emerald-500 text-sm hover:bg-emerald-500/10 font-semibold"
          >
            Mis actividades
          </button>
          <img src={hoja} alt="logo" className="w-9 h-9 drop-shadow-md" />
        </div>
      </header>

      {/* DESCRIPCIÃ“N */}
      <section className="mb-6 max-w-3xl">
        <h1 className="text-2xl font-semibold mb-2">
          Registrar actividad sostenible
        </h1>
        <p className="text-sm text-emerald-100/80">
          AquÃ­ puedes registrar acciones ecolÃ³gicas que realizaste (reciclaje,
          voluntariado, movilidad sostenible, etc.). El sistema las guardarÃ¡ en
          tu historial y te otorgarÃ¡ crÃ©ditos verdes segÃºn las reglas definidas
          por el administrador.
        </p>
      </section>

      {/* MENSAJES */}
      {error && (
        <div className="mb-4 rounded-md border border-red-400 bg-red-900/40 px-4 py-2 text-sm text-red-100">
          {error}
        </div>
      )}

      {mensajeOk && (
        <div className="mb-4 rounded-md border border-emerald-400 bg-emerald-900/40 px-4 py-2 text-sm text-emerald-100 flex items-center gap-2">
          <CheckCircle2 size={18} />
          <span>{mensajeOk}</span>
        </div>
      )}

      {/* FORMULARIO */}
      <form
        onSubmit={handleSubmit}
        className="max-w-3xl bg-[#0f3f2d] border border-emerald-700 rounded-2xl p-5 shadow-md space-y-4"
      >
        {/* id_tipo_actividad como SELECT */}
        <div>
          <label className="block text-xs mb-1">
            Tipo de actividad (id_tipo_actividad) *
          </label>
          <select
            value={idTipoActividad}
            onChange={(e) => setIdTipoActividad(e.target.value)}
            className="w-full rounded-lg border border-emerald-700 bg-emerald-950/80 px-3 py-2 text-sm outline-none focus:ring focus:ring-emerald-500/60"
          >
            <option value="">Selecciona un tipo de actividad</option>
            {TIPOS_ACTIVIDAD.map((t) => (
              <option key={t.id} value={t.id}>
                {t.id} - {t.nombre}
              </option>
            ))}
          </select>
          <p className="text-[11px] text-emerald-100/70 mt-1">
            La lista estÃ¡ basada en la tabla TIPO_ACTIVIDAD de la base de datos.
          </p>
        </div>

        {/* descripciÃ³n */}
        <div>
          <label className="block text-xs mb-1">DescripciÃ³n *</label>
          <textarea
            value={descripcion}
            onChange={(e) => setDescripcion(e.target.value)}
            rows={3}
            className="w-full rounded-lg border border-emerald-700 bg-emerald-950/80 px-3 py-2 text-sm outline-none focus:ring focus:ring-emerald-500/60"
            placeholder="Ej. ParticipÃ© 3 horas en una campaÃ±a de reforestaciÃ³n en el parque..."
          />
        </div>

        {/* crÃ©ditos */}
        <div>
          <label className="block text-xs mb-1">
            CrÃ©ditos otorgados (creditos_otorgados) *
          </label>
          <input
            type="number"
            value={creditos}
            onChange={(e) => setCreditos(e.target.value)}
            className="w-full rounded-lg border border-emerald-700 bg-emerald-950/80 px-3 py-2 text-sm outline-none focus:ring focus:ring-emerald-500/60"
            placeholder="Ej. 10"
          />
        </div>

        {/* evidencia_url */}
        <div>
          <label className="block text-xs mb-1">
            URL de evidencia (opcional)
          </label>
          <input
            type="url"
            value={evidenciaUrl}
            onChange={(e) => setEvidenciaUrl(e.target.value)}
            className="w-full rounded-lg border border-emerald-700 bg-emerald-950/80 px-3 py-2 text-sm outline-none focus:ring focus:ring-emerald-500/60"
            placeholder="Link a foto, drive, formulario, etc."
          />
        </div>

        <div className="pt-2 flex justify-end">
          <button
            type="submit"
            disabled={loading}
            className="px-6 py-2 rounded-lg bg-emerald-500 hover:bg-emerald-600 disabled:opacity-60 disabled:cursor-not-allowed text-sm font-semibold text-emerald-950"
          >
            {loading ? "Guardando..." : "Registrar actividad"}
          </button>
        </div>
      </form>

      {/* ÃšLTIMA ACTIVIDAD REGISTRADA (respuesta del backend) */}
      {ultimaActividad && (
        <section className="max-w-3xl mt-6 bg-[#0f3f2d] border border-emerald-700 rounded-2xl p-4 text-sm text-emerald-100/90">
          <p className="font-semibold mb-1">
            Ãšltima actividad registrada (respuesta del backend):
          </p>
          <pre className="text-xs overflow-x-auto">
            {JSON.stringify(ultimaActividad, null, 2)}
          </pre>
        </section>
      )}
    </div>
  );
}
</file>

<file path="frontend/src/pages/ActividadesAdmin.jsx">
// frontend/src/pages/ActividadesAdmin.jsx
import { useEffect, useState } from "react";
import {
  aprobarActividad,
  rechazarActividad,
  getActividadesAdmin,
} from "../services/api";
import hoja from "../assets/hoja.png";

export default function ActividadesAdmin() {
  const [actividades, setActividades] = useState([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState("");

  async function cargar() {
    try {
      setLoading(true);
      setError("");
      // Llamamos al endpoint ADMIN: GET /actividades-sostenibles/admin
      const lista = await getActividadesAdmin({});
      setActividades(Array.isArray(lista) ? lista : []);
    } catch (err) {
      console.error(err);
      setError(err.message || "Error cargando actividades");
    } finally {
      setLoading(false);
    }
  }

  async function handleAprobar(id) {
    try {
      await aprobarActividad(id);
      await cargar();
    } catch (err) {
      alert(err.message || "Error al aprobar la actividad");
    }
  }

  async function handleRechazar(id) {
    try {
      await rechazarActividad(id);
      await cargar();
    } catch (err) {
      alert(err.message || "Error al rechazar la actividad");
    }
  }

  useEffect(() => {
    cargar();
  }, []);

  return (
    <div className="min-h-screen bg-[#082b1f] text-white p-6">
      {/* HEADER */}
      <header className="flex justify-between items-center mb-6">
        <div>
          <h1 className="text-2xl font-bold">Panel de Actividades Sostenibles</h1>
          <p className="text-sm text-emerald-100/80">
            RevisiÃ³n y aprobaciÃ³n de actividades registradas por los usuarios.
          </p>
        </div>
        <img src={hoja} className="w-10 h-10" alt="logo" />
      </header>

      {/* ESTADOS */}
      {loading && <p className="text-emerald-100/80">Cargando actividades...</p>}
      {error && (
        <p className="text-red-400 mb-4">
          {error}
        </p>
      )}

      {!loading && !error && actividades.length === 0 && (
        <p className="text-emerald-100/80">
          No hay actividades registradas aÃºn.
        </p>
      )}

      {/* TABLA */}
      {!loading && !error && actividades.length > 0 && (
        <div className="overflow-x-auto mt-4 bg-[#0f3f2d] border border-emerald-700 rounded-xl">
          <table className="w-full text-sm border-collapse">
            <thead>
              <tr className="bg-emerald-900/40 text-emerald-200">
                <th className="p-2 border border-emerald-700">ID</th>
                <th className="p-2 border border-emerald-700">Usuario</th>
                <th className="p-2 border border-emerald-700">Correo</th>
                <th className="p-2 border border-emerald-700">Tipo</th>
                <th className="p-2 border border-emerald-700">CrÃ©ditos</th>
                <th className="p-2 border border-emerald-700">Estado</th>
                <th className="p-2 border border-emerald-700">Acciones</th>
              </tr>
            </thead>
            <tbody>
              {actividades.map((a) => (
                <tr key={a.id_actividad} className="border border-emerald-800">
                  <td className="p-2">{a.id_actividad}</td>
                  <td className="p-2">{a.nombre_usuario}</td>
                  <td className="p-2">{a.correo_usuario}</td>
                  <td className="p-2">
                    {a.nombre_tipo_actividad || a.descripcion}
                  </td>
                  <td className="p-2">{a.creditos_otorgados}</td>
                  <td className="p-2 font-bold">
                    {a.estado === "PENDIENTE" && (
                      <span className="text-yellow-300">PENDIENTE</span>
                    )}
                    {a.estado === "APROBADA" && (
                      <span className="text-emerald-300">APROBADA</span>
                    )}
                    {a.estado === "RECHAZADA" && (
                      <span className="text-red-300">RECHAZADA</span>
                    )}
                    {!a.estado && (
                      <span className="text-emerald-100/70">-</span>
                    )}
                  </td>
                  <td className="p-2">
                    {a.estado === "PENDIENTE" ? (
                      <div className="flex gap-2">
                        <button
                          onClick={() => handleAprobar(a.id_actividad)}
                          className="px-3 py-1 bg-emerald-500 text-black rounded text-xs"
                        >
                          Aprobar
                        </button>
                        <button
                          onClick={() => handleRechazar(a.id_actividad)}
                          className="px-3 py-1 bg-red-500 text-black rounded text-xs"
                        >
                          Rechazar
                        </button>
                      </div>
                    ) : a.estado === "APROBADA" ? (
                      <span className="text-emerald-300 text-xs">
                        Aprobada âœ”
                      </span>
                    ) : (
                      <span className="text-red-300 text-xs">
                        Rechazada âœ˜
                      </span>
                    )}
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      )}
    </div>
  );
}
</file>

<file path="frontend/src/pages/BackendLab.jsx">
// frontend/src/pages/BackendLab.jsx
import React, { useEffect, useState } from "react";

// Usa la misma URL base del backend que ya usas en el proyecto
const API_BASE_URL =
  import.meta.env.VITE_API_URL || "http://localhost:4000/api";

function loadToken() {
  return localStorage.getItem("token") || "";
}

export default function BackendLab() {
  const [token, setToken] = useState(loadToken());
  const [loading, setLoading] = useState(false);
  const [lastRequest, setLastRequest] = useState(null);
  const [lastResponse, setLastResponse] = useState(null);
  const [error, setError] = useState("");

  // ====== AUTH: registro / login ======
  const [regNombre, setRegNombre] = useState("Ana");
  const [regApellido, setRegApellido] = useState("Demo");
  const [regCorreo, setRegCorreo] = useState("ana.demo@example.com");
  const [regPassword, setRegPassword] = useState("ana12345");
  const [regTelefono, setRegTelefono] = useState("70000001");

  const [loginCorreo, setLoginCorreo] = useState("ana.demo@example.com");
  const [loginPassword, setLoginPassword] = useState("ana12345");

  // ====== Usuarios / historial ======
  const [userIdHistorial, setUserIdHistorial] = useState("");

  // ====== Wallet ======
  const [idPaquete, setIdPaquete] = useState("1");
  const [montoPagado, setMontoPagado] = useState("100");
  const [refPago, setRefPago] = useState("TEST-001");

  // ====== Intercambios ======
  const [idPublicacionInter, setIdPublicacionInter] = useState("");
  const [creditosInter, setCreditosInter] = useState("");

  // ====== Actividades ======
  const [idTipoAct, setIdTipoAct] = useState("1");
  const [descAct, setDescAct] = useState("EntregÃ³ 5kg de papel para reciclaje");
  const [credAct, setCredAct] = useState("10");

  // ====== Reportes ======
  const [desdeRep, setDesdeRep] = useState("2025-11-01");
  const [hastaRep, setHastaRep] = useState("2025-11-30");

  // ====== Request manual ======
  const [manualPath, setManualPath] = useState("/wallet/mis-creditos");
  const [manualMethod, setManualMethod] = useState("GET");
  const [manualBody, setManualBody] = useState("{\n  \n}");

  useEffect(() => {
    if (token) localStorage.setItem("token", token);
  }, [token]);

  async function callApi(moduleName, actionName, path, options = {}) {
    setError("");
    setLastResponse(null);

    const method = options.method || "GET";
    const bodyObj = options.body || null;

    setLastRequest({
      moduleName,
      actionName,
      method,
      url: API_BASE_URL + path,
      body: bodyObj,
    });

    try {
      setLoading(true);

      const headers = {
        "Content-Type": "application/json",
        ...(options.headers || {}),
      };

      if (token) {
        headers.Authorization = `Bearer ${token}`;
      }

      const res = await fetch(API_BASE_URL + path, {
        method,
        headers,
        body:
          bodyObj && ["POST", "PUT", "PATCH"].includes(method)
            ? JSON.stringify(bodyObj)
            : undefined,
      });

      let rawText = "";
      let data = null;
      try {
        rawText = await res.text();
        data = rawText ? JSON.parse(rawText) : null;
      } catch {
        data = rawText;
      }

      setLastResponse({
        status: res.status,
        ok: res.ok,
        data,
      });

      if (!res.ok) {
        setError(`Respuesta con error HTTP ${res.status}`);
      }
    } catch (err) {
      setError(err.message || "Error en la llamada");
    } finally {
      setLoading(false);
    }
  }

  // ====== AUTH: registro ======
  async function handleRegister(e) {
    e.preventDefault();
    await callApi("Auth", "POST /auth/register", "/auth/register", {
      method: "POST",
      body: {
        nombre: regNombre,
        apellido: regApellido,
        correo: regCorreo,
        password: regPassword,
        telefono: regTelefono,
      },
    });
  }

  // ====== AUTH: login ======
  async function handleLogin(e) {
    e.preventDefault();
    setError("");
    try {
      setLoading(true);

      const res = await fetch(API_BASE_URL + "/auth/login", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          correo: loginCorreo,
          password: loginPassword,
        }),
      });

      let raw = "";
      let data = null;
      try {
        raw = await res.text();
        data = raw ? JSON.parse(raw) : null;
      } catch {
        data = raw;
      }

      setLastRequest({
        moduleName: "Auth",
        actionName: "POST /auth/login",
        method: "POST",
        url: API_BASE_URL + "/auth/login",
        body: { correo: loginCorreo, password: "***" },
      });
      setLastResponse({
        status: res.status,
        ok: res.ok,
        data,
      });

      if (!res.ok) {
        setError(`Login fallÃ³ con HTTP ${res.status}`);
        return;
      }

      if (data && data.token) {
        setToken(data.token);
      } else {
        setError("La respuesta de login no contiene token");
      }
    } catch (err) {
      setError(err.message || "Error en login");
    } finally {
      setLoading(false);
    }
  }

  // ====== REQUEST MANUAL ======
  async function handleManualCall(e) {
    e.preventDefault();
    let bodyParsed = null;
    if (manualMethod !== "GET" && manualBody.trim()) {
      try {
        bodyParsed = JSON.parse(manualBody);
      } catch {
        setError("El body manual no es JSON vÃ¡lido");
        return;
      }
    }
    await callApi(
      "Manual",
      `${manualMethod} ${manualPath}`,
      manualPath,
      {
        method: manualMethod,
        body: bodyParsed,
      }
    );
  }

  return (
    <div className="space-y-4">
      {/* HEADER */}
      <header className="flex flex-col sm:flex-row justify-between gap-3 items-start sm:items-center">
        <div>
          <h2 className="text-xl font-semibold text-gray-900">
            Laboratorio completo de Backend
          </h2>
          <p className="text-sm text-gray-500">
            Registro, login e interacciÃ³n con todos los mÃ³dulos del backend para
            comprobar si las rutas responden correctamente.
          </p>
          <p className="text-xs text-gray-400 mt-1">
            API_BASE_URL: <code>{API_BASE_URL}</code>
          </p>
        </div>
        <div className="text-right text-xs">
          <p className="font-semibold">Token actual:</p>
          <p className="truncate max-w-xs text-gray-500">
            {token ? token : "(sin token)"}
          </p>
          <button
            className="mt-1 text-xs text-red-600 underline"
            onClick={() => {
              setToken("");
              localStorage.removeItem("token");
            }}
          >
            Limpiar token
          </button>
          {loading && (
            <p className="mt-1 text-emerald-600 font-medium">
              Ejecutando request...
            </p>
          )}
        </div>
      </header>

      {error && (
        <div className="bg-red-50 border-red-200 border text-red-700 text-sm px-3 py-2 rounded">
          {error}
        </div>
      )}

      {/* =========================================================
          1. AUTH: REGISTRO / LOGIN / ME
         ========================================================= */}
      <section className="card space-y-3">
        <p className="text-xs font-semibold uppercase text-gray-500">
          1. AutenticaciÃ³n (Registro / Login / Perfil)
        </p>

        <div className="grid gap-3 md:grid-cols-2 text-xs">
          {/* REGISTRO */}
          <form onSubmit={handleRegister} className="space-y-2">
            <p className="font-semibold">Registro rÃ¡pido</p>
            <div>
              <label className="block mb-1 font-medium">Nombre</label>
              <input
                type="text"
                value={regNombre}
                onChange={(e) => setRegNombre(e.target.value)}
                className="w-full border rounded px-2 py-1"
              />
            </div>
            <div>
              <label className="block mb-1 font-medium">Apellido</label>
              <input
                type="text"
                value={regApellido}
                onChange={(e) => setRegApellido(e.target.value)}
                className="w-full border rounded px-2 py-1"
              />
            </div>
            <div>
              <label className="block mb-1 font-medium">Correo</label>
              <input
                type="email"
                value={regCorreo}
                onChange={(e) => setRegCorreo(e.target.value)}
                className="w-full border rounded px-2 py-1"
              />
            </div>
            <div>
              <label className="block mb-1 font-medium">TelÃ©fono</label>
              <input
                type="text"
                value={regTelefono}
                onChange={(e) => setRegTelefono(e.target.value)}
                className="w-full border rounded px-2 py-1"
              />
            </div>
            <div>
              <label className="block mb-1 font-medium">ContraseÃ±a</label>
              <input
                type="password"
                value={regPassword}
                onChange={(e) => setRegPassword(e.target.value)}
                className="w-full border rounded px-2 py-1"
              />
            </div>
            <button type="submit" className="btn-secondary">
              Registrar usuario
            </button>
          </form>

          {/* LOGIN */}
          <form onSubmit={handleLogin} className="space-y-2">
            <p className="font-semibold">Login</p>
            <div>
              <label className="block mb-1 font-medium">Correo</label>
              <input
                type="email"
                value={loginCorreo}
                onChange={(e) => setLoginCorreo(e.target.value)}
                className="w-full border rounded px-2 py-1"
              />
            </div>
            <div>
              <label className="block mb-1 font-medium">ContraseÃ±a</label>
              <input
                type="password"
                value={loginPassword}
                onChange={(e) => setLoginPassword(e.target.value)}
                className="w-full border rounded px-2 py-1"
              />
            </div>
            <button type="submit" className="btn-primary">
              Iniciar sesiÃ³n
            </button>

            <div className="mt-2">
              <button
                type="button"
                className="btn-secondary"
                onClick={() =>
                  callApi("Auth", "GET /auth/me", "/auth/me")
                }
              >
                Probar /auth/me
              </button>
            </div>
          </form>
        </div>

        {/* Usuarios / historial */}
        <div className="border-t pt-2 mt-2 text-xs">
          <p className="font-semibold mb-1">Usuarios / historial</p>
          <div className="flex flex-wrap gap-2 items-end">
            <button
              className="btn-secondary"
              onClick={() =>
                callApi("Usuarios", "GET /usuarios", "/usuarios")
              }
            >
              Listar /usuarios (ADMIN)
            </button>
            <div className="flex gap-2 items-end">
              <div>
                <label className="block mb-1 font-medium">
                  ID usuario para historial:
                </label>
                <input
                  type="number"
                  value={userIdHistorial}
                  onChange={(e) => setUserIdHistorial(e.target.value)}
                  className="border rounded px-2 py-1"
                  placeholder="Ej: 1"
                />
              </div>
              <button
                className="btn-secondary"
                onClick={() =>
                  userIdHistorial &&
                  callApi(
                    "Usuarios",
                    `GET /usuarios/${userIdHistorial}/historial`,
                    `/usuarios/${userIdHistorial}/historial`
                  )
                }
              >
                Ver historial
              </button>
            </div>
          </div>
        </div>
      </section>

      {/* =========================================================
          2. CATÃLOGOS
         ========================================================= */}
      <section className="card space-y-2">
        <p className="text-xs font-semibold uppercase text-gray-500">
          2. CatÃ¡logos
        </p>
        <div className="flex flex-wrap gap-2 text-xs">
          <button
            className="btn-secondary"
            onClick={() =>
              callApi("CatÃ¡logos", "GET /catalogos/categorias", "/catalogos/categorias")
            }
          >
            CategorÃ­as
          </button>
          <button
            className="btn-secondary"
            onClick={() =>
              callApi(
                "CatÃ¡logos",
                "GET /catalogos/paquetes-creditos",
                "/catalogos/paquetes-creditos"
              )
            }
          >
            Paquetes crÃ©ditos
          </button>
          <button
            className="btn-secondary"
            onClick={() =>
              callApi(
                "CatÃ¡logos",
                "GET /catalogos/tipos-actividad",
                "/catalogos/tipos-actividad"
              )
            }
          >
            Tipos actividad
          </button>
          <button
            className="btn-secondary"
            onClick={() =>
              callApi("CatÃ¡logos", "GET /catalogos/periodos", "/catalogos/periodos")
            }
          >
            Periodos
          </button>
          <button
            className="btn-secondary"
            onClick={() =>
              callApi(
                "CatÃ¡logos",
                "GET /catalogos/tipos-reporte",
                "/catalogos/tipos-reporte"
              )
            }
          >
            Tipos reporte
          </button>
        </div>
      </section>

      {/* =========================================================
          3. WALLET
         ========================================================= */}
      <section className="card space-y-2">
        <p className="text-xs font-semibold uppercase text-gray-500">
          3. Wallet / Billetera
        </p>
        <div className="flex flex-wrap gap-2 text-xs">
          <button
            className="btn-secondary"
            onClick={() =>
              callApi("Wallet", "GET /wallet/mis-creditos", "/wallet/mis-creditos")
            }
          >
            Mis crÃ©ditos
          </button>
          <button
            className="btn-secondary"
            onClick={() =>
              callApi(
                "Wallet",
                "GET /wallet/mis-movimientos",
                "/wallet/mis-movimientos"
              )
            }
          >
            Mis movimientos
          </button>
          <button
            className="btn-secondary"
            onClick={() =>
              callApi("Wallet", "GET /wallet/compras", "/wallet/compras")
            }
          >
            Mis compras
          </button>
        </div>

        <div className="grid gap-2 md:grid-cols-4 text-xs mt-3">
          <div>
            <label className="block mb-1 font-medium">ID Paquete</label>
            <input
              type="number"
              value={idPaquete}
              onChange={(e) => setIdPaquete(e.target.value)}
              className="w-full border rounded px-2 py-1"
            />
          </div>
          <div>
            <label className="block mb-1 font-medium">Monto pagado (Bs.)</label>
            <input
              type="number"
              value={montoPagado}
              onChange={(e) => setMontoPagado(e.target.value)}
              className="w-full border rounded px-2 py-1"
            />
          </div>
          <div>
            <label className="block mb-1 font-medium">Referencia pago</label>
            <input
              type="text"
              value={refPago}
              onChange={(e) => setRefPago(e.target.value)}
              className="w-full border rounded px-2 py-1"
            />
          </div>
                    <button
            className="btn-primary w-full"
            onClick={() =>
                callApi(
                "Wallet",
                "POST /wallet/compra-creditos",
                "/wallet/compra-creditos",
                {
                    method: "POST",
                    body: {
                    idPaquete: Number(idPaquete),
                    montoPagado: Number(montoPagado),
                    referenciaPago: refPago,
                    },
                }
                )
            }
            >
            Comprar crÃ©ditos
            </button>

        </div>
      </section>

      {/* =========================================================
          4. PUBLICACIONES
         ========================================================= */}
      <section className="card space-y-2">
        <p className="text-xs font-semibold uppercase text-gray-500">
          4. Publicaciones
        </p>
        <div className="flex flex-wrap gap-2 text-xs">
          <button
            className="btn-secondary"
            onClick={() =>
              callApi("Publicaciones", "GET /publicaciones", "/publicaciones")
            }
          >
            Listar /publicaciones
          </button>
          <button
            className="btn-secondary"
            onClick={() =>
              callApi(
                "Publicaciones",
                "GET /publicaciones/mias",
                "/publicaciones/mias"
              )
            }
          >
            Mis publicaciones
          </button>
          <button
            className="btn-secondary"
            onClick={() =>
              callApi(
                "Publicaciones",
                "GET /publicaciones/busqueda?q=bici",
                "/publicaciones/busqueda?q=bici"
              )
            }
          >
            Buscar (q=bici)
          </button>
        </div>
        <p className="text-xs text-gray-500 mt-1">
          âš ï¸ Para crear publicaciones de prueba con todos los campos (producto /
          servicio) es mÃ¡s cÃ³modo usar tu Postman o el mÃ³dulo de publicaciones del
          frontend final. AquÃ­ nos enfocamos en comprobar que los listados devuelven
          datos y no rompen.
        </p>
      </section>

      {/* =========================================================
          5. INTERCAMBIOS
         ========================================================= */}
      <section className="card space-y-2">
        <p className="text-xs font-semibold uppercase text-gray-500">
          5. Intercambios
        </p>
        <div className="flex flex-wrap gap-2 text-xs">
          <button
            className="btn-secondary"
            onClick={() =>
              callApi(
                "Intercambios",
                "GET /intercambios/mis-compras",
                "/intercambios/mis-compras"
              )
            }
          >
            Mis compras
          </button>
          <button
            className="btn-secondary"
            onClick={() =>
              callApi(
                "Intercambios",
                "GET /intercambios/mis-ventas",
                "/intercambios/mis-ventas"
              )
            }
          >
            Mis ventas
          </button>
        </div>

        <div className="grid gap-2 md:grid-cols-3 text-xs mt-3">
          <div>
            <label className="block mb-1 font-medium">ID PublicaciÃ³n</label>
            <input
              type="number"
              value={idPublicacionInter}
              onChange={(e) => setIdPublicacionInter(e.target.value)}
              className="w-full border rounded px-2 py-1"
            />
          </div>
          <div>
            <label className="block mb-1 font-medium">
              CrÃ©ditos a intercambiar
            </label>
            <input
              type="number"
              value={creditosInter}
              onChange={(e) => setCreditosInter(e.target.value)}
              className="w-full border rounded px-2 py-1"
            />
          </div>
          <div className="flex items-end">
            <button
              className="btn-primary w-full"
              onClick={() =>
                idPublicacionInter &&
                creditosInter &&
                callApi(
                  "Intercambios",
                  "POST /intercambios",
                  "/intercambios",
                  {
                    method: "POST",
                    body: {
                      id_publicacion: Number(idPublicacionInter),
                      creditos: Number(creditosInter),
                    },
                  }
                )
              }
            >
              Crear intercambio
            </button>
          </div>
        </div>
      </section>

      {/* =========================================================
          6. ACTIVIDADES SOSTENIBLES
         ========================================================= */}
      <section className="card space-y-2">
        <p className="text-xs font-semibold uppercase text-gray-500">
          6. Actividades sostenibles
        </p>
        <div className="flex flex-wrap gap-2 text-xs">
          <button
            className="btn-secondary"
            onClick={() =>
              callApi(
                "Actividades",
                "GET /actividades-sostenibles/mias",
                "/actividades-sostenibles/mias"
              )
            }
          >
            Mis actividades
          </button>
        </div>

        <div className="grid gap-2 md:grid-cols-4 text-xs mt-3">
          <div>
            <label className="block mb-1 font-medium">ID tipo actividad</label>
            <input
              type="number"
              value={idTipoAct}
              onChange={(e) => setIdTipoAct(e.target.value)}
              className="w-full border rounded px-2 py-1"
            />
          </div>
          <div>
            <label className="block mb-1 font-medium">CrÃ©ditos otorgados</label>
            <input
              type="number"
              value={credAct}
              onChange={(e) => setCredAct(e.target.value)}
              className="w-full border rounded px-2 py-1"
            />
          </div>
          <div className="md:col-span-2">
            <label className="block mb-1 font-medium">DescripciÃ³n</label>
            <input
              type="text"
              value={descAct}
              onChange={(e) => setDescAct(e.target.value)}
              className="w-full border rounded px-2 py-1"
            />
          </div>
          <div className="md:col-span-4 flex justify-end">
            <button
              className="btn-primary"
              onClick={() =>
                callApi(
                  "Actividades",
                  "POST /actividades-sostenibles",
                  "/actividades-sostenibles",
                  {
                    method: "POST",
                    body: {
                      id_tipo_actividad: Number(idTipoAct),
                      descripcion: descAct,
                      creditos_otorgados: Number(credAct),
                      evidencia_url: null,
                    },
                  }
                )
              }
            >
              Registrar actividad
            </button>
          </div>
        </div>
      </section>

      {/* =========================================================
          7. PUBLICIDAD / PROMOS / LOGROS / PREMIUM
         ========================================================= */}
      <section className="card space-y-2">
        <p className="text-xs font-semibold uppercase text-gray-500">
          7. Publicidad / Promos / Logros / Premium
        </p>
        <div className="flex flex-wrap gap-2 text-xs">
          <button
            className="btn-secondary"
            onClick={() =>
              callApi("Publicidad", "GET /publicidad", "/publicidad")
            }
          >
            Publicidad activa
          </button>
          <button
            className="btn-secondary"
            onClick={() =>
              callApi(
                "Promociones",
                "GET /promociones/vigentes",
                "/promociones/vigentes"
              )
            }
          >
            Promos vigentes
          </button>
          <button
            className="btn-secondary"
            onClick={() =>
              callApi("Logros", "GET /logros/mis-logros", "/logros/mis-logros")
            }
          >
            Mis logros
          </button>
          <button
            className="btn-secondary"
            onClick={() =>
              callApi("Premium", "GET /premium/mi-plan", "/premium/mi-plan")
            }
          >
            Mi plan premium
          </button>
        </div>
      </section>

      {/* =========================================================
          8. REPORTES
         ========================================================= */}
      <section className="card space-y-2">
        <p className="text-xs font-semibold uppercase text-gray-500">
          8. Reportes (ADMIN)
        </p>

        <div className="grid gap-2 md:grid-cols-3 text-xs">
          <div>
            <label className="block mb-1 font-medium">Desde</label>
            <input
              type="date"
              value={desdeRep}
              onChange={(e) => setDesdeRep(e.target.value)}
              className="w-full border rounded px-2 py-1"
            />
          </div>
          <div>
            <label className="block mb-1 font-medium">Hasta</label>
            <input
              type="date"
              value={hastaRep}
              onChange={(e) => setHastaRep(e.target.value)}
              className="w-full border rounded px-2 py-1"
            />
          </div>
        </div>

        <div className="flex flex-wrap gap-2 text-xs mt-3">
          <button
            className="btn-secondary"
            onClick={() =>
              callApi(
                "Reportes",
                "GET /reportes/usuarios-activos",
                `/reportes/usuarios-activos?desde=${desdeRep}&hasta=${hastaRep}`
              )
            }
          >
            Usuarios activos
          </button>
          <button
            className="btn-secondary"
            onClick={() =>
              callApi(
                "Reportes",
                "GET /reportes/usuarios-abandonados",
                `/reportes/usuarios-abandonados?desde=${desdeRep}&hasta=${hastaRep}`
              )
            }
          >
            Usuarios abandonados
          </button>
          <button
            className="btn-secondary"
            onClick={() =>
              callApi(
                "Reportes",
                "GET /reportes/ingresos-creditos",
                `/reportes/ingresos-creditos?desde=${desdeRep}&hasta=${hastaRep}`
              )
            }
          >
            Ingresos crÃ©ditos
          </button>
          <button
            className="btn-secondary"
            onClick={() =>
              callApi(
                "Reportes",
                "GET /reportes/creditos-generados-consumidos",
                `/reportes/creditos-generados-consumidos?desde=${desdeRep}&hasta=${hastaRep}`
              )
            }
          >
            CrÃ©ditos gen. vs cons.
          </button>
          <button
            className="btn-secondary"
            onClick={() =>
              callApi(
                "Reportes",
                "GET /reportes/intercambios-categoria",
                `/reportes/intercambios-categoria?desde=${desdeRep}&hasta=${hastaRep}`
              )
            }
          >
            Intercambios x categorÃ­a
          </button>
          <button
            className="btn-secondary"
            onClick={() =>
              callApi(
                "Reportes",
                "GET /reportes/publicaciones-intercambios",
                `/reportes/publicaciones-intercambios?desde=${desdeRep}&hasta=${hastaRep}`
              )
            }
          >
            Publ. vs intercambios
          </button>
          <button
            className="btn-secondary"
            onClick={() =>
                callApi(
                "Reportes",
                "GET /reportes/impacto-acumulado",
                `/reportes/impacto-acumulado?id_tipo_reporte=1&id_periodo=1`
                )
            }
            >
            Impacto acumulado
</button>

          <button
  className="btn-secondary"
  onClick={() =>
    callApi(
      "Reportes",
      "GET /reportes/ranking-usuarios",
      `/reportes/ranking-usuarios?id_periodo=1&limit=10`
    )
  }
>
  Ranking usuarios
</button>

        </div>
      </section>

      {/* =========================================================
          9. REQUEST MANUAL
         ========================================================= */}
      <section className="card space-y-2">
        <p className="text-xs font-semibold uppercase text-gray-500">
          9. Request manual (cualquier endpoint)
        </p>
        <form onSubmit={handleManualCall} className="space-y-2 text-xs">
          <div className="flex gap-2">
            <select
              value={manualMethod}
              onChange={(e) => setManualMethod(e.target.value)}
              className="border rounded px-2 py-1"
            >
              <option>GET</option>
              <option>POST</option>
              <option>PUT</option>
              <option>PATCH</option>
              <option>DELETE</option>
            </select>
            <input
              type="text"
              value={manualPath}
              onChange={(e) => setManualPath(e.target.value)}
              className="flex-1 border rounded px-2 py-1"
              placeholder="/ruta/del/endpoint"
            />
            <button type="submit" className="btn-primary">
              Ejecutar
            </button>
          </div>
          {manualMethod !== "GET" && (
            <textarea
              rows={4}
              value={manualBody}
              onChange={(e) => setManualBody(e.target.value)}
              className="w-full border rounded px-2 py-1 font-mono"
            />
          )}
        </form>
      </section>

      {/* =========================================================
          PANEL DE RESULTADOS
         ========================================================= */}
      <section className="card space-y-2">
        <p className="text-xs font-semibold uppercase text-gray-500">
          Resultado de la Ãºltima llamada
        </p>

        {lastRequest ? (
          <div className="text-xs space-y-1">
            <p>
              <span className="font-semibold">MÃ³dulo:</span>{" "}
              {lastRequest.moduleName}
            </p>
            <p>
              <span className="font-semibold">AcciÃ³n:</span>{" "}
              {lastRequest.actionName}
            </p>
            <p>
              <span className="font-semibold">MÃ©todo:</span>{" "}
              {lastRequest.method}
            </p>
            <p>
              <span className="font-semibold">URL:</span>{" "}
              <code>{lastRequest.url}</code>
            </p>
            {lastRequest.body && (
              <details className="mt-1">
                <summary className="cursor-pointer text-gray-600">
                  Body enviado
                </summary>
                <pre className="bg-gray-50 border rounded p-2 mt-1 overflow-x-auto">
{JSON.stringify(lastRequest.body, null, 2)}
                </pre>
              </details>
            )}
          </div>
        ) : (
          <p className="text-xs text-gray-400">
            AÃºn no ejecutaste ninguna llamada.
          </p>
        )}

        {lastResponse && (
          <div className="mt-3 text-xs">
            <p>
              <span className="font-semibold">Status:</span>{" "}
              {lastResponse.status}{" "}
              {lastResponse.ok ? "(OK)" : "(Error)"}
            </p>
            <details className="mt-1" open>
              <summary className="cursor-pointer text-gray-600">
                Ver JSON de respuesta
              </summary>
              <pre className="bg-gray-50 border rounded p-2 mt-1 overflow-x-auto">
{JSON.stringify(lastResponse.data, null, 2)}
              </pre>
            </details>
          </div>
        )}
      </section>
    </div>
  );
}
</file>

<file path="frontend/src/pages/ComprarCreditos.jsx">
// frontend/src/pages/ComprarCreditos.jsx
import { useEffect, useState, useMemo } from "react";
import { useNavigate } from "react-router-dom";
import {
  getPaquetesCreditos,
  crearCompraCreditos,
  getMisCreditos,
} from "../services/api";
import { ArrowLeft, Wallet, CheckCircle } from "lucide-react";
import hoja from "../assets/hoja.png";

export default function ComprarCreditos() {
  const [paquetes, setPaquetes] = useState([]);
  const [selectedId, setSelectedId] = useState(null);
  const [saldoActual, setSaldoActual] = useState(0);
  const [medioPago, setMedioPago] = useState("tigo");
  const [loading, setLoading] = useState(false);
  const [successMsg, setSuccessMsg] = useState("");
  const [errorMsg, setErrorMsg] = useState("");
  const navigate = useNavigate();

  const paqueteSeleccionado = useMemo(
    () => paquetes.find((p) => p.id_paquete === selectedId) || null,
    [paquetes, selectedId]
  );

  // Cargar saldo y paquetes
  useEffect(() => {
    async function cargarDatos() {
      try {
        setErrorMsg("");
        const [saldoRes, paquetesRes] = await Promise.all([
          getMisCreditos(),
          getPaquetesCreditos(),
        ]);

        const saldo =
          saldoRes?.data?.saldo ??
          saldoRes?.saldo ??
          0;

        const lista =
          paquetesRes?.data && Array.isArray(paquetesRes.data)
            ? paquetesRes.data
            : Array.isArray(paquetesRes)
            ? paquetesRes
            : [];

        setSaldoActual(Number(saldo) || 0);

        // Solo paquetes activos (activo = 1)
        const activos = lista.filter(
          (p) => p.activo === 1 || p.activo === true || p.activo === "1"
        );
        setPaquetes(activos);
      } catch (err) {
        console.error(err);
        setErrorMsg("No se pudieron cargar los datos de la billetera.");
      }
    }

    cargarDatos();
  }, []);

  async function handleComprar() {
    try {
      setErrorMsg("");
      setSuccessMsg("");

      if (!paqueteSeleccionado) {
        setErrorMsg("Debes seleccionar un paquete de crÃ©ditos.");
        return;
      }

      setLoading(true);

      await crearCompraCreditos({
        idPaquete: paqueteSeleccionado.id_paquete,
        // por ahora dejamos idTransaccionPago null, en un futuro se integra el gateway real
        idTransaccionPago: null,
      });

      setSuccessMsg(
        `Compra realizada correctamente. Se acreditarÃ¡n ${paqueteSeleccionado.cantidad_creditos} crÃ©ditos a tu billetera.`
      );

      // Refrescar saldo
      try {
        const saldoRes = await getMisCreditos();
        const saldo =
          saldoRes?.data?.saldo ??
          saldoRes?.saldo ??
          0;
        setSaldoActual(Number(saldo) || 0);
      } catch (e) {
        console.warn("No se pudo refrescar el saldo luego de la compra.", e);
      }
    } catch (err) {
      console.error(err);
      const msgBackend =
        err?.message ||
        err?.response?.data?.message ||
        "OcurriÃ³ un error al intentar registrar la compra.";
      setErrorMsg(msgBackend);
    } finally {
      setLoading(false);
    }
  }

  function handleVolver() {
    navigate("/wallet");
  }

  return (
    <div className="min-h-screen bg-gradient-to-br from-[#04210f] via-[#06351a] to-[#041810] flex items-center justify-center px-4 py-6 text-white">
      {/* Contenedor tipo "modal" */}
      <div className="relative w-full max-w-5xl rounded-3xl bg-gradient-to-br from-[#0b3b24] via-[#0f4a2f] to-[#0a2a1c] shadow-2xl border border-emerald-500/60 overflow-hidden">
        {/* BotÃ³n volver */}
        <button
          onClick={handleVolver}
          className="absolute top-4 left-4 inline-flex items-center gap-2 text-sm text-emerald-50/80 hover:text-white hover:-translate-x-0.5 transition-transform"
        >
          <ArrowLeft size={18} />
          Volver a mi billetera
        </button>

        {/* Contenido principal */}
        <div className="px-8 pt-10 pb-6 md:px-10 md:pt-12 md:pb-8">
          {/* Header */}
          <div className="flex items-center justify-between gap-4 mb-6">
            <div className="flex items-center gap-4">
              <div className="w-12 h-12 rounded-2xl bg-emerald-500/20 border border-emerald-400/70 flex items-center justify-center">
                <Wallet className="text-amber-300" size={26} />
              </div>
              <div>
                <p className="text-xs uppercase tracking-[0.18em] text-emerald-200/80 font-semibold">
                  Mi Perfil
                </p>
                <h1 className="text-2xl md:text-3xl font-extrabold leading-tight">
                  Obtener CrÃ©ditos
                </h1>
                <p className="text-sm text-emerald-100/70">
                  Recarga tu billetera y sigue generando impacto ambiental.
                </p>
              </div>
            </div>

            {/* Saldo actual */}
            <div className="hidden sm:flex flex-col items-end bg-black/15 border border-emerald-400/40 px-4 py-3 rounded-2xl">
              <span className="text-xs uppercase tracking-[0.18em] text-emerald-200/80 font-semibold">
                SALDO ACTUAL
              </span>
              <p className="flex items-baseline gap-2 mt-1">
                <span className="text-2xl font-black">
                  {saldoActual.toLocaleString("es-BO")}
                </span>
                <span className="text-sm text-emerald-100/80">crÃ©ditos</span>
              </p>
            </div>
          </div>

          {/* Panel principal */}
          <div className="grid grid-cols-1 lg:grid-cols-[2fr,1.2fr] gap-6">
            {/* Columna izquierda: paquetes */}
            <div className="bg-black/15 rounded-3xl border border-emerald-500/40 p-5 md:p-6">
              {/* CrÃ©ditos obtenidos (segÃºn selecciÃ³n) */}
              <div className="mb-5">
                <p className="text-xs uppercase tracking-[0.2em] text-emerald-200/80 font-semibold">
                  CrÃ©ditos obtenidos
                </p>
                <div className="flex items-end gap-2 mt-1">
                  <span className="text-3xl md:text-4xl font-extrabold">
                    {paqueteSeleccionado
                      ? paqueteSeleccionado.cantidad_creditos.toLocaleString(
                          "es-BO"
                        )
                      : "0"}
                  </span>
                  <span className="text-sm text-emerald-100/80 mb-1">
                    crÃ©ditos
                  </span>
                </div>
                <p className="text-xs text-emerald-100/70 mt-1">
                  Selecciona un paquete para ver cuÃ¡ntos crÃ©ditos obtendrÃ¡s.
                </p>
              </div>

              {/* Recarga monedas */}
              <div className="mb-3 flex items-center justify-between">
                <div>
                  <h2 className="text-sm font-semibold tracking-wide uppercase text-emerald-50">
                    Recarga Monedas
                  </h2>
                  <p className="text-xs text-emerald-100/70">
                    Elige el paquete que mejor se adapte a ti.
                  </p>
                </div>
              </div>

              <div className="grid grid-cols-2 md:grid-cols-4 gap-3">
                {paquetes.map((p) => {
                  const isSelected = p.id_paquete === selectedId;

                  return (
                    <button
                      key={p.id_paquete}
                      type="button"
                      onClick={() => setSelectedId(p.id_paquete)}
                      className={`relative flex flex-col items-center justify-between rounded-2xl border px-3 py-3 transition-all ${
                        isSelected
                          ? "border-amber-300 bg-emerald-600/70 shadow-lg shadow-amber-500/25 scale-[1.02]"
                          : "border-emerald-400/50 bg-emerald-700/40 hover:border-amber-300/80 hover:bg-emerald-600/60"
                      }`}
                    >
                      {/* Icono */} 
                      <div className="flex flex-col items-center gap-1">
                        <div className="w-9 h-9 rounded-full bg-emerald-900/50 border border-amber-300/70 flex items-center justify-center">
                          <img src={hoja} alt="CrÃ©ditos verdes" className="w-5 h-5 object-contain" />
                        </div>
                        <p className="text-base font-bold mt-1">{p.cantidad_creditos}</p>
                        <p className="text-[11px] text-emerald-100/80">{p.nombre}</p>
                      </div>

                      <div className="mt-1 text-xs font-semibold text-amber-200">
                        Bs {Number(p.precio_bs).toFixed(2)}
                      </div>
                    </button>
                  );
                })}

                {paquetes.length === 0 && (
                  <p className="col-span-full text-sm text-emerald-100/70">
                    No hay paquetes de crÃ©ditos configurados en el sistema.
                  </p>
                )}
              </div>
            </div>

            {/* Columna derecha: medio de pago y resumen */}
            <div className="bg-black/20 rounded-3xl border border-emerald-500/40 flex flex-col justify-between p-5 md:p-6">
              <div>
                <h2 className="text-sm font-semibold tracking-wide uppercase text-emerald-50 mb-2">
                  Seleccione forma de pago
                </h2>

                <div className="space-y-3">
                  <button
                    type="button"
                    onClick={() => setMedioPago("tigo")}
                    className={`flex items-center gap-3 w-full rounded-2xl border px-3 py-2.5 text-left text-sm transition-all ${
                      medioPago === "tigo"
                        ? "border-amber-300 bg-emerald-700/70 shadow-md"
                        : "border-emerald-400/50 bg-emerald-800/30 hover:border-amber-200/80"
                    }`}
                  >
                    <div className="w-9 h-9 rounded-xl bg-emerald-900/70 flex items-center justify-center text-xs font-bold">
                      TM
                    </div>
                    <div>
                      <p className="font-semibold">Banca / Tigo Money</p>
                      <p className="text-xs text-emerald-100/75">
                        Pago con billeteras digitales y banca en lÃ­nea.
                      </p>
                    </div>
                  </button>

                  <button
                    type="button"
                    onClick={() => setMedioPago("qr")}
                    className={`flex items-center gap-3 w-full rounded-2xl border px-3 py-2.5 text-left text-sm transition-all ${
                      medioPago === "qr"
                        ? "border-amber-300 bg-emerald-700/70 shadow-md"
                        : "border-emerald-400/50 bg-emerald-800/30 hover:border-amber-200/80"
                    }`}
                  >
                    <div className="w-9 h-9 rounded-xl bg-emerald-900/70 flex items-center justify-center text-[10px] font-bold">
                      QR
                    </div>
                    <div>
                      <p className="font-semibold">Generar QR</p>
                      <p className="text-xs text-emerald-100/75">
                        Paga escaneando con tu app bancaria (BNB, YapE, etc.).
                      </p>
                    </div>
                  </button>
                </div>

                <div className="mt-4 text-xs text-emerald-100/70 space-y-1.5">
                  <p className="flex items-center gap-2">
                    <CheckCircle size={14} className="text-emerald-300" />
                    Tus crÃ©ditos se acreditarÃ¡n automÃ¡ticamente una vez
                    confirmado el pago.
                  </p>
                  <p className="flex items-center gap-2">
                    <CheckCircle size={14} className="text-emerald-300" />
                    PodrÃ¡s ver el movimiento en tu historial de billetera.
                  </p>
                </div>
              </div>

              {/* Mensajes y botÃ³n */}
              <div className="mt-4 pt-3 border-t border-emerald-500/30">
                {errorMsg && (
                  <div className="mb-2 text-xs text-red-200 bg-red-900/40 border border-red-500/40 rounded-xl px-3 py-2">
                    {errorMsg}
                  </div>
                )}
                {successMsg && (
                  <div className="mb-2 text-xs text-emerald-50 bg-emerald-800/60 border border-emerald-300/60 rounded-xl px-3 py-2 flex gap-2">
                    <CheckCircle size={14} className="mt-[2px]" />
                    <span>{successMsg}</span>
                  </div>
                )}

                <button
                  type="button"
                  disabled={loading || !paqueteSeleccionado}
                  onClick={handleComprar}
                  className="w-full inline-flex items-center justify-center gap-2 rounded-2xl bg-amber-400 hover:bg-amber-300 text-[#123020] font-semibold py-2.5 text-sm shadow-lg shadow-amber-500/25 disabled:opacity-60 disabled:cursor-not-allowed"
                >
                  {loading ? "Procesando..." : "Comprar ahora"}
                </button>

                <p className="mt-2 text-[11px] text-emerald-100/70 text-center">
                  Al continuar aceptas los tÃ©rminos de uso de crÃ©ditos de la
                  plataforma.
                </p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  );
}
</file>

<file path="frontend/src/pages/EditarPerfil.jsx">
import React, { useEffect, useState } from "react";
import { api } from "../services/api";
import hoja from "../assets/hoja.png";

export default function EditarPerfil() {
  const [usuario, setUsuario] = useState(null);

  const [nombre, setNombre] = useState("");
  const [correo, setCorreo] = useState("");
  const [telefono, setTelefono] = useState("");
  const [password, setPassword] = useState("");

  const [fotoPreview, setFotoPreview] = useState(null);
  const [fotoArchivo, setFotoArchivo] = useState(null);

  useEffect(() => {
    cargarDatos();
  }, []);

  async function cargarDatos() {
    try {
      const data = await api("/auth/me");  // âœ… ESTA ES LA RUTA CORRECTA
      setUsuario(data);

      setNombre(data.nombre || "");
      setCorreo(data.correo || "");
      setTelefono(data.telefono || "");
      setFotoPreview(data.foto || null);

    } catch (error) {
      console.error("Error al cargar perfil:", error);
    }
  }

  async function guardarCambios(e) {
    e.preventDefault();

    try {
      let fotoURL = fotoPreview;

      // Si se eligiÃ³ una nueva foto, subirla
      if (fotoArchivo) {
        const formData = new FormData();
        formData.append("archivo", fotoArchivo);

        const uploadRes = await api("/uploads", {
          method: "POST",
          body: formData,
        });

        fotoURL = uploadRes.url;
      }

      // Actualizar datos del usuario
      await api("/auth/me", {
        method: "PUT",
        body: {
          nombre,
          correo,
          telefono,
          foto: fotoURL,
          password: password || undefined, // si estÃ¡ vacÃ­o no lo envÃ­a
        },
      });

      alert("Perfil actualizado correctamente");
      window.location.href = "/perfil";

    } catch (error) {
      console.error("Error guardando perfil:", error);
      alert("Hubo un error al actualizar el perfil");
    }
  }

  if (!usuario) {
    return (
      <div className="min-h-screen bg-[#082b1f] text-white flex items-center justify-center">
        Cargando perfil...
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-[#082b1f] text-white p-6 md:p-10">

      {/* HEADER */}
      <div className="flex items-center gap-3 mb-10">
        <img src={hoja} alt="logo" className="w-12 h-12 drop-shadow-lg" />
        <h1 className="text-3xl font-bold text-emerald-400">
          Editar Perfil
        </h1>
      </div>

      {/* FORMULARIO */}
      <form
        onSubmit={guardarCambios}
        className="bg-[#0e4330] p-8 rounded-xl border border-emerald-500 shadow-xl max-w-2xl mx-auto"
      >

        {/* FOTO */}
        <div className="flex flex-col items-center mb-8">
          <img
            src={fotoPreview || "https://via.placeholder.com/120"}
            className="w-32 h-32 rounded-full object-cover border-4 border-emerald-500 shadow-lg"
          />

          <label
            className="mt-4 cursor-pointer bg-emerald-500 hover:bg-emerald-600 px-4 py-2 rounded-lg font-semibold transition"
          >
            Cambiar foto
            <input
              type="file"
              className="hidden"
              accept="image/*"
              onChange={(e) => {
                setFotoArchivo(e.target.files[0]);
                setFotoPreview(URL.createObjectURL(e.target.files[0]));
              }}
            />
          </label>
        </div>

        {/* NOMBRE */}
        <div className="mb-5">
          <label className="text-emerald-300 font-semibold">Nombre</label>
          <input
            type="text"
            value={nombre}
            onChange={(e) => setNombre(e.target.value)}
            className="w-full mt-1 bg-[#0f3f2d] text-white px-4 py-2 rounded-lg 
                       border border-emerald-500 outline-none focus:ring-2 
                       focus:ring-emerald-400"
          />
        </div>

        {/* CORREO */}
        <div className="mb-5">
          <label className="text-emerald-300 font-semibold">Correo</label>
          <input
            type="email"
            value={correo}
            onChange={(e) => setCorreo(e.target.value)}
            className="w-full mt-1 bg-[#0f3f2d] text-white px-4 py-2 rounded-lg 
                       border border-emerald-500 outline-none focus:ring-2 
                       focus:ring-emerald-400"
          />
        </div>

        {/* TELEFONO */}
        <div className="mb-5">
          <label className="text-emerald-300 font-semibold">TelÃ©fono</label>
          <input
            type="text"
            value={telefono}
            onChange={(e) => setTelefono(e.target.value)}
            className="w-full mt-1 bg-[#0f3f2d] text-white px-4 py-2 rounded-lg 
                       border border-emerald-500 outline-none focus:ring-2 
                       focus:ring-emerald-400"
          />
        </div>

        {/* PASSWORD (opcional) */}
        <div className="mb-5">
          <label className="text-emerald-300 font-semibold">
            Nueva contraseÃ±a (opcional)
          </label>
          <input
            type="password"
            value={password}
            onChange={(e) => setPassword(e.target.value)}
            placeholder="Dejar vacÃ­o si no deseas cambiarla"
            className="w-full mt-1 bg-[#0f3f2d] text-white px-4 py-2 rounded-lg 
                       border border-emerald-500 outline-none focus:ring-2 
                       focus:ring-emerald-400"
          />
        </div>

        {/* BOTONES */}
        <div className="flex justify-between mt-8">
          <a
            href="/perfil"
            className="px-5 py-2 rounded-lg bg-gray-600 hover:bg-gray-700 
                       transition font-semibold"
          >
            Cancelar
          </a>

          <button
            type="submit"
            className="px-6 py-2 rounded-lg bg-emerald-500 hover:bg-emerald-600 
                       transition font-semibold"
          >
            Guardar Cambios
          </button>
        </div>

      </form>
    </div>
  );
}
</file>

<file path="frontend/src/pages/HistorialCompras.jsx">
import React, { useEffect, useState } from "react";
import { useNavigate } from "react-router-dom";
import hoja from "../assets/hoja.png";
import { getMisComprasCreditos } from "../services/api";

export default function HistorialCompras() {
  const [compras, setCompras] = useState([]);
  const [cargando, setCargando] = useState(true);
  const [error, setError] = useState("");
  const navigate = useNavigate();

  useEffect(() => {
    cargar();
  }, []);

  async function cargar() {
    try {
      setCargando(true);
      setError("");
      const data = await getMisComprasCreditos();
      setCompras(Array.isArray(data) ? data : []);
    } catch (err) {
      console.error(err);
      setError("Error al cargar el historial de compras de crÃ©ditos.");
      setCompras([]);
    } finally {
      setCargando(false);
    }
  }

  if (cargando) {
    return (
      <div className="min-h-screen bg-[#082b1f] text-white flex items-center justify-center">
        Cargando historial de compras.
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-[#082b1f] text-white p-6 md:p-10">
      {/* HEADER */}
      <div className="flex items-center justify-between mb-8">
        <div className="flex items-center gap-3">
          <button
            className="bg-black/30 hover:bg-black/40 px-3 py-1 rounded-full text-xs"
            onClick={() => navigate(-1)}
          >
            Volver
          </button>
          <h1 className="text-2xl font-semibold text-emerald-300">
            Historial de compras de crÃ©ditos
          </h1>
        </div>
        <img src={hoja} alt="logo" className="w-9 h-9 drop-shadow-md" />
      </div>

      {error && (
        <div className="mb-4 rounded-md border border-red-400 bg-red-900/40 px-4 py-2 text-sm text-red-100">
          {error}
        </div>
      )}

      {/* TABLA */}
      <div className="bg-[#0f3f2d] border border-emerald-700 rounded-2xl p-4 md:p-6 shadow-lg">
        <div className="overflow-x-auto">
          <table className="min-w-full text-sm">
            <thead>
              <tr className="text-left text-emerald-200 border-b border-emerald-700/60">
                <th className="px-3 py-2">Fecha</th>
                <th className="px-3 py-2">Paquete</th>
                <th className="px-3 py-2 text-right">CrÃ©ditos</th>
                <th className="px-3 py-2 text-right">Monto (Bs)</th>
                <th className="px-3 py-2 text-right">Estado</th>
              </tr>
            </thead>
            <tbody>
              {compras.map((c) => (
                <tr
                  key={c.id_compra}
                  className="border-b border-emerald-800/40 last:border-0"
                >
                  <td className="px-3 py-2">
                    {c.creado_en
                      ? new Date(c.creado_en).toLocaleString()
                      : ""}
                  </td>
                  <td className="px-3 py-2">{c.paquete}</td>
                  <td className="px-3 py-2 text-right">
                    {c.cantidad_creditos}
                  </td>
                  <td className="px-3 py-2 text-right">
                    {c.monto_bs?.toFixed
                      ? c.monto_bs.toFixed(2)
                      : Number(c.monto_bs || 0).toFixed(2)}
                  </td>
                  <td className="px-3 py-2 text-right">
                    <span className="px-2 py-0.5 rounded-full text-xs bg-black/30 border border-emerald-500/60">
                      {c.estado}
                    </span>
                  </td>
                </tr>
              ))}

              {compras.length === 0 && (
                <tr>
                  <td
                    colSpan={5}
                    className="px-3 py-4 text-center text-emerald-100/70"
                  >
                    No tienes compras de crÃ©ditos registradas todavÃ­a.
                  </td>
                </tr>
              )}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  );
}
</file>

<file path="frontend/src/pages/Home.jsx">
// frontend/src/pages/Home.jsx
import React, { useEffect, useState } from "react";
import { useNavigate } from "react-router-dom";
import hoja from "../assets/hoja.png";
import { api } from "../services/api";

export default function Home() {
  const [estado, setEstado] = useState(null);
  const [misCreditos, setMisCreditos] = useState(0);
  const [actividadReciente, setActividadReciente] = useState([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState("");

  const navigate = useNavigate();

  useEffect(() => {
    cargarTodo();
  }, []);

  async function cargarTodo() {
    try {
      setLoading(true);
      setError("");

      const estadoRes = await api("/health");
      setEstado(estadoRes);

      const creditos = await api("/wallet/mis-creditos");

      const saldo =
        creditos?.saldo_creditos ??
        creditos?.saldo ??
        creditos?.creditos ??
        0;

      setMisCreditos(Number(saldo) || 0);

      const act = await api("/wallet/mis-movimientos");
      setActividadReciente(Array.isArray(act) ? act.slice(0, 8) : []);
    } catch (err) {
      console.error(err);
      setError("No se pudo cargar la informaciÃ³n de inicio.");
    } finally {
      setLoading(false);
    }
  }

  // MISMA LÃ“GICA QUE EN Movimientos.jsx: NO CAMBIAMOS HUSO HORARIO
  const formatFechaMovimiento = (raw) => {
    if (!raw) return "";

    if (typeof raw === "string") {
      const clean = raw.replace("T", " ").replace("Z", "").trim();
      const [datePart, timePart] = clean.split(" ");
      if (!datePart) return raw;

      const [year, month, day] = datePart.split("-");
      if (!timePart) return `${day}/${month}/${year}`;

      const [hh, mm] = timePart.split(":");
      return `${day}/${month}/${year}, ${hh}:${mm} p. m.`; // solo reordenamos texto
    }

    const d = raw instanceof Date ? raw : new Date(raw);
    if (Number.isNaN(d.getTime())) return "";
    return d.toLocaleString("es-BO", {
      day: "2-digit",
      month: "2-digit",
      year: "numeric",
      hour: "2-digit",
      minute: "2-digit",
    });
  };

  if (loading) {
    return (
      <div className="min-h-screen flex items-center justify-center bg-[#082b1f] text-white">
        Cargando inicio...
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-[#082b1f] text-white p-4 md:p-8">
      {/* HEADER */}
      <header className="flex items-center justify-between mb-8">
        <div>
          <h1 className="text-2xl md:text-3xl font-bold text-emerald-300">
            Bienvenido a CrÃ©ditos Verdes
          </h1>
          <p className="text-sm text-emerald-100/80">
            Plataforma de economÃ­a circular y sostenibilidad.
          </p>
        </div>
        <img src={hoja} alt="logo" className="w-10 h-10 drop-shadow-lg" />
      </header>

      {/* ESTADO API + SALDO */}
      <section className="grid gap-4 md:grid-cols-3 mb-8">
        <div className="bg-[#0f3f2d] rounded-xl p-5 border border-emerald-700 shadow-md">
          <p className="text-sm text-emerald-200 mb-1">Estado del sistema</p>
          <p className="text-lg font-semibold text-emerald-300">
            {estado?.ok ? "Online" : "Offline"}
          </p>
          {estado && (
            <p className="text-xs text-emerald-100/70 mt-1">
              {estado.message || ""}
            </p>
          )}
        </div>

        <div className="bg-[#0f3f2d] rounded-xl p-5 border border-emerald-700 shadow-md">
          <p className="text-sm text-emerald-200 mb-1">Mis crÃ©ditos</p>
          <p className="text-3xl font-bold text-emerald-300">
            {misCreditos.toLocaleString("es-BO")}
          </p>
          <button
            onClick={() => navigate("/wallet")}
            className="mt-3 text-xs bg-emerald-500 hover:bg-emerald-600 text-emerald-950 px-3 py-1.5 rounded-lg font-semibold"
          >
            Ver mi billetera
          </button>
        </div>

        <div className="bg-[#0f3f2d] rounded-xl p-5 border border-emerald-700 shadow-md">
          <p className="text-sm text-emerald-200 mb-1">Accesos rÃ¡pidos</p>
          <div className="flex flex-wrap gap-2 mt-2 text-xs">
            <button
              className="bg-emerald-600 hover:bg-emerald-500 px-3 py-1 rounded-lg"
              onClick={() => navigate("/publicaciones")}
            >
              Publicaciones
            </button>
            <button
              className="bg-emerald-600 hover:bg-emerald-500 px-3 py-1 rounded-lg"
              onClick={() => navigate("/actividades")}
            >
              Actividades
            </button>
            <button
              className="bg-emerald-600 hover:bg-emerald-500 px-3 py-1 rounded-lg"
              onClick={() => navigate("/reportes")}
            >
              Reportes
            </button>
          </div>
        </div>
      </section>

      {/* ACTIVIDAD RECIENTE */}
      <section className="bg-[#0f3f2d] rounded-xl p-5 border border-emerald-700 shadow-md">
        <div className="flex items-center justify-between mb-3">
          <h2 className="text-lg font-semibold text-emerald-300">
            Movimientos recientes
          </h2>
          <button
            onClick={() => navigate("/wallet/movimientos")}
            className="text-xs text-emerald-200 underline"
          >
            Ver todos
          </button>
        </div>

        {error && (
          <p className="text-sm text-red-300 mb-2">
            {error}
          </p>
        )}

        {actividadReciente.length === 0 ? (
          <p className="text-sm text-emerald-100/70">
            AÃºn no tienes movimientos en tu billetera.
          </p>
        ) : (
          <div className="space-y-2 text-sm">
            {actividadReciente.map((m) => {
              const fecha =
                m.creado_en || m.fecha || m.fecha_movimiento || null;

              const cantidad = m.cantidad ?? m.creditos ?? 0;
              const esIngreso = Number(cantidad) >= 0;
              const saldo = m.saldo_posterior ?? m.saldo ?? null;

              return (
                <div
                  key={m.id_movimiento || `${m.tipo_movimiento}-${fecha}`}
                  className="flex items-center justify-between border-b border-emerald-800/60 pb-2 last:border-0"
                >
                  <div>
                    <p className="font-semibold text-emerald-100">
                      {m.tipo_movimiento || "Movimiento"}
                      {m.tipo_referencia ? ` (${m.tipo_referencia})` : ""}
                    </p>
                    <p className="text-xs text-emerald-100/70">
                      {formatFechaMovimiento(fecha)}
                    </p>
                  </div>

                  <div className="text-right">
                    <p
                      className={`font-semibold ${
                        esIngreso ? "text-emerald-300" : "text-red-300"
                      }`}
                    >
                      {esIngreso ? "+" : "-"}
                      {Math.abs(Number(cantidad)).toLocaleString("es-BO")} cr.
                    </p>
                    {saldo != null && (
                      <p className="text-[11px] text-emerald-100/60 mt-1">
                        Saldo:{" "}
                        {Number(saldo).toLocaleString("es-BO")} cr.
                      </p>
                    )}
                  </div>
                </div>
              );
            })}
          </div>
        )}
      </section>
    </div>
  );
}
</file>

<file path="frontend/src/pages/IntercambioDetalle.jsx">
import { useEffect, useState } from "react";
import { useParams } from "react-router-dom";
import { getIntercambioDetalle } from "../services/api";
import { ArrowLeft, Info } from "lucide-react";

export default function IntercambioDetalle() {
  const { id } = useParams();
  const [detalle, setDetalle] = useState(null);
  const [error, setError] = useState("");

  useEffect(() => {
    cargar();
  }, []);

  async function cargar() {
    try {
      const data = await getIntercambioDetalle(id);
      setDetalle(data);
    } catch (err) {
      setError(err.message || "No se pudo cargar el detalle.");
    }
  }

  return (
    <div className="min-h-screen bg-[#082b1f] text-white p-6">
      <button
        onClick={() => (window.location.href = "/intercambios")}
        className="inline-flex items-center gap-2 px-3 py-1 bg-black/30 rounded-full text-sm hover:bg-black/40"
      >
        <ArrowLeft size={16} /> Volver
      </button>

      <h1 className="text-xl font-semibold flex items-center gap-2 mt-4">
        <Info size={20} className="text-emerald-400" />
        Detalle del intercambio #{id}
      </h1>

      {error && <p className="text-red-400 mt-4">{error}</p>}

      {detalle && (
        <div className="bg-[#0f3f2d] border border-emerald-700 p-5 rounded-xl mt-4">
          <p><strong>Producto:</strong> {detalle.titulo}</p>
          <p><strong>DescripciÃ³n:</strong> {detalle.descripcion}</p>
          <p><strong>CrÃ©ditos usados:</strong> {detalle.creditos}</p>
          <p><strong>Estado:</strong> {detalle.estado}</p>
          <p><strong>Fecha:</strong> {new Date(detalle.fecha).toLocaleString()}</p>
        </div>
      )}
    </div>
  );
}
</file>

<file path="frontend/src/pages/Intercambios.jsx">
// digital-barder/frontend/src/pages/Intercambios.jsx
import { useEffect, useState } from "react";
import { useNavigate } from "react-router-dom";
import { api } from "../services/api";
import { ArrowLeft, ArrowLeftRight, ShoppingBag, Store } from "lucide-react";
import hoja from "../assets/hoja.png";

export default function Intercambios() {
  const navigate = useNavigate();

  // formulario crear intercambio
  const [idPublicacion, setIdPublicacion] = useState("");
  const [creditos, setCreditos] = useState("");
  const [creando, setCreando] = useState(false);
  const [txCreada, setTxCreada] = useState(null);
  const [errorForm, setErrorForm] = useState("");

  // listas
  const [tab, setTab] = useState("compras"); // "compras" | "ventas"
  const [compras, setCompras] = useState([]);
  const [ventas, setVentas] = useState([]);
  const [loadingListas, setLoadingListas] = useState(false);
  const [errorListas, setErrorListas] = useState("");

  // cargar compras y ventas al entrar
  useEffect(() => {
    async function cargarListas() {
      try {
        setLoadingListas(true);
        setErrorListas("");

        const [respCompras, respVentas] = await Promise.all([
          api("/intercambios/mis-compras"),
          api("/intercambios/mis-ventas"),
        ]);

        setCompras(Array.isArray(respCompras) ? respCompras : []);
        setVentas(Array.isArray(respVentas) ? respVentas : []);
      } catch (err) {
        console.error(err);
        setErrorListas(
          err?.message || "No se pudieron cargar tus intercambios."
        );
      } finally {
        setLoadingListas(false);
      }
    }

    cargarListas();
  }, []);

  async function onCrearIntercambio(e) {
    e.preventDefault();
    setErrorForm("");
    setTxCreada(null);

    if (!idPublicacion || !creditos) {
      setErrorForm("id_publicacion y crÃ©ditos son obligatorios.");
      return;
    }

    const id_pub = Number(idPublicacion);
    const cred = Number(creditos);

    if (Number.isNaN(id_pub) || Number.isNaN(cred) || cred <= 0) {
      setErrorForm("Verifica que el ID y los crÃ©ditos sean vÃ¡lidos.");
      return;
    }

    const ok = window.confirm(
      `Â¿Confirmas el intercambio de ${cred} crÃ©ditos por la publicaciÃ³n #${id_pub}?`
    );
    if (!ok) return;

    try {
      setCreando(true);

      const res = await api("/intercambios", {
        method: "POST",
        body: {
          id_publicacion: id_pub,
          creditos: cred,
        },
      });

      setTxCreada(res?.transaccion || res || null);

      // refrescar listas
      try {
        const [respCompras, respVentas] = await Promise.all([
          api("/intercambios/mis-compras"),
          api("/intercambios/mis-ventas"),
        ]);
        setCompras(Array.isArray(respCompras) ? respCompras : []);
        setVentas(Array.isArray(respVentas) ? respVentas : []);
      } catch (errInner) {
        console.warn("No se pudieron refrescar las listas:", errInner);
      }
    } catch (err) {
      console.error(err);
      setErrorForm(
        err?.message ||
          "OcurriÃ³ un error al intentar realizar el intercambio. Revisa tu saldo o la publicaciÃ³n."
      );
    } finally {
      setCreando(false);
    }
  }

  function renderFila(tx) {
    const id = tx.id_transaccion || tx.id_intercambio || tx.id || null;

    const creditosTx =
      tx.creditos ??
      tx.monto_creditos ??
      tx.cantidad_creditos ??
      tx.valor_creditos ??
      "-";

    const titulo =
      tx.titulo_publicacion ??
      tx.titulo ??
      tx.publicacion ??
      `TransacciÃ³n #${id || "?"}`;

    const fechaStr = tx.creado_en
      ? new Date(tx.creado_en).toLocaleString()
      : tx.fecha ||
        (tx.fecha_intercambio &&
          new Date(tx.fecha_intercambio).toLocaleString()) ||
        "";

    const contraparte =
      tx.contraparte ||
      tx.usuario_contraparte ||
      tx.comprador ||
      tx.vendedor ||
      null;

    return (
      <div
        key={id || `${titulo}-${fechaStr}`}
        className="rounded-xl border border-emerald-800/60 bg-emerald-950/60 px-4 py-3 mb-3 flex flex-col md:flex-row md:items-center md:justify-between gap-2"
      >
        <div>
          <p className="font-semibold text-emerald-100">{titulo}</p>
          <p className="text-xs text-emerald-100/70">
            {fechaStr || "Sin fecha registrada"}
          </p>
          {tx.estado && (
            <p className="mt-1 inline-flex items-center text-[11px] rounded-full px-2 py-0.5 border border-emerald-400/60 text-emerald-200">
              Estado: {tx.estado}
            </p>
          )}
        </div>

        <div className="text-right">
          <p className="text-sm text-emerald-100/80">
            CrÃ©ditos:{" "}
            <span className="font-semibold text-emerald-300">
              {creditosTx}
            </span>
          </p>
          {contraparte && (
            <p className="text-xs text-emerald-100/70 mt-1">
              Con: {contraparte}
            </p>
          )}
        </div>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-gradient-to-b from-emerald-950 via-emerald-900 to-emerald-950 text-emerald-50 px-4 py-6">
      {/* HEADER */}
      <header className="mb-8 flex items-center justify-between">
        <div className="flex items-center gap-3">
          <button
            type="button"
            onClick={() => navigate(-1)}
            className="inline-flex items-center gap-2 rounded-full bg-black/30 px-3 py-1 text-sm hover:bg-black/40"
          >
            <ArrowLeft size={16} />
            Volver
          </button>
          <div className="flex items-center gap-2 rounded-2xl bg-emerald-900/70 px-3 py-2 text-sm">
            <ArrowLeftRight size={18} className="text-emerald-300" />
            <span className="font-semibold">Intercambios</span>
          </div>
        </div>

        <img src={hoja} alt="logo" className="w-9 h-9 drop-shadow-md" />
      </header>

      {/* FORMULARIO CREAR INTERCAMBIO */}
      <section className="mb-10">
        <h1 className="text-2xl font-semibold mb-1">
          Realizar intercambio manual
        </h1>
        <p className="text-sm text-emerald-100/80 mb-4">
          Para pruebas: indica el ID de una publicaciÃ³n y la cantidad de
          crÃ©ditos. El backend ejecutarÃ¡ el procedimiento de intercambio y
          actualizarÃ¡ tu billetera.
        </p>

        <form
          onSubmit={onCrearIntercambio}
          className="grid gap-4 md:grid-cols-[1fr_1fr_auto] items-end bg-emerald-950/60 border border-emerald-800/70 rounded-2xl px-4 py-4"
        >
          <div>
            <label className="block text-xs mb-1">
              ID publicaciÃ³n (id_publicacion) *
            </label>
            <input
              type="number"
              value={idPublicacion}
              onChange={(e) => setIdPublicacion(e.target.value)}
              className="w-full rounded-lg border border-emerald-700 bg-emerald-950/80 px-3 py-2 text-sm outline-none focus:ring focus:ring-emerald-500/60"
            />
          </div>

          <div>
            <label className="block text-xs mb-1">CrÃ©ditos a pagar *</label>
            <input
              type="number"
              value={creditos}
              onChange={(e) => setCreditos(e.target.value)}
              className="w-full rounded-lg border border-emerald-700 bg-emerald-950/80 px-3 py-2 text-sm outline-none focus:ring focus:ring-emerald-500/60"
            />
          </div>

          <button
            type="submit"
            disabled={creando}
            className="mt-2 md:mt-0 inline-flex items-center justify-center rounded-2xl bg-emerald-500 px-6 py-2 text-sm font-semibold text-emerald-950 shadow hover:bg-emerald-400 disabled:opacity-60 disabled:cursor-not-allowed"
          >
            {creando ? "Procesandoâ€¦" : "Realizar intercambio"}
          </button>
        </form>

        {errorForm && (
          <div className="mt-3 rounded-md border border-red-200 bg-red-50 px-3 py-2 text-sm text-red-700">
            {errorForm}
          </div>
        )}

        {txCreada && (
          <div className="mt-4 rounded-xl border border-emerald-500/70 bg-emerald-900/70 px-4 py-3 text-sm">
            <p className="font-semibold mb-1">
              Intercambio registrado correctamente âœ…
            </p>
            <pre className="text-xs text-emerald-100/80 overflow-x-auto">
              {JSON.stringify(txCreada, null, 2)}
            </pre>
          </div>
        )}
      </section>

      {/* LISTAS DE COMPRAS / VENTAS */}
      <section>
        <div className="mb-4 flex items-center justify-between gap-4">
          <div className="flex gap-2 rounded-full bg-emerald-950/60 p-1 border border-emerald-800/80">
            <button
              type="button"
              onClick={() => setTab("compras")}
              className={`flex items-center gap-1 rounded-full px-4 py-1.5 text-xs font-medium ${
                tab === "compras"
                  ? "bg-emerald-500 text-emerald-950"
                  : "text-emerald-100 hover:bg-emerald-800/60"
              }`}
            >
              <ShoppingBag size={14} />
              Mis compras
            </button>
            <button
              type="button"
              onClick={() => setTab("ventas")}
              className={`flex items-center gap-1 rounded-full px-4 py-1.5 text-xs font-medium ${
                tab === "ventas"
                  ? "bg-emerald-500 text-emerald-950"
                  : "text-emerald-100 hover:bg-emerald-800/60"
              }`}
            >
              <Store size={14} />
              Mis ventas
            </button>
          </div>

          {loadingListas && (
            <p className="text-xs text-emerald-100/80">Cargando listasâ€¦</p>
          )}
        </div>

        {errorListas && (
          <div className="mb-4 rounded-md border border-red-200 bg-red-50 px-3 py-2 text-sm text-red-700">
            {errorListas}
          </div>
        )}

        {tab === "compras" && !errorListas && (
          <div>
            {compras.map(renderFila)}
            {compras.length === 0 && !loadingListas && (
              <p className="text-sm text-emerald-100/80">
                AÃºn no tienes compras registradas.
              </p>
            )}
          </div>
        )}

        {tab === "ventas" && !errorListas && (
          <div>
            {ventas.map(renderFila)}
            {ventas.length === 0 && !loadingListas && (
              <p className="text-sm text-emerald-100/80">
                AÃºn no tienes ventas registradas.
              </p>
            )}
          </div>
        )}
      </section>
    </div>
  );
}
</file>

<file path="frontend/src/pages/Login.jsx">
// frontend/src/pages/Login.jsx
import React, { useState, useEffect } from "react";
import { Link, useNavigate } from "react-router-dom";
import { login } from "../services/api";
import hojaLogo from "../assets/hoja.png";

// Carrusel interno (sin componente externo)
const SLIDES = [
  {
    id: 1,
    title: "Crea una cuenta en Digital Barter",
    text: "ObtÃ©n 5 monedas Green Credits por tu primera sesiÃ³n.",
    image:
      "https://images.pexels.com/photos/3184339/pexels-photo-3184339.jpeg?auto=compress&cs=tinysrgb&w=1600",
  },
  {
    id: 2,
    title: "Intercambia productos y servicios",
    text: "Ahorra dinero mientras ayudas al planeta.",
    image:
      "https://images.pexels.com/photos/3184291/pexels-photo-3184291.jpeg?auto=compress&cs=tinysrgb&w=1600",
  },
  {
    id: 3,
    title: "Gana Green Credits",
    text: "Recibe crÃ©ditos verdes por cada intercambio sostenible.",
    image:
      "https://images.pexels.com/photos/8867432/pexels-photo-8867432.jpeg?auto=compress&cs=tinysrgb&w=1600",
  },
];

const Login = () => {
  const [correo, setCorreo] = useState("");
  const [password, setPassword] = useState("");
  const [error, setError] = useState("");
  const [cargando, setCargando] = useState(false);

  const [slideIndex, setSlideIndex] = useState(0);
  const navigate = useNavigate();

  // Carrusel automÃ¡tico (igual que en tu login anterior)
  useEffect(() => {
    const interval = setInterval(() => {
      setSlideIndex((prev) => (prev + 1) % SLIDES.length);
    }, 5000);
    return () => clearInterval(interval);
  }, []);

  const currentSlide = SLIDES[slideIndex];

  // ðŸ‘‰ AquÃ­ va la funcionalidad REAL de login (no setTimeout)
  const handleSubmit = async (e) => {
    e.preventDefault();
    setError("");

    if (!correo || !password) {
      setError("Debes ingresar correo y contraseÃ±a.");
      return;
    }

    try {
      setCargando(true);

      const data = await login({ correo, password });

      if (!data?.token) {
        setError("No se recibiÃ³ el token de autenticaciÃ³n.");
        return;
      }

      // Login correcto â†’ navega a /home
      navigate("/home");
    } catch (err) {
      console.error(err);
      setError(err.message || "Credenciales invÃ¡lidas");
    } finally {
      setCargando(false);
    }
  };

  return (
    <div
  className="min-h-screen w-full flex flex-col items-center py-2 px-6 overflow-x-hidden"
  style={{
    background: "radial-gradient(circle at center, #024023 0%, #005B30 100%)",
  }}
>

      {/* HEADER: tÃ­tulo + botÃ³n Crear Cuenta (igual al del .zip) */}
      <header className="w-full max-w-6xl flex items-center justify-between mb-2">
        <div className="text-center flex-1 lg:translate-x-12 lg:translate-y-[-0px]">
          {/* Digital Barter */}
          <h1
            className="text-[#06B060] leading-tight mb-2"
            style={{
              fontFamily: '"Berlin Sans FB Demi", system-ui, sans-serif',
              fontSize: "3.7rem",
              fontWeight: 700,
              marginTop: "0.2rem",
            }}
          >
            Digital Barter
          </h1>

          {/* green credits + imagen hoja */}
          <div className="flex items-center justify-center gap-2 -mt-1">
            <h2
              className="text-[#06B060]"
              style={{
                fontFamily: '"Jaro", system-ui, sans-serif',
                fontSize: "2.0rem",
                fontWeight: 400,
              }}
            >
              green credits
            </h2>
            {/* Usamos tu hoja importada, no /images/hoja.png */}
            <img
              src={hojaLogo}
              alt="leaf icon"
              className="w-8 h-8 object-contain"
            />
          </div>
        </div>

        {/* BotÃ³n Crear Cuenta arriba a la derecha */}
        <Link to="/register" className="absolute top-4 right-4">
          <button
            type="button"
            className="bg-[#005B30] text-white text-lg rounded-lg hover:bg-[#047645] flex items-center justify-center"
            style={{
              fontFamily: '"Berlin Sans FB Demi", system-ui, sans-serif',
              fontWeight: 700,
              height: "45px",
              width: "200px",
            }}
          >
            Crear Cuenta
          </button>
        </Link>
      </header>

      {/* CONTENIDO PRINCIPAL */}
      <main className="w-full max-w-6xl flex flex-col lg:flex-row items-start lg:items-start gap-4 mt-0">
        {/* Columna izquierda: carrusel (sustituye <Carousel /> del .zip, pero con tu lÃ³gica) */}
        <div className="flex justify-start w-full lg:w-2/5 lg:-translate-x-12 lg:-translate-y-25">
          <div
            className="w-full max-w-[500px] transform scale-90 lg:scale-100 overflow-hidden rounded-2xl shadow-2xl"
            style={{
              height: "450px", // misma altura que en el diseÃ±o
              clipPath:
                "polygon(0 0, 100% 0, 100% 100%, 0 100%)", // recorte inferior como en el .zip
            }}
          >
            <div className="relative w-full h-full">
              <img
                src={currentSlide.image}
                alt={currentSlide.title}
                className="w-full h-full object-cover"
              />
              <div className="absolute inset-0 bg-gradient-to-t from-black/70 via-black/20 to-transparent" />
              <div className="absolute inset-0 flex flex-col justify-end p-6">
                <h2 className="text-xl font-bold mb-2">
                  {currentSlide.title}
                </h2>
                <p className="text-sm text-gray-200 mb-4">
                  {currentSlide.text}
                </p>

                {/* Puntos del carrusel */}
                <div className="flex gap-2">
                  {SLIDES.map((s, idx) => (
                    <button
                      key={s.id}
                      onClick={() => setSlideIndex(idx)}
                      className={`w-3 h-3 rounded-full ${
                        idx === slideIndex
                          ? "bg-[#034828]"
                          : "bg-white/70"
                      }`}
                      aria-label={`Ir al slide ${idx + 1}`}
                    />
                  ))}
                </div>
              </div>
            </div>
          </div>
        </div>

        {/* Columna derecha: formulario (mismo layout del .zip, con tu lÃ³gica de login) */}
        <div className="flex-1 flex flex-col items-center lg:items-start mt-32 lg:ml-20 lg:translate-x-20">
          <form
            onSubmit={handleSubmit}
            className="w-full space-y-4 flex flex-col items-center"
          >
            {/* Campo correo/telÃ©fono */}
            <div className="space-y-3">
              <input
                type="text"
                value={correo}
                onChange={(e) => setCorreo(e.target.value)}
                placeholder="Correo electrÃ³nico o nÃºmero de telÃ©fono"
                className="w-[445px] rounded-xl px-4 py-3 bg-[#E9FFD9]/50 border border-[#B6E4A3] text-[#013726] placeholder:text-[#6C8A6E]"
                style={{
                  fontSize: "20px",
                  fontWeight: 500,
                }}
              />
            </div>

            {/* Campo contraseÃ±a */}
            <div className="space-y-3">
              <input
                type="password"
                value={password}
                onChange={(e) => setPassword(e.target.value)}
                placeholder="ContraseÃ±a"
                className="w-[445px] rounded-xl px-4 py-3 bg-[#E9FFD9]/50 border border-[#B6E4A3] text-[#013726] placeholder:text-[#6C8A6E]"
                style={{
                  fontSize: "20px",
                  fontWeight: 500,
                }}
              />
            </div>

            {/* Â¿Has olvidado tu contraseÃ±a? centrado (como en el .zip, usando <a>) */}
            <div className="text-center w-full">
              <a
                href="#"
                className="text-sm hover:text-[#06B060] font-medium"
                style={{ fontFamily: "Inter, system-ui, sans-serif" }}
                onClick={(e) => {
                  e.preventDefault();
                  alert(
                    "En el futuro aquÃ­ irÃ¡ el flujo de recuperar contraseÃ±a."
                  );
                }}
              >
                Â¿Has olvidado tu contraseÃ±a?
              </a>
            </div>

            {/* Mensaje de error (igual lÃ³gica, estilo simple) */}
            {error && (
              <p className="text-red-400 text-center text-sm font-medium">
                {error}
              </p>
            )}

            {/* BotÃ³n Iniciar SesiÃ³n */}
            <button
              type="submit"
              disabled={cargando}
              className="w-[445px] py-4 text-lg bg-[#005B30] text-white hover:bg-[#047645] flex items-center justify-center disabled:opacity-60 disabled:cursor-not-allowed"
              style={{
                fontFamily:
                  '"Berlin Sans FB Demi", "Arial Black", sans-serif',
                fontWeight: 700,
                fontSize: "22px",
                height: "50px",
                letterSpacing: "0.5px",
              }}
            >
              {cargando ? "Iniciando sesiÃ³n..." : "Iniciar sesiÃ³n"}
            </button>
          </form>
        </div>
      </main>

      {/* Enlace en la esquina inferior derecha (como en el .zip) */}
      <div className="absolute bottom-4 right-4 w-full text-right">
        <a
          href="#"
          className="text-base hover:text-[#06B060] font-medium"
          style={{ fontFamily: "Inter, system-ui, sans-serif" }}
          onClick={(e) => e.preventDefault()}
        >
          Â¡Un poco mÃ¡s sobre nosotros!
        </a>
      </div>
    </div>
  );
};

export default Login;
</file>

<file path="frontend/src/pages/Logros.jsx">
// digital-barder/frontend/src/pages/Logros.jsx
import { useEffect, useMemo, useState } from "react";
import { useNavigate } from "react-router-dom";
import { getMisLogros } from "../services/api";
import { ArrowLeft, Medal, Award, Crown } from "lucide-react";
import hoja from "../assets/hoja.png";

export default function Logros() {
  const navigate = useNavigate();
  const [logros, setLogros] = useState([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState("");

  useEffect(() => {
    cargarLogros();
  }, []);

  async function cargarLogros() {
    try {
      setLoading(true);
      setError("");
      const data = await getMisLogros();
      setLogros(Array.isArray(data) ? data : []);
    } catch (err) {
      console.error(err);
      setError(err.message || "No se pudieron cargar tus logros.");
    } finally {
      setLoading(false);
    }
  }

  // EstadÃ­sticas simples
  const stats = useMemo(() => {
    if (!logros.length) return { total: 0, ult: null };

    const ordenados = [...logros].sort((a, b) => {
      const fa = new Date(a.obtenido_en || a.creado_en || 0).getTime();
      const fb = new Date(b.obtenido_en || b.creado_en || 0).getTime();
      return fb - fa;
    });

    return {
      total: logros.length,
      ult: ordenados[0],
    };
  }, [logros]);

  return (
    <div className="min-h-screen bg-[#082b1f] text-white p-6 md:p-10">
      {/* HEADER */}
      <header className="flex items-center justify-between mb-8 gap-4">
        <div className="flex items-center gap-3">
          <button
            type="button"
            onClick={() => navigate(-1)}
            className="inline-flex items-center gap-2 rounded-full bg-black/30 px-3 py-1 text-sm hover:bg-black/40"
          >
            <ArrowLeft size={16} />
            Volver
          </button>
          <div className="flex items-center gap-2 rounded-2xl bg-emerald-900/70 px-3 py-2 text-sm">
            <Medal size={18} className="text-emerald-300" />
            <span className="font-semibold">Mis logros</span>
          </div>
        </div>

        <div className="flex items-center gap-3">
          <span className="text-sm text-emerald-100/80">
            Total de insignias:{" "}
            <span className="font-semibold text-emerald-300">
              {stats.total}
            </span>
          </span>
          <img src={hoja} alt="logo" className="w-9 h-9 drop-shadow-md" />
        </div>
      </header>

      {/* DESCRIPCIÃ“N */}
      <section className="max-w-3xl mb-6">
        <h1 className="text-2xl font-semibold mb-2">Tus insignias verdes</h1>
        <p className="text-sm text-emerald-100/80">
          AquÃ­ puedes ver todos los logros que has obtenido en Digital Barter:
          actividades sostenibles, intercambios, uso de la plataforma y otros
          hitos que te otorgan crÃ©ditos de recompensa.
        </p>
      </section>

      {/* ERROR */}
      {error && (
        <div className="mb-4 rounded-md border border-red-400 bg-red-900/40 px-4 py-2 text-sm text-red-100">
          {error}
        </div>
      )}

      {/* CONTENIDO */}
      {loading ? (
        <div className="text-center text-emerald-100/80">
          Cargando tus logros...
        </div>
      ) : logros.length === 0 ? (
        <div className="text-center text-emerald-100/80 mt-10">
          AÃºn no has desbloqueado ningÃºn logro.  
          Participa en actividades, realiza intercambios y usa la plataforma
          para comenzar a ganar insignias.
        </div>
      ) : (
        <>
          {/* ÃšLTIMO LOGRO DESTACADO */}
          {stats.ult && (
            <section className="max-w-3xl mb-6 bg-[#0f3f2d] border border-emerald-700 rounded-2xl p-4 flex items-start gap-4">
              <div className="mt-1">
                <Crown size={28} className="text-yellow-300" />
              </div>
              <div>
                <p className="text-xs text-emerald-300/90 mb-1">
                  Ãšltimo logro obtenido
                </p>
                <h2 className="text-lg font-semibold text-emerald-200">
                  {stats.ult.nombre || "Logro reciente"}
                </h2>
                <p className="text-sm text-emerald-100/90 mt-1">
                  {stats.ult.descripcion || "Sin descripciÃ³n."}
                </p>
                <p className="text-xs text-emerald-200/80 mt-2">
                  Obtenido el{" "}
                  {new Date(
                    stats.ult.obtenido_en ||
                      stats.ult.creado_en ||
                      Date.now()
                  ).toLocaleString()}
                </p>
                {typeof stats.ult.creditos_recompensa === "number" && (
                  <p className="text-xs text-emerald-200/90 mt-1">
                    CrÃ©ditos de recompensa:{" "}
                    <span className="font-semibold text-emerald-300">
                      {stats.ult.creditos_recompensa} cr.
                    </span>
                  </p>
                )}
              </div>
            </section>
          )}

          {/* GRID DE LOGROS */}
          <section className="grid gap-4 md:grid-cols-3">
            {logros.map((logro, idx) => {
              const progreso =
                logro.progreso_actual ??
                logro.progreso ??
                null;
              const meta = logro.meta_requerida ?? null;
              const porcentaje =
                progreso && meta ? Math.min(100, (progreso / meta) * 100) : null;

              return (
                <article
                  key={logro.id_logro || idx}
                  className="bg-[#0f3f2d] border border-emerald-700 rounded-2xl p-4 shadow-md flex flex-col"
                >
                  {/* Icono / encabezado */}
                  <div className="flex items-center gap-2 mb-3">
                    <div className="w-10 h-10 rounded-full bg-emerald-700/40 flex items-center justify-center">
                      <Award size={20} className="text-emerald-200" />
                    </div>
                    <div>
                      <h3 className="text-sm font-semibold text-emerald-100">
                        {logro.nombre || "Logro sin nombre"}
                      </h3>
                      {logro.meta_requerida && (
                        <p className="text-[11px] text-emerald-300/90">
                          Meta: {logro.meta_requerida}
                        </p>
                      )}
                    </div>
                  </div>

                  {/* DescripciÃ³n */}
                  <p className="text-xs text-emerald-100/80 flex-1">
                    {logro.descripcion || "Sin descripciÃ³n."}
                  </p>

                  {/* Progreso */}
                  {porcentaje !== null && (
                    <div className="mt-3">
                      <p className="text-[11px] text-emerald-200/90 mb-1">
                        Progreso: {progreso} / {meta}
                      </p>
                      <div className="w-full h-2 rounded-full bg-emerald-900/60 overflow-hidden">
                        <div
                          className="h-full bg-emerald-400"
                          style={{ width: `${porcentaje}%` }}
                        />
                      </div>
                    </div>
                  )}

                  {/* CrÃ©ditos recompensa + fecha */}
                  <div className="mt-3 text-[11px] text-emerald-200/80">
                    {typeof logro.creditos_recompensa === "number" && (
                      <p>
                        CrÃ©ditos recompensa:{" "}
                        <span className="font-semibold text-emerald-300">
                          {logro.creditos_recompensa} cr.
                        </span>
                      </p>
                    )}
                    {(logro.obtenido_en || logro.creado_en) && (
                      <p className="mt-1">
                        Obtenido el{" "}
                        {new Date(
                          logro.obtenido_en || logro.creado_en
                        ).toLocaleDateString()}
                      </p>
                    )}
                  </div>
                </article>
              );
            })}
          </section>
        </>
      )}
    </div>
  );
}
</file>

<file path="frontend/src/pages/MisActividades.jsx">
// digital-barder/frontend/src/pages/MisActividades.jsx
import { useEffect, useState } from "react";
import { useNavigate } from "react-router-dom";
import { getMisActividadesSostenibles } from "../services/api";
import { ArrowLeft, Leaf } from "lucide-react";
import hoja from "../assets/hoja.png";

export default function MisActividades() {
  const navigate = useNavigate();

  const [actividades, setActividades] = useState([]);
  const [cargando, setCargando] = useState(true);
  const [error, setError] = useState("");

  useEffect(() => {
    cargarMisActividades();
  }, []);

  async function cargarMisActividades() {
    try {
      setCargando(true);
      setError("");
      const data = await getMisActividadesSostenibles();
      setActividades(Array.isArray(data) ? data : []);
    } catch (err) {
      console.error(err);
      setError(
        err.message || "No se pudo cargar tu historial de actividades."
      );
    } finally {
      setCargando(false);
    }
  }

  // pequeÃ±a ayuda para formatear fecha si viene como string ISO
  function formatFecha(fecha) {
    if (!fecha) return "-";
    try {
      const d = new Date(fecha);
      if (Number.isNaN(d.getTime())) return fecha; // la dejo tal cual
      return d.toLocaleString();
    } catch {
      return fecha;
    }
  }

  return (
    <div className="min-h-screen bg-[#082b1f] text-white p-6 md:p-10">
      {/* HEADER */}
      <header className="flex items-center justify-between gap-3 mb-8">
        <div className="flex items-center gap-3">
          <button
            type="button"
            onClick={() => navigate(-1)}
            className="inline-flex items-center gap-2 rounded-full bg-black/30 px-3 py-1 text-sm hover:bg-black/40"
          >
            <ArrowLeft size={16} />
            Volver
          </button>
          <div className="flex items-center gap-2 rounded-2xl bg-emerald-900/70 px-3 py-2 text-sm">
            <Leaf size={18} className="text-emerald-300" />
            <span className="font-semibold">Mis actividades</span>
          </div>
        </div>

        <button
          type="button"
          onClick={() => navigate("/actividades")}
          className="px-4 py-2 rounded-lg border border-emerald-500 text-sm hover:bg-emerald-500/10 font-semibold"
        >
          Registrar nueva actividad
        </button>
      </header>

      {/* ERROR */}
      {error && (
        <div className="mb-4 rounded-md border border-red-400 bg-red-900/40 px-4 py-2 text-sm text-red-100">
          {error}
        </div>
      )}

      {/* CONTENIDO */}
      {cargando ? (
        <div className="text-center text-emerald-100/80">
          Cargando tu historial...
        </div>
      ) : actividades.length === 0 ? (
        <div className="text-center text-emerald-100/80">
          AÃºn no has registrado actividades sostenibles.
          <br />
          Participa en alguna para empezar a ganar crÃ©ditos verdes.
        </div>
      ) : (
        <div className="bg-[#0f3f2d] border border-emerald-700 rounded-xl overflow-x-auto">
          <table className="min-w-full text-sm">
            <thead className="border-b border-emerald-600 text-emerald-300">
              <tr>
                <th className="text-left py-2 px-4">DescripciÃ³n</th>
                <th className="text-left py-2 px-4">CrÃ©ditos</th>
                <th className="text-left py-2 px-4">Estado</th>
                <th className="text-left py-2 px-4">Fecha</th>
              </tr>
            </thead>
            <tbody>
              {actividades.map((a, idx) => (
                <tr
                  key={a.id_actividad || idx}
                  className="border-b border-emerald-800/50 last:border-0"
                >
                  <td className="py-2 px-4">
                    {a.descripcion || (
                      <span className="text-emerald-100/70 text-xs">
                        Sin descripciÃ³n
                      </span>
                    )}
                  </td>
                  <td className="py-2 px-4">
                    {a.creditos_otorgados != null
                      ? a.creditos_otorgados
                      : "â€”"}
                  </td>
                  <td className="py-2 px-4">
                    {a.estado || "PENDIENTE"}
                  </td>
                  <td className="py-2 px-4">
                    {formatFecha(a.creado_en)}
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      )}

      <div className="mt-6 flex justify-center">
        <img src={hoja} alt="logo" className="w-10 h-10 opacity-80" />
      </div>
    </div>
  );
}
</file>

<file path="frontend/src/pages/MisPublicaciones.jsx">
// frontend/src/pages/MisPublicaciones.jsx
import { useEffect, useState } from "react";
import { api } from "../services/api";
import hoja from "../assets/hoja.png";

export default function MisPublicaciones() {
  const [publicaciones, setPublicaciones] = useState([]);
  const [cargando, setCargando] = useState(true);
  const [error, setError] = useState("");

  useEffect(() => {
    cargarMisPublicaciones();
  }, []);

  async function cargarMisPublicaciones() {
    setCargando(true);
    setError("");
    try {
      // ðŸ‘‡ ruta EXACTA segÃºn tu router de backend
      const data = await api("/publicaciones/mias/listado");
      setPublicaciones(Array.isArray(data) ? data : []);
    } catch (err) {
      console.error(err);
      setError(err.message || "No se pudieron cargar tus publicaciones.");
    } finally {
      setCargando(false);
    }
  }

  return (
    <div className="min-h-screen bg-[#082b1f] text-white p-6 md:p-10">
      {/* HEADER */}
      <div className="flex items-center justify-between gap-3 mb-8">
        <div className="flex items-center gap-3">
          <img src={hoja} alt="logo" className="w-10 h-10 drop-shadow-lg" />
        <div>
          <h1 className="text-3xl font-bold text-emerald-400">
            Mis publicaciones
          </h1>
          <p className="text-sm text-emerald-100/80">
            AquÃ­ ves todo lo que has publicado en el marketplace.
          </p>
        </div>
        </div>

        <a
          href="/publicaciones"
          className="bg-emerald-500 hover:bg-emerald-600 px-4 py-2 rounded-lg font-semibold"
        >
          Ir al marketplace
        </a>
      </div>

      {/* ERROR */}
      {error && (
        <div className="mb-4 rounded-md border border-red-400 bg-red-900/40 px-4 py-2 text-sm text-red-100">
          {error}
        </div>
      )}

      {/* CONTENIDO */}
      {cargando ? (
        <div className="text-center text-emerald-100/80">Cargando...</div>
      ) : !error && publicaciones.length === 0 ? (
        <div className="text-center text-emerald-100/80">
          TodavÃ­a no has creado ninguna publicaciÃ³n.
        </div>
      ) : !error ? (
        <div className="bg-[#0f3f2d] border border-emerald-700 rounded-xl overflow-x-auto">
          <table className="min-w-full text-sm">
            <thead className="border-b border-emerald-600 text-emerald-300">
              <tr>
                <th className="text-left py-2 px-4">TÃ­tulo</th>
                <th className="text-left py-2 px-4">CategorÃ­a</th>
                <th className="text-left py-2 px-4">CrÃ©ditos</th>
                <th className="text-left py-2 px-4">Estado</th>
                <th className="text-left py-2 px-4">Creado</th>
              </tr>
            </thead>
            <tbody>
              {publicaciones.map((p) => (
                <tr
                  key={p.id_publicacion}
                  className="border-b border-emerald-800/50 last:border-0"
                >
                  <td className="py-2 px-4">{p.titulo}</td>
                  <td className="py-2 px-4">
                    {p.categoria || p.id_categoria}
                  </td>
                  <td className="py-2 px-4">{p.valor_creditos} cr.</td>
                  <td className="py-2 px-4">
                    <span
                      className={`px-2 py-1 rounded-full border text-xs ${
                        p.estado === "PUBLICADA" || p.estado === "ACTIVA"
                          ? "border-emerald-400 text-emerald-300"
                          : "border-yellow-400 text-yellow-300"
                      }`}
                    >
                      {p.estado || "â€”"}
                    </span>
                  </td>
                  <td className="py-2 px-4">
                    {p.creado_en || p.created_at || "-"}
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      ) : null}
    </div>
  );
}
</file>

<file path="frontend/src/pages/Movimientos.jsx">
// frontend/src/pages/Movimientos.jsx
import { useEffect, useState } from "react";
import { getMisMovimientos } from "../services/api";
import hoja from "../assets/hoja.png";
import { ArrowLeft } from "lucide-react";
import { useNavigate } from "react-router-dom";

export default function Movimientos() {
  const [movimientos, setMovimientos] = useState([]);
  const [errorMsg, setErrorMsg] = useState("");
  const navigate = useNavigate();

  useEffect(() => {
    async function cargar() {
      try {
        setErrorMsg("");
        const res = await getMisMovimientos();

        const lista =
          res?.data && Array.isArray(res.data)
            ? res.data
            : Array.isArray(res)
            ? res
            : [];

        setMovimientos(lista);
      } catch (err) {
        console.error(err);
        setErrorMsg("No se pudieron cargar los movimientos de la billetera.");
      }
    }
    cargar();
  }, []);

  // Formatear fecha sin tocar zona horaria (coincide con lo que sale en MySQL)
  const formatFecha = (raw) => {
    if (!raw) return "â€”";

    // Si viene como string tipo "2025-12-02T19:17:00.000Z" o "2025-12-02 19:17:00"
    if (typeof raw === "string") {
      const clean = raw.replace("T", " ").replace("Z", "").trim();
      const [datePart, timePart] = clean.split(" ");

      if (!datePart) return raw;

      const [year, month, day] = datePart.split("-");

      if (!timePart) {
        return `${day}/${month}/${year}`;
      }

      const [hh, mm] = timePart.split(":");

      // No convertimos nada, solo reordenamos el texto
      return `${day}/${month}/${year}, ${hh}:${mm} h`;
    }

    // Fallback por si llega un Date
    const d = raw instanceof Date ? raw : new Date(raw);
    if (Number.isNaN(d.getTime())) return "â€”";
    return d.toLocaleString("es-BO", {
      day: "2-digit",
      month: "2-digit",
      year: "numeric",
      hour: "2-digit",
      minute: "2-digit",
    });
  };

  return (
    <div className="bg-[#f4faf7] min-h-screen p-4 sm:p-6">
      {/* HEADER */}
      <div className="flex items-center gap-3 mb-6">
        <button
          onClick={() => navigate("/wallet")}
          className="flex items-center gap-1 text-emerald-700 hover:text-emerald-900 transition"
        >
          <ArrowLeft size={20} />
          Volver
        </button>

        <h1 className="text-2xl font-bold text-emerald-900">
          Historial de movimientos de crÃ©ditos
        </h1>
      </div>

      {errorMsg && (
        <div className="mb-3 text-sm text-red-700 bg-red-100 border border-red-300 rounded-lg px-3 py-2">
          {errorMsg}
        </div>
      )}

      <div className="rounded-xl bg-white shadow-md border border-emerald-100 overflow-hidden">
        {/* ENCABEZADO TABLA */}
        <div className="bg-emerald-50 text-emerald-900 font-semibold grid grid-cols-4 py-3 px-4 border-b border-emerald-100 text-sm">
          <span>Fecha</span>
          <span>DescripciÃ³n</span>
          <span className="text-right">CrÃ©ditos</span>
          <span className="text-right">Tipo</span>
        </div>

        {/* CUERPO TABLA */}
        <div>
          {movimientos.length === 0 ? (
            <p className="text-sm text-gray-600 p-4">
              AÃºn no tienes movimientos registrados en tu billetera.
            </p>
          ) : (
            movimientos.map((m, idx) => {
              const fecha = m.creado_en || m.fecha || m.fecha_movimiento;
              const tipo = m.tipo_movimiento || "Movimiento";
              const ref = m.tipo_referencia || "Sin detalle";
              const cantidad = Number(m.cantidad) || 0;
              const esIngreso = cantidad >= 0;
              const saldo = m.saldo_posterior ?? null;

              return (
                <div
                  key={idx}
                  className="grid grid-cols-4 items-center px-4 py-3 border-b border-emerald-100 hover:bg-emerald-50/40 transition"
                >
                  {/* FECHA */}
                  <span className="text-gray-700 text-sm">
                    {formatFecha(fecha)}
                  </span>

                  {/* DESCRIPCIÃ“N */}
                  <span className="flex items-start gap-2 text-sm text-gray-800">
                    <img
                      src={hoja}
                      alt="icono"
                      className="w-4 h-4 mt-[3px]"
                    />
                    <div className="flex flex-col">
                      <span className="font-semibold">{tipo}</span>
                      <span className="text-gray-500 text-xs">{ref}</span>
                    </div>
                  </span>

                  {/* CRÃ‰DITOS */}
                  <span
                    className={`text-right font-bold ${
                      esIngreso ? "text-emerald-600" : "text-red-600"
                    }`}
                  >
                    {esIngreso ? "+" : "-"}
                    {Math.abs(cantidad).toLocaleString("es-BO")}
                  </span>

                  {/* TIPO / SALDO */}
                  <span className="text-right text-sm text-gray-700 flex flex-col items-end">
                    <span
                      className={`px-2 py-0.5 rounded-full text-[11px] font-semibold ${
                        esIngreso
                          ? "bg-emerald-100 text-emerald-800"
                          : "bg-red-100 text-red-700"
                      }`}
                    >
                      {esIngreso ? "Ingreso" : "Egreso"}
                    </span>

                    {saldo !== null && (
                      <span className="text-[11px] text-gray-500 mt-1">
                        Saldo: {Number(saldo).toLocaleString("es-BO")}
                      </span>
                    )}
                  </span>
                </div>
              );
            })
          )}
        </div>
      </div>
    </div>
  );
}
</file>

<file path="frontend/src/pages/NotFound.jsx">
import React from "react";
import { Link } from "react-router-dom";

export default function NotFound() {
  return (
    <div className="min-h-screen flex flex-col items-center justify-center bg-gray-100">
      <div className="bg-white px-6 py-5 rounded-lg shadow-sm border border-gray-200 text-center max-w-sm">
        <h1 className="text-3xl font-bold text-gray-900 mb-2">404</h1>
        <p className="text-sm text-gray-500 mb-4">
          La pÃ¡gina que buscas no existe.
        </p>
        <Link to="/home" className="btn-primary">
          Volver al inicio
        </Link>
      </div>
    </div>
  );
}
</file>

<file path="frontend/src/pages/Perfil.jsx">
import React, { useEffect, useState } from "react";
import hoja from "../assets/hoja.png";
import { api } from "../services/api";
import { useNavigate } from "react-router-dom";

export default function Perfil() {
  const [usuario, setUsuario] = useState(null);
  const [creditos, setCreditos] = useState(null);

  const navigate = useNavigate();

  useEffect(() => {
    cargarDatos();
  }, []);

  async function cargarDatos() {
    try {
      const datosUsuario = await api("/auth/me");
      const wallet = await api("/wallet/mis-creditos");

      const saldo =
        wallet?.saldo_creditos ??
        wallet?.saldo ??
        wallet?.creditos ??
        0;

      setUsuario(datosUsuario);
      setCreditos(saldo);
    } catch (err) {
      console.error("Error cargando perfil:", err);
    }
  }

  if (!usuario) {
    return (
      <div className="min-h-screen bg-[#082b1f] flex items-center justify-center text-white">
        <p>Cargando perfil.</p>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-[#082b1f] text-white p-6 md:p-10">
      {/* Header */}
      <div className="flex items-center gap-3 mb-8">
        <img src={hoja} className="w-12 h-12 drop-shadow-lg" />
        <h1 className="text-3xl font-bold text-emerald-400">Mi Perfil</h1>
      </div>

      {/* Tarjeta principal */}
      <div className="bg-[#0e4330] border border-emerald-500 rounded-xl p-6 md:p-8 shadow-xl mb-10">
        <div className="flex flex-col md:flex-row md:items-center gap-6">
          {/* Foto */}
          <div>
            <img
              src={usuario.foto || "https://via.placeholder.com/120"}
              className="w-28 h-28 rounded-full object-cover border-4 border-emerald-500 shadow-lg"
            />
          </div>

          {/* Info */}
          <div className="flex-1">
            <h2 className="text-2xl font-bold text-emerald-300">
              {usuario.nombre}
            </h2>

            <p className="opacity-90">{usuario.correo}</p>

            <p className="mt-2 text-sm">
              Estado:{" "}
              <span
                className={`font-bold ${
                  usuario.es_premium ? "text-yellow-300" : "text-emerald-300"
                }`}
              >
                {usuario.es_premium ? "Premium" : "Cuenta Normal"}
              </span>
            </p>

            <button
              onClick={() => navigate("/perfil/editar")}
              className="mt-4 bg-emerald-500 hover:bg-emerald-600 px-5 py-2 rounded-lg font-semibold transition"
            >
              Editar Perfil
            </button>
          </div>
        </div>
      </div>

      {/* Tarjetas secundarias */}
      <div className="grid md:grid-cols-3 gap-6">
        {/* CrÃ©ditos */}
        <div className="bg-[#0e4330] border border-emerald-500 p-6 rounded-xl shadow-lg">
          <h3 className="text-lg font-semibold text-emerald-300">
            Mis CrÃ©ditos
          </h3>
          <p className="text-4xl font-bold text-emerald-400 mt-2">
            {creditos !== null ? creditos : "â€”"}
          </p>
        </div>

        {/* Logros */}
        <div
          onClick={() => navigate("/logros")}
          className="bg-[#0e4330] border border-emerald-500 p-6 rounded-xl shadow-lg 
          hover:bg-[#14694c] transition cursor-pointer"
        >
          <h3 className="text-lg font-semibold text-emerald-300">Logros</h3>
          <p className="opacity-80 mt-1">Ver mis insignias ganadas</p>
        </div>

        {/* Actividades */}
        <div
          onClick={() => navigate("/actividades")}
          className="bg-[#0e4330] border border-emerald-500 p-6 rounded-xl shadow-lg
          hover:bg-[#14694c] transition cursor-pointer"
        >
          <h3 className="text-lg font-semibold text-emerald-300">
            Actividades sostenibles
          </h3>
          <p className="opacity-80 mt-1">
            Mi impacto positivo registrado
          </p>
        </div>
      </div>

      {/* BotÃ³n extra */}
      <button
        onClick={() => navigate("/logros")}
        className="mt-6 px-6 py-3 bg-emerald-600 hover:bg-emerald-500 rounded-xl 
        text-white font-semibold shadow-md transition"
      >
        Ver logros
      </button>
    </div>
  );
}
</file>

<file path="frontend/src/pages/Premium.jsx">
// frontend/src/pages/Premium.jsx
import { useEffect, useState } from "react";
import { useNavigate } from "react-router-dom";
import { api } from "../services/api";

export default function Premium() {
  const [loadingPlan, setLoadingPlan] = useState(true);
  const [activando, setActivando] = useState(false);
  const [plan, setPlan] = useState(null);
  const [error, setError] = useState("");
  const [mensaje, setMensaje] = useState("");
  const navigate = useNavigate();

  // Cargar plan premium actual
  useEffect(() => {
    async function cargarPlan() {
      try {
        setError("");
        setMensaje("");
        setLoadingPlan(true);

        const data = await api("/premium/mi-plan");

        // miPlanPremiumService devuelve una FILA; por seguridad,
        // soportamos tambiÃ©n que pueda venir como array de 1 elemento.
        let row = null;
        if (Array.isArray(data)) row = data[0] || null;
        else if (data && Object.keys(data).length > 0) row = data;

        setPlan(row);
      } catch (err) {
        console.error(err);
        setError("No se pudo cargar la informaciÃ³n de tu plan premium.");
        setPlan(null);
      } finally {
        setLoadingPlan(false);
      }
    }

    cargarPlan();
  }, []);

  // En tu BD el valor "activo" es ACTIVA
  const esPremium = !!plan && plan.estado === "ACTIVA";
  const esVencida = !!plan && plan.estado === "VENCIDA";
  const esCancelada = !!plan && plan.estado === "CANCELADA";

  function formatearFecha(fecha) {
    if (!fecha) return "â€”";
    const d = new Date(fecha);
    if (Number.isNaN(d.getTime())) return fecha;
    return d.toLocaleDateString("es-BO", {
      year: "numeric",
      month: "short",
      day: "2-digit",
    });
  }

  async function activarPremium() {
    try {
      setError("");
      setMensaje("");
      setActivando(true);

      const nuevaSubscripcion = await api("/premium/activar", {
        method: "POST",
      });

      // Actualizamos el plan con lo que devuelva el backend
      setPlan(nuevaSubscripcion);
      setMensaje("Â¡Listo! Ahora eres usuario Premium ðŸŒ¿");
    } catch (err) {
      console.error(err);
      setError(
        err.message ||
          "OcurriÃ³ un error al activar tu plan premium. Intenta de nuevo."
      );
    } finally {
      setActivando(false);
    }
  }

  return (
    <div className="min-h-screen bg-gradient-to-b from-emerald-950 via-emerald-900 to-emerald-950 text-emerald-50 px-4 py-6">
      {/* HEADER */}
      <header className="mb-8 flex items-center justify-between">
        <button
          type="button"
          onClick={() => navigate(-1)}
          className="inline-flex items-center gap-2 rounded-full bg-black/30 px-3 py-1 text-sm hover:bg-black/40"
        >
          <span className="text-lg">â†</span>
          Volver
        </button>

        <div className="rounded-full bg-emerald-700/80 px-4 py-1.5 text-sm font-semibold shadow">
          Plan Premium
        </div>
      </header>

      {/* TÃTULO */}
      <section className="mb-6 space-y-2">
        <h1 className="text-3xl font-semibold tracking-wide">
          Haz crecer tu impacto con{" "}
          <span className="text-emerald-300">Premium</span>
        </h1>
        <p className="max-w-3xl text-sm text-emerald-100/80">
          Con la suscripciÃ³n premium obtienes mÃ¡s visibilidad en el marketplace,
          beneficios especiales y reportes avanzados de tu impacto ambiental.
        </p>
      </section>

      {/* MENSAJES GLOBALES */}
      {error && (
        <div className="mb-4 rounded-md border border-red-500/60 bg-red-900/40 px-4 py-2 text-sm text-red-100">
          {error}
        </div>
      )}
      {mensaje && (
        <div className="mb-4 rounded-md border border-emerald-400/60 bg-emerald-900/40 px-4 py-2 text-sm text-emerald-100">
          {mensaje}
        </div>
      )}

      {/* CONTENIDO PRINCIPAL */}
      <div className="grid gap-6 lg:grid-cols-2">
        {/* PANEL IZQUIERDO: ESTADO / CONVERSIÃ“N A PREMIUM */}
        <section className="rounded-3xl border border-emerald-700/70 bg-emerald-950/40 p-6 shadow-lg">
          {loadingPlan && (
            <p className="text-sm text-emerald-100/80">
              Cargando estado de tu plan premiumâ€¦
            </p>
          )}

          {!loadingPlan && !esPremium && !esVencida && !esCancelada && (
            <>
              <h2 className="text-xl font-semibold mb-2">
                AÃºn no eres usuario premium
              </h2>
              <p className="text-sm text-emerald-100/80 mb-4">
                Activa tu suscripciÃ³n para desbloquear beneficios exclusivos
                dentro de Digital Barter.
              </p>

              <ul className="mb-6 ml-4 list-disc space-y-1 text-sm text-emerald-100/90">
                <li>Mayor visibilidad para tus publicaciones.</li>
                <li>Acceso a reportes avanzados y mÃ©tricas de impacto.</li>
                <li>Insignia especial en tu perfil y en el marketplace.</li>
              </ul>

              <button
                type="button"
                onClick={activarPremium}
                disabled={activando}
                className="rounded-full bg-emerald-500 px-6 py-2 text-sm font-semibold text-emerald-950 shadow hover:bg-emerald-400 disabled:opacity-60 disabled:cursor-not-allowed"
              >
                {activando ? "Activando..." : "Convertirme en usuario Premium"}
              </button>
            </>
          )}

          {!loadingPlan && esPremium && (
            <>
              <h2 className="text-xl font-semibold mb-2">
                Â¡Ya eres usuario Premium! ðŸŒ¿
              </h2>
              <p className="text-sm text-emerald-100/80 mb-4">
                Tu cuenta tiene una suscripciÃ³n premium activa.
              </p>

              <div className="space-y-2 text-sm text-emerald-100/90">
                <p>
                  <span className="font-semibold">Estado:</span>{" "}
                  {plan.estado || "ACTIVA"}
                </p>
                <p>
                  <span className="font-semibold">Fecha inicio:</span>{" "}
                  {formatearFecha(plan.fecha_inicio)}
                </p>
                <p>
                  <span className="font-semibold">Fecha fin:</span>{" "}
                  {formatearFecha(plan.fecha_fin)}
                </p>
                <p>
                  <span className="font-semibold">Monto:</span>{" "}
                  {plan.monto_bs != null
                    ? Number(plan.monto_bs).toFixed(2)
                    : "â€”"}{" "}
                  Bs
                </p>
              </div>

              <p className="mt-5 text-xs text-emerald-200/70">
                Estos datos provienen de tu Ãºltima fila en la tabla{" "}
                <span className="font-mono">SUSCRIPCION_PREMIUM</span>.
              </p>
            </>
          )}

          {!loadingPlan && (esVencida || esCancelada) && !esPremium && (
            <>
              <h2 className="text-xl font-semibold mb-2">
                Tu plan premium ya no estÃ¡ activo
              </h2>
              <p className="text-sm text-emerald-100/80 mb-4">
                Estado actual:{" "}
                <span className="font-semibold">{plan.estado}</span>. Puedes
                activar nuevamente tu suscripciÃ³n para seguir disfrutando de los
                beneficios premium.
              </p>

              <div className="space-y-2 text-sm text-emerald-100/90 mb-4">
                <p>
                  <span className="font-semibold">Ãšltimo inicio:</span>{" "}
                  {formatearFecha(plan.fecha_inicio)}
                </p>
                <p>
                  <span className="font-semibold">Ãšltimo fin:</span>{" "}
                  {formatearFecha(plan.fecha_fin)}
                </p>
              </div>

              <button
                type="button"
                onClick={activarPremium}
                disabled={activando}
                className="rounded-full bg-emerald-500 px-6 py-2 text-sm font-semibold text-emerald-950 shadow hover:bg-emerald-400 disabled:opacity-60 disabled:cursor-not-allowed"
              >
                {activando ? "Reactivando..." : "Volver a ser usuario Premium"}
              </button>
            </>
          )}
        </section>

        {/* PANEL DERECHO: BENEFICIOS / INFO */}
        <aside className="rounded-3xl border border-emerald-700/70 bg-emerald-950/30 p-6 shadow-lg">
          <h2 className="text-xl font-semibold mb-3">Â¿QuÃ© incluye Premium?</h2>
          <ul className="ml-4 list-disc space-y-2 text-sm text-emerald-100/90">
            <li>Prioridad en el listado de publicaciones del marketplace.</li>
            <li>Mayor lÃ­mite para registrar actividades sostenibles al mes.</li>
            <li>Acceso a reportes especiales y estadÃ­sticas detalladas.</li>
            <li>Soporte preferencial dentro de la plataforma.</li>
          </ul>

        </aside>
      </div>
    </div>
  );
}
</file>

<file path="frontend/src/pages/Promociones.jsx">
// digital-barder/frontend/src/pages/Promociones.jsx
import { useEffect, useState } from "react";
import {
  getPromociones,
  crearPromocion,
  cambiarEstadoPromocion,
  vincularPublicacionPromocion,
} from "../services/api";
import { useNavigate } from "react-router-dom";
import {
  ArrowLeft,
  Tag,
  Percent,
  Gift,
  Link2,
  ToggleLeft,
  ToggleRight,
} from "lucide-react";
import hoja from "../assets/hoja.png";

export default function Promociones() {
  const navigate = useNavigate();

  const [promociones, setPromociones] = useState([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState("");
  const [mensajeOk, setMensajeOk] = useState("");

  // formulario nueva promo
  const [idTipoPromo, setIdTipoPromo] = useState("");
  const [nombre, setNombre] = useState("");
  const [descripcion, setDescripcion] = useState("");
  const [creditos, setCreditos] = useState("");
  const [fechaInicio, setFechaInicio] = useState("");
  const [fechaFin, setFechaFin] = useState("");

  // vincular publicaciÃ³n
  const [promoSeleccionada, setPromoSeleccionada] = useState(null);
  const [idPublicacionVincular, setIdPublicacionVincular] = useState("");

  useEffect(() => {
    cargarPromociones();
  }, []);

  async function cargarPromociones() {
    try {
      setLoading(true);
      setError("");
      const data = await getPromociones();
      setPromociones(Array.isArray(data) ? data : []);
    } catch (err) {
      console.error(err);
      setError(err.message || "No se pudieron cargar las promociones.");
    } finally {
      setLoading(false);
    }
  }

  async function handleCrearPromocion(e) {
    e.preventDefault();
    setError("");
    setMensajeOk("");

    const id_tipo_promocion = Number(idTipoPromo || 0);
    const creditos_otorgados = Number(creditos || 0);

    if (!id_tipo_promocion || !nombre.trim() || !fechaInicio || !fechaFin) {
      setError(
        "id_tipo_promocion, nombre, fecha de inicio y fecha fin son obligatorios."
      );
      return;
    }

    try {
      await crearPromocion({
        id_tipo_promocion,
        nombre,
        descripcion,
        creditos_otorgados,
        fecha_inicio: fechaInicio,
        fecha_fin: fechaFin,
      });

      setMensajeOk("PromociÃ³n creada correctamente.");
      // limpiar
      setIdTipoPromo("");
      setNombre("");
      setDescripcion("");
      setCreditos("");
      setFechaInicio("");
      setFechaFin("");

      await cargarPromociones();
    } catch (err) {
      console.error(err);
      setError(
        err.message || "OcurriÃ³ un error al crear la promociÃ³n."
      );
    }
  }

  async function handleToggleEstado(promo) {
    const nuevoEstado = promo.estado === "ACTIVA" ? "INACTIVA" : "ACTIVA";

    const ok = window.confirm(
      `Â¿Deseas cambiar el estado de la promociÃ³n "${promo.nombre}" a ${nuevoEstado}?`
    );
    if (!ok) return;

    try {
      setError("");
      setMensajeOk("");
      await cambiarEstadoPromocion(promo.id_promocion, nuevoEstado);
      setMensajeOk("Estado actualizado correctamente.");
      await cargarPromociones();
    } catch (err) {
      console.error(err);
      setError(
        err.message || "No se pudo actualizar el estado de la promociÃ³n."
      );
    }
  }

  async function handleVincularPublicacion(e) {
    e.preventDefault();
    if (!promoSeleccionada || !idPublicacionVincular.trim()) return;

    try {
      setError("");
      setMensajeOk("");
      await vincularPublicacionPromocion(
        promoSeleccionada.id_promocion,
        Number(idPublicacionVincular)
      );
      setMensajeOk("PublicaciÃ³n vinculada a la promociÃ³n.");
      setIdPublicacionVincular("");
    } catch (err) {
      console.error(err);
      setError(
        err.message || "No se pudo vincular la publicaciÃ³n a la promociÃ³n."
      );
    }
  }

  return (
    <div className="min-h-screen bg-[#082b1f] text-white p-6 md:p-10">
      {/* HEADER */}
      <header className="flex items-center justify-between gap-4 mb-8">
        <div className="flex items-center gap-3">
          <button
            type="button"
            onClick={() => navigate(-1)}
            className="inline-flex items-center gap-2 rounded-full bg-black/30 px-3 py-1 text-sm hover:bg-black/40"
          >
            <ArrowLeft size={16} />
            Volver
          </button>

          <div className="flex items-center gap-2 rounded-2xl bg-emerald-900/70 px-3 py-2 text-sm">
            <Tag size={18} className="text-emerald-300" />
            <span className="font-semibold">GestiÃ³n de promociones</span>
          </div>
        </div>

        <div className="flex items-center gap-3">
          <span className="text-sm text-emerald-100/80">
            Total:{" "}
            <span className="font-semibold text-emerald-300">
              {promociones.length}
            </span>
          </span>
          <img src={hoja} alt="logo" className="w-9 h-9 drop-shadow-md" />
        </div>
      </header>

      {/* MENSAJES */}
      {error && (
        <div className="mb-4 rounded-md border border-red-400 bg-red-900/40 px-4 py-2 text-sm text-red-100">
          {error}
        </div>
      )}

      {mensajeOk && (
        <div className="mb-4 rounded-md border border-emerald-400 bg-emerald-900/40 px-4 py-2 text-sm text-emerald-100">
          {mensajeOk}
        </div>
      )}

      {/* CONTENIDO: LISTADO + FORMULARIO */}
      <div className="grid gap-6 lg:grid-cols-[2fr,1.5fr]">

        {/* LISTADO DE PROMOCIONES */}
        <section className="bg-[#0f3f2d] border border-emerald-700 rounded-2xl p-4 md:p-5 shadow-md">
          <h2 className="text-lg font-semibold text-emerald-200 flex items-center gap-2 mb-3">
            <Percent size={18} className="text-emerald-300" />
            Promociones configuradas
          </h2>

          {loading ? (
            <p className="text-emerald-100/80 text-sm">Cargando promociones...</p>
          ) : promociones.length === 0 ? (
            <p className="text-emerald-100/80 text-sm">
              No hay promociones registradas.
            </p>
          ) : (
            <div className="space-y-3 max-h-[480px] overflow-y-auto pr-1">
              {promociones.map((promo) => (
                <article
                  key={promo.id_promocion}
                  className={`rounded-xl border p-3 text-sm flex flex-col gap-2 cursor-pointer ${
                    promoSeleccionada?.id_promocion === promo.id_promocion
                      ? "border-emerald-400 bg-emerald-900/50"
                      : "border-emerald-700/70 bg-emerald-900/30 hover:border-emerald-500/80"
                  }`}
                  onClick={() => setPromoSeleccionada(promo)}
                >
                  <div className="flex items-center justify-between gap-3">
                    <div>
                      <p className="text-xs text-emerald-300/80">
                        ID #{promo.id_promocion}
                      </p>
                      <h3 className="font-semibold text-emerald-100">
                        {promo.nombre}
                      </h3>
                    </div>

                    <button
                      type="button"
                      onClick={(e) => {
                        e.stopPropagation();
                        handleToggleEstado(promo);
                      }}
                      className="inline-flex items-center gap-1 px-3 py-1 rounded-full border border-emerald-500/70 text-xs"
                    >
                      {promo.estado === "ACTIVA" ? (
                        <>
                          <ToggleRight size={16} className="text-emerald-300" />
                          <span>Activa</span>
                        </>
                      ) : (
                        <>
                          <ToggleLeft size={16} className="text-emerald-300" />
                          <span>Inactiva</span>
                        </>
                      )}
                    </button>
                  </div>

                  <p className="text-emerald-100/80 text-xs">
                    {promo.descripcion || "Sin descripciÃ³n."}
                  </p>

                  <div className="flex flex-wrap gap-3 text-[11px] text-emerald-200/90">
                    {typeof promo.creditos_otorgados === "number" && (
                      <span className="px-2 py-0.5 rounded-full bg-emerald-800/60 border border-emerald-600/80">
                        +{promo.creditos_otorgados} cr.
                      </span>
                    )}

                    {promo.fecha_inicio && (
                      <span>
                        Inicio:{" "}
                        {new Date(promo.fecha_inicio).toLocaleDateString()}
                      </span>
                    )}
                    {promo.fecha_fin && (
                      <span>
                        Fin:{" "}
                        {new Date(promo.fecha_fin).toLocaleDateString()}
                      </span>
                    )}
                  </div>
                </article>
              ))}
            </div>
          )}
        </section>

        {/* FORMULARIO NUEVA PROMO + VINCULAR PUBLICACIÃ“N */}
        <section className="space-y-4">
          {/* NUEVA PROMO */}
          <div className="bg-[#0f3f2d] border border-emerald-700 rounded-2xl p-4 md:p-5 shadow-md">
            <h2 className="text-lg font-semibold text-emerald-200 flex items-center gap-2 mb-3">
              <Gift size={18} className="text-emerald-300" />
              Crear nueva promociÃ³n
            </h2>

            <form onSubmit={handleCrearPromocion} className="space-y-3 text-sm">
              <div>
                <label className="block text-xs mb-1">
                  ID tipo de promociÃ³n (id_tipo_promocion) *
                </label>
                <input
                  type="number"
                  value={idTipoPromo}
                  onChange={(e) => setIdTipoPromo(e.target.value)}
                  className="w-full rounded-lg border border-emerald-700 bg-emerald-950/80 px-3 py-2 text-sm outline-none focus:ring focus:ring-emerald-500/60"
                  placeholder="Ej. 1 (descuento), 2 (bonus crÃ©ditos)..."
                />
              </div>

              <div>
                <label className="block text-xs mb-1">Nombre *</label>
                <input
                  type="text"
                  value={nombre}
                  onChange={(e) => setNombre(e.target.value)}
                  className="w-full rounded-lg border border-emerald-700 bg-emerald-950/80 px-3 py-2 text-sm outline-none focus:ring focus:ring-emerald-500/60"
                  placeholder="Ej. Promo bienvenida, 2x1 en crÃ©ditos..."
                />
              </div>

              <div>
                <label className="block text-xs mb-1">DescripciÃ³n</label>
                <textarea
                  value={descripcion}
                  onChange={(e) => setDescripcion(e.target.value)}
                  rows={2}
                  className="w-full rounded-lg border border-emerald-700 bg-emerald-950/80 px-3 py-2 text-sm outline-none focus:ring focus:ring-emerald-500/60"
                  placeholder="Explica las condiciones de la promociÃ³n..."
                />
              </div>

              <div>
                <label className="block text-xs mb-1">
                  CrÃ©ditos otorgados (opcional)
                </label>
                <input
                  type="number"
                  value={creditos}
                  onChange={(e) => setCreditos(e.target.value)}
                  className="w-full rounded-lg border border-emerald-700 bg-emerald-950/80 px-3 py-2 text-sm outline-none focus:ring focus:ring-emerald-500/60"
                  placeholder="Ej. 10"
                />
              </div>

              <div className="grid grid-cols-2 gap-3">
                <div>
                  <label className="block text-xs mb-1">Fecha inicio *</label>
                  <input
                    type="date"
                    value={fechaInicio}
                    onChange={(e) => setFechaInicio(e.target.value)}
                    className="w-full rounded-lg border border-emerald-700 bg-emerald-950/80 px-3 py-2 text-sm outline-none focus:ring focus:ring-emerald-500/60"
                  />
                </div>
                <div>
                  <label className="block text-xs mb-1">Fecha fin *</label>
                  <input
                    type="date"
                    value={fechaFin}
                    onChange={(e) => setFechaFin(e.target.value)}
                    className="w-full rounded-lg border border-emerald-700 bg-emerald-950/80 px-3 py-2 text-sm outline-none focus:ring focus:ring-emerald-500/60"
                  />
                </div>
              </div>

              <div className="pt-2 flex justify-end">
                <button
                  type="submit"
                  className="px-6 py-2 rounded-lg bg-emerald-500 hover:bg-emerald-600 text-sm font-semibold text-emerald-950"
                >
                  Guardar promociÃ³n
                </button>
              </div>
            </form>
          </div>

          {/* VINCULAR PUBLICACIÃ“N */}
          <div className="bg-[#0f3f2d] border border-emerald-700 rounded-2xl p-4 md:p-5 shadow-md">
            <h2 className="text-sm font-semibold text-emerald-200 flex items-center gap-2 mb-3">
              <Link2 size={16} className="text-emerald-300" />
              Vincular publicaciÃ³n a promociÃ³n
            </h2>

            {promoSeleccionada ? (
              <>
                <p className="text-xs text-emerald-100/90 mb-2">
                  PromociÃ³n seleccionada:{" "}
                  <span className="font-semibold">{promoSeleccionada.nombre}</span>{" "}
                  (ID #{promoSeleccionada.id_promocion})
                </p>

                <form
                  onSubmit={handleVincularPublicacion}
                  className="flex flex-col sm:flex-row gap-2 text-sm"
                >
                  <input
                    type="number"
                    value={idPublicacionVincular}
                    onChange={(e) => setIdPublicacionVincular(e.target.value)}
                    className="flex-1 rounded-lg border border-emerald-700 bg-emerald-950/80 px-3 py-2 text-sm outline-none focus:ring focus:ring-emerald-500/60"
                    placeholder="ID de publicaciÃ³n"
                  />
                  <button
                    type="submit"
                    className="px-4 py-2 rounded-lg bg-emerald-500 hover:bg-emerald-600 text-sm font-semibold text-emerald-950"
                  >
                    Vincular
                  </button>
                </form>
              </>
            ) : (
              <p className="text-xs text-emerald-100/80">
                Primero selecciona una promociÃ³n del listado para poder
                vincularle publicaciones.
              </p>
            )}
          </div>
        </section>
      </div>
    </div>
  );
}
</file>

<file path="frontend/src/pages/Publicaciones.jsx">
// digital-barder/frontend/src/pages/Publicaciones.jsx
import { useEffect, useState } from "react";
import { api, crearIntercambio } from "../services/api";
import hoja from "../assets/hoja.png";

// Base de la API (ej: http://localhost:4000/api)
const API_BASE_URL =
  import.meta.env.VITE_API_URL || "http://localhost:4000/api";
// Base de archivos (sin /api, ej: http://localhost:4000)
const FILE_BASE_URL = API_BASE_URL.replace(/\/api\/?$/, "");

export default function Publicaciones() {
  const [publicaciones, setPublicaciones] = useState([]);
  const [cargando, setCargando] = useState(true);
  const [error, setError] = useState("");
  const [filtroTexto, setFiltroTexto] = useState("");
  const [filtroCategoria, setFiltroCategoria] = useState("TODAS");

  useEffect(() => {
    cargarPublicaciones();
  }, []);

  async function cargarPublicaciones() {
    try {
      setError("");
      setCargando(true);
      const data = await api("/publicaciones");
      setPublicaciones(Array.isArray(data) ? data : []);
    } catch (err) {
      console.error(err);
      setError("No se pudieron cargar las publicaciones.");
    } finally {
      setCargando(false);
    }
  }

  // Lista de categorÃ­as Ãºnicas
  const categorias = [
    "TODAS",
    ...Array.from(
      new Set(
        publicaciones
          .map((p) => p.categoria)
          .filter(Boolean)
      )
    ),
  ];

  // Filtros (solo PUBLICADAS en el marketplace)
  const filtradas = publicaciones.filter((p) => {
    const estado = (p.estado || "").toUpperCase();

    // Solo mostrar publicaciones PUBLICADA
    if (estado !== "PUBLICADA") return false;

    const texto = filtroTexto.trim().toLowerCase();
    const coincideTexto =
      !texto ||
      (p.titulo || "").toLowerCase().includes(texto) ||
      (p.descripcion || "").toLowerCase().includes(texto);

    const categoriaPub = p.categoria || "OTROS";
    const coincideCategoria =
      filtroCategoria === "TODAS" || filtroCategoria === categoriaPub;

    return coincideTexto && coincideCategoria;
  });

  // ðŸ‘‰ Intercambiar publicaciÃ³n
  async function handleIntercambiar(pub) {
    const creditos = Number(pub.valor_creditos || 0);

    if (!pub.id_publicacion || !creditos) {
      alert("No se pudo determinar la publicaciÃ³n o sus crÃ©ditos.");
      return;
    }

    const ok = window.confirm(
      `Â¿Quieres intercambiar ${creditos} crÃ©ditos por "${pub.titulo}"?`
    );
    if (!ok) return;

    try {
      await crearIntercambio({
        id_publicacion: pub.id_publicacion,
        creditos,
      });

      alert("Intercambio realizado correctamente âœ…");
      // Recargar: la publicaciÃ³n pasa a AGOTADA en BD y ya no pasa el filtro
      await cargarPublicaciones();
    } catch (err) {
      console.error(err);
      alert(
        err.message ||
          "OcurriÃ³ un error al realizar el intercambio. Revisa tu saldo."
      );
    }
  }

  return (
    <div className="min-h-screen bg-[#082b1f] text-white p-6 md:p-10">
      {/* HEADER */}
      <div className="flex items-center justify-between gap-3 mb-8">
        <div className="flex items-center gap-3">
          <img src={hoja} alt="logo" className="w-10 h-10 drop-shadow-lg" />
          <h1 className="text-3xl font-bold text-emerald-400">
            Marketplace
          </h1>
        </div>

        <div className="flex gap-2">
          <a
            href="/publicaciones/nueva"
            className="bg-emerald-500 hover:bg-emerald-600 px-4 py-2 rounded-lg font-semibold"
          >
            Crear publicaciÃ³n
          </a>
          <a
            href="/publicaciones/mias"
            className="bg-emerald-500 hover:bg-emerald-600 px-4 py-2 rounded-lg font-semibold"
          >
            Mis publicaciones
          </a>
        </div>
      </div>

      {/* FILTROS */}
      <div className="bg-[#0f3f2d] border border-emerald-600 rounded-xl p-4 mb-6 flex flex-col md:flex-row gap-4 md:items-center">
        <div className="flex-1">
          <label className="block text-sm text-emerald-200 mb-1">
            Buscar
          </label>
          <input
            type="text"
            value={filtroTexto}
            onChange={(e) => setFiltroTexto(e.target.value)}
            placeholder="TÃ­tulo o descripciÃ³n..."
            className="w-full bg-[#0e4330] border border-emerald-600 rounded-lg px-3 py-2 outline-none focus:ring-2 focus:ring-emerald-400"
          />
        </div>

        <div className="w-full md:w-64">
          <label className="block text-sm text-emerald-200 mb-1">
            CategorÃ­a
          </label>
          <select
            value={filtroCategoria}
            onChange={(e) => setFiltroCategoria(e.target.value)}
            className="w-full bg-[#0e4330] border border-emerald-600 rounded-lg px-3 py-2 outline-none focus:ring-2 focus:ring-emerald-400"
          >
            {categorias.map((c) => (
              <option key={c} value={c}>
                {c === "TODAS" ? "Todas las categorÃ­as" : c}
              </option>
            ))}
          </select>
        </div>
      </div>

      {/* ERRORES */}
      {error && (
        <div className="mb-4 rounded-md border border-red-400 bg-red-900/40 px-4 py-2 text-sm text-red-100">
          {error}
        </div>
      )}

      {/* LISTA DE PUBLICACIONES */}
      {cargando ? (
        <div className="text-center text-emerald-100/80">Cargando...</div>
      ) : filtradas.length === 0 ? (
        <div className="text-center text-emerald-100/80">
          No se encontraron publicaciones disponibles con los filtros actuales.
        </div>
      ) : (
        <div className="grid gap-5 md:grid-cols-3">
          {filtradas.map((p) => {
            const estado = (p.estado || "").toUpperCase();
            const esActiva = estado === "PUBLICADA";

            // Construir URL completa del archivo
            let archivoUrl = null;
            if (p.imagen_url) {
              const path = p.imagen_url.startsWith("/")
                ? p.imagen_url
                : "/" + p.imagen_url;
              archivoUrl = p.imagen_url.startsWith("http")
                ? p.imagen_url
                : FILE_BASE_URL + path;
            }

            const esImagenVisible =
              archivoUrl &&
              /\.(png|jpe?g|gif|webp|bmp)$/i.test(archivoUrl || "");

            return (
              <article
                key={p.id_publicacion}
                className="bg-[#0f3f2d] border border-emerald-700 rounded-xl p-4 shadow-md flex flex-col"
              >
                {/* Vista de archivo / imagen */}
                {esImagenVisible && (
                  <img
                    src={archivoUrl}
                    alt={p.titulo}
                    className="w-full h-40 object-cover rounded-lg mb-3"
                  />
                )}

                {!esImagenVisible && archivoUrl && (
                  <a
                    href={archivoUrl}
                    target="_blank"
                    rel="noreferrer"
                    className="mb-3 inline-flex items-center gap-2 text-xs text-emerald-200 underline"
                  >
                    Ver archivo adjunto
                  </a>
                )}

                <h2 className="text-lg font-semibold text-emerald-200">
                  {p.titulo}
                </h2>

                <p className="text-xs text-emerald-300/80 mt-1">
                  {p.categoria || "Sin categorÃ­a"} Â· {p.usuario}
                </p>

                <p className="mt-2 text-sm text-emerald-100/90 line-clamp-3">
                  {p.descripcion || "Sin descripciÃ³n"}
                </p>

                <div className="mt-3 flex items-center justify-between text-sm">
                  <span className="font-semibold text-emerald-300">
                    {p.valor_creditos} cr.
                  </span>
                  <span className="text-xs px-2 py-1 rounded-full border border-emerald-400 text-emerald-300">
                    {estado}
                  </span>
                </div>

                <button
                  type="button"
                  className="mt-4 w-full rounded-lg bg-emerald-500/20 border border-emerald-500 py-2 text-sm font-semibold text-emerald-200"
                  onClick={() =>
                    alert(
                      "AquÃ­ mÃ¡s adelante podemos abrir el detalle o flujo de intercambio."
                    )
                  }
                >
                  Ver detalle
                </button>

                <button
                  onClick={() => esActiva && handleIntercambiar(p)}
                  disabled={!esActiva}
                  className={`mt-3 w-full bg-emerald-500 hover:bg-emerald-600 text-emerald-950 font-semibold py-2 rounded-xl ${
                    !esActiva ? "opacity-60 cursor-not-allowed" : ""
                  }`}
                >
                  Intercambiar
                </button>
              </article>
            );
          })}
        </div>
      )}
    </div>
  );
}
</file>

<file path="frontend/src/pages/PublicacionNueva.jsx">
import { useEffect, useState } from "react";
import { useNavigate } from "react-router-dom";
import { api } from "../services/api";
import hoja from "../assets/hoja.png";

export default function PublicacionNueva() {
  const [tipo, setTipo] = useState("PRODUCTO"); // PRODUCTO | SERVICIO
  const [titulo, setTitulo] = useState("");
  const [descripcion, setDescripcion] = useState("");
  const [idCategoria, setIdCategoria] = useState("");
  const [costoCreditos, setCostoCreditos] = useState("");
  const [cantidad, setCantidad] = useState("");
  const [horario, setHorario] = useState("A convenir");

  const [imagenFile, setImagenFile] = useState(null);
  const [imagenPreview, setImagenPreview] = useState(null);

  const [loading, setLoading] = useState(false);
  const [mensajeError, setMensajeError] = useState("");
  const [mensajeOk, setMensajeOk] = useState("");

  // CATEGORÃAS
  const [categorias, setCategorias] = useState([]);
  const [cargandoCategorias, setCargandoCategorias] = useState(false);

  const navigate = useNavigate();

  // â¬‡ï¸ CARGAR CATEGORÃAS ORDENADAS
  useEffect(() => {
    async function cargarCategorias() {
      try {
        setCargandoCategorias(true);
        const res = await api("/catalogos/categorias");

        const lista = Array.isArray(res)
          ? res
          : Array.isArray(res.data)
          ? res.data
          : [];

        const ordenadas = [...lista].sort(
          (a, b) => Number(a.id_categoria) - Number(b.id_categoria)
        );

        setCategorias(ordenadas);
      } catch (err) {
        console.error("Error cargando categorÃ­as", err);
        setCategorias([]);
      } finally {
        setCargandoCategorias(false);
      }
    }

    cargarCategorias();
  }, []);

  // ENVIAR FORM
  async function manejarSubmit(e) {
    e.preventDefault();
    setMensajeError("");
    setMensajeOk("");

    if (!titulo.trim() || !descripcion.trim() || !idCategoria || !costoCreditos) {
      setMensajeError("TÃ­tulo, descripciÃ³n, categorÃ­a y crÃ©ditos son obligatorios.");
      return;
    }

    try {
      setLoading(true);

      // 1) Subir archivo si existe (PRODUCTO + SERVICIO)
      let imagenURL = null;
      if (imagenFile) {
        const formData = new FormData();
        formData.append("archivo", imagenFile);

        const resUpload = await api("/uploads", {
          method: "POST",
          body: formData,
        });

        // â¬‡ï¸â¬‡ï¸ CAMBIO IMPORTANTE: leer la URL real del backend
        imagenURL =
          resUpload?.data?.url ||
          resUpload?.data?.imagen_url ||
          resUpload?.url ||
          resUpload?.imagen_url ||
          null;
      }

      // 2) Body base para ambos tipos
      const base = {
        titulo: titulo.trim(),
        descripcion: descripcion.trim(),
        id_categoria: Number(idCategoria),
        valor_creditos: Number(costoCreditos),
        imagen_url: imagenURL,
      };

      let endpoint = "";
      let body = {};

      if (tipo === "PRODUCTO") {
        endpoint = "/publicaciones/producto";

        body = {
          ...base,
          producto: {
            nombre: titulo.trim(),
            descripcion: descripcion.trim(),
            precio: null,
            peso: null,
          },
          cantidad: Number(cantidad || 1),
          id_um: 1,
        };
      } else {
        endpoint = "/publicaciones/servicio";

        body = {
          ...base,
          servicio: {
            nombre: titulo.trim(),
            descripcion: descripcion.trim(),
            precio: null,
            duracion_min: null,
          },
          horario: horario || "A convenir",
        };
      }

      await api(endpoint, {
        method: "POST",
        body,
      });

      setMensajeOk("PublicaciÃ³n creada correctamente");

      // limpiar
      setTitulo("");
      setDescripcion("");
      setIdCategoria("");
      setCostoCreditos("");
      setCantidad("");
      setHorario("A convenir");
      setImagenFile(null);
      setImagenPreview(null);

      setTimeout(() => {
        navigate("/publicaciones/mias");
      }, 1200);
    } catch (err) {
      console.error(err);
      setMensajeError(
        err.message || "OcurriÃ³ un error al crear la publicaciÃ³n."
      );
    } finally {
      setLoading(false);
    }
  }

  return (
    <div className="min-h-screen bg-[#082b1f] text-white p-6 md:p-10">
      {/* HEADER */}
      <div className="flex items-center justify-between gap-3 mb-8">
        <div className="flex items-center gap-3">
          <img src={hoja} alt="logo" className="w-10 h-10 drop-shadow-lg" />
          <div>
            <h1 className="text-3xl font-bold text-emerald-400">
              Nueva publicaciÃ³n
            </h1>
            <p className="text-sm text-emerald-100/80">
              Publica un producto o servicio para intercambiar con crÃ©ditos verdes.
            </p>
          </div>
        </div>

        <button
          type="button"
          onClick={() => navigate(-1)}
          className="px-4 py-2 rounded-lg border border-emerald-500 text-sm hover:bg-emerald-500/10"
        >
          Volver
        </button>
      </div>

      {/* MENSAJES */}
      {mensajeError && (
        <div className="mb-4 rounded-md border border-red-400 bg-red-900/40 px-4 py-2 text-sm text-red-100">
          {mensajeError}
        </div>
      )}

      {mensajeOk && (
        <div className="mb-4 rounded-md border border-emerald-400 bg-emerald-900/40 px-4 py-2 text-sm text-emerald-100">
          {mensajeOk}
        </div>
      )}

      {/* FORM */}
      <form
        onSubmit={manejarSubmit}
        className="bg-[#0f3f2d] border border-emerald-700 rounded-xl p-6 md:p-8 max-w-3xl mx-auto space-y-6"
      >
        {/* Tipo */}
        <div>
          <span className="block text-sm font-semibold text-emerald-200 mb-2">
            Tipo de publicaciÃ³n
          </span>
          <div className="flex gap-3">
            <button
              type="button"
              onClick={() => setTipo("PRODUCTO")}
              className={`flex-1 py-2 rounded-lg border text-sm font-semibold
                ${
                  tipo === "PRODUCTO"
                    ? "bg-emerald-500 text-black border-emerald-400"
                    : "bg-[#0e4330] border-emerald-700 hover:border-emerald-500"
                }`}
            >
              Producto
            </button>
            <button
              type="button"
              onClick={() => setTipo("SERVICIO")}
              className={`flex-1 py-2 rounded-lg border text-sm font-semibold
                ${
                  tipo === "SERVICIO"
                    ? "bg-emerald-500 text-black border-emerald-400"
                    : "bg-[#0e4330] border-emerald-700 hover:border-emerald-500"
                }`}
            >
              Servicio
            </button>
          </div>
        </div>

        {/* TÃ­tulo */}
        <div>
          <label className="block text-sm text-emerald-200 mb-1">
            TÃ­tulo *
          </label>
          <input
            type="text"
            value={titulo}
            onChange={(e) => setTitulo(e.target.value)}
            className="w-full bg-[#0e4330] border border-emerald-600 rounded-lg px-3 py-2 outline-none focus:ring-2 focus:ring-emerald-400"
            placeholder="Ej. Sudadera, Clases de inglÃ©s..."
          />
        </div>

        {/* DescripciÃ³n */}
        <div>
          <label className="block text-sm text-emerald-200 mb-1">
            DescripciÃ³n *
          </label>
          <textarea
            value={descripcion}
            onChange={(e) => setDescripcion(e.target.value)}
            rows={4}
            className="w-full bg-[#0e4330] border border-emerald-600 rounded-lg px-3 py-2 outline-none focus:ring-2 focus:ring-emerald-400 resize-y"
            placeholder="Describe brevemente el producto o servicio..."
          />
        </div>

        {/* CategorÃ­a + CrÃ©ditos */}
        <div className="grid gap-4 md:grid-cols-2">
          {/* CategorÃ­a */}
          <div>
            <label className="block text-sm text-emerald-200 mb-1">
              CategorÃ­a *
            </label>
            <select
              value={idCategoria}
              onChange={(e) => setIdCategoria(e.target.value)}
              className="w-full bg-[#0e4330] border border-emerald-600 rounded-lg px-3 py-2 outline-none focus:ring-2 focus:ring-emerald-400"
            >
              <option value="">
                {cargandoCategorias
                  ? "Cargando categorÃ­as..."
                  : "Selecciona una categorÃ­a"}
              </option>

              {categorias.map((cat) => (
                <option key={cat.id_categoria} value={cat.id_categoria}>
                  {cat.id_categoria} - {cat.nombre}
                </option>
              ))}
            </select>
          </div>

          {/* CrÃ©ditos */}
          <div>
            <label className="block text-sm text-emerald-200 mb-1">
              Costo en crÃ©ditos *
            </label>
            <input
              type="number"
              min="1"
              value={costoCreditos}
              onChange={(e) => setCostoCreditos(e.target.value)}
              className="w-full bg-[#0e4330] border border-emerald-600 rounded-lg px-3 py-2 outline-none focus:ring-2 focus:ring-emerald-400"
              placeholder="Ej. 100"
            />
          </div>
        </div>

        {/* Producto o Servicio */}
        {tipo === "PRODUCTO" ? (
          <div>
            <label className="block text-sm text-emerald-200 mb-1">
              Cantidad disponible
            </label>
            <input
              type="number"
              min="1"
              value={cantidad}
              onChange={(e) => setCantidad(e.target.value)}
              className="w-full bg-[#0e4330] border border-emerald-600 rounded-lg px-3 py-2 outline-none focus:ring-2 focus:ring-emerald-400"
              placeholder="Por defecto 1"
            />
          </div>
        ) : (
          <div>
            <label className="block text-sm text-emerald-200 mb-1">
              Horario (para el servicio)
            </label>
            <input
              type="text"
              value={horario}
              onChange={(e) => setHorario(e.target.value)}
              className="w-full bg-[#0e4330] border border-emerald-600 rounded-lg px-3 py-2 outline-none focus:ring-2 focus:ring-emerald-400"
              placeholder="Ej. Fines de semana por la tarde"
            />
          </div>
        )}

        {/* ARCHIVO (PRODUCTO + SERVICIO) */}
        <div>
          <label className="block text-sm text-emerald-200 mb-1">
            Archivo (imagen, PDF, etc. â€” opcional)
          </label>
          <input
            type="file"
            onChange={(e) => {
              const file = e.target.files?.[0];
              setImagenFile(file || null);

              if (file && file.type.startsWith("image/")) {
                setImagenPreview(URL.createObjectURL(file));
              } else {
                setImagenPreview(null);
              }
            }}
            className="block w-full text-sm text-emerald-100 file:mr-4 file:rounded-lg file:border-0 file:bg-emerald-500 file:px-3 file:py-1 file:text-sm file:font-semibold hover:file:bg-emerald-600"
          />

          {imagenPreview && (
            <img
              src={imagenPreview}
              alt="PrevisualizaciÃ³n"
              className="mt-3 w-40 h-32 object-cover rounded-lg border border-emerald-600"
            />
          )}
        </div>

        {/* BOTONES */}
        <div className="flex justify-end gap-3 pt-4">
          <button
            type="button"
            onClick={() => navigate("/publicaciones/mias")}
            className="px-4 py-2 rounded-lg border border-emerald-500 text-sm hover:bg-emerald-500/10"
          >
            Cancelar
          </button>
          <button
            type="submit"
            disabled={loading}
            className={`px-5 py-2 rounded-lg text-sm font-semibold
              ${
                loading
                  ? "bg-gray-500 cursor-not-allowed"
                  : "bg-emerald-500 hover:bg-emerald-600"
              }`}
          >
            {loading ? "Guardando..." : "Publicar"}
          </button>
        </div>
      </form>
    </div>
  );
}
</file>

<file path="frontend/src/pages/Publicidad.jsx">
// digital-barder/frontend/src/pages/Publicidad.jsx
import { useEffect, useState } from "react";
import { useNavigate } from "react-router-dom";
import { getPublicidadActiva, crearPublicidad } from "../services/api";
import {
  ArrowLeft,
  Megaphone,
  Monitor,
  CalendarRange,
  ExternalLink,
  Coins,
} from "lucide-react";
import hoja from "../assets/hoja.png";

export default function Publicidad() {
  const navigate = useNavigate();

  const [anuncios, setAnuncios] = useState([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState("");
  const [mensajeOk, setMensajeOk] = useState("");

  // formulario nueva publicidad
  const [idUbicacion, setIdUbicacion] = useState("");
  const [titulo, setTitulo] = useState("");
  const [descripcion, setDescripcion] = useState("");
  const [urlDestino, setUrlDestino] = useState("");
  const [fechaInicio, setFechaInicio] = useState("");
  const [fechaFin, setFechaFin] = useState("");
  const [costoCreditos, setCostoCreditos] = useState("");

  useEffect(() => {
    cargarPublicidad();
  }, []);

  async function cargarPublicidad() {
    try {
      setLoading(true);
      setError("");
      const data = await getPublicidadActiva();
      setAnuncios(Array.isArray(data) ? data : []);
    } catch (err) {
      console.error(err);
      setError(
        err.message || "No se pudo cargar la publicidad activa."
      );
    } finally {
      setLoading(false);
    }
  }

  async function handleCrearPublicidad(e) {
    e.preventDefault();
    setError("");
    setMensajeOk("");

    const id_ubicacion = Number(idUbicacion || 0);
    const costo_creditos = Number(costoCreditos || 0);

    if (!id_ubicacion || !titulo.trim() || !fechaInicio || !fechaFin || !costo_creditos) {
      setError(
        "id_ubicacion, tÃ­tulo, fecha inicio, fecha fin y costo en crÃ©ditos son obligatorios."
      );
      return;
    }

    try {
      await crearPublicidad({
        id_ubicacion,
        titulo,
        descripcion,
        url_destino: urlDestino || null,
        fecha_inicio: fechaInicio,
        fecha_fin: fechaFin,
        costo_creditos,
      });

      setMensajeOk("Publicidad creada correctamente.");
      // limpiar
      setIdUbicacion("");
      setTitulo("");
      setDescripcion("");
      setUrlDestino("");
      setFechaInicio("");
      setFechaFin("");
      setCostoCreditos("");

      await cargarPublicidad();
    } catch (err) {
      console.error(err);
      setError(
        err.message || "OcurriÃ³ un error al crear la publicidad."
      );
    }
  }

  return (
    <div className="min-h-screen bg-[#082b1f] text-white p-6 md:p-10">
      {/* HEADER */}
      <header className="flex items-center justify-between gap-4 mb-8">
        <div className="flex items-center gap-3">
          <button
            type="button"
            onClick={() => navigate(-1)}
            className="inline-flex items-center gap-2 rounded-full bg-black/30 px-3 py-1 text-sm hover:bg-black/40"
          >
            <ArrowLeft size={16} />
            Volver
          </button>

          <div className="flex items-center gap-2 rounded-2xl bg-emerald-900/70 px-3 py-2 text-sm">
            <Megaphone size={18} className="text-emerald-300" />
            <span className="font-semibold">GestiÃ³n de publicidad</span>
          </div>
        </div>

        <div className="flex items-center gap-3">
          <span className="text-sm text-emerald-100/80 flex items-center gap-1">
            <Monitor size={16} className="text-emerald-300" />
            Activos:{" "}
            <span className="font-semibold text-emerald-300">
              {anuncios.length}
            </span>
          </span>
          <img src={hoja} alt="logo" className="w-9 h-9 drop-shadow-md" />
        </div>
      </header>

      {/* MENSAJES */}
      {error && (
        <div className="mb-4 rounded-md border border-red-400 bg-red-900/40 px-4 py-2 text-sm text-red-100">
          {error}
        </div>
      )}

      {mensajeOk && (
        <div className="mb-4 rounded-md border border-emerald-400 bg-emerald-900/40 px-4 py-2 text-sm text-emerald-100">
          {mensajeOk}
        </div>
      )}

      {/* CONTENIDO: LISTADO + FORMULARIO */}
      <div className="grid gap-6 lg:grid-cols-[2fr,1.5fr]">
        {/* LISTADO DE PUBLICIDAD ACTIVA */}
        <section className="bg-[#0f3f2d] border border-emerald-700 rounded-2xl p-4 md:p-5 shadow-md">
          <h2 className="text-lg font-semibold text-emerald-200 flex items-center gap-2 mb-3">
            <Monitor size={18} className="text-emerald-300" />
            Publicidad activa
          </h2>

          {loading ? (
            <p className="text-emerald-100/80 text-sm">
              Cargando anuncios...
            </p>
          ) : anuncios.length === 0 ? (
            <p className="text-emerald-100/80 text-sm">
              No hay publicidad activa en este momento.
            </p>
          ) : (
            <div className="space-y-3 max-h-[480px] overflow-y-auto pr-1">
              {anuncios.map((ad) => (
                <article
                  key={ad.id_publicidad}
                  className="rounded-xl border border-emerald-700/70 bg-emerald-900/30 p-3 text-sm flex flex-col gap-2"
                >
                  <div className="flex items-center justify-between gap-3">
                    <div>
                      <p className="text-xs text-emerald-300/80">
                        ID #{ad.id_publicidad} Â· {ad.usuario || "Usuario"}
                      </p>
                      <h3 className="font-semibold text-emerald-100">
                        {ad.titulo}
                      </h3>
                    </div>

                    {typeof ad.costo_creditos === "number" && (
                      <div className="flex items-center gap-1 text-[11px] px-2 py-1 rounded-full bg-emerald-800/70 border border-emerald-500/70">
                        <Coins size={14} className="text-emerald-300" />
                        <span>{ad.costo_creditos} cr.</span>
                      </div>
                    )}
                  </div>

                  {ad.descripcion && (
                    <p className="text-emerald-100/80 text-xs">
                      {ad.descripcion}
                    </p>
                  )}

                  <div className="flex flex-wrap gap-3 text-[11px] text-emerald-200/80 mt-1">
                    {ad.fecha_inicio && (
                      <span>
                        Inicio:{" "}
                        {new Date(ad.fecha_inicio).toLocaleDateString()}
                      </span>
                    )}
                    {ad.fecha_fin && (
                      <span>
                        Fin: {new Date(ad.fecha_fin).toLocaleDateString()}
                      </span>
                    )}
                    {ad.id_ubicacion && (
                      <span>UbicaciÃ³n #{ad.id_ubicacion}</span>
                    )}
                  </div>

                  {ad.url_destino && (
                    <a
                      href={ad.url_destino}
                      target="_blank"
                      rel="noopener noreferrer"
                      className="mt-2 inline-flex items-center gap-1 text-xs text-emerald-300 hover:text-emerald-100"
                    >
                      <ExternalLink size={14} />
                      Ver destino
                    </a>
                  )}
                </article>
              ))}
            </div>
          )}
        </section>

        {/* FORMULARIO NUEVA PUBLICIDAD */}
        <section className="bg-[#0f3f2d] border border-emerald-700 rounded-2xl p-4 md:p-5 shadow-md">
          <h2 className="text-lg font-semibold text-emerald-200 flex items-center gap-2 mb-3">
            <Megaphone size={18} className="text-emerald-300" />
            Crear nueva publicidad
          </h2>

          <p className="text-xs text-emerald-100/80 mb-3">
            Esta campaÃ±a descontarÃ¡ crÃ©ditos de la billetera del usuario que la
            publica, segÃºn el costo configurado y la ubicaciÃ³n seleccionada.
          </p>

          <form onSubmit={handleCrearPublicidad} className="space-y-3 text-sm">
            {/* id_ubicacion */}
            <div>
              <label className="block text-xs mb-1">
                ID de ubicaciÃ³n (id_ubicacion) *
              </label>
              <input
                type="number"
                value={idUbicacion}
                onChange={(e) => setIdUbicacion(e.target.value)}
                className="w-full rounded-lg border border-emerald-700 bg-emerald-950/80 px-3 py-2 text-sm outline-none focus:ring focus:ring-emerald-500/60"
                placeholder="Ej. 1 (header), 2 (sidebar), 3 (dashboard)..."
              />
            </div>

            {/* tÃ­tulo */}
            <div>
              <label className="block text-xs mb-1">TÃ­tulo *</label>
              <input
                type="text"
                value={titulo}
                onChange={(e) => setTitulo(e.target.value)}
                className="w-full rounded-lg border border-emerald-700 bg-emerald-950/80 px-3 py-2 text-sm outline-none focus:ring focus:ring-emerald-500/60"
                placeholder="Ej. Promociona tu ecoservicio aquÃ­"
              />
            </div>

            {/* descripciÃ³n */}
            <div>
              <label className="block text-xs mb-1">DescripciÃ³n</label>
              <textarea
                value={descripcion}
                onChange={(e) => setDescripcion(e.target.value)}
                rows={3}
                className="w-full rounded-lg border border-emerald-700 bg-emerald-950/80 px-3 py-2 text-sm outline-none focus:ring focus:ring-emerald-500/60"
                placeholder="Describe brevemente el anuncio o campaÃ±a..."
              />
            </div>

            {/* url_destino */}
            <div>
              <label className="block text-xs mb-1">
                URL de destino (opcional)
              </label>
              <input
                type="url"
                value={urlDestino}
                onChange={(e) => setUrlDestino(e.target.value)}
                className="w-full rounded-lg border border-emerald-700 bg-emerald-950/80 px-3 py-2 text-sm outline-none focus:ring focus:ring-emerald-500/60"
                placeholder="https://ejemplo.com/mi-campaÃ±a"
              />
            </div>

            {/* costo_creditos */}
            <div>
              <label className="block text-xs mb-1">
                Costo en crÃ©ditos (costo_creditos) *
              </label>
              <input
                type="number"
                value={costoCreditos}
                onChange={(e) => setCostoCreditos(e.target.value)}
                className="w-full rounded-lg border border-emerald-700 bg-emerald-950/80 px-3 py-2 text-sm outline-none focus:ring focus:ring-emerald-500/60"
                placeholder="Ej. 50"
              />
            </div>

            {/* fechas */}
            <div className="grid grid-cols-2 gap-3">
              <div>
                <label className="block text-xs mb-1">Fecha inicio *</label>
                <input
                  type="date"
                  value={fechaInicio}
                  onChange={(e) => setFechaInicio(e.target.value)}
                  className="w-full rounded-lg border border-emerald-700 bg-emerald-950/80 px-3 py-2 text-sm outline-none focus:ring focus:ring-emerald-500/60"
                />
              </div>
              <div>
                <label className="block text-xs mb-1">Fecha fin *</label>
                <input
                  type="date"
                  value={fechaFin}
                  onChange={(e) => setFechaFin(e.target.value)}
                  className="w-full rounded-lg border border-emerald-700 bg-emerald-950/80 px-3 py-2 text-sm outline-none focus:ring focus:ring-emerald-500/60"
                />
              </div>
            </div>

            <div className="pt-2 flex justify-end">
              <button
                type="submit"
                className="px-6 py-2 rounded-lg bg-emerald-500 hover:bg-emerald-600 text-sm font-semibold text-emerald-950"
              >
                Guardar publicidad
              </button>
            </div>
          </form>
        </section>
      </div>
    </div>
  );
}
</file>

<file path="frontend/src/pages/Register.jsx">
// frontend/src/pages/Register.jsx
import React, { useState, useEffect } from "react";
import { Link, useNavigate } from "react-router-dom";
import { register } from "../services/api";
import hojaLogo from "../assets/hoja.png";
import aurella from '../assets/aurella.png';
import aurela from '../assets/aurela.png';
const SLIDES = [
  {
    id: 1,
    
    image:
      aurela,
  },
  {
    id: 2,
    
    image:
      aurella,
  },
  {
    id: 3,
    title: "Impacto ambiental positivo",
    text: "Reduce COâ‚‚, agua y energÃ­a con cada intercambio.",
    image:
      "https://images.pexels.com/photos/286763/pexels-photo-286763.jpeg?auto=compress&cs=tinysrgb&w=1600",
  },
];

export default function Register() {
  const [nombre, setNombre] = useState("");
  const [apellidos, setApellidos] = useState("");
  const [correo, setCorreo] = useState("");
  const [telefono, setTelefono] = useState("");
  const [password, setPassword] = useState("");
  const [password2, setPassword2] = useState("");

  const [dia, setDia] = useState("22");
  const [mes, setMes] = useState("sept.");
  const [anio, setAnio] = useState("2025");
  const [genero, setGenero] = useState("Hombre");
  const [tipoUsuario, setTipoUsuario] = useState("Emprendedor");

  const [error, setError] = useState("");
  const [ok, setOk] = useState("");
  const [loading, setLoading] = useState(false);
  const [slideIndex, setSlideIndex] = useState(0);

  const navigate = useNavigate();

  useEffect(() => {
    const id = setInterval(
      () => setSlideIndex((prev) => (prev + 1) % SLIDES.length),
      5000
    );
    return () => clearInterval(id);
  }, []);

  const currentSlide = SLIDES[slideIndex];

  const dias = Array.from({ length: 31 }, (_, i) => String(i + 1));
  const anios = Array.from({ length: 80 }, (_, i) => String(2025 - i));

  async function handleSubmit(e) {
    e.preventDefault();
    setError("");
    setOk("");

    if (!nombre || !correo || !password || !password2) {
      setError("Nombre, correo y contraseÃ±as son obligatorios.");
      return;
    }

    if (password !== password2) {
      setError("Las contraseÃ±as no coinciden.");
      return;
    }

    try {
      setLoading(true);
      await register({
        nombre,
        apellido: apellidos,
        correo,
        password,
        telefono: telefono || undefined,
      });

      setOk("Cuenta creada correctamente. Ahora puedes iniciar sesiÃ³n.");
      navigate("/login");
    } catch (err) {
      console.error(err);
      setError(err.message || "No se pudo registrar el usuario.");
    } finally {
      setLoading(false);
    }
  }

  return (
    <div className="min-h-screen bg-gradient-to-br from-[#012b20] via-[#013726] to-[#011711] text-white flex flex-col">
      {/* NAVBAR SUPERIOR */}
      <header className="flex items-center justify-between px-10 py-4">
        <div className="flex items-center gap-3">
          <div className="flex items-center justify-center w-10 h-10 rounded-full bg-white/10">
            <img
              src={hojaLogo}
              alt="Logo Digital Barter"
              className="w-7 h-7 object-contain"
            />
          </div>
          <div>
            <h1 className="text-2xl font-black leading-tight tracking-tight">
              Digital Barter
            </h1>
            <p className="text-sm text-green-300 font-semibold flex items-center gap-1">
              green credits
              <span className="inline-block w-2 h-2 rounded-full bg-green-400" />
            </p>
          </div>
        </div>

        <Link
          to="/login"
          className="px-5 py-2 rounded-full bg-white text-green-900 font-semibold text-sm hover:bg-gray-100 transition"
        >
          Iniciar sesiÃ³n
        </Link>
      </header>

      {/* CONTENIDO PRINCIPAL */}
      <main className="flex-1 flex items-center justify-center gap-19 px-4 lg:px-12 pb-6">
        {/* PANEL IZQUIERDO: CARRUSEL ADELGAZADO */}
        <section className="flex-1 max-w-md bg-black/10 rounded-2xl overflow-hidden shadow-xl ">
          <div className="relative h-[580px]">
            <img
              src={currentSlide.image}
              alt={currentSlide.title}
              className="w-full h-full object"
            />
            <div className="absolute inset-0 bg-gradient-to-t from-black/70 via-black/20 to-transparent" />
            <div className="absolute inset-0 flex flex-col justify-end p-6">
              <h2 className="text-xl font-bold mb-2">{currentSlide.title}</h2>
              <p className="text-base text-gray-200 mb-4">{currentSlide.text}</p>
              <div className="flex gap-2">
                {SLIDES.map((s, idx) => (
                  <button
                    key={s.id}
                    onClick={() => setSlideIndex(idx)}
                    className={`w-2.5 h-2.5 rounded-full ${
                      idx === slideIndex ? "bg-white" : "bg-white/40"
                    }`}
                  />
                ))}
              </div>
            </div>
          </div>
        </section>

        {/* PANEL DERECHO: FORM REGISTRO EXPANDIDO */}
        <section className="w-full max-w-2xl rounded-3xl p-8">
          <h1
            className="text-center mb-8"
            style={{
              fontFamily: '"Berlin Sans FB Demi", system-ui, sans-serif',
              fontSize: "2.8rem",
              fontWeight: 700,
              letterSpacing: "0.08em",
              color: "#FFFFFF",
            }}
          >
            Crea una Cuenta
          </h1>

          {error && (
            <div className="mb-4 bg-red-500/20 border border-red-400 text-sm px-3 py-2 rounded-lg text-white">
              {error}
            </div>
          )}
          {ok && (
            <div className="mb-4 bg-green-500/20 border border-green-400 text-sm px-3 py-2 rounded-lg text-white">
              {ok}
            </div>
          )}

          <form onSubmit={handleSubmit} className="space-y-4">
            {/* Nombre / Apellidos */}
            <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
              <input
                type="text"
                value={nombre}
                onChange={(e) => setNombre(e.target.value)}
                placeholder="Nombre"
                className="w-full h-[60px] rounded-lg bg-[#E9FFD9] text-[#013726] px-4 text-[16px] font-medium border-none shadow placeholder-[#013726]/60"
              />
              <input
                type="text"
                value={apellidos}
                onChange={(e) => setApellidos(e.target.value)}
                placeholder="Apellidos"
                className="w-full h-[60px] rounded-lg bg-[#E9FFD9] text-[#013726] px-4 text-[16px] font-medium border-none shadow placeholder-[#013726]/60"
              />
            </div>

            {/* Fecha de nacimiento */}
            <div className="grid grid-cols-3 gap-3">
              <div className="flex flex-col">
                <label className="text-xs mb-1 text-gray-200 flex items-center gap-1">
                  Fecha de nacimiento
                  <span className="text-[0.7rem] w-4 h-4 rounded-full border border-gray-300 flex items-center justify-center">
                    ?
                  </span>
                </label>
                <select
                  value={dia}
                  onChange={(e) => setDia(e.target.value)}
                  className="w-full h-[60px] rounded-lg bg-[#E9FFD9] text-[#013726] px-4 text-[16px] font-medium border-none shadow"
                >
                  {dias.map((d) => (
                    <option key={d} value={d}>
                      {d}
                    </option>
                  ))}
                </select>
              </div>

              <div className="flex flex-col">
                <label className="text-xs mb-1 text-transparent select-none">
                  .
                </label>
                <select
                  value={mes}
                  onChange={(e) => setMes(e.target.value)}
                  className="w-full h-[60px] rounded-lg bg-[#E9FFD9] text-[#013726] px-4 text-[16px] font-medium border-none shadow"
                >
                  <option>ene.</option>
                  <option>feb.</option>
                  <option>mar.</option>
                  <option>abr.</option>
                  <option>may.</option>
                  <option>jun.</option>
                  <option>jul.</option>
                  <option>ago.</option>
                  <option>sept.</option>
                  <option>oct.</option>
                  <option>nov.</option>
                  <option>dic.</option>
                </select>
              </div>

              <div className="flex flex-col">
                <label className="text-xs mb-1 text-transparent select-none">
                  .
                </label>
                <select
                  value={anio}
                  onChange={(e) => setAnio(e.target.value)}
                  className="w-full h-[60px] rounded-lg bg-[#E9FFD9] text-[#013726] px-4 text-[16px] font-medium border-none shadow"
                >
                  {anios.map((a) => (
                    <option key={a} value={a}>
                      {a}
                    </option>
                  ))}
                </select>
              </div>
            </div>

            {/* GÃ©nero + Tipo Usuario */}
            <div className="grid grid-cols-3 gap-3">
              {/* GÃ©nero */}
              <div className="flex flex-col col-span-2">
                <label className="text-xs mb-1 text-gray-200 flex items-center gap-1">
                  GÃ©nero
                  <span className="text-[0.7rem] w-4 h-4 rounded-full border border-gray-300 flex items-center justify-center">
                    ?
                  </span>
                </label>
                <div className="grid grid-cols-2 gap-2">
                  <button
                    type="button"
                    onClick={() => setGenero("Hombre")}
                    className={`w-full h-[60px] rounded-lg flex items-center justify-between px-4 text-sm font-medium ${
                      genero === "Hombre"
                        ? "bg-[#E9FFD9] text-[#013726]"
                        : "bg-[#0b3a25] text-gray-100 border border-white/20"
                    }`}
                  >
                    <span>Hombre</span>
                    <span
                      className={`w-5 h-5 rounded-full ml-3 border flex items-center justify-center ${
                        genero === "Hombre"
                          ? "border-[#013726] bg-[#0fd46e]"
                          : "border-gray-300 bg-transparent"
                      }`}
                    >
                      {genero === "Hombre" && (
                        <span className="w-2.5 h-2.5 rounded-full bg-[#013726]" />
                      )}
                    </span>
                  </button>

                  <button
                    type="button"
                    onClick={() => setGenero("Mujer")}
                    className={`w-full h-[60px] rounded-lg flex items-center justify-between px-4 text-sm font-medium ${
                      genero === "Mujer"
                        ? "bg-[#E9FFD9] text-[#013726]"
                        : "bg-[#0b3a25] text-gray-100 border border-white/20"
                    }`}
                  >
                    <span>Mujer</span>
                    <span
                      className={`w-5 h-5 rounded-full ml-3 border flex items-center justify-center ${
                        genero === "Mujer"
                          ? "border-[#013726] bg-[#0fd46e]"
                          : "border-gray-300 bg-transparent"
                      }`}
                    >
                      {genero === "Mujer" && (
                        <span className="w-2.5 h-2.5 rounded-full bg-[#013726]" />
                      )}
                    </span>
                  </button>
                </div>
              </div>

              {/* Tipo Usuario */}
              <div className="flex flex-col">
                <label className="text-xs mb-1 text-gray-200">
                  Tipo Usuario
                </label>
                <select
                  value={tipoUsuario}
                  onChange={(e) => setTipoUsuario(e.target.value)}
                  className="w-full h-[60px] rounded-lg bg-[#E9FFD9] text-[#013726] px-4 text-[16px] font-medium border-none shadow"
                >
                  <option>Emprendedor</option>
                  <option>Consumidor</option>
                  <option>Ambos</option>
                </select>
              </div>
            </div>

            {/* Correo */}
            <input
              type="text"
              value={correo}
              onChange={(e) => setCorreo(e.target.value)}
              placeholder="NÃºmero de mÃ³vil o correo electrÃ³nico"
              className="w-full h-[60px] rounded-lg bg-[#E9FFD9] text-[#013726] px-4 text-[16px] font-medium border-none shadow placeholder-[#013726]/60"
            />

            {/* ContraseÃ±as */}
            <input
              type="password"
              value={password}
              onChange={(e) => setPassword(e.target.value)}
              placeholder="ContraseÃ±a"
              className="w-full h-[60px] rounded-lg bg-[#E9FFD9] text-[#013726] px-4 text-[16px] font-medium border-none shadow placeholder-[#013726]/60"
            />

            <input
              type="password"
              value={password2}
              onChange={(e) => setPassword2(e.target.value)}
              placeholder="Confirmar contraseÃ±a"
              className="w-full h-[60px] rounded-lg bg-[#E9FFD9] text-[#013726] px-4 text-[16px] font-medium border-none shadow placeholder-[#013726]/60"
            />

            {/* BotÃ³n Registrar */}
            <div className="flex flex-col items-center gap-3 pt-2">
              <button
                type="submit"
                disabled={loading}
                className="w-64 h-[52px] bg-[#0b7a35] hover:bg-[#0cb652] disabled:opacity-60 disabled:cursor-not-allowed text-white rounded-lg text-lg transition-colors"
                style={{
                  fontFamily:
                    '"Berlin Sans FB Demi", "Arial Black", sans-serif',
                  fontWeight: 700,
                }}
              >
                {loading ? "Registrando..." : "Registrar"}
              </button>

              <p className="text-xs text-gray-200">
                Â¿Ya tienes una cuenta?{" "}
                <Link to="/login" className="underline text-[#E9FFD9] hover:text-white transition-colors">
                  Inicia sesiÃ³n
                </Link>
              </p>
            </div>
          </form>
        </section>
      </main>

      {/* FOOTER MOVIDO A LA DERECHA INFERIOR */}
      <footer className="text-xs text-gray-300 pb-4 pr-6 self-end">
        Â¡Un poco mÃ¡s sobre nosotros!
      </footer>
    </div>
  );
}
</file>

<file path="frontend/src/pages/Reportes.jsx">
// frontend/src/pages/Reportes.jsx
import React from "react";
import { Link } from "react-router-dom";
import hoja from "../assets/hoja.png";

const reportesList = [
  {
    path: "/reportes/usuarios",
    title: "Usuarios activos y abandonados",
    description: "QuiÃ©nes estÃ¡n usando la plataforma y quiÃ©nes no.",
    categoria: "Usuarios",
  },
  {
    path: "/reportes/ingresos-creditos",
    title: "Ingresos por venta de crÃ©ditos",
    description: "CrÃ©ditos vendidos e ingresos en bolivianos.",
    categoria: "Finanzas",
  },
  {
    path: "/reportes/creditos-generados-consumidos",
    title: "CrÃ©ditos generados vs consumidos",
    description: "Balance global de crÃ©ditos generados y consumidos.",
    categoria: "CrÃ©ditos",
  },
  {
    path: "/reportes/intercambios-categoria",
    title: "Intercambios por categorÃ­a",
    description: "QuÃ© categorÃ­as tienen mÃ¡s movimiento en los intercambios.",
    categoria: "Intercambios",
  },
  {
    path: "/reportes/publicaciones-intercambios",
    title: "Publicaciones vs intercambios",
    description:
      "RelaciÃ³n entre lo publicado y lo que realmente se intercambia.",
    categoria: "Intercambios",
  },
  {
    path: "/reportes/impacto-acumulado",
    title: "Impacto ambiental acumulado",
    description: "COâ‚‚, agua y energÃ­a ahorrados en un perÃ­odo.",
    categoria: "Impacto ambiental",
  },
  {
    path: "/reportes/ranking-usuarios",
    title: "Ranking de usuarios por impacto",
    description: "Top de usuarios segÃºn su impacto ambiental.",
    categoria: "Usuarios",
  },
  {
    path: "/reportes/usuarios-premium",
    title: "Usuarios Premium",
    description: "AdopciÃ³n, actividad e ingresos por suscripciones premium.",
    categoria: "Premium",
  },
  {
    path: "/reportes/saldos-usuarios",
    title: "Saldos de crÃ©ditos por usuario",
    description: "CrÃ©ditos disponibles actualmente en las billeteras.",
    categoria: "CrÃ©ditos",
  },
  {
    path: "/reportes/actividades-sostenibles",
    title: "Actividades sostenibles",
    description: "Acciones ecolÃ³gicas registradas por los usuarios.",
    categoria: "Actividades",
  },
  {
    path: "/reportes/impacto-categoria",
    title: "Impacto ambiental por categorÃ­a",
    description: "Impacto ecolÃ³gico agrupado por categorÃ­a de publicaciÃ³n.",
    categoria: "Impacto ambiental",
  },
];

export default function Reportes() {
  return (
    <div className="min-h-screen bg-[#082b1f] text-emerald-50 px-4 py-8 md:px-8">
      {/* HEADER */}
      <header className="max-w-6xl mx-auto mb-8 flex flex-col gap-4 md:flex-row md:items-center md:justify-between">
        <div className="flex items-center gap-3">
          <div className="w-10 h-10 rounded-full bg-emerald-500/10 border border-emerald-400/70 flex items-center justify-center overflow-hidden">
            <img
              src={hoja}
              alt="Reportes Digital Barder"
              className="w-8 h-8 object-contain drop-shadow-[0_0_8px_rgba(16,185,129,0.8)]"
            />
          </div>
          <div>
            <h1 className="text-2xl md:text-3xl font-bold text-emerald-300">
              Reportes y analÃ­ticas
            </h1>
            <p className="text-sm text-emerald-100/80">
              Explora los reportes clave de usuarios, crÃ©ditos, intercambios e
              impacto ambiental.
            </p>
          </div>
        </div>
      </header>

      {/* CONTENIDO */}
      <main className="max-w-6xl mx-auto">
        <section>
          <h2 className="text-lg font-semibold text-emerald-200 mb-1">
            Tipos de reportes disponibles
          </h2>
          <p className="text-sm text-emerald-100/80 mb-4">
            Haz clic en cualquiera de los reportes para ver tablas detalladas,
            filtros por fecha y mÃ©tricas especÃ­ficas.
          </p>

          <div className="grid gap-4 md:grid-cols-2 xl:grid-cols-3">
            {reportesList.map((rep) => (
              <Link
                key={rep.path}
                to={rep.path}
                className="group rounded-2xl border border-emerald-700 bg-[#0f3f2d] p-4 shadow-lg hover:border-emerald-400 hover:bg-[#14533b] transition flex flex-col justify-between"
              >
                <div>
                  <p className="text-[11px] uppercase tracking-wide text-emerald-300/90 mb-1">
                    {rep.categoria}
                  </p>
                  <h3 className="text-base font-semibold text-emerald-50">
                    {rep.title}
                  </h3>
                  <p className="mt-1 text-sm text-emerald-100/80">
                    {rep.description}
                  </p>
                </div>

                <span className="mt-3 inline-flex items-center gap-1 text-[11px] font-semibold text-emerald-200 group-hover:text-emerald-50">
                  Ver reporte detallado
                  <span aria-hidden className="translate-y-[1px]">
                    â†’
                  </span>
                </span>
              </Link>
            ))}
          </div>
        </section>
      </main>
    </div>
  );
}
</file>

<file path="frontend/src/pages/ReportesActividadesSostenibles.jsx">
// frontend/src/pages/ReportesActividadesSostenibles.jsx
import React, { useEffect, useMemo, useState } from "react";
import {
  BarChart,
  Bar,
  XAxis,
  YAxis,
  Tooltip,
  ResponsiveContainer,
  PieChart,
  Pie,
  Legend,
  Cell,
} from "recharts";
import { getReporteActividadesSostenibles } from "../services/api";
import hoja from "../assets/hoja.png";

function hoyISO() {
  return new Date().toISOString().slice(0, 10);
}

function hace30DiasISO() {
  const d = new Date(Date.now() - 30 * 24 * 60 * 60 * 1000);
  return d.toISOString().slice(0, 10);
}

export default function ReportesActividadesSostenibles() {
  const [desde, setDesde] = useState(hace30DiasISO());
  const [hasta, setHasta] = useState(hoyISO());
  const [datos, setDatos] = useState([]);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState("");

  async function cargar() {
    try {
      setLoading(true);
      setError("");
      const res = await getReporteActividadesSostenibles({ desde, hasta });
      setDatos(Array.isArray(res) ? res : []);
    } catch (e) {
      console.error(e);
      setError("Error cargando actividades sostenibles.");
      setDatos([]);
    } finally {
      setLoading(false);
    }
  }

  useEffect(() => {
    cargar();
  }, []);

  function handleSubmit(e) {
    e.preventDefault();
    cargar();
  }

  const sinDatos = !loading && datos.length === 0;

  // MÃ‰TRICAS
  const metrics = useMemo(() => {
    if (!datos.length) {
      return {
        totalUsuarios: 0,
        totalActividades: 0,
        totalCreditos: 0,
        promedioCreditos: 0,
        topUsuario: null,
      };
    }

    const totalUsuarios = datos.length;
    const totalActividades = datos.reduce(
      (acc, it) => acc + Number(it.total_actividades || 0),
      0
    );
    const totalCreditos = datos.reduce(
      (acc, it) => acc + Number(it.creditos_otorgados || 0),
      0
    );
    const promedioCreditos =
      totalUsuarios ? totalCreditos / totalUsuarios : 0;

    const top = datos.reduce(
      (best, it) =>
        Number(it.creditos_otorgados || 0) >
        Number(best?.creditos_otorgados || 0)
          ? it
          : best,
      null
    );

    return {
      totalUsuarios,
      totalActividades,
      totalCreditos,
      promedioCreditos,
      topUsuario: top,
    };
  }, [datos]);

  // DATA GRÃFICOS
  const dataBarActividades = datos.map((d) => ({
    nombre: d.nombre,
    actividades: Number(d.total_actividades) || 0,
  }));

  const dataPieTop5 = (() => {
    const top5 = [...datos]
      .sort(
        (a, b) =>
          Number(b.creditos_otorgados || 0) -
          Number(a.creditos_otorgados || 0)
      )
      .slice(0, 5);

    return top5.map((u) => ({
      name: u.nombre,
      value: Number(u.creditos_otorgados) || 0,
    }));
  })();

  const COLORS = ["#047857", "#0d9488", "#1e3a8a", "#6d28d9", "#0f766e"];

  return (
    <div
      className="min-h-screen p-6 md:p-8"
      style={{
        background: "radial-gradient(circle at top, #bbf7d0 0, #ecfdf5 40%, #f9fafb 100%)",
      }}
    >
      <div className="max-w-6xl mx-auto space-y-8">
        {/* HEADER */}
        <header className="flex flex-col md:flex-row justify-between items-start md:items-center gap-6">
          <div className="flex items-center gap-4">
            <div className="w-16 h-16 rounded-2xl bg-white shadow-md flex items-center justify-center border border-emerald-600/30">
              <img src={hoja} className="w-10 h-10" alt="CrÃ©ditos verdes" />
            </div>

            <div>
              <h1 className="text-3xl md:text-4xl font-extrabold text-emerald-900 tracking-tight">
                Reporte de actividades sostenibles
              </h1>
              <p className="text-sm text-emerald-800/80 mt-1">
                AnÃ¡lisis por usuario de actividades registradas y crÃ©ditos otorgados.
              </p>
            </div>
          </div>

          {/* FILTRO DE FECHAS */}
          <form
            onSubmit={handleSubmit}
            className="flex flex-wrap gap-3 bg-white/80 px-4 py-3 rounded-2xl shadow border border-emerald-100 backdrop-blur"
          >
            <div className="flex flex-col text-xs md:text-sm">
              <label className="font-semibold text-emerald-900 mb-0.5">
                Desde
              </label>
              <input
                type="date"
                value={desde}
                onChange={(e) => setDesde(e.target.value)}
                className="border border-emerald-200 rounded-lg px-2 py-1 shadow-sm focus:outline-none focus:ring focus:ring-emerald-400/60"
              />
            </div>

            <div className="flex flex-col text-xs md:text-sm">
              <label className="font-semibold text-emerald-900 mb-0.5">
                Hasta
              </label>
              <input
                type="date"
                value={hasta}
                onChange={(e) => setHasta(e.target.value)}
                className="border border-emerald-200 rounded-lg px-2 py-1 shadow-sm focus:outline-none focus:ring focus:ring-emerald-400/60"
              />
            </div>

            <button
              type="submit"
              disabled={loading}
              className="self-end md:self-center bg-emerald-700 hover:bg-emerald-800 disabled:opacity-60 disabled:cursor-not-allowed text-white px-4 py-2 rounded-xl font-semibold text-sm shadow-md flex items-center gap-2"
            >
              {loading ? "Actualizandoâ€¦" : "Actualizar"}
            </button>
          </form>
        </header>

        {error && (
          <div className="bg-red-50 text-red-700 border border-red-200 px-4 py-2 rounded-xl shadow-sm text-sm">
            {error}
          </div>
        )}

        {/* MÃ‰TRICAS */}
        <section className="grid sm:grid-cols-2 lg:grid-cols-5 gap-4">
          {[
            {
              label: "Usuarios con actividades",
              value: metrics.totalUsuarios,
            },
            {
              label: "Total de actividades",
              value: metrics.totalActividades,
            },
            {
              label: "CrÃ©ditos otorgados",
              value: metrics.totalCreditos,
            },
            {
              label: "Promedio por usuario",
              value: metrics.promedioCreditos.toFixed(1),
            },
          ].map((m, i) => (
            <div
              key={i}
              className="bg-white shadow-sm border border-emerald-100 rounded-2xl p-4 flex flex-col justify-between hover:shadow-md transition"
            >
              <p className="text-[11px] font-semibold text-emerald-900/80 uppercase tracking-wide">
                {m.label}
              </p>
              <p className="mt-2 text-2xl font-extrabold text-emerald-900">
                {m.value}
              </p>
            </div>
          ))}

          {/* TOP USUARIO */}
          <div className="bg-emerald-900 text-emerald-50 rounded-2xl p-4 shadow-sm flex flex-col justify-between">
            <p className="text-[11px] font-semibold uppercase tracking-wide text-emerald-100/90">
              Usuario destacado
            </p>
            {metrics.topUsuario ? (
              <>
                <p className="mt-1 text-sm font-semibold">
                  {metrics.topUsuario.nombre}
                </p>
                <p className="text-xs text-emerald-100/80">
                  {metrics.topUsuario.correo}
                </p>
                <p className="mt-2 text-xs">
                  CrÃ©ditos otorgados:{" "}
                  <span className="font-bold">
                    {Number(
                      metrics.topUsuario.creditos_otorgados || 0
                    ).toLocaleString("es-BO")}
                  </span>
                </p>
              </>
            ) : (
              <p className="mt-2 text-xs text-emerald-100/80">
                No hay datos en el rango seleccionado.
              </p>
            )}
          </div>
        </section>

        {/* GRÃFICOS */}
        <section className="grid lg:grid-cols-2 gap-6">
          {/* BARRAS */}
          <div className="bg-white rounded-2xl border border-emerald-100 shadow-sm p-4 flex flex-col">
            <div className="flex items-center justify-between mb-2">
              <h2 className="text-base font-bold text-emerald-900">
                Actividades registradas por usuario
              </h2>
              <span className="text-[11px] text-emerald-700/70">
                Top {Math.min(dataBarActividades.length, 10)} usuarios
              </span>
            </div>

            <div className="h-72">
              {sinDatos ? (
                <div className="h-full flex items-center justify-center text-sm text-gray-400">
                  No hay actividades registradas en el rango seleccionado.
                </div>
              ) : (
                <ResponsiveContainer>
                  <BarChart data={dataBarActividades.slice(0, 10)}>
                    <XAxis dataKey="nombre" hide />
                    <YAxis allowDecimals={false} />
                    <Tooltip />
                    <Bar
                      dataKey="actividades"
                      fill="#047857"
                      radius={[8, 8, 0, 0]}
                    />
                  </BarChart>
                </ResponsiveContainer>
              )}
            </div>
          </div>

          {/* PIE */}
          <div className="bg-white rounded-2xl border border-emerald-100 shadow-sm p-4 flex flex-col">
            <div className="flex items-center justify-between mb-2">
              <h2 className="text-base font-bold text-emerald-900">
                Top 5 usuarios por crÃ©ditos otorgados
              </h2>
              <span className="text-[11px] text-emerald-700/70">
                DistribuciÃ³n porcentual
              </span>
            </div>

            <div className="h-72">
              {sinDatos ? (
                <div className="h-full flex items-center justify-center text-sm text-gray-400">
                  No hay crÃ©ditos otorgados en el rango seleccionado.
                </div>
              ) : (
                <ResponsiveContainer>
                  <PieChart>
                    <Pie
                      data={dataPieTop5}
                      cx="50%"
                      cy="50%"
                      outerRadius={90}
                      label
                      dataKey="value"
                    >
                      {dataPieTop5.map((entry, index) => (
                        <Cell
                          key={`slice-${index}`}
                          fill={COLORS[index % COLORS.length]}
                        />
                      ))}
                    </Pie>
                    <Tooltip />
                    <Legend />
                  </PieChart>
                </ResponsiveContainer>
              )}
            </div>
          </div>
        </section>

        {/* TABLA */}
        <section className="bg-white border border-emerald-100 rounded-2xl shadow-sm overflow-hidden">
          <div className="px-4 py-3 border-b bg-emerald-50 flex items-center justify-between">
            <h2 className="font-semibold text-emerald-900 text-sm">
              Detalle de actividades por usuario
            </h2>
            <span className="text-[11px] text-emerald-800/70">
              {datos.length} registro(s)
            </span>
          </div>

          {sinDatos ? (
            <div className="px-4 py-6 text-sm text-gray-500">
              No hay registros de actividades sostenibles para el rango
              seleccionado.
            </div>
          ) : (
            <div className="overflow-x-auto">
              <table className="min-w-full text-sm">
                <thead className="bg-slate-50 border-b border-slate-200">
                  <tr>
                    <th className="px-3 py-2 text-left font-semibold text-slate-700">
                      Usuario
                    </th>
                    <th className="px-3 py-2 text-left font-semibold text-slate-700">
                      Correo
                    </th>
                    <th className="px-3 py-2 text-right font-semibold text-slate-700">
                      Actividades
                    </th>
                    <th className="px-3 py-2 text-right font-semibold text-slate-700">
                      CrÃ©ditos otorgados
                    </th>
                  </tr>
                </thead>
                <tbody>
                  {datos.map((a, i) => (
                    <tr
                      key={i}
                      className={i % 2 === 0 ? "bg-white" : "bg-slate-50/60"}
                    >
                      <td className="px-3 py-2 text-slate-800">
                        {a.nombre}
                      </td>
                      <td className="px-3 py-2 text-slate-600">
                        {a.correo}
                      </td>
                      <td className="px-3 py-2 text-right text-slate-800">
                        {a.total_actividades}
                      </td>
                      <td className="px-3 py-2 text-right text-emerald-700 font-semibold">
                        {a.creditos_otorgados}
                      </td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          )}
        </section>
      </div>
    </div>
  );
}
</file>

<file path="frontend/src/pages/ReportesCreditosGeneradosConsumidos.jsx">
// src/pages/ReportesCreditosGenerados.jsx
import React, { useEffect, useMemo, useState } from "react";
import {
  BarChart,
  Bar,
  XAxis,
  YAxis,
  Tooltip,
  ResponsiveContainer,
  PieChart,
  Pie,
  Cell,
  Legend,
} from "recharts";
import { getReporteCreditosGeneradosVsConsumidos } from "../services/api";
import hoja from "../assets/hoja.png";

function hoyISO() {
  return new Date().toISOString().slice(0, 10);
}

function hace30DiasISO() {
  const d = new Date(Date.now() - 30 * 24 * 60 * 60 * 1000);
  return d.toISOString().slice(0, 10);
}

export default function ReportesCreditosGenerados() {
  const [desde, setDesde] = useState(hace30DiasISO());
  const [hasta, setHasta] = useState(hoyISO());
  const [resumen, setResumen] = useState(null);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState("");

  async function cargar() {
    try {
      setLoading(true);
      setError("");
      const res = await getReporteCreditosGeneradosVsConsumidos({
        desde,
        hasta,
      });
      setResumen(res || null);
    } catch (e) {
      console.error(e);
      setError("Error cargando resumen de crÃ©ditos");
      setResumen(null);
    } finally {
      setLoading(false);
    }
  }

  useEffect(() => {
    cargar();
  }, []);

  function handleSubmit(e) {
    e.preventDefault();
    cargar();
  }

  // =======================
  // MÃ‰TRICAS DERIVADAS
  // =======================
  const metrics = useMemo(() => {
    if (!resumen) {
      return {
        generados: 0,
        consumidos: 0,
        saldo: 0,
        tasaConsumo: 0,
        estado: "Sin datos",
      };
    }

    const generados = Number(resumen.creditos_generados || 0);
    const consumidos = Number(resumen.creditos_consumidos || 0);
    const saldo = Number(resumen.saldo_neto || generados - consumidos);
    const tasaConsumo =
      generados > 0 ? (consumidos / generados) * 100 : 0;

    let estado = "Equilibrado";
    if (saldo > 0 && tasaConsumo < 70) estado = "Sostenible";
    else if (saldo < 0 || tasaConsumo > 90) estado = "En riesgo";

    return { generados, consumidos, saldo, tasaConsumo, estado };
  }, [resumen]);

  // =======================
  // DATOS PARA GRÃFICOS
  // =======================
  const barData = useMemo(() => {
    if (!resumen) return [];
    return [
      { name: "Generados", valor: metrics.generados },
      { name: "Consumidos", valor: metrics.consumidos },
    ];
  }, [resumen, metrics.generados, metrics.consumidos]);

  const pieData = useMemo(() => {
    if (!resumen) return [];
    const total = metrics.generados + metrics.consumidos;
    if (total === 0) return [];
    return [
      { name: "Generados", value: metrics.generados },
      { name: "Consumidos", value: metrics.consumidos },
    ];
  }, [resumen, metrics.generados, metrics.consumidos]);

  const COLORS = ["#047857", "#1e3a8a"];

  return (
    <div
      className="min-h-screen p-8"
      style={{
        background: "linear-gradient(to bottom right, #f0fdf4, #d1fae5)",
        backgroundImage: `url(${hoja})`,
        backgroundRepeat: "no-repeat",
        backgroundPosition: "top right",
        backgroundSize: "160px",
      }}
    >
      <div className="max-w-6xl mx-auto space-y-8">
        {/* HEADER */}
        <header className="flex flex-col md:flex-row justify-between items-start md:items-end gap-6">
          <div className="flex items-center gap-4">
            <div className="w-16 h-16 rounded-full bg-white shadow-md flex items-center justify-center border border-emerald-700/20">
              <img src={hoja} alt="CrÃ©ditos verdes" className="w-10 h-10" />
            </div>
            <div>
              <h1 className="text-3xl font-extrabold text-emerald-800 drop-shadow">
                CrÃ©ditos generados vs consumidos
              </h1>
              <p className="text-sm text-emerald-700/80">
                Resumen global de crÃ©ditos emitidos, gastados y saldo neto en el
                periodo seleccionado.
              </p>
            </div>
          </div>

          <form
            onSubmit={handleSubmit}
            className="flex flex-wrap gap-4 bg-white/70 px-4 py-3 rounded-xl shadow backdrop-blur"
          >
            <div className="flex flex-col text-sm">
              <label className="font-semibold text-emerald-900">Desde</label>
              <input
                type="date"
                value={desde}
                onChange={(e) => setDesde(e.target.value)}
                className="border rounded px-2 py-1 text-sm shadow-sm"
              />
            </div>
            <div className="flex flex-col text-sm">
              <label className="font-semibold text-emerald-900">Hasta</label>
              <input
                type="date"
                value={hasta}
                onChange={(e) => setHasta(e.target.value)}
                className="border rounded px-2 py-1 text-sm shadow-sm"
              />
            </div>
            <button
              type="submit"
              className="bg-emerald-700 hover:bg-emerald-800 text-white px-4 py-2 rounded-lg font-semibold shadow-md"
            >
              {loading ? "Cargandoâ€¦" : "Actualizar"}
            </button>
          </form>
        </header>

        {error && (
          <div className="bg-red-100 text-red-700 border border-red-300 px-4 py-2 rounded-lg shadow-sm">
            {error}
          </div>
        )}

        {/* MÃ‰TRICAS PRINCIPALES */}
        <section className="grid md:grid-cols-4 gap-6">
          <div className="bg-white shadow-md border border-emerald-200/40 rounded-xl p-4 hover:shadow-lg transition">
            <p className="text-xs font-semibold text-emerald-800 uppercase tracking-wide">
              CrÃ©ditos generados
            </p>
            <p className="mt-2 text-3xl font-extrabold text-emerald-900 drop-shadow">
              {metrics.generados}
            </p>
          </div>

          <div className="bg-white shadow-md border border-emerald-200/40 rounded-xl p-4 hover:shadow-lg transition">
            <p className="text-xs font-semibold text-emerald-800 uppercase tracking-wide">
              CrÃ©ditos consumidos
            </p>
            <p className="mt-2 text-3xl font-extrabold text-emerald-900 drop-shadow">
              {metrics.consumidos}
            </p>
          </div>

          <div className="bg-white shadow-md border border-emerald-200/40 rounded-xl p-4 hover:shadow-lg transition">
            <p className="text-xs font-semibold text-emerald-800 uppercase tracking-wide">
              Saldo neto
            </p>
            <p className="mt-2 text-3xl font-extrabold text-emerald-900 drop-shadow">
              {metrics.saldo}
            </p>
          </div>

          <div className="bg-white shadow-md border border-emerald-200/40 rounded-xl p-4 hover:shadow-lg transition">
            <p className="text-xs font-semibold text-emerald-800 uppercase tracking-wide">
              Tasa de consumo
            </p>
            <p className="mt-2 text-3xl font-extrabold text-emerald-900 drop-shadow">
              {metrics.tasaConsumo.toFixed(1)}%
            </p>
            <p className="mt-1 text-xs text-emerald-700/80">
              Estado:{" "}
              <span className="font-semibold">
                {metrics.estado}
              </span>
            </p>
          </div>
        </section>

        {/* DASHBOARDS */}
        <section className="grid lg:grid-cols-2 gap-6">
          {/* BARRAS */}
          <div className="bg-white rounded-xl border border-emerald-200/40 shadow p-4">
            <h2 className="text-lg font-bold text-emerald-800 mb-2">
              ComparaciÃ³n de crÃ©ditos
            </h2>
            <p className="text-xs text-emerald-700/80 mb-3">
              ComparaciÃ³n directa entre crÃ©ditos generados y consumidos.
            </p>
            <div className="h-72">
              {barData.length > 0 ? (
                <ResponsiveContainer>
                  <BarChart data={barData}>
                    <XAxis dataKey="name" />
                    <YAxis allowDecimals={false} />
                    <Tooltip />
                    <Bar dataKey="valor" radius={[8, 8, 0, 0]}>
                      {barData.map((entry, index) => (
                        <Cell
                          key={`cell-${index}`}
                          fill={index === 0 ? COLORS[0] : COLORS[1]}
                        />
                      ))}
                    </Bar>
                  </BarChart>
                </ResponsiveContainer>
              ) : (
                <div className="h-full flex items-center justify-center text-xs text-gray-400">
                  Sin datos para mostrar el grÃ¡fico.
                </div>
              )}
            </div>
          </div>

          {/* PIE */}
          <div className="bg-white rounded-xl border border-emerald-200/40 shadow p-4">
            <h2 className="text-lg font-bold text-emerald-800 mb-2">
              DistribuciÃ³n generados vs consumidos
            </h2>
            <p className="text-xs text-emerald-700/80 mb-3">
              ProporciÃ³n de crÃ©ditos generados frente a los consumidos.
            </p>
            <div className="h-72">
              {pieData.length > 0 ? (
                <ResponsiveContainer>
                  <PieChart>
                    <Pie
                      data={pieData}
                      cx="50%"
                      cy="50%"
                      outerRadius={90}
                      label
                      dataKey="value"
                    >
                      {pieData.map((entry, index) => (
                        <Cell
                          key={`slice-${index}`}
                          fill={COLORS[index % COLORS.length]}
                        />
                      ))}
                    </Pie>
                    <Tooltip />
                    <Legend />
                  </PieChart>
                </ResponsiveContainer>
              ) : (
                <div className="h-full flex items-center justify-center text-xs text-gray-400">
                  Sin datos para mostrar el grÃ¡fico.
                </div>
              )}
            </div>
          </div>
        </section>

        {/* RESUMEN DETALLADO */}
        <section className="bg-white border border-emerald-200/40 rounded-xl shadow-md">
          <div className="px-4 py-3 border-b bg-emerald-50 rounded-t-xl">
            <h2 className="font-semibold text-emerald-900">
              Resumen detallado del periodo
            </h2>
          </div>
          <div className="px-4 py-4 text-sm">
            {resumen ? (
              <ul className="space-y-1 text-emerald-900">
                <li>
                  <span className="font-semibold">CrÃ©ditos generados:</span>{" "}
                  {metrics.generados}
                </li>
                <li>
                  <span className="font-semibold">CrÃ©ditos consumidos:</span>{" "}
                  {metrics.consumidos}
                </li>
                <li>
                  <span className="font-semibold">Saldo neto:</span>{" "}
                  {metrics.saldo}
                </li>
                <li>
                  <span className="font-semibold">Tasa de consumo:</span>{" "}
                  {metrics.tasaConsumo.toFixed(1)}%
                </li>
                <li>
                  <span className="font-semibold">Estado global:</span>{" "}
                  {metrics.estado}
                </li>
              </ul>
            ) : (
              <p className="text-gray-500">
                Sin datos de crÃ©ditos generados/consumidos para el rango
                seleccionado.
              </p>
            )}
          </div>
        </section>
      </div>
    </div>
  );
}
</file>

<file path="frontend/src/pages/ReportesImpactoAcumulado.jsx">
// frontend/src/pages/ReportesImpactoAcumulado.jsx
import { useMemo, useState } from "react";
import {
  BarChart,
  Bar,
  XAxis,
  YAxis,
  Tooltip,
  ResponsiveContainer,
  PieChart,
  Pie,
  Cell,
  Legend,
} from "recharts";
import { getReporteImpactoAcumulado } from "../services/api";
import hoja from "../assets/hoja.png";

const TIPOS_REPORTE = [
  { id: 1, label: "Mensual" },
  { id: 2, label: "Trimestral" },
  { id: 3, label: "Anual" },
];

function isArray(v) {
  return Array.isArray(v);
}

export default function ReportesImpactoAcumulado() {
  const [tipoReporte, setTipoReporte] = useState(1);
  const [idPeriodo, setIdPeriodo] = useState(1);
  const [datos, setDatos] = useState([]);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState(null);

  async function cargar() {
    try {
      setLoading(true);
      setError(null);

      const res = await getReporteImpactoAcumulado({
        idTipoReporte: tipoReporte,
        idPeriodo,
      });

      setDatos(isArray(res) ? res : []);
    } catch (e) {
      console.error(e);
      setError("Error cargando impacto acumulado");
      setDatos([]);
    } finally {
      setLoading(false);
    }
  }

  // =========================
  // MÃ‰TRICAS IMPACTO ACUMULADO
  // =========================
  const metrics = useMemo(() => {
    if (!datos.length) {
      return {
        co2: 0,
        agua: 0,
        energia: 0,
        transacciones: 0,
        usuariosActivos: 0,
      };
    }

    return datos.reduce(
      (acc, r) => ({
        co2: acc.co2 + Number(r.total_co2_ahorrado || 0),
        agua: acc.agua + Number(r.total_agua_ahorrada || 0),
        energia: acc.energia + Number(r.total_energia_ahorrada || 0),
        transacciones:
          acc.transacciones + Number(r.total_transacciones || 0),
        usuariosActivos:
          acc.usuariosActivos + Number(r.total_usuarios_activos || 0),
      }),
      { co2: 0, agua: 0, energia: 0, transacciones: 0, usuariosActivos: 0 }
    );
  }, [datos]); // ðŸ‘ˆ IMPORTANTE: depender de datos

  // =========================
  // DATOS PARA GRÃFICOS
  // =========================
  const barData = useMemo(
    () => [
      {
        indicador: "COâ‚‚ (kg)",
        valor: Number(metrics.co2.toFixed(2)),
      },
      {
        indicador: "Agua (L)",
        valor: Number(metrics.agua.toFixed(2)),
      },
      {
        indicador: "EnergÃ­a (kWh)",
        valor: Number(metrics.energia.toFixed(2)),
      },
    ],
    [metrics]
  );

  const pieData = useMemo(
    () =>
      [
        { name: "Agua", value: metrics.agua },
        { name: "COâ‚‚", value: metrics.co2 },
        { name: "EnergÃ­a", value: metrics.energia },
      ].filter((d) => d.value > 0),
    [metrics]
  );

  const COLORS = ["#1e3a8a", "#047857", "#0d9488"];

  const formatNumber = (n) =>
    Number(n || 0).toLocaleString("es-BO", {
      maximumFractionDigits: 2,
    });

  return (
    <div
      className="min-h-screen p-8"
      style={{
        background: "linear-gradient(to bottom right, #f0fdf4, #d1fae5)",
        backgroundImage: `url(${hoja})`,
        backgroundRepeat: "no-repeat",
        backgroundPosition: "top right",
        backgroundSize: "160px",
      }}
    >
      <div className="max-w-6xl mx-auto space-y-6">
        {/* Header */}
        <div className="flex items-center gap-4">
          <div className="w-14 h-14 rounded-full bg-emerald-600 flex items-center justify-center shadow-lg">
            <span className="text-3xl">ðŸŒ±</span>
          </div>
          <div>
            <h1 className="text-3xl font-bold text-emerald-900">
              Impacto ambiental acumulado
            </h1>
            <p className="text-sm text-emerald-800">
              Datos provenientes de la tabla REPORTE_IMPACTO segÃºn perÃ­odo.
            </p>
          </div>
        </div>

        {/* Filtros */}
        <div className="flex flex-wrap items-end gap-4 bg-white/80 p-4 rounded-2xl shadow">
          <div className="flex flex-col">
            <label className="text-xs font-semibold text-emerald-900 mb-1">
              Tipo de reporte
            </label>
            <select
              className="border rounded-xl px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-emerald-500"
              value={tipoReporte}
              onChange={(e) => setTipoReporte(Number(e.target.value))}
            >
              {TIPOS_REPORTE.map((t) => (
                <option key={t.id} value={t.id}>
                  {t.label}
                </option>
              ))}
            </select>
          </div>

          <div className="flex flex-col">
            <label className="text-xs font-semibold text-emerald-900 mb-1">
              ID perÃ­odo
            </label>
            <input
              type="number"
              min={1}
              className="border rounded-xl px-3 py-2 text-sm w-28 focus:outline-none focus:ring-2 focus:ring-emerald-500"
              value={idPeriodo}
              onChange={(e) => setIdPeriodo(Number(e.target.value))}
            />
          </div>

          <button
            onClick={cargar}
            disabled={loading}
            className="ml-auto bg-emerald-600 hover:bg-emerald-700 text-white font-semibold px-5 py-2 rounded-2xl shadow-lg transition disabled:opacity-60"
          >
            {loading ? "Cargando..." : "Actualizar"}
          </button>
        </div>

        {error && (
          <div className="bg-red-100 text-red-800 px-4 py-2 rounded-xl text-sm">
            {error}
          </div>
        )}

        {/* Cards de mÃ©tricas */}
        <div className="grid grid-cols-1 sm:grid-cols-3 lg:grid-cols-5 gap-4">
          <div className="bg-white/90 rounded-2xl p-4 shadow">
            <p className="text-xs font-semibold text-emerald-900">
              COâ‚‚ AHORRADO
            </p>
            <p className="mt-2 text-2xl font-bold text-emerald-700">
              {formatNumber(metrics.co2)}
            </p>
            <p className="text-xs text-emerald-800 mt-1">kg</p>
          </div>

          <div className="bg-white/90 rounded-2xl p-4 shadow">
            <p className="text-xs font-semibold text-emerald-900">
              AGUA AHORRADA
            </p>
            <p className="mt-2 text-2xl font-bold text-emerald-700">
              {formatNumber(metrics.agua)}
            </p>
            <p className="text-xs text-emerald-800 mt-1">L</p>
          </div>

          <div className="bg-white/90 rounded-2xl p-4 shadow">
            <p className="text-xs font-semibold text-emerald-900">
              ENERGÃA AHORRADA
            </p>
            <p className="mt-2 text-2xl font-bold text-emerald-700">
              {formatNumber(metrics.energia)}
            </p>
            <p className="text-xs text-emerald-800 mt-1">kWh</p>
          </div>

          <div className="bg-white/90 rounded-2xl p-4 shadow">
            <p className="text-xs font-semibold text-emerald-900">
              TRANSACCIONES
            </p>
            <p className="mt-2 text-2xl font-bold text-emerald-700">
              {formatNumber(metrics.transacciones)}
            </p>
          </div>

          <div className="bg-white/90 rounded-2xl p-4 shadow">
            <p className="text-xs font-semibold text-emerald-900">
              USUARIOS ACTIVOS
            </p>
            <p className="mt-2 text-2xl font-bold text-emerald-700">
              {formatNumber(metrics.usuariosActivos)}
            </p>
          </div>
        </div>

        {/* GrÃ¡ficos */}
        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
          {/* Bar */}
          <div className="bg-white/90 rounded-2xl p-4 shadow h-80 flex flex-col">
            <h2 className="text-lg font-semibold text-emerald-900">
              Impacto ambiental (acumulado)
            </h2>
            <p className="text-xs text-emerald-800 mb-2">
              ComparaciÃ³n total entre COâ‚‚, Agua y EnergÃ­a ahorrados.
            </p>
            <div className="flex-1">
              <ResponsiveContainer width="100%" height="100%">
                <BarChart data={barData}>
                  <XAxis dataKey="indicador" />
                  <YAxis />
                  <Tooltip />
                  <Bar dataKey="valor" />
                </BarChart>
              </ResponsiveContainer>
            </div>
          </div>

          {/* Pie */}
          <div className="bg-white/90 rounded-2xl p-4 shadow h-80 flex flex-col">
            <h2 className="text-lg font-semibold text-emerald-900">
              DistribuciÃ³n del impacto
            </h2>
            <p className="text-xs text-emerald-800 mb-2">
              ProporciÃ³n de los distintos tipos de impacto ambiental.
            </p>
            <div className="flex-1 flex items-center justify-center">
              {pieData.length ? (
                <ResponsiveContainer width="100%" height="100%">
                  <PieChart>
                    <Pie
                      data={pieData}
                      dataKey="value"
                      nameKey="name"
                      outerRadius={90}
                      label
                    >
                      {pieData.map((entry, index) => (
                        <Cell
                          key={`cell-${index}`}
                          fill={COLORS[index % COLORS.length]}
                        />
                      ))}
                    </Pie>
                    <Legend />
                    <Tooltip />
                  </PieChart>
                </ResponsiveContainer>
              ) : (
                <p className="text-xs text-emerald-700">
                  Sin datos para el perÃ­odo seleccionado.
                </p>
              )}
            </div>
          </div>
        </div>

        {/* Detalle por usuario/perÃ­odo */}
        <div className="bg-emerald-50/80 rounded-2xl p-4 shadow">
          <h2 className="text-lg font-semibold text-emerald-900 mb-2">
            Detalle de impacto por usuario/perÃ­odo
          </h2>

          <div className="overflow-x-auto">
            <table className="min-w-full text-sm">
              <thead className="bg-emerald-100">
                <tr>
                  <th className="px-3 py-2 text-left text-xs font-semibold text-emerald-900">
                    Usuario (ID)
                  </th>
                  <th className="px-3 py-2 text-left text-xs font-semibold text-emerald-900">
                    COâ‚‚ (kg)
                  </th>
                  <th className="px-3 py-2 text-left text-xs font-semibold text-emerald-900">
                    Agua (L)
                  </th>
                  <th className="px-3 py-2 text-left text-xs font-semibold text-emerald-900">
                    EnergÃ­a (kWh)
                  </th>
                  <th className="px-3 py-2 text-left text-xs font-semibold text-emerald-900">
                    Transacciones
                  </th>
                  <th className="px-3 py-2 text-left text-xs font-semibold text-emerald-900">
                    Usuarios activos
                  </th>
                </tr>
              </thead>
              <tbody>
                {datos.map((r) => (
                  <tr key={r.id_usuario ?? Math.random()}>
                    <td className="px-3 py-2 border-b border-emerald-100">
                      {r.id_usuario ?? "â€”"}
                    </td>
                    <td className="px-3 py-2 border-b border-emerald-100">
                      {formatNumber(r.total_co2_ahorrado)}
                    </td>
                    <td className="px-3 py-2 border-b border-emerald-100">
                      {formatNumber(r.total_agua_ahorrada)}
                    </td>
                    <td className="px-3 py-2 border-b border-emerald-100">
                      {formatNumber(r.total_energia_ahorrada)}
                    </td>
                    <td className="px-3 py-2 border-b border-emerald-100">
                      {formatNumber(r.total_transacciones)}
                    </td>
                    <td className="px-3 py-2 border-b border-emerald-100">
                      {formatNumber(r.total_usuarios_activos)}
                    </td>
                  </tr>
                ))}

                {!datos.length && (
                  <tr>
                    <td
                      colSpan={6}
                      className="px-3 py-4 text-center text-xs text-emerald-700"
                    >
                      No hay datos para el perÃ­odo seleccionado.
                    </td>
                  </tr>
                )}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  );
}
</file>

<file path="frontend/src/pages/ReportesImpactoCategoria.jsx">
// src/pages/ReportesImpactoCategoria.jsx
import React, { useEffect, useMemo, useState } from "react";
import { getReporteImpactoPorCategoria } from "../services/api";
import {
  BarChart,
  Bar,
  XAxis,
  YAxis,
  Tooltip,
  ResponsiveContainer,
  PieChart,
  Pie,
  Legend,
  Cell,
} from "recharts";
import hoja from "../assets/hoja.png";

export default function ReportesImpactoCategoria() {
  const [idPeriodo, setIdPeriodo] = useState("1");
  const [datos, setDatos] = useState([]);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState("");

  async function cargar() {
    try {
      setLoading(true);
      setError("");
      const res = await getReporteImpactoPorCategoria({ idPeriodo });
      setDatos(Array.isArray(res) ? res : []);
    } catch (e) {
      console.error(e);
      setError("Error cargando impacto por categorÃ­a");
      setDatos([]);
    } finally {
      setLoading(false);
    }
  }

  // Carga inicial
  useEffect(() => {
    cargar();
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, []);

  // =========================
  // MÃ‰TRICAS GLOBALES
  // =========================
  const metrics = useMemo(() => {
    if (!datos.length) {
      return {
        totalCo2: 0,
        totalAgua: 0,
        totalEnergia: 0,
        categorias: 0,
        topCategoria: null,
      };
    }

    const totalCo2 = datos.reduce(
      (acc, c) => acc + Number(c.co2_total || 0),
      0
    );
    const totalAgua = datos.reduce(
      (acc, c) => acc + Number(c.agua_total || 0),
      0
    );
    const totalEnergia = datos.reduce(
      (acc, c) => acc + Number(c.energia_total || 0),
      0
    );
    const categorias = datos.length;

    const topCategoria = datos.reduce(
      (best, c) =>
        Number(c.co2_total || 0) +
          Number(c.agua_total || 0) +
          Number(c.energia_total || 0) >
        (Number(best?.co2_total || 0) +
          Number(best?.agua_total || 0) +
          Number(best?.energia_total || 0))
          ? c
          : best,
      null
    );

    return { totalCo2, totalAgua, totalEnergia, categorias, topCategoria };
  }, [datos]);

  // =========================
  // DATOS PARA GRÃFICOS
  // =========================
  const barData = useMemo(
    () =>
      datos.map((c) => ({
        categoria: c.categoria,
        co2: Number(c.co2_total || 0),
        agua: Number(c.agua_total || 0),
        energia: Number(c.energia_total || 0),
      })),
    [datos]
  );

  const pieData = useMemo(() => {
    if (!datos.length) return [];
    return datos.map((c) => ({
      name: c.categoria,
      value:
        Number(c.co2_total || 0) +
        Number(c.agua_total || 0) +
        Number(c.energia_total || 0),
    }));
  }, [datos]);

  const COLORS = ["#047857", "#1e3a8a", "#0d9488", "#6d28d9", "#f59e0b"];

  const hasData = datos.length > 0;

  return (
    <div
      className="min-h-screen p-6 md:p-8"
      style={{
        background: "radial-gradient(circle at top left, #bbf7d0, #ecfdf5)",
        backgroundImage: `url(${hoja})`,
        backgroundRepeat: "no-repeat",
        backgroundPosition: "top right",
        backgroundSize: "180px",
      }}
    >
      <div className="max-w-6xl mx-auto space-y-8">
        {/* HEADER */}
        <header className="flex flex-col gap-6 md:flex-row md:items-center md:justify-between">
          <div className="flex items-start gap-4">
            <div className="w-16 h-16 rounded-2xl bg-white shadow-md flex items-center justify-center border border-emerald-700/20">
              <img src={hoja} alt="Hoja" className="w-9 h-9 opacity-90" />
            </div>
            <div className="space-y-1">
              <h1 className="text-3xl md:text-4xl font-extrabold text-emerald-900 drop-shadow-sm">
                Impacto ambiental por categorÃ­a
              </h1>
              <p className="text-sm md:text-base text-emerald-800/80 max-w-xl">
                AnÃ¡lisis del COâ‚‚, agua y energÃ­a ahorrados agrupados por
                categorÃ­a, a partir de la tabla{" "}
                <span className="font-mono text-xs bg-emerald-100/80 px-1.5 py-0.5 rounded">
                  IMPACTO_AMBIENTAL
                </span>
                .
              </p>
              <div className="inline-flex items-center gap-2 mt-1 text-xs text-emerald-900/80">
                <span className="inline-flex items-center gap-1 bg-white/70 px-2.5 py-1 rounded-full shadow-sm border border-emerald-200/60">
                  <span className="w-2 h-2 rounded-full bg-emerald-500" />
                  PerÃ­odo seleccionado:{" "}
                  <span className="font-semibold">#{idPeriodo}</span>
                </span>
                {hasData && metrics.topCategoria && (
                  <span className="inline-flex items-center gap-1 bg-amber-50 px-2 py-1 rounded-full border border-amber-200 text-amber-900">
                    â­ Mayor impacto:{" "}
                    <span className="font-semibold">
                      {metrics.topCategoria.categoria}
                    </span>
                  </span>
                )}
              </div>
            </div>
          </div>

          {/* Filtros */}
          <div className="bg-white/80 backdrop-blur rounded-2xl shadow-lg border border-emerald-100 px-4 py-3 flex flex-col gap-3 min-w-[240px]">
            <p className="text-xs font-semibold text-emerald-900 tracking-wide">
              Filtros
            </p>
            <div className="flex items-end gap-3">
              <div className="flex flex-col flex-1">
                <label className="mb-1 text-xs font-semibold text-emerald-900">
                  ID perÃ­odo
                </label>
                <input
                  type="number"
                  min="1"
                  value={idPeriodo}
                  onChange={(e) => setIdPeriodo(e.target.value)}
                  className="border border-emerald-200 rounded-lg px-2 py-1.5 text-sm shadow-sm focus:outline-none focus:ring-2 focus:ring-emerald-500/70 focus:border-emerald-500"
                />
              </div>
              <button
                type="button"
                onClick={cargar}
                disabled={loading}
                className={`px-4 py-2 rounded-lg text-sm font-semibold shadow-md transition
                ${
                  loading
                    ? "bg-emerald-300 text-emerald-900 cursor-wait"
                    : "bg-emerald-700 hover:bg-emerald-800 text-white"
                }`}
              >
                {loading ? "Cargandoâ€¦" : "Actualizar"}
              </button>
            </div>
            {loading && (
              <p className="text-[11px] text-emerald-700/80 flex items-center gap-1">
                <span className="w-2 h-2 rounded-full bg-emerald-500 animate-pulse" />
                Calculando impacto para el perÃ­odoâ€¦
              </p>
            )}
          </div>
        </header>

        {error && (
          <div className="bg-red-50 border border-red-200 text-red-700 text-sm px-4 py-2 rounded-xl shadow-sm">
            {error}
          </div>
        )}

        {/* KPIs */}
        <section className="grid md:grid-cols-4 gap-4 md:gap-6">
          <div className="bg-white shadow-sm border border-emerald-100 rounded-xl p-4 flex flex-col justify-between">
            <div>
              <p className="text-[11px] font-semibold text-emerald-700 uppercase tracking-wide">
                COâ‚‚ total (kg)
              </p>
              <p className="mt-2 text-3xl font-extrabold text-emerald-900 tabular-nums">
                {metrics.totalCo2.toLocaleString()}
              </p>
            </div>
            <p className="mt-1 text-[11px] text-emerald-700/75">
              Suma de emisiones evitadas por todas las categorÃ­as.
            </p>
          </div>

          <div className="bg-white shadow-sm border border-blue-100 rounded-xl p-4 flex flex-col justify-between">
            <div>
              <p className="text-[11px] font-semibold text-blue-700 uppercase tracking-wide">
                Agua total (L)
              </p>
              <p className="mt-2 text-3xl font-extrabold text-blue-900 tabular-nums">
                {metrics.totalAgua.toLocaleString()}
              </p>
            </div>
            <p className="mt-1 text-[11px] text-blue-800/75">
              Litros de agua ahorrada en el perÃ­odo.
            </p>
          </div>

          <div className="bg-white shadow-sm border border-teal-100 rounded-xl p-4 flex flex-col justify-between">
            <div>
              <p className="text-[11px] font-semibold text-teal-700 uppercase tracking-wide">
                EnergÃ­a total (kWh)
              </p>
              <p className="mt-2 text-3xl font-extrabold text-teal-900 tabular-nums">
                {metrics.totalEnergia.toLocaleString()}
              </p>
            </div>
            <p className="mt-1 text-[11px] text-teal-800/75">
              EnergÃ­a equivalente ahorrada en el perÃ­odo.
            </p>
          </div>

          <div className="bg-white shadow-sm border border-slate-200 rounded-xl p-4 flex flex-col justify-between">
            <div>
              <p className="text-[11px] font-semibold text-slate-700 uppercase tracking-wide">
                CategorÃ­as registradas
              </p>
              <p className="mt-2 text-3xl font-extrabold text-slate-900 tabular-nums">
                {metrics.categorias}
              </p>
              {metrics.topCategoria && (
                <p className="mt-2 text-xs text-emerald-800 flex flex-wrap gap-1">
                  <span className="inline-flex items-center px-1.5 py-0.5 rounded-full bg-emerald-50 border border-emerald-200 text-[11px]">
                    Top impacto:
                    <span className="ml-1 font-semibold">
                      {metrics.topCategoria.categoria}
                    </span>
                  </span>
                </p>
              )}
            </div>
            <p className="mt-1 text-[11px] text-slate-600/80">
              NÃºmero de categorÃ­as con impacto registrado.
            </p>
          </div>
        </section>

        {/* Mensaje de vacÃ­o global */}
        {!loading && !error && !hasData && (
          <div className="bg-emerald-50 border border-emerald-100 text-emerald-800 text-sm px-4 py-3 rounded-xl shadow-sm flex items-center gap-2">
            <span className="w-2 h-2 rounded-full bg-emerald-500" />
            No se encontrÃ³ impacto ambiental para el perÃ­odo seleccionado. Prueba
            con otro <strong className="ml-1">ID de perÃ­odo</strong> o genera
            nuevas transacciones.
          </div>
        )}

        {/* GRÃFICOS */}
        <section className="grid lg:grid-cols-2 gap-6">
          {/* Barras */}
          <div className="bg-white rounded-2xl border border-emerald-100 shadow-sm p-4 md:p-5">
            <div className="flex items-center justify-between mb-3">
              <div>
                <h2 className="text-base md:text-lg font-semibold text-emerald-900">
                  Impacto por categorÃ­a (COâ‚‚, Agua, EnergÃ­a)
                </h2>
                <p className="text-xs text-emerald-700/80">
                  ComparaciÃ³n de indicadores ambientales por cada categorÃ­a.
                </p>
              </div>
            </div>

            <div className="h-72">
              {barData.length > 0 ? (
                <ResponsiveContainer>
                  <BarChart data={barData}>
                    <XAxis
                      dataKey="categoria"
                      tick={{ fontSize: 11 }}
                      interval={0}
                      height={50}
                      tickLine={false}
                      axisLine={{ stroke: "#e5e7eb" }}
                    />
                    <YAxis tick={{ fontSize: 11 }} />
                    <Tooltip />
                    <Legend wrapperStyle={{ fontSize: 11 }} />
                    <Bar dataKey="co2" name="COâ‚‚ (kg)" fill="#047857" />
                    <Bar dataKey="agua" name="Agua (L)" fill="#1e3a8a" />
                    <Bar dataKey="energia" name="EnergÃ­a (kWh)" fill="#0d9488" />
                  </BarChart>
                </ResponsiveContainer>
              ) : (
                <div className="h-full flex items-center justify-center text-xs text-gray-400">
                  Sin datos para mostrar el grÃ¡fico.
                </div>
              )}
            </div>
          </div>

          {/* Pie */}
          <div className="bg-white rounded-2xl border border-emerald-100 shadow-sm p-4 md:p-5">
            <div className="flex items-center justify-between mb-3">
              <div>
                <h2 className="text-base md:text-lg font-semibold text-emerald-900">
                  DistribuciÃ³n de impacto por categorÃ­a
                </h2>
                <p className="text-xs text-emerald-700/80">
                  ProporciÃ³n del impacto total (COâ‚‚ + Agua + EnergÃ­a) por
                  categorÃ­a.
                </p>
              </div>
            </div>

            <div className="h-72">
              {pieData.length > 0 ? (
                <ResponsiveContainer>
                  <PieChart>
                    <Pie
                      data={pieData}
                      cx="50%"
                      cy="50%"
                      outerRadius={90}
                      label
                      dataKey="value"
                    >
                      {pieData.map((entry, index) => (
                        <Cell
                          key={`slice-${index}`}
                          fill={COLORS[index % COLORS.length]}
                        />
                      ))}
                    </Pie>
                    <Tooltip />
                    <Legend wrapperStyle={{ fontSize: 11 }} />
                  </PieChart>
                </ResponsiveContainer>
              ) : (
                <div className="h-full flex items-center justify-center text-xs text-gray-400">
                  Sin datos para mostrar el grÃ¡fico.
                </div>
              )}
            </div>
          </div>
        </section>

        {/* TABLA DETALLADA */}
        <section className="bg-white border border-emerald-100 rounded-2xl shadow-sm overflow-hidden">
          <div className="px-4 py-3 border-b bg-emerald-50 flex items-center justify-between">
            <h2 className="font-semibold text-emerald-900 text-sm md:text-base">
              Detalle de impacto por categorÃ­a
            </h2>
            {hasData && (
              <span className="text-[11px] text-emerald-800 bg-white/80 border border-emerald-200 px-2 py-0.5 rounded-full">
                {datos.length} categorÃ­a(s)
              </span>
            )}
          </div>

          <div className="overflow-x-auto">
            <table className="min-w-full text-sm">
              <thead className="bg-slate-50 border-b border-slate-200/80">
                <tr>
                  <th className="px-3 py-2 text-left text-xs font-semibold text-slate-600">
                    CategorÃ­a
                  </th>
                  <th className="px-3 py-2 text-right text-xs font-semibold text-slate-600">
                    COâ‚‚ total (kg)
                  </th>
                  <th className="px-3 py-2 text-right text-xs font-semibold text-slate-600">
                    Agua total (L)
                  </th>
                  <th className="px-3 py-2 text-right text-xs font-semibold text-slate-600">
                    EnergÃ­a total (kWh)
                  </th>
                </tr>
              </thead>
              <tbody>
                {datos.map((c, i) => (
                  <tr
                    key={i}
                    className={
                      i % 2 === 0 ? "bg-white" : "bg-slate-50/60 border-t"
                    }
                  >
                    <td className="px-3 py-2 text-sm text-slate-800">
                      {c.categoria}
                    </td>
                    <td className="px-3 py-2 text-right tabular-nums">
                      {c.co2_total}
                    </td>
                    <td className="px-3 py-2 text-right tabular-nums">
                      {c.agua_total}
                    </td>
                    <td className="px-3 py-2 text-right tabular-nums">
                      {c.energia_total}
                    </td>
                  </tr>
                ))}
                {datos.length === 0 && (
                  <tr>
                    <td
                      className="px-3 py-4 text-center text-gray-400 text-sm"
                      colSpan={4}
                    >
                      Sin impacto registrado para ese perÃ­odo.
                    </td>
                  </tr>
                )}
              </tbody>
            </table>
          </div>
        </section>
      </div>
    </div>
  );
}
</file>

<file path="frontend/src/pages/ReportesIngresosCreditos.jsx">
// src/pages/ReportesIngresosCreditos.jsx
import React, { useEffect, useMemo, useState } from "react";
import { getReporteIngresosCreditos } from "../services/api";
import {
  BarChart,
  Bar,
  XAxis,
  YAxis,
  Tooltip,
  ResponsiveContainer,
  LineChart,
  Line,
  Legend,
} from "recharts";
import hoja from "../assets/hoja.png";

function hoyISO() {
  return new Date().toISOString().slice(0, 10);
}

function hace30DiasISO() {
  const d = new Date(Date.now() - 30 * 24 * 60 * 60 * 1000);
  return d.toISOString().slice(0, 10);
}

export default function ReportesIngresosCreditos() {
  const [desde, setDesde] = useState(hace30DiasISO());
  const [hasta, setHasta] = useState(hoyISO());
  const [datos, setDatos] = useState([]);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState("");

  async function cargar() {
    try {
      setLoading(true);
      setError("");
      const res = await getReporteIngresosCreditos({ desde, hasta });
      setDatos(Array.isArray(res) ? res : []);
    } catch (e) {
      console.error(e);
      setError("Error cargando ingresos por crÃ©ditos");
      setDatos([]);
    } finally {
      setLoading(false);
    }
  }

  useEffect(() => {
    cargar();
  }, []);

  function handleSubmit(e) {
    e.preventDefault();
    cargar();
  }

  // =========================
  // MÃ‰TRICAS
  // =========================
  const metrics = useMemo(() => {
    if (!datos.length) {
      return {
        totalCreditos: 0,
        totalBs: 0,
        diasConVentas: 0,
        promedioTicket: 0,
      };
    }

    const totalCreditos = datos.reduce(
      (acc, r) => acc + Number(r.total_creditos || 0),
      0
    );
    const totalBs = datos.reduce(
      (acc, r) => acc + Number(r.total_bs || 0),
      0
    );
    const diasConVentas = datos.filter(
      (r) => Number(r.total_bs || 0) > 0
    ).length;
    const promedioTicket =
      diasConVentas > 0 ? totalBs / diasConVentas : 0;

    return { totalCreditos, totalBs, diasConVentas, promedioTicket };
  }, [datos]);

  // =========================
  // DATOS GRÃFICOS
  // =========================
  const chartData = useMemo(
    () =>
      datos.map((r) => ({
        fecha: r.fecha,
        creditos: Number(r.total_creditos || 0),
        monto: Number(r.total_bs || 0),
      })),
    [datos]
  );

  return (
    <div
      className="min-h-screen p-8"
      style={{
        background: "linear-gradient(to bottom right, #f0fdf4, #d1fae5)",
        backgroundImage: `url(${hoja})`,
        backgroundRepeat: "no-repeat",
        backgroundPosition: "top right",
        backgroundSize: "160px",
      }}
    >
      <div className="max-w-6xl mx-auto space-y-8">
        {/* HEADER */}
        <header className="flex flex-col md:flex-row md:items-end md:justify-between gap-6">
          <div className="flex items-center gap-4">
            <div className="w-16 h-16 rounded-full bg-white shadow-md flex items-center justify-center border border-emerald-700/20">
              <img src={hoja} alt="CrÃ©ditos verdes" className="w-10 h-10" />
            </div>
            <div>
              <h1 className="text-3xl font-extrabold text-emerald-800 drop-shadow">
                Ingresos por venta de crÃ©ditos
              </h1>
              <p className="text-sm text-emerald-700/80">
                CrÃ©ditos vendidos y monto recaudado por dÃ­a en el rango
                seleccionado.
              </p>
            </div>
          </div>

          <form
            onSubmit={handleSubmit}
            className="flex flex-wrap gap-4 items-end bg-white/70 px-4 py-3 rounded-xl shadow backdrop-blur text-sm"
          >
            <div className="flex flex-col">
              <label className="mb-1 font-semibold text-emerald-900">
                Desde
              </label>
              <input
                type="date"
                value={desde}
                onChange={(e) => setDesde(e.target.value)}
                className="border rounded px-2 py-1 text-sm shadow-sm"
              />
            </div>
            <div className="flex flex-col">
              <label className="mb-1 font-semibold text-emerald-900">
                Hasta
              </label>
              <input
                type="date"
                value={hasta}
                onChange={(e) => setHasta(e.target.value)}
                className="border rounded px-2 py-1 text-sm shadow-sm"
              />
            </div>
            <button
              type="submit"
              className="bg-emerald-700 hover:bg-emerald-800 text-white px-4 py-2 rounded-lg font-semibold shadow-md"
            >
              {loading ? "Cargandoâ€¦" : "Actualizar"}
            </button>
          </form>
        </header>

        {error && (
          <div className="bg-red-100 border border-red-300 text-red-700 text-sm px-4 py-2 rounded-lg shadow-sm">
            {error}
          </div>
        )}

        {/* KPIs */}
        <section className="grid md:grid-cols-4 gap-6">
          <div className="bg-white shadow-md border border-emerald-200/40 rounded-xl p-4">
            <p className="text-xs font-semibold text-emerald-700 uppercase">
              CrÃ©ditos vendidos
            </p>
            <p className="mt-2 text-3xl font-extrabold text-emerald-900">
              {metrics.totalCreditos.toLocaleString()}
            </p>
          </div>

          <div className="bg-white shadow-md border border-blue-200/60 rounded-xl p-4">
            <p className="text-xs font-semibold text-blue-700 uppercase">
              Monto total (Bs)
            </p>
            <p className="mt-2 text-3xl font-extrabold text-blue-900">
              {metrics.totalBs.toLocaleString(undefined, {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2,
              })}
            </p>
          </div>

          <div className="bg-white shadow-md border border-teal-200/60 rounded-xl p-4">
            <p className="text-xs font-semibold text-teal-700 uppercase">
              DÃ­as con ventas
            </p>
            <p className="mt-2 text-3xl font-extrabold text-teal-900">
              {metrics.diasConVentas}
            </p>
          </div>

          <div className="bg-white shadow-md border border-emerald-200/40 rounded-xl p-4">
            <p className="text-xs font-semibold text-slate-700 uppercase">
              Ticket promedio (Bs/dÃ­a)
            </p>
            <p className="mt-2 text-3xl font-extrabold text-slate-900">
              {metrics.promedioTicket.toLocaleString(undefined, {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2,
              })}
            </p>
          </div>
        </section>

        {/* GRÃFICOS */}
        <section className="grid lg:grid-cols-2 gap-6">
          {/* CrÃ©ditos por dÃ­a (barras) */}
          <div className="bg-white rounded-xl border border-emerald-200/40 shadow p-4">
            <h2 className="text-lg font-semibold text-emerald-900 mb-2">
              CrÃ©ditos vendidos por dÃ­a
            </h2>
            <p className="text-xs text-emerald-700/80 mb-3">
              DistribuciÃ³n de crÃ©ditos vendidos en el periodo.
            </p>
            <div className="h-72">
              {chartData.length > 0 ? (
                <ResponsiveContainer>
                  <BarChart data={chartData}>
                    <XAxis dataKey="fecha" hide />
                    <YAxis allowDecimals={false} />
                    <Tooltip />
                    <Bar
                      dataKey="creditos"
                      name="CrÃ©ditos"
                      radius={[8, 8, 0, 0]}
                      fill="#047857"
                    />
                  </BarChart>
                </ResponsiveContainer>
              ) : (
                <div className="h-full flex items-center justify-center text-xs text-gray-400">
                  Sin datos para mostrar el grÃ¡fico.
                </div>
              )}
            </div>
          </div>

          {/* Monto por dÃ­a (lÃ­nea) */}
          <div className="bg-white rounded-xl border border-emerald-200/40 shadow p-4">
            <h2 className="text-lg font-semibold text-emerald-900 mb-2">
              Monto recaudado por dÃ­a
            </h2>
            <p className="text-xs text-emerald-700/80 mb-3">
              EvoluciÃ³n del ingreso por ventas de crÃ©ditos.
            </p>
            <div className="h-72">
              {chartData.length > 0 ? (
                <ResponsiveContainer>
                  <LineChart data={chartData}>
                    <XAxis dataKey="fecha" hide />
                    <YAxis />
                    <Tooltip />
                    <Legend />
                    <Line
                      type="monotone"
                      dataKey="monto"
                      name="Monto (Bs)"
                      stroke="#1e3a8a"
                      strokeWidth={2}
                      dot={false}
                    />
                  </LineChart>
                </ResponsiveContainer>
              ) : (
                <div className="h-full flex items-center justify-center text-xs text-gray-400">
                  Sin datos para mostrar el grÃ¡fico.
                </div>
              )}
            </div>
          </div>
        </section>

        {/* TABLA DETALLADA */}
        <section className="bg-white border border-emerald-200/40 rounded-xl shadow">
          <div className="px-4 py-3 border-b bg-emerald-50 rounded-t-xl">
            <h2 className="font-semibold text-emerald-900">
              Detalle diario de ingresos
            </h2>
          </div>

          <div className="overflow-x-auto">
            <table className="min-w-full text-sm">
              <thead className="bg-slate-100">
                <tr>
                  <th className="px-3 py-2 text-left">Fecha</th>
                  <th className="px-3 py-2 text-right">CrÃ©ditos</th>
                  <th className="px-3 py-2 text-right">Monto (Bs)</th>
                </tr>
              </thead>
              <tbody>
                {datos.map((r, i) => (
                  <tr key={i} className="border-t">
                    <td className="px-3 py-2">{r.fecha}</td>
                    <td className="px-3 py-2 text-right">
                      {r.total_creditos}
                    </td>
                    <td className="px-3 py-2 text-right">{r.total_bs}</td>
                  </tr>
                ))}
                {datos.length === 0 && (
                  <tr>
                    <td
                      className="px-3 py-4 text-center text-gray-400"
                      colSpan={3}
                    >
                      Sin compras de crÃ©ditos en el rango.
                    </td>
                  </tr>
                )}
              </tbody>
            </table>
          </div>
        </section>
      </div>
    </div>
  );
}
</file>

<file path="frontend/src/pages/ReportesIntercambiosCategoria.jsx">
// src/pages/ReportesIntercambiosCategoria.jsx
import React, { useEffect, useMemo, useState } from "react";
import { getReporteIntercambiosCategoria } from "../services/api";
import {
  BarChart,
  Bar,
  XAxis,
  YAxis,
  Tooltip,
  ResponsiveContainer,
  PieChart,
  Pie,
  Legend,
  Cell,
} from "recharts";
import hoja from "../assets/hoja.png";

function hoyISO() {
  return new Date().toISOString().slice(0, 10);
}

function hace30DiasISO() {
  const d = new Date(Date.now() - 30 * 24 * 60 * 60 * 1000);
  return d.toISOString().slice(0, 10);
}

export default function ReportesIntercambiosCategoria() {
  const [desde, setDesde] = useState(hace30DiasISO());
  const [hasta, setHasta] = useState(hoyISO());
  const [datos, setDatos] = useState([]);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState("");

  async function cargar() {
    try {
      setLoading(true);
      setError("");
      const res = await getReporteIntercambiosCategoria({ desde, hasta });
      setDatos(Array.isArray(res) ? res : []);
    } catch (e) {
      console.error(e);
      setError("Error cargando intercambios por categorÃ­a");
      setDatos([]);
    } finally {
      setLoading(false);
    }
  }

  useEffect(() => {
    cargar();
  }, []);

  function handleSubmit(e) {
    e.preventDefault();
    cargar();
  }

  // =========================
  // MÃ‰TRICAS
  // =========================
  const metrics = useMemo(() => {
    if (!datos.length) {
      return {
        totalIntercambios: 0,
        categorias: 0,
        promedioPorCategoria: 0,
        topCategoria: null,
      };
    }

    const totalIntercambios = datos.reduce(
      (acc, c) => acc + Number(c.total_intercambios || 0),
      0
    );
    const categorias = datos.length;
    const promedioPorCategoria =
      categorias > 0 ? totalIntercambios / categorias : 0;

    const topCategoria = datos.reduce(
      (best, c) =>
        Number(c.total_intercambios || 0) >
        Number(best?.total_intercambios || 0)
          ? c
          : best,
      null
    );

    return { totalIntercambios, categorias, promedioPorCategoria, topCategoria };
  }, [datos]);

  // =========================
  // DATOS GRÃFICOS
  // =========================
  const barData = useMemo(
    () =>
      datos.map((c) => ({
        categoria: c.categoria,
        intercambios: Number(c.total_intercambios || 0),
      })),
    [datos]
  );

  const pieData = useMemo(
    () =>
      datos.map((c) => ({
        name: c.categoria,
        value: Number(c.total_intercambios || 0),
      })),
    [datos]
  );

  const COLORS = ["#047857", "#1e3a8a", "#0d9488", "#6d28d9", "#f59e0b"];

  return (
    <div
      className="min-h-screen p-8"
      style={{
        background: "linear-gradient(to bottom right, #f0fdf4, #d1fae5)",
        backgroundImage: `url(${hoja})`,
        backgroundRepeat: "no-repeat",
        backgroundPosition: "top right",
        backgroundSize: "160px",
      }}
    >
      <div className="max-w-6xl mx-auto space-y-8">
        {/* HEADER */}
        <header className="flex flex-col md:flex-row md:items-end md:justify-between gap-6">
          <div className="flex items-center gap-4">
            <div className="w-16 h-16 rounded-full bg-white shadow-md flex items-center justify-center border border-emerald-700/20">
              <img src={hoja} alt="Hoja" className="w-10 h-10" />
            </div>
            <div>
              <h1 className="text-3xl font-extrabold text-emerald-800 drop-shadow">
                Intercambios por categorÃ­a
              </h1>
              <p className="text-sm text-emerald-700/80">
                NÃºmero de intercambios agrupados por categorÃ­a de publicaciÃ³n.
              </p>
            </div>
          </div>

          <form
            onSubmit={handleSubmit}
            className="flex flex-wrap gap-4 items-end bg-white/70 px-4 py-3 rounded-xl shadow backdrop-blur text-sm"
          >
            <div className="flex flex-col">
              <label className="mb-1 font-semibold text-emerald-900">
                Desde
              </label>
              <input
                type="date"
                value={desde}
                onChange={(e) => setDesde(e.target.value)}
                className="border rounded px-2 py-1 text-sm shadow-sm"
              />
            </div>
            <div className="flex flex-col">
              <label className="mb-1 font-semibold text-emerald-900">
                Hasta
              </label>
              <input
                type="date"
                value={hasta}
                onChange={(e) => setHasta(e.target.value)}
                className="border rounded px-2 py-1 text-sm shadow-sm"
              />
            </div>
            <button
              type="submit"
              className="bg-emerald-700 hover:bg-emerald-800 text-white px-4 py-2 rounded-lg font-semibold shadow-md"
            >
              {loading ? "Cargandoâ€¦" : "Actualizar"}
            </button>
          </form>
        </header>

        {error && (
          <div className="bg-red-100 border border-red-300 text-red-700 text-sm px-4 py-2 rounded-lg shadow-sm">
            {error}
          </div>
        )}

        {/* KPIs */}
        <section className="grid md:grid-cols-4 gap-6">
          <div className="bg-white shadow-md border border-emerald-200/40 rounded-xl p-4">
            <p className="text-xs font-semibold text-emerald-700 uppercase">
              Intercambios totales
            </p>
            <p className="mt-2 text-3xl font-extrabold text-emerald-900">
              {metrics.totalIntercambios.toLocaleString()}
            </p>
          </div>

          <div className="bg-white shadow-md border border-slate-200/60 rounded-xl p-4">
            <p className="text-xs font-semibold text-slate-700 uppercase">
              CategorÃ­as con actividad
            </p>
            <p className="mt-2 text-3xl font-extrabold text-slate-900">
              {metrics.categorias}
            </p>
          </div>

          <div className="bg-white shadow-md border border-teal-200/60 rounded-xl p-4">
            <p className="text-xs font-semibold text-teal-700 uppercase">
              Promedio x categorÃ­a
            </p>
            <p className="mt-2 text-3xl font-extrabold text-teal-900">
              {metrics.promedioPorCategoria.toFixed(1)}
            </p>
          </div>

          <div className="bg-white shadow-md border border-emerald-200/60 rounded-xl p-4">
            <p className="text-xs font-semibold text-emerald-700 uppercase">
              CategorÃ­a mÃ¡s activa
            </p>
            {metrics.topCategoria ? (
              <>
                <p className="mt-2 text-base font-semibold text-emerald-900">
                  {metrics.topCategoria.categoria}
                </p>
                <p className="text-xs text-emerald-700/80">
                  {metrics.topCategoria.total_intercambios} intercambios
                </p>
              </>
            ) : (
              <p className="mt-2 text-sm text-emerald-700/80">
                Sin datos en el rango.
              </p>
            )}
          </div>
        </section>

        {/* GRÃFICOS */}
        <section className="grid lg:grid-cols-2 gap-6">
          {/* Barras */}
          <div className="bg-white rounded-xl border border-emerald-200/40 shadow p-4">
            <h2 className="text-lg font-semibold text-emerald-900 mb-2">
              Intercambios por categorÃ­a
            </h2>
            <p className="text-xs text-emerald-700/80 mb-3">
              ComparaciÃ³n de volumen de intercambios entre categorÃ­as.
            </p>

            <div className="h-72">
              {barData.length > 0 ? (
                <ResponsiveContainer>
                  <BarChart data={barData}>
                    <XAxis dataKey="categoria" hide />
                    <YAxis allowDecimals={false} />
                    <Tooltip />
                    <Bar
                      dataKey="intercambios"
                      name="Intercambios"
                      radius={[8, 8, 0, 0]}
                      fill="#047857"
                    />
                  </BarChart>
                </ResponsiveContainer>
              ) : (
                <div className="h-full flex items-center justify-center text-xs text-gray-400">
                  Sin datos para mostrar el grÃ¡fico.
                </div>
              )}
            </div>
          </div>

          {/* Pie */}
          <div className="bg-white rounded-xl border border-emerald-200/40 shadow p-4">
            <h2 className="text-lg font-semibold text-emerald-900 mb-2">
              DistribuciÃ³n de intercambios
            </h2>
            <p className="text-xs text-emerald-700/80 mb-3">
              ProporciÃ³n de intercambios por categorÃ­a dentro del periodo.
            </p>

            <div className="h-72">
              {pieData.length > 0 ? (
                <ResponsiveContainer>
                  <PieChart>
                    <Pie
                      data={pieData}
                      cx="50%"
                      cy="50%"
                      outerRadius={90}
                      label
                      dataKey="value"
                    >
                      {pieData.map((entry, index) => (
                        <Cell
                          key={`slice-${index}`}
                          fill={COLORS[index % COLORS.length]}
                        />
                      ))}
                    </Pie>
                    <Tooltip />
                    <Legend />
                  </PieChart>
                </ResponsiveContainer>
              ) : (
                <div className="h-full flex items-center justify-center text-xs text-gray-400">
                  Sin datos para mostrar el grÃ¡fico.
                </div>
              )}
            </div>
          </div>
        </section>

        {/* TABLA DETALLADA */}
        <section className="bg-white border border-emerald-200/40 rounded-xl shadow">
          <div className="px-4 py-3 border-b bg-emerald-50 rounded-t-xl">
            <h2 className="font-semibold text-emerald-900">
              Detalle por categorÃ­a
            </h2>
          </div>

          <div className="overflow-x-auto">
            <table className="min-w-full text-sm">
              <thead className="bg-slate-100">
                <tr>
                  <th className="px-3 py-2 text-left">CategorÃ­a</th>
                  <th className="px-3 py-2 text-right">Intercambios</th>
                </tr>
              </thead>
              <tbody>
                {datos.map((c, i) => (
                  <tr key={i} className="border-t">
                    <td className="px-3 py-2">{c.categoria}</td>
                    <td className="px-3 py-2 text-right">
                      {c.total_intercambios}
                    </td>
                  </tr>
                ))}
                {datos.length === 0 && (
                  <tr>
                    <td
                      className="px-3 py-4 text-center text-gray-400"
                      colSpan={2}
                    >
                      No hay intercambios en el rango.
                    </td>
                  </tr>
                )}
              </tbody>
            </table>
          </div>
        </section>
      </div>
    </div>
  );
}
</file>

<file path="frontend/src/pages/ReportesPublicacionesVsIntercambios.jsx">
// src/pages/ReportesPublicacionesIntercambios.jsx
import React, { useEffect, useMemo, useState } from "react";
import { getReportePublicacionesVsIntercambios } from "../services/api";
import {
  BarChart,
  Bar,
  XAxis,
  YAxis,
  Tooltip,
  ResponsiveContainer,
  PieChart,
  Pie,
  Legend,
  Cell,
} from "recharts";
import hoja from "../assets/hoja.png";

function hoyISO() {
  return new Date().toISOString().slice(0, 10);
}

function hace30DiasISO() {
  const d = new Date(Date.now() - 30 * 24 * 60 * 60 * 1000);
  return d.toISOString().slice(0, 10);
}

export default function ReportesPublicacionesIntercambios() {
  const [desde, setDesde] = useState(hace30DiasISO());
  const [hasta, setHasta] = useState(hoyISO());
  const [datos, setDatos] = useState([]);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState("");

  async function cargar() {
    try {
      setLoading(true);
      setError("");
      const res = await getReportePublicacionesVsIntercambios({
        desde,
        hasta,
      });
      setDatos(Array.isArray(res) ? res : []);
    } catch (e) {
      console.error(e);
      setError("Error cargando publicaciones vs intercambios");
      setDatos([]);
    } finally {
      setLoading(false);
    }
  }

  useEffect(() => {
    cargar();
  }, []);

  function handleSubmit(e) {
    e.preventDefault();
    cargar();
  }

  // ======================
  // MÃ‰TRICAS
  // ======================
  const metrics = useMemo(() => {
    if (!datos.length) {
      return {
        totalPublicaciones: 0,
        totalIntercambios: 0,
        categorias: 0,
        promedioRatio: 0,
        mejorCategoria: null,
      };
    }

    const totalPublicaciones = datos.reduce(
      (acc, p) => acc + Number(p.publicaciones || 0),
      0
    );
    const totalIntercambios = datos.reduce(
      (acc, p) => acc + Number(p.intercambios || 0),
      0
    );
    const categorias = datos.length;

    const ratiosNumericos = datos
      .map((p) => Number(p.ratio_intercambio ?? 0))
      .filter((r) => !Number.isNaN(r));

    const promedioRatio =
      ratiosNumericos.length > 0
        ? ratiosNumericos.reduce((a, b) => a + b, 0) / ratiosNumericos.length
        : 0;

    const mejorCategoria = datos.reduce(
      (best, p) =>
        Number(p.ratio_intercambio ?? 0) >
        Number(best?.ratio_intercambio ?? 0)
          ? p
          : best,
      null
    );

    return {
      totalPublicaciones,
      totalIntercambios,
      categorias,
      promedioRatio,
      mejorCategoria,
    };
  }, [datos]);

  // ======================
  // DATOS GRÃFICOS
  // ======================
  const barData = useMemo(
    () =>
      datos.map((p) => ({
        categoria: p.categoria,
        publicaciones: Number(p.publicaciones || 0),
        intercambios: Number(p.intercambios || 0),
      })),
    [datos]
  );

  const pieData = useMemo(
    () =>
      datos.map((p) => ({
        name: p.categoria,
        value: Number(p.intercambios || 0),
      })),
    [datos]
  );

  const COLORS = ["#047857", "#1e3a8a", "#0d9488", "#6d28d9", "#f59e0b"];

  return (
    <div
      className="min-h-screen p-8"
      style={{
        background: "linear-gradient(to bottom right, #f0fdf4, #d1fae5)",
        backgroundImage: `url(${hoja})`,
        backgroundRepeat: "no-repeat",
        backgroundPosition: "top right",
        backgroundSize: "160px",
      }}
    >
      <div className="max-w-6xl mx-auto space-y-8">
        {/* HEADER */}
        <header className="flex flex-col md:flex-row md:items-end md:justify-between gap-6">
          <div className="flex items-center gap-4">
            <div className="w-16 h-16 rounded-full bg-white shadow-md flex items-center justify-center border border-emerald-700/20">
              <img src={hoja} alt="Hoja" className="w-10 h-10" />
            </div>
            <div>
              <h1 className="text-3xl font-extrabold text-emerald-800 drop-shadow">
                Publicaciones vs intercambios por categorÃ­a
              </h1>
              <p className="text-sm text-emerald-700/80">
                RelaciÃ³n entre publicaciones creadas y las que se concretan
                como intercambio.
              </p>
            </div>
          </div>

          <form
            onSubmit={handleSubmit}
            className="flex flex-wrap gap-4 items-end bg-white/70 px-4 py-3 rounded-xl shadow backdrop-blur text-sm"
          >
            <div className="flex flex-col">
              <label className="mb-1 font-semibold text-emerald-900">
                Desde
              </label>
              <input
                type="date"
                value={desde}
                onChange={(e) => setDesde(e.target.value)}
                className="border rounded px-2 py-1 text-sm shadow-sm"
              />
            </div>
            <div className="flex flex-col">
              <label className="mb-1 font-semibold text-emerald-900">
                Hasta
              </label>
              <input
                type="date"
                value={hasta}
                onChange={(e) => setHasta(e.target.value)}
                className="border rounded px-2 py-1 text-sm shadow-sm"
              />
            </div>
            <button
              type="submit"
              className="bg-emerald-700 hover:bg-emerald-800 text-white px-4 py-2 rounded-lg font-semibold shadow-md"
            >
              {loading ? "Cargandoâ€¦" : "Actualizar"}
            </button>
          </form>
        </header>

        {error && (
          <div className="bg-red-100 border border-red-300 text-red-700 text-sm px-4 py-2 rounded-lg shadow-sm">
            {error}
          </div>
        )}

        {/* KPIs */}
        <section className="grid md:grid-cols-4 gap-6">
          <div className="bg-white shadow-md border border-emerald-200/40 rounded-xl p-4">
            <p className="text-xs font-semibold text-emerald-700 uppercase">
              Publicaciones totales
            </p>
            <p className="mt-2 text-3xl font-extrabold text-emerald-900">
              {metrics.totalPublicaciones.toLocaleString()}
            </p>
          </div>

          <div className="bg-white shadow-md border border-teal-200/60 rounded-xl p-4">
            <p className="text-xs font-semibold text-teal-700 uppercase">
              Intercambios totales
            </p>
            <p className="mt-2 text-3xl font-extrabold text-teal-900">
              {metrics.totalIntercambios.toLocaleString()}
            </p>
          </div>

          <div className="bg-white shadow-md border border-slate-200/60 rounded-xl p-4">
            <p className="text-xs font-semibold text-slate-700 uppercase">
              CategorÃ­as activas
            </p>
            <p className="mt-2 text-3xl font-extrabold text-slate-900">
              {metrics.categorias}
            </p>
          </div>

          <div className="bg-white shadow-md border border-emerald-200/60 rounded-xl p-4">
            <p className="text-xs font-semibold text-emerald-700 uppercase">
              Ratio promedio
            </p>
            <p className="mt-2 text-3xl font-extrabold text-emerald-900">
              {metrics.promedioRatio.toFixed(2)}
            </p>
            {metrics.mejorCategoria && (
              <p className="mt-1 text-[11px] text-emerald-700/80">
                Mejor categorÃ­a:{" "}
                <span className="font-semibold">
                  {metrics.mejorCategoria.categoria} (
                  {metrics.mejorCategoria.ratio_intercambio})
                </span>
              </p>
            )}
          </div>
        </section>

        {/* GRÃFICOS */}
        <section className="grid lg:grid-cols-2 gap-6">
          {/* Barras: publicaciones vs intercambios */}
          <div className="bg-white rounded-xl border border-emerald-200/40 shadow p-4">
            <h2 className="text-lg font-semibold text-emerald-900 mb-2">
              Publicaciones vs intercambios por categorÃ­a
            </h2>
            <p className="text-xs text-emerald-700/80 mb-3">
              ComparaciÃ³n del volumen de publicaciones frente a intercambios
              concretados.
            </p>

            <div className="h-72">
              {barData.length > 0 ? (
                <ResponsiveContainer>
                  <BarChart data={barData}>
                    <XAxis dataKey="categoria" hide />
                    <YAxis allowDecimals={false} />
                    <Tooltip />
                    <Legend />
                    <Bar
                      dataKey="publicaciones"
                      name="Publicaciones"
                      fill="#1e3a8a"
                      radius={[8, 8, 0, 0]}
                    />
                    <Bar
                      dataKey="intercambios"
                      name="Intercambios"
                      fill="#047857"
                      radius={[8, 8, 0, 0]}
                    />
                  </BarChart>
                </ResponsiveContainer>
              ) : (
                <div className="h-full flex items-center justify-center text-xs text-gray-400">
                  Sin datos para mostrar el grÃ¡fico.
                </div>
              )}
            </div>
          </div>

          {/* Pie: distribuciÃ³n de intercambios */}
          <div className="bg-white rounded-xl border border-emerald-200/40 shadow p-4">
            <h2 className="text-lg font-semibold text-emerald-900 mb-2">
              DistribuciÃ³n de intercambios por categorÃ­a
            </h2>
            <p className="text-xs text-emerald-700/80 mb-3">
              ProporciÃ³n de intercambios por categorÃ­a en el periodo.
            </p>

            <div className="h-72">
              {pieData.length > 0 ? (
                <ResponsiveContainer>
                  <PieChart>
                    <Pie
                      data={pieData}
                      cx="50%"
                      cy="50%"
                      outerRadius={90}
                      label
                      dataKey="value"
                    >
                      {pieData.map((entry, index) => (
                        <Cell
                          key={`slice-${index}`}
                          fill={COLORS[index % COLORS.length]}
                        />
                      ))}
                    </Pie>
                    <Tooltip />
                    <Legend />
                  </PieChart>
                </ResponsiveContainer>
              ) : (
                <div className="h-full flex items-center justify-center text-xs text-gray-400">
                  Sin datos para mostrar el grÃ¡fico.
                </div>
              )}
            </div>
          </div>
        </section>

        {/* TABLA DETALLADA */}
        <section className="bg-white border border-emerald-200/40 rounded-xl shadow">
          <div className="px-4 py-3 border-b bg-emerald-50 rounded-t-xl">
            <h2 className="font-semibold text-emerald-900">
              Detalle por categorÃ­a
            </h2>
          </div>

          <div className="overflow-x-auto">
            <table className="min-w-full text-sm">
              <thead className="bg-slate-100">
                <tr>
                  <th className="px-3 py-2 text-left">CategorÃ­a</th>
                  <th className="px-3 py-2 text-right">Publicaciones</th>
                  <th className="px-3 py-2 text-right">Intercambios</th>
                  <th className="px-3 py-2 text-right">Ratio</th>
                </tr>
              </thead>
              <tbody>
                {datos.map((p, i) => (
                  <tr key={i} className="border-t">
                    <td className="px-3 py-2">{p.categoria}</td>
                    <td className="px-3 py-2 text-right">
                      {p.publicaciones}
                    </td>
                    <td className="px-3 py-2 text-right">
                      {p.intercambios}
                    </td>
                    <td className="px-3 py-2 text-right">
                      {p.ratio_intercambio ?? "-"}
                    </td>
                  </tr>
                ))}
                {datos.length === 0 && (
                  <tr>
                    <td
                      className="px-3 py-4 text-center text-gray-400"
                      colSpan={4}
                    >
                      Sin datos para el rango.
                    </td>
                  </tr>
                )}
              </tbody>
            </table>
          </div>
        </section>
      </div>
    </div>
  );
}
</file>

<file path="frontend/src/pages/ReportesRankingUsuarios.jsx">
// src/pages/ReportesRankingUsuarios.jsx
import React, { useMemo, useState } from "react";
import { getReporteRankingUsuarios } from "../services/api";
import {
  BarChart,
  Bar,
  XAxis,
  YAxis,
  Tooltip,
  ResponsiveContainer,
  Legend,
} from "recharts";
import hoja from "../assets/hoja.png";

export default function ReportesRankingUsuarios() {
  const [idPeriodo, setIdPeriodo] = useState("");
  const [limit, setLimit] = useState(10);
  const [datos, setDatos] = useState([]);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState("");

  async function cargar() {
    try {
      setLoading(true);
      setError("");
      const res = await getReporteRankingUsuarios({ idPeriodo, limit });
      setDatos(Array.isArray(res) ? res : []);
    } catch (e) {
      console.error(e);
      setError("Error cargando ranking de usuarios");
      setDatos([]);
    } finally {
      setLoading(false);
    }
  }

  // =========================
  // MÃ‰TRICAS GLOBALES
  // =========================
  const metrics = useMemo(() => {
    if (!datos.length) {
      return {
        totalCo2: 0,
        totalAgua: 0,
        totalEnergia: 0,
        totalTransacciones: 0,
        usuarios: 0,
        topUsuario: null,
      };
    }

    const totalCo2 = datos.reduce(
      (acc, r) => acc + Number(r.co2_total || 0),
      0
    );
    const totalAgua = datos.reduce(
      (acc, r) => acc + Number(r.agua_total || 0),
      0
    );
    const totalEnergia = datos.reduce(
      (acc, r) => acc + Number(r.energia_total || 0),
      0
    );
    const totalTransacciones = datos.reduce(
      (acc, r) => acc + Number(r.transacciones || 0),
      0
    );
    const usuarios = datos.length;

    const topUsuario = datos.reduce(
      (best, r) => {
        const impacto =
          Number(r.co2_total || 0) +
          Number(r.agua_total || 0) +
          Number(r.energia_total || 0);
        const bestImpacto =
          Number(best?.co2_total || 0) +
          Number(best?.agua_total || 0) +
          Number(best?.energia_total || 0);
        return impacto > bestImpacto ? r : best;
      },
      null
    );

    return {
      totalCo2,
      totalAgua,
      totalEnergia,
      totalTransacciones,
      usuarios,
      topUsuario,
    };
  }, [datos]);

  // =========================
  // DATOS PARA GRÃFICOS
  // =========================
  const chartImpacto = useMemo(
    () =>
      datos.map((r) => ({
        usuario: `U${r.id_usuario}`,
        impacto:
          Number(r.co2_total || 0) +
          Number(r.agua_total || 0) +
          Number(r.energia_total || 0),
      })),
    [datos]
  );

  const chartTransacciones = useMemo(
    () =>
      datos.map((r) => ({
        usuario: `U${r.id_usuario}`,
        transacciones: Number(r.transacciones || 0),
      })),
    [datos]
  );

  return (
    <div
      className="min-h-screen p-8"
      style={{
        background: "linear-gradient(to bottom right, #f0fdf4, #d1fae5)",
        backgroundImage: `url(${hoja})`,
        backgroundRepeat: "no-repeat",
        backgroundPosition: "top right",
        backgroundSize: "160px",
      }}
    >
      <div className="max-w-6xl mx-auto space-y-8">
        {/* HEADER */}
        <header className="flex flex-col md:flex-row md:items-end md:justify-between gap-6">
          <div className="flex items-center gap-4">
            <div className="w-16 h-16 rounded-full bg-white shadow-md flex items-center justify-center border border-emerald-700/20">
              <img src={hoja} alt="Hoja" className="w-10 h-10" />
            </div>
            <div>
              <h1 className="text-3xl font-extrabold text-emerald-800 drop-shadow">
                Ranking de usuarios por impacto
              </h1>
              <p className="text-sm text-emerald-700/80">
                Usuarios ordenados por impacto ambiental (COâ‚‚, agua, energÃ­a).
              </p>
            </div>
          </div>

          <div className="flex flex-wrap gap-4 items-end text-sm bg-white/70 px-4 py-3 rounded-xl shadow backdrop-blur">
            <div className="flex flex-col">
              <label className="mb-1 font-semibold text-emerald-900">
                ID perÃ­odo (opcional)
              </label>
              <input
                type="number"
                min="1"
                value={idPeriodo}
                onChange={(e) => setIdPeriodo(e.target.value)}
                className="border rounded px-2 py-1 text-sm w-24 shadow-sm"
                placeholder="ej. 1"
              />
            </div>

            <div className="flex flex-col">
              <label className="mb-1 font-semibold text-emerald-900">
                Top N
              </label>
              <input
                type="number"
                min="1"
                value={limit}
                onChange={(e) => setLimit(Number(e.target.value) || 1)}
                className="border rounded px-2 py-1 text-sm w-20 shadow-sm"
              />
            </div>

            <button
              type="button"
              onClick={cargar}
              className="bg-emerald-700 hover:bg-emerald-800 text-white px-4 py-2 rounded-lg text-sm font-semibold shadow-md"
            >
              {loading ? "Cargandoâ€¦" : "Actualizar"}
            </button>
          </div>
        </header>

        {error && (
          <div className="bg-red-100 border border-red-300 text-red-700 text-sm px-4 py-2 rounded-lg shadow-sm">
            {error}
          </div>
        )}

        {/* KPIs */}
        <section className="grid md:grid-cols-5 gap-6">
          <div className="bg-white shadow-md border border-emerald-200/40 rounded-xl p-4">
            <p className="text-xs font-semibold text-emerald-700 uppercase">
              COâ‚‚ total (kg)
            </p>
            <p className="mt-2 text-3xl font-extrabold text-emerald-900">
              {metrics.totalCo2.toLocaleString()}
            </p>
          </div>

          <div className="bg-white shadow-md border border-blue-200/60 rounded-xl p-4">
            <p className="text-xs font-semibold text-blue-700 uppercase">
              Agua total (L)
            </p>
            <p className="mt-2 text-3xl font-extrabold text-blue-900">
              {metrics.totalAgua.toLocaleString()}
            </p>
          </div>

          <div className="bg-white shadow-md border border-teal-200/60 rounded-xl p-4">
            <p className="text-xs font-semibold text-teal-700 uppercase">
              EnergÃ­a total (kWh)
            </p>
            <p className="mt-2 text-3xl font-extrabold text-teal-900">
              {metrics.totalEnergia.toLocaleString()}
            </p>
          </div>

          <div className="bg-white shadow-md border border-slate-200/60 rounded-xl p-4">
            <p className="text-xs font-semibold text-slate-700 uppercase">
              Transacciones
            </p>
            <p className="mt-2 text-3xl font-extrabold text-slate-900">
              {metrics.totalTransacciones.toLocaleString()}
            </p>
          </div>

          <div className="bg-white shadow-md border border-emerald-200/40 rounded-xl p-4">
            <p className="text-xs font-semibold text-emerald-700 uppercase">
              Usuarios en ranking
            </p>
            <p className="mt-2 text-3xl font-extrabold text-emerald-900">
              {metrics.usuarios}
            </p>
            {metrics.topUsuario && (
              <p className="mt-1 text-[11px] text-emerald-700/80">
                Top 1:{" "}
                <span className="font-semibold">
                  U{metrics.topUsuario.id_usuario}
                </span>
              </p>
            )}
          </div>
        </section>

        {/* GRÃFICOS */}
        <section className="grid lg:grid-cols-2 gap-6">
          {/* Impacto total por usuario */}
          <div className="bg-white rounded-xl border border-emerald-200/40 shadow p-4">
            <h2 className="text-lg font-semibold text-emerald-900 mb-2">
              Impacto ambiental total por usuario
            </h2>
            <p className="text-xs text-emerald-700/80 mb-3">
              Suma de COâ‚‚, agua y energÃ­a por usuario en el ranking.
            </p>

            <div className="h-72">
              {chartImpacto.length > 0 ? (
                <ResponsiveContainer>
                  <BarChart data={chartImpacto}>
                    <XAxis dataKey="usuario" />
                    <YAxis />
                    <Tooltip />
                    <Bar
                      dataKey="impacto"
                      name="Impacto total (unidades combinadas)"
                      fill="#047857"
                      radius={[8, 8, 0, 0]}
                    />
                  </BarChart>
                </ResponsiveContainer>
              ) : (
                <div className="h-full flex items-center justify-center text-xs text-gray-400">
                  Sin datos para mostrar el grÃ¡fico.
                </div>
              )}
            </div>
          </div>

          {/* Transacciones por usuario */}
          <div className="bg-white rounded-xl border border-emerald-200/40 shadow p-4">
            <h2 className="text-lg font-semibold text-emerald-900 mb-2">
              Transacciones por usuario
            </h2>
            <p className="text-xs text-emerald-700/80 mb-3">
              Volumen de transacciones de los usuarios en el ranking.
            </p>

            <div className="h-72">
              {chartTransacciones.length > 0 ? (
                <ResponsiveContainer>
                  <BarChart data={chartTransacciones}>
                    <XAxis dataKey="usuario" />
                    <YAxis allowDecimals={false} />
                    <Tooltip />
                    <Legend />
                    <Bar
                      dataKey="transacciones"
                      name="Transacciones"
                      fill="#1e3a8a"
                      radius={[8, 8, 0, 0]}
                    />
                  </BarChart>
                </ResponsiveContainer>
              ) : (
                <div className="h-full flex items-center justify-center text-xs text-gray-400">
                  Sin datos para mostrar el grÃ¡fico.
                </div>
              )}
            </div>
          </div>
        </section>

        {/* TABLA DETALLADA */}
        <section className="bg-white border border-emerald-200/40 rounded-xl shadow">
          <div className="px-4 py-3 border-b bg-emerald-50 rounded-t-xl">
            <h2 className="font-semibold text-emerald-900">
              Detalle del ranking de usuarios
            </h2>
          </div>

          <div className="overflow-x-auto">
            <table className="min-w-full text-sm">
              <thead className="bg-slate-100">
                <tr>
                  <th className="px-3 py-2 text-left">Usuario (ID)</th>
                  <th className="px-3 py-2 text-right">COâ‚‚ total (kg)</th>
                  <th className="px-3 py-2 text-right">Agua total (L)</th>
                  <th className="px-3 py-2 text-right">EnergÃ­a total (kWh)</th>
                  <th className="px-3 py-2 text-right">Transacciones</th>
                </tr>
              </thead>
              <tbody>
                {datos.map((r, i) => (
                  <tr key={i} className="border-t">
                    <td className="px-3 py-2">U{r.id_usuario}</td>
                    <td className="px-3 py-2 text-right">
                      {r.co2_total}
                    </td>
                    <td className="px-3 py-2 text-right">
                      {r.agua_total}
                    </td>
                    <td className="px-3 py-2 text-right">
                      {r.energia_total}
                    </td>
                    <td className="px-3 py-2 text-right">
                      {r.transacciones}
                    </td>
                  </tr>
                ))}
                {datos.length === 0 && (
                  <tr>
                    <td
                      className="px-3 py-4 text-center text-gray-400"
                      colSpan={5}
                    >
                      Sin datos de ranking para los filtros actuales.
                    </td>
                  </tr>
                )}
              </tbody>
            </table>
          </div>
        </section>
      </div>
    </div>
  );
}
</file>

<file path="frontend/src/pages/ReportesSaldosUsuarios.jsx">
// src/pages/ReportesSaldosUsuarios.jsx
import React, { useEffect, useMemo, useState } from "react";
import { getReporteSaldosUsuarios } from "../services/api";
import {
  BarChart,
  Bar,
  XAxis,
  YAxis,
  Tooltip,
  ResponsiveContainer,
  PieChart,
  Pie,
  Legend,
  Cell,
} from "recharts";
import hoja from "../assets/hoja.png";

export default function ReportesSaldosUsuarios() {
  const [limit, setLimit] = useState(20);
  const [datos, setDatos] = useState([]);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState("");

  async function cargar() {
    try {
      setLoading(true);
      setError("");
      const res = await getReporteSaldosUsuarios({ limit });
      setDatos(Array.isArray(res) ? res : []);
    } catch (e) {
      console.error(e);
      setError("Error cargando saldos de usuarios");
      setDatos([]);
    } finally {
      setLoading(false);
    }
  }

  useEffect(() => {
    cargar();
  }, []);

  // =========================
  // MÃ‰TRICAS
  // =========================
  const metrics = useMemo(() => {
    if (!datos.length) {
      return {
        totalUsuarios: 0,
        totalSaldo: 0,
        promedioSaldo: 0,
        topUsuario: null,
      };
    }

    const totalUsuarios = datos.length;
    const totalSaldo = datos.reduce(
      (acc, u) => acc + Number(u.saldo_creditos || 0),
      0
    );
    const promedioSaldo =
      totalUsuarios > 0 ? totalSaldo / totalUsuarios : 0;

    const topUsuario = datos.reduce(
      (best, u) =>
        Number(u.saldo_creditos || 0) >
        Number(best?.saldo_creditos || 0)
          ? u
          : best,
      null
    );

    return { totalUsuarios, totalSaldo, promedioSaldo, topUsuario };
  }, [datos]);

  // =========================
  // DATOS GRÃFICOS
  // =========================
  const barData = useMemo(
    () =>
      datos.map((u, index) => ({
        etiqueta: `U${index + 1}`,
        nombre: u.nombre,
        saldo: Number(u.saldo_creditos || 0),
      })),
    [datos]
  );

  const pieData = useMemo(
    () =>
      datos.map((u) => ({
        name: u.nombre,
        value: Number(u.saldo_creditos || 0),
      })),
    [datos]
  );

  const COLORS = ["#047857", "#1e3a8a", "#0d9488", "#6d28d9", "#f59e0b"];

  return (
    <div
      className="min-h-screen p-8"
      style={{
        background: "linear-gradient(to bottom right, #f0fdf4, #d1fae5)",
        backgroundImage: `url(${hoja})`,
        backgroundRepeat: "no-repeat",
        backgroundPosition: "top right",
        backgroundSize: "160px",
      }}
    >
      <div className="max-w-6xl mx-auto space-y-8">
        {/* HEADER */}
        <header className="flex flex-col md:flex-row md:items-end md:justify-between gap-6">
          <div className="flex items-center gap-4">
            <div className="w-16 h-16 rounded-full bg-white shadow-md flex items-center justify-center border border-emerald-700/20">
              <img src={hoja} alt="Hoja" className="w-10 h-10" />
            </div>
            <div>
              <h1 className="text-3xl font-extrabold text-emerald-800 drop-shadow">
                Saldos de crÃ©ditos por usuario
              </h1>
              <p className="text-sm text-emerald-700/80">
                Top de usuarios con mayor saldo en su billetera.
              </p>
            </div>
          </div>

          <div className="flex flex-wrap gap-4 items-end text-sm bg-white/70 px-4 py-3 rounded-xl shadow backdrop-blur">
            <div className="flex flex-col">
              <label className="mb-1 font-semibold text-emerald-900">
                Top N
              </label>
              <input
                type="number"
                min="1"
                value={limit}
                onChange={(e) =>
                  setLimit(Math.max(1, Number(e.target.value) || 1))
                }
                className="border rounded px-2 py-1 text-sm w-20 shadow-sm"
              />
            </div>
            <button
              type="button"
              onClick={cargar}
              className="bg-emerald-700 hover:bg-emerald-800 text-white px-4 py-2 rounded-lg text-sm font-semibold shadow-md"
            >
              {loading ? "Cargandoâ€¦" : "Actualizar"}
            </button>
          </div>
        </header>

        {error && (
          <div className="bg-red-100 border border-red-300 text-red-700 text-sm px-4 py-2 rounded-lg shadow-sm">
            {error}
          </div>
        )}

        {/* KPIs */}
        <section className="grid md:grid-cols-3 gap-6">
          <div className="bg-white shadow-md border border-emerald-200/40 rounded-xl p-4">
            <p className="text-xs font-semibold text-emerald-700 uppercase">
              Usuarios en el ranking
            </p>
            <p className="mt-2 text-3xl font-extrabold text-emerald-900">
              {metrics.totalUsuarios}
            </p>
          </div>

          <div className="bg-white shadow-md border border-blue-200/60 rounded-xl p-4">
            <p className="text-xs font-semibold text-blue-700 uppercase">
              Saldo total (crÃ©ditos)
            </p>
            <p className="mt-2 text-3xl font-extrabold text-blue-900">
              {metrics.totalSaldo.toLocaleString()}
            </p>
          </div>

          <div className="bg-white shadow-md border border-teal-200/60 rounded-xl p-4">
            <p className="text-xs font-semibold text-teal-700 uppercase">
              Saldo promedio
            </p>
            <p className="mt-2 text-3xl font-extrabold text-teal-900">
              {metrics.promedioSaldo.toFixed(1)}
            </p>
          </div>
        </section>

        {/* Usuario Top */}
        <section className="grid md:grid-cols-3 gap-6">
          <div className="md:col-span-3 bg-white shadow-md border border-emerald-200/40 rounded-xl p-4 flex flex-col md:flex-row md:items-center md:justify-between gap-4">
            <div>
              <p className="text-xs font-semibold text-emerald-700 uppercase">
                Usuario con mayor saldo
              </p>
              {metrics.topUsuario ? (
                <>
                  <p className="mt-1 text-lg font-bold text-emerald-900">
                    {metrics.topUsuario.nombre}
                  </p>
                  <p className="text-xs text-slate-700">
                    {metrics.topUsuario.correo}
                  </p>
                </>
              ) : (
                <p className="mt-1 text-sm text-emerald-700/80">
                  No hay datos para mostrar.
                </p>
              )}
            </div>
            {metrics.topUsuario && (
              <div className="text-right">
                <p className="text-xs font-semibold text-slate-700 uppercase">
                  Saldo crÃ©ditos
                </p>
                <p className="mt-1 text-3xl font-extrabold text-emerald-900">
                  {Number(
                    metrics.topUsuario.saldo_creditos || 0
                  ).toLocaleString()}
                </p>
              </div>
            )}
          </div>
        </section>

        {/* GRÃFICOS */}
        <section className="grid lg:grid-cols-2 gap-6">
          {/* Barras */}
          <div className="bg-white rounded-xl border border-emerald-200/40 shadow p-4">
            <h2 className="text-lg font-semibold text-emerald-900 mb-2">
              Saldos por usuario
            </h2>
            <p className="text-xs text-emerald-700/80 mb-3">
              ComparaciÃ³n del saldo de crÃ©ditos entre los usuarios del top.
            </p>

            <div className="h-72">
              {barData.length > 0 ? (
                <ResponsiveContainer>
                  <BarChart data={barData}>
                    <XAxis dataKey="etiqueta" />
                    <YAxis />
                    <Tooltip
                      formatter={(value, name, props) => [
                        value,
                        props.payload.nombre,
                      ]}
                    />
                    <Bar
                      dataKey="saldo"
                      name="Saldo crÃ©ditos"
                      fill="#047857"
                      radius={[8, 8, 0, 0]}
                    />
                  </BarChart>
                </ResponsiveContainer>
              ) : (
                <div className="h-full flex items-center justify-center text-xs text-gray-400">
                  Sin datos para mostrar el grÃ¡fico.
                </div>
              )}
            </div>
          </div>

          {/* Pie */}
          <div className="bg-white rounded-xl border border-emerald-200/40 shadow p-4">
            <h2 className="text-lg font-semibold text-emerald-900 mb-2">
              DistribuciÃ³n de saldos
            </h2>
            <p className="text-xs text-emerald-700/80 mb-3">
              ProporciÃ³n del saldo total que concentra cada usuario.
            </p>

            <div className="h-72">
              {pieData.length > 0 ? (
                <ResponsiveContainer>
                  <PieChart>
                    <Pie
                      data={pieData}
                      cx="50%"
                      cy="50%"
                      outerRadius={90}
                      label
                      dataKey="value"
                    >
                      {pieData.map((entry, index) => (
                        <Cell
                          key={`slice-${index}`}
                          fill={COLORS[index % COLORS.length]}
                        />
                      ))}
                    </Pie>
                    <Tooltip />
                    <Legend />
                  </PieChart>
                </ResponsiveContainer>
              ) : (
                <div className="h-full flex items-center justify-center text-xs text-gray-400">
                  Sin datos para mostrar el grÃ¡fico.
                </div>
              )}
            </div>
          </div>
        </section>

        {/* TABLA DETALLADA */}
        <section className="bg-white border border-emerald-200/40 rounded-xl shadow">
          <div className="px-4 py-3 border-b bg-emerald-50 rounded-t-xl">
            <h2 className="font-semibold text-emerald-900">
              Detalle de saldos por usuario
            </h2>
          </div>

          <div className="overflow-x-auto">
            <table className="min-w-full text-sm">
              <thead className="bg-slate-100">
                <tr>
                  <th className="px-3 py-2 text-left">Usuario</th>
                  <th className="px-3 py-2 text-left">Correo</th>
                  <th className="px-3 py-2 text-right">Saldo crÃ©ditos</th>
                </tr>
              </thead>
              <tbody>
                {datos.map((u, i) => (
                  <tr key={i} className="border-t">
                    <td className="px-3 py-2">{u.nombre}</td>
                    <td className="px-3 py-2">{u.correo}</td>
                    <td className="px-3 py-2 text-right">
                      {u.saldo_creditos}
                    </td>
                  </tr>
                ))}
                {datos.length === 0 && (
                  <tr>
                    <td
                      className="px-3 py-4 text-center text-gray-400"
                      colSpan={3}
                    >
                      Sin datos de saldos para mostrar.
                    </td>
                  </tr>
                )}
              </tbody>
            </table>
          </div>
        </section>
      </div>
    </div>
  );
}
</file>

<file path="frontend/src/pages/ReportesUsuarios.jsx">
// src/pages/ReportesUsuarios.jsx
import React, { useEffect, useMemo, useState } from "react";
import {
  getReporteUsuariosActivos,
  getReporteUsuariosAbandonados,
  getReporteUsuariosNuevos,
} from "../services/api";
import {
  BarChart,
  Bar,
  XAxis,
  YAxis,
  Tooltip,
  ResponsiveContainer,
  Legend,
} from "recharts";
import hoja from "../assets/hoja.png";

function hoyISO() {
  return new Date().toISOString().slice(0, 10);
}

function hace30DiasISO() {
  const d = new Date(Date.now() - 30 * 24 * 60 * 60 * 1000);
  return d.toISOString().slice(0, 10);
}

export default function ReportesUsuarios() {
  const [desde, setDesde] = useState(hace30DiasISO());
  const [hasta, setHasta] = useState(hoyISO());

  const [activos, setActivos] = useState([]);
  const [abandonados, setAbandonados] = useState([]);
  const [nuevos, setNuevos] = useState([]);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState("");

  async function cargar() {
    try {
      setLoading(true);
      setError("");
      const [a, b, n] = await Promise.all([
        getReporteUsuariosActivos({ desde, hasta }),
        getReporteUsuariosAbandonados({ desde, hasta }),
        getReporteUsuariosNuevos({ desde, hasta }),
      ]);
      setActivos(Array.isArray(a) ? a : []);
      setAbandonados(Array.isArray(b) ? b : []);
      setNuevos(Array.isArray(n) ? n : []);
    } catch (e) {
      console.error(e);
      setError("Error cargando reportes de usuarios");
      setActivos([]);
      setAbandonados([]);
      setNuevos([]);
    } finally {
      setLoading(false);
    }
  }

  useEffect(() => {
    cargar();
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, []);

  function handleSubmit(e) {
    e.preventDefault();
    cargar();
  }

  // =========================
  // MÃ‰TRICAS
  // =========================
  const metrics = useMemo(() => {
    const totalActivos = activos.length;
    const totalAbandonados = abandonados.length;
    const totalNuevos = nuevos.length;
    const totalUsuariosPeriodo =
      totalActivos + totalAbandonados + totalNuevos;

    const tasaRetencion =
      totalUsuariosPeriodo > 0
        ? (totalActivos / totalUsuariosPeriodo) * 100
        : 0;
    const tasaAbandono =
      totalUsuariosPeriodo > 0
        ? (totalAbandonados / totalUsuariosPeriodo) * 100
        : 0;

    return {
      totalActivos,
      totalAbandonados,
      totalNuevos,
      totalUsuariosPeriodo,
      tasaRetencion,
      tasaAbandono,
    };
  }, [activos, abandonados, nuevos]);

  const chartResumen = useMemo(
    () => [
      { tipo: "Activos", cantidad: metrics.totalActivos },
      { tipo: "Abandonados", cantidad: metrics.totalAbandonados },
      { tipo: "Nuevos", cantidad: metrics.totalNuevos },
    ],
    [metrics.totalActivos, metrics.totalAbandonados, metrics.totalNuevos]
  );

  return (
    <div
      className="min-h-screen p-8"
      style={{
        background: "linear-gradient(to bottom right, #f0fdf4, #d1fae5)",
        backgroundImage: `url(${hoja})`,
        backgroundRepeat: "no-repeat",
        backgroundPosition: "top right",
        backgroundSize: "160px",
      }}
    >
      <div className="max-w-6xl mx-auto bg-emerald-900/90 rounded-2xl shadow-xl text-white p-6 md:p-8">
        <header className="mb-6 border-b border-emerald-500/40 pb-4">
          <h1 className="text-2xl md:text-3xl font-bold flex items-center gap-3">
            <span className="inline-flex h-10 w-10 items-center justify-center rounded-full bg-emerald-500/20 border border-emerald-400/60">
              ðŸ“Š
            </span>
            Reporte de usuarios activos, abandonados y nuevos (primer login)
          </h1>
          <p className="mt-2 text-sm text-emerald-100/80">
            Analiza el comportamiento de los usuarios en un rango de fechas:
            quiÃ©nes se mantienen activos, quiÃ©nes abandonan y quiÃ©nes ingresan
            por primera vez a la plataforma.
          </p>
        </header>

        {/* Filtros */}
        <section className="mb-6 bg-emerald-800/80 rounded-xl p-4 border border-emerald-500/40">
          <form
            onSubmit={handleSubmit}
            className="flex flex-col md:flex-row md:items-end gap-4"
          >
            <div className="flex-1">
              <label className="block text-xs font-semibold text-emerald-200 mb-1">
                Desde
              </label>
              <input
                type="date"
                value={desde}
                onChange={(e) => setDesde(e.target.value)}
                className="w-full rounded-lg bg-emerald-900/60 border border-emerald-500/60 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-emerald-400"
              />
            </div>
            <div className="flex-1">
              <label className="block text-xs font-semibold text-emerald-200 mb-1">
                Hasta
              </label>
              <input
                type="date"
                value={hasta}
                onChange={(e) => setHasta(e.target.value)}
                className="w-full rounded-lg bg-emerald-900/60 border border-emerald-500/60 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-emerald-400"
              />
            </div>

            <button
              type="submit"
              className="inline-flex items-center justify-center rounded-lg bg-emerald-500 hover:bg-emerald-400 px-4 py-2 text-sm font-semibold shadow-md transition-colors"
            >
              Actualizar reporte
            </button>
          </form>

          {error && (
            <p className="mt-3 text-xs text-red-300 bg-red-900/30 border border-red-400/60 rounded-md px-3 py-2">
              {error}
            </p>
          )}

          {loading && (
            <p className="mt-3 text-xs text-emerald-100/80">
              Cargando datos...
            </p>
          )}
        </section>

        {/* Tarjetas de mÃ©tricas */}
        <section className="grid md:grid-cols-4 gap-4 mb-6">
          <div className="bg-white shadow-md border border-emerald-200/60 rounded-xl p-4">
            <p className="text-xs font-semibold text-emerald-700 uppercase">
              Usuarios activos
            </p>
            <p className="mt-2 text-3xl font-extrabold text-emerald-900">
              {metrics.totalActivos}
            </p>
            <p className="text-[11px] text-emerald-700/80 mt-1">
              Usuarios con actividad reciente en el perÃ­odo.
            </p>
          </div>

          <div className="bg-white shadow-md border border-emerald-200/60 rounded-xl p-4">
            <p className="text-xs font-semibold text-emerald-700 uppercase">
              Usuarios abandonados
            </p>
            <p className="mt-2 text-3xl font-extrabold text-emerald-900">
              {metrics.totalAbandonados}
            </p>
            <p className="text-[11px] text-emerald-700/80 mt-1">
              Usuarios que dejaron de usar la plataforma en el perÃ­odo.
            </p>
          </div>

          <div className="bg-white shadow-md border border-emerald-200/60 rounded-xl p-4">
            <p className="text-xs font-semibold text-emerald-700 uppercase">
              Nuevos usuarios
            </p>
            <p className="mt-2 text-3xl font-extrabold text-emerald-900">
              {metrics.totalNuevos}
            </p>
            <p className="text-[11px] text-emerald-700/80 mt-1">
              Usuarios cuyo primer login estÃ¡ dentro del rango.
            </p>
          </div>

          <div className="bg-white shadow-md border border-emerald-200/60 rounded-xl p-4">
            <p className="text-xs font-semibold text-emerald-700 uppercase">
              Tasa de retenciÃ³n
            </p>
            <p className="mt-2 text-3xl font-extrabold text-emerald-900">
              {metrics.tasaRetencion.toFixed(1)}%
            </p>
            <p className="text-[11px] text-emerald-700/80 mt-1">
              Abandono: {metrics.tasaAbandono.toFixed(1)}%
            </p>
          </div>
        </section>

        {/* GrÃ¡fico resumen */}
        <section className="grid lg:grid-cols-2 gap-6 mb-6">
          <div className="bg-white rounded-xl border border-emerald-200/40 shadow p-4">
            <h2 className="text-lg font-semibold text-emerald-900 mb-2">
              DistribuciÃ³n de usuarios por tipo
            </h2>
            <p className="text-xs text-emerald-700/80 mb-3">
              ComparaciÃ³n entre usuarios activos, abandonados y nuevos.
            </p>
            <div className="h-72">
              <ResponsiveContainer>
                <BarChart data={chartResumen}>
                  <XAxis dataKey="tipo" />
                  <YAxis allowDecimals={false} />
                  <Tooltip />
                  <Legend />
                  <Bar
                    dataKey="cantidad"
                    name="Usuarios"
                    radius={[8, 8, 0, 0]}
                  />
                </BarChart>
              </ResponsiveContainer>
            </div>
          </div>

          <div className="bg-white rounded-xl border border-emerald-200/40 shadow p-4 flex flex-col justify-center">
            <h2 className="text-lg font-semibold text-emerald-900 mb-2">
              Resumen del periodo
            </h2>
            <ul className="text-sm text-emerald-900 space-y-1">
              <li>
                <span className="font-semibold">
                  Total usuarios en anÃ¡lisis:{" "}
                </span>
                {metrics.totalUsuariosPeriodo}
              </li>
              <li>
                <span className="font-semibold">Activos: </span>
                {metrics.totalActivos}
              </li>
              <li>
                <span className="font-semibold">Abandonados: </span>
                {metrics.totalAbandonados}
              </li>
              <li>
                <span className="font-semibold">Nuevos: </span>
                {metrics.totalNuevos}
              </li>
              <li>
                <span className="font-semibold">Tasa de retenciÃ³n: </span>
                {metrics.tasaRetencion.toFixed(1)}%
              </li>
              <li>
                <span className="font-semibold">Tasa de abandono: </span>
                {metrics.tasaAbandono.toFixed(1)}%
              </li>
            </ul>
          </div>
        </section>

        {/* Usuarios activos */}
        <section className="space-y-2 bg-white border border-emerald-200/40 rounded-xl shadow mb-6">
          <div className="px-4 py-3 border-b bg-emerald-50 rounded-t-xl">
            <h2 className="font-semibold text-emerald-900">
              Usuarios activos ({activos.length})
            </h2>
          </div>
          <div className="overflow-x-auto">
            <table className="min-w-full text-xs">
              <thead className="bg-slate-100">
                <tr>
                  <th className="px-2 py-1 text-left">Usuario</th>
                  <th className="px-2 py-1 text-left">Correo</th>
                  <th className="px-2 py-1 text-right">Primera actividad</th>
                  <th className="px-2 py-1 text-right">Ãšltima actividad</th>
                  <th className="px-2 py-1 text-right">Total acciones</th>
                </tr>
              </thead>
              <tbody>
                {activos.map((u, i) => (
                  <tr key={i} className="border-t">
                    <td className="px-2 py-1">{u.nombre}</td>
                    <td className="px-2 py-1">{u.correo}</td>
                    <td className="px-2 py-1 text-right">
                      {u.primera_actividad || "-"}
                    </td>
                    <td className="px-2 py-1 text-right">
                      {u.ultima_actividad || "-"}
                    </td>
                    <td className="px-2 py-1 text-right">
                      {u.total_acciones}
                    </td>
                  </tr>
                ))}
                {activos.length === 0 && (
                  <tr>
                    <td
                      className="px-2 py-2 text-center text-gray-400"
                      colSpan={5}
                    >
                      Sin datos en el rango.
                    </td>
                  </tr>
                )}
              </tbody>
            </table>
          </div>
        </section>

        {/* Usuarios abandonados */}
        <section className="space-y-2 bg-white border border-emerald-200/40 rounded-xl shadow mb-6">
          <div className="px-4 py-3 border-b bg-emerald-50 rounded-t-xl">
            <h2 className="font-semibold text-emerald-900">
              Usuarios abandonados ({abandonados.length})
            </h2>
          </div>
          <div className="overflow-x-auto">
            <table className="min-w-full text-xs">
              <thead className="bg-slate-100">
                <tr>
                  <th className="px-2 py-1 text-left">Usuario</th>
                  <th className="px-2 py-1 text-left">Correo</th>
                  <th className="px-2 py-1 text-right">Ãšltima actividad</th>
                </tr>
              </thead>
              <tbody>
                {abandonados.map((u, i) => (
                  <tr key={i} className="border-t">
                    <td className="px-2 py-1">{u.nombre}</td>
                    <td className="px-2 py-1">{u.correo}</td>
                    <td className="px-2 py-1 text-right">
                      {u.ultima_actividad || "-"}
                    </td>
                  </tr>
                ))}
                {abandonados.length === 0 && (
                  <tr>
                    <td
                      className="px-2 py-2 text-center text-gray-400"
                      colSpan={3}
                    >
                      Sin usuarios abandonados en el rango.
                    </td>
                  </tr>
                )}
              </tbody>
            </table>
          </div>
        </section>

        {/* Usuarios nuevos */}
        <section className="space-y-2 bg-white border border-emerald-200/40 rounded-xl shadow">
          <div className="px-4 py-3 border-b bg-emerald-50 rounded-t-xl">
            <h2 className="font-semibold text-emerald-900">
              Usuarios nuevos (primer login) ({nuevos.length})
            </h2>
          </div>
          <div className="overflow-x-auto">
            <table className="min-w-full text-xs">
              <thead className="bg-slate-100">
                <tr>
                  <th className="px-2 py-1 text-left">Usuario</th>
                  <th className="px-2 py-1 text-left">Correo</th>
                  <th className="px-2 py-1 text-right">Fecha primer login</th>
                </tr>
              </thead>
              <tbody>
                {nuevos.map((u, i) => (
                  <tr key={i} className="border-t">
                    <td className="px-2 py-1">{u.nombre}</td>
                    <td className="px-2 py-1">{u.correo}</td>
                    <td className="px-2 py-1 text-right">
                      {u.fecha_primer_login || "-"}
                    </td>
                  </tr>
                ))}
                {nuevos.length === 0 && (
                  <tr>
                    <td
                      className="px-2 py-2 text-center text-gray-400"
                      colSpan={3}
                    >
                      Sin usuarios nuevos en el rango.
                    </td>
                  </tr>
                )}
              </tbody>
            </table>
          </div>
        </section>
      </div>
    </div>
  );
}
</file>

<file path="frontend/src/pages/ReportesUsuariosPremium.jsx">
// src/pages/ReportesUsuariosPremium.jsx
import React, { useEffect, useMemo, useState } from "react";
import { getReporteUsuariosPremium } from "../services/api";
import {
  BarChart,
  Bar,
  XAxis,
  YAxis,
  Tooltip,
  ResponsiveContainer,
  Legend,
  LineChart,
  Line,
} from "recharts";
import hoja from "../assets/hoja.png";

function hoyISO() {
  return new Date().toISOString().slice(0, 10);
}

function hace30DiasISO() {
  const d = new Date(Date.now() - 30 * 24 * 60 * 60 * 1000);
  return d.toISOString().slice(0, 10);
}

export default function ReportesUsuariosPremium() {
  const [desde, setDesde] = useState(hace30DiasISO());
  const [hasta, setHasta] = useState(hoyISO());
  const [datos, setDatos] = useState([]);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState("");

  async function cargar() {
    try {
      setLoading(true);
      setError("");
      const res = await getReporteUsuariosPremium({ desde, hasta });
      setDatos(Array.isArray(res) ? res : []);
    } catch (e) {
      console.error(e);
      setError("Error cargando reporte de usuarios premium");
      setDatos([]);
    } finally {
      setLoading(false);
    }
  }

  useEffect(() => {
    cargar();
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, []);

  function handleSubmit(e) {
    e.preventDefault();
    cargar();
  }

  // =========================
  // MÃ‰TRICAS GLOBALES
  // =========================
  const metrics = useMemo(() => {
    if (!datos.length) {
      return {
        totalUsuariosActivos: 0,
        totalNuevosPremium: 0,
        totalPremiumActivos: 0,
        ingresosTotales: 0,
        adopcionPromedio: 0,
        periodos: 0,
      };
    }

    const totalUsuariosActivos = datos.reduce(
      (acc, r) => acc + Number(r.total_usuarios_activos || 0),
      0
    );
    const totalNuevosPremium = datos.reduce(
      (acc, r) => acc + Number(r.usuarios_nuevos_premium || 0),
      0
    );
    const totalPremiumActivos = datos.reduce(
      (acc, r) => acc + Number(r.usuarios_premium_activos || 0),
      0
    );
    const ingresosTotales = datos.reduce(
      (acc, r) => acc + Number(r.ingresos_suscripcion_bs || 0),
      0
    );

    const porcentajes = datos
      .map((r) => Number(r.porcentaje_adopcion_premium || 0))
      .filter((v) => !Number.isNaN(v));

    const adopcionPromedio =
      porcentajes.length > 0
        ? porcentajes.reduce((a, b) => a + b, 0) / porcentajes.length
        : 0;

    return {
      totalUsuariosActivos,
      totalNuevosPremium,
      totalPremiumActivos,
      ingresosTotales,
      adopcionPromedio,
      periodos: datos.length,
    };
  }, [datos]);

  // =========================
  // DATOS PARA GRÃFICOS
  // =========================
  const chartPorPeriodo = useMemo(
    () =>
      datos.map((r, i) => ({
        label: r.desde && r.hasta ? `${r.desde} â†’ ${r.hasta}` : `Periodo ${i + 1}`,
        usuariosActivos: Number(r.total_usuarios_activos || 0),
        nuevosPremium: Number(r.usuarios_nuevos_premium || 0),
        premiumActivos: Number(r.usuarios_premium_activos || 0),
        ingresos: Number(r.ingresos_suscripcion_bs || 0),
        adopcion: Number(r.porcentaje_adopcion_premium || 0),
      })),
    [datos]
  );

  return (
    <div
      className="min-h-screen p-8"
      style={{
        background: "linear-gradient(to bottom right, #f0fdf4, #d1fae5)",
        backgroundImage: `url(${hoja})`,
        backgroundRepeat: "no-repeat",
        backgroundPosition: "top right",
        backgroundSize: "160px",
      }}
    >
      <div className="max-w-6xl mx-auto space-y-8">
        {/* HEADER */}
        <header className="flex flex-col md:flex-row md:items-end md:justify-between gap-6">
          <div className="flex items-center gap-4">
            <div className="w-16 h-16 rounded-full bg-white shadow-md flex items-center justify-center border border-emerald-700/20">
              <img src={hoja} alt="Premium verde" className="w-10 h-10" />
            </div>
            <div>
              <h1 className="text-3xl font-extrabold text-emerald-800 drop-shadow">
                Usuarios premium
              </h1>
              <p className="text-sm text-emerald-700/80">
                AdopciÃ³n del plan premium e ingresos por suscripciÃ³n en el
                rango seleccionado.
              </p>
            </div>
          </div>

          <form
            onSubmit={handleSubmit}
            className="flex flex-wrap gap-4 items-end bg-white/70 px-4 py-3 rounded-xl shadow backdrop-blur text-sm"
          >
            <div className="flex flex-col">
              <label className="mb-1 font-semibold text-emerald-900">
                Desde
              </label>
              <input
                type="date"
                value={desde}
                onChange={(e) => setDesde(e.target.value)}
                className="border rounded px-2 py-1 text-sm shadow-sm"
              />
            </div>
            <div className="flex flex-col">
              <label className="mb-1 font-semibold text-emerald-900">
                Hasta
              </label>
              <input
                type="date"
                value={hasta}
                onChange={(e) => setHasta(e.target.value)}
                className="border rounded px-2 py-1 text-sm shadow-sm"
              />
            </div>
            <button
              type="submit"
              className="bg-emerald-700 hover:bg-emerald-800 text-white px-4 py-2 rounded-lg font-semibold shadow-md"
            >
              {loading ? "Cargandoâ€¦" : "Actualizar"}
            </button>
          </form>
        </header>

        {error && (
          <div className="bg-red-100 border border-red-300 text-red-700 text-sm px-4 py-2 rounded-lg shadow-sm">
            {error}
          </div>
        )}

        {/* KPIs */}
        <section className="grid md:grid-cols-4 gap-6">
          <div className="bg-white shadow-md border border-emerald-200/40 rounded-xl p-4">
            <p className="text-xs font-semibold text-emerald-700 uppercase">
              Premium activos
            </p>
            <p className="mt-2 text-3xl font-extrabold text-emerald-900">
              {metrics.totalPremiumActivos.toLocaleString()}
            </p>
            <p className="text-[11px] text-emerald-700/80 mt-1">
              Suma de usuarios premium activos en los periodos.
            </p>
          </div>

          <div className="bg-white shadow-md border border-teal-200/60 rounded-xl p-4">
            <p className="text-xs font-semibold text-teal-700 uppercase">
              Nuevos premium
            </p>
            <p className="mt-2 text-3xl font-extrabold text-teal-900">
              {metrics.totalNuevosPremium.toLocaleString()}
            </p>
            <p className="text-[11px] text-teal-700/80 mt-1">
              Nuevas altas de premium en el periodo.
            </p>
          </div>

          <div className="bg-white shadow-md border border-blue-200/60 rounded-xl p-4">
            <p className="text-xs font-semibold text-blue-700 uppercase">
              Ingresos por suscripciÃ³n (Bs)
            </p>
            <p className="mt-2 text-3xl font-extrabold text-blue-900">
              {metrics.ingresosTotales.toLocaleString(undefined, {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2,
              })}
            </p>
          </div>

          <div className="bg-white shadow-md border border-emerald-200/60 rounded-xl p-4">
            <p className="text-xs font-semibold text-emerald-700 uppercase">
              AdopciÃ³n promedio premium
            </p>
            <p className="mt-2 text-3xl font-extrabold text-emerald-900">
              {metrics.adopcionPromedio.toFixed(1)}%
            </p>
            <p className="text-[11px] text-emerald-700/80 mt-1">
              Promedio de % adopciÃ³n en los periodos.
            </p>
          </div>
        </section>

        {/* GRÃFICO INGRESOS + ADOPCIÃ“N */}
        <section className="grid lg:grid-cols-2 gap-6">
          <div className="bg-white rounded-xl border border-emerald-200/40 shadow p-4">
            <h2 className="text-lg font-semibold text-emerald-900 mb-2">
              Ingresos por suscripciones premium
            </h2>
            <p className="text-xs text-emerald-700/80 mb-3">
              EvoluciÃ³n de los ingresos por periodo en el rango seleccionado.
            </p>

            <div className="h-72">
              {chartPorPeriodo.length > 0 ? (
                <ResponsiveContainer>
                  <BarChart data={chartPorPeriodo}>
                    <XAxis dataKey="label" hide />
                    <YAxis />
                    <Tooltip />
                    <Bar
                      dataKey="ingresos"
                      name="Ingresos (Bs)"
                      fill="#1e3a8a"
                      radius={[8, 8, 0, 0]}
                    />
                  </BarChart>
                </ResponsiveContainer>
              ) : (
                <div className="h-full flex items-center justify-center text-xs text-gray-400">
                  Sin datos para mostrar el grÃ¡fico.
                </div>
              )}
            </div>
          </div>

          <div className="bg-white rounded-xl border border-emerald-200/40 shadow p-4">
            <h2 className="text-lg font-semibold text-emerald-900 mb-2">
              AdopciÃ³n premium vs usuarios activos
            </h2>
            <p className="text-xs text-emerald-700/80 mb-3">
              RelaciÃ³n entre usuarios activos y porcentaje de adopciÃ³n premium.
            </p>

            <div className="h-72">
              {chartPorPeriodo.length > 0 ? (
                <ResponsiveContainer>
                  <LineChart data={chartPorPeriodo}>
                    <XAxis dataKey="label" hide />
                    <YAxis yAxisId="left" />
                    <YAxis
                      yAxisId="right"
                      orientation="right"
                      tickFormatter={(v) => `${v}%`}
                    />
                    <Tooltip />
                    <Legend />
                    <Bar
                      yAxisId="left"
                      dataKey="usuariosActivos"
                      name="Usuarios activos"
                      fill="#047857"
                      radius={[8, 8, 0, 0]}
                    />
                    <Line
                      yAxisId="right"
                      type="monotone"
                      dataKey="adopcion"
                      name="% adopciÃ³n premium"
                      stroke="#f59e0b"
                      strokeWidth={2}
                      dot={false}
                    />
                  </LineChart>
                </ResponsiveContainer>
              ) : (
                <div className="h-full flex items-center justify-center text-xs text-gray-400">
                  Sin datos para mostrar el grÃ¡fico.
                </div>
              )}
            </div>
          </div>
        </section>

        {/* TABLA DETALLADA */}
        <section className="bg-white border border-emerald-200/40 rounded-xl shadow">
          <div className="px-4 py-3 border-b bg-emerald-50 rounded-t-xl">
            <h2 className="font-semibold text-emerald-900">
              Detalle de adopciÃ³n premium por periodo
            </h2>
          </div>

          <div className="overflow-x-auto">
            <table className="min-w-full text-sm">
              <thead className="bg-slate-100">
                <tr>
                  <th className="px-2 py-1 text-left">Desde</th>
                  <th className="px-2 py-1 text-left">Hasta</th>
                  <th className="px-2 py-1 text-right">Usuarios activos</th>
                  <th className="px-2 py-1 text-right">Nuevos premium</th>
                  <th className="px-2 py-1 text-right">Premium activos</th>
                  <th className="px-2 py-1 text-right">Ingresos (Bs)</th>
                  <th className="px-2 py-1 text-right">% adopciÃ³n</th>
                </tr>
              </thead>
              <tbody>
                {datos.map((r, i) => (
                  <tr key={i} className="border-t">
                    <td className="px-2 py-1">{r.desde}</td>
                    <td className="px-2 py-1">{r.hasta}</td>
                    <td className="px-2 py-1 text-right">
                      {r.total_usuarios_activos}
                    </td>
                    <td className="px-2 py-1 text-right">
                      {r.usuarios_nuevos_premium}
                    </td>
                    <td className="px-2 py-1 text-right">
                      {r.usuarios_premium_activos}
                    </td>
                    <td className="px-2 py-1 text-right">
                      {r.ingresos_suscripcion_bs}
                    </td>
                    <td className="px-2 py-1 text-right">
                      {r.porcentaje_adopcion_premium}%
                    </td>
                  </tr>
                ))}
                {datos.length === 0 && (
                  <tr>
                    <td
                      className="px-2 py-2 text-center text-gray-400"
                      colSpan={7}
                    >
                      Sin datos de suscripciones premium en el rango.
                    </td>
                  </tr>
                )}
              </tbody>
            </table>
          </div>
        </section>
      </div>
    </div>
  );
}
</file>

<file path="frontend/src/pages/Wallet.jsx">
import React, { useEffect, useState } from "react";
import { useNavigate } from "react-router-dom";
import { api } from "../services/api";
import hoja from "../assets/hoja.png";

export default function Wallet() {
  const [saldo, setSaldo] = useState(0);
  const [bloqueado, setBloqueado] = useState(0);
  const [movimientos, setMovimientos] = useState([]);
  const [cargando, setCargando] = useState(true);
  const [error, setError] = useState("");
  const navigate = useNavigate();

  useEffect(() => {
    cargarDatos();
  }, []);

  async function cargarDatos() {
    try {
      setCargando(true);
      setError("");

      const [resCreditos, resMovs] = await Promise.all([
        api("/wallet/mis-creditos"),
        api("/wallet/mis-movimientos"),
      ]);

      const saldoDisponible =
        resCreditos?.saldo_creditos ??
        resCreditos?.saldo ??
        resCreditos?.creditos ??
        0;

      const saldoBloqueado =
        resCreditos?.saldo_bloqueado ??
        resCreditos?.bloqueado ??
        0;

      setSaldo(saldoDisponible);
      setBloqueado(saldoBloqueado);

      setMovimientos(
        Array.isArray(resMovs) ? resMovs.slice(0, 10) : []
      );
    } catch (err) {
      console.error("Error cargando billetera:", err);
      setError(err.message || "Error al cargar la informaciÃ³n de la billetera.");
    } finally {
      setCargando(false);
    }
  }

  if (cargando) {
    return (
      <div className="min-h-screen bg-[#082b1f] text-white flex items-center justify-center">
        Cargando billeterat.
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-[#082b1f] text-white p-6 md:p-10">
      {/* HEADER */}
      <div className="flex items-center gap-3 mb-8">
        <img src={hoja} alt="logo" className="w-10 h-10 drop-shadow-lg" />
        <h1 className="text-3xl font-bold text-emerald-400">Mi Billetera</h1>
      </div>

      {/* ERROR */}
      {error && (
        <div className="mb-4 rounded-md border border-red-400 bg-red-900/40 px-4 py-2 text-sm text-red-100">
          {error}
        </div>
      )}

      {/* TARJETAS RESUMEN */}
      <div className="grid gap-6 md:grid-cols-3 mb-10">
        {/* CrÃ©ditos disponibles */}
        <div className="rounded-2xl border border-emerald-700 bg-[#0f3f2d] p-6 shadow-lg">
          <p className="text-emerald-200 text-sm mb-2">CrÃ©ditos disponibles</p>
          <p className="text-4xl font-bold text-emerald-300">{saldo}</p>
        </div>

        {/* CrÃ©ditos bloqueados */}
        <div className="rounded-2xl border border-emerald-700 bg-[#0f3f2d] p-6 shadow-lg">
          <p className="text-emerald-200 text-sm mb-2">CrÃ©ditos bloqueados</p>
          <p className="text-4xl font-bold text-yellow-300">{bloqueado}</p>
        </div>

        {/* Acciones rÃ¡pidas */}
        <div className="rounded-2xl border border-emerald-700 bg-[#0f3f2d] p-6 shadow-lg flex flex-col justify-between">
          <div>
            <p className="text-emerald-200 text-sm mb-2">
              Acciones rÃ¡pidas
            </p>
            <p className="text-xs text-emerald-100/80 mb-3">
              Compra crÃ©ditos, revisa movimientos o historial de compras.
            </p>
          </div>
          <div className="flex flex-wrap gap-2 text-xs">
            <button
              className="bg-emerald-500 hover:bg-emerald-600 text-emerald-950 px-3 py-1.5 rounded-lg font-semibold"
              onClick={() => navigate("/wallet/compra-creditos")}
            >
              Comprar crÃ©ditos
            </button>
            <button
              className="bg-emerald-500 hover:bg-emerald-600 text-emerald-950 px-3 py-1.5 rounded-lg font-semibold"
              onClick={() => navigate("/wallet/movimientos")}
            >
              Ver movimientos
            </button>
            <button
              className="bg-emerald-500 hover:bg-emerald-600 text-emerald-950 px-3 py-1.5 rounded-lg font-semibold"
              onClick={() => navigate("/wallet/historial-compras")}
            >
              Historial de compras
            </button>
          </div>
        </div>
      </div>

      {/* LISTA MOVIMIENTOS RECIENTES */}
      <section className="bg-[#0f3f2d] rounded-2xl border border-emerald-700 p-6 shadow-lg">
        <div className="flex items-center justify-between mb  -4">
          <h2 className="text-lg font-semibold text-emerald-300">
            Movimientos recientes
          </h2>
          <button
            className="text-xs text-emerald-200 underline"
            onClick={() => navigate("/wallet/movimientos")}
          >
            Ver todos
          </button>
        </div>

        {movimientos.length === 0 ? (
          <p className="text-sm text-emerald-100/70 mt-2">
            AÃºn no tienes movimientos registrados.
          </p>
        ) : (
          <div className="mt-3 space-y-3 text-sm">
            {movimientos.map((m) => {
              const fecha =
                m.creado_en || m.fecha || m.fecha_movimiento || null;

              return (
                <div
                  key={m.id_movimiento}
                  className="flex items-center justify-between border-b border-emerald-800/70 pb-2 last:border-0"
                >
                  <div>
                    <p className="font-semibold text-emerald-100">
                      {m.tipo_movimiento || "Movimiento"}
                      {m.tipo_referencia ? ` (${m.tipo_referencia})` : ""}
                    </p>
                    <p className="text-[11px] text-emerald-100/70">
                      {fecha ? new Date(fecha).toLocaleString() : ""}
                    </p>
                  </div>

                  <div className="text-right">
                    <p
                      className={`font-semibold ${
                        (m.cantidad ?? 0) >= 0
                          ? "text-emerald-300"
                          : "text-red-300"
                      }`}
                    >
                      {(m.cantidad ?? 0) >= 0 ? "+" : ""}
                      {m.cantidad ?? m.creditos ?? 0} cr.
                    </p>
                    <p className="text-[11px] text-emerald-100/60 mt-1">
                      Saldo:{" "}
                      {m.saldo_posterior ??
                        m.saldo ??
                        "-"}{" "}
                      cr.
                    </p>
                  </div>
                </div>
              );
            })}
          </div>
        )}
      </section>
    </div>
  );
}
</file>

<file path="frontend/src/router.jsx">
// frontend/src/router.jsx
import React from "react";
import { Routes, Route, Navigate } from "react-router-dom";
import ProtectedRoute from "./components/ProtectedRoute.jsx";
import Layout from "./components/Layout.jsx";

// PÃ¡ginas base
import Login from "./pages/Login.jsx";
import Register from "./pages/Register.jsx";
import Home from "./pages/Home.jsx";
import NotFound from "./pages/NotFound.jsx";

// Perfil
import Perfil from "./pages/Perfil.jsx";
import EditarPerfil from "./pages/EditarPerfil.jsx";

// Wallet
import ComprarCreditos from "./pages/ComprarCreditos.jsx";
import Movimientos from "./pages/Movimientos.jsx";
import HistorialCompras from "./pages/HistorialCompras.jsx";
import Wallet from "./pages/Wallet.jsx";

// Publicaciones
import Publicaciones from "./pages/Publicaciones.jsx";
import MisPublicaciones from "./pages/MisPublicaciones.jsx";
import PublicacionNueva from "./pages/PublicacionNueva.jsx";

// Intercambios
import Intercambios from "./pages/Intercambios.jsx";

// Actividades
import Actividades from "./pages/Actividades.jsx";
import MisActividades from "./pages/MisActividades.jsx";

// Premium / otros mÃ³dulos
import Premium from "./pages/Premium.jsx";
import Logros from "./pages/Logros.jsx";
import Promociones from "./pages/Promociones.jsx";

// Publicidad
import Publicidad from "./pages/Publicidad.jsx";

// Reportes menÃº principal
import Reportes from "./pages/Reportes.jsx";

// Reportes individuales
import ReportesUsuarios from "./pages/ReportesUsuarios.jsx";
import ReportesIngresosCreditos from "./pages/ReportesIngresosCreditos.jsx";
import ReportesCreditosGeneradosConsumidos from "./pages/ReportesCreditosGeneradosConsumidos.jsx";
import ReportesIntercambiosCategoria from "./pages/ReportesIntercambiosCategoria.jsx";
import ReportesPublicacionesVsIntercambios from "./pages/ReportesPublicacionesVsIntercambios.jsx";
import ReportesImpactoAcumulado from "./pages/ReportesImpactoAcumulado.jsx";
import ReportesRankingUsuarios from "./pages/ReportesRankingUsuarios.jsx";
import ReportesUsuariosPremium from "./pages/ReportesUsuariosPremium.jsx";
import ReportesSaldosUsuarios from "./pages/ReportesSaldosUsuarios.jsx";
import ReportesActividadesSostenibles from "./pages/ReportesActividadesSostenibles.jsx";
import ReportesImpactoCategoria from "./pages/ReportesImpactoCategoria.jsx";

// Backend lab
import BackendLab from "./pages/BackendLab.jsx";

export default function AppRouter() {
  return (
    <Routes>
      {/* Redirige raÃ­z a login */}
      <Route path="/" element={<Navigate to="/login" replace />} />

      {/* RUTAS PÃšBLICAS */}
      <Route path="/login" element={<Login />} />
      <Route path="/register" element={<Register />} />

      {/* ------------------------------- */}
      {/*         RUTAS PROTEGIDAS        */}
      {/* ------------------------------- */}

      {/* HOME */}
      <Route
        path="/home"
        element={
          <ProtectedRoute>
            <Layout>
              <Home />
            </Layout>
          </ProtectedRoute>
        }
      />

      {/* PERFIL */}
      <Route
        path="/perfil"
        element={
          <ProtectedRoute>
            <Layout>
              <Perfil />
            </Layout>
          </ProtectedRoute>
        }
      />

      {/* EDITAR PERFIL */}
      <Route
        path="/perfil/editar"
        element={
          <ProtectedRoute>
            <Layout>
              <EditarPerfil />
            </Layout>
          </ProtectedRoute>
        }
      />

      {/* WALLET - RESUMEN */}
      <Route
        path="/wallet"
        element={
          <ProtectedRoute>
            <Layout>
              <Wallet />
            </Layout>
          </ProtectedRoute>
        }
      />

      {/* COMPRAR CRÃ‰DITOS (ruta principal) */}
      <Route
        path="/comprar-creditos"
        element={
          <ProtectedRoute>
            <Layout>
              <ComprarCreditos />
            </Layout>
          </ProtectedRoute>
        }
      />

      {/* Alias para evitar 404 en /wallet/compra-creditos */}
      <Route
        path="/wallet/compra-creditos"
        element={
          <ProtectedRoute>
            <Layout>
              <ComprarCreditos />
            </Layout>
          </ProtectedRoute>
        }
      />

      {/* MOVIMIENTOS WALLET */}
      <Route
        path="/wallet/movimientos"
        element={
          <ProtectedRoute>
            <Layout>
              <Movimientos />
            </Layout>
          </ProtectedRoute>
        }
      />

      {/* HISTORIAL COMPRAS WALLET */}
      // Historial de compras (ruta â€œcortaâ€)
      <Route
        path="/wallet/compras"
        element={
          <ProtectedRoute>
            <Layout>
              <HistorialCompras />
            </Layout>
          </ProtectedRoute>
        }
      />

      // Alias: /wallet/historial-compras
      <Route
        path="/wallet/historial-compras"
        element={
          <ProtectedRoute>
            <Layout>
              <HistorialCompras />
            </Layout>
          </ProtectedRoute>
        }
      />

      {/* PUBLICACIONES */}
      <Route
        path="/publicaciones"
        element={
          <ProtectedRoute>
            <Layout>
              <Publicaciones />
            </Layout>
          </ProtectedRoute>
        }
      />

      <Route
        path="/publicaciones/mias"
        element={
          <ProtectedRoute>
            <Layout>
              <MisPublicaciones />
            </Layout>
          </ProtectedRoute>
        }
      />

      <Route
        path="/publicaciones/nueva"
        element={
          <ProtectedRoute>
            <Layout>
              <PublicacionNueva />
            </Layout>
          </ProtectedRoute>
        }
      />

      {/* INTERCAMBIOS */}
      <Route
        path="/intercambios"
        element={
          <ProtectedRoute>
            <Layout>
              <Intercambios />
            </Layout>
          </ProtectedRoute>
        }
      />

      {/* ACTIVIDADES */}
      <Route
        path="/actividades"
        element={
          <ProtectedRoute>
            <Layout>
              <Actividades />
            </Layout>
          </ProtectedRoute>
        }
      />

      <Route
        path="/actividades/mias"
        element={
          <ProtectedRoute>
            <Layout>
              <MisActividades />
            </Layout>
          </ProtectedRoute>
        }
      />
      

      {/* PREMIUM / LOGROS / PROMOCIONES */}
      <Route
        path="/premium"
        element={
          <ProtectedRoute>
            <Layout>
              <Premium />
            </Layout>
          </ProtectedRoute>
        }
      />

      <Route
        path="/logros"
        element={
          <ProtectedRoute>
            <Layout>
              <Logros />
            </Layout>
          </ProtectedRoute>
        }
      />

      <Route
        path="/promociones"
        element={
          <ProtectedRoute>
            <Layout>
              <Promociones />
            </Layout>
          </ProtectedRoute>
        }
      />

      {/* PUBLICIDAD */}
      <Route
        path="/publicidad"
        element={
          <ProtectedRoute>
            <Layout>
              <Publicidad />
            </Layout>
          </ProtectedRoute>
        }
      />

      {/* REPORTES MENÃš PRINCIPAL */}
      <Route
        path="/reportes"
        element={
          <ProtectedRoute>
            <Layout>
              <Reportes />
            </Layout>
          </ProtectedRoute>
        }
      />

      {/* REPORTES INDIVIDUALES */}
      <Route
        path="/reportes/usuarios"
        element={
          <ProtectedRoute>
            <Layout>
              <ReportesUsuarios />
            </Layout>
          </ProtectedRoute>
        }
      />

      <Route
        path="/reportes/ingresos-creditos"
        element={
          <ProtectedRoute>
            <Layout>
              <ReportesIngresosCreditos />
            </Layout>
          </ProtectedRoute>
        }
      />

      <Route
        path="/reportes/creditos-generados-consumidos"
        element={
          <ProtectedRoute>
            <Layout>
              <ReportesCreditosGeneradosConsumidos />
            </Layout>
          </ProtectedRoute>
        }
      />

      <Route
        path="/reportes/intercambios-categoria"
        element={
          <ProtectedRoute>
            <Layout>
              <ReportesIntercambiosCategoria />
            </Layout>
          </ProtectedRoute>
        }
      />

      <Route
        path="/reportes/publicaciones-intercambios"
        element={
          <ProtectedRoute>
            <Layout>
              <ReportesPublicacionesVsIntercambios />
            </Layout>
          </ProtectedRoute>
        }
      />

      <Route
        path="/reportes/impacto-acumulado"
        element={
          <ProtectedRoute>
            <Layout>
              <ReportesImpactoAcumulado />
            </Layout>
          </ProtectedRoute>
        }
      />

      <Route
        path="/reportes/ranking-usuarios"
        element={
          <ProtectedRoute>
            <Layout>
              <ReportesRankingUsuarios />
            </Layout>
          </ProtectedRoute>
        }
      />

      <Route
        path="/reportes/usuarios-premium"
        element={
          <ProtectedRoute>
            <Layout>
              <ReportesUsuariosPremium />
            </Layout>
          </ProtectedRoute>
        }
      />

      <Route
        path="/reportes/saldos-usuarios"
        element={
          <ProtectedRoute>
            <Layout>
              <ReportesSaldosUsuarios />
            </Layout>
          </ProtectedRoute>
        }
      />

      <Route
        path="/reportes/actividades-sostenibles"
        element={
          <ProtectedRoute>
            <Layout>
              <ReportesActividadesSostenibles />
            </Layout>
          </ProtectedRoute>
        }
      />

      <Route
        path="/reportes/impacto-categoria"
        element={
          <ProtectedRoute>
            <Layout>
              <ReportesImpactoCategoria />
            </Layout>
          </ProtectedRoute>
        }
      />

      {/* LABORATORIO BACKEND */}
      <Route
        path="/backend-lab"
        element={
          <ProtectedRoute>
            <Layout>
              <BackendLab />
            </Layout>
          </ProtectedRoute>
        }
      />

      {/* 404 */}
      <Route path="*" element={<NotFound />} />
    </Routes>
  );
}
</file>

<file path="frontend/src/services/api.js">
// ================== CONFIGURACIÃ“N BASE ==================

const API_URL = import.meta.env.VITE_API_URL ?? "http://localhost:4000/api";
const API_BASE_URL = API_URL.replace(/\/api\/?$/, "");

function authHeaders() {
  const token = localStorage.getItem("token");
  if (!token) return {};
  return {
    Authorization: `Bearer ${token}`,
  };
}

export async function api(path, { method = "GET", body, headers = {} } = {}) {
  const isJsonBody = body && !(body instanceof FormData);

  const res = await fetch(`${API_URL}${path}`, {
    method,
    headers: {
      ...(isJsonBody ? { "Content-Type": "application/json" } : {}),
      ...authHeaders(),
      ...headers,
    },
    body: isJsonBody ? JSON.stringify(body) : body,
  });

  const text = await res.text();

  if (!res.ok) {
    let message =
      res.statusText || `Error HTTP ${res.status}` || "Error en la solicitud";

    if (text) {
      try {
        const parsed = JSON.parse(text);
        if (parsed && parsed.message) {
          message = parsed.message;
        }
      } catch {
        message = text;
      }
    }

    throw new Error(message);
  }

  if (!text) return null;

  try {
    return JSON.parse(text);
  } catch {
    console.warn("Respuesta no JSON para", path, "=>", text);
    return text;
  }
}

// ================== AUTENTICACIÃ“N ==================

export async function login({ correo, password }) {
  const data = await api("/auth/login", {
    method: "POST",
    body: { correo, password },
  });

  if (data?.token) {
    localStorage.setItem("token", data.token);
    if (data.usuario) {
      localStorage.setItem("usuario", JSON.stringify(data.usuario));
    }
  }

  return data;
}

export function logout() {
  localStorage.removeItem("token");
  localStorage.removeItem("usuario");
}

export async function getHealth() {
  return api("/health");
}

export async function register({ nombre, apellido, correo, password, telefono }) {
  return api("/auth/register", {
    method: "POST",
    body: { nombre, apellido, correo, password, telefono },
  });
}

// =====================================================
// ======================= REPORTES =====================
// =====================================================

function buildRangeQuery(desde, hasta) {
  const params = new URLSearchParams();
  if (desde) params.append("desde", desde);
  if (hasta) params.append("hasta", hasta);
  const qs = params.toString();
  return qs ? `?${qs}` : "";
}

// Usuarios activos
export function getReporteUsuariosActivos({ desde, hasta } = {}) {
  return api(`/reportes/usuarios-activos${buildRangeQuery(desde, hasta)}`);
}

// Usuarios abandonados
export function getReporteUsuariosAbandonados({ desde, hasta } = {}) {
  return api(`/reportes/usuarios-abandonados${buildRangeQuery(desde, hasta)}`);
}

// Ingresos por crÃ©ditos
export function getReporteIngresosCreditos({ desde, hasta } = {}) {
  return api(`/reportes/ingresos-creditos${buildRangeQuery(desde, hasta)}`);
}

// CrÃ©ditos generados vs consumidos
export function getReporteCreditosGeneradosVsConsumidos({ desde, hasta } = {}) {
  return api(
    `/reportes/creditos-generados-consumidos${buildRangeQuery(desde, hasta)}`
  );
}

// Intercambios por categorÃ­a
export function getReporteIntercambiosCategoria({ desde, hasta } = {}) {
  return api(
    `/reportes/intercambios-categoria${buildRangeQuery(desde, hasta)}`
  );
}

// Publicaciones vs intercambios
export function getReportePublicacionesVsIntercambios({ desde, hasta } = {}) {
  return api(
    `/reportes/publicaciones-vs-intercambios${buildRangeQuery(desde, hasta)}`
  );
}

// Impacto acumulado
export function getReporteImpactoAcumulado({ idTipoReporte, idPeriodo }) {
  const params = new URLSearchParams();
  if (idTipoReporte != null) params.append("idTipoReporte", idTipoReporte);
  if (idPeriodo != null) params.append("idPeriodo", idPeriodo);
  const qs = params.toString();
  return api(`/reportes/impacto-acumulado?${qs}`);
}

// Ranking de usuarios
export function getReporteRankingUsuarios({ idPeriodo = null, limit = 10 } = {}) {
  const params = new URLSearchParams();
  if (idPeriodo != null && idPeriodo !== "") params.append("idPeriodo", idPeriodo);
  params.append("limit", String(limit));
  return api(`/reportes/ranking-usuarios?${params.toString()}`);
}

// Usuarios premium
export function getReporteUsuariosPremium({ desde, hasta } = {}) {
  return api(`/reportes/usuarios-premium${buildRangeQuery(desde, hasta)}`);
}

// Usuarios nuevos
export function getReporteUsuariosNuevos({ desde, hasta } = {}) {
  return api(`/reportes/usuarios-nuevos${buildRangeQuery(desde, hasta)}`);
}

// Saldos de crÃ©ditos
export function getReporteSaldosUsuarios({ limit = 20 } = {}) {
  const params = new URLSearchParams();
  params.append("limit", String(limit));
  return api(`/reportes/saldos-usuarios?${params.toString()}`);
}

// Reporte Actividades Sostenibles
export function getReporteActividadesSostenibles({ desde, hasta } = {}) {
  return api(`/reportes/actividades-sostenibles${buildRangeQuery(desde, hasta)}`);
}

// Impacto por categorÃ­a
export function getReporteImpactoPorCategoria({ idPeriodo }) {
  const params = new URLSearchParams();
  if (idPeriodo != null) params.append("idPeriodo", idPeriodo);
  return api(`/reportes/impacto-categoria?${params.toString()}`);
}

// =====================================================
// ======================== WALLET ======================
// =====================================================

export function getMisCreditos() {
  return api("/wallet/mis-creditos");
}

export function getMisMovimientos() {
  return api("/wallet/mis-movimientos");
}

export function getPaquetesCreditos() {
  return api("/catalogos/paquetes-creditos");
}

export function crearCompraCreditos({ idPaquete, idTransaccionPago = null }) {
  return api("/wallet/compra-creditos", {
    method: "POST",
    body: { idPaquete, idTransaccionPago },
  });
}

export function getMisComprasCreditos() {
  return api("/wallet/compras");
}

// =====================================================
// ===================== INTERCAMBIOS ===================
// =====================================================

export function crearIntercambio({ id_publicacion, creditos }) {
  return api("/intercambios", {
    method: "POST",
    body: { id_publicacion, creditos },
  });
}

export function getMisComprasIntercambios() {
  return api("/intercambios/mis-compras");
}

export function getMisVentasIntercambios() {
  return api("/intercambios/mis-ventas");
}

export function getDetalleTransaccion(idTransaccion) {
  return api(`/intercambios/${idTransaccion}`);
}

// =====================================================
// ================= ACTIVIDADES SOSTENIBLES ============
// =====================================================

// â­ OpciÃ³n A aplicada: devolver SOLO la actividad
export async function registrarActividadSostenible({
  id_tipo_actividad,
  descripcion,
  creditos_otorgados,
  evidencia_url,
}) {
  const data = await api("/actividades-sostenibles", {
    method: "POST",
    body: {
      id_tipo_actividad,
      descripcion,
      creditos_otorgados,
      evidencia_url,
    },
  });

  return data.actividad; // devolvemos solo la fila registrada
}

export function getMisActividadesSostenibles() {
  return api("/actividades-sostenibles/mias");
}

export function aprobarActividad(idActividad) {
  return api(`/actividades-sostenibles/${idActividad}/aprobar`, {
    method: "PATCH",
  });
}

export function rechazarActividad(idActividad) {
  return api(`/actividades-sostenibles/${idActividad}/rechazar`, {
    method: "PATCH",
  });
}

// =====================================================
// ======================== LOGROS ======================
// =====================================================

export function getMisLogros() {
  return api("/logros/mios");
}

// =====================================================
// ===================== PROMOCIONES ====================
// =====================================================

export function getPromociones() {
  return api("/promociones");
}

export function crearPromocion(body) {
  return api("/promociones", {
    method: "POST",
    body,
  });
}

export function cambiarEstadoPromocion(id_promocion, estado) {
  return api(`/promociones/${id_promocion}/estado`, {
    method: "PATCH",
    body: { estado },
  });
}

export function vincularPublicacionPromocion(id_promocion, id_publicacion) {
  return api(`/promociones/${id_promocion}/publicaciones`, {
    method: "POST",
    body: { id_publicacion },
  });
}

// =====================================================
// ======================= PUBLICIDAD ===================
// =====================================================

export function getPublicidadActiva() {
  return api("/publicidad");
}

export function crearPublicidad(body) {
  return api("/publicidad", {
    method: "POST",
    body,
  });
}

// =====================================================
// ===================== UTILIDADES =====================
// =====================================================

export function buildUploadUrl(url) {
  if (!url) return "";

  if (/^https?:\/\//i.test(url)) return url;

  if (url.startsWith("/")) {
    return `${API_BASE_URL}${url}`;
  }

  return `${API_BASE_URL}/${url}`;
}
</file>

<file path="frontend/tailwind.config.js">
/** @type {import('tailwindcss').Config} */
module.exports = {
  content: [
    "./index.html",
    "./src/**/*.{js,jsx,ts,tsx}"
  ],
  theme: {
    extend: {}
  },
  plugins: []
};
</file>

<file path="frontend/vite.config.js">
import { defineConfig } from "vite";
import react from "@vitejs/plugin-react";

export default defineConfig({
  plugins: [react()],
  server: {
    port: 5173
  }
});
</file>

<file path="package.json">
{
  "name": "iu-db-monorepo",
  "private": true,
  "version": "0.1.0",
  "scripts": {
    "dev": "npm-run-all --parallel dev:front dev:back",
    "dev:front": "npm --prefix frontend run dev",
    "dev:back": "npm --prefix backend run dev",
    "build": "npm-run-all build:front build:back",
    "build:front": "npm --prefix frontend run build",
    "build:back": "npm --prefix backend run build",
    "db:migrate": "npm --prefix backend run prisma:migrate",
    "db:seed": "npm --prefix backend run prisma:seed"
  },
  "devDependencies": {
    "npm-run-all": "^4.1.5"
  }
}
</file>

<file path="README.md">
# Monorepo: UI + API + DB (React + Vite + Tailwind / Node + Express + Prisma / MySQL)

## Dev rÃ¡pido
```bash
# en la raÃ­z
npm install
npm run dev
```

## Requisitos
- Node 18+
- Docker (opcional para DB)

## Estructura
- `frontend/` React + Vite + Tailwind
- `backend/`  Node + Express + Prisma (MySQL)
- `infra/db/` SQL de init y seeds
</file>

</files>
