This file is a merged representation of the entire codebase, combined into a single document by Repomix.

<file_summary>
This section contains a summary of this file.

<purpose>
This file contains a packed representation of the entire repository's contents.
It is designed to be easily consumable by AI systems for analysis, code review,
or other automated processes.
</purpose>

<file_format>
The content is organized as follows:
1. This summary section
2. Repository information
3. Directory structure
4. Repository files (if enabled)
5. Multiple file entries, each consisting of:
  - File path as an attribute
  - Full contents of the file
</file_format>

<usage_guidelines>
- This file should be treated as read-only. Any changes should be made to the
  original repository files, not this packed version.
- When processing this file, use the file path to distinguish
  between different files in the repository.
- Be aware that this file may contain sensitive information. Handle it with
  the same level of security as you would the original repository.
</usage_guidelines>

<notes>
- Some files may have been excluded based on .gitignore rules and Repomix's configuration
- Binary files are not included in this packed representation. Please refer to the Repository Structure section for a complete list of file paths, including binary files
- Files matching patterns in .gitignore are excluded
- Files matching default ignore patterns are excluded
- Files are sorted by Git change count (files with more changes are at the bottom)
</notes>

</file_summary>

<directory_structure>
.gitignore
backend/Dockerfile
backend/package.json
backend/prisma/schema.prisma
backend/prisma/seed.js
backend/src/app.js
backend/src/config/env.js
backend/src/config/prisma.js
backend/src/middlewares/auth.js
backend/src/middlewares/errorHandler.js
backend/src/middlewares/isAdmin.js
backend/src/modules/actividades/actividades.controller.js
backend/src/modules/actividades/actividades.routes.js
backend/src/modules/actividades/actividades.service.js
backend/src/modules/auth/auth.controller.js
backend/src/modules/auth/auth.routes.js
backend/src/modules/auth/auth.service.js
backend/src/modules/catalogos/catalogos.controller.js
backend/src/modules/catalogos/catalogos.routes.js
backend/src/modules/catalogos/catalogos.service.js
backend/src/modules/intercambios/intercambios.controller.js
backend/src/modules/intercambios/intercambios.routes.js
backend/src/modules/intercambios/intercambios.service.js
backend/src/modules/logros/logros.controller.js
backend/src/modules/logros/logros.routes.js
backend/src/modules/logros/logros.service.js
backend/src/modules/notificaciones/notificaciones.controller.js
backend/src/modules/notificaciones/notificaciones.routes.js
backend/src/modules/notificaciones/notificaciones.service.js
backend/src/modules/premium/premium.controller.js
backend/src/modules/premium/premium.routes.js
backend/src/modules/premium/premium.service.js
backend/src/modules/promociones/promociones.controller.js
backend/src/modules/promociones/promociones.routes.js
backend/src/modules/promociones/promociones.service.js
backend/src/modules/publicaciones/publicaciones.controller.js
backend/src/modules/publicaciones/publicaciones.routes.js
backend/src/modules/publicaciones/publicaciones.service.js
backend/src/modules/publicidad/publicidad.controller.js
backend/src/modules/publicidad/publicidad.routes.js
backend/src/modules/publicidad/publicidad.service.js
backend/src/modules/reportes/reportes.controller.js
backend/src/modules/reportes/reportes.routes.js
backend/src/modules/reportes/reportes.service.js
backend/src/modules/uploads/multer.js
backend/src/modules/uploads/uploads.controller.js
backend/src/modules/uploads/uploads.routes.js
backend/src/modules/uploads/uploads.service.js
backend/src/modules/usuarios/usuarios.controller.js
backend/src/modules/usuarios/usuarios.routes.js
backend/src/modules/usuarios/usuarios.service.js
backend/src/modules/wallet/wallet.controller.js
backend/src/modules/wallet/wallet.routes.js
backend/src/modules/wallet/wallet.service.js
backend/src/routes/index.js
backend/src/server.js
backend/uploads_storage/cb6b319f-881d-4f8a-8a5e-9f8eecd10402.png
backend/utils/jsonBigInt.js
docker-compose.yml
frontend/index.html
frontend/package.json
frontend/postcss.config.js
frontend/src/App.jsx
frontend/src/assets/aurela.png
frontend/src/assets/aurella.png
frontend/src/assets/hoja.png
frontend/src/assets/publicit.png
frontend/src/assets/TomCruise.png
frontend/src/components/Layout.jsx
frontend/src/components/Navbar.jsx
frontend/src/components/ProtectedRoute.jsx
frontend/src/index.css
frontend/src/main.jsx
frontend/src/pages/BackendLab.jsx
frontend/src/pages/Home.jsx
frontend/src/pages/Login.jsx
frontend/src/pages/NotFound.jsx
frontend/src/pages/Register.jsx
frontend/src/pages/Reportes.jsx
frontend/src/pages/ReportesActividadesSostenibles.jsx
frontend/src/pages/ReportesCreditosGeneradosConsumidos.jsx
frontend/src/pages/ReportesDashboard.jsx
frontend/src/pages/ReportesImpactoAcumulado.jsx
frontend/src/pages/ReportesImpactoCategoria.jsx
frontend/src/pages/ReportesIngresosCreditos.jsx
frontend/src/pages/ReportesIntercambiosCategoria.jsx
frontend/src/pages/ReportesPublicacionesVsIntercambios.jsx
frontend/src/pages/ReportesRankingUsuarios.jsx
frontend/src/pages/ReportesSaldosUsuarios.jsx
frontend/src/pages/ReportesUsuarios.jsx
frontend/src/pages/ReportesUsuariosPremium.jsx
frontend/src/router.jsx
frontend/src/services/api.js
frontend/tailwind.config.js
frontend/vite.config.js
package.json
README.md
</directory_structure>

<files>
This section contains the contents of the repository's files.

<file path=".gitignore">
node_modules
dist
.env
.env.*
.prisma
.DS_Store
</file>

<file path="backend/Dockerfile">
# simple dev image; optional
FROM node:18-alpine
WORKDIR /app
COPY package*.json ./
RUN npm install
COPY . .
EXPOSE 4000
CMD ["npm","run","start"]
</file>

<file path="backend/package.json">
{
  "name": "backend",
  "private": true,
  "version": "0.1.0",
  "type": "module",
  "scripts": {
    "dev": "node --watch src/server.js",
    "start": "node src/server.js",
    "prisma:generate": "prisma generate",
    "prisma:migrate": "prisma migrate dev --name init",
    "prisma:deploy": "prisma migrate deploy",
    "prisma:seed": "node prisma/seed.js",
    "studio": "prisma studio"
  },
  "dependencies": {
    "@prisma/client": "^6.19.0",
    "bcryptjs": "^2.4.3",
    "cors": "^2.8.5",
    "dotenv": "^16.4.5",
    "express": "^4.21.1",
    "helmet": "^7.1.0",
    "jsonwebtoken": "^9.0.2",
    "morgan": "^1.10.1",
    "multer": "^2.0.2",
    "uuid": "^13.0.0"
  },
  "devDependencies": {
    "prisma": "^6.19.0"
  }
}
</file>

<file path="backend/prisma/schema.prisma">
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model actividad_sostenible {
  id_actividad       Int      @id @default(autoincrement())
  id_usuario         Int
  id_tipo_actividad  Int
  descripcion        String   @db.Text
  creditos_otorgados Int
  evidencia_url      String?  @db.VarChar(500)
  creado_en          DateTime @default(now()) @db.DateTime(0)

  @@index([id_tipo_actividad], map: "fk_act_tipo")
  @@index([id_usuario], map: "fk_act_usuario")
  @@index([creado_en], map: "ix_actsost_creado_en")
}

model billetera {
  id_billetera    Int               @id @default(autoincrement())
  id_usuario      Int               @unique(map: "id_usuario")
  estado          billetera_estado? @default(ACTIVA)
  saldo_creditos  BigInt?           @default(0)
  saldo_bs        Decimal?          @default(0.00) @db.Decimal(12, 2)
  cuenta_bancaria String?           @db.VarChar(100)
}

model bitacora_acceso {
  id_acceso    Int      @id @default(autoincrement())
  id_usuario   Int
  fecha        DateTime @default(now()) @db.DateTime(0)
  direccion_ip String   @db.VarChar(45)
  user_agent   String?  @db.VarChar(500)
  id_resultado Int

  @@index([id_resultado], map: "fk_bitacc_resultado")
  @@index([id_usuario, fecha], map: "ix_bitacceso_usuario_fecha")
}

model bitacora_intercambio {
  id_bitacora        Int     @id @default(autoincrement())
  id_transaccion     Int
  id_usuario_origen  Int
  id_usuario_destino Int
  cantidad_creditos  BigInt
  descripcion        String? @db.VarChar(500)

  @@index([id_usuario_destino], map: "fk_bi_usr_destino")
  @@index([id_usuario_origen], map: "fk_bi_usr_origen")
  @@index([id_transaccion], map: "ix_bitacora_trx")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model calificacion {
  id_calificacion Int     @id @default(autoincrement())
  id_usuario      Int
  id_publicacion  Int
  estrellas       Int     @db.TinyInt
  comentario      String? @db.VarChar(300)

  @@unique([id_usuario, id_publicacion], map: "id_usuario")
  @@index([id_publicacion], map: "fk_calif_publicacion")
}

model categoria {
  id_categoria Int     @id @default(autoincrement())
  nombre       String  @unique(map: "nombre") @db.VarChar(100)
  descripcion  String? @db.VarChar(255)
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model compra_creditos {
  id_compra           Int                     @id @default(autoincrement())
  id_usuario          Int
  id_paquete          Int
  monto_bs            Decimal                 @db.Decimal(12, 2)
  estado              compra_creditos_estado? @default(PENDIENTE)
  id_transaccion_pago String?                 @unique(map: "id_transaccion_pago") @db.VarChar(255)
  creado_en           DateTime                @default(now()) @db.DateTime(0)

  @@index([id_paquete], map: "fk_compra_paquete")
  @@index([id_usuario], map: "fk_compra_usuario")
  @@index([estado], map: "ix_compra_estado")
  @@index([creado_en], map: "ix_compra_creado_en")
}

model dimension_ambiental {
  id_dimension Int     @id @default(autoincrement())
  codigo       String  @unique(map: "codigo") @db.VarChar(30)
  nombre       String  @db.VarChar(100)
  unidad_base  String? @db.VarChar(20)
  descripcion  String? @db.VarChar(255)
}

model equivalencia_impacto {
  id_equivalencia    Int     @id @default(autoincrement())
  id_categoria       Int
  id_um              Int?
  co2_por_unidad     Decimal @db.Decimal(12, 6)
  agua_por_unidad    Decimal @db.Decimal(12, 6)
  energia_por_unidad Decimal @db.Decimal(12, 6)

  @@unique([id_categoria, id_um], map: "id_categoria")
  @@index([id_um], map: "fk_eq_um")
}

model evento_ambiental {
  id_evento              Int                     @id @default(autoincrement())
  id_usuario             Int
  id_dimension           Int
  fuente                 evento_ambiental_fuente
  id_fuente              Int
  categoria              String?                 @db.VarChar(100)
  valor                  Decimal                 @db.Decimal(18, 6)
  id_um                  Int?
  contaminacion_reducida Decimal?                @db.Decimal(18, 6)
  descripcion            String?                 @db.VarChar(255)

  @@index([id_dimension], map: "fk_ev_dimension")
  @@index([id_um], map: "fk_ev_um")
  @@index([id_usuario], map: "fk_ev_usuario")
}

model impacto_ambiental {
  id_impacto       Int     @id @default(autoincrement())
  id_usuario       Int
  id_transaccion   Int
  id_categoria     Int
  co2_ahorrado     Decimal @db.Decimal(12, 6)
  agua_ahorrada    Decimal @db.Decimal(12, 6)
  energia_ahorrada Decimal @db.Decimal(12, 6)
  id_periodo       Int

  @@index([id_transaccion], map: "fk_imp_tx")
  @@index([id_categoria], map: "ix_impa_categoria")
  @@index([id_periodo], map: "ix_impa_periodo")
  @@index([id_usuario, id_periodo], map: "ix_impa_usuario_periodo")
}

model logro {
  id_logro            Int     @id @default(autoincrement())
  id_tipo_logro       Int
  nombre              String  @db.VarChar(100)
  descripcion         String? @db.VarChar(255)
  meta_requerida      BigInt
  creditos_recompensa BigInt

  @@index([id_tipo_logro], map: "fk_logro_tipo")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model movimiento_creditos {
  id_movimiento      Int      @id @default(autoincrement())
  id_usuario         Int
  id_tipo_movimiento Int
  id_tipo_referencia Int
  cantidad           BigInt
  descripcion        String?  @db.VarChar(255)
  saldo_anterior     BigInt
  saldo_posterior    BigInt
  id_referencia      Int?
  creado_en          DateTime @default(now()) @db.DateTime(0)

  @@index([id_tipo_movimiento], map: "fk_mov_tipomov")
  @@index([id_movimiento], map: "ix_mov_creado")
  @@index([id_tipo_referencia], map: "ix_mov_tiporef")
  @@index([id_usuario, id_movimiento], map: "ix_mov_usuario")
  @@index([creado_en], map: "ix_mov_creado_en")
}

model paquete_creditos {
  id_paquete        Int     @id @default(autoincrement())
  nombre            String  @unique(map: "nombre") @db.VarChar(100)
  cantidad_creditos BigInt
  precio_bs         Decimal @db.Decimal(12, 2)
  activo            Boolean @default(true)
}

model periodo {
  id_periodo   Int       @id @default(autoincrement())
  nombre       String    @unique(map: "nombre") @db.VarChar(50)
  descripcion  String?   @db.VarChar(255)
  fecha_inicio DateTime? @db.Date
  fecha_fin    DateTime? @db.Date

  @@index([fecha_inicio, fecha_fin], map: "ix_periodo_rango")
}

model permiso {
  id_permiso  Int     @id @default(autoincrement())
  nombre      String  @unique(map: "nombre") @db.VarChar(100)
  descripcion String? @db.VarChar(255)
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model producto {
  id_producto  Int      @id @default(autoincrement())
  id_categoria Int
  nombre       String   @db.VarChar(255)
  descripcion  String?  @db.VarChar(255)
  precio       Decimal? @db.Decimal(12, 2)
  peso         Decimal? @db.Decimal(10, 2)

  @@index([id_categoria], map: "fk_producto_categoria")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model promocion {
  id_promocion       Int               @id @default(autoincrement())
  id_tipo_promocion  Int
  nombre             String            @db.VarChar(100)
  descripcion        String?           @db.VarChar(255)
  creditos_otorgados BigInt
  fecha_inicio       DateTime          @db.DateTime(0)
  fecha_fin          DateTime          @db.DateTime(0)
  estado             promocion_estado? @default(PROGRAMADA)

  @@index([id_tipo_promocion], map: "fk_promocion_tipo")
  @@index([estado, fecha_inicio, fecha_fin], map: "ix_promocion_activa")
}

model promocion_publicacion {
  id_promocion   Int
  id_publicacion Int

  @@id([id_promocion, id_publicacion])
  @@index([id_promocion], map: "ix_promopub_prom")
  @@index([id_publicacion], map: "ix_promopub_pub")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model publicacion {
  id_publicacion      Int                 @id @default(autoincrement())
  id_usuario          Int
  id_categoria        Int
  id_tipo_publicacion Int
  estado              publicacion_estado? @default(PUBLICADA)
  id_ubicacion        Int?
  titulo              String              @db.VarChar(200)
  descripcion         String              @db.Text
  valor_creditos      BigInt
  imagen_url          String?             @db.VarChar(500)
  creado_en           DateTime            @default(now()) @db.DateTime(0)

  @@index([id_tipo_publicacion], map: "fk_publicacion_tipopub")
  @@index([id_ubicacion], map: "fk_publicacion_ubicacion")
  @@index([id_categoria, estado], map: "ix_pub_categoria_estado")
  @@index([id_usuario, estado], map: "ix_pub_usuario_estado")
  @@index([creado_en], map: "ix_pub_creado_en")
  @@fulltext([titulo, descripcion], map: "ft_pub_titulo_desc")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model publicacion_producto {
  id_publicacion Int
  id_producto    Int
  cantidad       Decimal @db.Decimal(15, 4)
  id_um          Int

  @@id([id_publicacion, id_producto])
  @@index([id_producto], map: "fk_pprd_producto")
  @@index([id_um], map: "fk_pprd_um")
}

model publicacion_servicio {
  id_publicacion Int
  id_servicio    Int
  horario        String @db.VarChar(100)

  @@id([id_publicacion, id_servicio])
  @@index([id_servicio], map: "fk_pserv_servicio")
}

model publicidad {
  id_publicidad  Int                @id @default(autoincrement())
  id_usuario     Int
  id_ubicacion   Int
  estado         publicidad_estado? @default(PROGRAMADA)
  titulo         String             @db.VarChar(200)
  descripcion    String?            @db.VarChar(255)
  url_destino    String?            @db.VarChar(500)
  fecha_inicio   DateTime           @db.DateTime(0)
  fecha_fin      DateTime           @db.DateTime(0)
  costo_creditos BigInt

  @@index([id_ubicacion], map: "fk_publicidad_ubipub")
  @@index([id_usuario], map: "fk_publicidad_usuario")
}

model reporte_impacto {
  id_reporte             Int     @id @default(autoincrement())
  id_usuario             Int?
  id_tipo_reporte        Int
  id_periodo             Int
  total_co2_ahorrado     Decimal @db.Decimal(12, 6)
  total_agua_ahorrada    Decimal @db.Decimal(12, 6)
  total_energia_ahorrada Decimal @db.Decimal(12, 6)
  total_transacciones    BigInt
  total_usuarios_activos BigInt

  @@index([id_periodo], map: "fk_rep_periodo")
  @@index([id_usuario], map: "fk_rep_usuario")
  @@index([id_tipo_reporte, id_periodo, id_usuario], map: "ix_rep_unico_helper")
}

model resultado_acceso {
  id_resultado Int     @id @default(autoincrement())
  nombre       String  @unique(map: "nombre") @db.VarChar(50)
  descripcion  String? @db.VarChar(255)
}

model rol {
  id_rol      Int     @id @default(autoincrement())
  nombre      String  @unique(map: "nombre") @db.VarChar(50)
  descripcion String? @db.VarChar(255)
}

model rol_permiso {
  id_rol     Int
  id_permiso Int

  @@id([id_rol, id_permiso])
  @@index([id_permiso], map: "fk_rp_permiso")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model servicio {
  id_servicio  Int              @id @default(autoincrement())
  id_categoria Int
  estado       servicio_estado? @default(ACTIVO)
  nombre       String           @db.VarChar(255)
  descripcion  String?          @db.Text
  precio       Decimal?         @db.Decimal(12, 2)
  duracion_min Int?             @db.SmallInt

  @@index([id_categoria], map: "fk_servicio_categoria")
}

model signo_movimiento {
  id_signo Int    @id @default(autoincrement())
  nombre   String @unique(map: "nombre") @db.VarChar(20)
}

model signo_tipo_mov {
  id_tipo_movimiento Int
  id_signo           Int
  creado_en          DateTime? @db.DateTime(0)

  @@id([id_tipo_movimiento, id_signo])
  @@index([id_signo], map: "ix_sxtm_signo")
}

model tipo_actividad {
  id_tipo_actividad Int     @id @default(autoincrement())
  nombre            String  @unique(map: "nombre") @db.VarChar(100)
  descripcion       String? @db.VarChar(255)
}

model tipo_logro {
  id_tipo_logro Int     @id @default(autoincrement())
  nombre        String  @unique(map: "nombre") @db.VarChar(50)
  descripcion   String? @db.VarChar(255)
}

model tipo_movimiento {
  id_tipo_movimiento Int     @id @default(autoincrement())
  nombre             String  @unique(map: "nombre") @db.VarChar(50)
  descripcion        String? @db.VarChar(255)

  @@index([nombre], map: "ix_tipomov_nombre")
}

model tipo_promocion {
  id_tipo_promocion Int     @id @default(autoincrement())
  nombre            String  @unique(map: "nombre") @db.VarChar(50)
  descripcion       String? @db.VarChar(255)
}

model tipo_publicacion {
  id_tipo_publicacion Int     @id @default(autoincrement())
  nombre              String  @unique(map: "nombre") @db.VarChar(50)
  descripcion         String? @db.VarChar(255)
}

model tipo_referencia {
  id_tipo_referencia Int    @id @default(autoincrement())
  nombre             String @unique(map: "nombre") @db.VarChar(30)

  @@index([nombre], map: "ix_tiporef_nombre")
}

model tipo_reporte {
  id_tipo_reporte Int     @id @default(autoincrement())
  nombre          String  @unique(map: "nombre") @db.VarChar(50)
  descripcion     String? @db.VarChar(255)
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model transaccion {
  id_transaccion    Int                 @id @default(autoincrement())
  id_comprador      Int
  id_vendedor       Int
  id_publicacion    Int
  cantidad_creditos BigInt
  estado            transaccion_estado? @default(SOLICITADA)
  creado_en         DateTime            @default(now()) @db.DateTime(0)

  @@index([estado], map: "ix_trans_estado")
  @@index([id_comprador], map: "ix_tx_comprador")
  @@index([id_publicacion], map: "ix_tx_publicacion")
  @@index([id_vendedor], map: "ix_tx_vendedor")
  @@index([creado_en], map: "ix_tx_creado_en")
}

model ubicacion {
  id_ubicacion Int      @id @default(autoincrement())
  direccion    String   @db.VarChar(500)
  ciudad       String?  @db.VarChar(100)
  provincia    String?  @db.VarChar(100)
  latitud      Decimal? @db.Decimal(9, 6)
  longitud     Decimal? @db.Decimal(9, 6)
}

model ubicacion_publicidad {
  id_ubicacion Int     @id @default(autoincrement())
  nombre       String  @unique(map: "nombre") @db.VarChar(100)
  descripcion  String? @db.VarChar(255)
  precio_base  Decimal @db.Decimal(12, 2)
}

model unidad_medida {
  id_um   Int    @id @default(autoincrement())
  nombre  String @unique(map: "nombre") @db.VarChar(100)
  simbolo String @unique(map: "simbolo") @db.VarChar(20)
}

model usuario {
  id_usuario    Int            @id @default(autoincrement())
  id_rol        Int
  estado        usuario_estado @default(ACTIVO)
  nombre        String         @db.VarChar(100)
  apellido      String?        @db.VarChar(100)
  correo        String         @unique(map: "correo") @db.VarChar(255)
  password_hash String         @default("") @db.VarChar(255)
  telefono      String?        @db.VarChar(25)
  url_perfil    String?        @unique(map: "url_perfil") @db.VarChar(120)

  @@index([id_rol], map: "fk_usuario_rol")
}

model usuario_logro {
  id_usuario_logro Int     @id @default(autoincrement())
  id_usuario       Int
  id_logro         Int
  progreso_actual  BigInt? @default(0)

  @@unique([id_usuario, id_logro], map: "id_usuario")
  @@index([id_logro], map: "fk_ulogro_logro")
}

model suscripcion_premium {
  id_suscripcion Int                        @id @default(autoincrement())
  id_usuario     Int
  fecha_inicio   DateTime                   @default(now()) @db.DateTime(0)
  fecha_fin      DateTime?                  @db.DateTime(0)
  estado         suscripcion_premium_estado @default(ACTIVA)
  monto_bs       Decimal                    @db.Decimal(12, 2)

  @@index([fecha_inicio, fecha_fin], map: "ix_suscrip_fechas")
  @@index([id_usuario, estado], map: "ix_suscrip_usuario_estado")
}

enum billetera_estado {
  ACTIVA
  BLOQUEADA
  CERRADA
}

enum servicio_estado {
  ACTIVO
  PAUSADO
  INACTIVO
  ELIMINADO
}

enum usuario_estado {
  ACTIVO
  SUSPENDIDO
  BLOQUEADO
  ELIMINADO
}

enum evento_ambiental_fuente {
  PUBLICACION
  TRANSACCION
}

enum publicidad_estado {
  PROGRAMADA
  ACTIVA
  PAUSADA
  FINALIZADA
  CANCELADA
}

enum compra_creditos_estado {
  PENDIENTE
  APROBADO
  RECHAZADO
  FALLIDO
  REVERTIDO
}

enum publicacion_estado {
  BORRADOR
  PUBLICADA
  PAUSADA
  AGOTADA
  OCULTA
  ELIMINADA
}

enum transaccion_estado {
  SOLICITADA
  ACEPTADA
  RECHAZADA
  CANCELADA
  COMPLETADA
  ANULADA
}

enum promocion_estado {
  PROGRAMADA
  ACTIVA
  PAUSADA
  FINALIZADA
  CANCELADA
}

enum suscripcion_premium_estado {
  ACTIVA
  CANCELADA
  VENCIDA
}
</file>

<file path="backend/prisma/seed.js">
import { PrismaClient } from '@prisma/client'
import bcrypt from 'bcryptjs'
const prisma = new PrismaClient()

async function main() {
  const [adminRole, userRole] = await Promise.all([
    prisma.role.upsert({ where: { name: 'ADMIN' }, update: {}, create: { name: 'ADMIN' } }),
    prisma.role.upsert({ where: { name: 'USER' }, update: {}, create: { name: 'USER' } }),
  ])

  const passwordHash = await bcrypt.hash('demo123', 10)
  const admin = await prisma.user.upsert({
    where: { email: 'demo@demo.com' },
    update: {},
    create: { email: 'demo@demo.com', name: 'Admin Demo', passwordHash, roleId: adminRole.id }
  })

  await prisma.wallet.upsert({
    where: { userId: admin.id },
    update: {},
    create: { userId: admin.id, credits: 1000 }
  })

  console.log('Seed listo:', { admin: admin.email })
}

main().catch(e=>{console.error(e); process.exit(1)}).finally(()=>prisma.$disconnect())
</file>

<file path="backend/src/app.js">
// src/app.js

// üîß Parche global para que JSON.stringify soporte BigInt en todas las respuestas
if (typeof BigInt !== "undefined" && !BigInt.prototype.toJSON) {
  // eslint-disable-next-line no-extend-native
  BigInt.prototype.toJSON = function () {
    return Number(this);
  };
}

import express from "express";
import cors from "cors";
import morgan from "morgan";
import routes from "./routes/index.js";
import { errorHandler } from "./middlewares/errorHandler.js";

import path from "path";
import { fileURLToPath } from "url";

const app = express();

// -------------------------------------------------------------
// Necesario para rutas absolutas (uploads y archivos est√°ticos)
// -------------------------------------------------------------
const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

// -------------------------------------------------------------
// Middlewares globales
// -------------------------------------------------------------
app.use(cors());                // permitir peticiones de tu frontend
app.use(morgan("dev"));         // logs en consola
app.use(express.json());        // permite JSON en body
app.use(express.urlencoded({ extended: true })); // formularios

// -------------------------------------------------------------
// Servir archivos est√°ticos (subidas de im√°genes)
// Ruta final: http://localhost:4000/uploads/<nombre-archivo>
// -------------------------------------------------------------
app.use(
  "/uploads",
  express.static(path.join(__dirname, "..", "uploads_storage"))
);

// -------------------------------------------------------------
// Registrar todas las rutas del backend
// -------------------------------------------------------------
app.use("/api", routes);

// -------------------------------------------------------------
// Middleware para rutas no encontradas
// -------------------------------------------------------------
app.use((req, res, next) => {
  res.status(404).json({ message: "Ruta no encontrada" });
});

// -------------------------------------------------------------
// Middleware global de manejo de errores
// (Siempre debe ir al final)
// -------------------------------------------------------------
app.use(errorHandler);

export default app;
</file>

<file path="backend/src/config/env.js">
// src/config/env.js
import 'dotenv/config'

export const env = {
  NODE_ENV: process.env.NODE_ENV ?? 'development',
  PORT: Number(process.env.PORT ?? 4000),
  DATABASE_URL: process.env.DATABASE_URL,
}
</file>

<file path="backend/src/config/prisma.js">
// src/config/prisma.js
import { PrismaClient } from '@prisma/client'

export const prisma = new PrismaClient({
    log: ['query', 'error', 'warn'],
})
</file>

<file path="backend/src/middlewares/auth.js">
// src/middlewares/auth.js
import jwt from "jsonwebtoken";

// Middleware principal: requiere token v√°lido
export function authMiddleware(req, res, next) {
  const authHeader = req.headers.authorization;

  // Esperamos "Authorization: Bearer <token>"
  if (!authHeader || !authHeader.startsWith("Bearer ")) {
    return res.status(401).json({ message: "Token de autenticaci√≥n faltante" });
  }

  const token = authHeader.split(" ")[1];

  try {
    const payload = jwt.verify(token, process.env.JWT_SECRET);
    // En el payload nosotros pusimos: id_usuario, correo, rol
    req.user = payload;
    next();
  } catch (err) {
    return res
      .status(401)
      .json({ message: "Token inv√°lido o expirado" });
  }
}

// Versi√≥n opcional: si hay token lo lee, si no, deja pasar
export function optionalAuth(req, _res, next) {
  const authHeader = req.headers.authorization;
  if (!authHeader || !authHeader.startsWith("Bearer ")) {
    return next();
  }

  const token = authHeader.split(" ")[1];

  try {
    const payload = jwt.verify(token, process.env.JWT_SECRET);
    req.user = payload;
  } catch {
    // si falla, simplemente no ponemos req.user
  }
  next();
}
</file>

<file path="backend/src/middlewares/errorHandler.js">
// src/middlewares/errorHandler.js

// Middleware de manejo global de errores (SIEMPRE 4 par√°metros)
export function errorHandler(err, req, res, next) {
  console.error("‚ùå Error:", err);

  // Si ya se empez√≥ a enviar la respuesta, delega a Express
  if (res.headersSent) {
    return next(err);
  }

  const status = err.status || err.statusCode || 500;
  const message =
    err.message || "Ocurri√≥ un error inesperado en el servidor";

  const response = { message };

  // En desarrollo podemos enviar m√°s detalles
  if (process.env.NODE_ENV !== "production") {
    response.stack = err.stack;
    if (err.code) response.code = err.code;
  }

  res.status(status).json(response);
}
</file>

<file path="backend/src/middlewares/isAdmin.js">
// src/middlewares/isAdmin.js

// Middleware simple: solo ADMIN
export function isAdmin(req, res, next) {
  if (!req.user) {
    return res.status(401).json({ message: "No autenticado" });
  }

  if (req.user.rol !== "ADMIN") {
    return res.status(403).json({ message: "Acceso solo para administradores" });
  }

  next();
}

// Middleware m√°s general: aceptar varios roles
export function hasRole(...rolesPermitidos) {
  return (req, res, next) => {
    if (!req.user) {
      return res.status(401).json({ message: "No autenticado" });
    }

    if (!rolesPermitidos.includes(req.user.rol)) {
      return res.status(403).json({ message: "No tienes permisos suficientes" });
    }

    next();
  };
}
</file>

<file path="backend/src/modules/actividades/actividades.controller.js">
import {
  registrarActividadService,
  misActividadesService,
} from "./actividades.service.js";

export const registrarActividadController = async (req, res, next) => {
  try {
    const idUsuario = req.user.id_usuario;
    const { id_tipo_actividad, descripcion, creditos_otorgados, evidencia_url } = req.body;

    const result = await registrarActividadService({
      idUsuario,
      id_tipo_actividad,
      descripcion,
      creditos_otorgados,
      evidencia_url,
    });

    res.status(201).json(result);
  } catch (e) { next(e); }
};

export const misActividadesController = async (req, res, next) => {
  try { res.json(await misActividadesService(req.user.id_usuario)); }
  catch (e) { next(e); }
};
</file>

<file path="backend/src/modules/actividades/actividades.routes.js">
import { Router } from "express";
import { authMiddleware } from "../../middlewares/auth.js";
import {
  registrarActividadController,
  misActividadesController,
} from "./actividades.controller.js";

const router = Router();

router.use(authMiddleware);

router.post("/", registrarActividadController);
router.get("/mias", misActividadesController);

export default router;
</file>

<file path="backend/src/modules/actividades/actividades.service.js">
import { prisma } from "../../config/prisma.js";

export async function registrarActividadService({
  idUsuario,
  id_tipo_actividad,
  descripcion,
  creditos_otorgados,
  evidencia_url,
}) {
  if (!id_tipo_actividad || !descripcion || !creditos_otorgados) {
    const err = new Error("id_tipo_actividad, descripcion y creditos_otorgados son obligatorios");
    err.status = 400;
    throw err;
  }

  await prisma.$executeRawUnsafe(
    "CALL sp_registrar_actividad_sostenible(?, ?, ?, ?, ?)",
    idUsuario,
    id_tipo_actividad,
    descripcion,
    creditos_otorgados,
    evidencia_url || null
  );

  // devolver ultima actividad del usuario
  const [act] = await prisma.$queryRaw`
    SELECT *
    FROM ACTIVIDAD_SOSTENIBLE
    WHERE id_usuario = ${idUsuario}
    ORDER BY creado_en DESC, id_actividad DESC
    LIMIT 1
  `;
  return act;
}

export async function misActividadesService(idUsuario) {
  return prisma.$queryRaw`
    SELECT * FROM ACTIVIDAD_SOSTENIBLE
    WHERE id_usuario = ${idUsuario}
    ORDER BY creado_en DESC
  `;
}
</file>

<file path="backend/src/modules/auth/auth.controller.js">
import {
  registrarUsuarioService,
  loginService,
  obtenerPerfilService,
} from "./auth.service.js";

export async function registerController(req, res, next) {
  try {
    const { nombre, apellido, correo, password, telefono } = req.body;

    if (!nombre || !correo || !password) {
      return res
        .status(400)
        .json({ message: "nombre, correo y password son obligatorios" });
    }

    const usuario = await registrarUsuarioService({
      nombre,
      apellido,
      correo,
      password,
      telefono,
    });

    res.status(201).json({
      message: "Usuario registrado correctamente",
      usuario,
    });
  } catch (err) {
    next(err);
  }
}

export async function loginController(req, res, next) {
  try {
    const { correo, password } = req.body;

    if (!correo || !password) {
      return res
        .status(400)
        .json({ message: "correo y password son obligatorios" });
    }

    const result = await loginService({
      correo,
      password,
      ip: req.ip,
      userAgent: req.headers["user-agent"] || "",
    });

    res.json(result); // { token, usuario }
  } catch (err) {
    next(err);
  }
}

export async function meController(req, res, next) {
  try {
    const idUsuario = req.user.id_usuario;
    const perfil = await obtenerPerfilService(idUsuario);
    res.json(perfil);
  } catch (err) {
    next(err);
  }
}
</file>

<file path="backend/src/modules/auth/auth.routes.js">
import { Router } from "express";
import {
    registerController,
    loginController,
    meController,
} from "./auth.controller.js";
import { authMiddleware } from "../../middlewares/auth.js";

const router = Router();

// Registro p√∫blico (rol COMPRADOR)
router.post("/register", registerController);

// Login
router.post("/login", loginController);

// Datos del usuario logueado
router.get("/me", authMiddleware, meController);

export default router;
</file>

<file path="backend/src/modules/auth/auth.service.js">
import bcrypt from "bcryptjs";
import jwt from "jsonwebtoken";
import { prisma } from "../../config/prisma.js";

// Helper: obtener id_rol por nombre
async function getRolId(nombreRol) {
  const rows = await prisma.$queryRaw`
    SELECT id_rol FROM ROL WHERE nombre = ${nombreRol} LIMIT 1
  `;
  if (!rows.length) {
    throw new Error(`No existe el rol ${nombreRol}`);
  }
  return rows[0].id_rol;
}

// Helper: obtener id_resultado de BITACORA_ACCESO (OK / FAIL)
async function getResultadoAccesoId(nombre) {
  const rows = await prisma.$queryRaw`
    SELECT id_resultado FROM RESULTADO_ACCESO WHERE nombre = ${nombre} LIMIT 1
  `;
  if (!rows.length) {
    throw new Error(`No existe RESULTADO_ACCESO '${nombre}'`);
  }
  return rows[0].id_resultado;
}

export async function registrarUsuarioService({
  nombre,
  apellido,
  correo,
  password,
  telefono,
}) {
  // ¬øCorreo ya existe?
  const existente = await prisma.$queryRaw`
    SELECT id_usuario FROM USUARIO WHERE correo = ${correo} LIMIT 1
  `;
  if (existente.length) {
    const error = new Error("El correo ya est√° registrado");
    error.status = 409;
    throw error;
  }

  const hash = await bcrypt.hash(password, 10);
  const idRolComprador = await getRolId("COMPRADOR");

  await prisma.$queryRaw`
    INSERT INTO USUARIO (id_rol, estado, nombre, apellido, correo, password_hash, telefono, url_perfil)
    VALUES (${idRolComprador}, 'ACTIVO', ${nombre}, ${apellido || null}, ${correo},
            ${hash}, ${telefono || null}, NULL)
  `;

  // Volver a leer el usuario insertado
  const usuarioRows = await prisma.$queryRaw`
    SELECT u.id_usuario, u.nombre, u.apellido, u.correo, u.telefono, r.nombre AS rol
    FROM USUARIO u
    JOIN ROL r ON r.id_rol = u.id_rol
    WHERE u.correo = ${correo}
    LIMIT 1
  `;

  return usuarioRows[0];
}

export async function loginService({ correo, password, ip, userAgent }) {
  const usuarios = await prisma.$queryRaw`
    SELECT u.id_usuario, u.password_hash, u.nombre, u.apellido, u.correo,
           u.estado, r.nombre AS rol
    FROM USUARIO u
    JOIN ROL r ON r.id_rol = u.id_rol
    WHERE u.correo = ${correo}
    LIMIT 1
  `;

  const user = usuarios[0];
  let resultadoNombre = "FAIL";

  if (!user) {
    const idFail = await getResultadoAccesoId(resultadoNombre);
    // Podr√≠as registrar intento fallido sin usuario si quisieras
    const error = new Error("Credenciales inv√°lidas");
    error.status = 401;
    throw error;
  }

  // ===== CAMBIO IMPORTANTE: compatibilidad con hashes bcrypt y texto plano =====
  let ok = false;

  try {
    // Si parece un hash bcrypt ($2a$, $2b$, $2y$...), usamos bcrypt.compare
    if (user.password_hash && user.password_hash.startsWith("$2")) {
      ok = await bcrypt.compare(password, user.password_hash);
    } else {
      // Si NO parece hash, asumimos que est√° en texto plano (ej: '123456')
      ok = password === user.password_hash;
    }
  } catch (e) {
    // Si bcrypt truena por hash inv√°lido, hacemos fallback a texto plano
    ok = password === user.password_hash;
  }

  if (!ok) {
    const idFail = await getResultadoAccesoId(resultadoNombre);
    await prisma.$queryRaw`
      INSERT INTO BITACORA_ACCESO (id_usuario, fecha, direccion_ip, user_agent, id_resultado)
      VALUES (${user.id_usuario}, NOW(), ${ip}, ${userAgent}, ${idFail})
    `;
    const error = new Error("Credenciales inv√°lidas");
    error.status = 401;
    throw error;
  }

  // Login correcto
  resultadoNombre = "OK";
  const idOk = await getResultadoAccesoId(resultadoNombre);
  await prisma.$queryRaw`
    INSERT INTO BITACORA_ACCESO (id_usuario, fecha, direccion_ip, user_agent, id_resultado)
    VALUES (${user.id_usuario}, NOW(), ${ip}, ${userAgent}, ${idOk})
  `;

  const payload = {
    id_usuario: user.id_usuario,
    correo: user.correo,
    rol: user.rol,
  };

  const token = jwt.sign(payload, process.env.JWT_SECRET, {
    expiresIn: "2h",
  });

  // No devolver hash
  delete user.password_hash;

  return {
    token,
    usuario: {
      id_usuario: user.id_usuario,
      nombre: user.nombre,
      apellido: user.apellido,
      correo: user.correo,
      rol: user.rol,
      estado: user.estado,
    },
  };
}

export async function obtenerPerfilService(idUsuario) {
  const rows = await prisma.$queryRaw`
    SELECT u.id_usuario, u.nombre, u.apellido, u.correo, u.telefono,
           u.estado, r.nombre AS rol
    FROM USUARIO u
    JOIN ROL r ON r.id_rol = u.id_rol
    WHERE u.id_usuario = ${idUsuario}
    LIMIT 1
  `;
  if (!rows.length) {
    const err = new Error("Usuario no encontrado");
    err.status = 404;
    throw err;
  }
  return rows[0];
}
</file>

<file path="backend/src/modules/catalogos/catalogos.controller.js">
import {
  listarCategorias,
  listarUnidadesMedida,
  listarPaquetesCreditos,
  listarTiposActividad,
  listarTiposPromocion,
  listarUbicacionesPublicidad,
  listarTiposLogro,
} from "./catalogos.service.js";

export const getCategorias = async (_req, res, next) => {
  try { res.json(await listarCategorias()); } catch (e) { next(e); }
};
export const getUnidadesMedida = async (_req, res, next) => {
  try { res.json(await listarUnidadesMedida()); } catch (e) { next(e); }
};
export const getPaquetesCreditos = async (_req, res, next) => {
  try { res.json(await listarPaquetesCreditos()); } catch (e) { next(e); }
};
export const getTiposActividad = async (_req, res, next) => {
  try { res.json(await listarTiposActividad()); } catch (e) { next(e); }
};
export const getTiposPromocion = async (_req, res, next) => {
  try { res.json(await listarTiposPromocion()); } catch (e) { next(e); }
};
export const getUbicacionesPublicidad = async (_req, res, next) => {
  try { res.json(await listarUbicacionesPublicidad()); } catch (e) { next(e); }
};
export const getTiposLogro = async (_req, res, next) => {
  try { res.json(await listarTiposLogro()); } catch (e) { next(e); }
};
</file>

<file path="backend/src/modules/catalogos/catalogos.routes.js">
import { Router } from "express";
import {
  getCategorias,
  getUnidadesMedida,
  getPaquetesCreditos,
  getTiposActividad,
  getTiposPromocion,
  getUbicacionesPublicidad,
  getTiposLogro,
} from "./catalogos.controller.js";

const router = Router();

router.get("/categorias", getCategorias);
router.get("/unidades-medida", getUnidadesMedida);
router.get("/paquetes-creditos", getPaquetesCreditos);
router.get("/tipos-actividad", getTiposActividad);
router.get("/tipos-promocion", getTiposPromocion);
router.get("/ubicaciones-publicidad", getUbicacionesPublicidad);
router.get("/tipos-logro", getTiposLogro);

export default router;
</file>

<file path="backend/src/modules/catalogos/catalogos.service.js">
import { prisma } from "../../config/prisma.js";

export const listarCategorias = () =>
  prisma.$queryRaw`SELECT * FROM CATEGORIA ORDER BY nombre`;

export const listarUnidadesMedida = () =>
  prisma.$queryRaw`SELECT * FROM UNIDAD_MEDIDA ORDER BY nombre`;

export const listarPaquetesCreditos = () =>
  prisma.$queryRaw`SELECT * FROM PAQUETE_CREDITOS WHERE activo = TRUE ORDER BY cantidad_creditos`;

export const listarTiposActividad = () =>
  prisma.$queryRaw`SELECT * FROM TIPO_ACTIVIDAD ORDER BY nombre`;

export const listarTiposPromocion = () =>
  prisma.$queryRaw`SELECT * FROM TIPO_PROMOCION ORDER BY nombre`;

export const listarUbicacionesPublicidad = () =>
  prisma.$queryRaw`SELECT * FROM UBICACION_PUBLICIDAD ORDER BY nombre`;

export const listarTiposLogro = () =>
  prisma.$queryRaw`SELECT * FROM TIPO_LOGRO ORDER BY nombre`;
</file>

<file path="backend/src/modules/intercambios/intercambios.controller.js">
import {
  crearIntercambioService,
  misComprasService,
  misVentasService,
  detalleTransaccionService,
} from "./intercambios.service.js";

export const crearIntercambioController = async (req, res, next) => {
  try {
    const idComprador = req.user.id_usuario;
    const { id_publicacion, creditos } = req.body;
    const tx = await crearIntercambioService({ idComprador, id_publicacion, creditos });
    res.status(201).json({ message: "Intercambio creado", transaccion: tx });
  } catch (e) { next(e); }
};

export const misComprasController = async (req, res, next) => {
  try { res.json(await misComprasService(req.user.id_usuario)); }
  catch (e) { next(e); }
};

export const misVentasController = async (req, res, next) => {
  try { res.json(await misVentasService(req.user.id_usuario)); }
  catch (e) { next(e); }
};

export const detalleTransaccionController = async (req, res, next) => {
  try { res.json(await detalleTransaccionService(+req.params.id)); }
  catch (e) { next(e); }
};
</file>

<file path="backend/src/modules/intercambios/intercambios.routes.js">
import { Router } from "express";
import { authMiddleware } from "../../middlewares/auth.js";
import {
  crearIntercambioController,
  misComprasController,
  misVentasController,
  detalleTransaccionController,
} from "./intercambios.controller.js";

const router = Router();

router.use(authMiddleware);

router.post("/", crearIntercambioController);
router.get("/mis-compras", misComprasController);
router.get("/mis-ventas", misVentasController);
router.get("/:id", detalleTransaccionController);

export default router;
</file>

<file path="backend/src/modules/intercambios/intercambios.service.js">
import { prisma } from "../../config/prisma.js";

export async function crearIntercambioService({ idComprador, id_publicacion, creditos }) {
  if (!id_publicacion || !creditos) {
    const err = new Error("id_publicacion y creditos son obligatorios");
    err.status = 400;
    throw err;
  }

  await prisma.$executeRawUnsafe(
    "CALL sp_realizar_intercambio(?, ?, ?)",
    idComprador,
    id_publicacion,
    creditos
  );

  // La √∫ltima transacci√≥n creada
  const [tx] = await prisma.$queryRaw`
    SELECT *
    FROM TRANSACCION
    WHERE id_comprador = ${idComprador}
    ORDER BY id_transaccion DESC
    LIMIT 1
  `;
  return tx;
}

export async function misComprasService(idUsuario) {
  return prisma.$queryRaw`
    SELECT t.*, p.titulo
    FROM TRANSACCION t
    JOIN PUBLICACION p ON p.id_publicacion = t.id_publicacion
    WHERE t.id_comprador = ${idUsuario}
    ORDER BY t.creado_en DESC
  `;
}

export async function misVentasService(idUsuario) {
  return prisma.$queryRaw`
    SELECT t.*, p.titulo
    FROM TRANSACCION t
    JOIN PUBLICACION p ON p.id_publicacion = t.id_publicacion
    WHERE t.id_vendedor = ${idUsuario}
    ORDER BY t.creado_en DESC
  `;
}

export async function detalleTransaccionService(idTransaccion) {
  const [row] = await prisma.$queryRaw`
    SELECT t.*, p.titulo, p.descripcion, p.valor_creditos
    FROM TRANSACCION t
    JOIN PUBLICACION p ON p.id_publicacion = t.id_publicacion
    WHERE t.id_transaccion = ${idTransaccion}
    LIMIT 1
  `;
  if (!row) {
    const err = new Error("Transacci√≥n no encontrada");
    err.status = 404;
    throw err;
  }
  return row;
}
</file>

<file path="backend/src/modules/logros/logros.controller.js">
import {
  misLogrosService,
  listarLogrosService,
} from "./logros.service.js";

export const misLogrosController = async (req, res, next) => {
  try { res.json(await misLogrosService(req.user.id_usuario)); }
  catch (e) { next(e); }
};

export const listarLogrosController = async (_req, res, next) => {
  try { res.json(await listarLogrosService()); }
  catch (e) { next(e); }
};
</file>

<file path="backend/src/modules/logros/logros.routes.js">
import { Router } from "express";
import { authMiddleware } from "../../middlewares/auth.js";
import { isAdmin } from "../../middlewares/isAdmin.js";
import {
  misLogrosController,
  listarLogrosController,
} from "./logros.controller.js";

const router = Router();

router.use(authMiddleware);

router.get("/mios", misLogrosController);

// s√≥lo admin ve cat√°logo completo
router.get("/", isAdmin, listarLogrosController);

export default router;
</file>

<file path="backend/src/modules/logros/logros.service.js">
import { prisma } from "../../config/prisma.js";

export const listarLogrosService = () =>
  prisma.$queryRaw`
    SELECT l.*, tl.nombre AS tipo_logro
    FROM LOGRO l
    JOIN TIPO_LOGRO tl ON tl.id_tipo_logro = l.id_tipo_logro
    ORDER BY l.id_logro
  `;

export const misLogrosService = (idUsuario) =>
  prisma.$queryRaw`
    SELECT ul.*, l.nombre, l.descripcion, l.meta_requerida, l.creditos_recompensa
    FROM USUARIO_LOGRO ul
    JOIN LOGRO l ON l.id_logro = ul.id_logro
    WHERE ul.id_usuario = ${idUsuario}
    ORDER BY l.id_logro
  `;
</file>

<file path="backend/src/modules/premium/premium.controller.js">
// premium.controller.js
import { miPlanPremiumService } from "./premium.service.js";

export const miPlanPremiumController = async (req, res, next) => {
  try { res.json(await miPlanPremiumService(req.user.id_usuario)); }
  catch (e) { next(e); }
};
</file>

<file path="backend/src/modules/premium/premium.routes.js">
// premium.routes.js
import { Router } from "express";
import { authMiddleware } from "../../middlewares/auth.js";
import {
  miPlanPremiumController,
} from "./premium.controller.js";

const router = Router();
router.use(authMiddleware);

router.get("/mi-plan", miPlanPremiumController);

export default router;
</file>

<file path="backend/src/modules/premium/premium.service.js">
// premium.service.js
import { prisma } from "../../config/prisma.js";

export const miPlanPremiumService = (idUsuario) =>
  prisma.$queryRaw`
    SELECT * FROM SUSCRIPCION_PREMIUM
    WHERE id_usuario = ${idUsuario}
    ORDER BY fecha_inicio DESC
    LIMIT 1
  `;
</file>

<file path="backend/src/modules/promociones/promociones.controller.js">
import {
  listarPromocionesService,
  crearPromocionService,
  actualizarEstadoPromocionService,
  vincularPublicacionService,
} from "./promociones.service.js";

export const listarPromocionesController = async (_req, res, next) => {
  try { res.json(await listarPromocionesService()); } catch (e) { next(e); }
};

export const crearPromocionController = async (req, res, next) => {
  try { res.status(201).json(await crearPromocionService(req.body)); }
  catch (e) { next(e); }
};

export const actualizarEstadoPromocionController = async (req, res, next) => {
  try {
    const id = +req.params.id;
    const { estado } = req.body;
    res.json(await actualizarEstadoPromocionService(id, estado));
  } catch (e) { next(e); }
};

export const vincularPublicacionController = async (req, res, next) => {
  try {
    const idPromocion = +req.params.id;
    const { id_publicacion } = req.body;
    await vincularPublicacionService(idPromocion, id_publicacion);
    res.status(201).json({ message: "Publicaci√≥n vinculada" });
  } catch (e) { next(e); }
};
</file>

<file path="backend/src/modules/promociones/promociones.routes.js">
import { Router } from "express";
import { authMiddleware } from "../../middlewares/auth.js";
import { isAdmin } from "../../middlewares/isAdmin.js";
import {
  listarPromocionesController,
  crearPromocionController,
  actualizarEstadoPromocionController,
  vincularPublicacionController,
} from "./promociones.controller.js";

const router = Router();

router.use(authMiddleware, isAdmin);

router.get("/", listarPromocionesController);
router.post("/", crearPromocionController);
router.patch("/:id/estado", actualizarEstadoPromocionController);
router.post("/:id/publicaciones", vincularPublicacionController);

export default router;
</file>

<file path="backend/src/modules/promociones/promociones.service.js">
import { prisma } from "../../config/prisma.js";

export const listarPromocionesService = () =>
  prisma.$queryRaw`
    SELECT * FROM PROMOCION
    ORDER BY fecha_inicio DESC
  `;

export async function crearPromocionService(body) {
  const {
    id_tipo_promocion,
    nombre,
    descripcion,
    creditos_otorgados,
    fecha_inicio,
    fecha_fin,
    estado = "ACTIVA",
  } = body;

  if (!id_tipo_promocion || !nombre || !creditos_otorgados || !fecha_inicio || !fecha_fin) {
    const err = new Error("Faltan datos obligatorios de promoci√≥n");
    err.status = 400;
    throw err;
  }

  await prisma.$queryRaw`
    INSERT INTO PROMOCION
      (id_tipo_promocion, nombre, descripcion, creditos_otorgados,
       fecha_inicio, fecha_fin, estado)
    VALUES
      (${id_tipo_promocion}, ${nombre}, ${descripcion || null}, ${creditos_otorgados},
       ${fecha_inicio}, ${fecha_fin}, ${estado})
  `;

  const [row] = await prisma.$queryRaw`
    SELECT * FROM PROMOCION
    WHERE id_promocion = LAST_INSERT_ID()
    LIMIT 1
  `;
  return row;
}

export async function actualizarEstadoPromocionService(idPromocion, estado) {
  await prisma.$queryRaw`
    UPDATE PROMOCION
    SET estado = ${estado}
    WHERE id_promocion = ${idPromocion}
  `;
  const [row] = await prisma.$queryRaw`
    SELECT * FROM PROMOCION
    WHERE id_promocion = ${idPromocion}
    LIMIT 1
  `;
  return row;
}

export async function vincularPublicacionService(idPromocion, idPublicacion) {
  if (!idPublicacion) {
    const err = new Error("id_publicacion es obligatorio");
    err.status = 400;
    throw err;
  }
  await prisma.$queryRaw`
    INSERT IGNORE INTO PROMOCION_PUBLICACION (id_promocion, id_publicacion)
    VALUES (${idPromocion}, ${idPublicacion})
  `;
}
</file>

<file path="backend/src/modules/publicaciones/publicaciones.controller.js">
import {
  listarPublicacionesService,
  obtenerPublicacionService,
  crearPublicacionProductoService,
  crearPublicacionServicioService,
  misPublicacionesService,
  buscarPublicacionesService,
  crearCalificacionService,
  listarCalificacionesService,
} from "./publicaciones.service.js";

export const listarPublicacionesController = async (req, res, next) => {
  try {
    const { categoria, estado } = req.query;
    res.json(await listarPublicacionesService({ categoria, estado }));
  } catch (e) { next(e); }
};

export const obtenerPublicacionController = async (req, res, next) => {
  try { res.json(await obtenerPublicacionService(+req.params.id)); }
  catch (e) { next(e); }
};

export const crearPublicacionProductoController = async (req, res, next) => {
  try {
    const idUsuario = req.user.id_usuario;
    const pub = await crearPublicacionProductoService(idUsuario, req.body);
    res.status(201).json(pub);
  } catch (e) { next(e); }
};

export const crearPublicacionServicioController = async (req, res, next) => {
  try {
    const idUsuario = req.user.id_usuario;
    const pub = await crearPublicacionServicioService(idUsuario, req.body);
    res.status(201).json(pub);
  } catch (e) { next(e); }
};

export const misPublicacionesController = async (req, res, next) => {
  try {
    const idUsuario = req.user.id_usuario;
    res.json(await misPublicacionesService(idUsuario));
  } catch (e) { next(e); }
};

export const buscarPublicacionesController = async (req, res, next) => {
  try { res.json(await buscarPublicacionesService(req.query.q || "")); }
  catch (e) { next(e); }
};

export const crearCalificacionController = async (req, res, next) => {
  try {
    const idUsuario = req.user.id_usuario;
    const idPublicacion = +req.params.id;
    const { estrellas, comentario } = req.body;
    const calif = await crearCalificacionService({
      idUsuario, idPublicacion, estrellas, comentario,
    });
    res.status(201).json(calif);
  } catch (e) { next(e); }
};

export const listarCalificacionesController = async (req, res, next) => {
  try {
    res.json(await listarCalificacionesService(+req.params.id));
  } catch (e) { next(e); }
};
</file>

<file path="backend/src/modules/publicaciones/publicaciones.routes.js">
import { Router } from "express";
import { authMiddleware } from "../../middlewares/auth.js";
import {
  listarPublicacionesController,
  obtenerPublicacionController,
  crearPublicacionProductoController,
  crearPublicacionServicioController,
  misPublicacionesController,
  buscarPublicacionesController,
  crearCalificacionController,
  listarCalificacionesController,
} from "./publicaciones.controller.js";

const router = Router();

// p√∫blicas
router.get("/", listarPublicacionesController);
router.get("/busqueda", buscarPublicacionesController);
router.get("/:id", obtenerPublicacionController);
router.get("/:id/calificaciones", listarCalificacionesController);

// protegidas
router.use(authMiddleware);

router.get("/mias/listado", misPublicacionesController);
router.post("/producto", crearPublicacionProductoController);
router.post("/servicio", crearPublicacionServicioController);
router.post("/:id/calificaciones", crearCalificacionController);

export default router;
</file>

<file path="backend/src/modules/publicaciones/publicaciones.service.js">
import { prisma } from "../../config/prisma.js";

// Listar b√°sicas (sin joins pesados)
export async function listarPublicacionesService({ categoria, estado }) {
  let where = "WHERE 1=1";
  const params = [];

  if (categoria) {
    where += " AND p.id_categoria = ?";
    params.push(parseInt(categoria, 10));
  }
  if (estado) {
    where += " AND p.estado = ?";
    params.push(estado);
  }

  const sql = `
    SELECT p.id_publicacion, p.titulo, p.descripcion, p.valor_creditos,
           p.estado, p.imagen_url, c.nombre AS categoria, u.nombre AS usuario
    FROM PUBLICACION p
    JOIN CATEGORIA c ON c.id_categoria = p.id_categoria
    JOIN USUARIO u ON u.id_usuario = p.id_usuario
    ${where}
    ORDER BY p.creado_en DESC
  `;
  // @ts-ignore
  return prisma.$queryRawUnsafe(sql, ...params);
}

export async function obtenerPublicacionService(idPublicacion) {
  const [row] = await prisma.$queryRaw`
    SELECT p.*, c.nombre AS categoria, u.nombre AS usuario
    FROM PUBLICACION p
    JOIN CATEGORIA c ON c.id_categoria = p.id_categoria
    JOIN USUARIO u ON u.id_usuario = p.id_usuario
    WHERE p.id_publicacion = ${idPublicacion}
    LIMIT 1
  `;
  if (!row) {
    const err = new Error("Publicaci√≥n no encontrada");
    err.status = 404;
    throw err;
  }
  return row;
}

export async function misPublicacionesService(idUsuario) {
  return prisma.$queryRaw`
    SELECT p.*
    FROM PUBLICACION p
    WHERE p.id_usuario = ${idUsuario}
    ORDER BY p.creado_en DESC
  `;
}

// Crear PRODUCTO + PUBLICACION + PUBLICACION_PRODUCTO
export async function crearPublicacionProductoService(idUsuario, body) {
  const {
    titulo,
    descripcion,
    id_categoria,
    valor_creditos,
    imagen_url,
    producto,         // { nombre, descripcion, precio, peso }
    cantidad,
    id_um,
  } = body;

  if (!titulo || !descripcion || !id_categoria || !valor_creditos || !producto || !cantidad || !id_um) {
    const err = new Error("Faltan datos obligatorios");
    err.status = 400;
    throw err;
  }

  return prisma.$transaction(async (tx) => {
    const prod = await tx.$queryRaw`
      INSERT INTO PRODUCTO (id_categoria, nombre, descripcion, precio, peso)
      VALUES (${id_categoria}, ${producto.nombre}, ${producto.descripcion || null},
              ${producto.precio || null}, ${producto.peso || null})
    `;

    const [newProd] = await tx.$queryRaw`
      SELECT * FROM PRODUCTO
      WHERE id_producto = LAST_INSERT_ID()
      LIMIT 1
    `;

    const tipoProducto = await tx.$queryRaw`
      SELECT id_tipo_publicacion
      FROM TIPO_PUBLICACION
      WHERE nombre = 'PRODUCTO'
      LIMIT 1
    `;
    if (!tipoProducto.length) {
      const err = new Error("No existe TIPO_PUBLICACION PRODUCTO");
      err.status = 500;
      throw err;
    }

    await tx.$queryRaw`
      INSERT INTO PUBLICACION
        (id_usuario, id_categoria, id_tipo_publicacion, titulo, descripcion, valor_creditos, imagen_url)
      VALUES
        (${idUsuario}, ${id_categoria}, ${tipoProducto[0].id_tipo_publicacion},
         ${titulo}, ${descripcion}, ${valor_creditos}, ${imagen_url || null})
    `;

    const [pub] = await tx.$queryRaw`
      SELECT * FROM PUBLICACION WHERE id_publicacion = LAST_INSERT_ID() LIMIT 1
    `;

    await tx.$queryRaw`
      INSERT INTO PUBLICACION_PRODUCTO (id_publicacion, id_producto, cantidad, id_um)
      VALUES (${pub.id_publicacion}, ${newProd.id_producto}, ${cantidad}, ${id_um})
    `;

    return pub;
  });
}

// Crear SERVICIO + PUBLICACION + PUBLICACION_SERVICIO
export async function crearPublicacionServicioService(idUsuario, body) {
  const {
    titulo,
    descripcion,
    id_categoria,
    valor_creditos,
    imagen_url,
    servicio, // { nombre, descripcion, precio, duracion_min }
    horario,
  } = body;

  if (!titulo || !descripcion || !id_categoria || !valor_creditos || !servicio || !horario) {
    const err = new Error("Faltan datos obligatorios");
    err.status = 400;
    throw err;
  }

  return prisma.$transaction(async (tx) => {
    await tx.$queryRaw`
      INSERT INTO SERVICIO (id_categoria, estado, nombre, descripcion, precio, duracion_min)
      VALUES (${id_categoria}, 'ACTIVO', ${servicio.nombre}, ${servicio.descripcion || null},
              ${servicio.precio || null}, ${servicio.duracion_min || null})
    `;

    const [serv] = await tx.$queryRaw`
      SELECT * FROM SERVICIO WHERE id_servicio = LAST_INSERT_ID() LIMIT 1
    `;

    const tipoServicio = await tx.$queryRaw`
      SELECT id_tipo_publicacion
      FROM TIPO_PUBLICACION
      WHERE nombre = 'SERVICIO'
      LIMIT 1
    `;
    if (!tipoServicio.length) {
      const err = new Error("No existe TIPO_PUBLICACION SERVICIO");
      err.status = 500;
      throw err;
    }

    await tx.$queryRaw`
      INSERT INTO PUBLICACION
        (id_usuario, id_categoria, id_tipo_publicacion, titulo, descripcion, valor_creditos, imagen_url)
      VALUES
        (${idUsuario}, ${id_categoria}, ${tipoServicio[0].id_tipo_publicacion},
         ${titulo}, ${descripcion}, ${valor_creditos}, ${imagen_url || null})
    `;

    const [pub] = await tx.$queryRaw`
      SELECT * FROM PUBLICACION WHERE id_publicacion = LAST_INSERT_ID() LIMIT 1
    `;

    await tx.$queryRaw`
      INSERT INTO PUBLICACION_SERVICIO (id_publicacion, id_servicio, horario)
      VALUES (${pub.id_publicacion}, ${serv.id_servicio}, ${horario})
    `;

    return pub;
  });
}

// B√∫squeda FULLTEXT
export async function buscarPublicacionesService(q) {
  if (!q.trim()) return [];
  return prisma.$queryRawUnsafe(
    `
    SELECT id_publicacion, titulo, descripcion, valor_creditos, imagen_url
    FROM PUBLICACION
    WHERE MATCH(titulo, descripcion) AGAINST (? IN NATURAL LANGUAGE MODE)
      AND estado = 'PUBLICADA'
    ORDER BY creado_en DESC
    `,
    q
  );
}

// Calificaciones
export async function crearCalificacionService({
  idUsuario,
  idPublicacion,
  estrellas,
  comentario,
}) {
  if (!estrellas) {
    const err = new Error("estrellas es obligatorio");
    err.status = 400;
    throw err;
  }

  await prisma.$queryRaw`
    INSERT INTO CALIFICACION (id_usuario, id_publicacion, estrellas, comentario)
    VALUES (${idUsuario}, ${idPublicacion}, ${estrellas}, ${comentario || null})
    ON DUPLICATE KEY UPDATE
      estrellas = VALUES(estrellas),
      comentario = VALUES(comentario)
  `;

  const [row] = await prisma.$queryRaw`
    SELECT * FROM CALIFICACION
    WHERE id_usuario = ${idUsuario} AND id_publicacion = ${idPublicacion}
    LIMIT 1
  `;
  return row;
}

export async function listarCalificacionesService(idPublicacion) {
  return prisma.$queryRaw`
    SELECT c.*, u.nombre
    FROM CALIFICACION c
    JOIN USUARIO u ON u.id_usuario = c.id_usuario
    WHERE c.id_publicacion = ${idPublicacion}
    ORDER BY c.id_calificacion DESC
  `;
}
</file>

<file path="backend/src/modules/publicidad/publicidad.controller.js">
// src/modules/publicidad/publicidad.controller.js

// Servicios propios del m√≥dulo PUBLICIDAD
import {
  crearPublicidadService,
  listarPublicidadActivaService,
  listarPublicidadAdminService,
} from "./publicidad.service.js";

// Servicio del m√≥dulo PUBLICACIONES (ruta correcta)
import { buscarPublicacionesService } from "../publicaciones/publicaciones.service.js";

/**
 * Convierte BigInt, Date, Prisma.Decimal, etc. en tipos JSON-safe
 */
function toPlain(value) {
  if (typeof value === "bigint") return Number(value);

  if (value instanceof Date)
    return value.toISOString().slice(0, 19).replace("T", " ");

  if (value && typeof value === "object") {
    if (typeof value.toNumber === "function") {
      return value.toNumber();
    }

    const prim = value.valueOf?.();
    if (prim != null && typeof prim !== "object") return prim;

    if (Array.isArray(value)) return value.map((v) => toPlain(v));

    const out = {};
    for (const [k, v] of Object.entries(value)) out[k] = toPlain(v);
    return out;
  }

  return value;
}

/**
 * POST /api/publicidad
 * Crear anuncio publicitario (solo admin)
 */
export const crearPublicidadController = async (req, res, next) => {
  try {
    const idUsuario = req.user.id_usuario;
    const data = await crearPublicidadService(idUsuario, req.body);
    res.status(201).json(toPlain(data));
  } catch (err) {
    next(err);
  }
};

/**
 * GET /api/publicidad/activa
 * Publicidad visible para el FRONT (solo activas y en rango)
 */
export const listarPublicidadActivaController = async (req, res, next) => {
  try {
    const data = await listarPublicidadActivaService();
    res.json(toPlain(data));
  } catch (err) {
    next(err);
  }
};

/**
 * GET /api/publicidad/admin
 * Lista TODA la publicidad (panel administrador)
 */
export const listarPublicidadAdminController = async (req, res, next) => {
  try {
    const data = await listarPublicidadAdminService();
    res.json(toPlain(data));
  } catch (err) {
    next(err);
  }
};

/**
 * GET /api/publicidad/buscar-publicaciones?q=
 * Buscar publicaciones para vincularlas a un banner
 */
export const buscarPublicacionesParaPublicidadController = async (
  req,
  res,
  next
) => {
  try {
    const q = req.query.q || "";
    const data = await buscarPublicacionesService(q);
    res.json(toPlain(data));
  } catch (err) {
    next(err);
  }
};
</file>

<file path="backend/src/modules/publicidad/publicidad.routes.js">
import { Router } from "express";
import { authMiddleware } from "../../middlewares/auth.js";
import {
  listarPublicidadActivaController,
  crearPublicidadController,
} from "./publicidad.controller.js";

const router = Router();

router.get("/", listarPublicidadActivaController);

router.use(authMiddleware);
router.post("/", crearPublicidadController);

export default router;
</file>

<file path="backend/src/modules/publicidad/publicidad.service.js">
// src/modules/publicidad/publicidad.service.js
import { prisma } from "../../config/prisma.js";

// Publicidad visible para el FRONT (activa y en rango de fechas)
export const listarPublicidadActivaService = () =>
  prisma.$queryRaw`
    SELECT p.*, u.nombre AS usuario
    FROM PUBLICIDAD p
    JOIN USUARIO u ON u.id_usuario = p.id_usuario
    WHERE p.estado = 'ACTIVA'
      AND NOW() BETWEEN p.fecha_inicio AND p.fecha_fin
    ORDER BY p.fecha_inicio DESC, p.id_publicidad DESC
  `;

// Publicidad para ADMIN (toda la publicidad)
export const listarPublicidadAdminService = () =>
  prisma.$queryRaw`
    SELECT p.*, u.nombre AS usuario
    FROM PUBLICIDAD p
    JOIN USUARIO u ON u.id_usuario = p.id_usuario
    ORDER BY p.fecha_inicio DESC, p.id_publicidad DESC
  `;

// Crear una nueva PUBLICIDAD
export const crearPublicidadService = async (idUsuario, body) => {
  const {
    id_ubicacion,
    titulo,
    descripcion,
    url_destino,
    fecha_inicio,
    fecha_fin,
    costo_creditos,
  } = body;

  if (!id_ubicacion || !titulo || !fecha_inicio || !fecha_fin || !costo_creditos) {
    const err = new Error("Faltan datos obligatorios de publicidad");
    err.status = 400;
    throw err;
  }

  // INSERT
  await prisma.$queryRaw`
    INSERT INTO PUBLICIDAD
      (id_usuario, id_ubicacion, estado, titulo, descripcion, url_destino,
       fecha_inicio, fecha_fin, costo_creditos)
    VALUES
      (
        ${idUsuario},
        ${id_ubicacion},
        'PROGRAMADA',
        ${titulo},
        ${descripcion || null},
        ${url_destino || null},
        ${fecha_inicio},
        ${fecha_fin},
        ${costo_creditos}
      )
  `;

  // Devolver el registro reci√©n creado
  const [row] = await prisma.$queryRaw`
    SELECT *
    FROM PUBLICIDAD
    WHERE id_publicidad = LAST_INSERT_ID()
    LIMIT 1
  `;
  return row;
};
</file>

<file path="backend/src/modules/reportes/reportes.controller.js">
// src/modules/reportes/reportes.controller.js
import {
  repUsuariosActivosService,
  repUsuariosAbandonadosService,
  repIngresosCreditosService,
  repCreditosGenConsService,
  repIntercambiosCategoriaService,
  repPublicacionesVsIntercambiosService,
  repImpactoAcumuladoService,
  rankingUsuariosService,
} from "./reportes.service.js";

/**
 * Helper para convertir BigInt / Date / Decimal a tipos serializables
 */
function toPlain(value) {
  if (typeof value === "bigint") return Number(value);

  if (value instanceof Date) {
    return value.toISOString().slice(0, 19).replace("T", " ");
  }

  if (value && typeof value === "object") {
    if (typeof value.toNumber === "function") return value.toNumber();

    const prim = value.valueOf?.();
    if (prim != null && typeof prim !== "object") return prim;

    if (Array.isArray(value)) return value.map((v) => toPlain(v));

    const out = {};
    for (const [k, v] of Object.entries(value)) {
      out[k] = toPlain(v);
    }
    return out;
  }

  return value;
}

function rango(req) {
  return { desde: req.query.desde, hasta: req.query.hasta };
}

export const repUsuariosActivosController = async (req, res, next) => {
  try {
    const data = await repUsuariosActivosService(rango(req));
    res.json(toPlain(data));
  } catch (e) {
    next(e);
  }
};

export const repUsuariosAbandonadosController = async (req, res, next) => {
  try {
    const data = await repUsuariosAbandonadosService(rango(req));
    res.json(toPlain(data));
  } catch (e) {
    next(e);
  }
};

export const repIngresosCreditosController = async (req, res, next) => {
  try {
    const data = await repIngresosCreditosService(rango(req));
    res.json(toPlain(data));
  } catch (e) {
    next(e);
  }
};

export const repCreditosGenConsController = async (req, res, next) => {
  try {
    const data = await repCreditosGenConsService(rango(req));
    res.json(toPlain(data));
  } catch (e) {
    next(e);
  }
};

export const repIntercambiosCategoriaController = async (req, res, next) => {
  try {
    const data = await repIntercambiosCategoriaService(rango(req));
    res.json(toPlain(data));
  } catch (e) {
    next(e);
  }
};

export const repPublicacionesVsIntercambiosController = async (
  req,
  res,
  next
) => {
  try {
    const data = await repPublicacionesVsIntercambiosService(rango(req));
    res.json(toPlain(data));
  } catch (e) {
    next(e);
  }
};

export const repImpactoAcumuladoController = async (req, res, next) => {
  try {
    const { id_tipo_reporte, id_periodo } = req.query;

    // Asegurar n√∫meros (o null)
    const tipoReporte = id_tipo_reporte ? parseInt(id_tipo_reporte, 10) : null;
    const periodo     = id_periodo ? parseInt(id_periodo, 10) : null;

    const data = await repImpactoAcumuladoService(tipoReporte, periodo);
    res.json(data);
  } catch (e) {
    next(e);
  }
};

export const rankingUsuariosController = async (req, res, next) => {
  try {
    const idPeriodo = req.query.id_periodo
      ? parseInt(req.query.id_periodo, 10)
      : null;
    const limit = req.query.limit ? parseInt(req.query.limit, 10) : null;

    const data = await rankingUsuariosService(idPeriodo, limit);
    res.json(toPlain(data));
  } catch (e) {
    next(e);
  }
};
</file>

<file path="backend/src/modules/reportes/reportes.routes.js">
import { Router } from "express";
import { authMiddleware } from "../../middlewares/auth.js";
import { isAdmin } from "../../middlewares/isAdmin.js";
import {
  repUsuariosActivosController,
  repUsuariosAbandonadosController,
  repIngresosCreditosController,
  repCreditosGenConsController,
  repIntercambiosCategoriaController,
  repPublicacionesVsIntercambiosController,
  repImpactoAcumuladoController,
  rankingUsuariosController,
} from "./reportes.controller.js";

const router = Router();

router.use(authMiddleware, isAdmin);

router.get("/usuarios-activos", repUsuariosActivosController);
router.get("/usuarios-abandonados", repUsuariosAbandonadosController);
router.get("/ingresos-creditos", repIngresosCreditosController);
router.get("/creditos-generados-consumidos", repCreditosGenConsController);
router.get("/intercambios-categoria", repIntercambiosCategoriaController);
router.get("/publicaciones-intercambios", repPublicacionesVsIntercambiosController);
router.get("/impacto-acumulado", repImpactoAcumuladoController);
router.get("/ranking-usuarios", rankingUsuariosController);

export default router;
</file>

<file path="backend/src/modules/reportes/reportes.service.js">
// src/modules/reportes/reportes.service.js
import { prisma } from "../../config/prisma.js";

function rangoFechas({ desde, hasta }) {
  return [desde || "2000-01-01", hasta || "2100-01-01"];
}

export async function repUsuariosActivosService(r) {
  const [rows] = await prisma.$queryRawUnsafe(
    "CALL sp_rep_usuarios_activos(?, ?)",
    ...rangoFechas(r)
  );
  return rows;
}

export async function repUsuariosAbandonadosService(r) {
  const [rows] = await prisma.$queryRawUnsafe(
    "CALL sp_rep_usuarios_abandonados(?, ?)",
    ...rangoFechas(r)
  );
  return rows;
}

export async function repIngresosCreditosService(r) {
  const [rows] = await prisma.$queryRawUnsafe(
    "CALL sp_rep_ingresos_creditos(?, ?)",
    ...rangoFechas(r)
  );
  return rows;
}

export async function repCreditosGenConsService(r) {
  const [rows] = await prisma.$queryRawUnsafe(
    "CALL sp_rep_creditos_generados_vs_consumidos(?, ?)",
    ...rangoFechas(r)
  );
  return rows;
}

export async function repIntercambiosCategoriaService(r) {
  const [rows] = await prisma.$queryRawUnsafe(
    "CALL sp_rep_intercambios_por_categoria(?, ?)",
    ...rangoFechas(r)
  );
  return rows;
}

export async function repPublicacionesVsIntercambiosService(r) {
  const [rows] = await prisma.$queryRawUnsafe(
    "CALL sp_rep_publicaciones_vs_intercambios(?, ?)",
    ...rangoFechas(r)
  );
  return rows;
}

export async function repImpactoAcumuladoService(tipoReporte, periodo) {
  const [rows] = await prisma.$queryRawUnsafe(
    "CALL sp_generar_reporte_impacto(?, ?, NULL)",
    tipoReporte,
    periodo,
  );
  return rows;
}


export async function rankingUsuariosService(idPeriodo, limit) {
  const [rows] = await prisma.$queryRawUnsafe(
    "CALL sp_obtener_ranking_usuarios(?, ?)",
    idPeriodo ?? null,
    limit ?? null
  );
  return rows;
}
</file>

<file path="backend/src/modules/uploads/multer.js">
// uploads/multer.js
import multer from "multer";
import { v4 as uuid } from "uuid";
import path from "path";

const storage = multer.diskStorage({
  destination: (req, file, cb) => {
    cb(null, "uploads_storage"); // carpeta real donde iran las im√°genes
  },
  filename: (req, file, cb) => {
    const unique = uuid();
    const ext = path.extname(file.originalname);
    cb(null, unique + ext);
  },
});

export const upload = multer({ storage });
</file>

<file path="backend/src/modules/uploads/uploads.controller.js">
import { procesarArchivoService } from "./uploads.service.js";

export const subirArchivoController = async (req, res, next) => {
  try {
    if (!req.file) {
      return res.status(400).json({ message: "No enviaste ning√∫n archivo" });
    }

    const url = await procesarArchivoService(req.file);

    res.json({
      message: "Archivo subido correctamente",
      url,
    });
  } catch (err) {
    next(err);
  }
};
</file>

<file path="backend/src/modules/uploads/uploads.routes.js">
import { Router } from "express";
import { authMiddleware } from "../../middlewares/auth.js";
import { upload } from "./multer.js";
import { subirArchivoController } from "./uploads.controller.js";

const router = Router();

// Ruta protegida: requiere login
router.post("/", authMiddleware, upload.single("archivo"), subirArchivoController);

export default router;
</file>

<file path="backend/src/modules/uploads/uploads.service.js">
import path from "path";

export async function procesarArchivoService(file) {
  // URL p√∫blica final (aj√∫stala seg√∫n tu hosting)
  const url = `/uploads/${file.filename}`;

  // Puedes almacenar archivo en S3, Cloudinary o FS local.
  // Aqu√≠ usamos local para desarrollo.
  
  return url;
}
</file>

<file path="backend/src/modules/usuarios/usuarios.controller.js">
import {
  listarUsuariosService,
  crearUsuarioAdminService,
  actualizarUsuarioService,
  cambiarEstadoUsuarioService,
  obtenerHistorialUsuarioService,
} from "./usuarios.service.js";

export async function listarUsuariosController(req, res, next) {
  try {
    const usuarios = await listarUsuariosService();
    res.json(usuarios);
  } catch (err) {
    next(err);
  }
}

export async function crearUsuarioAdminController(req, res, next) {
  try {
    const usuario = await crearUsuarioAdminService(req.body);
    res.status(201).json(usuario);
  } catch (err) {
    next(err);
  }
}

export async function actualizarUsuarioController(req, res, next) {
  try {
    const id = parseInt(req.params.id, 10);
    const usuario = await actualizarUsuarioService(id, req.body);
    res.json(usuario);
  } catch (err) {
    next(err);
  }
}

export async function cambiarEstadoUsuarioController(req, res, next) {
  try {
    const id = parseInt(req.params.id, 10);
    const { estado } = req.body;
    const usuario = await cambiarEstadoUsuarioService(id, estado);
    res.json(usuario);
  } catch (err) {
    next(err);
  }
}

export async function obtenerHistorialUsuarioController(req, res, next) {
  try {
    const id = parseInt(req.params.id, 10);
    const historial = await obtenerHistorialUsuarioService(id);
    res.json(historial);
  } catch (err) {
    next(err);
  }
}
</file>

<file path="backend/src/modules/usuarios/usuarios.routes.js">
import { Router } from "express";
import { authMiddleware } from "../../middlewares/auth.js";
import { isAdmin } from "../../middlewares/isAdmin.js";
import {
  listarUsuariosController,
  crearUsuarioAdminController,
  actualizarUsuarioController,
  cambiarEstadoUsuarioController,
  obtenerHistorialUsuarioController,
} from "./usuarios.controller.js";

const router = Router();

// Todo lo de aqu√≠ requiere admin
router.use(authMiddleware, isAdmin);

// GET /api/usuarios
router.get("/", listarUsuariosController);

// POST /api/usuarios
router.post("/", crearUsuarioAdminController);

// PUT /api/usuarios/:id
router.put("/:id", actualizarUsuarioController);

// PATCH /api/usuarios/:id/estado
router.patch("/:id/estado", cambiarEstadoUsuarioController);

// GET /api/usuarios/:id/historial
router.get("/:id/historial", obtenerHistorialUsuarioController);

export default router;
</file>

<file path="backend/src/modules/usuarios/usuarios.service.js">
import bcrypt from "bcryptjs";
import { prisma } from "../../config/prisma.js";

export async function listarUsuariosService() {
  const rows = await prisma.$queryRaw`
    SELECT u.id_usuario, u.nombre, u.apellido, u.correo, u.telefono,
           u.estado, r.nombre AS rol
    FROM USUARIO u
    JOIN ROL r ON r.id_rol = u.id_rol
    ORDER BY u.id_usuario DESC
  `;
  return rows;
}

export async function crearUsuarioAdminService({
  nombre,
  apellido,
  correo,
  telefono,
  password,
  id_rol,
  estado = "ACTIVO",
}) {
  if (!nombre || !correo || !password || !id_rol) {
    const err = new Error("nombre, correo, password e id_rol son obligatorios");
    err.status = 400;
    throw err;
  }

  const existente = await prisma.$queryRaw`
    SELECT id_usuario FROM USUARIO WHERE correo = ${correo} LIMIT 1
  `;
  if (existente.length) {
    const error = new Error("El correo ya est√° registrado");
    error.status = 409;
    throw error;
  }

  const hash = await bcrypt.hash(password, 10);

  await prisma.$queryRaw`
    INSERT INTO USUARIO (id_rol, estado, nombre, apellido, correo, password_hash, telefono, url_perfil)
    VALUES (${id_rol}, ${estado}, ${nombre}, ${apellido || null}, ${correo}, ${hash},
            ${telefono || null}, NULL)
  `;

  const rows = await prisma.$queryRaw`
    SELECT u.id_usuario, u.nombre, u.apellido, u.correo, u.telefono,
           u.estado, r.nombre AS rol
    FROM USUARIO u
    JOIN ROL r ON r.id_rol = u.id_rol
    WHERE u.correo = ${correo}
    LIMIT 1
  `;
  return rows[0];
}

export async function actualizarUsuarioService(idUsuario, data) {
  const { nombre, apellido, telefono, id_rol } = data;

  await prisma.$queryRaw`
    UPDATE USUARIO
    SET nombre = COALESCE(${nombre}, nombre),
        apellido = COALESCE(${apellido}, apellido),
        telefono = COALESCE(${telefono}, telefono),
        id_rol = COALESCE(${id_rol}, id_rol)
    WHERE id_usuario = ${idUsuario}
  `;

  const rows = await prisma.$queryRaw`
    SELECT u.id_usuario, u.nombre, u.apellido, u.correo, u.telefono,
           u.estado, r.nombre AS rol
    FROM USUARIO u
    JOIN ROL r ON r.id_rol = u.id_rol
    WHERE u.id_usuario = ${idUsuario}
    LIMIT 1
  `;
  if (!rows.length) {
    const err = new Error("Usuario no encontrado");
    err.status = 404;
    throw err;
  }
  return rows[0];
}

export async function cambiarEstadoUsuarioService(idUsuario, estado) {
  if (!estado) {
    const err = new Error("estado es obligatorio");
    err.status = 400;
    throw err;
  }

  await prisma.$queryRaw`
    UPDATE USUARIO
    SET estado = ${estado}
    WHERE id_usuario = ${idUsuario}
  `;

  const rows = await prisma.$queryRaw`
    SELECT u.id_usuario, u.nombre, u.apellido, u.correo, u.telefono,
           u.estado, r.nombre AS rol
    FROM USUARIO u
    JOIN ROL r ON r.id_rol = u.id_rol
    WHERE u.id_usuario = ${idUsuario}
    LIMIT 1
  `;
  if (!rows.length) {
    const err = new Error("Usuario no encontrado");
    err.status = 404;
    throw err;
  }
  return rows[0];
}

export async function obtenerHistorialUsuarioService(idUsuario) {
  // Llama a tu SP sp_obtener_historial_usuario
  const result = await prisma.$queryRawUnsafe(
    "CALL sp_obtener_historial_usuario(?)",
    idUsuario
  );
  // En MySQL, CALL devuelve [rows, meta]; nos quedamos con rows[0]
  return result[0] || result;
}
</file>

<file path="backend/src/modules/wallet/wallet.controller.js">
import {
  obtenerMisCreditosService,
  obtenerMisMovimientosService,
  comprarCreditosService,
  obtenerMisComprasService,
} from "./wallet.service.js";

export async function getMisCreditosController(req, res, next) {
  try {
    const idUsuario = req.user.id_usuario;
    const data = await obtenerMisCreditosService(idUsuario);
    res.json(data);
  } catch (err) {
    next(err);
  }
}

export async function getMisMovimientosController(req, res, next) {
  try {
    const idUsuario = req.user.id_usuario;
    const data = await obtenerMisMovimientosService(idUsuario);
    res.json(data);
  } catch (err) {
    next(err);
  }
}

export async function postCompraCreditosController(req, res, next) {
  try {
    const idUsuario = req.user.id_usuario;
    const { idPaquete, idTransaccionPago } = req.body;

    if (!idPaquete) {
      return res.status(400).json({ message: "idPaquete es obligatorio" });
    }

    const billetera = await comprarCreditosService({
      idUsuario,
      idPaquete,
      idTransaccionPago: idTransaccionPago || null,
    });

    res.status(201).json({
      message: "Compra aprobada",
      billetera,
    });
  } catch (err) {
    next(err);
  }
}

export async function getMisComprasController(req, res, next) {
  try {
    const idUsuario = req.user.id_usuario;
    const compras = await obtenerMisComprasService(idUsuario);
    res.json(compras);
  } catch (err) {
    next(err);
  }
}
</file>

<file path="backend/src/modules/wallet/wallet.routes.js">
import { Router } from "express";
import { authMiddleware } from "../../middlewares/auth.js";
import {
  getMisCreditosController,
  getMisMovimientosController,
  postCompraCreditosController,
  getMisComprasController,
} from "./wallet.controller.js";

const router = Router();

router.use(authMiddleware);

// GET /api/wallet/mis-creditos
router.get("/mis-creditos", getMisCreditosController);

// GET /api/wallet/mis-movimientos
router.get("/mis-movimientos", getMisMovimientosController);

// POST /api/wallet/compra-creditos
router.post("/compra-creditos", postCompraCreditosController);

// GET /api/wallet/compras
router.get("/compras", getMisComprasController);

export default router;
</file>

<file path="backend/src/modules/wallet/wallet.service.js">
import { prisma } from "../../config/prisma.js";

// Helper para convertir BigInt / Decimal a Number
function toNumberSafe(value, def = 0) {
  if (value == null) return def;

  if (typeof value === "bigint") return Number(value);

  if (typeof value === "object" && typeof value.toNumber === "function") {
    return value.toNumber();
  }

  const num = Number(value);
  return Number.isNaN(num) ? def : num;
}

function normalizeBilleteraRow(row) {
  if (!row) {
    return {
      saldo_creditos: 0,
      saldo_bs: 0,
    };
  }

  return {
    saldo_creditos: toNumberSafe(row.saldo_creditos, 0),
    saldo_bs: toNumberSafe(row.saldo_bs, 0),
  };
}

export async function obtenerMisCreditosService(idUsuario) {
  const rows = await prisma.$queryRaw`
    SELECT saldo_creditos, saldo_bs
    FROM BILLETERA
    WHERE id_usuario = ${idUsuario}
    LIMIT 1
  `;

  return normalizeBilleteraRow(rows[0]);
}

export async function obtenerMisMovimientosService(idUsuario) {
  const rows = await prisma.$queryRaw`
    SELECT m.id_movimiento,
           m.cantidad,
           m.saldo_anterior,
           m.saldo_posterior,
           m.id_referencia,
           m.creado_en,
           tm.nombre AS tipo_movimiento,
           tr.nombre AS tipo_referencia
    FROM MOVIMIENTO_CREDITOS m
    JOIN TIPO_MOVIMIENTO tm ON tm.id_tipo_movimiento = m.id_tipo_movimiento
    JOIN TIPO_REFERENCIA tr ON tr.id_tipo_referencia = m.id_tipo_referencia
    WHERE m.id_usuario = ${idUsuario}
    ORDER BY m.creado_en DESC, m.id_movimiento DESC
  `;

  // si quieres, aqu√≠ tambi√©n podr√≠as normalizar BigInt, pero por ahora lo dejamos
  return rows;
}

export async function comprarCreditosService({
  idUsuario,
  idPaquete,
  idTransaccionPago,
}) {
  // Llamar al SP
  await prisma.$executeRawUnsafe(
    "CALL sp_compra_creditos_aprobar(?, ?, ?)",
    idUsuario,
    idPaquete,
    idTransaccionPago
  );

  const rows = await prisma.$queryRaw`
    SELECT saldo_creditos, saldo_bs
    FROM BILLETERA
    WHERE id_usuario = ${idUsuario}
    LIMIT 1
  `;

  return normalizeBilleteraRow(rows[0]);
}

export async function obtenerMisComprasService(idUsuario) {
  const rows = await prisma.$queryRaw`
    SELECT c.id_compra,
           c.id_paquete,
           p.nombre AS paquete,
           p.cantidad_creditos,
           c.monto_bs,
           c.estado,
           c.id_transaccion_pago,
           c.creado_en
    FROM COMPRA_CREDITOS c
    JOIN PAQUETE_CREDITOS p ON p.id_paquete = c.id_paquete
    WHERE c.id_usuario = ${idUsuario}
    ORDER BY c.creado_en DESC, c.id_compra DESC
  `;
  return rows;
}
</file>

<file path="backend/src/routes/index.js">
// src/routes/index.js
import { Router } from 'express';

import authRoutes from '../modules/auth/auth.routes.js';
import usuariosRoutes from '../modules/usuarios/usuarios.routes.js';
import catalogosRoutes from '../modules/catalogos/catalogos.routes.js';
import walletRoutes from '../modules/wallet/wallet.routes.js';
import publicacionesRoutes from '../modules/publicaciones/publicaciones.routes.js';
import intercambiosRoutes from '../modules/intercambios/intercambios.routes.js';
import actividadesRoutes from '../modules/actividades/actividades.routes.js';
import promocionesRoutes from '../modules/promociones/promociones.routes.js';
import publicidadRoutes from '../modules/publicidad/publicidad.routes.js';
import logrosRoutes from '../modules/logros/logros.routes.js';
import premiumRoutes from '../modules/premium/premium.routes.js';
import reportesRoutes from '../modules/reportes/reportes.routes.js';
import uploadsRoutes from '../modules/uploads/uploads.routes.js';

const router = Router();

router.use('/auth', authRoutes);
router.use('/usuarios', usuariosRoutes);
router.use('/catalogos', catalogosRoutes);
router.use('/wallet', walletRoutes);
router.use('/publicaciones', publicacionesRoutes);
router.use('/intercambios', intercambiosRoutes);
router.use('/actividades-sostenibles', actividadesRoutes);
router.use('/promociones', promocionesRoutes);
router.use('/publicidad', publicidadRoutes);
router.use('/logros', logrosRoutes);
router.use('/premium', premiumRoutes);
router.use('/reportes', reportesRoutes);
router.use('/uploads', uploadsRoutes);

export default router;
</file>

<file path="backend/src/server.js">
// src/server.js
import app from './app.js'
import { env } from './config/env.js'

const PORT = env.PORT

app.listen(PORT, () => {
    console.log(`üöÄ API running on http://localhost:${PORT}`)
})
</file>

<file path="backend/utils/jsonBigInt.js">
export function toJsonSafe(value) {
  if (typeof value === "bigint") {
    return Number(value);            // <- si prefieres string: value.toString()
  }

  if (Array.isArray(value)) {
    return value.map(toJsonSafe);
  }

  if (value !== null && typeof value === "object") {
    const out = {};
    for (const key in value) {
      out[key] = toJsonSafe(value[key]);
    }
    return out;
  }

  return value;
}
</file>

<file path="docker-compose.yml">
version: "3.9"
services:
  db:
    image: mysql:8.0
    restart: unless-stopped
    environment:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_DATABASE: appdb
    ports:
      - "3306:3306"
    volumes:
      - db_data:/var/lib/mysql
      - ./infra/db/init.sql:/docker-entrypoint-initdb.d/1-init.sql
      - ./infra/db/seed.sql:/docker-entrypoint-initdb.d/2-seed.sql
  backend:
    build: ./backend
    working_dir: /app
    env_file: ./backend/.env
    depends_on:
      - db
    ports:
      - "4000:4000"
    command: sh -c "npx prisma migrate deploy && node src/server.js"
    volumes:
      - ./backend:/app
  frontend:
    build: ./frontend
    working_dir: /app
    ports:
      - "5173:5173"
    environment:
      - VITE_API_URL=http://localhost:4000/api
    command: npm run dev -- --host
    volumes:
      - ./frontend:/app
volumes:
  db_data:
</file>

<file path="frontend/index.html">
<!doctype html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <title>Digital Barter</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  </head>
  <body class="bg-gray-100">
    <div id="root"></div>
    <script type="module" src="/src/main.jsx"></script>
  </body>
</html>
</file>

<file path="frontend/package.json">
{
  "name": "frontend",
  "version": "0.0.1",
  "private": true,
  "scripts": {
    "dev": "vite",
    "build": "vite build",
    "preview": "vite preview"
  },
  "dependencies": {
    "react": "^18.3.1",
    "react-dom": "^18.3.1",
    "react-router-dom": "^6.28.0",
    "recharts": "^3.4.1"
  },
  "devDependencies": {
    "@vitejs/plugin-react": "^4.3.4",
    "autoprefixer": "^10.4.20",
    "postcss": "^8.4.49",
    "tailwindcss": "^3.4.14",
    "vite": "^5.4.0"
  }
}
</file>

<file path="frontend/postcss.config.js">
module.exports = {
  plugins: {
    tailwindcss: {},
    autoprefixer: {}
  }
};
</file>

<file path="frontend/src/App.jsx">
import React from "react";
import AppRouter from "./router.jsx";

export default function App() {
  return <AppRouter />;
}
</file>

<file path="frontend/src/components/Layout.jsx">
import React from "react";
import Navbar from "./Navbar.jsx";

export default function Layout({ children }) {
  return (
    <div className="min-h-screen flex flex-col">
      <Navbar />
      <main className="flex-1 max-w-6xl w-full mx-auto px-4 py-4">
        {children}
      </main>
    </div>
  );
}
</file>

<file path="frontend/src/components/Navbar.jsx">
import React from "react";
import { useNavigate } from "react-router-dom";
import { logout } from "../services/api.js";

export default function Navbar() {
  const navigate = useNavigate();
  const usuarioJson = localStorage.getItem("usuario");
  let usuario = null;

  try {
    usuario = usuarioJson ? JSON.parse(usuarioJson) : null;
  } catch {
    usuario = null;
  }

  const handleLogout = () => {
    logout();
    navigate("/login");
  };

  return (
    <header className="w-full bg-white border-b border-gray-200 px-4 py-2 flex items-center justify-between">
      <div className="flex items-center gap-2">
        <span className="font-bold text-lg text-blue-700">Digital Barter</span>
        <span className="text-xs text-gray-500 hidden sm:inline">
          Panel principal
        </span>
      </div>

      <div className="flex items-center gap-3">
        {usuario && (
          <div className="text-right">
            <p className="text-sm font-medium">
              {usuario.nombre ?? usuario.correo ?? "Usuario"}
            </p>
            <p className="text-xs text-gray-500">
              {usuario.rol ?? "Rol no asignado"}
            </p>
          </div>
        )}
        <button
          type="button"
          onClick={handleLogout}
          className="px-3 py-1 text-xs rounded-md border border-gray-300 hover:bg-gray-100"
        >
          Cerrar sesi√≥n
        </button>
      </div>
    </header>
  );
}
</file>

<file path="frontend/src/components/ProtectedRoute.jsx">
import React from "react";
import { Navigate, useLocation } from "react-router-dom";

export default function ProtectedRoute({ children }) {
  const token = localStorage.getItem("token");
  const location = useLocation();

  if (!token) {
    return <Navigate to="/login" state={{ from: location }} replace />;
  }

  return children;
}
</file>

<file path="frontend/src/index.css">
@tailwind base;
@tailwind components;
@tailwind utilities;

/* estilos globales */
body {
  @apply bg-gray-100 text-gray-900;
}

.btn-primary {
  @apply inline-flex items-center justify-center px-4 py-2 rounded-md bg-blue-600 text-white text-sm font-medium hover:bg-blue-700 transition;
}

.card {
  @apply bg-white rounded-lg shadow-sm border border-gray-200 p-4;
}
</file>

<file path="frontend/src/main.jsx">
import React from "react";
import ReactDOM from "react-dom/client";
import { BrowserRouter } from "react-router-dom";
import App from "./App.jsx";
import "./index.css";

ReactDOM.createRoot(document.getElementById("root")).render(
  <React.StrictMode>
    <BrowserRouter>
      <App />
    </BrowserRouter>
  </React.StrictMode>
);
</file>

<file path="frontend/src/pages/BackendLab.jsx">
// frontend/src/pages/BackendLab.jsx
import React, { useEffect, useState } from "react";

// Usa la misma URL base del backend que ya usas en el proyecto
const API_BASE_URL =
  import.meta.env.VITE_API_URL || "http://localhost:4000/api";

function loadToken() {
  return localStorage.getItem("token") || "";
}

export default function BackendLab() {
  const [token, setToken] = useState(loadToken());
  const [loading, setLoading] = useState(false);
  const [lastRequest, setLastRequest] = useState(null);
  const [lastResponse, setLastResponse] = useState(null);
  const [error, setError] = useState("");

  // ====== AUTH: registro / login ======
  const [regNombre, setRegNombre] = useState("Ana");
  const [regApellido, setRegApellido] = useState("Demo");
  const [regCorreo, setRegCorreo] = useState("ana.demo@example.com");
  const [regPassword, setRegPassword] = useState("ana12345");
  const [regTelefono, setRegTelefono] = useState("70000001");

  const [loginCorreo, setLoginCorreo] = useState("ana.demo@example.com");
  const [loginPassword, setLoginPassword] = useState("ana12345");

  // ====== Usuarios / historial ======
  const [userIdHistorial, setUserIdHistorial] = useState("");

  // ====== Wallet ======
  const [idPaquete, setIdPaquete] = useState("1");
  const [montoPagado, setMontoPagado] = useState("100");
  const [refPago, setRefPago] = useState("TEST-001");

  // ====== Intercambios ======
  const [idPublicacionInter, setIdPublicacionInter] = useState("");
  const [creditosInter, setCreditosInter] = useState("");

  // ====== Actividades ======
  const [idTipoAct, setIdTipoAct] = useState("1");
  const [descAct, setDescAct] = useState("Entreg√≥ 5kg de papel para reciclaje");
  const [credAct, setCredAct] = useState("10");

  // ====== Reportes ======
  const [desdeRep, setDesdeRep] = useState("2025-11-01");
  const [hastaRep, setHastaRep] = useState("2025-11-30");

  // ====== Request manual ======
  const [manualPath, setManualPath] = useState("/wallet/mis-creditos");
  const [manualMethod, setManualMethod] = useState("GET");
  const [manualBody, setManualBody] = useState("{\n  \n}");

  useEffect(() => {
    if (token) localStorage.setItem("token", token);
  }, [token]);

  async function callApi(moduleName, actionName, path, options = {}) {
    setError("");
    setLastResponse(null);

    const method = options.method || "GET";
    const bodyObj = options.body || null;

    setLastRequest({
      moduleName,
      actionName,
      method,
      url: API_BASE_URL + path,
      body: bodyObj,
    });

    try {
      setLoading(true);

      const headers = {
        "Content-Type": "application/json",
        ...(options.headers || {}),
      };

      if (token) {
        headers.Authorization = `Bearer ${token}`;
      }

      const res = await fetch(API_BASE_URL + path, {
        method,
        headers,
        body:
          bodyObj && ["POST", "PUT", "PATCH"].includes(method)
            ? JSON.stringify(bodyObj)
            : undefined,
      });

      let rawText = "";
      let data = null;
      try {
        rawText = await res.text();
        data = rawText ? JSON.parse(rawText) : null;
      } catch {
        data = rawText;
      }

      setLastResponse({
        status: res.status,
        ok: res.ok,
        data,
      });

      if (!res.ok) {
        setError(`Respuesta con error HTTP ${res.status}`);
      }
    } catch (err) {
      setError(err.message || "Error en la llamada");
    } finally {
      setLoading(false);
    }
  }

  // ====== AUTH: registro ======
  async function handleRegister(e) {
    e.preventDefault();
    await callApi("Auth", "POST /auth/register", "/auth/register", {
      method: "POST",
      body: {
        nombre: regNombre,
        apellido: regApellido,
        correo: regCorreo,
        password: regPassword,
        telefono: regTelefono,
      },
    });
  }

  // ====== AUTH: login ======
  async function handleLogin(e) {
    e.preventDefault();
    setError("");
    try {
      setLoading(true);

      const res = await fetch(API_BASE_URL + "/auth/login", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          correo: loginCorreo,
          password: loginPassword,
        }),
      });

      let raw = "";
      let data = null;
      try {
        raw = await res.text();
        data = raw ? JSON.parse(raw) : null;
      } catch {
        data = raw;
      }

      setLastRequest({
        moduleName: "Auth",
        actionName: "POST /auth/login",
        method: "POST",
        url: API_BASE_URL + "/auth/login",
        body: { correo: loginCorreo, password: "***" },
      });
      setLastResponse({
        status: res.status,
        ok: res.ok,
        data,
      });

      if (!res.ok) {
        setError(`Login fall√≥ con HTTP ${res.status}`);
        return;
      }

      if (data && data.token) {
        setToken(data.token);
      } else {
        setError("La respuesta de login no contiene token");
      }
    } catch (err) {
      setError(err.message || "Error en login");
    } finally {
      setLoading(false);
    }
  }

  // ====== REQUEST MANUAL ======
  async function handleManualCall(e) {
    e.preventDefault();
    let bodyParsed = null;
    if (manualMethod !== "GET" && manualBody.trim()) {
      try {
        bodyParsed = JSON.parse(manualBody);
      } catch {
        setError("El body manual no es JSON v√°lido");
        return;
      }
    }
    await callApi(
      "Manual",
      `${manualMethod} ${manualPath}`,
      manualPath,
      {
        method: manualMethod,
        body: bodyParsed,
      }
    );
  }

  return (
    <div className="space-y-4">
      {/* HEADER */}
      <header className="flex flex-col sm:flex-row justify-between gap-3 items-start sm:items-center">
        <div>
          <h2 className="text-xl font-semibold text-gray-900">
            Laboratorio completo de Backend
          </h2>
          <p className="text-sm text-gray-500">
            Registro, login e interacci√≥n con todos los m√≥dulos del backend para
            comprobar si las rutas responden correctamente.
          </p>
          <p className="text-xs text-gray-400 mt-1">
            API_BASE_URL: <code>{API_BASE_URL}</code>
          </p>
        </div>
        <div className="text-right text-xs">
          <p className="font-semibold">Token actual:</p>
          <p className="truncate max-w-xs text-gray-500">
            {token ? token : "(sin token)"}
          </p>
          <button
            className="mt-1 text-xs text-red-600 underline"
            onClick={() => {
              setToken("");
              localStorage.removeItem("token");
            }}
          >
            Limpiar token
          </button>
          {loading && (
            <p className="mt-1 text-emerald-600 font-medium">
              Ejecutando request...
            </p>
          )}
        </div>
      </header>

      {error && (
        <div className="bg-red-50 border-red-200 border text-red-700 text-sm px-3 py-2 rounded">
          {error}
        </div>
      )}

      {/* =========================================================
          1. AUTH: REGISTRO / LOGIN / ME
         ========================================================= */}
      <section className="card space-y-3">
        <p className="text-xs font-semibold uppercase text-gray-500">
          1. Autenticaci√≥n (Registro / Login / Perfil)
        </p>

        <div className="grid gap-3 md:grid-cols-2 text-xs">
          {/* REGISTRO */}
          <form onSubmit={handleRegister} className="space-y-2">
            <p className="font-semibold">Registro r√°pido</p>
            <div>
              <label className="block mb-1 font-medium">Nombre</label>
              <input
                type="text"
                value={regNombre}
                onChange={(e) => setRegNombre(e.target.value)}
                className="w-full border rounded px-2 py-1"
              />
            </div>
            <div>
              <label className="block mb-1 font-medium">Apellido</label>
              <input
                type="text"
                value={regApellido}
                onChange={(e) => setRegApellido(e.target.value)}
                className="w-full border rounded px-2 py-1"
              />
            </div>
            <div>
              <label className="block mb-1 font-medium">Correo</label>
              <input
                type="email"
                value={regCorreo}
                onChange={(e) => setRegCorreo(e.target.value)}
                className="w-full border rounded px-2 py-1"
              />
            </div>
            <div>
              <label className="block mb-1 font-medium">Tel√©fono</label>
              <input
                type="text"
                value={regTelefono}
                onChange={(e) => setRegTelefono(e.target.value)}
                className="w-full border rounded px-2 py-1"
              />
            </div>
            <div>
              <label className="block mb-1 font-medium">Contrase√±a</label>
              <input
                type="password"
                value={regPassword}
                onChange={(e) => setRegPassword(e.target.value)}
                className="w-full border rounded px-2 py-1"
              />
            </div>
            <button type="submit" className="btn-secondary">
              Registrar usuario
            </button>
          </form>

          {/* LOGIN */}
          <form onSubmit={handleLogin} className="space-y-2">
            <p className="font-semibold">Login</p>
            <div>
              <label className="block mb-1 font-medium">Correo</label>
              <input
                type="email"
                value={loginCorreo}
                onChange={(e) => setLoginCorreo(e.target.value)}
                className="w-full border rounded px-2 py-1"
              />
            </div>
            <div>
              <label className="block mb-1 font-medium">Contrase√±a</label>
              <input
                type="password"
                value={loginPassword}
                onChange={(e) => setLoginPassword(e.target.value)}
                className="w-full border rounded px-2 py-1"
              />
            </div>
            <button type="submit" className="btn-primary">
              Iniciar sesi√≥n
            </button>

            <div className="mt-2">
              <button
                type="button"
                className="btn-secondary"
                onClick={() =>
                  callApi("Auth", "GET /auth/me", "/auth/me")
                }
              >
                Probar /auth/me
              </button>
            </div>
          </form>
        </div>

        {/* Usuarios / historial */}
        <div className="border-t pt-2 mt-2 text-xs">
          <p className="font-semibold mb-1">Usuarios / historial</p>
          <div className="flex flex-wrap gap-2 items-end">
            <button
              className="btn-secondary"
              onClick={() =>
                callApi("Usuarios", "GET /usuarios", "/usuarios")
              }
            >
              Listar /usuarios (ADMIN)
            </button>
            <div className="flex gap-2 items-end">
              <div>
                <label className="block mb-1 font-medium">
                  ID usuario para historial:
                </label>
                <input
                  type="number"
                  value={userIdHistorial}
                  onChange={(e) => setUserIdHistorial(e.target.value)}
                  className="border rounded px-2 py-1"
                  placeholder="Ej: 1"
                />
              </div>
              <button
                className="btn-secondary"
                onClick={() =>
                  userIdHistorial &&
                  callApi(
                    "Usuarios",
                    `GET /usuarios/${userIdHistorial}/historial`,
                    `/usuarios/${userIdHistorial}/historial`
                  )
                }
              >
                Ver historial
              </button>
            </div>
          </div>
        </div>
      </section>

      {/* =========================================================
          2. CAT√ÅLOGOS
         ========================================================= */}
      <section className="card space-y-2">
        <p className="text-xs font-semibold uppercase text-gray-500">
          2. Cat√°logos
        </p>
        <div className="flex flex-wrap gap-2 text-xs">
          <button
            className="btn-secondary"
            onClick={() =>
              callApi("Cat√°logos", "GET /catalogos/categorias", "/catalogos/categorias")
            }
          >
            Categor√≠as
          </button>
          <button
            className="btn-secondary"
            onClick={() =>
              callApi(
                "Cat√°logos",
                "GET /catalogos/paquetes-creditos",
                "/catalogos/paquetes-creditos"
              )
            }
          >
            Paquetes cr√©ditos
          </button>
          <button
            className="btn-secondary"
            onClick={() =>
              callApi(
                "Cat√°logos",
                "GET /catalogos/tipos-actividad",
                "/catalogos/tipos-actividad"
              )
            }
          >
            Tipos actividad
          </button>
          <button
            className="btn-secondary"
            onClick={() =>
              callApi("Cat√°logos", "GET /catalogos/periodos", "/catalogos/periodos")
            }
          >
            Periodos
          </button>
          <button
            className="btn-secondary"
            onClick={() =>
              callApi(
                "Cat√°logos",
                "GET /catalogos/tipos-reporte",
                "/catalogos/tipos-reporte"
              )
            }
          >
            Tipos reporte
          </button>
        </div>
      </section>

      {/* =========================================================
          3. WALLET
         ========================================================= */}
      <section className="card space-y-2">
        <p className="text-xs font-semibold uppercase text-gray-500">
          3. Wallet / Billetera
        </p>
        <div className="flex flex-wrap gap-2 text-xs">
          <button
            className="btn-secondary"
            onClick={() =>
              callApi("Wallet", "GET /wallet/mis-creditos", "/wallet/mis-creditos")
            }
          >
            Mis cr√©ditos
          </button>
          <button
            className="btn-secondary"
            onClick={() =>
              callApi(
                "Wallet",
                "GET /wallet/mis-movimientos",
                "/wallet/mis-movimientos"
              )
            }
          >
            Mis movimientos
          </button>
          <button
            className="btn-secondary"
            onClick={() =>
              callApi("Wallet", "GET /wallet/compras", "/wallet/compras")
            }
          >
            Mis compras
          </button>
        </div>

        <div className="grid gap-2 md:grid-cols-4 text-xs mt-3">
          <div>
            <label className="block mb-1 font-medium">ID Paquete</label>
            <input
              type="number"
              value={idPaquete}
              onChange={(e) => setIdPaquete(e.target.value)}
              className="w-full border rounded px-2 py-1"
            />
          </div>
          <div>
            <label className="block mb-1 font-medium">Monto pagado (Bs.)</label>
            <input
              type="number"
              value={montoPagado}
              onChange={(e) => setMontoPagado(e.target.value)}
              className="w-full border rounded px-2 py-1"
            />
          </div>
          <div>
            <label className="block mb-1 font-medium">Referencia pago</label>
            <input
              type="text"
              value={refPago}
              onChange={(e) => setRefPago(e.target.value)}
              className="w-full border rounded px-2 py-1"
            />
          </div>
                    <button
            className="btn-primary w-full"
            onClick={() =>
                callApi(
                "Wallet",
                "POST /wallet/compra-creditos",
                "/wallet/compra-creditos",
                {
                    method: "POST",
                    body: {
                    idPaquete: Number(idPaquete),
                    montoPagado: Number(montoPagado),
                    referenciaPago: refPago,
                    },
                }
                )
            }
            >
            Comprar cr√©ditos
            </button>

        </div>
      </section>

      {/* =========================================================
          4. PUBLICACIONES
         ========================================================= */}
      <section className="card space-y-2">
        <p className="text-xs font-semibold uppercase text-gray-500">
          4. Publicaciones
        </p>
        <div className="flex flex-wrap gap-2 text-xs">
          <button
            className="btn-secondary"
            onClick={() =>
              callApi("Publicaciones", "GET /publicaciones", "/publicaciones")
            }
          >
            Listar /publicaciones
          </button>
          <button
            className="btn-secondary"
            onClick={() =>
              callApi(
                "Publicaciones",
                "GET /publicaciones/mias",
                "/publicaciones/mias"
              )
            }
          >
            Mis publicaciones
          </button>
          <button
            className="btn-secondary"
            onClick={() =>
              callApi(
                "Publicaciones",
                "GET /publicaciones/busqueda?q=bici",
                "/publicaciones/busqueda?q=bici"
              )
            }
          >
            Buscar (q=bici)
          </button>
        </div>
        <p className="text-xs text-gray-500 mt-1">
          ‚ö†Ô∏è Para crear publicaciones de prueba con todos los campos (producto /
          servicio) es m√°s c√≥modo usar tu Postman o el m√≥dulo de publicaciones del
          frontend final. Aqu√≠ nos enfocamos en comprobar que los listados devuelven
          datos y no rompen.
        </p>
      </section>

      {/* =========================================================
          5. INTERCAMBIOS
         ========================================================= */}
      <section className="card space-y-2">
        <p className="text-xs font-semibold uppercase text-gray-500">
          5. Intercambios
        </p>
        <div className="flex flex-wrap gap-2 text-xs">
          <button
            className="btn-secondary"
            onClick={() =>
              callApi(
                "Intercambios",
                "GET /intercambios/mis-compras",
                "/intercambios/mis-compras"
              )
            }
          >
            Mis compras
          </button>
          <button
            className="btn-secondary"
            onClick={() =>
              callApi(
                "Intercambios",
                "GET /intercambios/mis-ventas",
                "/intercambios/mis-ventas"
              )
            }
          >
            Mis ventas
          </button>
        </div>

        <div className="grid gap-2 md:grid-cols-3 text-xs mt-3">
          <div>
            <label className="block mb-1 font-medium">ID Publicaci√≥n</label>
            <input
              type="number"
              value={idPublicacionInter}
              onChange={(e) => setIdPublicacionInter(e.target.value)}
              className="w-full border rounded px-2 py-1"
            />
          </div>
          <div>
            <label className="block mb-1 font-medium">
              Cr√©ditos a intercambiar
            </label>
            <input
              type="number"
              value={creditosInter}
              onChange={(e) => setCreditosInter(e.target.value)}
              className="w-full border rounded px-2 py-1"
            />
          </div>
          <div className="flex items-end">
            <button
              className="btn-primary w-full"
              onClick={() =>
                idPublicacionInter &&
                creditosInter &&
                callApi(
                  "Intercambios",
                  "POST /intercambios",
                  "/intercambios",
                  {
                    method: "POST",
                    body: {
                      id_publicacion: Number(idPublicacionInter),
                      creditos: Number(creditosInter),
                    },
                  }
                )
              }
            >
              Crear intercambio
            </button>
          </div>
        </div>
      </section>

      {/* =========================================================
          6. ACTIVIDADES SOSTENIBLES
         ========================================================= */}
      <section className="card space-y-2">
        <p className="text-xs font-semibold uppercase text-gray-500">
          6. Actividades sostenibles
        </p>
        <div className="flex flex-wrap gap-2 text-xs">
          <button
            className="btn-secondary"
            onClick={() =>
              callApi(
                "Actividades",
                "GET /actividades-sostenibles/mias",
                "/actividades-sostenibles/mias"
              )
            }
          >
            Mis actividades
          </button>
        </div>

        <div className="grid gap-2 md:grid-cols-4 text-xs mt-3">
          <div>
            <label className="block mb-1 font-medium">ID tipo actividad</label>
            <input
              type="number"
              value={idTipoAct}
              onChange={(e) => setIdTipoAct(e.target.value)}
              className="w-full border rounded px-2 py-1"
            />
          </div>
          <div>
            <label className="block mb-1 font-medium">Cr√©ditos otorgados</label>
            <input
              type="number"
              value={credAct}
              onChange={(e) => setCredAct(e.target.value)}
              className="w-full border rounded px-2 py-1"
            />
          </div>
          <div className="md:col-span-2">
            <label className="block mb-1 font-medium">Descripci√≥n</label>
            <input
              type="text"
              value={descAct}
              onChange={(e) => setDescAct(e.target.value)}
              className="w-full border rounded px-2 py-1"
            />
          </div>
          <div className="md:col-span-4 flex justify-end">
            <button
              className="btn-primary"
              onClick={() =>
                callApi(
                  "Actividades",
                  "POST /actividades-sostenibles",
                  "/actividades-sostenibles",
                  {
                    method: "POST",
                    body: {
                      id_tipo_actividad: Number(idTipoAct),
                      descripcion: descAct,
                      creditos_otorgados: Number(credAct),
                      evidencia_url: null,
                    },
                  }
                )
              }
            >
              Registrar actividad
            </button>
          </div>
        </div>
      </section>

      {/* =========================================================
          7. PUBLICIDAD / PROMOS / LOGROS / PREMIUM
         ========================================================= */}
      <section className="card space-y-2">
        <p className="text-xs font-semibold uppercase text-gray-500">
          7. Publicidad / Promos / Logros / Premium
        </p>
        <div className="flex flex-wrap gap-2 text-xs">
          <button
            className="btn-secondary"
            onClick={() =>
              callApi("Publicidad", "GET /publicidad", "/publicidad")
            }
          >
            Publicidad activa
          </button>
          <button
            className="btn-secondary"
            onClick={() =>
              callApi(
                "Promociones",
                "GET /promociones/vigentes",
                "/promociones/vigentes"
              )
            }
          >
            Promos vigentes
          </button>
          <button
            className="btn-secondary"
            onClick={() =>
              callApi("Logros", "GET /logros/mis-logros", "/logros/mis-logros")
            }
          >
            Mis logros
          </button>
          <button
            className="btn-secondary"
            onClick={() =>
              callApi("Premium", "GET /premium/mi-plan", "/premium/mi-plan")
            }
          >
            Mi plan premium
          </button>
        </div>
      </section>

      {/* =========================================================
          8. REPORTES
         ========================================================= */}
      <section className="card space-y-2">
        <p className="text-xs font-semibold uppercase text-gray-500">
          8. Reportes (ADMIN)
        </p>

        <div className="grid gap-2 md:grid-cols-3 text-xs">
          <div>
            <label className="block mb-1 font-medium">Desde</label>
            <input
              type="date"
              value={desdeRep}
              onChange={(e) => setDesdeRep(e.target.value)}
              className="w-full border rounded px-2 py-1"
            />
          </div>
          <div>
            <label className="block mb-1 font-medium">Hasta</label>
            <input
              type="date"
              value={hastaRep}
              onChange={(e) => setHastaRep(e.target.value)}
              className="w-full border rounded px-2 py-1"
            />
          </div>
        </div>

        <div className="flex flex-wrap gap-2 text-xs mt-3">
          <button
            className="btn-secondary"
            onClick={() =>
              callApi(
                "Reportes",
                "GET /reportes/usuarios-activos",
                `/reportes/usuarios-activos?desde=${desdeRep}&hasta=${hastaRep}`
              )
            }
          >
            Usuarios activos
          </button>
          <button
            className="btn-secondary"
            onClick={() =>
              callApi(
                "Reportes",
                "GET /reportes/usuarios-abandonados",
                `/reportes/usuarios-abandonados?desde=${desdeRep}&hasta=${hastaRep}`
              )
            }
          >
            Usuarios abandonados
          </button>
          <button
            className="btn-secondary"
            onClick={() =>
              callApi(
                "Reportes",
                "GET /reportes/ingresos-creditos",
                `/reportes/ingresos-creditos?desde=${desdeRep}&hasta=${hastaRep}`
              )
            }
          >
            Ingresos cr√©ditos
          </button>
          <button
            className="btn-secondary"
            onClick={() =>
              callApi(
                "Reportes",
                "GET /reportes/creditos-generados-consumidos",
                `/reportes/creditos-generados-consumidos?desde=${desdeRep}&hasta=${hastaRep}`
              )
            }
          >
            Cr√©ditos gen. vs cons.
          </button>
          <button
            className="btn-secondary"
            onClick={() =>
              callApi(
                "Reportes",
                "GET /reportes/intercambios-categoria",
                `/reportes/intercambios-categoria?desde=${desdeRep}&hasta=${hastaRep}`
              )
            }
          >
            Intercambios x categor√≠a
          </button>
          <button
            className="btn-secondary"
            onClick={() =>
              callApi(
                "Reportes",
                "GET /reportes/publicaciones-intercambios",
                `/reportes/publicaciones-intercambios?desde=${desdeRep}&hasta=${hastaRep}`
              )
            }
          >
            Publ. vs intercambios
          </button>
          <button
            className="btn-secondary"
            onClick={() =>
                callApi(
                "Reportes",
                "GET /reportes/impacto-acumulado",
                `/reportes/impacto-acumulado?id_tipo_reporte=1&id_periodo=1`
                )
            }
            >
            Impacto acumulado
</button>

          <button
  className="btn-secondary"
  onClick={() =>
    callApi(
      "Reportes",
      "GET /reportes/ranking-usuarios",
      `/reportes/ranking-usuarios?id_periodo=1&limit=10`
    )
  }
>
  Ranking usuarios
</button>

        </div>
      </section>

      {/* =========================================================
          9. REQUEST MANUAL
         ========================================================= */}
      <section className="card space-y-2">
        <p className="text-xs font-semibold uppercase text-gray-500">
          9. Request manual (cualquier endpoint)
        </p>
        <form onSubmit={handleManualCall} className="space-y-2 text-xs">
          <div className="flex gap-2">
            <select
              value={manualMethod}
              onChange={(e) => setManualMethod(e.target.value)}
              className="border rounded px-2 py-1"
            >
              <option>GET</option>
              <option>POST</option>
              <option>PUT</option>
              <option>PATCH</option>
              <option>DELETE</option>
            </select>
            <input
              type="text"
              value={manualPath}
              onChange={(e) => setManualPath(e.target.value)}
              className="flex-1 border rounded px-2 py-1"
              placeholder="/ruta/del/endpoint"
            />
            <button type="submit" className="btn-primary">
              Ejecutar
            </button>
          </div>
          {manualMethod !== "GET" && (
            <textarea
              rows={4}
              value={manualBody}
              onChange={(e) => setManualBody(e.target.value)}
              className="w-full border rounded px-2 py-1 font-mono"
            />
          )}
        </form>
      </section>

      {/* =========================================================
          PANEL DE RESULTADOS
         ========================================================= */}
      <section className="card space-y-2">
        <p className="text-xs font-semibold uppercase text-gray-500">
          Resultado de la √∫ltima llamada
        </p>

        {lastRequest ? (
          <div className="text-xs space-y-1">
            <p>
              <span className="font-semibold">M√≥dulo:</span>{" "}
              {lastRequest.moduleName}
            </p>
            <p>
              <span className="font-semibold">Acci√≥n:</span>{" "}
              {lastRequest.actionName}
            </p>
            <p>
              <span className="font-semibold">M√©todo:</span>{" "}
              {lastRequest.method}
            </p>
            <p>
              <span className="font-semibold">URL:</span>{" "}
              <code>{lastRequest.url}</code>
            </p>
            {lastRequest.body && (
              <details className="mt-1">
                <summary className="cursor-pointer text-gray-600">
                  Body enviado
                </summary>
                <pre className="bg-gray-50 border rounded p-2 mt-1 overflow-x-auto">
{JSON.stringify(lastRequest.body, null, 2)}
                </pre>
              </details>
            )}
          </div>
        ) : (
          <p className="text-xs text-gray-400">
            A√∫n no ejecutaste ninguna llamada.
          </p>
        )}

        {lastResponse && (
          <div className="mt-3 text-xs">
            <p>
              <span className="font-semibold">Status:</span>{" "}
              {lastResponse.status}{" "}
              {lastResponse.ok ? "(OK)" : "(Error)"}
            </p>
            <details className="mt-1" open>
              <summary className="cursor-pointer text-gray-600">
                Ver JSON de respuesta
              </summary>
              <pre className="bg-gray-50 border rounded p-2 mt-1 overflow-x-auto">
{JSON.stringify(lastResponse.data, null, 2)}
              </pre>
            </details>
          </div>
        )}
      </section>
    </div>
  );
}
</file>

<file path="frontend/src/pages/Home.jsx">
// frontend/src/pages/Home.jsx
import React, { useEffect, useState } from "react";
import { Link } from "react-router-dom";
import { getHealth } from "../services/api.js";

export default function Home() {
  const [health, setHealth] = useState(null);
  const [error, setError] = useState("");

  useEffect(() => {
    let isMounted = true;

    getHealth()
      .then((data) => {
        if (isMounted) setHealth(data);
      })
      .catch((err) => {
        if (isMounted) setError(err.message || "Error consultando API");
      });

    return () => {
      isMounted = false;
    };
  }, []);

  return (
    <div className="space-y-4">
      {/* HEADER */}
      <section className="flex flex-col sm:flex-row justify-between gap-3 items-start sm:items-center">
        <div>
          <h2 className="text-xl font-semibold text-gray-900">
            Bienvenido al panel
          </h2>
          <p className="text-sm text-gray-500">
            Aqu√≠ ir√°n las tarjetas de saldo, publicaciones, estad√≠sticas, etc.
          </p>
        </div>
      </section>

      {/* TARJETAS DEL HOME */}
      <section className="grid gap-4 md:grid-cols-3">
        {/* TARJETA: ESTADO API */}
        <div className="card">
          <p className="text-xs font-medium text-gray-500 uppercase tracking-wide mb-1">
            Estado de la API
          </p>
          {error && (
            <p className="text-sm text-red-600">
              Error: <span className="font-medium">{error}</span>
            </p>
          )}
          {!error && !health && (
            <p className="text-sm text-gray-500">Verificando API‚Ä¶</p>
          )}
          {health && (
            <div className="space-y-1 text-sm">
              <p>
                <span className="font-medium">ok:</span>{" "}
                {String(health.ok ?? health.status ?? "desconocido")}
              </p>
              {health.env && (
                <p>
                  <span className="font-medium">Entorno:</span> {health.env}
                </p>
              )}
            </div>
          )}
        </div>

        {/* TARJETA: CR√âDITOS */}
        <div className="card">
          <p className="text-xs font-medium text-gray-500 uppercase tracking-wide mb-1">
            Cr√©ditos
          </p>
          <p className="text-sm text-gray-500">
            Aqu√≠ puedes mostrar el saldo de cr√©ditos de la billetera del
            usuario.
          </p>
        </div>

        {/* TARJETA: ACTIVIDAD RECIENTE */}
        <div className="card">
          <p className="text-xs font-medium text-gray-500 uppercase tracking-wide mb-1">
            Actividad reciente
          </p>
          <p className="text-sm text-gray-500">
            Listado de √∫ltimas publicaciones, intercambios, etc.
          </p>
        </div>
        
          <Link
            to="/backend-lab"
            className="card hover:shadow-md transition"
          >
            <p className="text-xs font-medium text-gray-500 uppercase mb-1">
              Laboratorio Backend
            </p>
            <p className="text-sm font-semibold">
              Probar todos los m√≥dulos (QA)
            </p>
            <p className="text-xs text-gray-500 mt-1">
              Registro, login, wallet, publicaciones, intercambios, actividades,
              reportes y m√°s desde una sola pantalla.
            </p>
          </Link>

        {/* ‚≠ê NUEVA TARJETA: REPORTES ‚≠ê */}
        <div className="card flex flex-col justify-between">
          <div>
            <p className="text-xs font-medium text-gray-500 uppercase tracking-wide mb-1">
              Reportes
            </p>
            <p className="text-sm text-gray-500">
              Accede a reportes de actividad, cr√©ditos e impacto ambiental.
            </p>
          </div>

          <div className="mt-3">
            <Link
              to="/reportes"
              className="text-blue-600 hover:text-blue-800 text-sm font-medium"
            >
              Ver reportes ‚Üí
            </Link>
          </div>
        </div>
      </section>
    </div>
  );
}
</file>

<file path="frontend/src/pages/Login.jsx">
// frontend/src/pages/Login.jsx
import React, { useState, useEffect } from "react";
import { useNavigate, Link } from "react-router-dom";
import { login } from "../services/api";
import hojaLogo from "../assets/hoja.png";

const SLIDES = [
  {
    id: 1,
    title: "Crea una cuenta en Digital Barter",
    text: "Obt√©n 5 monedas Green Credits por tu primera sesi√≥n.",
    image:
      "https://images.pexels.com/photos/3184339/pexels-photo-3184339.jpeg?auto=compress&cs=tinysrgb&w=1600",
  },
  {
    id: 2,
    title: "Intercambia productos y servicios",
    text: "Ahorra dinero mientras ayudas al planeta.",
    image:
      "https://images.pexels.com/photos/3184291/pexels-photo-3184291.jpeg?auto=compress&cs=tinysrgb&w=1600",
  },
  {
    id: 3,
    title: "Gana Green Credits",
    text: "Recibe cr√©ditos verdes por cada intercambio sostenible.",
    image:
      "https://images.pexels.com/photos/8867432/pexels-photo-8867432.jpeg?auto=compress&cs=tinysrgb&w=1600",
  },
];

export default function Login() {
  const [correo, setCorreo] = useState("");
  const [password, setPassword] = useState("");
  const [error, setError] = useState("");
  const [loading, setLoading] = useState(false);

  const [slideIndex, setSlideIndex] = useState(0);

  const navigate = useNavigate();

  useEffect(() => {
    const id = setInterval(() => {
      setSlideIndex((prev) => (prev + 1) % SLIDES.length);
    }, 5000);
    return () => clearInterval(id);
  }, []);

  async function handleSubmit(e) {
    e.preventDefault();
    setError("");

    if (!correo || !password) {
      setError("Debes ingresar correo y contrase√±a.");
      return;
    }

    try {
      setLoading(true);
      const data = await login({ correo, password });

      if (!data?.token) {
        setError("No se recibi√≥ el token de autenticaci√≥n.");
        return;
      }

      // Despu√©s del login te llevo a tu flujo de reportes
      navigate("/reportes/usuarios-activos");
    } catch (err) {
      console.error(err);
      setError(err.message || "Credenciales inv√°lidas");
    } finally {
      setLoading(false);
    }
  }

  const currentSlide = SLIDES[slideIndex];

  return (
    <div className="min-h-screen bg-gradient-to-br from-[#012b20] via-[#013726] to-[#011711] text-white flex flex-col">
      {/* NAVBAR SUPERIOR */}
      <header className="flex items-center justify-between px-10 py-4">
        <div className="flex items-center gap-3">
          <div className="flex items-center justify-center w-10 h-10 rounded-full bg-white/10">
            <img
              src={hojaLogo}
              alt="Logo Digital Barter"
              className="w-7 h-7 object-contain"
            />
          </div>
          <div>
            <h1 className="text-2xl font-black leading-tight tracking-tight">
              Digital Barter
            </h1>
            <p className="text-sm text-green-300 font-semibold flex items-center gap-1">
              green credits
              <span className="inline-block w-2 h-2 rounded-full bg-green-400" />
            </p>
          </div>
        </div>

        <Link
          to="/register"
          className="px-5 py-2 rounded-full bg-white text-green-900 font-semibold text-sm hover:bg-gray-100 transition"
        >
          Crear Cuenta
        </Link>
      </header>

      {/* CONTENIDO PRINCIPAL */}
      <main className="flex-1 flex flex-col lg:flex-row items-center justify-center gap-10 px-6 lg:px-16 pb-10">
        {/* PANEL IZQUIERDO: CARRUSEL */}
        <section className="w-full max-w-md bg-black/20 rounded-3xl overflow-hidden shadow-2xl">
          <div className="relative h-80">
            <img
              src={currentSlide.image}
              alt={currentSlide.title}
              className="w-full h-full object-cover"
            />
            <div className="absolute inset-0 bg-gradient-to-t from-black/70 via-black/20 to-transparent" />
            <div className="absolute inset-0 flex flex-col justify-end p-6">
              <h2 className="text-xl font-bold mb-2">{currentSlide.title}</h2>
              <p className="text-sm text-gray-200 mb-4">{currentSlide.text}</p>

              {/* Puntos del carrusel */}
              <div className="flex gap-2">
                {SLIDES.map((s, idx) => (
                  <button
                    key={s.id}
                    onClick={() => setSlideIndex(idx)}
                    className={`w-2.5 h-2.5 rounded-full ${
                      idx === slideIndex ? "bg-white" : "bg-white/40"
                    }`}
                    aria-label={`Ir al slide ${idx + 1}`}
                  />
                ))}
              </div>
            </div>
          </div>
        </section>

        {/* PANEL DERECHO: FORM LOGIN */}
        <section className="w-full max-w-md bg-white/5 backdrop-blur-md rounded-3xl p-8 shadow-2xl">
          <h2 className="text-2xl font-bold mb-2 text-center">
            Iniciar sesi√≥n
          </h2>
          <p className="text-sm text-gray-200 mb-6 text-center">
            Ingresa para gestionar tus Green Credits.
          </p>

          {error && (
            <div className="mb-4 bg-red-500/20 border border-red-400 text-sm px-3 py-2 rounded-lg">
              {error}
            </div>
          )}

          <form className="space-y-4" onSubmit={handleSubmit}>
            <div>
              <label className="block text-sm mb-1">
                Correo electr√≥nico o n√∫mero de tel√©fono
              </label>
              <input
                type="text"
                value={correo}
                onChange={(e) => setCorreo(e.target.value)}
                className="w-full rounded-lg px-3 py-2 bg-white/10 border border-white/20 text-sm placeholder:text-gray-300 focus:outline-none focus:ring-2 focus:ring-green-400"
                placeholder="tucorreo@email.com"
              />
            </div>

            <div>
              <label className="block text-sm mb-1">Contrase√±a</label>
              <input
                type="password"
                value={password}
                onChange={(e) => setPassword(e.target.value)}
                className="w-full rounded-lg px-3 py-2 bg-white/10 border border-white/20 text-sm placeholder:text-gray-300 focus:outline-none focus:ring-2 focus:ring-green-400"
                placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
              />
            </div>

            <div className="flex justify-end text-xs text-gray-300 mb-1">
              <button
                type="button"
                className="hover:underline"
                onClick={() => alert("En el futuro aqu√≠ ir√° el flujo de recuperar contrase√±a.")}
              >
                ¬øHas olvidado tu contrase√±a?
              </button>
            </div>

            <button
              type="submit"
              disabled={loading}
              className="w-full mt-2 bg-[#0a8f44] hover:bg-[#0cb652] disabled:opacity-60 disabled:cursor-not-allowed text-white font-semibold py-2.5 rounded-full text-sm transition"
            >
              {loading ? "Ingresando..." : "Iniciar sesi√≥n"}
            </button>
          </form>

          <p className="mt-6 text-xs text-center text-gray-200">
            ¬øNo tienes cuenta?{" "}
            <Link to="/register" className="font-semibold underline">
              Crear una cuenta
            </Link>
          </p>
        </section>
      </main>

      <footer className="text-xs text-gray-300 text-center pb-4">
        ¬°Un poco m√°s sobre nosotros!
      </footer>
    </div>
  );
}
</file>

<file path="frontend/src/pages/NotFound.jsx">
import React from "react";
import { Link } from "react-router-dom";

export default function NotFound() {
  return (
    <div className="min-h-screen flex flex-col items-center justify-center bg-gray-100">
      <div className="bg-white px-6 py-5 rounded-lg shadow-sm border border-gray-200 text-center max-w-sm">
        <h1 className="text-3xl font-bold text-gray-900 mb-2">404</h1>
        <p className="text-sm text-gray-500 mb-4">
          La p√°gina que buscas no existe.
        </p>
        <Link to="/home" className="btn-primary">
          Volver al inicio
        </Link>
      </div>
    </div>
  );
}
</file>

<file path="frontend/src/pages/Register.jsx">
// frontend/src/pages/Register.jsx
import React, { useState, useEffect } from "react";
import { Link, useNavigate } from "react-router-dom";
import { register } from "../services/api";
import hojaLogo from "../assets/hoja.png";

const SLIDES = [
  {
    id: 1,
    title: "Crea una cuenta en Digital Barter",
    text: "Empieza a ganar Green Credits desde hoy.",
    image:
      "https://images.pexels.com/photos/3184328/pexels-photo-3184328.jpeg?auto=compress&cs=tinysrgb&w=1600",
  },
  {
    id: 2,
    title: "Comparte y reutiliza",
    text: "Publica productos y servicios que ya no usas.",
    image:
      "https://images.pexels.com/photos/3738088/pexels-photo-3738088.jpeg?auto=compress&cs=tinysrgb&w=1600",
  },
  {
    id: 3,
    title: "Impacto ambiental positivo",
    text: "Reduce CO‚ÇÇ, agua y energ√≠a con cada intercambio.",
    image:
      "https://images.pexels.com/photos/286763/pexels-photo-286763.jpeg?auto=compress&cs=tinysrgb&w=1600",
  },
];

export default function Register() {
  const [nombre, setNombre] = useState("");
  const [apellidos, setApellidos] = useState("");
  const [correo, setCorreo] = useState("");
  const [telefono, setTelefono] = useState("");
  const [password, setPassword] = useState("");
  const [password2, setPassword2] = useState("");

  const [dia, setDia] = useState("1");
  const [mes, setMes] = useState("ene.");
  const [anio, setAnio] = useState("2000");
  const [genero, setGenero] = useState("Hombre");

  const [error, setError] = useState("");
  const [ok, setOk] = useState("");
  const [loading, setLoading] = useState(false);
  const [slideIndex, setSlideIndex] = useState(0);

  const navigate = useNavigate();

  useEffect(() => {
    const id = setInterval(
      () => setSlideIndex((prev) => (prev + 1) % SLIDES.length),
      5000
    );
    return () => clearInterval(id);
  }, []);

  const currentSlide = SLIDES[slideIndex];

  async function handleSubmit(e) {
    e.preventDefault();
    setError("");
    setOk("");

    if (!nombre || !correo || !password || !password2) {
      setError("Nombre, correo y contrase√±as son obligatorios.");
      return;
    }

    if (password !== password2) {
      setError("Las contrase√±as no coinciden.");
      return;
    }

    try {
      setLoading(true);
      await register({
        nombre,
        apellido: apellidos,
        correo,
        password,
        telefono: telefono || undefined,
      });

      setOk("Cuenta creada correctamente. Ahora puedes iniciar sesi√≥n.");
      // Opcional: enviarte de una vez al login
      navigate("/login");
    } catch (err) {
      console.error(err);
      setError(err.message || "No se pudo registrar el usuario.");
    } finally {
      setLoading(false);
    }
  }

  const dias = Array.from({ length: 31 }, (_, i) => String(i + 1));
  const anios = Array.from({ length: 80 }, (_, i) =>
    String(2025 - i)
  );

  return (
    <div className="min-h-screen bg-gradient-to-br from-[#012b20] via-[#013726] to-[#011711] text-white flex flex-col">
      {/* NAVBAR SUPERIOR */}
      <header className="flex items-center justify-between px-10 py-4">
        <div className="flex items-center gap-3">
          <div className="flex items-center justify-center w-10 h-10 rounded-full bg-white/10">
            <img
              src={hojaLogo}
              alt="Logo Digital Barter"
              className="w-7 h-7 object-contain"
            />
          </div>
          <div>
            <h1 className="text-2xl font-black leading-tight tracking-tight">
              Digital Barter
            </h1>
            <p className="text-sm text-green-300 font-semibold flex items-center gap-1">
              green credits
              <span className="inline-block w-2 h-2 rounded-full bg-green-400" />
            </p>
          </div>
        </div>

        <Link
          to="/login"
          className="px-5 py-2 rounded-full bg-white text-green-900 font-semibold text-sm hover:bg-gray-100 transition"
        >
          Iniciar sesi√≥n
        </Link>
      </header>

      {/* CONTENIDO PRINCIPAL */}
      <main className="flex-1 flex flex-col lg:flex-row items-center justify-center gap-10 px-6 lg:px-16 pb-10">
        {/* PANEL IZQUIERDO: CARRUSEL */}
        <section className="w-full max-w-md bg-black/20 rounded-3xl overflow-hidden shadow-2xl">
          <div className="relative h-80">
            <img
              src={currentSlide.image}
              alt={currentSlide.title}
              className="w-full h-full object-cover"
            />
            <div className="absolute inset-0 bg-gradient-to-t from-black/70 via-black/20 to-transparent" />
            <div className="absolute inset-0 flex flex-col justify-end p-6">
              <h2 className="text-xl font-bold mb-2">{currentSlide.title}</h2>
              <p className="text-sm text-gray-200 mb-4">{currentSlide.text}</p>
              <div className="flex gap-2">
                {SLIDES.map((s, idx) => (
                  <button
                    key={s.id}
                    onClick={() => setSlideIndex(idx)}
                    className={`w-2.5 h-2.5 rounded-full ${
                      idx === slideIndex ? "bg-white" : "bg-white/40"
                    }`}
                  />
                ))}
              </div>
            </div>
          </div>
        </section>

        {/* PANEL DERECHO: FORM REGISTRO */}
        <section className="w-full max-w-md bg-white/5 backdrop-blur-md rounded-3xl p-8 shadow-2xl">
          <h2 className="text-2xl font-bold mb-2 text-center">Crea una Cuenta</h2>

          {error && (
            <div className="mb-4 bg-red-500/20 border border-red-400 text-sm px-3 py-2 rounded-lg">
              {error}
            </div>
          )}
          {ok && (
            <div className="mb-4 bg-green-500/20 border border-green-400 text-sm px-3 py-2 rounded-lg">
              {ok}
            </div>
          )}

          <form className="space-y-4" onSubmit={handleSubmit}>
            {/* Nombre y apellidos */}
            <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
              <div>
                <label className="block text-sm mb-1">Nombre</label>
                <input
                  type="text"
                  value={nombre}
                  onChange={(e) => setNombre(e.target.value)}
                  className="w-full rounded-lg px-3 py-2 bg-white/10 border border-white/20 text-sm focus:outline-none focus:ring-2 focus:ring-green-400"
                  placeholder="Nombre"
                />
              </div>
              <div>
                <label className="block text-sm mb-1">Apellidos</label>
                <input
                  type="text"
                  value={apellidos}
                  onChange={(e) => setApellidos(e.target.value)}
                  className="w-full rounded-lg px-3 py-2 bg-white/10 border border-white/20 text-sm focus:outline-none focus:ring-2 focus:ring-green-400"
                  placeholder="Apellidos"
                />
              </div>
            </div>

            {/* Fecha de nacimiento */}
            <div>
              <p className="text-xs mb-1">Fecha de nacimiento</p>
              <div className="grid grid-cols-3 gap-2">
                <select
                  value={dia}
                  onChange={(e) => setDia(e.target.value)}
                  className="rounded-lg px-2 py-2 bg-white/10 border border-white/20 text-sm"
                >
                  {dias.map((d) => (
                    <option key={d} value={d}>
                      {d}
                    </option>
                  ))}
                </select>

                <select
                  value={mes}
                  onChange={(e) => setMes(e.target.value)}
                  className="rounded-lg px-2 py-2 bg-white/10 border border-white/20 text-sm"
                >
                  <option>ene.</option>
                  <option>feb.</option>
                  <option>mar.</option>
                  <option>abr.</option>
                  <option>may.</option>
                  <option>jun.</option>
                  <option>jul.</option>
                  <option>ago.</option>
                  <option>sept.</option>
                  <option>oct.</option>
                  <option>nov.</option>
                  <option>dic.</option>
                </select>

                <select
                  value={anio}
                  onChange={(e) => setAnio(e.target.value)}
                  className="rounded-lg px-2 py-2 bg-white/10 border border-white/20 text-sm"
                >
                  {anios.map((a) => (
                    <option key={a} value={a}>
                      {a}
                    </option>
                  ))}
                </select>
              </div>
            </div>

            {/* G√©nero */}
            <div>
              <p className="text-xs mb-1">G√©nero</p>
              <div className="flex gap-3">
                <button
                  type="button"
                  onClick={() => setGenero("Hombre")}
                  className={`flex-1 flex items-center justify-center gap-2 px-3 py-2 rounded-full border text-sm ${
                    genero === "Hombre"
                      ? "bg-green-500 border-green-400"
                      : "bg-white/10 border-white/20"
                  }`}
                >
                  <span
                    className={`w-3 h-3 rounded-full border ${
                      genero === "Hombre"
                        ? "bg-white border-white"
                        : "bg-transparent border-white"
                    }`}
                  />
                  Hombre
                </button>
                <button
                  type="button"
                  onClick={() => setGenero("Mujer")}
                  className={`flex-1 flex items-center justify-center gap-2 px-3 py-2 rounded-full border text-sm ${
                    genero === "Mujer"
                      ? "bg-green-500 border-green-400"
                      : "bg-white/10 border-white/20"
                  }`}
                >
                  <span
                    className={`w-3 h-3 rounded-full border ${
                      genero === "Mujer"
                        ? "bg-white border-white"
                        : "bg-transparent border-white"
                    }`}
                  />
                  Mujer
                </button>
              </div>
            </div>

            {/* Contacto */}
            <div>
              <label className="block text-sm mb-1">
                N√∫mero de m√≥vil o correo electr√≥nico
              </label>
              <input
                type="text"
                value={correo}
                onChange={(e) => setCorreo(e.target.value)}
                className="w-full rounded-lg px-3 py-2 bg-white/10 border border-white/20 text-sm focus:outline-none focus:ring-2 focus:ring-green-400"
                placeholder="correo@ejemplo.com"
              />
            </div>

            <div>
              <label className="block text-sm mb-1">Tel√©fono (opcional)</label>
              <input
                type="tel"
                value={telefono}
                onChange={(e) => setTelefono(e.target.value)}
                className="w-full rounded-lg px-3 py-2 bg-white/10 border border-white/20 text-sm focus:outline-none focus:ring-2 focus:ring-green-400"
                placeholder="+591 70000000"
              />
            </div>

            {/* Contrase√±as */}
            <div>
              <label className="block text-sm mb-1">Contrase√±a</label>
              <input
                type="password"
                value={password}
                onChange={(e) => setPassword(e.target.value)}
                className="w-full rounded-lg px-3 py-2 bg-white/10 border border-white/20 text-sm focus:outline-none focus:ring-2 focus:ring-green-400"
                placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
              />
            </div>
            <div>
              <label className="block text-sm mb-1">Confirmar contrase√±a</label>
              <input
                type="password"
                value={password2}
                onChange={(e) => setPassword2(e.target.value)}
                className="w-full rounded-lg px-3 py-2 bg-white/10 border border-white/20 text-sm focus:outline-none focus:ring-2 focus:ring-green-400"
                placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
              />
            </div>

            <button
              type="submit"
              disabled={loading}
              className="w-full mt-2 bg-[#0a8f44] hover:bg-[#0cb652] disabled:opacity-60 disabled:cursor-not-allowed text-white font-semibold py-2.5 rounded-full text-sm transition"
            >
              {loading ? "Registrando..." : "Registrar"}
            </button>
          </form>
        </section>
      </main>

      <footer className="text-xs text-gray-300 text-center pb-4">
        ¬°Un poco m√°s sobre nosotros!
      </footer>
    </div>
  );
}
</file>

<file path="frontend/src/pages/Reportes.jsx">
// frontend/src/pages/Reportes.jsx
import { Link } from "react-router-dom";

const reportesList = [
  {
    path: "/reportes/usuarios",
    title: "Usuarios activos y abandonados",
    description: "Qui√©nes est√°n usando la plataforma y qui√©nes no.",
  },
  {
    path: "/reportes/ingresos-creditos",
    title: "Ingresos por venta de cr√©ditos",
    description: "Cr√©ditos vendidos e ingresos en bolivianos.",
  },
  {
    path: "/reportes/creditos-generados-consumidos",
    title: "Cr√©ditos generados vs consumidos",
    description: "Balance global de cr√©ditos generados y consumidos.",
  },
  {
    path: "/reportes/intercambios-categoria",
    title: "Intercambios por categor√≠a",
    description: "Qu√© categor√≠as tienen m√°s movimiento en los intercambios.",
  },
  {
    path: "/reportes/publicaciones-intercambios",
    title: "Publicaciones vs intercambios",
    description: "Relaci√≥n entre lo publicado y lo que realmente se intercambia.",
  },
  {
    path: "/reportes/impacto-acumulado",
    title: "Impacto ambiental acumulado",
    description: "CO‚ÇÇ, agua y energ√≠a ahorrados en un per√≠odo.",
  },
  {
    path: "/reportes/ranking-usuarios",
    title: "Ranking de usuarios por impacto",
    description: "Top de usuarios seg√∫n su impacto ambiental.",
  },
  {
    path: "/reportes/usuarios-premium",
    title: "Usuarios Premium",
    description: "Adopci√≥n, actividad e ingresos por suscripciones premium.",
  },
  {
    path: "/reportes/saldos-usuarios",
    title: "Saldos de cr√©ditos por usuario",
    description: "Cr√©ditos disponibles actualmente en las billeteras.",
  },
  {
    path: "/reportes/actividades-sostenibles",
    title: "Actividades sostenibles",
    description: "Acciones ecol√≥gicas registradas por los usuarios.",
  },
  {
    path: "/reportes/impacto-categoria",
    title: "Impacto ambiental por categor√≠a",
    description: "Impacto ecol√≥gico agrupado por categor√≠a de publicaci√≥n.",
  },
];

export default function Reportes() {
  return (
    <div className="p-4 space-y-6">
      {/* Header */}
      <header className="flex flex-col gap-3 md:flex-row md:items-center md:justify-between">
        <div>
          <h1 className="text-2xl font-bold">Reportes</h1>
          <p className="text-sm text-gray-500">
            Explora los reportes disponibles o abre el dashboard completo.
          </p>
        </div>

        <Link
          to="/reportes-dashboard"
          className="inline-flex items-center justify-center bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded text-sm font-medium transition"
        >
          Ver dashboard completo
        </Link>
      </header>

      {/* Tarjetas de reportes */}
      <section className="grid gap-4 md:grid-cols-2 xl:grid-cols-3">
        {reportesList.map((rep, idx) => (
          <div
            key={idx}
            className="border rounded-lg p-4 bg-white shadow-sm flex flex-col justify-between hover:shadow-md transition"
          >
            <div>
              <h2 className="font-semibold text-lg mb-1">{rep.title}</h2>
              <p className="text-sm text-gray-500 mb-3">{rep.description}</p>
            </div>

            <div className="flex justify-end">
              <Link
                to={rep.path}
                className="text-blue-600 hover:text-blue-800 text-sm font-medium"
              >
                Ver detalle ‚Üí
              </Link>
            </div>
          </div>
        ))}
      </section>
    </div>
  );
}
</file>

<file path="frontend/src/pages/ReportesActividadesSostenibles.jsx">
import React, { useEffect, useState } from "react";
import { getReporteActividadesSostenibles } from "../services/api";

function hoyISO() {
  return new Date().toISOString().slice(0, 10);
}

function hace30DiasISO() {
  const d = new Date(Date.now() - 30 * 24 * 60 * 60 * 1000);
  return d.toISOString().slice(0, 10);
}

export default function ReportesActividadesSostenibles() {
  const [desde, setDesde] = useState(hace30DiasISO());
  const [hasta, setHasta] = useState(hoyISO());
  const [datos, setDatos] = useState([]);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState("");

  async function cargar() {
    try {
      setLoading(true);
      setError("");
      const res = await getReporteActividadesSostenibles({ desde, hasta });
      setDatos(Array.isArray(res) ? res : []);
    } catch (e) {
      console.error(e);
      setError("Error cargando actividades sostenibles");
      setDatos([]);
    } finally {
      setLoading(false);
    }
  }

  useEffect(() => {
    cargar();
  }, []);

  function handleSubmit(e) {
    e.preventDefault();
    cargar();
  }

  return (
    <div className="p-4 space-y-6">
      <header className="flex flex-col md:flex-row md:items-end md:justify-between gap-3">
        <div>
          <h1 className="text-2xl font-bold">
            Actividades sostenibles por usuario
          </h1>
          <p className="text-sm text-gray-500">
            Cantidad de actividades y cr√©ditos otorgados en el rango.
          </p>
        </div>

        <form
          onSubmit={handleSubmit}
          className="flex flex-wrap gap-2 items-end"
        >
          <div className="flex flex-col text-sm">
            <label className="mb-1 font-medium">Desde</label>
            <input
              type="date"
              value={desde}
              onChange={(e) => setDesde(e.target.value)}
              className="border rounded px-2 py-1 text-sm"
            />
          </div>
          <div className="flex flex-col text-sm">
            <label className="mb-1 font-medium">Hasta</label>
            <input
              type="date"
              value={hasta}
              onChange={(e) => setHasta(e.target.value)}
              className="border rounded px-2 py-1 text-sm"
            />
          </div>
          <button
            type="submit"
            className="bg-emerald-600 text-white px-3 py-1.5 rounded text-sm"
          >
            {loading ? "Cargando‚Ä¶" : "Actualizar"}
          </button>
        </form>
      </header>

      {error && (
        <div className="bg-red-50 border-red-200 border text-red-700 text-sm px-3 py-2 rounded">
          {error}
        </div>
      )}

      <section>
        <div className="overflow-x-auto border rounded bg-white">
          <table className="min-w-full text-sm">
            <thead className="bg-gray-100">
              <tr>
                <th className="px-2 py-1 text-left">Usuario</th>
                <th className="px-2 py-1 text-left">Correo</th>
                <th className="px-2 py-1 text-right">Total actividades</th>
                <th className="px-2 py-1 text-right">Cr√©ditos otorgados</th>
              </tr>
            </thead>
            <tbody>
              {datos.map((a, i) => (
                <tr key={i} className="border-t">
                  <td className="px-2 py-1">{a.nombre}</td>
                  <td className="px-2 py-1">{a.correo}</td>
                  <td className="px-2 py-1 text-right">
                    {a.total_actividades}
                  </td>
                  <td className="px-2 py-1 text-right">
                    {a.creditos_otorgados}
                  </td>
                </tr>
              ))}
              {datos.length === 0 && (
                <tr>
                  <td
                    className="px-2 py-2 text-center text-gray-400"
                    colSpan={4}
                  >
                    Sin actividades sostenibles en el rango.
                  </td>
                </tr>
              )}
            </tbody>
          </table>
        </div>
      </section>
    </div>
  );
}
</file>

<file path="frontend/src/pages/ReportesCreditosGeneradosConsumidos.jsx">
import React, { useEffect, useState } from "react";
import { getReporteCreditosGeneradosVsConsumidos } from "../services/api";

function hoyISO() {
  return new Date().toISOString().slice(0, 10);
}

function hace30DiasISO() {
  const d = new Date(Date.now() - 30 * 24 * 60 * 60 * 1000);
  return d.toISOString().slice(0, 10);
}

export default function ReportesCreditosGenerados() {
  const [desde, setDesde] = useState(hace30DiasISO());
  const [hasta, setHasta] = useState(hoyISO());
  const [resumen, setResumen] = useState(null);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState("");

  async function cargar() {
    try {
      setLoading(true);
      setError("");
      const res = await getReporteCreditosGeneradosVsConsumidos({
        desde,
        hasta,
      });
      setResumen(res || null);
    } catch (e) {
      console.error(e);
      setError("Error cargando resumen de cr√©ditos");
      setResumen(null);
    } finally {
      setLoading(false);
    }
  }

  useEffect(() => {
    cargar();
  }, []);

  function handleSubmit(e) {
    e.preventDefault();
    cargar();
  }

  return (
    <div className="p-4 space-y-6">
      <header className="flex flex-col md:flex-row md:items-end md:justify-between gap-3">
        <div>
          <h1 className="text-2xl font-bold">
            Cr√©ditos generados vs consumidos
          </h1>
          <p className="text-sm text-gray-500">
            Resumen global de cr√©ditos emitidos, gastados y saldo neto.
          </p>
        </div>

        <form
          onSubmit={handleSubmit}
          className="flex flex-wrap gap-2 items-end"
        >
          <div className="flex flex-col text-sm">
            <label className="mb-1 font-medium">Desde</label>
            <input
              type="date"
              value={desde}
              onChange={(e) => setDesde(e.target.value)}
              className="border rounded px-2 py-1 text-sm"
            />
          </div>
          <div className="flex flex-col text-sm">
            <label className="mb-1 font-medium">Hasta</label>
            <input
              type="date"
              value={hasta}
              onChange={(e) => setHasta(e.target.value)}
              className="border rounded px-2 py-1 text-sm"
            />
          </div>
          <button
            type="submit"
            className="bg-emerald-600 text-white px-3 py-1.5 rounded text-sm"
          >
            {loading ? "Cargando‚Ä¶" : "Actualizar"}
          </button>
        </form>
      </header>

      {error && (
        <div className="bg-red-50 border-red-200 border text-red-700 text-sm px-3 py-2 rounded">
          {error}
        </div>
      )}

      <section className="border rounded p-4 bg-white text-sm">
        {resumen ? (
          <ul className="space-y-1">
            <li>
              <span className="font-semibold">Cr√©ditos generados:</span>{" "}
              {resumen.creditos_generados}
            </li>
            <li>
              <span className="font-semibold">Cr√©ditos consumidos:</span>{" "}
              {resumen.creditos_consumidos}
            </li>
            <li>
              <span className="font-semibold">Saldo neto:</span>{" "}
              {resumen.saldo_neto}
            </li>
          </ul>
        ) : (
          <p className="text-gray-500">
            Sin datos de cr√©ditos generados/consumidos para el rango.
          </p>
        )}
      </section>
    </div>
  );
}
</file>

<file path="frontend/src/pages/ReportesDashboard.jsx">
import { useEffect, useState, useMemo } from "react";
import {
  getReporteUsuariosActivos,
  getReporteIngresosCreditos,
  getReporteCreditosGeneradosVsConsumidos,
  getReporteIntercambiosCategoria,
  getReportePublicacionesVsIntercambios,
  getReporteImpactoAcumulado,
} from "../services/api";

import {
  ResponsiveContainer,
  BarChart,
  Bar,
  XAxis,
  YAxis,
  CartesianGrid,
  Tooltip,
  Legend,
} from "recharts";

/* Utilidades */
function hoyISO() {
  return new Date().toISOString().slice(0, 10);
}

function hace30DiasISO() {
  const d = new Date(Date.now() - 30 * 24 * 60 * 60 * 1000);
  return d.toISOString().slice(0, 10);
}

const nf = new Intl.NumberFormat("es-BO");

export default function ReportesDashboard() {
  const [desde, setDesde] = useState(hace30DiasISO());
  const [hasta, setHasta] = useState(hoyISO());

  const [usuariosActivos, setUsuariosActivos] = useState([]);
  const [ingresos, setIngresos] = useState([]);
  const [intercambiosCat, setIntercambiosCat] = useState([]);
  const [pubVsInt, setPubVsInt] = useState([]);
  const [credResumen, setCredResumen] = useState(null);
  const [impacto, setImpacto] = useState([]);

  const [tipoReporte, setTipoReporte] = useState("2"); // mensual
  const [idPeriodo, setIdPeriodo] = useState("1");

  const [loading, setLoading] = useState(false);
  const [loadingImpacto, setLoadingImpacto] = useState(false);
  const [error, setError] = useState("");

/*     Carga de datos*/

  async function cargarDatosBasicos() {
    try {
      setLoading(true);
      setError("");

      const [activos, ing, cgvc, interc, pubInt] = await Promise.all([
        getReporteUsuariosActivos({ desde, hasta }),
        getReporteIngresosCreditos({ desde, hasta }),
        getReporteCreditosGeneradosVsConsumidos({ desde, hasta }),
        getReporteIntercambiosCategoria({ desde, hasta }),
        getReportePublicacionesVsIntercambios({ desde, hasta }),
      ]);

      setUsuariosActivos(Array.isArray(activos) ? activos : []);
      setIngresos(Array.isArray(ing) ? ing : []);
      setIntercambiosCat(Array.isArray(interc) ? interc : []);
      setPubVsInt(Array.isArray(pubInt) ? pubInt : []);
      setCredResumen(cgvc || null);
    } catch (e) {
      console.error(e);
      setError("Error cargando datos de reportes");
      setUsuariosActivos([]);
      setIngresos([]);
      setIntercambiosCat([]);
      setPubVsInt([]);
      setCredResumen(null);
    } finally {
      setLoading(false);
    }
  }

  async function cargarImpacto() {
    try {
      setLoadingImpacto(true);
      setError("");

      const datos = await getReporteImpactoAcumulado({
        idTipoReporte: tipoReporte,
        idPeriodo,
      });

      setImpacto(Array.isArray(datos) ? datos : []);
    } catch (e) {
      console.error(e);
      setError("Error cargando impacto ambiental");
      setImpacto([]);
    } finally {
      setLoadingImpacto(false);
    }
  }

  function onSubmitRango(e) {
    e.preventDefault();
    cargarDatosBasicos();
  }

  useEffect(() => {
    cargarDatosBasicos();
  }, []);

  /* Datos preparados para gr√°ficos */

  // Ingresos por d√≠a
  const ingresosChartData = useMemo(
    () =>
      ingresos.map((r) => ({
        fecha: r.fecha?.slice(0, 10) || "",
        total_bs: Number(r.total_bs ?? 0),
        total_creditos: Number(r.total_creditos ?? 0),
      })),
    [ingresos]
  );

  // Intercambios por categor√≠a
  const intercambiosChartData = useMemo(
    () =>
      intercambiosCat.map((c) => ({
        categoria: c.categoria,
        total_intercambios: Number(c.total_intercambios ?? 0),
      })),
    [intercambiosCat]
  );

  // Publicaciones vs intercambios
  const pubVsIntChartData = useMemo(
    () =>
      pubVsInt.map((p) => ({
        categoria: p.categoria,
        publicaciones: Number(p.publicaciones ?? 0),
        intercambios: Number(p.intercambios ?? 0),
      })),
    [pubVsInt]
  );

  // Cr√©ditos generados/consumidos/saldo
  const credChartData = useMemo(() => {
    if (!credResumen) return [];
    return [
      {
        nombre: "Generados",
        valor: Number(credResumen.creditos_generados ?? 0),
      },
      {
        nombre: "Consumidos",
        valor: Number(credResumen.creditos_consumidos ?? 0),
      },
      {
        nombre: "Saldo neto",
        valor: Number(credResumen.saldo_neto ?? 0),
      },
    ];
  }, [credResumen]);

  // Impacto ambiental por usuario
  const impactoChartData = useMemo(
    () =>
      impacto.map((r) => ({
        usuario: r.id_usuario ?? "GLOBAL",
        co2: Number(r.total_co2_ahorrado ?? 0),
        agua: Number(r.total_agua_ahorrada ?? 0),
        energia: Number(r.total_energia_ahorrada ?? 0),
      })),
    [impacto]
  );

  return (
    <div className="min-h-screen bg-slate-100 px-4 py-6 lg:px-8">
      {/* HEADER */}
      <header className="mb-6 flex flex-col gap-4 border-b border-slate-200 pb-4 md:flex-row md:items-end md:justify-between">
        <div>
          <h1 className="text-2xl font-semibold text-slate-900">
            Dashboard de reportes
          </h1>
          <p className="mt-1 text-sm text-slate-500">
            Actividad del sistema, cr√©ditos e impacto ambiental.
          </p>
          <p className="mt-1 text-xs text-slate-400">
            Rango seleccionado:{" "}
            <span className="font-medium text-slate-600">{desde}</span> ‚Äì{" "}
            <span className="font-medium text-slate-600">{hasta}</span>
          </p>
        </div>

        <form
          onSubmit={onSubmitRango}
          className="flex flex-wrap items-end gap-3 rounded-lg bg-white px-4 py-3 shadow-sm"
        >
          <div className="flex flex-col text-xs">
            <label className="mb-1 font-medium text-slate-600">Desde</label>
            <input
              type="date"
              value={desde}
              onChange={(e) => setDesde(e.target.value)}
              className="rounded-md border border-slate-300 px-2 py-1 text-sm focus:border-emerald-500 focus:outline-none focus:ring-1 focus:ring-emerald-500"
            />
          </div>

          <div className="flex flex-col text-xs">
            <label className="mb-1 font-medium text-slate-600">Hasta</label>
            <input
              type="date"
              value={hasta}
              onChange={(e) => setHasta(e.target.value)}
              className="rounded-md border border-slate-300 px-2 py-1 text-sm focus:border-emerald-500 focus:outline-none focus:ring-1 focus:ring-emerald-500"
            />
          </div>

          <button
            type="submit"
            className="inline-flex items-center rounded-md bg-emerald-600 px-3 py-1.5 text-sm font-medium text-white shadow-sm hover:bg-emerald-700 focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:ring-offset-1"
          >
            {loading ? "Cargando‚Ä¶" : "Actualizar datos"}
          </button>
        </form>
      </header>

      {error && (
        <div className="mb-4 rounded-md border border-red-200 bg-red-50 px-3 py-2 text-sm text-red-700">
          {error}
        </div>
      )}

      {/* 1) RESUMEN R√ÅPIDO */}
      <section className="mb-6 space-y-2">
        <h2 className="text-sm font-semibold text-slate-800">
          Resumen general
        </h2>
        <div className="grid gap-4 text-sm md:grid-cols-3">
          <div className="rounded-lg border border-slate-200 bg-white p-4 shadow-sm">
            <p className="text-xs font-medium uppercase tracking-wide text-slate-500">
              Usuarios activos
            </p>
            <p className="mt-2 text-3xl font-semibold text-slate-900">
              {nf.format(usuariosActivos.length)}
            </p>
            <p className="mt-2 text-xs text-slate-500">
              Usuarios con actividad en el rango.
            </p>
          </div>

          <div className="rounded-lg border border-slate-200 bg-white p-4 shadow-sm">
            <p className="text-xs font-medium uppercase tracking-wide text-slate-500">
              D√≠as con ingresos
            </p>
            <p className="mt-2 text-3xl font-semibold text-slate-900">
              {nf.format(ingresosChartData.length)}
            </p>
            <p className="mt-2 text-xs text-slate-500">
              D√≠as con ventas de cr√©ditos registradas.
            </p>
          </div>

          <div className="rounded-lg border border-slate-200 bg-white p-4 shadow-sm">
            <p className="text-xs font-medium uppercase tracking-wide text-slate-500">
              Categor√≠as con intercambios
            </p>
            <p className="mt-2 text-3xl font-semibold text-slate-900">
              {nf.format(intercambiosChartData.length)}
            </p>
            <p className="mt-2 text-xs text-slate-500">
              Categor√≠as en las que hubo al menos un intercambio.
            </p>
          </div>
        </div>
      </section>

      {/* 2) INGRESOS POR D√çA */}
      <section className="mb-6 space-y-2">
        <div>
          <h2 className="text-sm font-semibold text-slate-800">
            Ingresos por venta de cr√©ditos
          </h2>
          <p className="text-xs text-slate-500">
            Monto total diario en bolivianos.
          </p>
        </div>

        <div className="h-80 w-full rounded-lg border border-slate-200 bg-white p-4 shadow-sm">
          {ingresosChartData.length > 0 ? (
            <ResponsiveContainer width="100%" height="100%">
              <BarChart
                data={ingresosChartData}
                margin={{ top: 12, right: 16, left: 0, bottom: 8 }}
              >
                <CartesianGrid strokeDasharray="3 3" stroke="#e5e7eb" />
                <XAxis
                  dataKey="fecha"
                  tick={{ fontSize: 11, fill: "#6b7280" }}
                  tickLine={false}
                />
                <YAxis
                  tick={{ fontSize: 11, fill: "#6b7280" }}
                  tickLine={false}
                />
                <Tooltip />
                <Legend />
                <Bar
                  dataKey="total_bs"
                  name="Monto (Bs)"
                  fill="#22c55e"
                  radius={[6, 6, 0, 0]}
                  barSize={30}
                />
              </BarChart>
            </ResponsiveContainer>
          ) : (
            <div className="flex h-full w-full items-center justify-center text-xs text-slate-400">
              Sin datos de ingresos en el rango.
            </div>
          )}
        </div>
      </section>

      {/* 3) CR√âDITOS GENERADOS / CONSUMIDOS */}
      <section className="mb-6 space-y-2">
        <div>
          <h2 className="text-sm font-semibold text-slate-800">
            Cr√©ditos generados vs consumidos
          </h2>
          <p className="text-xs text-slate-500">
            Resumen global de cr√©ditos y saldo neto.
          </p>
        </div>

        <div className="h-80 w-full rounded-lg border border-slate-200 bg-white p-4 shadow-sm">
          {credChartData.length > 0 ? (
            <ResponsiveContainer width="100%" height="100%">
              <BarChart
                data={credChartData}
                margin={{ top: 12, right: 16, left: 0, bottom: 8 }}
              >
                <CartesianGrid strokeDasharray="3 3" stroke="#e5e7eb" />
                <XAxis
                  dataKey="nombre"
                  tick={{ fontSize: 11, fill: "#6b7280" }}
                  tickLine={false}
                />
                <YAxis
                  tick={{ fontSize: 11, fill: "#6b7280" }}
                  tickLine={false}
                />
                <Tooltip />
                <Bar
                  dataKey="valor"
                  name="Cr√©ditos"
                  fill="#22c55e"
                  radius={[6, 6, 0, 0]}
                  barSize={40}
                />
              </BarChart>
            </ResponsiveContainer>
          ) : (
            <div className="flex h-full w-full items-center justify-center text-xs text-slate-400">
              Sin datos de cr√©ditos para el rango.
            </div>
          )}
        </div>
      </section>

      {/* 4) INTERCAMBIOS POR CATEGOR√çA */}
      <section className="mb-6 space-y-2">
        <div>
          <h2 className="text-sm font-semibold text-slate-800">
            Intercambios por categor√≠a
          </h2>
          <p className="text-xs text-slate-500">
            Total de intercambios registrados por categor√≠a.
          </p>
        </div>

        <div className="h-80 w-full rounded-lg border border-slate-200 bg-white p-4 shadow-sm">
          {intercambiosChartData.length > 0 ? (
            <ResponsiveContainer width="100%" height="100%">
              <BarChart
                data={intercambiosChartData}
                margin={{ top: 12, right: 16, left: 0, bottom: 40 }}
              >
                <CartesianGrid strokeDasharray="3 3" stroke="#e5e7eb" />
                <XAxis
                  dataKey="categoria"
                  tick={{ fontSize: 10, fill: "#6b7280" }}
                  tickLine={false}
                  interval={0}
                  angle={-20}
                  textAnchor="end"
                  height={50}
                />
                <YAxis
                  tick={{ fontSize: 11, fill: "#6b7280" }}
                  tickLine={false}
                />
                <Tooltip />
                <Bar
                  dataKey="total_intercambios"
                  name="Intercambios"
                  fill="#22c55e"
                  radius={[6, 6, 0, 0]}
                  barSize={30}
                />
              </BarChart>
            </ResponsiveContainer>
          ) : (
            <div className="flex h-full w-full items-center justify-center text-xs text-slate-400">
              No hay intercambios en el rango.
            </div>
          )}
        </div>
      </section>

      {/* 5) PUBLICACIONES VS INTERCAMBIOS */}
      <section className="mb-6 space-y-2">
        <div>
          <h2 className="text-sm font-semibold text-slate-800">
            Publicaciones vs intercambios
          </h2>
          <p className="text-xs text-slate-500">
            Comparaci√≥n por categor√≠a entre publicaciones e intercambios.
          </p>
        </div>

        <div className="h-80 w-full rounded-lg border border-slate-200 bg-white p-4 shadow-sm">
          {pubVsIntChartData.length > 0 ? (
            <ResponsiveContainer width="100%" height="100%">
              <BarChart
                data={pubVsIntChartData}
                margin={{ top: 12, right: 16, left: 0, bottom: 40 }}
              >
                <CartesianGrid strokeDasharray="3 3" stroke="#e5e7eb" />
                <XAxis
                  dataKey="categoria"
                  tick={{ fontSize: 10, fill: "#6b7280" }}
                  tickLine={false}
                  interval={0}
                  angle={-20}
                  textAnchor="end"
                  height={50}
                />
                <YAxis
                  tick={{ fontSize: 11, fill: "#6b7280" }}
                  tickLine={false}
                />
                <Tooltip />
                <Legend />
                <Bar
                  dataKey="publicaciones"
                  name="Publicaciones"
                  fill="#22c55e"
                  radius={[6, 6, 0, 0]}
                  barSize={26}
                />
                <Bar
                  dataKey="intercambios"
                  name="Intercambios"
                  fill="#16a34a"
                  radius={[6, 6, 0, 0]}
                  barSize={26}
                />
              </BarChart>
            </ResponsiveContainer>
          ) : (
            <div className="flex h-full w-full items-center justify-center text-xs text-slate-400">
              Sin datos de publicaciones/intercambios.
            </div>
          )}
        </div>
      </section>

      {/* 6) IMPACTO AMBIENTAL */}
      <section className="mb-2 space-y-3">
        <div className="flex flex-col gap-3 md:flex-row md:items-end md:justify-between">
          <div>
            <h2 className="text-sm font-semibold text-slate-800">
              Impacto ambiental acumulado
            </h2>
            <p className="text-xs text-slate-500">
              CO‚ÇÇ ahorrado por usuario seg√∫n el per√≠odo seleccionado.
            </p>
          </div>

          <div className="flex flex-wrap items-end gap-3 rounded-lg bg-white px-4 py-3 text-sm shadow-sm">
            <div className="flex flex-col">
              <label className="mb-1 text-xs font-medium text-slate-600">
                Tipo de per√≠odo
              </label>
              <select
                value={tipoReporte}
                onChange={(e) => setTipoReporte(e.target.value)}
                className="w-32 rounded-md border border-slate-300 px-2 py-1 text-sm focus:border-emerald-500 focus:outline-none focus:ring-1 focus:ring-emerald-500"
              >
                <option value="1">Diario</option>
                <option value="2">Mensual</option>
                <option value="3">Anual</option>
              </select>
            </div>

            <div className="flex flex-col">
              <label className="mb-1 text-xs font-medium text-slate-600">
                ID per√≠odo
              </label>
              <input
                type="number"
                min="1"
                value={idPeriodo}
                onChange={(e) => setIdPeriodo(e.target.value)}
                className="w-24 rounded-md border border-slate-300 px-2 py-1 text-sm focus:border-emerald-500 focus:outline-none focus:ring-1 focus:ring-emerald-500"
              />
            </div>

            <button
              type="button"
              onClick={cargarImpacto}
              className="inline-flex items-center rounded-md bg-emerald-600 px-3 py-1.5 text-sm font-medium text-white shadow-sm hover:bg-emerald-700 focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:ring-offset-1"
            >
              {loadingImpacto ? "Cargando‚Ä¶" : "Actualizar"}
            </button>
          </div>
        </div>

        <div className="h-80 w-full rounded-lg border border-slate-200 bg-white p-4 shadow-sm">
          {impactoChartData.length > 0 ? (
            <ResponsiveContainer width="100%" height="100%">
              <BarChart
                data={impactoChartData}
                margin={{ top: 12, right: 16, left: 0, bottom: 8 }}
              >
                <CartesianGrid strokeDasharray="3 3" stroke="#e5e7eb" />
                <XAxis
                  dataKey="usuario"
                  tick={{ fontSize: 10, fill: "#6b7280" }}
                  tickLine={false}
                />
                <YAxis
                  tick={{ fontSize: 11, fill: "#6b7280" }}
                  tickLine={false}
                />
                <Tooltip />
                <Legend />
                <Bar
                  dataKey="co2"
                  name="CO‚ÇÇ (kg)"
                  fill="#22c55e"
                  radius={[6, 6, 0, 0]}
                  barSize={30}
                />
                
                <Bar dataKey="agua" name="Agua (L)" fill="#0ea5e9" radius={[6,6,0,0]} />
                <Bar dataKey="energia" name="Energ√≠a (kWh)" fill="#eab308" radius={[6,6,0,0]} />
                
              </BarChart>
            </ResponsiveContainer>
          ) : (
            <div className="flex h-full w-full items-center justify-center text-xs text-slate-400">
              Sin datos de impacto para ese per√≠odo.
            </div>
          )}
        </div>
      </section>
    </div>
  );
}
</file>

<file path="frontend/src/pages/ReportesImpactoAcumulado.jsx">
import React, { useState } from "react";
import { getReporteImpactoAcumulado } from "../services/api";

export default function ReportesImpactoAcumulado() {
  const [tipoReporte, setTipoReporte] = useState("1"); // 1=Mensual
  const [idPeriodo, setIdPeriodo] = useState("1");
  const [datos, setDatos] = useState([]);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState("");

  async function cargar() {
    try {
      setLoading(true);
      setError("");
      const res = await getReporteImpactoAcumulado({
        idTipoReporte: tipoReporte,
        idPeriodo,
      });
      setDatos(Array.isArray(res) ? res : []);
    } catch (e) {
      console.error(e);
      setError("Error cargando impacto acumulado");
      setDatos([]);
    } finally {
      setLoading(false);
    }
  }

  return (
    <div className="p-4 space-y-6">
      <header className="flex flex-col md:flex-row md:items-end md:justify-between gap-3">
        <div>
          <h1 className="text-2xl font-bold">Impacto ambiental acumulado</h1>
          <p className="text-sm text-gray-500">
            Datos provenientes de la tabla REPORTE_IMPACTO (por per√≠odo).
          </p>
        </div>

        <div className="flex flex-wrap gap-2 items-end text-sm">
          <div className="flex flex-col">
            <label className="mb-1 font-medium">Tipo de reporte</label>
            <select
              value={tipoReporte}
              onChange={(e) => setTipoReporte(e.target.value)}
              className="border rounded px-2 py-1 text-sm"
            >
              <option value="1">Mensual</option>
              <option value="2">Diario</option>
              <option value="3">Anual</option>
            </select>
          </div>

          <div className="flex flex-col">
            <label className="mb-1 font-medium">ID per√≠odo</label>
            <input
              type="number"
              min="1"
              value={idPeriodo}
              onChange={(e) => setIdPeriodo(e.target.value)}
              className="border rounded px-2 py-1 text-sm w-24"
            />
          </div>

          <button
            type="button"
            onClick={cargar}
            className="bg-emerald-600 text-white px-3 py-1.5 rounded text-sm"
          >
            {loading ? "Cargando‚Ä¶" : "Actualizar"}
          </button>
        </div>
      </header>

      {error && (
        <div className="bg-red-50 border-red-200 border text-red-700 text-sm px-3 py-2 rounded">
          {error}
        </div>
      )}

      <section>
        <div className="overflow-x-auto border rounded bg-white">
          <table className="min-w-full text-sm">
            <thead className="bg-gray-100">
              <tr>
                <th className="px-2 py-1 text-left">Usuario (ID)</th>
                <th className="px-2 py-1 text-right">CO‚ÇÇ total (kg)</th>
                <th className="px-2 py-1 text-right">Agua total (L)</th>
                <th className="px-2 py-1 text-right">Energ√≠a total (kWh)</th>
                <th className="px-2 py-1 text-right">Transacciones</th>
                <th className="px-2 py-1 text-right">Usuarios activos</th>
              </tr>
            </thead>
            <tbody>
              {datos.map((r, i) => (
                <tr key={i} className="border-t">
                  <td className="px-2 py-1">{r.id_usuario ?? "GLOBAL"}</td>
                  <td className="px-2 py-1 text-right">
                    {r.total_co2_ahorrado}
                  </td>
                  <td className="px-2 py-1 text-right">
                    {r.total_agua_ahorrada}
                  </td>
                  <td className="px-2 py-1 text-right">
                    {r.total_energia_ahorrada}
                  </td>
                  <td className="px-2 py-1 text-right">
                    {r.total_transacciones}
                  </td>
                  <td className="px-2 py-1 text-right">
                    {r.total_usuarios_activos}
                  </td>
                </tr>
              ))}
              {datos.length === 0 && (
                <tr>
                  <td
                    className="px-2 py-2 text-center text-gray-400"
                    colSpan={6}
                  >
                    Sin datos en REPORTE_IMPACTO para ese per√≠odo.
                  </td>
                </tr>
              )}
            </tbody>
          </table>
        </div>
      </section>
    </div>
  );
}
</file>

<file path="frontend/src/pages/ReportesImpactoCategoria.jsx">
import React, { useState } from "react";
import { getReporteImpactoPorCategoria } from "../services/api";

export default function ReportesImpactoCategoria() {
  const [idPeriodo, setIdPeriodo] = useState("1");
  const [datos, setDatos] = useState([]);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState("");

  async function cargar() {
    try {
      setLoading(true);
      setError("");
      const res = await getReporteImpactoPorCategoria({ idPeriodo });
      setDatos(Array.isArray(res) ? res : []);
    } catch (e) {
      console.error(e);
      setError("Error cargando impacto por categor√≠a");
      setDatos([]);
    } finally {
      setLoading(false);
    }
  }

  return (
    <div className="p-4 space-y-6">
      <header className="flex flex-col md:flex-row md:items-end md:justify-between gap-3">
        <div>
          <h1 className="text-2xl font-bold">
            Impacto ambiental por categor√≠a
          </h1>
          <p className="text-sm text-gray-500">
            Suma de CO‚ÇÇ, agua y energ√≠a ahorrada por cada categor√≠a (tabla
            IMPACTO_AMBIENTAL).
          </p>
        </div>

        <div className="flex flex-wrap gap-2 items-end text-sm">
          <div className="flex flex-col">
            <label className="mb-1 font-medium">ID per√≠odo</label>
            <input
              type="number"
              min="1"
              value={idPeriodo}
              onChange={(e) => setIdPeriodo(e.target.value)}
              className="border rounded px-2 py-1 text-sm w-24"
            />
          </div>
          <button
            type="button"
            onClick={cargar}
            className="bg-emerald-600 text-white px-3 py-1.5 rounded text-sm"
          >
            {loading ? "Cargando‚Ä¶" : "Actualizar"}
          </button>
        </div>
      </header>

      {error && (
        <div className="bg-red-50 border-red-200 border text-red-700 text-sm px-3 py-2 rounded">
          {error}
        </div>
      )}

      <section>
        <div className="overflow-x-auto border rounded bg-white">
          <table className="min-w-full text-sm">
            <thead className="bg-gray-100">
              <tr>
                <th className="px-2 py-1 text-left">Categor√≠a</th>
                <th className="px-2 py-1 text-right">CO‚ÇÇ total (kg)</th>
                <th className="px-2 py-1 text-right">Agua total (L)</th>
                <th className="px-2 py-1 text-right">Energ√≠a total (kWh)</th>
              </tr>
            </thead>
            <tbody>
              {datos.map((c, i) => (
                <tr key={i} className="border-t">
                  <td className="px-2 py-1">{c.categoria}</td>
                  <td className="px-2 py-1 text-right">{c.co2_total}</td>
                  <td className="px-2 py-1 text-right">{c.agua_total}</td>
                  <td className="px-2 py-1 text-right">{c.energia_total}</td>
                </tr>
              ))}
              {datos.length === 0 && (
                <tr>
                  <td
                    className="px-2 py-2 text-center text-gray-400"
                    colSpan={4}
                  >
                    Sin impacto registrado para ese per√≠odo.
                  </td>
                </tr>
              )}
            </tbody>
          </table>
        </div>
      </section>
    </div>
  );
}
</file>

<file path="frontend/src/pages/ReportesIngresosCreditos.jsx">
import React, { useEffect, useState } from "react";
import { getReporteIngresosCreditos } from "../services/api";

function hoyISO() {
  return new Date().toISOString().slice(0, 10);
}

function hace30DiasISO() {
  const d = new Date(Date.now() - 30 * 24 * 60 * 60 * 1000);
  return d.toISOString().slice(0, 10);
}

export default function ReportesIngresosCreditos() {
  const [desde, setDesde] = useState(hace30DiasISO());
  const [hasta, setHasta] = useState(hoyISO());
  const [datos, setDatos] = useState([]);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState("");

  async function cargar() {
    try {
      setLoading(true);
      setError("");
      const res = await getReporteIngresosCreditos({ desde, hasta });
      setDatos(Array.isArray(res) ? res : []);
    } catch (e) {
      console.error(e);
      setError("Error cargando ingresos por cr√©ditos");
      setDatos([]);
    } finally {
      setLoading(false);
    }
  }

  useEffect(() => {
    cargar();
  }, []);

  function handleSubmit(e) {
    e.preventDefault();
    cargar();
  }

  return (
    <div className="p-4 space-y-6">
      <header className="flex flex-col md:flex-row md:items-end md:justify-between gap-3">
        <div>
          <h1 className="text-2xl font-bold">Ingresos por venta de cr√©ditos</h1>
          <p className="text-sm text-gray-500">
            Cr√©ditos vendidos y monto recaudado por d√≠a.
          </p>
        </div>

        <form
          onSubmit={handleSubmit}
          className="flex flex-wrap gap-2 items-end"
        >
          <div className="flex flex-col text-sm">
            <label className="mb-1 font-medium">Desde</label>
            <input
              type="date"
              value={desde}
              onChange={(e) => setDesde(e.target.value)}
              className="border rounded px-2 py-1 text-sm"
            />
          </div>
          <div className="flex flex-col text-sm">
            <label className="mb-1 font-medium">Hasta</label>
            <input
              type="date"
              value={hasta}
              onChange={(e) => setHasta(e.target.value)}
              className="border rounded px-2 py-1 text-sm"
            />
          </div>
          <button
            type="submit"
            className="bg-emerald-600 text-white px-3 py-1.5 rounded text-sm"
          >
            {loading ? "Cargando‚Ä¶" : "Actualizar"}
          </button>
        </form>
      </header>

      {error && (
        <div className="bg-red-50 border-red-200 border text-red-700 text-sm px-3 py-2 rounded">
          {error}
        </div>
      )}

      <section>
        <div className="overflow-x-auto border rounded bg-white">
          <table className="min-w-full text-sm">
            <thead className="bg-gray-100">
              <tr>
                <th className="px-2 py-1 text-left">Fecha</th>
                <th className="px-2 py-1 text-right">Cr√©ditos</th>
                <th className="px-2 py-1 text-right">Monto (Bs)</th>
              </tr>
            </thead>
            <tbody>
              {datos.map((r, i) => (
                <tr key={i} className="border-t">
                  <td className="px-2 py-1">{r.fecha}</td>
                  <td className="px-2 py-1 text-right">{r.total_creditos}</td>
                  <td className="px-2 py-1 text-right">{r.total_bs}</td>
                </tr>
              ))}
              {datos.length === 0 && (
                <tr>
                  <td
                    className="px-2 py-2 text-center text-gray-400"
                    colSpan={3}
                  >
                    Sin compras de cr√©ditos en el rango.
                  </td>
                </tr>
              )}
            </tbody>
          </table>
        </div>
      </section>
    </div>
  );
}
</file>

<file path="frontend/src/pages/ReportesIntercambiosCategoria.jsx">
import React, { useEffect, useState } from "react";
import { getReporteIntercambiosCategoria } from "../services/api";

function hoyISO() {
  return new Date().toISOString().slice(0, 10);
}

function hace30DiasISO() {
  const d = new Date(Date.now() - 30 * 24 * 60 * 60 * 1000);
  return d.toISOString().slice(0, 10);
}

export default function ReportesIntercambiosCategoria() {
  const [desde, setDesde] = useState(hace30DiasISO());
  const [hasta, setHasta] = useState(hoyISO());
  const [datos, setDatos] = useState([]);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState("");

  async function cargar() {
    try {
      setLoading(true);
      setError("");
      const res = await getReporteIntercambiosCategoria({ desde, hasta });
      setDatos(Array.isArray(res) ? res : []);
    } catch (e) {
      console.error(e);
      setError("Error cargando intercambios por categor√≠a");
      setDatos([]);
    } finally {
      setLoading(false);
    }
  }

  useEffect(() => {
    cargar();
  }, []);

  function handleSubmit(e) {
    e.preventDefault();
    cargar();
  }

  return (
    <div className="p-4 space-y-6">
      <header className="flex flex-col md:flex-row md:items-end md:justify-between gap-3">
        <div>
          <h1 className="text-2xl font-bold">Intercambios por categor√≠a</h1>
          <p className="text-sm text-gray-500">
            N√∫mero de intercambios agrupados por categor√≠a de publicaci√≥n.
          </p>
        </div>

        <form
          onSubmit={handleSubmit}
          className="flex flex-wrap gap-2 items-end"
        >
          <div className="flex flex-col text-sm">
            <label className="mb-1 font-medium">Desde</label>
            <input
              type="date"
              value={desde}
              onChange={(e) => setDesde(e.target.value)}
              className="border rounded px-2 py-1 text-sm"
            />
          </div>
          <div className="flex flex-col text-sm">
            <label className="mb-1 font-medium">Hasta</label>
            <input
              type="date"
              value={hasta}
              onChange={(e) => setHasta(e.target.value)}
              className="border rounded px-2 py-1 text-sm"
            />
          </div>
          <button
            type="submit"
            className="bg-emerald-600 text-white px-3 py-1.5 rounded text-sm"
          >
            {loading ? "Cargando‚Ä¶" : "Actualizar"}
          </button>
        </form>
      </header>

      {error && (
        <div className="bg-red-50 border-red-200 border text-red-700 text-sm px-3 py-2 rounded">
          {error}
        </div>
      )}

      <section>
        <div className="overflow-x-auto border rounded bg-white">
          <table className="min-w-full text-sm">
            <thead className="bg-gray-100">
              <tr>
                <th className="px-2 py-1 text-left">Categor√≠a</th>
                <th className="px-2 py-1 text-right">Intercambios</th>
              </tr>
            </thead>
            <tbody>
              {datos.map((c, i) => (
                <tr key={i} className="border-t">
                  <td className="px-2 py-1">{c.categoria}</td>
                  <td className="px-2 py-1 text-right">
                    {c.total_intercambios}
                  </td>
                </tr>
              ))}
              {datos.length === 0 && (
                <tr>
                  <td
                    className="px-2 py-2 text-center text-gray-400"
                    colSpan={2}
                  >
                    No hay intercambios en el rango.
                  </td>
                </tr>
              )}
            </tbody>
          </table>
        </div>
      </section>
    </div>
  );
}
</file>

<file path="frontend/src/pages/ReportesPublicacionesVsIntercambios.jsx">
import React, { useEffect, useState } from "react";
import { getReportePublicacionesVsIntercambios } from "../services/api";

function hoyISO() {
  return new Date().toISOString().slice(0, 10);
}

function hace30DiasISO() {
  const d = new Date(Date.now() - 30 * 24 * 60 * 60 * 1000);
  return d.toISOString().slice(0, 10);
}

export default function ReportesPublicacionesIntercambios() {
  const [desde, setDesde] = useState(hace30DiasISO());
  const [hasta, setHasta] = useState(hoyISO());
  const [datos, setDatos] = useState([]);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState("");

  async function cargar() {
    try {
      setLoading(true);
      setError("");
      const res = await getReportePublicacionesVsIntercambios({
        desde,
        hasta,
      });
      setDatos(Array.isArray(res) ? res : []);
    } catch (e) {
      console.error(e);
      setError("Error cargando publicaciones vs intercambios");
      setDatos([]);
    } finally {
      setLoading(false);
    }
  }

  useEffect(() => {
    cargar();
  }, []);

  function handleSubmit(e) {
    e.preventDefault();
    cargar();
  }

  return (
    <div className="p-4 space-y-6">
      <header className="flex flex-col md:flex-row md:items-end md:justify-between gap-3">
        <div>
          <h1 className="text-2xl font-bold">
            Publicaciones vs intercambios por categor√≠a
          </h1>
          <p className="text-sm text-gray-500">
            Relaci√≥n entre publicaciones creadas y las que se concretan como
            intercambio.
          </p>
        </div>

        <form
          onSubmit={handleSubmit}
          className="flex flex-wrap gap-2 items-end"
        >
          <div className="flex flex-col text-sm">
            <label className="mb-1 font-medium">Desde</label>
            <input
              type="date"
              value={desde}
              onChange={(e) => setDesde(e.target.value)}
              className="border rounded px-2 py-1 text-sm"
            />
          </div>
          <div className="flex flex-col text-sm">
            <label className="mb-1 font-medium">Hasta</label>
            <input
              type="date"
              value={hasta}
              onChange={(e) => setHasta(e.target.value)}
              className="border rounded px-2 py-1 text-sm"
            />
          </div>
          <button
            type="submit"
            className="bg-emerald-600 text-white px-3 py-1.5 rounded text-sm"
          >
            {loading ? "Cargando‚Ä¶" : "Actualizar"}
          </button>
        </form>
      </header>

      {error && (
        <div className="bg-red-50 border-red-200 border text-red-700 text-sm px-3 py-2 rounded">
          {error}
        </div>
      )}

      <section>
        <div className="overflow-x-auto border rounded bg-white">
          <table className="min-w-full text-sm">
            <thead className="bg-gray-100">
              <tr>
                <th className="px-2 py-1 text-left">Categor√≠a</th>
                <th className="px-2 py-1 text-right">Publicaciones</th>
                <th className="px-2 py-1 text-right">Intercambios</th>
                <th className="px-2 py-1 text-right">Ratio</th>
              </tr>
            </thead>
            <tbody>
              {datos.map((p, i) => (
                <tr key={i} className="border-t">
                  <td className="px-2 py-1">{p.categoria}</td>
                  <td className="px-2 py-1 text-right">{p.publicaciones}</td>
                  <td className="px-2 py-1 text-right">{p.intercambios}</td>
                  <td className="px-2 py-1 text-right">
                    {p.ratio_intercambio ?? "-"}
                  </td>
                </tr>
              ))}
              {datos.length === 0 && (
                <tr>
                  <td
                    className="px-2 py-2 text-center text-gray-400"
                    colSpan={4}
                  >
                    Sin datos para el rango.
                  </td>
                </tr>
              )}
            </tbody>
          </table>
        </div>
      </section>
    </div>
  );
}
</file>

<file path="frontend/src/pages/ReportesRankingUsuarios.jsx">
import React, { useState } from "react";
import { getReporteRankingUsuarios } from "../services/api";

export default function ReportesRankingUsuarios() {
  const [idPeriodo, setIdPeriodo] = useState("");
  const [limit, setLimit] = useState(10);
  const [datos, setDatos] = useState([]);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState("");

  async function cargar() {
    try {
      setLoading(true);
      setError("");
      const res = await getReporteRankingUsuarios({ idPeriodo, limit });
      setDatos(Array.isArray(res) ? res : []);
    } catch (e) {
      console.error(e);
      setError("Error cargando ranking de usuarios");
      setDatos([]);
    } finally {
      setLoading(false);
    }
  }

  return (
    <div className="p-4 space-y-6">
      <header className="flex flex-col md:flex-row md:items-end md:justify-between gap-3">
        <div>
          <h1 className="text-2xl font-bold">Ranking de usuarios por impacto</h1>
          <p className="text-sm text-gray-500">
            Usuarios ordenados por impacto ambiental (CO‚ÇÇ, agua, energ√≠a).
          </p>
        </div>

        <div className="flex flex-wrap gap-2 items-end text-sm">
          <div className="flex flex-col">
            <label className="mb-1 font-medium">ID per√≠odo (opcional)</label>
            <input
              type="number"
              min="1"
              value={idPeriodo}
              onChange={(e) => setIdPeriodo(e.target.value)}
              className="border rounded px-2 py-1 text-sm w-24"
              placeholder="ej. 1"
            />
          </div>
          <div className="flex flex-col">
            <label className="mb-1 font-medium">Top N</label>
            <input
              type="number"
              min="1"
              value={limit}
              onChange={(e) => setLimit(Number(e.target.value))}
              className="border rounded px-2 py-1 text-sm w-20"
            />
          </div>
          <button
            type="button"
            onClick={cargar}
            className="bg-emerald-600 text-white px-3 py-1.5 rounded text-sm"
          >
            {loading ? "Cargando‚Ä¶" : "Actualizar"}
          </button>
        </div>
      </header>

      {error && (
        <div className="bg-red-50 border-red-200 border text-red-700 text-sm px-3 py-2 rounded">
          {error}
        </div>
      )}

      <section>
        <div className="overflow-x-auto border rounded bg-white">
          <table className="min-w-full text-sm">
            <thead className="bg-gray-100">
              <tr>
                <th className="px-2 py-1 text-left">Usuario (ID)</th>
                <th className="px-2 py-1 text-right">CO‚ÇÇ total (kg)</th>
                <th className="px-2 py-1 text-right">Agua total (L)</th>
                <th className="px-2 py-1 text-right">Energ√≠a total (kWh)</th>
                <th className="px-2 py-1 text-right">Transacciones</th>
              </tr>
            </thead>
            <tbody>
              {datos.map((r, i) => (
                <tr key={i} className="border-t">
                  <td className="px-2 py-1">{r.id_usuario}</td>
                  <td className="px-2 py-1 text-right">{r.co2_total}</td>
                  <td className="px-2 py-1 text-right">{r.agua_total}</td>
                  <td className="px-2 py-1 text-right">{r.energia_total}</td>
                  <td className="px-2 py-1 text-right">{r.transacciones}</td>
                </tr>
              ))}
              {datos.length === 0 && (
                <tr>
                  <td
                    className="px-2 py-2 text-center text-gray-400"
                    colSpan={5}
                  >
                    Sin datos de ranking para los filtros actuales.
                  </td>
                </tr>
              )}
            </tbody>
          </table>
        </div>
      </section>
    </div>
  );
}
</file>

<file path="frontend/src/pages/ReportesSaldosUsuarios.jsx">
import React, { useEffect, useState } from "react";
import { getReporteSaldosUsuarios } from "../services/api";

export default function ReportesSaldosUsuarios() {
  const [limit, setLimit] = useState(20);
  const [datos, setDatos] = useState([]);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState("");

  async function cargar() {
    try {
      setLoading(true);
      setError("");
      const res = await getReporteSaldosUsuarios({ limit });
      setDatos(Array.isArray(res) ? res : []);
    } catch (e) {
      console.error(e);
      setError("Error cargando saldos de usuarios");
      setDatos([]);
    } finally {
      setLoading(false);
    }
  }

  useEffect(() => {
    cargar();
  }, []);

  return (
    <div className="p-4 space-y-6">
      <header className="flex flex-col md:flex-row md:items-end md:justify-between gap-3">
        <div>
          <h1 className="text-2xl font-bold">Saldos de cr√©ditos por usuario</h1>
          <p className="text-sm text-gray-500">
            Top de usuarios con mayor saldo en su billetera.
          </p>
        </div>

        <div className="flex flex-wrap gap-2 items-end text-sm">
          <div className="flex flex-col">
            <label className="mb-1 font-medium">Top N</label>
            <input
              type="number"
              min="1"
              value={limit}
              onChange={(e) => setLimit(Number(e.target.value))}
              className="border rounded px-2 py-1 text-sm w-20"
            />
          </div>
          <button
            type="button"
            onClick={cargar}
            className="bg-emerald-600 text-white px-3 py-1.5 rounded text-sm"
          >
            {loading ? "Cargando‚Ä¶" : "Actualizar"}
          </button>
        </div>
      </header>

      {error && (
        <div className="bg-red-50 border-red-200 border text-red-700 text-sm px-3 py-2 rounded">
          {error}
        </div>
      )}

      <section>
        <div className="overflow-x-auto border rounded bg-white">
          <table className="min-w-full text-sm">
            <thead className="bg-gray-100">
              <tr>
                <th className="px-2 py-1 text-left">Usuario</th>
                <th className="px-2 py-1 text-left">Correo</th>
                <th className="px-2 py-1 text-right">Saldo cr√©ditos</th>
              </tr>
            </thead>
            <tbody>
              {datos.map((u, i) => (
                <tr key={i} className="border-t">
                  <td className="px-2 py-1">{u.nombre}</td>
                  <td className="px-2 py-1">{u.correo}</td>
                  <td className="px-2 py-1 text-right">
                    {u.saldo_creditos}
                  </td>
                </tr>
              ))}
              {datos.length === 0 && (
                <tr>
                  <td
                    className="px-2 py-2 text-center text-gray-400"
                    colSpan={3}
                  >
                    Sin datos de saldos para mostrar.
                  </td>
                </tr>
              )}
            </tbody>
          </table>
        </div>
      </section>
    </div>
  );
}
</file>

<file path="frontend/src/pages/ReportesUsuarios.jsx">
import React, { useEffect, useState } from "react";
import {
  getReporteUsuariosActivos,
  getReporteUsuariosAbandonados,
  getReporteUsuariosNuevos,
} from "../services/api";

function hoyISO() {
  return new Date().toISOString().slice(0, 10);
}

function hace30DiasISO() {
  const d = new Date(Date.now() - 30 * 24 * 60 * 60 * 1000);
  return d.toISOString().slice(0, 10);
}

export default function ReportesUsuarios() {
  const [desde, setDesde] = useState(hace30DiasISO());
  const [hasta, setHasta] = useState(hoyISO());

  const [activos, setActivos] = useState([]);
  const [abandonados, setAbandonados] = useState([]);
  const [nuevos, setNuevos] = useState([]);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState("");

  async function cargar() {
    try {
      setLoading(true);
      setError("");
      const [a, b, n] = await Promise.all([
        getReporteUsuariosActivos({ desde, hasta }),
        getReporteUsuariosAbandonados({ desde, hasta }),
        getReporteUsuariosNuevos({ desde, hasta }),
      ]);
      setActivos(Array.isArray(a) ? a : []);
      setAbandonados(Array.isArray(b) ? b : []);
      setNuevos(Array.isArray(n) ? n : []);
    } catch (e) {
      console.error(e);
      setError("Error cargando reportes de usuarios");
      setActivos([]);
      setAbandonados([]);
      setNuevos([]);
    } finally {
      setLoading(false);
    }
  }

  useEffect(() => {
    cargar();
  }, []);

  function handleSubmit(e) {
    e.preventDefault();
    cargar();
  }

  return (
    <div className="p-4 space-y-6">
      <header className="flex flex-col md:flex-row md:items-end md:justify-between gap-3">
        <div>
          <h1 className="text-2xl font-bold">Reporte de usuarios</h1>
          <p className="text-sm text-gray-500">
            Usuarios activos, abandonados y nuevos (primer login).
          </p>
        </div>

        <form
          onSubmit={handleSubmit}
          className="flex flex-wrap gap-2 items-end"
        >
          <div className="flex flex-col text-sm">
            <label className="mb-1 font-medium">Desde</label>
            <input
              type="date"
              value={desde}
              onChange={(e) => setDesde(e.target.value)}
              className="border rounded px-2 py-1 text-sm"
            />
          </div>
          <div className="flex flex-col text-sm">
            <label className="mb-1 font-medium">Hasta</label>
            <input
              type="date"
              value={hasta}
              onChange={(e) => setHasta(e.target.value)}
              className="border rounded px-2 py-1 text-sm"
            />
          </div>
          <button
            type="submit"
            className="bg-emerald-600 text-white px-3 py-1.5 rounded text-sm"
          >
            {loading ? "Cargando‚Ä¶" : "Actualizar"}
          </button>
        </form>
      </header>

      {error && (
        <div className="bg-red-50 border border-red-200 text-red-700 text-sm px-3 py-2 rounded">
          {error}
        </div>
      )}

      {/* Usuarios activos */}
      <section className="space-y-2">
        <h2 className="font-semibold">Usuarios activos ({activos.length})</h2>
        <div className="overflow-x-auto border rounded bg-white">
          <table className="min-w-full text-xs">
            <thead className="bg-gray-100">
              <tr>
                <th className="px-2 py-1 text-left">Usuario</th>
                <th className="px-2 py-1 text-left">Correo</th>
                <th className="px-2 py-1 text-right">Primera actividad</th>
                <th className="px-2 py-1 text-right">√öltima actividad</th>
                <th className="px-2 py-1 text-right">Total acciones</th>
              </tr>
            </thead>
            <tbody>
              {activos.map((u, i) => (
                <tr key={i} className="border-t">
                  <td className="px-2 py-1">{u.nombre}</td>
                  <td className="px-2 py-1">{u.correo}</td>
                  <td className="px-2 py-1 text-right">
                    {u.primera_actividad || "-"}
                  </td>
                  <td className="px-2 py-1 text-right">
                    {u.ultima_actividad || "-"}
                  </td>
                  <td className="px-2 py-1 text-right">{u.total_acciones}</td>
                </tr>
              ))}
              {activos.length === 0 && (
                <tr>
                  <td
                    className="px-2 py-2 text-center text-gray-400"
                    colSpan={5}
                  >
                    Sin datos en el rango.
                  </td>
                </tr>
              )}
            </tbody>
          </table>
        </div>
      </section>

      {/* Usuarios abandonados */}
      <section className="space-y-2">
        <h2 className="font-semibold">
          Usuarios abandonados ({abandonados.length})
        </h2>
        <div className="overflow-x-auto border rounded bg-white">
          <table className="min-w-full text-xs">
            <thead className="bg-gray-100">
              <tr>
                <th className="px-2 py-1 text-left">Usuario</th>
                <th className="px-2 py-1 text-left">Correo</th>
                <th className="px-2 py-1 text-right">Estado</th>
              </tr>
            </thead>
            <tbody>
              {abandonados.map((u, i) => (
                <tr key={i} className="border-t">
                  <td className="px-2 py-1">{u.nombre}</td>
                  <td className="px-2 py-1">{u.correo}</td>
                  <td className="px-2 py-1 text-right">{u.estado}</td>
                </tr>
              ))}
              {abandonados.length === 0 && (
                <tr>
                  <td
                    className="px-2 py-2 text-center text-gray-400"
                    colSpan={3}
                  >
                    Sin datos en el rango.
                  </td>
                </tr>
              )}
            </tbody>
          </table>
        </div>
      </section>

      {/* Usuarios nuevos (primer login) */}
      <section className="space-y-2">
        <h2 className="font-semibold">
          Usuarios nuevos (primer login) ({nuevos.length})
        </h2>
        <div className="overflow-x-auto border rounded bg-white">
          <table className="min-w-full text-xs">
            <thead className="bg-gray-100">
              <tr>
                <th className="px-2 py-1 text-left">Usuario</th>
                <th className="px-2 py-1 text-left">Correo</th>
                <th className="px-2 py-1 text-right">Fecha primer login</th>
              </tr>
            </thead>
            <tbody>
              {nuevos.map((u, i) => (
                <tr key={i} className="border-t">
                  <td className="px-2 py-1">{u.nombre}</td>
                  <td className="px-2 py-1">{u.correo}</td>
                  <td className="px-2 py-1 text-right">
                    {u.fecha_primer_login}
                  </td>
                </tr>
              ))}
              {nuevos.length === 0 && (
                <tr>
                  <td
                    className="px-2 py-2 text-center text-gray-400"
                    colSpan={3}
                  >
                    Sin usuarios nuevos en el rango.
                  </td>
                </tr>
              )}
            </tbody>
          </table>
        </div>
      </section>
    </div>
  );
}
</file>

<file path="frontend/src/pages/ReportesUsuariosPremium.jsx">
import React, { useEffect, useState } from "react";
import { getReporteUsuariosPremium } from "../services/api";

function hoyISO() {
  return new Date().toISOString().slice(0, 10);
}

function hace30DiasISO() {
  const d = new Date(Date.now() - 30 * 24 * 60 * 60 * 1000);
  return d.toISOString().slice(0, 10);
}

export default function ReportesUsuariosPremium() {
  const [desde, setDesde] = useState(hace30DiasISO());
  const [hasta, setHasta] = useState(hoyISO());
  const [datos, setDatos] = useState([]);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState("");

  async function cargar() {
    try {
      setLoading(true);
      setError("");
      const res = await getReporteUsuariosPremium({ desde, hasta });
      setDatos(Array.isArray(res) ? res : []);
    } catch (e) {
      console.error(e);
      setError("Error cargando reporte de usuarios premium");
      setDatos([]);
    } finally {
      setLoading(false);
    }
  }

  useEffect(() => {
    cargar();
  }, []);

  function handleSubmit(e) {
    e.preventDefault();
    cargar();
  }

  return (
    <div className="p-4 space-y-6">
      <header className="flex flex-col md:flex-row md:items-end md:justify-between gap-3">
        <div>
          <h1 className="text-2xl font-bold">Usuarios premium</h1>
          <p className="text-sm text-gray-500">
            Adopci√≥n del plan premium e ingresos por suscripci√≥n.
          </p>
        </div>

        <form
          onSubmit={handleSubmit}
          className="flex flex-wrap gap-2 items-end"
        >
          <div className="flex flex-col text-sm">
            <label className="mb-1 font-medium">Desde</label>
            <input
              type="date"
              value={desde}
              onChange={(e) => setDesde(e.target.value)}
              className="border rounded px-2 py-1 text-sm"
            />
          </div>
          <div className="flex flex-col text-sm">
            <label className="mb-1 font-medium">Hasta</label>
            <input
              type="date"
              value={hasta}
              onChange={(e) => setHasta(e.target.value)}
              className="border rounded px-2 py-1 text-sm"
            />
          </div>
          <button
            type="submit"
            className="bg-emerald-600 text-white px-3 py-1.5 rounded text-sm"
          >
            {loading ? "Cargando‚Ä¶" : "Actualizar"}
          </button>
        </form>
      </header>

      {error && (
        <div className="bg-red-50 border-red-200 border text-red-700 text-sm px-3 py-2 rounded">
          {error}
        </div>
      )}

      <section>
        <div className="overflow-x-auto border rounded bg-white">
          <table className="min-w-full text-sm">
            <thead className="bg-gray-100">
              <tr>
                <th className="px-2 py-1 text-left">Desde</th>
                <th className="px-2 py-1 text-left">Hasta</th>
                <th className="px-2 py-1 text-right">Usuarios activos</th>
                <th className="px-2 py-1 text-right">Nuevos premium</th>
                <th className="px-2 py-1 text-right">Premium activos</th>
                <th className="px-2 py-1 text-right">Ingresos (Bs)</th>
                <th className="px-2 py-1 text-right">% adopci√≥n</th>
              </tr>
            </thead>
            <tbody>
              {datos.map((r, i) => (
                <tr key={i} className="border-t">
                  <td className="px-2 py-1">{r.desde}</td>
                  <td className="px-2 py-1">{r.hasta}</td>
                  <td className="px-2 py-1 text-right">
                    {r.total_usuarios_activos}
                  </td>
                  <td className="px-2 py-1 text-right">
                    {r.usuarios_nuevos_premium}
                  </td>
                  <td className="px-2 py-1 text-right">
                    {r.usuarios_premium_activos}
                  </td>
                  <td className="px-2 py-1 text-right">
                    {r.ingresos_suscripcion_bs}
                  </td>
                  <td className="px-2 py-1 text-right">
                    {r.porcentaje_adopcion_premium}%
                  </td>
                </tr>
              ))}
              {datos.length === 0 && (
                <tr>
                  <td
                    className="px-2 py-2 text-center text-gray-400"
                    colSpan={7}
                  >
                    Sin datos de suscripciones premium en el rango.
                  </td>
                </tr>
              )}
            </tbody>
          </table>
        </div>
      </section>
    </div>
  );
}
</file>

<file path="frontend/src/router.jsx">
// frontend/src/router.jsx
import React from "react";
import { Routes, Route, Navigate } from "react-router-dom";
import ProtectedRoute from "./components/ProtectedRoute.jsx";
import Layout from "./components/Layout.jsx";

// P√°ginas base
import Login from "./pages/Login.jsx";
import Home from "./pages/Home.jsx";
import NotFound from "./pages/NotFound.jsx";

// √çndice de reportes + bot√≥n a dashboard
import Reportes from "./pages/Reportes.jsx";

// Dashboard con gr√°ficas (ya lo tienes creado)
import ReportesDashboard from "./pages/ReportesDashboard.jsx";

// P√°ginas individuales de reportes (tablas)
import ReportesUsuarios from "./pages/ReportesUsuarios.jsx";
import ReportesIngresosCreditos from "./pages/ReportesIngresosCreditos.jsx";
import ReportesCreditosGeneradosConsumidos from "./pages/ReportesCreditosGeneradosConsumidos.jsx";
import ReportesIntercambiosCategoria from "./pages/ReportesIntercambiosCategoria.jsx";
import ReportesPublicacionesVsIntercambios from "./pages/ReportesPublicacionesVsIntercambios.jsx";
import ReportesImpactoAcumulado from "./pages/ReportesImpactoAcumulado.jsx";

import ReportesRankingUsuarios from "./pages/ReportesRankingUsuarios.jsx";
import ReportesUsuariosPremium from "./pages/ReportesUsuariosPremium.jsx";
import ReportesSaldosUsuarios from "./pages/ReportesSaldosUsuarios.jsx";
import ReportesActividadesSostenibles from "./pages/ReportesActividadesSostenibles.jsx";
import ReportesImpactoCategoria from "./pages/ReportesImpactoCategoria.jsx";

import BackendLab from "./pages/BackendLab.jsx";

export default function AppRouter() {
  return (
    <Routes>
      {/* Ruta ra√≠z ‚Üí /home */}
      <Route path="/" element={<Navigate to="/home" replace />} />

      {/* Login p√∫blico */}
      <Route path="/login" element={<Login />} />

      {/* Home protegido */}
      <Route
        path="/home"
        element={
          <ProtectedRoute>
            <Layout>
              <Home />
            </Layout>
          </ProtectedRoute>
        }
      />

      {/* √çndice de reportes (lista de tarjetas + bot√≥n al dashboard) */}
      <Route
        path="/reportes"
        element={
          <ProtectedRoute>
            <Layout>
              <Reportes />
            </Layout>
          </ProtectedRoute>
        }
      />

      {/* P√°ginas individuales de reportes (tablas) */}
      <Route
        path="/reportes/usuarios"
        element={
          <ProtectedRoute>
            <Layout>
              <ReportesUsuarios />
            </Layout>
          </ProtectedRoute>
        }
      />

      <Route
        path="/reportes/ingresos-creditos"
        element={
          <ProtectedRoute>
            <Layout>
              <ReportesIngresosCreditos />
            </Layout>
          </ProtectedRoute>
        }
      />

      <Route
        path="/reportes/creditos-generados-consumidos"
        element={
          <ProtectedRoute>
            <Layout>
              <ReportesCreditosGeneradosConsumidos />
            </Layout>
          </ProtectedRoute>
        }
      />

      <Route
        path="/reportes/intercambios-categoria"
        element={
          <ProtectedRoute>
            <Layout>
              <ReportesIntercambiosCategoria />
            </Layout>
          </ProtectedRoute>
        }
      />

      <Route
        path="/reportes/publicaciones-intercambios"
        element={
          <ProtectedRoute>
            <Layout>
              <ReportesPublicacionesVsIntercambios />
            </Layout>
          </ProtectedRoute>
        }
      />

      <Route
        path="/reportes/impacto-acumulado"
        element={
          <ProtectedRoute>
            <Layout>
              <ReportesImpactoAcumulado />
            </Layout>
          </ProtectedRoute>
        }
      />

      <Route
        path="/reportes/ranking-usuarios"
        element={
          <ProtectedRoute>
            <Layout>
              <ReportesRankingUsuarios />
            </Layout>
          </ProtectedRoute>
        }
      />

      <Route
        path="/reportes/usuarios-premium"
        element={
          <ProtectedRoute>
            <Layout>
              <ReportesUsuariosPremium />
            </Layout>
          </ProtectedRoute>
        }
      />

      <Route
        path="/reportes/saldos-usuarios"
        element={
          <ProtectedRoute>
            <Layout>
              <ReportesSaldosUsuarios />
            </Layout>
          </ProtectedRoute>
        }
      />

      <Route
        path="/reportes/actividades-sostenibles"
        element={
          <ProtectedRoute>
            <Layout>
              <ReportesActividadesSostenibles />
            </Layout>
          </ProtectedRoute>
        }
      />

      <Route
        path="/reportes/impacto-categoria"
        element={
          <ProtectedRoute>
            <Layout>
              <ReportesImpactoCategoria />
            </Layout>
          </ProtectedRoute>
        }
      />

      {/* Dashboard con gr√°ficos de reportes */}
      <Route
        path="/reportes-dashboard"
        element={
          <ProtectedRoute>
            <Layout>
              <ReportesDashboard />
            </Layout>
          </ProtectedRoute>
        }
      />

      <Route
        path="/backend-lab"
        element={
          <ProtectedRoute>
            <Layout>
              <BackendLab />
            </Layout>
          </ProtectedRoute>
        }
      />

      {/* 404 */}
      <Route path="*" element={<NotFound />} />
    </Routes>
  );
}
</file>

<file path="frontend/src/services/api.js">
// frontend/src/services/api.js
const API_URL = import.meta.env.VITE_API_URL ?? "http://localhost:4000/api";

function authHeaders() {
  const token = localStorage.getItem("token");
  if (!token) return {};
  return {
    Authorization: `Bearer ${token}`,
  };
}

export async function api(path, { method = "GET", body, headers = {} } = {}) {
  const isJsonBody = body && !(body instanceof FormData);

  const res = await fetch(`${API_URL}${path}`, {
    method,
    headers: {
      ...(isJsonBody ? { "Content-Type": "application/json" } : {}),
      ...authHeaders(),
      ...headers,
    },
    body: isJsonBody ? JSON.stringify(body) : body,
  });

  const text = await res.text();

  if (!res.ok) {
    let message =
      res.statusText || `Error HTTP ${res.status}` || "Error en la solicitud";

    if (text) {
      try {
        const parsed = JSON.parse(text);
        if (parsed && parsed.message) {
          message = parsed.message;
        }
      } catch {
        message = text;
      }
    }

    throw new Error(message);
  }

  if (!text) {
    return null;
  }

  try {
    return JSON.parse(text);
  } catch {
    console.warn("Respuesta no JSON para", path, "=>", text);
    return text;
  }
}

export async function login({ correo, password }) {
  const data = await api("/auth/login", {
    method: "POST",
    body: { correo, password },
  });

  if (data?.token) {
    localStorage.setItem("token", data.token);
    if (data.usuario) {
      localStorage.setItem("usuario", JSON.stringify(data.usuario));
    }
  }

  return data;
}

export function logout() {
  localStorage.removeItem("token");
  localStorage.removeItem("usuario");
}

export async function getHealth() {
  return api("/health");
}

function buildRangeQuery(desde, hasta) {
  const params = new URLSearchParams();
  if (desde) params.append("desde", desde);
  if (hasta) params.append("hasta", hasta);
  const qs = params.toString();
  return qs ? `?${qs}` : "";
}

export async function register({ nombre, apellido, correo, password, telefono }) {
  return api("/auth/register", {
    method: "POST",
    body: { nombre, apellido, correo, password, telefono },
  });
}

//REPORTES

// Usuarios activos
export function getReporteUsuariosActivos({ desde, hasta } = {}) {
  return api(`/reportes/usuarios-activos${buildRangeQuery(desde, hasta)}`);
}

// Usuarios abandonados
export function getReporteUsuariosAbandonados({ desde, hasta } = {}) {
  return api(`/reportes/usuarios-abandonados${buildRangeQuery(desde, hasta)}`);
}

// Ingresos por venta de cr√©ditos
export function getReporteIngresosCreditos({ desde, hasta } = {}) {
  return api(`/reportes/ingresos-creditos${buildRangeQuery(desde, hasta)}`);
}

// Cr√©ditos generados vs consumidos
export function getReporteCreditosGeneradosVsConsumidos({ desde, hasta } = {}) {
  return api(
    `/reportes/creditos-generados-consumidos${buildRangeQuery(desde, hasta)}`
  );
}

// Intercambios por categor√≠a
export function getReporteIntercambiosCategoria({ desde, hasta } = {}) {
  return api(
    `/reportes/intercambios-categoria${buildRangeQuery(desde, hasta)}`
  );
}

// Publicaciones vs intercambios
export function getReportePublicacionesVsIntercambios({ desde, hasta } = {}) {
  return api(
    `/reportes/publicaciones-vs-intercambios${buildRangeQuery(desde, hasta)}`
  );
}

// Impacto acumulado (REPORTE_IMPACTO)
export function getReporteImpactoAcumulado({ idTipoReporte, idPeriodo }) {
  const params = new URLSearchParams();
  if (idTipoReporte != null) params.append("idTipoReporte", idTipoReporte);
  if (idPeriodo != null) params.append("idPeriodo", idPeriodo);
  const qs = params.toString();
  return api(`/reportes/impacto-acumulado?${qs}`);
}

//REPORTES 

// Ranking de usuarios por impacto
export function getReporteRankingUsuarios({ idPeriodo = null, limit = 10 } = {}) {
  const params = new URLSearchParams();
  if (idPeriodo != null && idPeriodo !== "") {
    params.append("idPeriodo", idPeriodo);
  }
  if (limit != null) {
    params.append("limit", String(limit));
  }
  const qs = params.toString();
  return api(`/reportes/ranking-usuarios?${qs}`);
}

// Usuarios premium
export function getReporteUsuariosPremium({ desde, hasta } = {}) {
  return api(`/reportes/usuarios-premium${buildRangeQuery(desde, hasta)}`);
}

// Usuarios nuevos (primer login)
export function getReporteUsuariosNuevos({ desde, hasta } = {}) {
  return api(`/reportes/usuarios-nuevos${buildRangeQuery(desde, hasta)}`);
}

// Saldos de cr√©ditos por usuario (top N)
export function getReporteSaldosUsuarios({ limit = 20 } = {}) {
  const params = new URLSearchParams();
  params.append("limit", String(limit));
  const qs = params.toString();
  return api(`/reportes/saldos-usuarios?${qs}`);
}

// Actividades sostenibles por usuario
export function getReporteActividadesSostenibles({ desde, hasta } = {}) {
  return api(
    `/reportes/actividades-sostenibles${buildRangeQuery(desde, hasta)}`
  );
}

// Impacto ambiental por categor√≠a
export function getReporteImpactoPorCategoria({ idPeriodo }) {
  const params = new URLSearchParams();
  if (idPeriodo != null) params.append("idPeriodo", idPeriodo);
  const qs = params.toString();
  return api(`/reportes/impacto-categoria?${qs}`);
}
</file>

<file path="frontend/tailwind.config.js">
/** @type {import('tailwindcss').Config} */
module.exports = {
  content: [
    "./index.html",
    "./src/**/*.{js,jsx,ts,tsx}"
  ],
  theme: {
    extend: {}
  },
  plugins: []
};
</file>

<file path="frontend/vite.config.js">
import { defineConfig } from "vite";
import react from "@vitejs/plugin-react";

export default defineConfig({
  plugins: [react()],
  server: {
    port: 5173
  }
});
</file>

<file path="package.json">
{
  "name": "iu-db-monorepo",
  "private": true,
  "version": "0.1.0",
  "scripts": {
    "dev": "npm-run-all --parallel dev:front dev:back",
    "dev:front": "npm --prefix frontend run dev",
    "dev:back": "npm --prefix backend run dev",
    "build": "npm-run-all build:front build:back",
    "build:front": "npm --prefix frontend run build",
    "build:back": "npm --prefix backend run build",
    "db:migrate": "npm --prefix backend run prisma:migrate",
    "db:seed": "npm --prefix backend run prisma:seed"
  },
  "devDependencies": {
    "npm-run-all": "^4.1.5"
  }
}
</file>

<file path="README.md">
# Monorepo: UI + API + DB (React + Vite + Tailwind / Node + Express + Prisma / MySQL)

## Dev r√°pido
```bash
# en la ra√≠z
npm install
npm run dev
```

## Requisitos
- Node 18+
- Docker (opcional para DB)

## Estructura
- `frontend/` React + Vite + Tailwind
- `backend/`  Node + Express + Prisma (MySQL)
- `infra/db/` SQL de init y seeds
</file>

</files>
