This file is a merged representation of the entire codebase, combined into a single document by Repomix.

<file_summary>
This section contains a summary of this file.

<purpose>
This file contains a packed representation of the entire repository's contents.
It is designed to be easily consumable by AI systems for analysis, code review,
or other automated processes.
</purpose>

<file_format>
The content is organized as follows:
1. This summary section
2. Repository information
3. Directory structure
4. Repository files (if enabled)
5. Multiple file entries, each consisting of:
  - File path as an attribute
  - Full contents of the file
</file_format>

<usage_guidelines>
- This file should be treated as read-only. Any changes should be made to the
  original repository files, not this packed version.
- When processing this file, use the file path to distinguish
  between different files in the repository.
- Be aware that this file may contain sensitive information. Handle it with
  the same level of security as you would the original repository.
</usage_guidelines>

<notes>
- Some files may have been excluded based on .gitignore rules and Repomix's configuration
- Binary files are not included in this packed representation. Please refer to the Repository Structure section for a complete list of file paths, including binary files
- Files matching patterns in .gitignore are excluded
- Files matching default ignore patterns are excluded
- Files are sorted by Git change count (files with more changes are at the bottom)
</notes>

</file_summary>

<directory_structure>
base de datos/bd_tbd(oficial).sql
base de datos/ER.png
base de datos/Poblado_de_Datos_German.sql
base de datos/primera_ronda.sql
base de datos/pruebas_finales(ejemplo de jose).sql
base de datos/segunda_ronda.sql
base de datos/tercerprueba.sql
digital-barder.zip
digital-barder/.gitignore
digital-barder/backend/Dockerfile
digital-barder/backend/package.json
digital-barder/backend/prisma/schema.prisma
digital-barder/backend/prisma/seed.js
digital-barder/backend/src/app.js
digital-barder/backend/src/config/env.js
digital-barder/backend/src/config/prisma.js
digital-barder/backend/src/middlewares/auth.js
digital-barder/backend/src/middlewares/errorHandler.js
digital-barder/backend/src/middlewares/isAdmin.js
digital-barder/backend/src/modules/actividades/actividades.controller.js
digital-barder/backend/src/modules/actividades/actividades.routes.js
digital-barder/backend/src/modules/actividades/actividades.service.js
digital-barder/backend/src/modules/auth/auth.controller.js
digital-barder/backend/src/modules/auth/auth.routes.js
digital-barder/backend/src/modules/auth/auth.service.js
digital-barder/backend/src/modules/catalogos/catalogos.controller.js
digital-barder/backend/src/modules/catalogos/catalogos.routes.js
digital-barder/backend/src/modules/catalogos/catalogos.service.js
digital-barder/backend/src/modules/intercambios/intercambios.controller.js
digital-barder/backend/src/modules/intercambios/intercambios.routes.js
digital-barder/backend/src/modules/intercambios/intercambios.service.js
digital-barder/backend/src/modules/logros/logros.controller.js
digital-barder/backend/src/modules/logros/logros.routes.js
digital-barder/backend/src/modules/logros/logros.service.js
digital-barder/backend/src/modules/notificaciones/notificaciones.controller.js
digital-barder/backend/src/modules/notificaciones/notificaciones.routes.js
digital-barder/backend/src/modules/notificaciones/notificaciones.service.js
digital-barder/backend/src/modules/premium/premium.controller.js
digital-barder/backend/src/modules/premium/premium.routes.js
digital-barder/backend/src/modules/premium/premium.service.js
digital-barder/backend/src/modules/promociones/promociones.controller.js
digital-barder/backend/src/modules/promociones/promociones.routes.js
digital-barder/backend/src/modules/promociones/promociones.service.js
digital-barder/backend/src/modules/publicaciones/publicaciones.controller.js
digital-barder/backend/src/modules/publicaciones/publicaciones.routes.js
digital-barder/backend/src/modules/publicaciones/publicaciones.service.js
digital-barder/backend/src/modules/publicidad/publicidad.controller.js
digital-barder/backend/src/modules/publicidad/publicidad.routes.js
digital-barder/backend/src/modules/publicidad/publicidad.service.js
digital-barder/backend/src/modules/reportes/reportes.controller.js
digital-barder/backend/src/modules/reportes/reportes.routes.js
digital-barder/backend/src/modules/reportes/reportes.service.js
digital-barder/backend/src/modules/uploads/multer.js
digital-barder/backend/src/modules/uploads/uploads.controller.js
digital-barder/backend/src/modules/uploads/uploads.routes.js
digital-barder/backend/src/modules/uploads/uploads.service.js
digital-barder/backend/src/modules/usuarios/usuarios.controller.js
digital-barder/backend/src/modules/usuarios/usuarios.routes.js
digital-barder/backend/src/modules/usuarios/usuarios.service.js
digital-barder/backend/src/modules/wallet/wallet.controller.js
digital-barder/backend/src/modules/wallet/wallet.routes.js
digital-barder/backend/src/modules/wallet/wallet.service.js
digital-barder/backend/src/routes/index.js
digital-barder/backend/src/server.js
digital-barder/backend/uploads_storage/cb6b319f-881d-4f8a-8a5e-9f8eecd10402.png
digital-barder/backend/utils/jsonBigInt.js
digital-barder/docker-compose.yml
digital-barder/frontend/index.html
digital-barder/frontend/package.json
digital-barder/frontend/postcss.config.js
digital-barder/frontend/src/App.jsx
digital-barder/frontend/src/assets/aurela.png
digital-barder/frontend/src/assets/aurella.png
digital-barder/frontend/src/assets/hoja.png
digital-barder/frontend/src/assets/publicit.png
digital-barder/frontend/src/assets/TomCruise.png
digital-barder/frontend/src/components/Layout.jsx
digital-barder/frontend/src/components/Navbar.jsx
digital-barder/frontend/src/components/ProtectedRoute.jsx
digital-barder/frontend/src/index.css
digital-barder/frontend/src/main.jsx
digital-barder/frontend/src/pages/BackendLab.jsx
digital-barder/frontend/src/pages/Home.jsx
digital-barder/frontend/src/pages/Login.jsx
digital-barder/frontend/src/pages/NotFound.jsx
digital-barder/frontend/src/pages/Register.jsx
digital-barder/frontend/src/pages/Reportes.jsx
digital-barder/frontend/src/pages/ReportesActividadesSostenibles.jsx
digital-barder/frontend/src/pages/ReportesCreditosGeneradosConsumidos.jsx
digital-barder/frontend/src/pages/ReportesDashboard.jsx
digital-barder/frontend/src/pages/ReportesImpactoAcumulado.jsx
digital-barder/frontend/src/pages/ReportesImpactoCategoria.jsx
digital-barder/frontend/src/pages/ReportesIngresosCreditos.jsx
digital-barder/frontend/src/pages/ReportesIntercambiosCategoria.jsx
digital-barder/frontend/src/pages/ReportesPublicacionesVsIntercambios.jsx
digital-barder/frontend/src/pages/ReportesRankingUsuarios.jsx
digital-barder/frontend/src/pages/ReportesSaldosUsuarios.jsx
digital-barder/frontend/src/pages/ReportesUsuarios.jsx
digital-barder/frontend/src/pages/ReportesUsuariosPremium.jsx
digital-barder/frontend/src/router.jsx
digital-barder/frontend/src/services/api.js
digital-barder/frontend/tailwind.config.js
digital-barder/frontend/vite.config.js
digital-barder/package.json
digital-barder/README.md
digital-barder/repomix-output.xml
README.md
</directory_structure>

<files>
This section contains the contents of the repository's files.

<file path="base de datos/tercerprueba.sql">
USE CREDITOS_VERDES;
SET SQL_SAFE_UPDATES = 0;

START TRANSACTION;
/* =========================================================
   1) CATÁLOGOS (idempotentes)
   ========================================================= */
INSERT IGNORE INTO ROL (nombre, descripcion) VALUES
('ADMIN','Administrador del sistema'),
('USER','Usuario estándar');

INSERT IGNORE INTO PERMISO (nombre, descripcion) VALUES
('VER_PUBLICACIONES','Puede ver publicaciones'),
('CREAR_PUBLICACIONES','Puede crear publicaciones'),
('COMPRAR_CREDITOS','Puede comprar créditos'),
('INTERCAMBIAR','Puede realizar intercambios'),
('ADMINISTRAR','Permisos administrativos');

INSERT IGNORE INTO RESULTADO_ACCESO (nombre, descripcion) VALUES
('OK','Acceso exitoso'),('FALLIDO','Credenciales inválidas'),('BLOQUEADO','Usuario bloqueado');

INSERT IGNORE INTO CATEGORIA (nombre, descripcion) VALUES
('Electrónica','Productos electrónicos'),
('Servicios de Reciclaje','Servicios verdes de reciclaje');

INSERT IGNORE INTO UNIDAD_MEDIDA (nombre, simbolo) VALUES
('Unidad','u'),('Kilogramo','kg'),('Litro','L');

INSERT IGNORE INTO FACTOR_CONVERSION (id_um_origen, id_um_destino, factor, descripcion)
VALUES (
 (SELECT id_um FROM UNIDAD_MEDIDA WHERE simbolo='kg'),
 (SELECT id_um FROM UNIDAD_MEDIDA WHERE simbolo='u'),
 1.00000000, 'Ejemplo sin conversión real'
);

INSERT IGNORE INTO UBICACION (direccion, ciudad, provincia, latitud, longitud) VALUES
('Av. 16 de Julio #100','La Paz','La Paz',-16.4959,-68.1334),
('Av. Cristo Redentor #2500','Santa Cruz de la Sierra','Santa Cruz',-17.7833,-63.1821),
('Av. Blanco Galindo km 5','Cochabamba','Cochabamba',-17.3895,-66.1568);

INSERT IGNORE INTO TIPO_PUBLICACION (nombre, descripcion) VALUES
('PRODUCTO','Publicación de producto'),
('SERVICIO','Publicación de servicio');

INSERT IGNORE INTO TIPO_REFERENCIA (nombre) VALUES ('COMPRA'),('TRANSACCION'),('AJUSTE');

INSERT IGNORE INTO TIPO_MOVIMIENTO (nombre, descripcion) VALUES
('RECARGA','Créditos ingresan por compra de paquete'),
('INTERCAMBIO_IN','Créditos recibidos por intercambio'),
('INTERCAMBIO_OUT','Créditos pagados en intercambio'),
('BONO_ACTIVIDAD','Bono por actividad sostenible'),
('BONO_PUBLICACION','Bono por crear publicación en promo');

INSERT IGNORE INTO SIGNO_MOVIMIENTO (nombre) VALUES ('POSITIVO'),('NEGATIVO');

INSERT IGNORE INTO SIGNO_X_TIPO_MOV (id_tipo_movimiento, id_signo, creado_en)
SELECT tm.id_tipo_movimiento, sm.id_signo, NOW()
FROM TIPO_MOVIMIENTO tm
JOIN SIGNO_MOVIMIENTO sm
  ON ( (tm.nombre IN ('RECARGA','INTERCAMBIO_IN','BONO_ACTIVIDAD','BONO_PUBLICACION') AND sm.nombre='POSITIVO')
    OR (tm.nombre='INTERCAMBIO_OUT' AND sm.nombre='NEGATIVO') );

INSERT IGNORE INTO PAQUETE_CREDITOS (nombre, cantidad_creditos, precio_bs, activo) VALUES
('Pack 200',200,20.00,TRUE),
('Pack 500',500,48.00,TRUE),
('Pack 1000',1000,90.00,TRUE);

INSERT IGNORE INTO TIPO_PROMOCION (nombre, descripcion) VALUES
('BONO_PUBLICACION','Otorga créditos al crear publicación');

INSERT IGNORE INTO TIPO_LOGRO (nombre, descripcion) VALUES
('RECICLADOR','Metas por reciclaje'),
('AHORRADOR_CO2','Metas por CO2 ahorrado');

INSERT IGNORE INTO TIPO_ACTIVIDAD (nombre, descripcion) VALUES
('Reciclaje de electrónicos','Entrega de RAEE a punto limpio'),
('Reforestación','Siembra de árboles');

INSERT IGNORE INTO UBICACION_PUBLICIDAD (nombre, descripcion, precio_base) VALUES
('Banner Home','Ubicación principal en home', 120.00),
('Sidebar','Lateral de páginas', 50.00);

INSERT IGNORE INTO TIPO_REPORTE (nombre, descripcion) VALUES
('MENSUAL','Acumulado mensual'),
('GENERAL','Acumulado general');

INSERT IGNORE INTO PERIODO (nombre, descripcion) VALUES
('2025-11','Noviembre 2025');

INSERT IGNORE INTO DIMENSION_AMBIENTAL (codigo, nombre, unidad_base, descripcion) VALUES
('CO2','Dióxido de carbono','kg','Emisiones de CO2');

INSERT IGNORE INTO EQUIVALENCIA_IMPACTO (id_categoria, id_um, co2_por_unidad, agua_por_unidad, energia_por_unidad)
VALUES
((SELECT id_categoria FROM CATEGORIA WHERE nombre='Electrónica'),
 (SELECT id_um FROM UNIDAD_MEDIDA WHERE simbolo='u'), 1.800000,7.500000,1.200000),
((SELECT id_categoria FROM CATEGORIA WHERE nombre='Servicios de Reciclaje'),
 (SELECT id_um FROM UNIDAD_MEDIDA WHERE simbolo='u'), 0.900000,4.000000,0.600000);

/* =========================================================
   2) USUARIOS BOLIVIA + permisos + bitácora
   ========================================================= */
-- ADMIN
INSERT IGNORE INTO USUARIO (id_rol, estado, nombre, apellido, correo, telefono, url_perfil) VALUES
((SELECT id_rol FROM ROL WHERE nombre='ADMIN'),'ACTIVO','Luis Alberto','Vargas','l.vargas@ejemplo.bo','+591-70000011','https://perfil.ejemplo.bo/luis.vargas');
-- PUBLICA
INSERT IGNORE INTO USUARIO (id_rol, estado, nombre, apellido, correo, telefono, url_perfil) VALUES
((SELECT id_rol FROM ROL WHERE nombre='USER'),'ACTIVO','Ana María','Flores','a.flores@ejemplo.bo','+591-70000012','https://perfil.ejemplo.bo/ana.flores');
-- COMPRA
INSERT IGNORE INTO USUARIO (id_rol, estado, nombre, apellido, correo, telefono, url_perfil) VALUES
((SELECT id_rol FROM ROL WHERE nombre='USER'),'ACTIVO','Marco Antonio','Quispe','m.quispe@ejemplo.bo','+591-70000013','https://perfil.ejemplo.bo/marco.quispe');

-- Permisos por rol
INSERT IGNORE INTO ROL_PERMISO (id_rol, id_permiso)
SELECT r.id_rol, p.id_permiso
FROM ROL r JOIN PERMISO p
WHERE (r.nombre='USER'  AND p.nombre IN ('VER_PUBLICACIONES','CREAR_PUBLICACIONES','COMPRAR_CREDITOS','INTERCAMBIAR'))
   OR (r.nombre='ADMIN' AND p.nombre='ADMINISTRAR');

-- Bitácora acceso inicial OK
INSERT INTO BITACORA_ACCESO (id_usuario, fecha, direccion_ip, user_agent, id_resultado)
SELECT u.id_usuario, NOW(), '181.114.10.10', 'Chrome/142 Win10',
       (SELECT id_resultado FROM RESULTADO_ACCESO WHERE nombre='OK')
FROM USUARIO u
WHERE u.correo IN ('l.vargas@ejemplo.bo','a.flores@ejemplo.bo','m.quispe@ejemplo.bo');

-- Variables
SET @id_admin := (SELECT id_usuario FROM USUARIO WHERE correo='l.vargas@ejemplo.bo');
SET @id_pub   := (SELECT id_usuario FROM USUARIO WHERE correo='a.flores@ejemplo.bo');
SET @id_comp  := (SELECT id_usuario FROM USUARIO WHERE correo='m.quispe@ejemplo.bo');
SET @id_cat_e := (SELECT id_categoria FROM CATEGORIA WHERE nombre='Electrónica');
SET @id_cat_s := (SELECT id_categoria FROM CATEGORIA WHERE nombre='Servicios de Reciclaje');
SET @id_tp_p  := (SELECT id_tipo_publicacion FROM TIPO_PUBLICACION WHERE nombre='PRODUCTO');
SET @id_tp_s  := (SELECT id_tipo_publicacion FROM TIPO_PUBLICACION WHERE nombre='SERVICIO');
SET @id_um_u  := (SELECT id_um FROM UNIDAD_MEDIDA WHERE simbolo='u');

/* =========================================================
   3) COMPRAS DE CRÉDITOS (mensual/anual) – RECARGAS
   ========================================================= */
-- Admin compra Pack 1000 (simula anual)
SET @tx_admin := CONCAT('TX-ADMIN-', UNIX_TIMESTAMP(), '-', FLOOR(RAND()*10000));
CALL sp_compra_creditos_aprobar(@id_admin, (SELECT id_paquete FROM PAQUETE_CREDITOS WHERE nombre='Pack 1000'), @tx_admin);

-- Marco (comprador) compra Pack 200 (mensual)
SET @tx_comp := CONCAT('TX-COMP-', UNIX_TIMESTAMP(), '-', FLOOR(RAND()*10000));
CALL sp_compra_creditos_aprobar(@id_comp, (SELECT id_paquete FROM PAQUETE_CREDITOS WHERE nombre='Pack 200'), @tx_comp);

/* =========================================================
   4) PUBLICIDAD del ADMIN (crea campaña y la paga con créditos)
   ========================================================= */
INSERT IGNORE INTO PUBLICIDAD (id_usuario, id_ubicacion, estado, titulo, descripcion, url_destino, fecha_inicio, fecha_fin, costo_creditos, clicks, impresiones)
VALUES (
  @id_admin,
  (SELECT id_ubicacion FROM UBICACION_PUBLICIDAD WHERE nombre='Banner Home'),
  'ACTIVA',
  'Campaña Eco Bolivia',
  'Lanzamiento de campaña eco en portada',
  'https://campana.ejemplo.bo/eco',
  NOW(), DATE_ADD(NOW(), INTERVAL 15 DAY),
  80, 5, 320
);
-- Descuento del costo de la publicidad (AJUSTE, usando INTERCAMBIO_OUT para egreso)
INSERT INTO MOVIMIENTO_CREDITOS (id_usuario, id_tipo_movimiento, id_tipo_referencia, cantidad, descripcion, saldo_anterior, saldo_posterior, id_referencia)
VALUES (
  @id_admin,
  (SELECT id_tipo_movimiento FROM TIPO_MOVIMIENTO WHERE nombre='INTERCAMBIO_OUT'),
  (SELECT id_tipo_referencia FROM TIPO_REFERENCIA WHERE nombre='AJUSTE'),
  (SELECT costo_creditos FROM PUBLICIDAD WHERE id_usuario=@id_admin ORDER BY id_publicidad DESC LIMIT 1),
  'Pago de publicidad (Banner Home)',
  0,0,
  (SELECT id_publicidad FROM PUBLICIDAD WHERE id_usuario=@id_admin ORDER BY id_publicidad DESC LIMIT 1)
);

/* =========================================================
   5) PUBLICACIONES (Ana publica producto + servicio)
   ========================================================= */
SET @prod_name := 'Foco LED 9W Ahorro';
SET @serv_name := 'Recolección RAEE domicilio';
SET @pub_title_prod := 'Foco LED 9W E27';
SET @pub_title_serv := 'Retiro RAEE en SCZ';

-- PRODUCTO
INSERT IGNORE INTO PRODUCTO (id_categoria, nombre, descripcion, precio, peso)
VALUES (@id_cat_e, @prod_name, 'Foco LED 9W, 6500K, E27, A++', 18.50, 0.18);
SET @id_producto := (SELECT id_producto FROM PRODUCTO WHERE nombre=@prod_name ORDER BY id_producto DESC LIMIT 1);

-- SERVICIO
INSERT IGNORE INTO SERVICIO (id_categoria, estado, nombre, descripcion, precio, duracion_min)
VALUES (@id_cat_s, 'ACTIVO', @serv_name, 'Retiro en domicilio de electrónicos en desuso', 25.00, 90);
SET @id_servicio := (SELECT id_servicio FROM SERVICIO WHERE nombre=@serv_name ORDER BY id_servicio DESC LIMIT 1);

-- PUBLICACIÓN PRODUCTO (Santa Cruz)
INSERT IGNORE INTO PUBLICACION (id_usuario, id_categoria, id_tipo_publicacion, estado, id_ubicacion, titulo, descripcion, valor_creditos, imagen_url)
VALUES (@id_pub, @id_cat_e, @id_tp_p, 'PUBLICADA',
        (SELECT id_ubicacion FROM UBICACION WHERE ciudad='Santa Cruz de la Sierra' LIMIT 1),
        @pub_title_prod, 'Ahorro energético, luz fría 6500K', 90, 'https://img.ejemplo.bo/foco9w.jpg');
SET @id_pub_prod := (SELECT id_publicacion FROM PUBLICACION WHERE titulo=@pub_title_prod AND id_usuario=@id_pub ORDER BY id_publicacion DESC LIMIT 1);

-- PUBLICACIÓN SERVICIO
INSERT IGNORE INTO PUBLICACION (id_usuario, id_categoria, id_tipo_publicacion, estado, id_ubicacion, titulo, descripcion, valor_creditos, imagen_url)
VALUES (@id_pub, @id_cat_s, @id_tp_s, 'PUBLICADA',
        (SELECT id_ubicacion FROM UBICACION WHERE ciudad='Santa Cruz de la Sierra' LIMIT 1),
        @pub_title_serv, 'Cobertura 3er y 4to anillo', 60, 'https://img.ejemplo.bo/retiro-raee-scz.jpg');
SET @id_pub_serv := (SELECT id_publicacion FROM PUBLICACION WHERE titulo=@pub_title_serv AND id_usuario=@id_pub ORDER BY id_publicacion DESC LIMIT 1);

-- VÍNCULOS
INSERT IGNORE INTO PUBLICACION_PRODUCTO (id_publicacion, id_producto, cantidad, id_um)
VALUES (@id_pub_prod, @id_producto, 1.0000, @id_um_u);

INSERT IGNORE INTO PUBLICACION_SERVICIO (id_publicacion, id_servicio, horario)
VALUES (@id_pub_serv, @id_servicio, 'Lun-Sáb 09:00-17:00');

/* =========================================================
   6) INTERCAMBIOS (SP) – compras reales
   ========================================================= */
-- Marco compra el producto (90 créditos)
CALL sp_realizar_intercambio(@id_comp,  @id_pub_prod, 90);

-- Admin compra el servicio (60 créditos)
CALL sp_realizar_intercambio(@id_admin, @id_pub_serv, 60);

/* =========================================================
   7) ACTIVIDAD SOSTENIBLE (SP) – bono para la publicadora
   ========================================================= */
CALL sp_registrar_actividad_sostenible(
  @id_pub,
  (SELECT id_tipo_actividad FROM TIPO_ACTIVIDAD WHERE nombre='Reforestación'),
  'Siembra de 4 plantines nativos en la zona del Piraí',
  40,
  'https://evidencias.ejemplo.bo/siembra4.jpg'
);

/* =========================================================
   8) EVENTO AMBIENTAL (estimación puntual ligada a última transacción)
   ========================================================= */
INSERT INTO EVENTO_AMBIENTAL (id_usuario, id_dimension, fuente, id_fuente, categoria, valor, id_um, contaminacion_reducida, descripcion)
VALUES (
 @id_comp,
 (SELECT id_dimension FROM DIMENSION_AMBIENTAL WHERE codigo='CO2'),
 'TRANSACCION',
 (SELECT id_transaccion FROM TRANSACCION ORDER BY id_transaccion DESC LIMIT 1),
 'Intercambio',
 1.800000,
 (SELECT id_um FROM UNIDAD_MEDIDA WHERE simbolo='u'),
 NULL,
 'CO2 evitado por compra de foco LED'
);

/* =========================================================
   9) ADMIN gestiona estado: SUSPENDIDO a Marco (comprador)
   ========================================================= */
UPDATE USUARIO SET estado='SUSPENDIDO' WHERE id_usuario=@id_comp;

INSERT INTO BITACORA_ACCESO (id_usuario, fecha, direccion_ip, user_agent, id_resultado)
VALUES (@id_comp, NOW(), '181.114.10.11', 'Chrome/142 Win10', (SELECT id_resultado FROM RESULTADO_ACCESO WHERE nombre='BLOQUEADO'));

/* =========================================================
   10) REPORTES (SP)
   ========================================================= */
CALL sp_generar_reporte_impacto(
  (SELECT id_tipo_reporte FROM TIPO_REPORTE WHERE nombre='MENSUAL'),
  (SELECT id_periodo FROM PERIODO ORDER BY id_periodo DESC LIMIT 1),
  NULL
);

CALL sp_generar_reporte_impacto(
  (SELECT id_tipo_reporte FROM TIPO_REPORTE WHERE nombre='MENSUAL'),
  (SELECT id_periodo FROM PERIODO ORDER BY id_periodo DESC LIMIT 1),
  @id_pub
);

COMMIT;

/* =========================================================
   11) CONSULTAS – 16 TABLAS CLAVE (todos los atributos)
   ========================================================= */
-- 1) USUARIO
SELECT * FROM USUARIO WHERE id_usuario IN (@id_admin,@id_pub,@id_comp) ORDER BY id_usuario;

-- 2) BILLETERA
SELECT * FROM BILLETERA WHERE id_usuario IN (@id_admin,@id_pub,@id_comp) ORDER BY id_billetera;

-- 3) PUBLICACION
SELECT * FROM PUBLICACION WHERE id_publicacion IN (@id_pub_prod,@id_pub_serv) ORDER BY id_publicacion;

-- 4) PRODUCTO
SELECT * FROM PRODUCTO WHERE id_producto=@id_producto;

-- 5) SERVICIO
SELECT * FROM SERVICIO WHERE id_servicio=@id_servicio;

-- 6) PUBLICACION_PRODUCTO
SELECT * FROM PUBLICACION_PRODUCTO WHERE id_publicacion=@id_pub_prod;

-- 7) PUBLICACION_SERVICIO
SELECT * FROM PUBLICACION_SERVICIO WHERE id_publicacion=@id_pub_serv;

-- 8) TRANSACCION
SELECT * FROM TRANSACCION ORDER BY id_transaccion DESC;

-- 9) BITACORA_INTERCAMBIO
SELECT * FROM BITACORA_INTERCAMBIO ORDER BY id_bitacora DESC;

-- 10) COMPRA_CREDITOS
SELECT * FROM COMPRA_CREDITOS WHERE id_usuario IN (@id_admin,@id_comp) ORDER BY id_compra DESC;

-- 11) MOVIMIENTO_CREDITOS
SELECT * FROM MOVIMIENTO_CREDITOS WHERE id_usuario IN (@id_admin,@id_pub,@id_comp) ORDER BY id_movimiento DESC;

-- 12) CALIFICACION (si decidieras calificar, aquí saldrían; en esta prueba no calificamos)
SELECT * FROM CALIFICACION WHERE id_publicacion=@id_pub_prod;

-- 13) PUBLICIDAD
SELECT * FROM PUBLICIDAD WHERE id_usuario=@id_admin ORDER BY id_publicidad DESC;

-- 14) ACTIVIDAD_SOSTENIBLE
SELECT * FROM ACTIVIDAD_SOSTENIBLE WHERE id_usuario=@id_pub ORDER BY id_actividad DESC;

-- 15) IMPACTO_AMBIENTAL
SELECT * FROM IMPACTO_AMBIENTAL ORDER BY id_impacto DESC;

-- 16) REPORTE_IMPACTO
SELECT * FROM REPORTE_IMPACTO ORDER BY id_reporte DESC;

-- Extras útiles
SELECT * FROM EVENTO_AMBIENTAL ORDER BY id_evento DESC;
SELECT * FROM BITACORA_ACCESO WHERE id_usuario IN (@id_admin,@id_pub,@id_comp) ORDER BY id_acceso DESC;

SET SQL_SAFE_UPDATES = 1;
</file>

<file path="digital-barder/frontend/src/pages/BackendLab.jsx">
// frontend/src/pages/BackendLab.jsx
import React, { useEffect, useState } from "react";

// Usa la misma URL base del backend que ya usas en el proyecto
const API_BASE_URL =
  import.meta.env.VITE_API_URL || "http://localhost:4000/api";

function loadToken() {
  return localStorage.getItem("token") || "";
}

export default function BackendLab() {
  const [token, setToken] = useState(loadToken());
  const [loading, setLoading] = useState(false);
  const [lastRequest, setLastRequest] = useState(null);
  const [lastResponse, setLastResponse] = useState(null);
  const [error, setError] = useState("");

  // ====== AUTH: registro / login ======
  const [regNombre, setRegNombre] = useState("Ana");
  const [regApellido, setRegApellido] = useState("Demo");
  const [regCorreo, setRegCorreo] = useState("ana.demo@example.com");
  const [regPassword, setRegPassword] = useState("ana12345");
  const [regTelefono, setRegTelefono] = useState("70000001");

  const [loginCorreo, setLoginCorreo] = useState("ana.demo@example.com");
  const [loginPassword, setLoginPassword] = useState("ana12345");

  // ====== Usuarios / historial ======
  const [userIdHistorial, setUserIdHistorial] = useState("");

  // ====== Wallet ======
  const [idPaquete, setIdPaquete] = useState("1");
  const [montoPagado, setMontoPagado] = useState("100");
  const [refPago, setRefPago] = useState("TEST-001");

  // ====== Intercambios ======
  const [idPublicacionInter, setIdPublicacionInter] = useState("");
  const [creditosInter, setCreditosInter] = useState("");

  // ====== Actividades ======
  const [idTipoAct, setIdTipoAct] = useState("1");
  const [descAct, setDescAct] = useState("Entregó 5kg de papel para reciclaje");
  const [credAct, setCredAct] = useState("10");

  // ====== Reportes ======
  const [desdeRep, setDesdeRep] = useState("2025-11-01");
  const [hastaRep, setHastaRep] = useState("2025-11-30");

  // ====== Request manual ======
  const [manualPath, setManualPath] = useState("/wallet/mis-creditos");
  const [manualMethod, setManualMethod] = useState("GET");
  const [manualBody, setManualBody] = useState("{\n  \n}");

  useEffect(() => {
    if (token) localStorage.setItem("token", token);
  }, [token]);

  async function callApi(moduleName, actionName, path, options = {}) {
    setError("");
    setLastResponse(null);

    const method = options.method || "GET";
    const bodyObj = options.body || null;

    setLastRequest({
      moduleName,
      actionName,
      method,
      url: API_BASE_URL + path,
      body: bodyObj,
    });

    try {
      setLoading(true);

      const headers = {
        "Content-Type": "application/json",
        ...(options.headers || {}),
      };

      if (token) {
        headers.Authorization = `Bearer ${token}`;
      }

      const res = await fetch(API_BASE_URL + path, {
        method,
        headers,
        body:
          bodyObj && ["POST", "PUT", "PATCH"].includes(method)
            ? JSON.stringify(bodyObj)
            : undefined,
      });

      let rawText = "";
      let data = null;
      try {
        rawText = await res.text();
        data = rawText ? JSON.parse(rawText) : null;
      } catch {
        data = rawText;
      }

      setLastResponse({
        status: res.status,
        ok: res.ok,
        data,
      });

      if (!res.ok) {
        setError(`Respuesta con error HTTP ${res.status}`);
      }
    } catch (err) {
      setError(err.message || "Error en la llamada");
    } finally {
      setLoading(false);
    }
  }

  // ====== AUTH: registro ======
  async function handleRegister(e) {
    e.preventDefault();
    await callApi("Auth", "POST /auth/register", "/auth/register", {
      method: "POST",
      body: {
        nombre: regNombre,
        apellido: regApellido,
        correo: regCorreo,
        password: regPassword,
        telefono: regTelefono,
      },
    });
  }

  // ====== AUTH: login ======
  async function handleLogin(e) {
    e.preventDefault();
    setError("");
    try {
      setLoading(true);

      const res = await fetch(API_BASE_URL + "/auth/login", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          correo: loginCorreo,
          password: loginPassword,
        }),
      });

      let raw = "";
      let data = null;
      try {
        raw = await res.text();
        data = raw ? JSON.parse(raw) : null;
      } catch {
        data = raw;
      }

      setLastRequest({
        moduleName: "Auth",
        actionName: "POST /auth/login",
        method: "POST",
        url: API_BASE_URL + "/auth/login",
        body: { correo: loginCorreo, password: "***" },
      });
      setLastResponse({
        status: res.status,
        ok: res.ok,
        data,
      });

      if (!res.ok) {
        setError(`Login falló con HTTP ${res.status}`);
        return;
      }

      if (data && data.token) {
        setToken(data.token);
      } else {
        setError("La respuesta de login no contiene token");
      }
    } catch (err) {
      setError(err.message || "Error en login");
    } finally {
      setLoading(false);
    }
  }

  // ====== REQUEST MANUAL ======
  async function handleManualCall(e) {
    e.preventDefault();
    let bodyParsed = null;
    if (manualMethod !== "GET" && manualBody.trim()) {
      try {
        bodyParsed = JSON.parse(manualBody);
      } catch {
        setError("El body manual no es JSON válido");
        return;
      }
    }
    await callApi(
      "Manual",
      `${manualMethod} ${manualPath}`,
      manualPath,
      {
        method: manualMethod,
        body: bodyParsed,
      }
    );
  }

  return (
    <div className="space-y-4">
      {/* HEADER */}
      <header className="flex flex-col sm:flex-row justify-between gap-3 items-start sm:items-center">
        <div>
          <h2 className="text-xl font-semibold text-gray-900">
            Laboratorio completo de Backend
          </h2>
          <p className="text-sm text-gray-500">
            Registro, login e interacción con todos los módulos del backend para
            comprobar si las rutas responden correctamente.
          </p>
          <p className="text-xs text-gray-400 mt-1">
            API_BASE_URL: <code>{API_BASE_URL}</code>
          </p>
        </div>
        <div className="text-right text-xs">
          <p className="font-semibold">Token actual:</p>
          <p className="truncate max-w-xs text-gray-500">
            {token ? token : "(sin token)"}
          </p>
          <button
            className="mt-1 text-xs text-red-600 underline"
            onClick={() => {
              setToken("");
              localStorage.removeItem("token");
            }}
          >
            Limpiar token
          </button>
          {loading && (
            <p className="mt-1 text-emerald-600 font-medium">
              Ejecutando request...
            </p>
          )}
        </div>
      </header>

      {error && (
        <div className="bg-red-50 border-red-200 border text-red-700 text-sm px-3 py-2 rounded">
          {error}
        </div>
      )}

      {/* =========================================================
          1. AUTH: REGISTRO / LOGIN / ME
         ========================================================= */}
      <section className="card space-y-3">
        <p className="text-xs font-semibold uppercase text-gray-500">
          1. Autenticación (Registro / Login / Perfil)
        </p>

        <div className="grid gap-3 md:grid-cols-2 text-xs">
          {/* REGISTRO */}
          <form onSubmit={handleRegister} className="space-y-2">
            <p className="font-semibold">Registro rápido</p>
            <div>
              <label className="block mb-1 font-medium">Nombre</label>
              <input
                type="text"
                value={regNombre}
                onChange={(e) => setRegNombre(e.target.value)}
                className="w-full border rounded px-2 py-1"
              />
            </div>
            <div>
              <label className="block mb-1 font-medium">Apellido</label>
              <input
                type="text"
                value={regApellido}
                onChange={(e) => setRegApellido(e.target.value)}
                className="w-full border rounded px-2 py-1"
              />
            </div>
            <div>
              <label className="block mb-1 font-medium">Correo</label>
              <input
                type="email"
                value={regCorreo}
                onChange={(e) => setRegCorreo(e.target.value)}
                className="w-full border rounded px-2 py-1"
              />
            </div>
            <div>
              <label className="block mb-1 font-medium">Teléfono</label>
              <input
                type="text"
                value={regTelefono}
                onChange={(e) => setRegTelefono(e.target.value)}
                className="w-full border rounded px-2 py-1"
              />
            </div>
            <div>
              <label className="block mb-1 font-medium">Contraseña</label>
              <input
                type="password"
                value={regPassword}
                onChange={(e) => setRegPassword(e.target.value)}
                className="w-full border rounded px-2 py-1"
              />
            </div>
            <button type="submit" className="btn-secondary">
              Registrar usuario
            </button>
          </form>

          {/* LOGIN */}
          <form onSubmit={handleLogin} className="space-y-2">
            <p className="font-semibold">Login</p>
            <div>
              <label className="block mb-1 font-medium">Correo</label>
              <input
                type="email"
                value={loginCorreo}
                onChange={(e) => setLoginCorreo(e.target.value)}
                className="w-full border rounded px-2 py-1"
              />
            </div>
            <div>
              <label className="block mb-1 font-medium">Contraseña</label>
              <input
                type="password"
                value={loginPassword}
                onChange={(e) => setLoginPassword(e.target.value)}
                className="w-full border rounded px-2 py-1"
              />
            </div>
            <button type="submit" className="btn-primary">
              Iniciar sesión
            </button>

            <div className="mt-2">
              <button
                type="button"
                className="btn-secondary"
                onClick={() =>
                  callApi("Auth", "GET /auth/me", "/auth/me")
                }
              >
                Probar /auth/me
              </button>
            </div>
          </form>
        </div>

        {/* Usuarios / historial */}
        <div className="border-t pt-2 mt-2 text-xs">
          <p className="font-semibold mb-1">Usuarios / historial</p>
          <div className="flex flex-wrap gap-2 items-end">
            <button
              className="btn-secondary"
              onClick={() =>
                callApi("Usuarios", "GET /usuarios", "/usuarios")
              }
            >
              Listar /usuarios (ADMIN)
            </button>
            <div className="flex gap-2 items-end">
              <div>
                <label className="block mb-1 font-medium">
                  ID usuario para historial:
                </label>
                <input
                  type="number"
                  value={userIdHistorial}
                  onChange={(e) => setUserIdHistorial(e.target.value)}
                  className="border rounded px-2 py-1"
                  placeholder="Ej: 1"
                />
              </div>
              <button
                className="btn-secondary"
                onClick={() =>
                  userIdHistorial &&
                  callApi(
                    "Usuarios",
                    `GET /usuarios/${userIdHistorial}/historial`,
                    `/usuarios/${userIdHistorial}/historial`
                  )
                }
              >
                Ver historial
              </button>
            </div>
          </div>
        </div>
      </section>

      {/* =========================================================
          2. CATÁLOGOS
         ========================================================= */}
      <section className="card space-y-2">
        <p className="text-xs font-semibold uppercase text-gray-500">
          2. Catálogos
        </p>
        <div className="flex flex-wrap gap-2 text-xs">
          <button
            className="btn-secondary"
            onClick={() =>
              callApi("Catálogos", "GET /catalogos/categorias", "/catalogos/categorias")
            }
          >
            Categorías
          </button>
          <button
            className="btn-secondary"
            onClick={() =>
              callApi(
                "Catálogos",
                "GET /catalogos/paquetes-creditos",
                "/catalogos/paquetes-creditos"
              )
            }
          >
            Paquetes créditos
          </button>
          <button
            className="btn-secondary"
            onClick={() =>
              callApi(
                "Catálogos",
                "GET /catalogos/tipos-actividad",
                "/catalogos/tipos-actividad"
              )
            }
          >
            Tipos actividad
          </button>
          <button
            className="btn-secondary"
            onClick={() =>
              callApi("Catálogos", "GET /catalogos/periodos", "/catalogos/periodos")
            }
          >
            Periodos
          </button>
          <button
            className="btn-secondary"
            onClick={() =>
              callApi(
                "Catálogos",
                "GET /catalogos/tipos-reporte",
                "/catalogos/tipos-reporte"
              )
            }
          >
            Tipos reporte
          </button>
        </div>
      </section>

      {/* =========================================================
          3. WALLET
         ========================================================= */}
      <section className="card space-y-2">
        <p className="text-xs font-semibold uppercase text-gray-500">
          3. Wallet / Billetera
        </p>
        <div className="flex flex-wrap gap-2 text-xs">
          <button
            className="btn-secondary"
            onClick={() =>
              callApi("Wallet", "GET /wallet/mis-creditos", "/wallet/mis-creditos")
            }
          >
            Mis créditos
          </button>
          <button
            className="btn-secondary"
            onClick={() =>
              callApi(
                "Wallet",
                "GET /wallet/mis-movimientos",
                "/wallet/mis-movimientos"
              )
            }
          >
            Mis movimientos
          </button>
          <button
            className="btn-secondary"
            onClick={() =>
              callApi("Wallet", "GET /wallet/compras", "/wallet/compras")
            }
          >
            Mis compras
          </button>
        </div>

        <div className="grid gap-2 md:grid-cols-4 text-xs mt-3">
          <div>
            <label className="block mb-1 font-medium">ID Paquete</label>
            <input
              type="number"
              value={idPaquete}
              onChange={(e) => setIdPaquete(e.target.value)}
              className="w-full border rounded px-2 py-1"
            />
          </div>
          <div>
            <label className="block mb-1 font-medium">Monto pagado (Bs.)</label>
            <input
              type="number"
              value={montoPagado}
              onChange={(e) => setMontoPagado(e.target.value)}
              className="w-full border rounded px-2 py-1"
            />
          </div>
          <div>
            <label className="block mb-1 font-medium">Referencia pago</label>
            <input
              type="text"
              value={refPago}
              onChange={(e) => setRefPago(e.target.value)}
              className="w-full border rounded px-2 py-1"
            />
          </div>
                    <button
            className="btn-primary w-full"
            onClick={() =>
                callApi(
                "Wallet",
                "POST /wallet/compra-creditos",
                "/wallet/compra-creditos",
                {
                    method: "POST",
                    body: {
                    idPaquete: Number(idPaquete),
                    montoPagado: Number(montoPagado),
                    referenciaPago: refPago,
                    },
                }
                )
            }
            >
            Comprar créditos
            </button>

        </div>
      </section>

      {/* =========================================================
          4. PUBLICACIONES
         ========================================================= */}
      <section className="card space-y-2">
        <p className="text-xs font-semibold uppercase text-gray-500">
          4. Publicaciones
        </p>
        <div className="flex flex-wrap gap-2 text-xs">
          <button
            className="btn-secondary"
            onClick={() =>
              callApi("Publicaciones", "GET /publicaciones", "/publicaciones")
            }
          >
            Listar /publicaciones
          </button>
          <button
            className="btn-secondary"
            onClick={() =>
              callApi(
                "Publicaciones",
                "GET /publicaciones/mias",
                "/publicaciones/mias"
              )
            }
          >
            Mis publicaciones
          </button>
          <button
            className="btn-secondary"
            onClick={() =>
              callApi(
                "Publicaciones",
                "GET /publicaciones/busqueda?q=bici",
                "/publicaciones/busqueda?q=bici"
              )
            }
          >
            Buscar (q=bici)
          </button>
        </div>
        <p className="text-xs text-gray-500 mt-1">
          ⚠️ Para crear publicaciones de prueba con todos los campos (producto /
          servicio) es más cómodo usar tu Postman o el módulo de publicaciones del
          frontend final. Aquí nos enfocamos en comprobar que los listados devuelven
          datos y no rompen.
        </p>
      </section>

      {/* =========================================================
          5. INTERCAMBIOS
         ========================================================= */}
      <section className="card space-y-2">
        <p className="text-xs font-semibold uppercase text-gray-500">
          5. Intercambios
        </p>
        <div className="flex flex-wrap gap-2 text-xs">
          <button
            className="btn-secondary"
            onClick={() =>
              callApi(
                "Intercambios",
                "GET /intercambios/mis-compras",
                "/intercambios/mis-compras"
              )
            }
          >
            Mis compras
          </button>
          <button
            className="btn-secondary"
            onClick={() =>
              callApi(
                "Intercambios",
                "GET /intercambios/mis-ventas",
                "/intercambios/mis-ventas"
              )
            }
          >
            Mis ventas
          </button>
        </div>

        <div className="grid gap-2 md:grid-cols-3 text-xs mt-3">
          <div>
            <label className="block mb-1 font-medium">ID Publicación</label>
            <input
              type="number"
              value={idPublicacionInter}
              onChange={(e) => setIdPublicacionInter(e.target.value)}
              className="w-full border rounded px-2 py-1"
            />
          </div>
          <div>
            <label className="block mb-1 font-medium">
              Créditos a intercambiar
            </label>
            <input
              type="number"
              value={creditosInter}
              onChange={(e) => setCreditosInter(e.target.value)}
              className="w-full border rounded px-2 py-1"
            />
          </div>
          <div className="flex items-end">
            <button
              className="btn-primary w-full"
              onClick={() =>
                idPublicacionInter &&
                creditosInter &&
                callApi(
                  "Intercambios",
                  "POST /intercambios",
                  "/intercambios",
                  {
                    method: "POST",
                    body: {
                      id_publicacion: Number(idPublicacionInter),
                      creditos: Number(creditosInter),
                    },
                  }
                )
              }
            >
              Crear intercambio
            </button>
          </div>
        </div>
      </section>

      {/* =========================================================
          6. ACTIVIDADES SOSTENIBLES
         ========================================================= */}
      <section className="card space-y-2">
        <p className="text-xs font-semibold uppercase text-gray-500">
          6. Actividades sostenibles
        </p>
        <div className="flex flex-wrap gap-2 text-xs">
          <button
            className="btn-secondary"
            onClick={() =>
              callApi(
                "Actividades",
                "GET /actividades-sostenibles/mias",
                "/actividades-sostenibles/mias"
              )
            }
          >
            Mis actividades
          </button>
        </div>

        <div className="grid gap-2 md:grid-cols-4 text-xs mt-3">
          <div>
            <label className="block mb-1 font-medium">ID tipo actividad</label>
            <input
              type="number"
              value={idTipoAct}
              onChange={(e) => setIdTipoAct(e.target.value)}
              className="w-full border rounded px-2 py-1"
            />
          </div>
          <div>
            <label className="block mb-1 font-medium">Créditos otorgados</label>
            <input
              type="number"
              value={credAct}
              onChange={(e) => setCredAct(e.target.value)}
              className="w-full border rounded px-2 py-1"
            />
          </div>
          <div className="md:col-span-2">
            <label className="block mb-1 font-medium">Descripción</label>
            <input
              type="text"
              value={descAct}
              onChange={(e) => setDescAct(e.target.value)}
              className="w-full border rounded px-2 py-1"
            />
          </div>
          <div className="md:col-span-4 flex justify-end">
            <button
              className="btn-primary"
              onClick={() =>
                callApi(
                  "Actividades",
                  "POST /actividades-sostenibles",
                  "/actividades-sostenibles",
                  {
                    method: "POST",
                    body: {
                      id_tipo_actividad: Number(idTipoAct),
                      descripcion: descAct,
                      creditos_otorgados: Number(credAct),
                      evidencia_url: null,
                    },
                  }
                )
              }
            >
              Registrar actividad
            </button>
          </div>
        </div>
      </section>

      {/* =========================================================
          7. PUBLICIDAD / PROMOS / LOGROS / PREMIUM
         ========================================================= */}
      <section className="card space-y-2">
        <p className="text-xs font-semibold uppercase text-gray-500">
          7. Publicidad / Promos / Logros / Premium
        </p>
        <div className="flex flex-wrap gap-2 text-xs">
          <button
            className="btn-secondary"
            onClick={() =>
              callApi("Publicidad", "GET /publicidad", "/publicidad")
            }
          >
            Publicidad activa
          </button>
          <button
            className="btn-secondary"
            onClick={() =>
              callApi(
                "Promociones",
                "GET /promociones/vigentes",
                "/promociones/vigentes"
              )
            }
          >
            Promos vigentes
          </button>
          <button
            className="btn-secondary"
            onClick={() =>
              callApi("Logros", "GET /logros/mis-logros", "/logros/mis-logros")
            }
          >
            Mis logros
          </button>
          <button
            className="btn-secondary"
            onClick={() =>
              callApi("Premium", "GET /premium/mi-plan", "/premium/mi-plan")
            }
          >
            Mi plan premium
          </button>
        </div>
      </section>

      {/* =========================================================
          8. REPORTES
         ========================================================= */}
      <section className="card space-y-2">
        <p className="text-xs font-semibold uppercase text-gray-500">
          8. Reportes (ADMIN)
        </p>

        <div className="grid gap-2 md:grid-cols-3 text-xs">
          <div>
            <label className="block mb-1 font-medium">Desde</label>
            <input
              type="date"
              value={desdeRep}
              onChange={(e) => setDesdeRep(e.target.value)}
              className="w-full border rounded px-2 py-1"
            />
          </div>
          <div>
            <label className="block mb-1 font-medium">Hasta</label>
            <input
              type="date"
              value={hastaRep}
              onChange={(e) => setHastaRep(e.target.value)}
              className="w-full border rounded px-2 py-1"
            />
          </div>
        </div>

        <div className="flex flex-wrap gap-2 text-xs mt-3">
          <button
            className="btn-secondary"
            onClick={() =>
              callApi(
                "Reportes",
                "GET /reportes/usuarios-activos",
                `/reportes/usuarios-activos?desde=${desdeRep}&hasta=${hastaRep}`
              )
            }
          >
            Usuarios activos
          </button>
          <button
            className="btn-secondary"
            onClick={() =>
              callApi(
                "Reportes",
                "GET /reportes/usuarios-abandonados",
                `/reportes/usuarios-abandonados?desde=${desdeRep}&hasta=${hastaRep}`
              )
            }
          >
            Usuarios abandonados
          </button>
          <button
            className="btn-secondary"
            onClick={() =>
              callApi(
                "Reportes",
                "GET /reportes/ingresos-creditos",
                `/reportes/ingresos-creditos?desde=${desdeRep}&hasta=${hastaRep}`
              )
            }
          >
            Ingresos créditos
          </button>
          <button
            className="btn-secondary"
            onClick={() =>
              callApi(
                "Reportes",
                "GET /reportes/creditos-generados-consumidos",
                `/reportes/creditos-generados-consumidos?desde=${desdeRep}&hasta=${hastaRep}`
              )
            }
          >
            Créditos gen. vs cons.
          </button>
          <button
            className="btn-secondary"
            onClick={() =>
              callApi(
                "Reportes",
                "GET /reportes/intercambios-categoria",
                `/reportes/intercambios-categoria?desde=${desdeRep}&hasta=${hastaRep}`
              )
            }
          >
            Intercambios x categoría
          </button>
          <button
            className="btn-secondary"
            onClick={() =>
              callApi(
                "Reportes",
                "GET /reportes/publicaciones-intercambios",
                `/reportes/publicaciones-intercambios?desde=${desdeRep}&hasta=${hastaRep}`
              )
            }
          >
            Publ. vs intercambios
          </button>
          <button
            className="btn-secondary"
            onClick={() =>
                callApi(
                "Reportes",
                "GET /reportes/impacto-acumulado",
                `/reportes/impacto-acumulado?id_tipo_reporte=1&id_periodo=1`
                )
            }
            >
            Impacto acumulado
</button>

          <button
  className="btn-secondary"
  onClick={() =>
    callApi(
      "Reportes",
      "GET /reportes/ranking-usuarios",
      `/reportes/ranking-usuarios?id_periodo=1&limit=10`
    )
  }
>
  Ranking usuarios
</button>

        </div>
      </section>

      {/* =========================================================
          9. REQUEST MANUAL
         ========================================================= */}
      <section className="card space-y-2">
        <p className="text-xs font-semibold uppercase text-gray-500">
          9. Request manual (cualquier endpoint)
        </p>
        <form onSubmit={handleManualCall} className="space-y-2 text-xs">
          <div className="flex gap-2">
            <select
              value={manualMethod}
              onChange={(e) => setManualMethod(e.target.value)}
              className="border rounded px-2 py-1"
            >
              <option>GET</option>
              <option>POST</option>
              <option>PUT</option>
              <option>PATCH</option>
              <option>DELETE</option>
            </select>
            <input
              type="text"
              value={manualPath}
              onChange={(e) => setManualPath(e.target.value)}
              className="flex-1 border rounded px-2 py-1"
              placeholder="/ruta/del/endpoint"
            />
            <button type="submit" className="btn-primary">
              Ejecutar
            </button>
          </div>
          {manualMethod !== "GET" && (
            <textarea
              rows={4}
              value={manualBody}
              onChange={(e) => setManualBody(e.target.value)}
              className="w-full border rounded px-2 py-1 font-mono"
            />
          )}
        </form>
      </section>

      {/* =========================================================
          PANEL DE RESULTADOS
         ========================================================= */}
      <section className="card space-y-2">
        <p className="text-xs font-semibold uppercase text-gray-500">
          Resultado de la última llamada
        </p>

        {lastRequest ? (
          <div className="text-xs space-y-1">
            <p>
              <span className="font-semibold">Módulo:</span>{" "}
              {lastRequest.moduleName}
            </p>
            <p>
              <span className="font-semibold">Acción:</span>{" "}
              {lastRequest.actionName}
            </p>
            <p>
              <span className="font-semibold">Método:</span>{" "}
              {lastRequest.method}
            </p>
            <p>
              <span className="font-semibold">URL:</span>{" "}
              <code>{lastRequest.url}</code>
            </p>
            {lastRequest.body && (
              <details className="mt-1">
                <summary className="cursor-pointer text-gray-600">
                  Body enviado
                </summary>
                <pre className="bg-gray-50 border rounded p-2 mt-1 overflow-x-auto">
{JSON.stringify(lastRequest.body, null, 2)}
                </pre>
              </details>
            )}
          </div>
        ) : (
          <p className="text-xs text-gray-400">
            Aún no ejecutaste ninguna llamada.
          </p>
        )}

        {lastResponse && (
          <div className="mt-3 text-xs">
            <p>
              <span className="font-semibold">Status:</span>{" "}
              {lastResponse.status}{" "}
              {lastResponse.ok ? "(OK)" : "(Error)"}
            </p>
            <details className="mt-1" open>
              <summary className="cursor-pointer text-gray-600">
                Ver JSON de respuesta
              </summary>
              <pre className="bg-gray-50 border rounded p-2 mt-1 overflow-x-auto">
{JSON.stringify(lastResponse.data, null, 2)}
              </pre>
            </details>
          </div>
        )}
      </section>
    </div>
  );
}
</file>

<file path="digital-barder/repomix-output.xml">
This file is a merged representation of the entire codebase, combined into a single document by Repomix.

<file_summary>
This section contains a summary of this file.

<purpose>
This file contains a packed representation of the entire repository's contents.
It is designed to be easily consumable by AI systems for analysis, code review,
or other automated processes.
</purpose>

<file_format>
The content is organized as follows:
1. This summary section
2. Repository information
3. Directory structure
4. Repository files (if enabled)
5. Multiple file entries, each consisting of:
  - File path as an attribute
  - Full contents of the file
</file_format>

<usage_guidelines>
- This file should be treated as read-only. Any changes should be made to the
  original repository files, not this packed version.
- When processing this file, use the file path to distinguish
  between different files in the repository.
- Be aware that this file may contain sensitive information. Handle it with
  the same level of security as you would the original repository.
</usage_guidelines>

<notes>
- Some files may have been excluded based on .gitignore rules and Repomix's configuration
- Binary files are not included in this packed representation. Please refer to the Repository Structure section for a complete list of file paths, including binary files
- Files matching patterns in .gitignore are excluded
- Files matching default ignore patterns are excluded
- Files are sorted by Git change count (files with more changes are at the bottom)
</notes>

</file_summary>

<directory_structure>
.gitignore
backend/Dockerfile
backend/package.json
backend/prisma/schema.prisma
backend/prisma/seed.js
backend/src/app.js
backend/src/config/env.js
backend/src/config/prisma.js
backend/src/middlewares/auth.js
backend/src/middlewares/errorHandler.js
backend/src/middlewares/isAdmin.js
backend/src/modules/actividades/actividades.controller.js
backend/src/modules/actividades/actividades.routes.js
backend/src/modules/actividades/actividades.service.js
backend/src/modules/auth/auth.controller.js
backend/src/modules/auth/auth.routes.js
backend/src/modules/auth/auth.service.js
backend/src/modules/catalogos/catalogos.controller.js
backend/src/modules/catalogos/catalogos.routes.js
backend/src/modules/catalogos/catalogos.service.js
backend/src/modules/intercambios/intercambios.controller.js
backend/src/modules/intercambios/intercambios.routes.js
backend/src/modules/intercambios/intercambios.service.js
backend/src/modules/logros/logros.controller.js
backend/src/modules/logros/logros.routes.js
backend/src/modules/logros/logros.service.js
backend/src/modules/notificaciones/notificaciones.controller.js
backend/src/modules/notificaciones/notificaciones.routes.js
backend/src/modules/notificaciones/notificaciones.service.js
backend/src/modules/premium/premium.controller.js
backend/src/modules/premium/premium.routes.js
backend/src/modules/premium/premium.service.js
backend/src/modules/promociones/promociones.controller.js
backend/src/modules/promociones/promociones.routes.js
backend/src/modules/promociones/promociones.service.js
backend/src/modules/publicaciones/publicaciones.controller.js
backend/src/modules/publicaciones/publicaciones.routes.js
backend/src/modules/publicaciones/publicaciones.service.js
backend/src/modules/publicidad/publicidad.controller.js
backend/src/modules/publicidad/publicidad.routes.js
backend/src/modules/publicidad/publicidad.service.js
backend/src/modules/reportes/reportes.controller.js
backend/src/modules/reportes/reportes.routes.js
backend/src/modules/reportes/reportes.service.js
backend/src/modules/uploads/multer.js
backend/src/modules/uploads/uploads.controller.js
backend/src/modules/uploads/uploads.routes.js
backend/src/modules/uploads/uploads.service.js
backend/src/modules/usuarios/usuarios.controller.js
backend/src/modules/usuarios/usuarios.routes.js
backend/src/modules/usuarios/usuarios.service.js
backend/src/modules/wallet/wallet.controller.js
backend/src/modules/wallet/wallet.routes.js
backend/src/modules/wallet/wallet.service.js
backend/src/routes/index.js
backend/src/server.js
backend/uploads_storage/cb6b319f-881d-4f8a-8a5e-9f8eecd10402.png
backend/utils/jsonBigInt.js
docker-compose.yml
frontend/index.html
frontend/package.json
frontend/postcss.config.js
frontend/src/App.jsx
frontend/src/assets/aurela.png
frontend/src/assets/aurella.png
frontend/src/assets/hoja.png
frontend/src/assets/publicit.png
frontend/src/assets/TomCruise.png
frontend/src/components/Layout.jsx
frontend/src/components/Navbar.jsx
frontend/src/components/ProtectedRoute.jsx
frontend/src/index.css
frontend/src/main.jsx
frontend/src/pages/BackendLab.jsx
frontend/src/pages/Home.jsx
frontend/src/pages/Login.jsx
frontend/src/pages/NotFound.jsx
frontend/src/pages/Register.jsx
frontend/src/pages/Reportes.jsx
frontend/src/pages/ReportesActividadesSostenibles.jsx
frontend/src/pages/ReportesCreditosGeneradosConsumidos.jsx
frontend/src/pages/ReportesDashboard.jsx
frontend/src/pages/ReportesImpactoAcumulado.jsx
frontend/src/pages/ReportesImpactoCategoria.jsx
frontend/src/pages/ReportesIngresosCreditos.jsx
frontend/src/pages/ReportesIntercambiosCategoria.jsx
frontend/src/pages/ReportesPublicacionesVsIntercambios.jsx
frontend/src/pages/ReportesRankingUsuarios.jsx
frontend/src/pages/ReportesSaldosUsuarios.jsx
frontend/src/pages/ReportesUsuarios.jsx
frontend/src/pages/ReportesUsuariosPremium.jsx
frontend/src/router.jsx
frontend/src/services/api.js
frontend/tailwind.config.js
frontend/vite.config.js
package.json
README.md
</directory_structure>

<files>
This section contains the contents of the repository's files.

<file path=".gitignore">
node_modules
dist
.env
.env.*
.prisma
.DS_Store
</file>

<file path="backend/Dockerfile">
# simple dev image; optional
FROM node:18-alpine
WORKDIR /app
COPY package*.json ./
RUN npm install
COPY . .
EXPOSE 4000
CMD ["npm","run","start"]
</file>

<file path="backend/package.json">
{
  "name": "backend",
  "private": true,
  "version": "0.1.0",
  "type": "module",
  "scripts": {
    "dev": "node --watch src/server.js",
    "start": "node src/server.js",
    "prisma:generate": "prisma generate",
    "prisma:migrate": "prisma migrate dev --name init",
    "prisma:deploy": "prisma migrate deploy",
    "prisma:seed": "node prisma/seed.js",
    "studio": "prisma studio"
  },
  "dependencies": {
    "@prisma/client": "^6.19.0",
    "bcryptjs": "^2.4.3",
    "cors": "^2.8.5",
    "dotenv": "^16.4.5",
    "express": "^4.21.1",
    "helmet": "^7.1.0",
    "jsonwebtoken": "^9.0.2",
    "morgan": "^1.10.1",
    "multer": "^2.0.2",
    "uuid": "^13.0.0"
  },
  "devDependencies": {
    "prisma": "^6.19.0"
  }
}
</file>

<file path="backend/prisma/schema.prisma">
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model actividad_sostenible {
  id_actividad       Int      @id @default(autoincrement())
  id_usuario         Int
  id_tipo_actividad  Int
  descripcion        String   @db.Text
  creditos_otorgados Int
  evidencia_url      String?  @db.VarChar(500)
  creado_en          DateTime @default(now()) @db.DateTime(0)

  @@index([id_tipo_actividad], map: "fk_act_tipo")
  @@index([id_usuario], map: "fk_act_usuario")
  @@index([creado_en], map: "ix_actsost_creado_en")
}

model billetera {
  id_billetera    Int               @id @default(autoincrement())
  id_usuario      Int               @unique(map: "id_usuario")
  estado          billetera_estado? @default(ACTIVA)
  saldo_creditos  BigInt?           @default(0)
  saldo_bs        Decimal?          @default(0.00) @db.Decimal(12, 2)
  cuenta_bancaria String?           @db.VarChar(100)
}

model bitacora_acceso {
  id_acceso    Int      @id @default(autoincrement())
  id_usuario   Int
  fecha        DateTime @default(now()) @db.DateTime(0)
  direccion_ip String   @db.VarChar(45)
  user_agent   String?  @db.VarChar(500)
  id_resultado Int

  @@index([id_resultado], map: "fk_bitacc_resultado")
  @@index([id_usuario, fecha], map: "ix_bitacceso_usuario_fecha")
}

model bitacora_intercambio {
  id_bitacora        Int     @id @default(autoincrement())
  id_transaccion     Int
  id_usuario_origen  Int
  id_usuario_destino Int
  cantidad_creditos  BigInt
  descripcion        String? @db.VarChar(500)

  @@index([id_usuario_destino], map: "fk_bi_usr_destino")
  @@index([id_usuario_origen], map: "fk_bi_usr_origen")
  @@index([id_transaccion], map: "ix_bitacora_trx")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model calificacion {
  id_calificacion Int     @id @default(autoincrement())
  id_usuario      Int
  id_publicacion  Int
  estrellas       Int     @db.TinyInt
  comentario      String? @db.VarChar(300)

  @@unique([id_usuario, id_publicacion], map: "id_usuario")
  @@index([id_publicacion], map: "fk_calif_publicacion")
}

model categoria {
  id_categoria Int     @id @default(autoincrement())
  nombre       String  @unique(map: "nombre") @db.VarChar(100)
  descripcion  String? @db.VarChar(255)
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model compra_creditos {
  id_compra           Int                     @id @default(autoincrement())
  id_usuario          Int
  id_paquete          Int
  monto_bs            Decimal                 @db.Decimal(12, 2)
  estado              compra_creditos_estado? @default(PENDIENTE)
  id_transaccion_pago String?                 @unique(map: "id_transaccion_pago") @db.VarChar(255)
  creado_en           DateTime                @default(now()) @db.DateTime(0)

  @@index([id_paquete], map: "fk_compra_paquete")
  @@index([id_usuario], map: "fk_compra_usuario")
  @@index([estado], map: "ix_compra_estado")
  @@index([creado_en], map: "ix_compra_creado_en")
}

model dimension_ambiental {
  id_dimension Int     @id @default(autoincrement())
  codigo       String  @unique(map: "codigo") @db.VarChar(30)
  nombre       String  @db.VarChar(100)
  unidad_base  String? @db.VarChar(20)
  descripcion  String? @db.VarChar(255)
}

model equivalencia_impacto {
  id_equivalencia    Int     @id @default(autoincrement())
  id_categoria       Int
  id_um              Int?
  co2_por_unidad     Decimal @db.Decimal(12, 6)
  agua_por_unidad    Decimal @db.Decimal(12, 6)
  energia_por_unidad Decimal @db.Decimal(12, 6)

  @@unique([id_categoria, id_um], map: "id_categoria")
  @@index([id_um], map: "fk_eq_um")
}

model evento_ambiental {
  id_evento              Int                     @id @default(autoincrement())
  id_usuario             Int
  id_dimension           Int
  fuente                 evento_ambiental_fuente
  id_fuente              Int
  categoria              String?                 @db.VarChar(100)
  valor                  Decimal                 @db.Decimal(18, 6)
  id_um                  Int?
  contaminacion_reducida Decimal?                @db.Decimal(18, 6)
  descripcion            String?                 @db.VarChar(255)

  @@index([id_dimension], map: "fk_ev_dimension")
  @@index([id_um], map: "fk_ev_um")
  @@index([id_usuario], map: "fk_ev_usuario")
}

model impacto_ambiental {
  id_impacto       Int     @id @default(autoincrement())
  id_usuario       Int
  id_transaccion   Int
  id_categoria     Int
  co2_ahorrado     Decimal @db.Decimal(12, 6)
  agua_ahorrada    Decimal @db.Decimal(12, 6)
  energia_ahorrada Decimal @db.Decimal(12, 6)
  id_periodo       Int

  @@index([id_transaccion], map: "fk_imp_tx")
  @@index([id_categoria], map: "ix_impa_categoria")
  @@index([id_periodo], map: "ix_impa_periodo")
  @@index([id_usuario, id_periodo], map: "ix_impa_usuario_periodo")
}

model logro {
  id_logro            Int     @id @default(autoincrement())
  id_tipo_logro       Int
  nombre              String  @db.VarChar(100)
  descripcion         String? @db.VarChar(255)
  meta_requerida      BigInt
  creditos_recompensa BigInt

  @@index([id_tipo_logro], map: "fk_logro_tipo")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model movimiento_creditos {
  id_movimiento      Int      @id @default(autoincrement())
  id_usuario         Int
  id_tipo_movimiento Int
  id_tipo_referencia Int
  cantidad           BigInt
  descripcion        String?  @db.VarChar(255)
  saldo_anterior     BigInt
  saldo_posterior    BigInt
  id_referencia      Int?
  creado_en          DateTime @default(now()) @db.DateTime(0)

  @@index([id_tipo_movimiento], map: "fk_mov_tipomov")
  @@index([id_movimiento], map: "ix_mov_creado")
  @@index([id_tipo_referencia], map: "ix_mov_tiporef")
  @@index([id_usuario, id_movimiento], map: "ix_mov_usuario")
  @@index([creado_en], map: "ix_mov_creado_en")
}

model paquete_creditos {
  id_paquete        Int     @id @default(autoincrement())
  nombre            String  @unique(map: "nombre") @db.VarChar(100)
  cantidad_creditos BigInt
  precio_bs         Decimal @db.Decimal(12, 2)
  activo            Boolean @default(true)
}

model periodo {
  id_periodo   Int       @id @default(autoincrement())
  nombre       String    @unique(map: "nombre") @db.VarChar(50)
  descripcion  String?   @db.VarChar(255)
  fecha_inicio DateTime? @db.Date
  fecha_fin    DateTime? @db.Date

  @@index([fecha_inicio, fecha_fin], map: "ix_periodo_rango")
}

model permiso {
  id_permiso  Int     @id @default(autoincrement())
  nombre      String  @unique(map: "nombre") @db.VarChar(100)
  descripcion String? @db.VarChar(255)
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model producto {
  id_producto  Int      @id @default(autoincrement())
  id_categoria Int
  nombre       String   @db.VarChar(255)
  descripcion  String?  @db.VarChar(255)
  precio       Decimal? @db.Decimal(12, 2)
  peso         Decimal? @db.Decimal(10, 2)

  @@index([id_categoria], map: "fk_producto_categoria")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model promocion {
  id_promocion       Int               @id @default(autoincrement())
  id_tipo_promocion  Int
  nombre             String            @db.VarChar(100)
  descripcion        String?           @db.VarChar(255)
  creditos_otorgados BigInt
  fecha_inicio       DateTime          @db.DateTime(0)
  fecha_fin          DateTime          @db.DateTime(0)
  estado             promocion_estado? @default(PROGRAMADA)

  @@index([id_tipo_promocion], map: "fk_promocion_tipo")
  @@index([estado, fecha_inicio, fecha_fin], map: "ix_promocion_activa")
}

model promocion_publicacion {
  id_promocion   Int
  id_publicacion Int

  @@id([id_promocion, id_publicacion])
  @@index([id_promocion], map: "ix_promopub_prom")
  @@index([id_publicacion], map: "ix_promopub_pub")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model publicacion {
  id_publicacion      Int                 @id @default(autoincrement())
  id_usuario          Int
  id_categoria        Int
  id_tipo_publicacion Int
  estado              publicacion_estado? @default(PUBLICADA)
  id_ubicacion        Int?
  titulo              String              @db.VarChar(200)
  descripcion         String              @db.Text
  valor_creditos      BigInt
  imagen_url          String?             @db.VarChar(500)
  creado_en           DateTime            @default(now()) @db.DateTime(0)

  @@index([id_tipo_publicacion], map: "fk_publicacion_tipopub")
  @@index([id_ubicacion], map: "fk_publicacion_ubicacion")
  @@index([id_categoria, estado], map: "ix_pub_categoria_estado")
  @@index([id_usuario, estado], map: "ix_pub_usuario_estado")
  @@index([creado_en], map: "ix_pub_creado_en")
  @@fulltext([titulo, descripcion], map: "ft_pub_titulo_desc")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model publicacion_producto {
  id_publicacion Int
  id_producto    Int
  cantidad       Decimal @db.Decimal(15, 4)
  id_um          Int

  @@id([id_publicacion, id_producto])
  @@index([id_producto], map: "fk_pprd_producto")
  @@index([id_um], map: "fk_pprd_um")
}

model publicacion_servicio {
  id_publicacion Int
  id_servicio    Int
  horario        String @db.VarChar(100)

  @@id([id_publicacion, id_servicio])
  @@index([id_servicio], map: "fk_pserv_servicio")
}

model publicidad {
  id_publicidad  Int                @id @default(autoincrement())
  id_usuario     Int
  id_ubicacion   Int
  estado         publicidad_estado? @default(PROGRAMADA)
  titulo         String             @db.VarChar(200)
  descripcion    String?            @db.VarChar(255)
  url_destino    String?            @db.VarChar(500)
  fecha_inicio   DateTime           @db.DateTime(0)
  fecha_fin      DateTime           @db.DateTime(0)
  costo_creditos BigInt

  @@index([id_ubicacion], map: "fk_publicidad_ubipub")
  @@index([id_usuario], map: "fk_publicidad_usuario")
}

model reporte_impacto {
  id_reporte             Int     @id @default(autoincrement())
  id_usuario             Int?
  id_tipo_reporte        Int
  id_periodo             Int
  total_co2_ahorrado     Decimal @db.Decimal(12, 6)
  total_agua_ahorrada    Decimal @db.Decimal(12, 6)
  total_energia_ahorrada Decimal @db.Decimal(12, 6)
  total_transacciones    BigInt
  total_usuarios_activos BigInt

  @@index([id_periodo], map: "fk_rep_periodo")
  @@index([id_usuario], map: "fk_rep_usuario")
  @@index([id_tipo_reporte, id_periodo, id_usuario], map: "ix_rep_unico_helper")
}

model resultado_acceso {
  id_resultado Int     @id @default(autoincrement())
  nombre       String  @unique(map: "nombre") @db.VarChar(50)
  descripcion  String? @db.VarChar(255)
}

model rol {
  id_rol      Int     @id @default(autoincrement())
  nombre      String  @unique(map: "nombre") @db.VarChar(50)
  descripcion String? @db.VarChar(255)
}

model rol_permiso {
  id_rol     Int
  id_permiso Int

  @@id([id_rol, id_permiso])
  @@index([id_permiso], map: "fk_rp_permiso")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model servicio {
  id_servicio  Int              @id @default(autoincrement())
  id_categoria Int
  estado       servicio_estado? @default(ACTIVO)
  nombre       String           @db.VarChar(255)
  descripcion  String?          @db.Text
  precio       Decimal?         @db.Decimal(12, 2)
  duracion_min Int?             @db.SmallInt

  @@index([id_categoria], map: "fk_servicio_categoria")
}

model signo_movimiento {
  id_signo Int    @id @default(autoincrement())
  nombre   String @unique(map: "nombre") @db.VarChar(20)
}

model signo_tipo_mov {
  id_tipo_movimiento Int
  id_signo           Int
  creado_en          DateTime? @db.DateTime(0)

  @@id([id_tipo_movimiento, id_signo])
  @@index([id_signo], map: "ix_sxtm_signo")
}

model tipo_actividad {
  id_tipo_actividad Int     @id @default(autoincrement())
  nombre            String  @unique(map: "nombre") @db.VarChar(100)
  descripcion       String? @db.VarChar(255)
}

model tipo_logro {
  id_tipo_logro Int     @id @default(autoincrement())
  nombre        String  @unique(map: "nombre") @db.VarChar(50)
  descripcion   String? @db.VarChar(255)
}

model tipo_movimiento {
  id_tipo_movimiento Int     @id @default(autoincrement())
  nombre             String  @unique(map: "nombre") @db.VarChar(50)
  descripcion        String? @db.VarChar(255)

  @@index([nombre], map: "ix_tipomov_nombre")
}

model tipo_promocion {
  id_tipo_promocion Int     @id @default(autoincrement())
  nombre            String  @unique(map: "nombre") @db.VarChar(50)
  descripcion       String? @db.VarChar(255)
}

model tipo_publicacion {
  id_tipo_publicacion Int     @id @default(autoincrement())
  nombre              String  @unique(map: "nombre") @db.VarChar(50)
  descripcion         String? @db.VarChar(255)
}

model tipo_referencia {
  id_tipo_referencia Int    @id @default(autoincrement())
  nombre             String @unique(map: "nombre") @db.VarChar(30)

  @@index([nombre], map: "ix_tiporef_nombre")
}

model tipo_reporte {
  id_tipo_reporte Int     @id @default(autoincrement())
  nombre          String  @unique(map: "nombre") @db.VarChar(50)
  descripcion     String? @db.VarChar(255)
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model transaccion {
  id_transaccion    Int                 @id @default(autoincrement())
  id_comprador      Int
  id_vendedor       Int
  id_publicacion    Int
  cantidad_creditos BigInt
  estado            transaccion_estado? @default(SOLICITADA)
  creado_en         DateTime            @default(now()) @db.DateTime(0)

  @@index([estado], map: "ix_trans_estado")
  @@index([id_comprador], map: "ix_tx_comprador")
  @@index([id_publicacion], map: "ix_tx_publicacion")
  @@index([id_vendedor], map: "ix_tx_vendedor")
  @@index([creado_en], map: "ix_tx_creado_en")
}

model ubicacion {
  id_ubicacion Int      @id @default(autoincrement())
  direccion    String   @db.VarChar(500)
  ciudad       String?  @db.VarChar(100)
  provincia    String?  @db.VarChar(100)
  latitud      Decimal? @db.Decimal(9, 6)
  longitud     Decimal? @db.Decimal(9, 6)
}

model ubicacion_publicidad {
  id_ubicacion Int     @id @default(autoincrement())
  nombre       String  @unique(map: "nombre") @db.VarChar(100)
  descripcion  String? @db.VarChar(255)
  precio_base  Decimal @db.Decimal(12, 2)
}

model unidad_medida {
  id_um   Int    @id @default(autoincrement())
  nombre  String @unique(map: "nombre") @db.VarChar(100)
  simbolo String @unique(map: "simbolo") @db.VarChar(20)
}

model usuario {
  id_usuario    Int            @id @default(autoincrement())
  id_rol        Int
  estado        usuario_estado @default(ACTIVO)
  nombre        String         @db.VarChar(100)
  apellido      String?        @db.VarChar(100)
  correo        String         @unique(map: "correo") @db.VarChar(255)
  password_hash String         @default("") @db.VarChar(255)
  telefono      String?        @db.VarChar(25)
  url_perfil    String?        @unique(map: "url_perfil") @db.VarChar(120)

  @@index([id_rol], map: "fk_usuario_rol")
}

model usuario_logro {
  id_usuario_logro Int     @id @default(autoincrement())
  id_usuario       Int
  id_logro         Int
  progreso_actual  BigInt? @default(0)

  @@unique([id_usuario, id_logro], map: "id_usuario")
  @@index([id_logro], map: "fk_ulogro_logro")
}

model suscripcion_premium {
  id_suscripcion Int                        @id @default(autoincrement())
  id_usuario     Int
  fecha_inicio   DateTime                   @default(now()) @db.DateTime(0)
  fecha_fin      DateTime?                  @db.DateTime(0)
  estado         suscripcion_premium_estado @default(ACTIVA)
  monto_bs       Decimal                    @db.Decimal(12, 2)

  @@index([fecha_inicio, fecha_fin], map: "ix_suscrip_fechas")
  @@index([id_usuario, estado], map: "ix_suscrip_usuario_estado")
}

enum billetera_estado {
  ACTIVA
  BLOQUEADA
  CERRADA
}

enum servicio_estado {
  ACTIVO
  PAUSADO
  INACTIVO
  ELIMINADO
}

enum usuario_estado {
  ACTIVO
  SUSPENDIDO
  BLOQUEADO
  ELIMINADO
}

enum evento_ambiental_fuente {
  PUBLICACION
  TRANSACCION
}

enum publicidad_estado {
  PROGRAMADA
  ACTIVA
  PAUSADA
  FINALIZADA
  CANCELADA
}

enum compra_creditos_estado {
  PENDIENTE
  APROBADO
  RECHAZADO
  FALLIDO
  REVERTIDO
}

enum publicacion_estado {
  BORRADOR
  PUBLICADA
  PAUSADA
  AGOTADA
  OCULTA
  ELIMINADA
}

enum transaccion_estado {
  SOLICITADA
  ACEPTADA
  RECHAZADA
  CANCELADA
  COMPLETADA
  ANULADA
}

enum promocion_estado {
  PROGRAMADA
  ACTIVA
  PAUSADA
  FINALIZADA
  CANCELADA
}

enum suscripcion_premium_estado {
  ACTIVA
  CANCELADA
  VENCIDA
}
</file>

<file path="backend/prisma/seed.js">
import { PrismaClient } from '@prisma/client'
import bcrypt from 'bcryptjs'
const prisma = new PrismaClient()

async function main() {
  const [adminRole, userRole] = await Promise.all([
    prisma.role.upsert({ where: { name: 'ADMIN' }, update: {}, create: { name: 'ADMIN' } }),
    prisma.role.upsert({ where: { name: 'USER' }, update: {}, create: { name: 'USER' } }),
  ])

  const passwordHash = await bcrypt.hash('demo123', 10)
  const admin = await prisma.user.upsert({
    where: { email: 'demo@demo.com' },
    update: {},
    create: { email: 'demo@demo.com', name: 'Admin Demo', passwordHash, roleId: adminRole.id }
  })

  await prisma.wallet.upsert({
    where: { userId: admin.id },
    update: {},
    create: { userId: admin.id, credits: 1000 }
  })

  console.log('Seed listo:', { admin: admin.email })
}

main().catch(e=>{console.error(e); process.exit(1)}).finally(()=>prisma.$disconnect())
</file>

<file path="backend/src/app.js">
// src/app.js

// 🔧 Parche global para que JSON.stringify soporte BigInt en todas las respuestas
if (typeof BigInt !== "undefined" && !BigInt.prototype.toJSON) {
  // eslint-disable-next-line no-extend-native
  BigInt.prototype.toJSON = function () {
    return Number(this);
  };
}

import express from "express";
import cors from "cors";
import morgan from "morgan";
import routes from "./routes/index.js";
import { errorHandler } from "./middlewares/errorHandler.js";

import path from "path";
import { fileURLToPath } from "url";

const app = express();

// -------------------------------------------------------------
// Necesario para rutas absolutas (uploads y archivos estáticos)
// -------------------------------------------------------------
const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

// -------------------------------------------------------------
// Middlewares globales
// -------------------------------------------------------------
app.use(cors());                // permitir peticiones de tu frontend
app.use(morgan("dev"));         // logs en consola
app.use(express.json());        // permite JSON en body
app.use(express.urlencoded({ extended: true })); // formularios

// -------------------------------------------------------------
// Servir archivos estáticos (subidas de imágenes)
// Ruta final: http://localhost:4000/uploads/<nombre-archivo>
// -------------------------------------------------------------
app.use(
  "/uploads",
  express.static(path.join(__dirname, "..", "uploads_storage"))
);

// -------------------------------------------------------------
// Registrar todas las rutas del backend
// -------------------------------------------------------------
app.use("/api", routes);

// -------------------------------------------------------------
// Middleware para rutas no encontradas
// -------------------------------------------------------------
app.use((req, res, next) => {
  res.status(404).json({ message: "Ruta no encontrada" });
});

// -------------------------------------------------------------
// Middleware global de manejo de errores
// (Siempre debe ir al final)
// -------------------------------------------------------------
app.use(errorHandler);

export default app;
</file>

<file path="backend/src/config/env.js">
// src/config/env.js
import 'dotenv/config'

export const env = {
  NODE_ENV: process.env.NODE_ENV ?? 'development',
  PORT: Number(process.env.PORT ?? 4000),
  DATABASE_URL: process.env.DATABASE_URL,
}
</file>

<file path="backend/src/config/prisma.js">
// src/config/prisma.js
import { PrismaClient } from '@prisma/client'

export const prisma = new PrismaClient({
    log: ['query', 'error', 'warn'],
})
</file>

<file path="backend/src/middlewares/auth.js">
// src/middlewares/auth.js
import jwt from "jsonwebtoken";

// Middleware principal: requiere token válido
export function authMiddleware(req, res, next) {
  const authHeader = req.headers.authorization;

  // Esperamos "Authorization: Bearer <token>"
  if (!authHeader || !authHeader.startsWith("Bearer ")) {
    return res.status(401).json({ message: "Token de autenticación faltante" });
  }

  const token = authHeader.split(" ")[1];

  try {
    const payload = jwt.verify(token, process.env.JWT_SECRET);
    // En el payload nosotros pusimos: id_usuario, correo, rol
    req.user = payload;
    next();
  } catch (err) {
    return res
      .status(401)
      .json({ message: "Token inválido o expirado" });
  }
}

// Versión opcional: si hay token lo lee, si no, deja pasar
export function optionalAuth(req, _res, next) {
  const authHeader = req.headers.authorization;
  if (!authHeader || !authHeader.startsWith("Bearer ")) {
    return next();
  }

  const token = authHeader.split(" ")[1];

  try {
    const payload = jwt.verify(token, process.env.JWT_SECRET);
    req.user = payload;
  } catch {
    // si falla, simplemente no ponemos req.user
  }
  next();
}
</file>

<file path="backend/src/middlewares/errorHandler.js">
// src/middlewares/errorHandler.js

// Middleware de manejo global de errores (SIEMPRE 4 parámetros)
export function errorHandler(err, req, res, next) {
  console.error("❌ Error:", err);

  // Si ya se empezó a enviar la respuesta, delega a Express
  if (res.headersSent) {
    return next(err);
  }

  const status = err.status || err.statusCode || 500;
  const message =
    err.message || "Ocurrió un error inesperado en el servidor";

  const response = { message };

  // En desarrollo podemos enviar más detalles
  if (process.env.NODE_ENV !== "production") {
    response.stack = err.stack;
    if (err.code) response.code = err.code;
  }

  res.status(status).json(response);
}
</file>

<file path="backend/src/middlewares/isAdmin.js">
// src/middlewares/isAdmin.js

// Middleware simple: solo ADMIN
export function isAdmin(req, res, next) {
  if (!req.user) {
    return res.status(401).json({ message: "No autenticado" });
  }

  if (req.user.rol !== "ADMIN") {
    return res.status(403).json({ message: "Acceso solo para administradores" });
  }

  next();
}

// Middleware más general: aceptar varios roles
export function hasRole(...rolesPermitidos) {
  return (req, res, next) => {
    if (!req.user) {
      return res.status(401).json({ message: "No autenticado" });
    }

    if (!rolesPermitidos.includes(req.user.rol)) {
      return res.status(403).json({ message: "No tienes permisos suficientes" });
    }

    next();
  };
}
</file>

<file path="backend/src/modules/actividades/actividades.controller.js">
import {
  registrarActividadService,
  misActividadesService,
} from "./actividades.service.js";

export const registrarActividadController = async (req, res, next) => {
  try {
    const idUsuario = req.user.id_usuario;
    const { id_tipo_actividad, descripcion, creditos_otorgados, evidencia_url } = req.body;

    const result = await registrarActividadService({
      idUsuario,
      id_tipo_actividad,
      descripcion,
      creditos_otorgados,
      evidencia_url,
    });

    res.status(201).json(result);
  } catch (e) { next(e); }
};

export const misActividadesController = async (req, res, next) => {
  try { res.json(await misActividadesService(req.user.id_usuario)); }
  catch (e) { next(e); }
};
</file>

<file path="backend/src/modules/actividades/actividades.routes.js">
import { Router } from "express";
import { authMiddleware } from "../../middlewares/auth.js";
import {
  registrarActividadController,
  misActividadesController,
} from "./actividades.controller.js";

const router = Router();

router.use(authMiddleware);

router.post("/", registrarActividadController);
router.get("/mias", misActividadesController);

export default router;
</file>

<file path="backend/src/modules/actividades/actividades.service.js">
import { prisma } from "../../config/prisma.js";

export async function registrarActividadService({
  idUsuario,
  id_tipo_actividad,
  descripcion,
  creditos_otorgados,
  evidencia_url,
}) {
  if (!id_tipo_actividad || !descripcion || !creditos_otorgados) {
    const err = new Error("id_tipo_actividad, descripcion y creditos_otorgados son obligatorios");
    err.status = 400;
    throw err;
  }

  await prisma.$executeRawUnsafe(
    "CALL sp_registrar_actividad_sostenible(?, ?, ?, ?, ?)",
    idUsuario,
    id_tipo_actividad,
    descripcion,
    creditos_otorgados,
    evidencia_url || null
  );

  // devolver ultima actividad del usuario
  const [act] = await prisma.$queryRaw`
    SELECT *
    FROM ACTIVIDAD_SOSTENIBLE
    WHERE id_usuario = ${idUsuario}
    ORDER BY creado_en DESC, id_actividad DESC
    LIMIT 1
  `;
  return act;
}

export async function misActividadesService(idUsuario) {
  return prisma.$queryRaw`
    SELECT * FROM ACTIVIDAD_SOSTENIBLE
    WHERE id_usuario = ${idUsuario}
    ORDER BY creado_en DESC
  `;
}
</file>

<file path="backend/src/modules/auth/auth.controller.js">
import {
  registrarUsuarioService,
  loginService,
  obtenerPerfilService,
} from "./auth.service.js";

export async function registerController(req, res, next) {
  try {
    const { nombre, apellido, correo, password, telefono } = req.body;

    if (!nombre || !correo || !password) {
      return res
        .status(400)
        .json({ message: "nombre, correo y password son obligatorios" });
    }

    const usuario = await registrarUsuarioService({
      nombre,
      apellido,
      correo,
      password,
      telefono,
    });

    res.status(201).json({
      message: "Usuario registrado correctamente",
      usuario,
    });
  } catch (err) {
    next(err);
  }
}

export async function loginController(req, res, next) {
  try {
    const { correo, password } = req.body;

    if (!correo || !password) {
      return res
        .status(400)
        .json({ message: "correo y password son obligatorios" });
    }

    const result = await loginService({
      correo,
      password,
      ip: req.ip,
      userAgent: req.headers["user-agent"] || "",
    });

    res.json(result); // { token, usuario }
  } catch (err) {
    next(err);
  }
}

export async function meController(req, res, next) {
  try {
    const idUsuario = req.user.id_usuario;
    const perfil = await obtenerPerfilService(idUsuario);
    res.json(perfil);
  } catch (err) {
    next(err);
  }
}
</file>

<file path="backend/src/modules/auth/auth.routes.js">
import { Router } from "express";
import {
    registerController,
    loginController,
    meController,
} from "./auth.controller.js";
import { authMiddleware } from "../../middlewares/auth.js";

const router = Router();

// Registro público (rol COMPRADOR)
router.post("/register", registerController);

// Login
router.post("/login", loginController);

// Datos del usuario logueado
router.get("/me", authMiddleware, meController);

export default router;
</file>

<file path="backend/src/modules/auth/auth.service.js">
import bcrypt from "bcryptjs";
import jwt from "jsonwebtoken";
import { prisma } from "../../config/prisma.js";

// Helper: obtener id_rol por nombre
async function getRolId(nombreRol) {
  const rows = await prisma.$queryRaw`
    SELECT id_rol FROM ROL WHERE nombre = ${nombreRol} LIMIT 1
  `;
  if (!rows.length) {
    throw new Error(`No existe el rol ${nombreRol}`);
  }
  return rows[0].id_rol;
}

// Helper: obtener id_resultado de BITACORA_ACCESO (OK / FAIL)
async function getResultadoAccesoId(nombre) {
  const rows = await prisma.$queryRaw`
    SELECT id_resultado FROM RESULTADO_ACCESO WHERE nombre = ${nombre} LIMIT 1
  `;
  if (!rows.length) {
    throw new Error(`No existe RESULTADO_ACCESO '${nombre}'`);
  }
  return rows[0].id_resultado;
}

export async function registrarUsuarioService({
  nombre,
  apellido,
  correo,
  password,
  telefono,
}) {
  // ¿Correo ya existe?
  const existente = await prisma.$queryRaw`
    SELECT id_usuario FROM USUARIO WHERE correo = ${correo} LIMIT 1
  `;
  if (existente.length) {
    const error = new Error("El correo ya está registrado");
    error.status = 409;
    throw error;
  }

  const hash = await bcrypt.hash(password, 10);
  const idRolComprador = await getRolId("COMPRADOR");

  await prisma.$queryRaw`
    INSERT INTO USUARIO (id_rol, estado, nombre, apellido, correo, password_hash, telefono, url_perfil)
    VALUES (${idRolComprador}, 'ACTIVO', ${nombre}, ${apellido || null}, ${correo},
            ${hash}, ${telefono || null}, NULL)
  `;

  // Volver a leer el usuario insertado
  const usuarioRows = await prisma.$queryRaw`
    SELECT u.id_usuario, u.nombre, u.apellido, u.correo, u.telefono, r.nombre AS rol
    FROM USUARIO u
    JOIN ROL r ON r.id_rol = u.id_rol
    WHERE u.correo = ${correo}
    LIMIT 1
  `;

  return usuarioRows[0];
}

export async function loginService({ correo, password, ip, userAgent }) {
  const usuarios = await prisma.$queryRaw`
    SELECT u.id_usuario, u.password_hash, u.nombre, u.apellido, u.correo,
           u.estado, r.nombre AS rol
    FROM USUARIO u
    JOIN ROL r ON r.id_rol = u.id_rol
    WHERE u.correo = ${correo}
    LIMIT 1
  `;

  const user = usuarios[0];
  let resultadoNombre = "FAIL";

  if (!user) {
    const idFail = await getResultadoAccesoId(resultadoNombre);
    // Podrías registrar intento fallido sin usuario si quisieras
    const error = new Error("Credenciales inválidas");
    error.status = 401;
    throw error;
  }

  // ===== CAMBIO IMPORTANTE: compatibilidad con hashes bcrypt y texto plano =====
  let ok = false;

  try {
    // Si parece un hash bcrypt ($2a$, $2b$, $2y$...), usamos bcrypt.compare
    if (user.password_hash && user.password_hash.startsWith("$2")) {
      ok = await bcrypt.compare(password, user.password_hash);
    } else {
      // Si NO parece hash, asumimos que está en texto plano (ej: '123456')
      ok = password === user.password_hash;
    }
  } catch (e) {
    // Si bcrypt truena por hash inválido, hacemos fallback a texto plano
    ok = password === user.password_hash;
  }

  if (!ok) {
    const idFail = await getResultadoAccesoId(resultadoNombre);
    await prisma.$queryRaw`
      INSERT INTO BITACORA_ACCESO (id_usuario, fecha, direccion_ip, user_agent, id_resultado)
      VALUES (${user.id_usuario}, NOW(), ${ip}, ${userAgent}, ${idFail})
    `;
    const error = new Error("Credenciales inválidas");
    error.status = 401;
    throw error;
  }

  // Login correcto
  resultadoNombre = "OK";
  const idOk = await getResultadoAccesoId(resultadoNombre);
  await prisma.$queryRaw`
    INSERT INTO BITACORA_ACCESO (id_usuario, fecha, direccion_ip, user_agent, id_resultado)
    VALUES (${user.id_usuario}, NOW(), ${ip}, ${userAgent}, ${idOk})
  `;

  const payload = {
    id_usuario: user.id_usuario,
    correo: user.correo,
    rol: user.rol,
  };

  const token = jwt.sign(payload, process.env.JWT_SECRET, {
    expiresIn: "2h",
  });

  // No devolver hash
  delete user.password_hash;

  return {
    token,
    usuario: {
      id_usuario: user.id_usuario,
      nombre: user.nombre,
      apellido: user.apellido,
      correo: user.correo,
      rol: user.rol,
      estado: user.estado,
    },
  };
}

export async function obtenerPerfilService(idUsuario) {
  const rows = await prisma.$queryRaw`
    SELECT u.id_usuario, u.nombre, u.apellido, u.correo, u.telefono,
           u.estado, r.nombre AS rol
    FROM USUARIO u
    JOIN ROL r ON r.id_rol = u.id_rol
    WHERE u.id_usuario = ${idUsuario}
    LIMIT 1
  `;
  if (!rows.length) {
    const err = new Error("Usuario no encontrado");
    err.status = 404;
    throw err;
  }
  return rows[0];
}
</file>

<file path="backend/src/modules/catalogos/catalogos.controller.js">
import {
  listarCategorias,
  listarUnidadesMedida,
  listarPaquetesCreditos,
  listarTiposActividad,
  listarTiposPromocion,
  listarUbicacionesPublicidad,
  listarTiposLogro,
} from "./catalogos.service.js";

export const getCategorias = async (_req, res, next) => {
  try { res.json(await listarCategorias()); } catch (e) { next(e); }
};
export const getUnidadesMedida = async (_req, res, next) => {
  try { res.json(await listarUnidadesMedida()); } catch (e) { next(e); }
};
export const getPaquetesCreditos = async (_req, res, next) => {
  try { res.json(await listarPaquetesCreditos()); } catch (e) { next(e); }
};
export const getTiposActividad = async (_req, res, next) => {
  try { res.json(await listarTiposActividad()); } catch (e) { next(e); }
};
export const getTiposPromocion = async (_req, res, next) => {
  try { res.json(await listarTiposPromocion()); } catch (e) { next(e); }
};
export const getUbicacionesPublicidad = async (_req, res, next) => {
  try { res.json(await listarUbicacionesPublicidad()); } catch (e) { next(e); }
};
export const getTiposLogro = async (_req, res, next) => {
  try { res.json(await listarTiposLogro()); } catch (e) { next(e); }
};
</file>

<file path="backend/src/modules/catalogos/catalogos.routes.js">
import { Router } from "express";
import {
  getCategorias,
  getUnidadesMedida,
  getPaquetesCreditos,
  getTiposActividad,
  getTiposPromocion,
  getUbicacionesPublicidad,
  getTiposLogro,
} from "./catalogos.controller.js";

const router = Router();

router.get("/categorias", getCategorias);
router.get("/unidades-medida", getUnidadesMedida);
router.get("/paquetes-creditos", getPaquetesCreditos);
router.get("/tipos-actividad", getTiposActividad);
router.get("/tipos-promocion", getTiposPromocion);
router.get("/ubicaciones-publicidad", getUbicacionesPublicidad);
router.get("/tipos-logro", getTiposLogro);

export default router;
</file>

<file path="backend/src/modules/catalogos/catalogos.service.js">
import { prisma } from "../../config/prisma.js";

export const listarCategorias = () =>
  prisma.$queryRaw`SELECT * FROM CATEGORIA ORDER BY nombre`;

export const listarUnidadesMedida = () =>
  prisma.$queryRaw`SELECT * FROM UNIDAD_MEDIDA ORDER BY nombre`;

export const listarPaquetesCreditos = () =>
  prisma.$queryRaw`SELECT * FROM PAQUETE_CREDITOS WHERE activo = TRUE ORDER BY cantidad_creditos`;

export const listarTiposActividad = () =>
  prisma.$queryRaw`SELECT * FROM TIPO_ACTIVIDAD ORDER BY nombre`;

export const listarTiposPromocion = () =>
  prisma.$queryRaw`SELECT * FROM TIPO_PROMOCION ORDER BY nombre`;

export const listarUbicacionesPublicidad = () =>
  prisma.$queryRaw`SELECT * FROM UBICACION_PUBLICIDAD ORDER BY nombre`;

export const listarTiposLogro = () =>
  prisma.$queryRaw`SELECT * FROM TIPO_LOGRO ORDER BY nombre`;
</file>

<file path="backend/src/modules/intercambios/intercambios.controller.js">
import {
  crearIntercambioService,
  misComprasService,
  misVentasService,
  detalleTransaccionService,
} from "./intercambios.service.js";

export const crearIntercambioController = async (req, res, next) => {
  try {
    const idComprador = req.user.id_usuario;
    const { id_publicacion, creditos } = req.body;
    const tx = await crearIntercambioService({ idComprador, id_publicacion, creditos });
    res.status(201).json({ message: "Intercambio creado", transaccion: tx });
  } catch (e) { next(e); }
};

export const misComprasController = async (req, res, next) => {
  try { res.json(await misComprasService(req.user.id_usuario)); }
  catch (e) { next(e); }
};

export const misVentasController = async (req, res, next) => {
  try { res.json(await misVentasService(req.user.id_usuario)); }
  catch (e) { next(e); }
};

export const detalleTransaccionController = async (req, res, next) => {
  try { res.json(await detalleTransaccionService(+req.params.id)); }
  catch (e) { next(e); }
};
</file>

<file path="backend/src/modules/intercambios/intercambios.routes.js">
import { Router } from "express";
import { authMiddleware } from "../../middlewares/auth.js";
import {
  crearIntercambioController,
  misComprasController,
  misVentasController,
  detalleTransaccionController,
} from "./intercambios.controller.js";

const router = Router();

router.use(authMiddleware);

router.post("/", crearIntercambioController);
router.get("/mis-compras", misComprasController);
router.get("/mis-ventas", misVentasController);
router.get("/:id", detalleTransaccionController);

export default router;
</file>

<file path="backend/src/modules/intercambios/intercambios.service.js">
import { prisma } from "../../config/prisma.js";

export async function crearIntercambioService({ idComprador, id_publicacion, creditos }) {
  if (!id_publicacion || !creditos) {
    const err = new Error("id_publicacion y creditos son obligatorios");
    err.status = 400;
    throw err;
  }

  await prisma.$executeRawUnsafe(
    "CALL sp_realizar_intercambio(?, ?, ?)",
    idComprador,
    id_publicacion,
    creditos
  );

  // La última transacción creada
  const [tx] = await prisma.$queryRaw`
    SELECT *
    FROM TRANSACCION
    WHERE id_comprador = ${idComprador}
    ORDER BY id_transaccion DESC
    LIMIT 1
  `;
  return tx;
}

export async function misComprasService(idUsuario) {
  return prisma.$queryRaw`
    SELECT t.*, p.titulo
    FROM TRANSACCION t
    JOIN PUBLICACION p ON p.id_publicacion = t.id_publicacion
    WHERE t.id_comprador = ${idUsuario}
    ORDER BY t.creado_en DESC
  `;
}

export async function misVentasService(idUsuario) {
  return prisma.$queryRaw`
    SELECT t.*, p.titulo
    FROM TRANSACCION t
    JOIN PUBLICACION p ON p.id_publicacion = t.id_publicacion
    WHERE t.id_vendedor = ${idUsuario}
    ORDER BY t.creado_en DESC
  `;
}

export async function detalleTransaccionService(idTransaccion) {
  const [row] = await prisma.$queryRaw`
    SELECT t.*, p.titulo, p.descripcion, p.valor_creditos
    FROM TRANSACCION t
    JOIN PUBLICACION p ON p.id_publicacion = t.id_publicacion
    WHERE t.id_transaccion = ${idTransaccion}
    LIMIT 1
  `;
  if (!row) {
    const err = new Error("Transacción no encontrada");
    err.status = 404;
    throw err;
  }
  return row;
}
</file>

<file path="backend/src/modules/logros/logros.controller.js">
import {
  misLogrosService,
  listarLogrosService,
} from "./logros.service.js";

export const misLogrosController = async (req, res, next) => {
  try { res.json(await misLogrosService(req.user.id_usuario)); }
  catch (e) { next(e); }
};

export const listarLogrosController = async (_req, res, next) => {
  try { res.json(await listarLogrosService()); }
  catch (e) { next(e); }
};
</file>

<file path="backend/src/modules/logros/logros.routes.js">
import { Router } from "express";
import { authMiddleware } from "../../middlewares/auth.js";
import { isAdmin } from "../../middlewares/isAdmin.js";
import {
  misLogrosController,
  listarLogrosController,
} from "./logros.controller.js";

const router = Router();

router.use(authMiddleware);

router.get("/mios", misLogrosController);

// sólo admin ve catálogo completo
router.get("/", isAdmin, listarLogrosController);

export default router;
</file>

<file path="backend/src/modules/logros/logros.service.js">
import { prisma } from "../../config/prisma.js";

export const listarLogrosService = () =>
  prisma.$queryRaw`
    SELECT l.*, tl.nombre AS tipo_logro
    FROM LOGRO l
    JOIN TIPO_LOGRO tl ON tl.id_tipo_logro = l.id_tipo_logro
    ORDER BY l.id_logro
  `;

export const misLogrosService = (idUsuario) =>
  prisma.$queryRaw`
    SELECT ul.*, l.nombre, l.descripcion, l.meta_requerida, l.creditos_recompensa
    FROM USUARIO_LOGRO ul
    JOIN LOGRO l ON l.id_logro = ul.id_logro
    WHERE ul.id_usuario = ${idUsuario}
    ORDER BY l.id_logro
  `;
</file>

<file path="backend/src/modules/premium/premium.controller.js">
// premium.controller.js
import { miPlanPremiumService } from "./premium.service.js";

export const miPlanPremiumController = async (req, res, next) => {
  try { res.json(await miPlanPremiumService(req.user.id_usuario)); }
  catch (e) { next(e); }
};
</file>

<file path="backend/src/modules/premium/premium.routes.js">
// premium.routes.js
import { Router } from "express";
import { authMiddleware } from "../../middlewares/auth.js";
import {
  miPlanPremiumController,
} from "./premium.controller.js";

const router = Router();
router.use(authMiddleware);

router.get("/mi-plan", miPlanPremiumController);

export default router;
</file>

<file path="backend/src/modules/premium/premium.service.js">
// premium.service.js
import { prisma } from "../../config/prisma.js";

export const miPlanPremiumService = (idUsuario) =>
  prisma.$queryRaw`
    SELECT * FROM SUSCRIPCION_PREMIUM
    WHERE id_usuario = ${idUsuario}
    ORDER BY fecha_inicio DESC
    LIMIT 1
  `;
</file>

<file path="backend/src/modules/promociones/promociones.controller.js">
import {
  listarPromocionesService,
  crearPromocionService,
  actualizarEstadoPromocionService,
  vincularPublicacionService,
} from "./promociones.service.js";

export const listarPromocionesController = async (_req, res, next) => {
  try { res.json(await listarPromocionesService()); } catch (e) { next(e); }
};

export const crearPromocionController = async (req, res, next) => {
  try { res.status(201).json(await crearPromocionService(req.body)); }
  catch (e) { next(e); }
};

export const actualizarEstadoPromocionController = async (req, res, next) => {
  try {
    const id = +req.params.id;
    const { estado } = req.body;
    res.json(await actualizarEstadoPromocionService(id, estado));
  } catch (e) { next(e); }
};

export const vincularPublicacionController = async (req, res, next) => {
  try {
    const idPromocion = +req.params.id;
    const { id_publicacion } = req.body;
    await vincularPublicacionService(idPromocion, id_publicacion);
    res.status(201).json({ message: "Publicación vinculada" });
  } catch (e) { next(e); }
};
</file>

<file path="backend/src/modules/promociones/promociones.routes.js">
import { Router } from "express";
import { authMiddleware } from "../../middlewares/auth.js";
import { isAdmin } from "../../middlewares/isAdmin.js";
import {
  listarPromocionesController,
  crearPromocionController,
  actualizarEstadoPromocionController,
  vincularPublicacionController,
} from "./promociones.controller.js";

const router = Router();

router.use(authMiddleware, isAdmin);

router.get("/", listarPromocionesController);
router.post("/", crearPromocionController);
router.patch("/:id/estado", actualizarEstadoPromocionController);
router.post("/:id/publicaciones", vincularPublicacionController);

export default router;
</file>

<file path="backend/src/modules/promociones/promociones.service.js">
import { prisma } from "../../config/prisma.js";

export const listarPromocionesService = () =>
  prisma.$queryRaw`
    SELECT * FROM PROMOCION
    ORDER BY fecha_inicio DESC
  `;

export async function crearPromocionService(body) {
  const {
    id_tipo_promocion,
    nombre,
    descripcion,
    creditos_otorgados,
    fecha_inicio,
    fecha_fin,
    estado = "ACTIVA",
  } = body;

  if (!id_tipo_promocion || !nombre || !creditos_otorgados || !fecha_inicio || !fecha_fin) {
    const err = new Error("Faltan datos obligatorios de promoción");
    err.status = 400;
    throw err;
  }

  await prisma.$queryRaw`
    INSERT INTO PROMOCION
      (id_tipo_promocion, nombre, descripcion, creditos_otorgados,
       fecha_inicio, fecha_fin, estado)
    VALUES
      (${id_tipo_promocion}, ${nombre}, ${descripcion || null}, ${creditos_otorgados},
       ${fecha_inicio}, ${fecha_fin}, ${estado})
  `;

  const [row] = await prisma.$queryRaw`
    SELECT * FROM PROMOCION
    WHERE id_promocion = LAST_INSERT_ID()
    LIMIT 1
  `;
  return row;
}

export async function actualizarEstadoPromocionService(idPromocion, estado) {
  await prisma.$queryRaw`
    UPDATE PROMOCION
    SET estado = ${estado}
    WHERE id_promocion = ${idPromocion}
  `;
  const [row] = await prisma.$queryRaw`
    SELECT * FROM PROMOCION
    WHERE id_promocion = ${idPromocion}
    LIMIT 1
  `;
  return row;
}

export async function vincularPublicacionService(idPromocion, idPublicacion) {
  if (!idPublicacion) {
    const err = new Error("id_publicacion es obligatorio");
    err.status = 400;
    throw err;
  }
  await prisma.$queryRaw`
    INSERT IGNORE INTO PROMOCION_PUBLICACION (id_promocion, id_publicacion)
    VALUES (${idPromocion}, ${idPublicacion})
  `;
}
</file>

<file path="backend/src/modules/publicaciones/publicaciones.controller.js">
import {
  listarPublicacionesService,
  obtenerPublicacionService,
  crearPublicacionProductoService,
  crearPublicacionServicioService,
  misPublicacionesService,
  buscarPublicacionesService,
  crearCalificacionService,
  listarCalificacionesService,
} from "./publicaciones.service.js";

export const listarPublicacionesController = async (req, res, next) => {
  try {
    const { categoria, estado } = req.query;
    res.json(await listarPublicacionesService({ categoria, estado }));
  } catch (e) { next(e); }
};

export const obtenerPublicacionController = async (req, res, next) => {
  try { res.json(await obtenerPublicacionService(+req.params.id)); }
  catch (e) { next(e); }
};

export const crearPublicacionProductoController = async (req, res, next) => {
  try {
    const idUsuario = req.user.id_usuario;
    const pub = await crearPublicacionProductoService(idUsuario, req.body);
    res.status(201).json(pub);
  } catch (e) { next(e); }
};

export const crearPublicacionServicioController = async (req, res, next) => {
  try {
    const idUsuario = req.user.id_usuario;
    const pub = await crearPublicacionServicioService(idUsuario, req.body);
    res.status(201).json(pub);
  } catch (e) { next(e); }
};

export const misPublicacionesController = async (req, res, next) => {
  try {
    const idUsuario = req.user.id_usuario;
    res.json(await misPublicacionesService(idUsuario));
  } catch (e) { next(e); }
};

export const buscarPublicacionesController = async (req, res, next) => {
  try { res.json(await buscarPublicacionesService(req.query.q || "")); }
  catch (e) { next(e); }
};

export const crearCalificacionController = async (req, res, next) => {
  try {
    const idUsuario = req.user.id_usuario;
    const idPublicacion = +req.params.id;
    const { estrellas, comentario } = req.body;
    const calif = await crearCalificacionService({
      idUsuario, idPublicacion, estrellas, comentario,
    });
    res.status(201).json(calif);
  } catch (e) { next(e); }
};

export const listarCalificacionesController = async (req, res, next) => {
  try {
    res.json(await listarCalificacionesService(+req.params.id));
  } catch (e) { next(e); }
};
</file>

<file path="backend/src/modules/publicaciones/publicaciones.routes.js">
import { Router } from "express";
import { authMiddleware } from "../../middlewares/auth.js";
import {
  listarPublicacionesController,
  obtenerPublicacionController,
  crearPublicacionProductoController,
  crearPublicacionServicioController,
  misPublicacionesController,
  buscarPublicacionesController,
  crearCalificacionController,
  listarCalificacionesController,
} from "./publicaciones.controller.js";

const router = Router();

// públicas
router.get("/", listarPublicacionesController);
router.get("/busqueda", buscarPublicacionesController);
router.get("/:id", obtenerPublicacionController);
router.get("/:id/calificaciones", listarCalificacionesController);

// protegidas
router.use(authMiddleware);

router.get("/mias/listado", misPublicacionesController);
router.post("/producto", crearPublicacionProductoController);
router.post("/servicio", crearPublicacionServicioController);
router.post("/:id/calificaciones", crearCalificacionController);

export default router;
</file>

<file path="backend/src/modules/publicaciones/publicaciones.service.js">
import { prisma } from "../../config/prisma.js";

// Listar básicas (sin joins pesados)
export async function listarPublicacionesService({ categoria, estado }) {
  let where = "WHERE 1=1";
  const params = [];

  if (categoria) {
    where += " AND p.id_categoria = ?";
    params.push(parseInt(categoria, 10));
  }
  if (estado) {
    where += " AND p.estado = ?";
    params.push(estado);
  }

  const sql = `
    SELECT p.id_publicacion, p.titulo, p.descripcion, p.valor_creditos,
           p.estado, p.imagen_url, c.nombre AS categoria, u.nombre AS usuario
    FROM PUBLICACION p
    JOIN CATEGORIA c ON c.id_categoria = p.id_categoria
    JOIN USUARIO u ON u.id_usuario = p.id_usuario
    ${where}
    ORDER BY p.creado_en DESC
  `;
  // @ts-ignore
  return prisma.$queryRawUnsafe(sql, ...params);
}

export async function obtenerPublicacionService(idPublicacion) {
  const [row] = await prisma.$queryRaw`
    SELECT p.*, c.nombre AS categoria, u.nombre AS usuario
    FROM PUBLICACION p
    JOIN CATEGORIA c ON c.id_categoria = p.id_categoria
    JOIN USUARIO u ON u.id_usuario = p.id_usuario
    WHERE p.id_publicacion = ${idPublicacion}
    LIMIT 1
  `;
  if (!row) {
    const err = new Error("Publicación no encontrada");
    err.status = 404;
    throw err;
  }
  return row;
}

export async function misPublicacionesService(idUsuario) {
  return prisma.$queryRaw`
    SELECT p.*
    FROM PUBLICACION p
    WHERE p.id_usuario = ${idUsuario}
    ORDER BY p.creado_en DESC
  `;
}

// Crear PRODUCTO + PUBLICACION + PUBLICACION_PRODUCTO
export async function crearPublicacionProductoService(idUsuario, body) {
  const {
    titulo,
    descripcion,
    id_categoria,
    valor_creditos,
    imagen_url,
    producto,         // { nombre, descripcion, precio, peso }
    cantidad,
    id_um,
  } = body;

  if (!titulo || !descripcion || !id_categoria || !valor_creditos || !producto || !cantidad || !id_um) {
    const err = new Error("Faltan datos obligatorios");
    err.status = 400;
    throw err;
  }

  return prisma.$transaction(async (tx) => {
    const prod = await tx.$queryRaw`
      INSERT INTO PRODUCTO (id_categoria, nombre, descripcion, precio, peso)
      VALUES (${id_categoria}, ${producto.nombre}, ${producto.descripcion || null},
              ${producto.precio || null}, ${producto.peso || null})
    `;

    const [newProd] = await tx.$queryRaw`
      SELECT * FROM PRODUCTO
      WHERE id_producto = LAST_INSERT_ID()
      LIMIT 1
    `;

    const tipoProducto = await tx.$queryRaw`
      SELECT id_tipo_publicacion
      FROM TIPO_PUBLICACION
      WHERE nombre = 'PRODUCTO'
      LIMIT 1
    `;
    if (!tipoProducto.length) {
      const err = new Error("No existe TIPO_PUBLICACION PRODUCTO");
      err.status = 500;
      throw err;
    }

    await tx.$queryRaw`
      INSERT INTO PUBLICACION
        (id_usuario, id_categoria, id_tipo_publicacion, titulo, descripcion, valor_creditos, imagen_url)
      VALUES
        (${idUsuario}, ${id_categoria}, ${tipoProducto[0].id_tipo_publicacion},
         ${titulo}, ${descripcion}, ${valor_creditos}, ${imagen_url || null})
    `;

    const [pub] = await tx.$queryRaw`
      SELECT * FROM PUBLICACION WHERE id_publicacion = LAST_INSERT_ID() LIMIT 1
    `;

    await tx.$queryRaw`
      INSERT INTO PUBLICACION_PRODUCTO (id_publicacion, id_producto, cantidad, id_um)
      VALUES (${pub.id_publicacion}, ${newProd.id_producto}, ${cantidad}, ${id_um})
    `;

    return pub;
  });
}

// Crear SERVICIO + PUBLICACION + PUBLICACION_SERVICIO
export async function crearPublicacionServicioService(idUsuario, body) {
  const {
    titulo,
    descripcion,
    id_categoria,
    valor_creditos,
    imagen_url,
    servicio, // { nombre, descripcion, precio, duracion_min }
    horario,
  } = body;

  if (!titulo || !descripcion || !id_categoria || !valor_creditos || !servicio || !horario) {
    const err = new Error("Faltan datos obligatorios");
    err.status = 400;
    throw err;
  }

  return prisma.$transaction(async (tx) => {
    await tx.$queryRaw`
      INSERT INTO SERVICIO (id_categoria, estado, nombre, descripcion, precio, duracion_min)
      VALUES (${id_categoria}, 'ACTIVO', ${servicio.nombre}, ${servicio.descripcion || null},
              ${servicio.precio || null}, ${servicio.duracion_min || null})
    `;

    const [serv] = await tx.$queryRaw`
      SELECT * FROM SERVICIO WHERE id_servicio = LAST_INSERT_ID() LIMIT 1
    `;

    const tipoServicio = await tx.$queryRaw`
      SELECT id_tipo_publicacion
      FROM TIPO_PUBLICACION
      WHERE nombre = 'SERVICIO'
      LIMIT 1
    `;
    if (!tipoServicio.length) {
      const err = new Error("No existe TIPO_PUBLICACION SERVICIO");
      err.status = 500;
      throw err;
    }

    await tx.$queryRaw`
      INSERT INTO PUBLICACION
        (id_usuario, id_categoria, id_tipo_publicacion, titulo, descripcion, valor_creditos, imagen_url)
      VALUES
        (${idUsuario}, ${id_categoria}, ${tipoServicio[0].id_tipo_publicacion},
         ${titulo}, ${descripcion}, ${valor_creditos}, ${imagen_url || null})
    `;

    const [pub] = await tx.$queryRaw`
      SELECT * FROM PUBLICACION WHERE id_publicacion = LAST_INSERT_ID() LIMIT 1
    `;

    await tx.$queryRaw`
      INSERT INTO PUBLICACION_SERVICIO (id_publicacion, id_servicio, horario)
      VALUES (${pub.id_publicacion}, ${serv.id_servicio}, ${horario})
    `;

    return pub;
  });
}

// Búsqueda FULLTEXT
export async function buscarPublicacionesService(q) {
  if (!q.trim()) return [];
  return prisma.$queryRawUnsafe(
    `
    SELECT id_publicacion, titulo, descripcion, valor_creditos, imagen_url
    FROM PUBLICACION
    WHERE MATCH(titulo, descripcion) AGAINST (? IN NATURAL LANGUAGE MODE)
      AND estado = 'PUBLICADA'
    ORDER BY creado_en DESC
    `,
    q
  );
}

// Calificaciones
export async function crearCalificacionService({
  idUsuario,
  idPublicacion,
  estrellas,
  comentario,
}) {
  if (!estrellas) {
    const err = new Error("estrellas es obligatorio");
    err.status = 400;
    throw err;
  }

  await prisma.$queryRaw`
    INSERT INTO CALIFICACION (id_usuario, id_publicacion, estrellas, comentario)
    VALUES (${idUsuario}, ${idPublicacion}, ${estrellas}, ${comentario || null})
    ON DUPLICATE KEY UPDATE
      estrellas = VALUES(estrellas),
      comentario = VALUES(comentario)
  `;

  const [row] = await prisma.$queryRaw`
    SELECT * FROM CALIFICACION
    WHERE id_usuario = ${idUsuario} AND id_publicacion = ${idPublicacion}
    LIMIT 1
  `;
  return row;
}

export async function listarCalificacionesService(idPublicacion) {
  return prisma.$queryRaw`
    SELECT c.*, u.nombre
    FROM CALIFICACION c
    JOIN USUARIO u ON u.id_usuario = c.id_usuario
    WHERE c.id_publicacion = ${idPublicacion}
    ORDER BY c.id_calificacion DESC
  `;
}
</file>

<file path="backend/src/modules/publicidad/publicidad.controller.js">
// src/modules/publicidad/publicidad.controller.js

// Servicios propios del módulo PUBLICIDAD
import {
  crearPublicidadService,
  listarPublicidadActivaService,
  listarPublicidadAdminService,
} from "./publicidad.service.js";

// Servicio del módulo PUBLICACIONES (ruta correcta)
import { buscarPublicacionesService } from "../publicaciones/publicaciones.service.js";

/**
 * Convierte BigInt, Date, Prisma.Decimal, etc. en tipos JSON-safe
 */
function toPlain(value) {
  if (typeof value === "bigint") return Number(value);

  if (value instanceof Date)
    return value.toISOString().slice(0, 19).replace("T", " ");

  if (value && typeof value === "object") {
    if (typeof value.toNumber === "function") {
      return value.toNumber();
    }

    const prim = value.valueOf?.();
    if (prim != null && typeof prim !== "object") return prim;

    if (Array.isArray(value)) return value.map((v) => toPlain(v));

    const out = {};
    for (const [k, v] of Object.entries(value)) out[k] = toPlain(v);
    return out;
  }

  return value;
}

/**
 * POST /api/publicidad
 * Crear anuncio publicitario (solo admin)
 */
export const crearPublicidadController = async (req, res, next) => {
  try {
    const idUsuario = req.user.id_usuario;
    const data = await crearPublicidadService(idUsuario, req.body);
    res.status(201).json(toPlain(data));
  } catch (err) {
    next(err);
  }
};

/**
 * GET /api/publicidad/activa
 * Publicidad visible para el FRONT (solo activas y en rango)
 */
export const listarPublicidadActivaController = async (req, res, next) => {
  try {
    const data = await listarPublicidadActivaService();
    res.json(toPlain(data));
  } catch (err) {
    next(err);
  }
};

/**
 * GET /api/publicidad/admin
 * Lista TODA la publicidad (panel administrador)
 */
export const listarPublicidadAdminController = async (req, res, next) => {
  try {
    const data = await listarPublicidadAdminService();
    res.json(toPlain(data));
  } catch (err) {
    next(err);
  }
};

/**
 * GET /api/publicidad/buscar-publicaciones?q=
 * Buscar publicaciones para vincularlas a un banner
 */
export const buscarPublicacionesParaPublicidadController = async (
  req,
  res,
  next
) => {
  try {
    const q = req.query.q || "";
    const data = await buscarPublicacionesService(q);
    res.json(toPlain(data));
  } catch (err) {
    next(err);
  }
};
</file>

<file path="backend/src/modules/publicidad/publicidad.routes.js">
import { Router } from "express";
import { authMiddleware } from "../../middlewares/auth.js";
import {
  listarPublicidadActivaController,
  crearPublicidadController,
} from "./publicidad.controller.js";

const router = Router();

router.get("/", listarPublicidadActivaController);

router.use(authMiddleware);
router.post("/", crearPublicidadController);

export default router;
</file>

<file path="backend/src/modules/publicidad/publicidad.service.js">
// src/modules/publicidad/publicidad.service.js
import { prisma } from "../../config/prisma.js";

// Publicidad visible para el FRONT (activa y en rango de fechas)
export const listarPublicidadActivaService = () =>
  prisma.$queryRaw`
    SELECT p.*, u.nombre AS usuario
    FROM PUBLICIDAD p
    JOIN USUARIO u ON u.id_usuario = p.id_usuario
    WHERE p.estado = 'ACTIVA'
      AND NOW() BETWEEN p.fecha_inicio AND p.fecha_fin
    ORDER BY p.fecha_inicio DESC, p.id_publicidad DESC
  `;

// Publicidad para ADMIN (toda la publicidad)
export const listarPublicidadAdminService = () =>
  prisma.$queryRaw`
    SELECT p.*, u.nombre AS usuario
    FROM PUBLICIDAD p
    JOIN USUARIO u ON u.id_usuario = p.id_usuario
    ORDER BY p.fecha_inicio DESC, p.id_publicidad DESC
  `;

// Crear una nueva PUBLICIDAD
export const crearPublicidadService = async (idUsuario, body) => {
  const {
    id_ubicacion,
    titulo,
    descripcion,
    url_destino,
    fecha_inicio,
    fecha_fin,
    costo_creditos,
  } = body;

  if (!id_ubicacion || !titulo || !fecha_inicio || !fecha_fin || !costo_creditos) {
    const err = new Error("Faltan datos obligatorios de publicidad");
    err.status = 400;
    throw err;
  }

  // INSERT
  await prisma.$queryRaw`
    INSERT INTO PUBLICIDAD
      (id_usuario, id_ubicacion, estado, titulo, descripcion, url_destino,
       fecha_inicio, fecha_fin, costo_creditos)
    VALUES
      (
        ${idUsuario},
        ${id_ubicacion},
        'PROGRAMADA',
        ${titulo},
        ${descripcion || null},
        ${url_destino || null},
        ${fecha_inicio},
        ${fecha_fin},
        ${costo_creditos}
      )
  `;

  // Devolver el registro recién creado
  const [row] = await prisma.$queryRaw`
    SELECT *
    FROM PUBLICIDAD
    WHERE id_publicidad = LAST_INSERT_ID()
    LIMIT 1
  `;
  return row;
};
</file>

<file path="backend/src/modules/reportes/reportes.controller.js">
// src/modules/reportes/reportes.controller.js
import {
  repUsuariosActivosService,
  repUsuariosAbandonadosService,
  repIngresosCreditosService,
  repCreditosGenConsService,
  repIntercambiosCategoriaService,
  repPublicacionesVsIntercambiosService,
  repImpactoAcumuladoService,
  rankingUsuariosService,
} from "./reportes.service.js";

/**
 * Helper para convertir BigInt / Date / Decimal a tipos serializables
 */
function toPlain(value) {
  if (typeof value === "bigint") return Number(value);

  if (value instanceof Date) {
    return value.toISOString().slice(0, 19).replace("T", " ");
  }

  if (value && typeof value === "object") {
    if (typeof value.toNumber === "function") return value.toNumber();

    const prim = value.valueOf?.();
    if (prim != null && typeof prim !== "object") return prim;

    if (Array.isArray(value)) return value.map((v) => toPlain(v));

    const out = {};
    for (const [k, v] of Object.entries(value)) {
      out[k] = toPlain(v);
    }
    return out;
  }

  return value;
}

function rango(req) {
  return { desde: req.query.desde, hasta: req.query.hasta };
}

export const repUsuariosActivosController = async (req, res, next) => {
  try {
    const data = await repUsuariosActivosService(rango(req));
    res.json(toPlain(data));
  } catch (e) {
    next(e);
  }
};

export const repUsuariosAbandonadosController = async (req, res, next) => {
  try {
    const data = await repUsuariosAbandonadosService(rango(req));
    res.json(toPlain(data));
  } catch (e) {
    next(e);
  }
};

export const repIngresosCreditosController = async (req, res, next) => {
  try {
    const data = await repIngresosCreditosService(rango(req));
    res.json(toPlain(data));
  } catch (e) {
    next(e);
  }
};

export const repCreditosGenConsController = async (req, res, next) => {
  try {
    const data = await repCreditosGenConsService(rango(req));
    res.json(toPlain(data));
  } catch (e) {
    next(e);
  }
};

export const repIntercambiosCategoriaController = async (req, res, next) => {
  try {
    const data = await repIntercambiosCategoriaService(rango(req));
    res.json(toPlain(data));
  } catch (e) {
    next(e);
  }
};

export const repPublicacionesVsIntercambiosController = async (
  req,
  res,
  next
) => {
  try {
    const data = await repPublicacionesVsIntercambiosService(rango(req));
    res.json(toPlain(data));
  } catch (e) {
    next(e);
  }
};

export const repImpactoAcumuladoController = async (req, res, next) => {
  try {
    const { id_tipo_reporte, id_periodo } = req.query;

    // Asegurar números (o null)
    const tipoReporte = id_tipo_reporte ? parseInt(id_tipo_reporte, 10) : null;
    const periodo     = id_periodo ? parseInt(id_periodo, 10) : null;

    const data = await repImpactoAcumuladoService(tipoReporte, periodo);
    res.json(data);
  } catch (e) {
    next(e);
  }
};

export const rankingUsuariosController = async (req, res, next) => {
  try {
    const idPeriodo = req.query.id_periodo
      ? parseInt(req.query.id_periodo, 10)
      : null;
    const limit = req.query.limit ? parseInt(req.query.limit, 10) : null;

    const data = await rankingUsuariosService(idPeriodo, limit);
    res.json(toPlain(data));
  } catch (e) {
    next(e);
  }
};
</file>

<file path="backend/src/modules/reportes/reportes.routes.js">
import { Router } from "express";
import { authMiddleware } from "../../middlewares/auth.js";
import { isAdmin } from "../../middlewares/isAdmin.js";
import {
  repUsuariosActivosController,
  repUsuariosAbandonadosController,
  repIngresosCreditosController,
  repCreditosGenConsController,
  repIntercambiosCategoriaController,
  repPublicacionesVsIntercambiosController,
  repImpactoAcumuladoController,
  rankingUsuariosController,
} from "./reportes.controller.js";

const router = Router();

router.use(authMiddleware, isAdmin);

router.get("/usuarios-activos", repUsuariosActivosController);
router.get("/usuarios-abandonados", repUsuariosAbandonadosController);
router.get("/ingresos-creditos", repIngresosCreditosController);
router.get("/creditos-generados-consumidos", repCreditosGenConsController);
router.get("/intercambios-categoria", repIntercambiosCategoriaController);
router.get("/publicaciones-intercambios", repPublicacionesVsIntercambiosController);
router.get("/impacto-acumulado", repImpactoAcumuladoController);
router.get("/ranking-usuarios", rankingUsuariosController);

export default router;
</file>

<file path="backend/src/modules/reportes/reportes.service.js">
// src/modules/reportes/reportes.service.js
import { prisma } from "../../config/prisma.js";

function rangoFechas({ desde, hasta }) {
  return [desde || "2000-01-01", hasta || "2100-01-01"];
}

export async function repUsuariosActivosService(r) {
  const [rows] = await prisma.$queryRawUnsafe(
    "CALL sp_rep_usuarios_activos(?, ?)",
    ...rangoFechas(r)
  );
  return rows;
}

export async function repUsuariosAbandonadosService(r) {
  const [rows] = await prisma.$queryRawUnsafe(
    "CALL sp_rep_usuarios_abandonados(?, ?)",
    ...rangoFechas(r)
  );
  return rows;
}

export async function repIngresosCreditosService(r) {
  const [rows] = await prisma.$queryRawUnsafe(
    "CALL sp_rep_ingresos_creditos(?, ?)",
    ...rangoFechas(r)
  );
  return rows;
}

export async function repCreditosGenConsService(r) {
  const [rows] = await prisma.$queryRawUnsafe(
    "CALL sp_rep_creditos_generados_vs_consumidos(?, ?)",
    ...rangoFechas(r)
  );
  return rows;
}

export async function repIntercambiosCategoriaService(r) {
  const [rows] = await prisma.$queryRawUnsafe(
    "CALL sp_rep_intercambios_por_categoria(?, ?)",
    ...rangoFechas(r)
  );
  return rows;
}

export async function repPublicacionesVsIntercambiosService(r) {
  const [rows] = await prisma.$queryRawUnsafe(
    "CALL sp_rep_publicaciones_vs_intercambios(?, ?)",
    ...rangoFechas(r)
  );
  return rows;
}

export async function repImpactoAcumuladoService(tipoReporte, periodo) {
  const [rows] = await prisma.$queryRawUnsafe(
    "CALL sp_generar_reporte_impacto(?, ?, NULL)",
    tipoReporte,
    periodo,
  );
  return rows;
}


export async function rankingUsuariosService(idPeriodo, limit) {
  const [rows] = await prisma.$queryRawUnsafe(
    "CALL sp_obtener_ranking_usuarios(?, ?)",
    idPeriodo ?? null,
    limit ?? null
  );
  return rows;
}
</file>

<file path="backend/src/modules/uploads/multer.js">
// uploads/multer.js
import multer from "multer";
import { v4 as uuid } from "uuid";
import path from "path";

const storage = multer.diskStorage({
  destination: (req, file, cb) => {
    cb(null, "uploads_storage"); // carpeta real donde iran las imágenes
  },
  filename: (req, file, cb) => {
    const unique = uuid();
    const ext = path.extname(file.originalname);
    cb(null, unique + ext);
  },
});

export const upload = multer({ storage });
</file>

<file path="backend/src/modules/uploads/uploads.controller.js">
import { procesarArchivoService } from "./uploads.service.js";

export const subirArchivoController = async (req, res, next) => {
  try {
    if (!req.file) {
      return res.status(400).json({ message: "No enviaste ningún archivo" });
    }

    const url = await procesarArchivoService(req.file);

    res.json({
      message: "Archivo subido correctamente",
      url,
    });
  } catch (err) {
    next(err);
  }
};
</file>

<file path="backend/src/modules/uploads/uploads.routes.js">
import { Router } from "express";
import { authMiddleware } from "../../middlewares/auth.js";
import { upload } from "./multer.js";
import { subirArchivoController } from "./uploads.controller.js";

const router = Router();

// Ruta protegida: requiere login
router.post("/", authMiddleware, upload.single("archivo"), subirArchivoController);

export default router;
</file>

<file path="backend/src/modules/uploads/uploads.service.js">
import path from "path";

export async function procesarArchivoService(file) {
  // URL pública final (ajústala según tu hosting)
  const url = `/uploads/${file.filename}`;

  // Puedes almacenar archivo en S3, Cloudinary o FS local.
  // Aquí usamos local para desarrollo.
  
  return url;
}
</file>

<file path="backend/src/modules/usuarios/usuarios.controller.js">
import {
  listarUsuariosService,
  crearUsuarioAdminService,
  actualizarUsuarioService,
  cambiarEstadoUsuarioService,
  obtenerHistorialUsuarioService,
} from "./usuarios.service.js";

export async function listarUsuariosController(req, res, next) {
  try {
    const usuarios = await listarUsuariosService();
    res.json(usuarios);
  } catch (err) {
    next(err);
  }
}

export async function crearUsuarioAdminController(req, res, next) {
  try {
    const usuario = await crearUsuarioAdminService(req.body);
    res.status(201).json(usuario);
  } catch (err) {
    next(err);
  }
}

export async function actualizarUsuarioController(req, res, next) {
  try {
    const id = parseInt(req.params.id, 10);
    const usuario = await actualizarUsuarioService(id, req.body);
    res.json(usuario);
  } catch (err) {
    next(err);
  }
}

export async function cambiarEstadoUsuarioController(req, res, next) {
  try {
    const id = parseInt(req.params.id, 10);
    const { estado } = req.body;
    const usuario = await cambiarEstadoUsuarioService(id, estado);
    res.json(usuario);
  } catch (err) {
    next(err);
  }
}

export async function obtenerHistorialUsuarioController(req, res, next) {
  try {
    const id = parseInt(req.params.id, 10);
    const historial = await obtenerHistorialUsuarioService(id);
    res.json(historial);
  } catch (err) {
    next(err);
  }
}
</file>

<file path="backend/src/modules/usuarios/usuarios.routes.js">
import { Router } from "express";
import { authMiddleware } from "../../middlewares/auth.js";
import { isAdmin } from "../../middlewares/isAdmin.js";
import {
  listarUsuariosController,
  crearUsuarioAdminController,
  actualizarUsuarioController,
  cambiarEstadoUsuarioController,
  obtenerHistorialUsuarioController,
} from "./usuarios.controller.js";

const router = Router();

// Todo lo de aquí requiere admin
router.use(authMiddleware, isAdmin);

// GET /api/usuarios
router.get("/", listarUsuariosController);

// POST /api/usuarios
router.post("/", crearUsuarioAdminController);

// PUT /api/usuarios/:id
router.put("/:id", actualizarUsuarioController);

// PATCH /api/usuarios/:id/estado
router.patch("/:id/estado", cambiarEstadoUsuarioController);

// GET /api/usuarios/:id/historial
router.get("/:id/historial", obtenerHistorialUsuarioController);

export default router;
</file>

<file path="backend/src/modules/usuarios/usuarios.service.js">
import bcrypt from "bcryptjs";
import { prisma } from "../../config/prisma.js";

export async function listarUsuariosService() {
  const rows = await prisma.$queryRaw`
    SELECT u.id_usuario, u.nombre, u.apellido, u.correo, u.telefono,
           u.estado, r.nombre AS rol
    FROM USUARIO u
    JOIN ROL r ON r.id_rol = u.id_rol
    ORDER BY u.id_usuario DESC
  `;
  return rows;
}

export async function crearUsuarioAdminService({
  nombre,
  apellido,
  correo,
  telefono,
  password,
  id_rol,
  estado = "ACTIVO",
}) {
  if (!nombre || !correo || !password || !id_rol) {
    const err = new Error("nombre, correo, password e id_rol son obligatorios");
    err.status = 400;
    throw err;
  }

  const existente = await prisma.$queryRaw`
    SELECT id_usuario FROM USUARIO WHERE correo = ${correo} LIMIT 1
  `;
  if (existente.length) {
    const error = new Error("El correo ya está registrado");
    error.status = 409;
    throw error;
  }

  const hash = await bcrypt.hash(password, 10);

  await prisma.$queryRaw`
    INSERT INTO USUARIO (id_rol, estado, nombre, apellido, correo, password_hash, telefono, url_perfil)
    VALUES (${id_rol}, ${estado}, ${nombre}, ${apellido || null}, ${correo}, ${hash},
            ${telefono || null}, NULL)
  `;

  const rows = await prisma.$queryRaw`
    SELECT u.id_usuario, u.nombre, u.apellido, u.correo, u.telefono,
           u.estado, r.nombre AS rol
    FROM USUARIO u
    JOIN ROL r ON r.id_rol = u.id_rol
    WHERE u.correo = ${correo}
    LIMIT 1
  `;
  return rows[0];
}

export async function actualizarUsuarioService(idUsuario, data) {
  const { nombre, apellido, telefono, id_rol } = data;

  await prisma.$queryRaw`
    UPDATE USUARIO
    SET nombre = COALESCE(${nombre}, nombre),
        apellido = COALESCE(${apellido}, apellido),
        telefono = COALESCE(${telefono}, telefono),
        id_rol = COALESCE(${id_rol}, id_rol)
    WHERE id_usuario = ${idUsuario}
  `;

  const rows = await prisma.$queryRaw`
    SELECT u.id_usuario, u.nombre, u.apellido, u.correo, u.telefono,
           u.estado, r.nombre AS rol
    FROM USUARIO u
    JOIN ROL r ON r.id_rol = u.id_rol
    WHERE u.id_usuario = ${idUsuario}
    LIMIT 1
  `;
  if (!rows.length) {
    const err = new Error("Usuario no encontrado");
    err.status = 404;
    throw err;
  }
  return rows[0];
}

export async function cambiarEstadoUsuarioService(idUsuario, estado) {
  if (!estado) {
    const err = new Error("estado es obligatorio");
    err.status = 400;
    throw err;
  }

  await prisma.$queryRaw`
    UPDATE USUARIO
    SET estado = ${estado}
    WHERE id_usuario = ${idUsuario}
  `;

  const rows = await prisma.$queryRaw`
    SELECT u.id_usuario, u.nombre, u.apellido, u.correo, u.telefono,
           u.estado, r.nombre AS rol
    FROM USUARIO u
    JOIN ROL r ON r.id_rol = u.id_rol
    WHERE u.id_usuario = ${idUsuario}
    LIMIT 1
  `;
  if (!rows.length) {
    const err = new Error("Usuario no encontrado");
    err.status = 404;
    throw err;
  }
  return rows[0];
}

export async function obtenerHistorialUsuarioService(idUsuario) {
  // Llama a tu SP sp_obtener_historial_usuario
  const result = await prisma.$queryRawUnsafe(
    "CALL sp_obtener_historial_usuario(?)",
    idUsuario
  );
  // En MySQL, CALL devuelve [rows, meta]; nos quedamos con rows[0]
  return result[0] || result;
}
</file>

<file path="backend/src/modules/wallet/wallet.controller.js">
import {
  obtenerMisCreditosService,
  obtenerMisMovimientosService,
  comprarCreditosService,
  obtenerMisComprasService,
} from "./wallet.service.js";

export async function getMisCreditosController(req, res, next) {
  try {
    const idUsuario = req.user.id_usuario;
    const data = await obtenerMisCreditosService(idUsuario);
    res.json(data);
  } catch (err) {
    next(err);
  }
}

export async function getMisMovimientosController(req, res, next) {
  try {
    const idUsuario = req.user.id_usuario;
    const data = await obtenerMisMovimientosService(idUsuario);
    res.json(data);
  } catch (err) {
    next(err);
  }
}

export async function postCompraCreditosController(req, res, next) {
  try {
    const idUsuario = req.user.id_usuario;
    const { idPaquete, idTransaccionPago } = req.body;

    if (!idPaquete) {
      return res.status(400).json({ message: "idPaquete es obligatorio" });
    }

    const billetera = await comprarCreditosService({
      idUsuario,
      idPaquete,
      idTransaccionPago: idTransaccionPago || null,
    });

    res.status(201).json({
      message: "Compra aprobada",
      billetera,
    });
  } catch (err) {
    next(err);
  }
}

export async function getMisComprasController(req, res, next) {
  try {
    const idUsuario = req.user.id_usuario;
    const compras = await obtenerMisComprasService(idUsuario);
    res.json(compras);
  } catch (err) {
    next(err);
  }
}
</file>

<file path="backend/src/modules/wallet/wallet.routes.js">
import { Router } from "express";
import { authMiddleware } from "../../middlewares/auth.js";
import {
  getMisCreditosController,
  getMisMovimientosController,
  postCompraCreditosController,
  getMisComprasController,
} from "./wallet.controller.js";

const router = Router();

router.use(authMiddleware);

// GET /api/wallet/mis-creditos
router.get("/mis-creditos", getMisCreditosController);

// GET /api/wallet/mis-movimientos
router.get("/mis-movimientos", getMisMovimientosController);

// POST /api/wallet/compra-creditos
router.post("/compra-creditos", postCompraCreditosController);

// GET /api/wallet/compras
router.get("/compras", getMisComprasController);

export default router;
</file>

<file path="backend/src/modules/wallet/wallet.service.js">
import { prisma } from "../../config/prisma.js";

// Helper para convertir BigInt / Decimal a Number
function toNumberSafe(value, def = 0) {
  if (value == null) return def;

  if (typeof value === "bigint") return Number(value);

  if (typeof value === "object" && typeof value.toNumber === "function") {
    return value.toNumber();
  }

  const num = Number(value);
  return Number.isNaN(num) ? def : num;
}

function normalizeBilleteraRow(row) {
  if (!row) {
    return {
      saldo_creditos: 0,
      saldo_bs: 0,
    };
  }

  return {
    saldo_creditos: toNumberSafe(row.saldo_creditos, 0),
    saldo_bs: toNumberSafe(row.saldo_bs, 0),
  };
}

export async function obtenerMisCreditosService(idUsuario) {
  const rows = await prisma.$queryRaw`
    SELECT saldo_creditos, saldo_bs
    FROM BILLETERA
    WHERE id_usuario = ${idUsuario}
    LIMIT 1
  `;

  return normalizeBilleteraRow(rows[0]);
}

export async function obtenerMisMovimientosService(idUsuario) {
  const rows = await prisma.$queryRaw`
    SELECT m.id_movimiento,
           m.cantidad,
           m.saldo_anterior,
           m.saldo_posterior,
           m.id_referencia,
           m.creado_en,
           tm.nombre AS tipo_movimiento,
           tr.nombre AS tipo_referencia
    FROM MOVIMIENTO_CREDITOS m
    JOIN TIPO_MOVIMIENTO tm ON tm.id_tipo_movimiento = m.id_tipo_movimiento
    JOIN TIPO_REFERENCIA tr ON tr.id_tipo_referencia = m.id_tipo_referencia
    WHERE m.id_usuario = ${idUsuario}
    ORDER BY m.creado_en DESC, m.id_movimiento DESC
  `;

  // si quieres, aquí también podrías normalizar BigInt, pero por ahora lo dejamos
  return rows;
}

export async function comprarCreditosService({
  idUsuario,
  idPaquete,
  idTransaccionPago,
}) {
  // Llamar al SP
  await prisma.$executeRawUnsafe(
    "CALL sp_compra_creditos_aprobar(?, ?, ?)",
    idUsuario,
    idPaquete,
    idTransaccionPago
  );

  const rows = await prisma.$queryRaw`
    SELECT saldo_creditos, saldo_bs
    FROM BILLETERA
    WHERE id_usuario = ${idUsuario}
    LIMIT 1
  `;

  return normalizeBilleteraRow(rows[0]);
}

export async function obtenerMisComprasService(idUsuario) {
  const rows = await prisma.$queryRaw`
    SELECT c.id_compra,
           c.id_paquete,
           p.nombre AS paquete,
           p.cantidad_creditos,
           c.monto_bs,
           c.estado,
           c.id_transaccion_pago,
           c.creado_en
    FROM COMPRA_CREDITOS c
    JOIN PAQUETE_CREDITOS p ON p.id_paquete = c.id_paquete
    WHERE c.id_usuario = ${idUsuario}
    ORDER BY c.creado_en DESC, c.id_compra DESC
  `;
  return rows;
}
</file>

<file path="backend/src/routes/index.js">
// src/routes/index.js
import { Router } from 'express';

import authRoutes from '../modules/auth/auth.routes.js';
import usuariosRoutes from '../modules/usuarios/usuarios.routes.js';
import catalogosRoutes from '../modules/catalogos/catalogos.routes.js';
import walletRoutes from '../modules/wallet/wallet.routes.js';
import publicacionesRoutes from '../modules/publicaciones/publicaciones.routes.js';
import intercambiosRoutes from '../modules/intercambios/intercambios.routes.js';
import actividadesRoutes from '../modules/actividades/actividades.routes.js';
import promocionesRoutes from '../modules/promociones/promociones.routes.js';
import publicidadRoutes from '../modules/publicidad/publicidad.routes.js';
import logrosRoutes from '../modules/logros/logros.routes.js';
import premiumRoutes from '../modules/premium/premium.routes.js';
import reportesRoutes from '../modules/reportes/reportes.routes.js';
import uploadsRoutes from '../modules/uploads/uploads.routes.js';

const router = Router();

router.use('/auth', authRoutes);
router.use('/usuarios', usuariosRoutes);
router.use('/catalogos', catalogosRoutes);
router.use('/wallet', walletRoutes);
router.use('/publicaciones', publicacionesRoutes);
router.use('/intercambios', intercambiosRoutes);
router.use('/actividades-sostenibles', actividadesRoutes);
router.use('/promociones', promocionesRoutes);
router.use('/publicidad', publicidadRoutes);
router.use('/logros', logrosRoutes);
router.use('/premium', premiumRoutes);
router.use('/reportes', reportesRoutes);
router.use('/uploads', uploadsRoutes);

export default router;
</file>

<file path="backend/src/server.js">
// src/server.js
import app from './app.js'
import { env } from './config/env.js'

const PORT = env.PORT

app.listen(PORT, () => {
    console.log(`🚀 API running on http://localhost:${PORT}`)
})
</file>

<file path="backend/utils/jsonBigInt.js">
export function toJsonSafe(value) {
  if (typeof value === "bigint") {
    return Number(value);            // <- si prefieres string: value.toString()
  }

  if (Array.isArray(value)) {
    return value.map(toJsonSafe);
  }

  if (value !== null && typeof value === "object") {
    const out = {};
    for (const key in value) {
      out[key] = toJsonSafe(value[key]);
    }
    return out;
  }

  return value;
}
</file>

<file path="docker-compose.yml">
version: "3.9"
services:
  db:
    image: mysql:8.0
    restart: unless-stopped
    environment:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_DATABASE: appdb
    ports:
      - "3306:3306"
    volumes:
      - db_data:/var/lib/mysql
      - ./infra/db/init.sql:/docker-entrypoint-initdb.d/1-init.sql
      - ./infra/db/seed.sql:/docker-entrypoint-initdb.d/2-seed.sql
  backend:
    build: ./backend
    working_dir: /app
    env_file: ./backend/.env
    depends_on:
      - db
    ports:
      - "4000:4000"
    command: sh -c "npx prisma migrate deploy && node src/server.js"
    volumes:
      - ./backend:/app
  frontend:
    build: ./frontend
    working_dir: /app
    ports:
      - "5173:5173"
    environment:
      - VITE_API_URL=http://localhost:4000/api
    command: npm run dev -- --host
    volumes:
      - ./frontend:/app
volumes:
  db_data:
</file>

<file path="frontend/index.html">
<!doctype html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <title>Digital Barter</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  </head>
  <body class="bg-gray-100">
    <div id="root"></div>
    <script type="module" src="/src/main.jsx"></script>
  </body>
</html>
</file>

<file path="frontend/package.json">
{
  "name": "frontend",
  "version": "0.0.1",
  "private": true,
  "scripts": {
    "dev": "vite",
    "build": "vite build",
    "preview": "vite preview"
  },
  "dependencies": {
    "react": "^18.3.1",
    "react-dom": "^18.3.1",
    "react-router-dom": "^6.28.0",
    "recharts": "^3.4.1"
  },
  "devDependencies": {
    "@vitejs/plugin-react": "^4.3.4",
    "autoprefixer": "^10.4.20",
    "postcss": "^8.4.49",
    "tailwindcss": "^3.4.14",
    "vite": "^5.4.0"
  }
}
</file>

<file path="frontend/postcss.config.js">
module.exports = {
  plugins: {
    tailwindcss: {},
    autoprefixer: {}
  }
};
</file>

<file path="frontend/src/App.jsx">
import React from "react";
import AppRouter from "./router.jsx";

export default function App() {
  return <AppRouter />;
}
</file>

<file path="frontend/src/components/Layout.jsx">
import React from "react";
import Navbar from "./Navbar.jsx";

export default function Layout({ children }) {
  return (
    <div className="min-h-screen flex flex-col">
      <Navbar />
      <main className="flex-1 max-w-6xl w-full mx-auto px-4 py-4">
        {children}
      </main>
    </div>
  );
}
</file>

<file path="frontend/src/components/Navbar.jsx">
import React from "react";
import { useNavigate } from "react-router-dom";
import { logout } from "../services/api.js";

export default function Navbar() {
  const navigate = useNavigate();
  const usuarioJson = localStorage.getItem("usuario");
  let usuario = null;

  try {
    usuario = usuarioJson ? JSON.parse(usuarioJson) : null;
  } catch {
    usuario = null;
  }

  const handleLogout = () => {
    logout();
    navigate("/login");
  };

  return (
    <header className="w-full bg-white border-b border-gray-200 px-4 py-2 flex items-center justify-between">
      <div className="flex items-center gap-2">
        <span className="font-bold text-lg text-blue-700">Digital Barter</span>
        <span className="text-xs text-gray-500 hidden sm:inline">
          Panel principal
        </span>
      </div>

      <div className="flex items-center gap-3">
        {usuario && (
          <div className="text-right">
            <p className="text-sm font-medium">
              {usuario.nombre ?? usuario.correo ?? "Usuario"}
            </p>
            <p className="text-xs text-gray-500">
              {usuario.rol ?? "Rol no asignado"}
            </p>
          </div>
        )}
        <button
          type="button"
          onClick={handleLogout}
          className="px-3 py-1 text-xs rounded-md border border-gray-300 hover:bg-gray-100"
        >
          Cerrar sesión
        </button>
      </div>
    </header>
  );
}
</file>

<file path="frontend/src/components/ProtectedRoute.jsx">
import React from "react";
import { Navigate, useLocation } from "react-router-dom";

export default function ProtectedRoute({ children }) {
  const token = localStorage.getItem("token");
  const location = useLocation();

  if (!token) {
    return <Navigate to="/login" state={{ from: location }} replace />;
  }

  return children;
}
</file>

<file path="frontend/src/index.css">
@tailwind base;
@tailwind components;
@tailwind utilities;

/* estilos globales */
body {
  @apply bg-gray-100 text-gray-900;
}

.btn-primary {
  @apply inline-flex items-center justify-center px-4 py-2 rounded-md bg-blue-600 text-white text-sm font-medium hover:bg-blue-700 transition;
}

.card {
  @apply bg-white rounded-lg shadow-sm border border-gray-200 p-4;
}
</file>

<file path="frontend/src/main.jsx">
import React from "react";
import ReactDOM from "react-dom/client";
import { BrowserRouter } from "react-router-dom";
import App from "./App.jsx";
import "./index.css";

ReactDOM.createRoot(document.getElementById("root")).render(
  <React.StrictMode>
    <BrowserRouter>
      <App />
    </BrowserRouter>
  </React.StrictMode>
);
</file>

<file path="frontend/src/pages/BackendLab.jsx">
// frontend/src/pages/BackendLab.jsx
import React, { useEffect, useState } from "react";

// Usa la misma URL base del backend que ya usas en el proyecto
const API_BASE_URL =
  import.meta.env.VITE_API_URL || "http://localhost:4000/api";

function loadToken() {
  return localStorage.getItem("token") || "";
}

export default function BackendLab() {
  const [token, setToken] = useState(loadToken());
  const [loading, setLoading] = useState(false);
  const [lastRequest, setLastRequest] = useState(null);
  const [lastResponse, setLastResponse] = useState(null);
  const [error, setError] = useState("");

  // ====== AUTH: registro / login ======
  const [regNombre, setRegNombre] = useState("Ana");
  const [regApellido, setRegApellido] = useState("Demo");
  const [regCorreo, setRegCorreo] = useState("ana.demo@example.com");
  const [regPassword, setRegPassword] = useState("ana12345");
  const [regTelefono, setRegTelefono] = useState("70000001");

  const [loginCorreo, setLoginCorreo] = useState("ana.demo@example.com");
  const [loginPassword, setLoginPassword] = useState("ana12345");

  // ====== Usuarios / historial ======
  const [userIdHistorial, setUserIdHistorial] = useState("");

  // ====== Wallet ======
  const [idPaquete, setIdPaquete] = useState("1");
  const [montoPagado, setMontoPagado] = useState("100");
  const [refPago, setRefPago] = useState("TEST-001");

  // ====== Intercambios ======
  const [idPublicacionInter, setIdPublicacionInter] = useState("");
  const [creditosInter, setCreditosInter] = useState("");

  // ====== Actividades ======
  const [idTipoAct, setIdTipoAct] = useState("1");
  const [descAct, setDescAct] = useState("Entregó 5kg de papel para reciclaje");
  const [credAct, setCredAct] = useState("10");

  // ====== Reportes ======
  const [desdeRep, setDesdeRep] = useState("2025-11-01");
  const [hastaRep, setHastaRep] = useState("2025-11-30");

  // ====== Request manual ======
  const [manualPath, setManualPath] = useState("/wallet/mis-creditos");
  const [manualMethod, setManualMethod] = useState("GET");
  const [manualBody, setManualBody] = useState("{\n  \n}");

  useEffect(() => {
    if (token) localStorage.setItem("token", token);
  }, [token]);

  async function callApi(moduleName, actionName, path, options = {}) {
    setError("");
    setLastResponse(null);

    const method = options.method || "GET";
    const bodyObj = options.body || null;

    setLastRequest({
      moduleName,
      actionName,
      method,
      url: API_BASE_URL + path,
      body: bodyObj,
    });

    try {
      setLoading(true);

      const headers = {
        "Content-Type": "application/json",
        ...(options.headers || {}),
      };

      if (token) {
        headers.Authorization = `Bearer ${token}`;
      }

      const res = await fetch(API_BASE_URL + path, {
        method,
        headers,
        body:
          bodyObj && ["POST", "PUT", "PATCH"].includes(method)
            ? JSON.stringify(bodyObj)
            : undefined,
      });

      let rawText = "";
      let data = null;
      try {
        rawText = await res.text();
        data = rawText ? JSON.parse(rawText) : null;
      } catch {
        data = rawText;
      }

      setLastResponse({
        status: res.status,
        ok: res.ok,
        data,
      });

      if (!res.ok) {
        setError(`Respuesta con error HTTP ${res.status}`);
      }
    } catch (err) {
      setError(err.message || "Error en la llamada");
    } finally {
      setLoading(false);
    }
  }

  // ====== AUTH: registro ======
  async function handleRegister(e) {
    e.preventDefault();
    await callApi("Auth", "POST /auth/register", "/auth/register", {
      method: "POST",
      body: {
        nombre: regNombre,
        apellido: regApellido,
        correo: regCorreo,
        password: regPassword,
        telefono: regTelefono,
      },
    });
  }

  // ====== AUTH: login ======
  async function handleLogin(e) {
    e.preventDefault();
    setError("");
    try {
      setLoading(true);

      const res = await fetch(API_BASE_URL + "/auth/login", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          correo: loginCorreo,
          password: loginPassword,
        }),
      });

      let raw = "";
      let data = null;
      try {
        raw = await res.text();
        data = raw ? JSON.parse(raw) : null;
      } catch {
        data = raw;
      }

      setLastRequest({
        moduleName: "Auth",
        actionName: "POST /auth/login",
        method: "POST",
        url: API_BASE_URL + "/auth/login",
        body: { correo: loginCorreo, password: "***" },
      });
      setLastResponse({
        status: res.status,
        ok: res.ok,
        data,
      });

      if (!res.ok) {
        setError(`Login falló con HTTP ${res.status}`);
        return;
      }

      if (data && data.token) {
        setToken(data.token);
      } else {
        setError("La respuesta de login no contiene token");
      }
    } catch (err) {
      setError(err.message || "Error en login");
    } finally {
      setLoading(false);
    }
  }

  // ====== REQUEST MANUAL ======
  async function handleManualCall(e) {
    e.preventDefault();
    let bodyParsed = null;
    if (manualMethod !== "GET" && manualBody.trim()) {
      try {
        bodyParsed = JSON.parse(manualBody);
      } catch {
        setError("El body manual no es JSON válido");
        return;
      }
    }
    await callApi(
      "Manual",
      `${manualMethod} ${manualPath}`,
      manualPath,
      {
        method: manualMethod,
        body: bodyParsed,
      }
    );
  }

  return (
    <div className="space-y-4">
      {/* HEADER */}
      <header className="flex flex-col sm:flex-row justify-between gap-3 items-start sm:items-center">
        <div>
          <h2 className="text-xl font-semibold text-gray-900">
            Laboratorio completo de Backend
          </h2>
          <p className="text-sm text-gray-500">
            Registro, login e interacción con todos los módulos del backend para
            comprobar si las rutas responden correctamente.
          </p>
          <p className="text-xs text-gray-400 mt-1">
            API_BASE_URL: <code>{API_BASE_URL}</code>
          </p>
        </div>
        <div className="text-right text-xs">
          <p className="font-semibold">Token actual:</p>
          <p className="truncate max-w-xs text-gray-500">
            {token ? token : "(sin token)"}
          </p>
          <button
            className="mt-1 text-xs text-red-600 underline"
            onClick={() => {
              setToken("");
              localStorage.removeItem("token");
            }}
          >
            Limpiar token
          </button>
          {loading && (
            <p className="mt-1 text-emerald-600 font-medium">
              Ejecutando request...
            </p>
          )}
        </div>
      </header>

      {error && (
        <div className="bg-red-50 border-red-200 border text-red-700 text-sm px-3 py-2 rounded">
          {error}
        </div>
      )}

      {/* =========================================================
          1. AUTH: REGISTRO / LOGIN / ME
         ========================================================= */}
      <section className="card space-y-3">
        <p className="text-xs font-semibold uppercase text-gray-500">
          1. Autenticación (Registro / Login / Perfil)
        </p>

        <div className="grid gap-3 md:grid-cols-2 text-xs">
          {/* REGISTRO */}
          <form onSubmit={handleRegister} className="space-y-2">
            <p className="font-semibold">Registro rápido</p>
            <div>
              <label className="block mb-1 font-medium">Nombre</label>
              <input
                type="text"
                value={regNombre}
                onChange={(e) => setRegNombre(e.target.value)}
                className="w-full border rounded px-2 py-1"
              />
            </div>
            <div>
              <label className="block mb-1 font-medium">Apellido</label>
              <input
                type="text"
                value={regApellido}
                onChange={(e) => setRegApellido(e.target.value)}
                className="w-full border rounded px-2 py-1"
              />
            </div>
            <div>
              <label className="block mb-1 font-medium">Correo</label>
              <input
                type="email"
                value={regCorreo}
                onChange={(e) => setRegCorreo(e.target.value)}
                className="w-full border rounded px-2 py-1"
              />
            </div>
            <div>
              <label className="block mb-1 font-medium">Teléfono</label>
              <input
                type="text"
                value={regTelefono}
                onChange={(e) => setRegTelefono(e.target.value)}
                className="w-full border rounded px-2 py-1"
              />
            </div>
            <div>
              <label className="block mb-1 font-medium">Contraseña</label>
              <input
                type="password"
                value={regPassword}
                onChange={(e) => setRegPassword(e.target.value)}
                className="w-full border rounded px-2 py-1"
              />
            </div>
            <button type="submit" className="btn-secondary">
              Registrar usuario
            </button>
          </form>

          {/* LOGIN */}
          <form onSubmit={handleLogin} className="space-y-2">
            <p className="font-semibold">Login</p>
            <div>
              <label className="block mb-1 font-medium">Correo</label>
              <input
                type="email"
                value={loginCorreo}
                onChange={(e) => setLoginCorreo(e.target.value)}
                className="w-full border rounded px-2 py-1"
              />
            </div>
            <div>
              <label className="block mb-1 font-medium">Contraseña</label>
              <input
                type="password"
                value={loginPassword}
                onChange={(e) => setLoginPassword(e.target.value)}
                className="w-full border rounded px-2 py-1"
              />
            </div>
            <button type="submit" className="btn-primary">
              Iniciar sesión
            </button>

            <div className="mt-2">
              <button
                type="button"
                className="btn-secondary"
                onClick={() =>
                  callApi("Auth", "GET /auth/me", "/auth/me")
                }
              >
                Probar /auth/me
              </button>
            </div>
          </form>
        </div>

        {/* Usuarios / historial */}
        <div className="border-t pt-2 mt-2 text-xs">
          <p className="font-semibold mb-1">Usuarios / historial</p>
          <div className="flex flex-wrap gap-2 items-end">
            <button
              className="btn-secondary"
              onClick={() =>
                callApi("Usuarios", "GET /usuarios", "/usuarios")
              }
            >
              Listar /usuarios (ADMIN)
            </button>
            <div className="flex gap-2 items-end">
              <div>
                <label className="block mb-1 font-medium">
                  ID usuario para historial:
                </label>
                <input
                  type="number"
                  value={userIdHistorial}
                  onChange={(e) => setUserIdHistorial(e.target.value)}
                  className="border rounded px-2 py-1"
                  placeholder="Ej: 1"
                />
              </div>
              <button
                className="btn-secondary"
                onClick={() =>
                  userIdHistorial &&
                  callApi(
                    "Usuarios",
                    `GET /usuarios/${userIdHistorial}/historial`,
                    `/usuarios/${userIdHistorial}/historial`
                  )
                }
              >
                Ver historial
              </button>
            </div>
          </div>
        </div>
      </section>

      {/* =========================================================
          2. CATÁLOGOS
         ========================================================= */}
      <section className="card space-y-2">
        <p className="text-xs font-semibold uppercase text-gray-500">
          2. Catálogos
        </p>
        <div className="flex flex-wrap gap-2 text-xs">
          <button
            className="btn-secondary"
            onClick={() =>
              callApi("Catálogos", "GET /catalogos/categorias", "/catalogos/categorias")
            }
          >
            Categorías
          </button>
          <button
            className="btn-secondary"
            onClick={() =>
              callApi(
                "Catálogos",
                "GET /catalogos/paquetes-creditos",
                "/catalogos/paquetes-creditos"
              )
            }
          >
            Paquetes créditos
          </button>
          <button
            className="btn-secondary"
            onClick={() =>
              callApi(
                "Catálogos",
                "GET /catalogos/tipos-actividad",
                "/catalogos/tipos-actividad"
              )
            }
          >
            Tipos actividad
          </button>
          <button
            className="btn-secondary"
            onClick={() =>
              callApi("Catálogos", "GET /catalogos/periodos", "/catalogos/periodos")
            }
          >
            Periodos
          </button>
          <button
            className="btn-secondary"
            onClick={() =>
              callApi(
                "Catálogos",
                "GET /catalogos/tipos-reporte",
                "/catalogos/tipos-reporte"
              )
            }
          >
            Tipos reporte
          </button>
        </div>
      </section>

      {/* =========================================================
          3. WALLET
         ========================================================= */}
      <section className="card space-y-2">
        <p className="text-xs font-semibold uppercase text-gray-500">
          3. Wallet / Billetera
        </p>
        <div className="flex flex-wrap gap-2 text-xs">
          <button
            className="btn-secondary"
            onClick={() =>
              callApi("Wallet", "GET /wallet/mis-creditos", "/wallet/mis-creditos")
            }
          >
            Mis créditos
          </button>
          <button
            className="btn-secondary"
            onClick={() =>
              callApi(
                "Wallet",
                "GET /wallet/mis-movimientos",
                "/wallet/mis-movimientos"
              )
            }
          >
            Mis movimientos
          </button>
          <button
            className="btn-secondary"
            onClick={() =>
              callApi("Wallet", "GET /wallet/compras", "/wallet/compras")
            }
          >
            Mis compras
          </button>
        </div>

        <div className="grid gap-2 md:grid-cols-4 text-xs mt-3">
          <div>
            <label className="block mb-1 font-medium">ID Paquete</label>
            <input
              type="number"
              value={idPaquete}
              onChange={(e) => setIdPaquete(e.target.value)}
              className="w-full border rounded px-2 py-1"
            />
          </div>
          <div>
            <label className="block mb-1 font-medium">Monto pagado (Bs.)</label>
            <input
              type="number"
              value={montoPagado}
              onChange={(e) => setMontoPagado(e.target.value)}
              className="w-full border rounded px-2 py-1"
            />
          </div>
          <div>
            <label className="block mb-1 font-medium">Referencia pago</label>
            <input
              type="text"
              value={refPago}
              onChange={(e) => setRefPago(e.target.value)}
              className="w-full border rounded px-2 py-1"
            />
          </div>
                    <button
            className="btn-primary w-full"
            onClick={() =>
                callApi(
                "Wallet",
                "POST /wallet/compra-creditos",
                "/wallet/compra-creditos",
                {
                    method: "POST",
                    body: {
                    idPaquete: Number(idPaquete),
                    montoPagado: Number(montoPagado),
                    referenciaPago: refPago,
                    },
                }
                )
            }
            >
            Comprar créditos
            </button>

        </div>
      </section>

      {/* =========================================================
          4. PUBLICACIONES
         ========================================================= */}
      <section className="card space-y-2">
        <p className="text-xs font-semibold uppercase text-gray-500">
          4. Publicaciones
        </p>
        <div className="flex flex-wrap gap-2 text-xs">
          <button
            className="btn-secondary"
            onClick={() =>
              callApi("Publicaciones", "GET /publicaciones", "/publicaciones")
            }
          >
            Listar /publicaciones
          </button>
          <button
            className="btn-secondary"
            onClick={() =>
              callApi(
                "Publicaciones",
                "GET /publicaciones/mias",
                "/publicaciones/mias"
              )
            }
          >
            Mis publicaciones
          </button>
          <button
            className="btn-secondary"
            onClick={() =>
              callApi(
                "Publicaciones",
                "GET /publicaciones/busqueda?q=bici",
                "/publicaciones/busqueda?q=bici"
              )
            }
          >
            Buscar (q=bici)
          </button>
        </div>
        <p className="text-xs text-gray-500 mt-1">
          ⚠️ Para crear publicaciones de prueba con todos los campos (producto /
          servicio) es más cómodo usar tu Postman o el módulo de publicaciones del
          frontend final. Aquí nos enfocamos en comprobar que los listados devuelven
          datos y no rompen.
        </p>
      </section>

      {/* =========================================================
          5. INTERCAMBIOS
         ========================================================= */}
      <section className="card space-y-2">
        <p className="text-xs font-semibold uppercase text-gray-500">
          5. Intercambios
        </p>
        <div className="flex flex-wrap gap-2 text-xs">
          <button
            className="btn-secondary"
            onClick={() =>
              callApi(
                "Intercambios",
                "GET /intercambios/mis-compras",
                "/intercambios/mis-compras"
              )
            }
          >
            Mis compras
          </button>
          <button
            className="btn-secondary"
            onClick={() =>
              callApi(
                "Intercambios",
                "GET /intercambios/mis-ventas",
                "/intercambios/mis-ventas"
              )
            }
          >
            Mis ventas
          </button>
        </div>

        <div className="grid gap-2 md:grid-cols-3 text-xs mt-3">
          <div>
            <label className="block mb-1 font-medium">ID Publicación</label>
            <input
              type="number"
              value={idPublicacionInter}
              onChange={(e) => setIdPublicacionInter(e.target.value)}
              className="w-full border rounded px-2 py-1"
            />
          </div>
          <div>
            <label className="block mb-1 font-medium">
              Créditos a intercambiar
            </label>
            <input
              type="number"
              value={creditosInter}
              onChange={(e) => setCreditosInter(e.target.value)}
              className="w-full border rounded px-2 py-1"
            />
          </div>
          <div className="flex items-end">
            <button
              className="btn-primary w-full"
              onClick={() =>
                idPublicacionInter &&
                creditosInter &&
                callApi(
                  "Intercambios",
                  "POST /intercambios",
                  "/intercambios",
                  {
                    method: "POST",
                    body: {
                      id_publicacion: Number(idPublicacionInter),
                      creditos: Number(creditosInter),
                    },
                  }
                )
              }
            >
              Crear intercambio
            </button>
          </div>
        </div>
      </section>

      {/* =========================================================
          6. ACTIVIDADES SOSTENIBLES
         ========================================================= */}
      <section className="card space-y-2">
        <p className="text-xs font-semibold uppercase text-gray-500">
          6. Actividades sostenibles
        </p>
        <div className="flex flex-wrap gap-2 text-xs">
          <button
            className="btn-secondary"
            onClick={() =>
              callApi(
                "Actividades",
                "GET /actividades-sostenibles/mias",
                "/actividades-sostenibles/mias"
              )
            }
          >
            Mis actividades
          </button>
        </div>

        <div className="grid gap-2 md:grid-cols-4 text-xs mt-3">
          <div>
            <label className="block mb-1 font-medium">ID tipo actividad</label>
            <input
              type="number"
              value={idTipoAct}
              onChange={(e) => setIdTipoAct(e.target.value)}
              className="w-full border rounded px-2 py-1"
            />
          </div>
          <div>
            <label className="block mb-1 font-medium">Créditos otorgados</label>
            <input
              type="number"
              value={credAct}
              onChange={(e) => setCredAct(e.target.value)}
              className="w-full border rounded px-2 py-1"
            />
          </div>
          <div className="md:col-span-2">
            <label className="block mb-1 font-medium">Descripción</label>
            <input
              type="text"
              value={descAct}
              onChange={(e) => setDescAct(e.target.value)}
              className="w-full border rounded px-2 py-1"
            />
          </div>
          <div className="md:col-span-4 flex justify-end">
            <button
              className="btn-primary"
              onClick={() =>
                callApi(
                  "Actividades",
                  "POST /actividades-sostenibles",
                  "/actividades-sostenibles",
                  {
                    method: "POST",
                    body: {
                      id_tipo_actividad: Number(idTipoAct),
                      descripcion: descAct,
                      creditos_otorgados: Number(credAct),
                      evidencia_url: null,
                    },
                  }
                )
              }
            >
              Registrar actividad
            </button>
          </div>
        </div>
      </section>

      {/* =========================================================
          7. PUBLICIDAD / PROMOS / LOGROS / PREMIUM
         ========================================================= */}
      <section className="card space-y-2">
        <p className="text-xs font-semibold uppercase text-gray-500">
          7. Publicidad / Promos / Logros / Premium
        </p>
        <div className="flex flex-wrap gap-2 text-xs">
          <button
            className="btn-secondary"
            onClick={() =>
              callApi("Publicidad", "GET /publicidad", "/publicidad")
            }
          >
            Publicidad activa
          </button>
          <button
            className="btn-secondary"
            onClick={() =>
              callApi(
                "Promociones",
                "GET /promociones/vigentes",
                "/promociones/vigentes"
              )
            }
          >
            Promos vigentes
          </button>
          <button
            className="btn-secondary"
            onClick={() =>
              callApi("Logros", "GET /logros/mis-logros", "/logros/mis-logros")
            }
          >
            Mis logros
          </button>
          <button
            className="btn-secondary"
            onClick={() =>
              callApi("Premium", "GET /premium/mi-plan", "/premium/mi-plan")
            }
          >
            Mi plan premium
          </button>
        </div>
      </section>

      {/* =========================================================
          8. REPORTES
         ========================================================= */}
      <section className="card space-y-2">
        <p className="text-xs font-semibold uppercase text-gray-500">
          8. Reportes (ADMIN)
        </p>

        <div className="grid gap-2 md:grid-cols-3 text-xs">
          <div>
            <label className="block mb-1 font-medium">Desde</label>
            <input
              type="date"
              value={desdeRep}
              onChange={(e) => setDesdeRep(e.target.value)}
              className="w-full border rounded px-2 py-1"
            />
          </div>
          <div>
            <label className="block mb-1 font-medium">Hasta</label>
            <input
              type="date"
              value={hastaRep}
              onChange={(e) => setHastaRep(e.target.value)}
              className="w-full border rounded px-2 py-1"
            />
          </div>
        </div>

        <div className="flex flex-wrap gap-2 text-xs mt-3">
          <button
            className="btn-secondary"
            onClick={() =>
              callApi(
                "Reportes",
                "GET /reportes/usuarios-activos",
                `/reportes/usuarios-activos?desde=${desdeRep}&hasta=${hastaRep}`
              )
            }
          >
            Usuarios activos
          </button>
          <button
            className="btn-secondary"
            onClick={() =>
              callApi(
                "Reportes",
                "GET /reportes/usuarios-abandonados",
                `/reportes/usuarios-abandonados?desde=${desdeRep}&hasta=${hastaRep}`
              )
            }
          >
            Usuarios abandonados
          </button>
          <button
            className="btn-secondary"
            onClick={() =>
              callApi(
                "Reportes",
                "GET /reportes/ingresos-creditos",
                `/reportes/ingresos-creditos?desde=${desdeRep}&hasta=${hastaRep}`
              )
            }
          >
            Ingresos créditos
          </button>
          <button
            className="btn-secondary"
            onClick={() =>
              callApi(
                "Reportes",
                "GET /reportes/creditos-generados-consumidos",
                `/reportes/creditos-generados-consumidos?desde=${desdeRep}&hasta=${hastaRep}`
              )
            }
          >
            Créditos gen. vs cons.
          </button>
          <button
            className="btn-secondary"
            onClick={() =>
              callApi(
                "Reportes",
                "GET /reportes/intercambios-categoria",
                `/reportes/intercambios-categoria?desde=${desdeRep}&hasta=${hastaRep}`
              )
            }
          >
            Intercambios x categoría
          </button>
          <button
            className="btn-secondary"
            onClick={() =>
              callApi(
                "Reportes",
                "GET /reportes/publicaciones-intercambios",
                `/reportes/publicaciones-intercambios?desde=${desdeRep}&hasta=${hastaRep}`
              )
            }
          >
            Publ. vs intercambios
          </button>
          <button
            className="btn-secondary"
            onClick={() =>
                callApi(
                "Reportes",
                "GET /reportes/impacto-acumulado",
                `/reportes/impacto-acumulado?id_tipo_reporte=1&id_periodo=1`
                )
            }
            >
            Impacto acumulado
</button>

          <button
  className="btn-secondary"
  onClick={() =>
    callApi(
      "Reportes",
      "GET /reportes/ranking-usuarios",
      `/reportes/ranking-usuarios?id_periodo=1&limit=10`
    )
  }
>
  Ranking usuarios
</button>

        </div>
      </section>

      {/* =========================================================
          9. REQUEST MANUAL
         ========================================================= */}
      <section className="card space-y-2">
        <p className="text-xs font-semibold uppercase text-gray-500">
          9. Request manual (cualquier endpoint)
        </p>
        <form onSubmit={handleManualCall} className="space-y-2 text-xs">
          <div className="flex gap-2">
            <select
              value={manualMethod}
              onChange={(e) => setManualMethod(e.target.value)}
              className="border rounded px-2 py-1"
            >
              <option>GET</option>
              <option>POST</option>
              <option>PUT</option>
              <option>PATCH</option>
              <option>DELETE</option>
            </select>
            <input
              type="text"
              value={manualPath}
              onChange={(e) => setManualPath(e.target.value)}
              className="flex-1 border rounded px-2 py-1"
              placeholder="/ruta/del/endpoint"
            />
            <button type="submit" className="btn-primary">
              Ejecutar
            </button>
          </div>
          {manualMethod !== "GET" && (
            <textarea
              rows={4}
              value={manualBody}
              onChange={(e) => setManualBody(e.target.value)}
              className="w-full border rounded px-2 py-1 font-mono"
            />
          )}
        </form>
      </section>

      {/* =========================================================
          PANEL DE RESULTADOS
         ========================================================= */}
      <section className="card space-y-2">
        <p className="text-xs font-semibold uppercase text-gray-500">
          Resultado de la última llamada
        </p>

        {lastRequest ? (
          <div className="text-xs space-y-1">
            <p>
              <span className="font-semibold">Módulo:</span>{" "}
              {lastRequest.moduleName}
            </p>
            <p>
              <span className="font-semibold">Acción:</span>{" "}
              {lastRequest.actionName}
            </p>
            <p>
              <span className="font-semibold">Método:</span>{" "}
              {lastRequest.method}
            </p>
            <p>
              <span className="font-semibold">URL:</span>{" "}
              <code>{lastRequest.url}</code>
            </p>
            {lastRequest.body && (
              <details className="mt-1">
                <summary className="cursor-pointer text-gray-600">
                  Body enviado
                </summary>
                <pre className="bg-gray-50 border rounded p-2 mt-1 overflow-x-auto">
{JSON.stringify(lastRequest.body, null, 2)}
                </pre>
              </details>
            )}
          </div>
        ) : (
          <p className="text-xs text-gray-400">
            Aún no ejecutaste ninguna llamada.
          </p>
        )}

        {lastResponse && (
          <div className="mt-3 text-xs">
            <p>
              <span className="font-semibold">Status:</span>{" "}
              {lastResponse.status}{" "}
              {lastResponse.ok ? "(OK)" : "(Error)"}
            </p>
            <details className="mt-1" open>
              <summary className="cursor-pointer text-gray-600">
                Ver JSON de respuesta
              </summary>
              <pre className="bg-gray-50 border rounded p-2 mt-1 overflow-x-auto">
{JSON.stringify(lastResponse.data, null, 2)}
              </pre>
            </details>
          </div>
        )}
      </section>
    </div>
  );
}
</file>

<file path="frontend/src/pages/Home.jsx">
// frontend/src/pages/Home.jsx
import React, { useEffect, useState } from "react";
import { Link } from "react-router-dom";
import { getHealth } from "../services/api.js";

export default function Home() {
  const [health, setHealth] = useState(null);
  const [error, setError] = useState("");

  useEffect(() => {
    let isMounted = true;

    getHealth()
      .then((data) => {
        if (isMounted) setHealth(data);
      })
      .catch((err) => {
        if (isMounted) setError(err.message || "Error consultando API");
      });

    return () => {
      isMounted = false;
    };
  }, []);

  return (
    <div className="space-y-4">
      {/* HEADER */}
      <section className="flex flex-col sm:flex-row justify-between gap-3 items-start sm:items-center">
        <div>
          <h2 className="text-xl font-semibold text-gray-900">
            Bienvenido al panel
          </h2>
          <p className="text-sm text-gray-500">
            Aquí irán las tarjetas de saldo, publicaciones, estadísticas, etc.
          </p>
        </div>
      </section>

      {/* TARJETAS DEL HOME */}
      <section className="grid gap-4 md:grid-cols-3">
        {/* TARJETA: ESTADO API */}
        <div className="card">
          <p className="text-xs font-medium text-gray-500 uppercase tracking-wide mb-1">
            Estado de la API
          </p>
          {error && (
            <p className="text-sm text-red-600">
              Error: <span className="font-medium">{error}</span>
            </p>
          )}
          {!error && !health && (
            <p className="text-sm text-gray-500">Verificando API…</p>
          )}
          {health && (
            <div className="space-y-1 text-sm">
              <p>
                <span className="font-medium">ok:</span>{" "}
                {String(health.ok ?? health.status ?? "desconocido")}
              </p>
              {health.env && (
                <p>
                  <span className="font-medium">Entorno:</span> {health.env}
                </p>
              )}
            </div>
          )}
        </div>

        {/* TARJETA: CRÉDITOS */}
        <div className="card">
          <p className="text-xs font-medium text-gray-500 uppercase tracking-wide mb-1">
            Créditos
          </p>
          <p className="text-sm text-gray-500">
            Aquí puedes mostrar el saldo de créditos de la billetera del
            usuario.
          </p>
        </div>

        {/* TARJETA: ACTIVIDAD RECIENTE */}
        <div className="card">
          <p className="text-xs font-medium text-gray-500 uppercase tracking-wide mb-1">
            Actividad reciente
          </p>
          <p className="text-sm text-gray-500">
            Listado de últimas publicaciones, intercambios, etc.
          </p>
        </div>
        
          <Link
            to="/backend-lab"
            className="card hover:shadow-md transition"
          >
            <p className="text-xs font-medium text-gray-500 uppercase mb-1">
              Laboratorio Backend
            </p>
            <p className="text-sm font-semibold">
              Probar todos los módulos (QA)
            </p>
            <p className="text-xs text-gray-500 mt-1">
              Registro, login, wallet, publicaciones, intercambios, actividades,
              reportes y más desde una sola pantalla.
            </p>
          </Link>

        {/* ⭐ NUEVA TARJETA: REPORTES ⭐ */}
        <div className="card flex flex-col justify-between">
          <div>
            <p className="text-xs font-medium text-gray-500 uppercase tracking-wide mb-1">
              Reportes
            </p>
            <p className="text-sm text-gray-500">
              Accede a reportes de actividad, créditos e impacto ambiental.
            </p>
          </div>

          <div className="mt-3">
            <Link
              to="/reportes"
              className="text-blue-600 hover:text-blue-800 text-sm font-medium"
            >
              Ver reportes →
            </Link>
          </div>
        </div>
      </section>
    </div>
  );
}
</file>

<file path="frontend/src/pages/Login.jsx">
// frontend/src/pages/Login.jsx
import React, { useState, useEffect } from "react";
import { useNavigate, Link } from "react-router-dom";
import { login } from "../services/api";
import hojaLogo from "../assets/hoja.png";

const SLIDES = [
  {
    id: 1,
    title: "Crea una cuenta en Digital Barter",
    text: "Obtén 5 monedas Green Credits por tu primera sesión.",
    image:
      "https://images.pexels.com/photos/3184339/pexels-photo-3184339.jpeg?auto=compress&cs=tinysrgb&w=1600",
  },
  {
    id: 2,
    title: "Intercambia productos y servicios",
    text: "Ahorra dinero mientras ayudas al planeta.",
    image:
      "https://images.pexels.com/photos/3184291/pexels-photo-3184291.jpeg?auto=compress&cs=tinysrgb&w=1600",
  },
  {
    id: 3,
    title: "Gana Green Credits",
    text: "Recibe créditos verdes por cada intercambio sostenible.",
    image:
      "https://images.pexels.com/photos/8867432/pexels-photo-8867432.jpeg?auto=compress&cs=tinysrgb&w=1600",
  },
];

export default function Login() {
  const [correo, setCorreo] = useState("");
  const [password, setPassword] = useState("");
  const [error, setError] = useState("");
  const [loading, setLoading] = useState(false);

  const [slideIndex, setSlideIndex] = useState(0);

  const navigate = useNavigate();

  useEffect(() => {
    const id = setInterval(() => {
      setSlideIndex((prev) => (prev + 1) % SLIDES.length);
    }, 5000);
    return () => clearInterval(id);
  }, []);

  async function handleSubmit(e) {
    e.preventDefault();
    setError("");

    if (!correo || !password) {
      setError("Debes ingresar correo y contraseña.");
      return;
    }

    try {
      setLoading(true);
      const data = await login({ correo, password });

      if (!data?.token) {
        setError("No se recibió el token de autenticación.");
        return;
      }

      // Después del login te llevo a tu flujo de reportes
      navigate("/reportes/usuarios-activos");
    } catch (err) {
      console.error(err);
      setError(err.message || "Credenciales inválidas");
    } finally {
      setLoading(false);
    }
  }

  const currentSlide = SLIDES[slideIndex];

  return (
    <div className="min-h-screen bg-gradient-to-br from-[#012b20] via-[#013726] to-[#011711] text-white flex flex-col">
      {/* NAVBAR SUPERIOR */}
      <header className="flex items-center justify-between px-10 py-4">
        <div className="flex items-center gap-3">
          <div className="flex items-center justify-center w-10 h-10 rounded-full bg-white/10">
            <img
              src={hojaLogo}
              alt="Logo Digital Barter"
              className="w-7 h-7 object-contain"
            />
          </div>
          <div>
            <h1 className="text-2xl font-black leading-tight tracking-tight">
              Digital Barter
            </h1>
            <p className="text-sm text-green-300 font-semibold flex items-center gap-1">
              green credits
              <span className="inline-block w-2 h-2 rounded-full bg-green-400" />
            </p>
          </div>
        </div>

        <Link
          to="/register"
          className="px-5 py-2 rounded-full bg-white text-green-900 font-semibold text-sm hover:bg-gray-100 transition"
        >
          Crear Cuenta
        </Link>
      </header>

      {/* CONTENIDO PRINCIPAL */}
      <main className="flex-1 flex flex-col lg:flex-row items-center justify-center gap-10 px-6 lg:px-16 pb-10">
        {/* PANEL IZQUIERDO: CARRUSEL */}
        <section className="w-full max-w-md bg-black/20 rounded-3xl overflow-hidden shadow-2xl">
          <div className="relative h-80">
            <img
              src={currentSlide.image}
              alt={currentSlide.title}
              className="w-full h-full object-cover"
            />
            <div className="absolute inset-0 bg-gradient-to-t from-black/70 via-black/20 to-transparent" />
            <div className="absolute inset-0 flex flex-col justify-end p-6">
              <h2 className="text-xl font-bold mb-2">{currentSlide.title}</h2>
              <p className="text-sm text-gray-200 mb-4">{currentSlide.text}</p>

              {/* Puntos del carrusel */}
              <div className="flex gap-2">
                {SLIDES.map((s, idx) => (
                  <button
                    key={s.id}
                    onClick={() => setSlideIndex(idx)}
                    className={`w-2.5 h-2.5 rounded-full ${
                      idx === slideIndex ? "bg-white" : "bg-white/40"
                    }`}
                    aria-label={`Ir al slide ${idx + 1}`}
                  />
                ))}
              </div>
            </div>
          </div>
        </section>

        {/* PANEL DERECHO: FORM LOGIN */}
        <section className="w-full max-w-md bg-white/5 backdrop-blur-md rounded-3xl p-8 shadow-2xl">
          <h2 className="text-2xl font-bold mb-2 text-center">
            Iniciar sesión
          </h2>
          <p className="text-sm text-gray-200 mb-6 text-center">
            Ingresa para gestionar tus Green Credits.
          </p>

          {error && (
            <div className="mb-4 bg-red-500/20 border border-red-400 text-sm px-3 py-2 rounded-lg">
              {error}
            </div>
          )}

          <form className="space-y-4" onSubmit={handleSubmit}>
            <div>
              <label className="block text-sm mb-1">
                Correo electrónico o número de teléfono
              </label>
              <input
                type="text"
                value={correo}
                onChange={(e) => setCorreo(e.target.value)}
                className="w-full rounded-lg px-3 py-2 bg-white/10 border border-white/20 text-sm placeholder:text-gray-300 focus:outline-none focus:ring-2 focus:ring-green-400"
                placeholder="tucorreo@email.com"
              />
            </div>

            <div>
              <label className="block text-sm mb-1">Contraseña</label>
              <input
                type="password"
                value={password}
                onChange={(e) => setPassword(e.target.value)}
                className="w-full rounded-lg px-3 py-2 bg-white/10 border border-white/20 text-sm placeholder:text-gray-300 focus:outline-none focus:ring-2 focus:ring-green-400"
                placeholder="••••••••"
              />
            </div>

            <div className="flex justify-end text-xs text-gray-300 mb-1">
              <button
                type="button"
                className="hover:underline"
                onClick={() => alert("En el futuro aquí irá el flujo de recuperar contraseña.")}
              >
                ¿Has olvidado tu contraseña?
              </button>
            </div>

            <button
              type="submit"
              disabled={loading}
              className="w-full mt-2 bg-[#0a8f44] hover:bg-[#0cb652] disabled:opacity-60 disabled:cursor-not-allowed text-white font-semibold py-2.5 rounded-full text-sm transition"
            >
              {loading ? "Ingresando..." : "Iniciar sesión"}
            </button>
          </form>

          <p className="mt-6 text-xs text-center text-gray-200">
            ¿No tienes cuenta?{" "}
            <Link to="/register" className="font-semibold underline">
              Crear una cuenta
            </Link>
          </p>
        </section>
      </main>

      <footer className="text-xs text-gray-300 text-center pb-4">
        ¡Un poco más sobre nosotros!
      </footer>
    </div>
  );
}
</file>

<file path="frontend/src/pages/NotFound.jsx">
import React from "react";
import { Link } from "react-router-dom";

export default function NotFound() {
  return (
    <div className="min-h-screen flex flex-col items-center justify-center bg-gray-100">
      <div className="bg-white px-6 py-5 rounded-lg shadow-sm border border-gray-200 text-center max-w-sm">
        <h1 className="text-3xl font-bold text-gray-900 mb-2">404</h1>
        <p className="text-sm text-gray-500 mb-4">
          La página que buscas no existe.
        </p>
        <Link to="/home" className="btn-primary">
          Volver al inicio
        </Link>
      </div>
    </div>
  );
}
</file>

<file path="frontend/src/pages/Register.jsx">
// frontend/src/pages/Register.jsx
import React, { useState, useEffect } from "react";
import { Link, useNavigate } from "react-router-dom";
import { register } from "../services/api";
import hojaLogo from "../assets/hoja.png";

const SLIDES = [
  {
    id: 1,
    title: "Crea una cuenta en Digital Barter",
    text: "Empieza a ganar Green Credits desde hoy.",
    image:
      "https://images.pexels.com/photos/3184328/pexels-photo-3184328.jpeg?auto=compress&cs=tinysrgb&w=1600",
  },
  {
    id: 2,
    title: "Comparte y reutiliza",
    text: "Publica productos y servicios que ya no usas.",
    image:
      "https://images.pexels.com/photos/3738088/pexels-photo-3738088.jpeg?auto=compress&cs=tinysrgb&w=1600",
  },
  {
    id: 3,
    title: "Impacto ambiental positivo",
    text: "Reduce CO₂, agua y energía con cada intercambio.",
    image:
      "https://images.pexels.com/photos/286763/pexels-photo-286763.jpeg?auto=compress&cs=tinysrgb&w=1600",
  },
];

export default function Register() {
  const [nombre, setNombre] = useState("");
  const [apellidos, setApellidos] = useState("");
  const [correo, setCorreo] = useState("");
  const [telefono, setTelefono] = useState("");
  const [password, setPassword] = useState("");
  const [password2, setPassword2] = useState("");

  const [dia, setDia] = useState("1");
  const [mes, setMes] = useState("ene.");
  const [anio, setAnio] = useState("2000");
  const [genero, setGenero] = useState("Hombre");

  const [error, setError] = useState("");
  const [ok, setOk] = useState("");
  const [loading, setLoading] = useState(false);
  const [slideIndex, setSlideIndex] = useState(0);

  const navigate = useNavigate();

  useEffect(() => {
    const id = setInterval(
      () => setSlideIndex((prev) => (prev + 1) % SLIDES.length),
      5000
    );
    return () => clearInterval(id);
  }, []);

  const currentSlide = SLIDES[slideIndex];

  async function handleSubmit(e) {
    e.preventDefault();
    setError("");
    setOk("");

    if (!nombre || !correo || !password || !password2) {
      setError("Nombre, correo y contraseñas son obligatorios.");
      return;
    }

    if (password !== password2) {
      setError("Las contraseñas no coinciden.");
      return;
    }

    try {
      setLoading(true);
      await register({
        nombre,
        apellido: apellidos,
        correo,
        password,
        telefono: telefono || undefined,
      });

      setOk("Cuenta creada correctamente. Ahora puedes iniciar sesión.");
      // Opcional: enviarte de una vez al login
      navigate("/login");
    } catch (err) {
      console.error(err);
      setError(err.message || "No se pudo registrar el usuario.");
    } finally {
      setLoading(false);
    }
  }

  const dias = Array.from({ length: 31 }, (_, i) => String(i + 1));
  const anios = Array.from({ length: 80 }, (_, i) =>
    String(2025 - i)
  );

  return (
    <div className="min-h-screen bg-gradient-to-br from-[#012b20] via-[#013726] to-[#011711] text-white flex flex-col">
      {/* NAVBAR SUPERIOR */}
      <header className="flex items-center justify-between px-10 py-4">
        <div className="flex items-center gap-3">
          <div className="flex items-center justify-center w-10 h-10 rounded-full bg-white/10">
            <img
              src={hojaLogo}
              alt="Logo Digital Barter"
              className="w-7 h-7 object-contain"
            />
          </div>
          <div>
            <h1 className="text-2xl font-black leading-tight tracking-tight">
              Digital Barter
            </h1>
            <p className="text-sm text-green-300 font-semibold flex items-center gap-1">
              green credits
              <span className="inline-block w-2 h-2 rounded-full bg-green-400" />
            </p>
          </div>
        </div>

        <Link
          to="/login"
          className="px-5 py-2 rounded-full bg-white text-green-900 font-semibold text-sm hover:bg-gray-100 transition"
        >
          Iniciar sesión
        </Link>
      </header>

      {/* CONTENIDO PRINCIPAL */}
      <main className="flex-1 flex flex-col lg:flex-row items-center justify-center gap-10 px-6 lg:px-16 pb-10">
        {/* PANEL IZQUIERDO: CARRUSEL */}
        <section className="w-full max-w-md bg-black/20 rounded-3xl overflow-hidden shadow-2xl">
          <div className="relative h-80">
            <img
              src={currentSlide.image}
              alt={currentSlide.title}
              className="w-full h-full object-cover"
            />
            <div className="absolute inset-0 bg-gradient-to-t from-black/70 via-black/20 to-transparent" />
            <div className="absolute inset-0 flex flex-col justify-end p-6">
              <h2 className="text-xl font-bold mb-2">{currentSlide.title}</h2>
              <p className="text-sm text-gray-200 mb-4">{currentSlide.text}</p>
              <div className="flex gap-2">
                {SLIDES.map((s, idx) => (
                  <button
                    key={s.id}
                    onClick={() => setSlideIndex(idx)}
                    className={`w-2.5 h-2.5 rounded-full ${
                      idx === slideIndex ? "bg-white" : "bg-white/40"
                    }`}
                  />
                ))}
              </div>
            </div>
          </div>
        </section>

        {/* PANEL DERECHO: FORM REGISTRO */}
        <section className="w-full max-w-md bg-white/5 backdrop-blur-md rounded-3xl p-8 shadow-2xl">
          <h2 className="text-2xl font-bold mb-2 text-center">Crea una Cuenta</h2>

          {error && (
            <div className="mb-4 bg-red-500/20 border border-red-400 text-sm px-3 py-2 rounded-lg">
              {error}
            </div>
          )}
          {ok && (
            <div className="mb-4 bg-green-500/20 border border-green-400 text-sm px-3 py-2 rounded-lg">
              {ok}
            </div>
          )}

          <form className="space-y-4" onSubmit={handleSubmit}>
            {/* Nombre y apellidos */}
            <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
              <div>
                <label className="block text-sm mb-1">Nombre</label>
                <input
                  type="text"
                  value={nombre}
                  onChange={(e) => setNombre(e.target.value)}
                  className="w-full rounded-lg px-3 py-2 bg-white/10 border border-white/20 text-sm focus:outline-none focus:ring-2 focus:ring-green-400"
                  placeholder="Nombre"
                />
              </div>
              <div>
                <label className="block text-sm mb-1">Apellidos</label>
                <input
                  type="text"
                  value={apellidos}
                  onChange={(e) => setApellidos(e.target.value)}
                  className="w-full rounded-lg px-3 py-2 bg-white/10 border border-white/20 text-sm focus:outline-none focus:ring-2 focus:ring-green-400"
                  placeholder="Apellidos"
                />
              </div>
            </div>

            {/* Fecha de nacimiento */}
            <div>
              <p className="text-xs mb-1">Fecha de nacimiento</p>
              <div className="grid grid-cols-3 gap-2">
                <select
                  value={dia}
                  onChange={(e) => setDia(e.target.value)}
                  className="rounded-lg px-2 py-2 bg-white/10 border border-white/20 text-sm"
                >
                  {dias.map((d) => (
                    <option key={d} value={d}>
                      {d}
                    </option>
                  ))}
                </select>

                <select
                  value={mes}
                  onChange={(e) => setMes(e.target.value)}
                  className="rounded-lg px-2 py-2 bg-white/10 border border-white/20 text-sm"
                >
                  <option>ene.</option>
                  <option>feb.</option>
                  <option>mar.</option>
                  <option>abr.</option>
                  <option>may.</option>
                  <option>jun.</option>
                  <option>jul.</option>
                  <option>ago.</option>
                  <option>sept.</option>
                  <option>oct.</option>
                  <option>nov.</option>
                  <option>dic.</option>
                </select>

                <select
                  value={anio}
                  onChange={(e) => setAnio(e.target.value)}
                  className="rounded-lg px-2 py-2 bg-white/10 border border-white/20 text-sm"
                >
                  {anios.map((a) => (
                    <option key={a} value={a}>
                      {a}
                    </option>
                  ))}
                </select>
              </div>
            </div>

            {/* Género */}
            <div>
              <p className="text-xs mb-1">Género</p>
              <div className="flex gap-3">
                <button
                  type="button"
                  onClick={() => setGenero("Hombre")}
                  className={`flex-1 flex items-center justify-center gap-2 px-3 py-2 rounded-full border text-sm ${
                    genero === "Hombre"
                      ? "bg-green-500 border-green-400"
                      : "bg-white/10 border-white/20"
                  }`}
                >
                  <span
                    className={`w-3 h-3 rounded-full border ${
                      genero === "Hombre"
                        ? "bg-white border-white"
                        : "bg-transparent border-white"
                    }`}
                  />
                  Hombre
                </button>
                <button
                  type="button"
                  onClick={() => setGenero("Mujer")}
                  className={`flex-1 flex items-center justify-center gap-2 px-3 py-2 rounded-full border text-sm ${
                    genero === "Mujer"
                      ? "bg-green-500 border-green-400"
                      : "bg-white/10 border-white/20"
                  }`}
                >
                  <span
                    className={`w-3 h-3 rounded-full border ${
                      genero === "Mujer"
                        ? "bg-white border-white"
                        : "bg-transparent border-white"
                    }`}
                  />
                  Mujer
                </button>
              </div>
            </div>

            {/* Contacto */}
            <div>
              <label className="block text-sm mb-1">
                Número de móvil o correo electrónico
              </label>
              <input
                type="text"
                value={correo}
                onChange={(e) => setCorreo(e.target.value)}
                className="w-full rounded-lg px-3 py-2 bg-white/10 border border-white/20 text-sm focus:outline-none focus:ring-2 focus:ring-green-400"
                placeholder="correo@ejemplo.com"
              />
            </div>

            <div>
              <label className="block text-sm mb-1">Teléfono (opcional)</label>
              <input
                type="tel"
                value={telefono}
                onChange={(e) => setTelefono(e.target.value)}
                className="w-full rounded-lg px-3 py-2 bg-white/10 border border-white/20 text-sm focus:outline-none focus:ring-2 focus:ring-green-400"
                placeholder="+591 70000000"
              />
            </div>

            {/* Contraseñas */}
            <div>
              <label className="block text-sm mb-1">Contraseña</label>
              <input
                type="password"
                value={password}
                onChange={(e) => setPassword(e.target.value)}
                className="w-full rounded-lg px-3 py-2 bg-white/10 border border-white/20 text-sm focus:outline-none focus:ring-2 focus:ring-green-400"
                placeholder="••••••••"
              />
            </div>
            <div>
              <label className="block text-sm mb-1">Confirmar contraseña</label>
              <input
                type="password"
                value={password2}
                onChange={(e) => setPassword2(e.target.value)}
                className="w-full rounded-lg px-3 py-2 bg-white/10 border border-white/20 text-sm focus:outline-none focus:ring-2 focus:ring-green-400"
                placeholder="••••••••"
              />
            </div>

            <button
              type="submit"
              disabled={loading}
              className="w-full mt-2 bg-[#0a8f44] hover:bg-[#0cb652] disabled:opacity-60 disabled:cursor-not-allowed text-white font-semibold py-2.5 rounded-full text-sm transition"
            >
              {loading ? "Registrando..." : "Registrar"}
            </button>
          </form>
        </section>
      </main>

      <footer className="text-xs text-gray-300 text-center pb-4">
        ¡Un poco más sobre nosotros!
      </footer>
    </div>
  );
}
</file>

<file path="frontend/src/pages/Reportes.jsx">
// frontend/src/pages/Reportes.jsx
import { Link } from "react-router-dom";

const reportesList = [
  {
    path: "/reportes/usuarios",
    title: "Usuarios activos y abandonados",
    description: "Quiénes están usando la plataforma y quiénes no.",
  },
  {
    path: "/reportes/ingresos-creditos",
    title: "Ingresos por venta de créditos",
    description: "Créditos vendidos e ingresos en bolivianos.",
  },
  {
    path: "/reportes/creditos-generados-consumidos",
    title: "Créditos generados vs consumidos",
    description: "Balance global de créditos generados y consumidos.",
  },
  {
    path: "/reportes/intercambios-categoria",
    title: "Intercambios por categoría",
    description: "Qué categorías tienen más movimiento en los intercambios.",
  },
  {
    path: "/reportes/publicaciones-intercambios",
    title: "Publicaciones vs intercambios",
    description: "Relación entre lo publicado y lo que realmente se intercambia.",
  },
  {
    path: "/reportes/impacto-acumulado",
    title: "Impacto ambiental acumulado",
    description: "CO₂, agua y energía ahorrados en un período.",
  },
  {
    path: "/reportes/ranking-usuarios",
    title: "Ranking de usuarios por impacto",
    description: "Top de usuarios según su impacto ambiental.",
  },
  {
    path: "/reportes/usuarios-premium",
    title: "Usuarios Premium",
    description: "Adopción, actividad e ingresos por suscripciones premium.",
  },
  {
    path: "/reportes/saldos-usuarios",
    title: "Saldos de créditos por usuario",
    description: "Créditos disponibles actualmente en las billeteras.",
  },
  {
    path: "/reportes/actividades-sostenibles",
    title: "Actividades sostenibles",
    description: "Acciones ecológicas registradas por los usuarios.",
  },
  {
    path: "/reportes/impacto-categoria",
    title: "Impacto ambiental por categoría",
    description: "Impacto ecológico agrupado por categoría de publicación.",
  },
];

export default function Reportes() {
  return (
    <div className="p-4 space-y-6">
      {/* Header */}
      <header className="flex flex-col gap-3 md:flex-row md:items-center md:justify-between">
        <div>
          <h1 className="text-2xl font-bold">Reportes</h1>
          <p className="text-sm text-gray-500">
            Explora los reportes disponibles o abre el dashboard completo.
          </p>
        </div>

        <Link
          to="/reportes-dashboard"
          className="inline-flex items-center justify-center bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded text-sm font-medium transition"
        >
          Ver dashboard completo
        </Link>
      </header>

      {/* Tarjetas de reportes */}
      <section className="grid gap-4 md:grid-cols-2 xl:grid-cols-3">
        {reportesList.map((rep, idx) => (
          <div
            key={idx}
            className="border rounded-lg p-4 bg-white shadow-sm flex flex-col justify-between hover:shadow-md transition"
          >
            <div>
              <h2 className="font-semibold text-lg mb-1">{rep.title}</h2>
              <p className="text-sm text-gray-500 mb-3">{rep.description}</p>
            </div>

            <div className="flex justify-end">
              <Link
                to={rep.path}
                className="text-blue-600 hover:text-blue-800 text-sm font-medium"
              >
                Ver detalle →
              </Link>
            </div>
          </div>
        ))}
      </section>
    </div>
  );
}
</file>

<file path="frontend/src/pages/ReportesActividadesSostenibles.jsx">
import React, { useEffect, useState } from "react";
import { getReporteActividadesSostenibles } from "../services/api";

function hoyISO() {
  return new Date().toISOString().slice(0, 10);
}

function hace30DiasISO() {
  const d = new Date(Date.now() - 30 * 24 * 60 * 60 * 1000);
  return d.toISOString().slice(0, 10);
}

export default function ReportesActividadesSostenibles() {
  const [desde, setDesde] = useState(hace30DiasISO());
  const [hasta, setHasta] = useState(hoyISO());
  const [datos, setDatos] = useState([]);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState("");

  async function cargar() {
    try {
      setLoading(true);
      setError("");
      const res = await getReporteActividadesSostenibles({ desde, hasta });
      setDatos(Array.isArray(res) ? res : []);
    } catch (e) {
      console.error(e);
      setError("Error cargando actividades sostenibles");
      setDatos([]);
    } finally {
      setLoading(false);
    }
  }

  useEffect(() => {
    cargar();
  }, []);

  function handleSubmit(e) {
    e.preventDefault();
    cargar();
  }

  return (
    <div className="p-4 space-y-6">
      <header className="flex flex-col md:flex-row md:items-end md:justify-between gap-3">
        <div>
          <h1 className="text-2xl font-bold">
            Actividades sostenibles por usuario
          </h1>
          <p className="text-sm text-gray-500">
            Cantidad de actividades y créditos otorgados en el rango.
          </p>
        </div>

        <form
          onSubmit={handleSubmit}
          className="flex flex-wrap gap-2 items-end"
        >
          <div className="flex flex-col text-sm">
            <label className="mb-1 font-medium">Desde</label>
            <input
              type="date"
              value={desde}
              onChange={(e) => setDesde(e.target.value)}
              className="border rounded px-2 py-1 text-sm"
            />
          </div>
          <div className="flex flex-col text-sm">
            <label className="mb-1 font-medium">Hasta</label>
            <input
              type="date"
              value={hasta}
              onChange={(e) => setHasta(e.target.value)}
              className="border rounded px-2 py-1 text-sm"
            />
          </div>
          <button
            type="submit"
            className="bg-emerald-600 text-white px-3 py-1.5 rounded text-sm"
          >
            {loading ? "Cargando…" : "Actualizar"}
          </button>
        </form>
      </header>

      {error && (
        <div className="bg-red-50 border-red-200 border text-red-700 text-sm px-3 py-2 rounded">
          {error}
        </div>
      )}

      <section>
        <div className="overflow-x-auto border rounded bg-white">
          <table className="min-w-full text-sm">
            <thead className="bg-gray-100">
              <tr>
                <th className="px-2 py-1 text-left">Usuario</th>
                <th className="px-2 py-1 text-left">Correo</th>
                <th className="px-2 py-1 text-right">Total actividades</th>
                <th className="px-2 py-1 text-right">Créditos otorgados</th>
              </tr>
            </thead>
            <tbody>
              {datos.map((a, i) => (
                <tr key={i} className="border-t">
                  <td className="px-2 py-1">{a.nombre}</td>
                  <td className="px-2 py-1">{a.correo}</td>
                  <td className="px-2 py-1 text-right">
                    {a.total_actividades}
                  </td>
                  <td className="px-2 py-1 text-right">
                    {a.creditos_otorgados}
                  </td>
                </tr>
              ))}
              {datos.length === 0 && (
                <tr>
                  <td
                    className="px-2 py-2 text-center text-gray-400"
                    colSpan={4}
                  >
                    Sin actividades sostenibles en el rango.
                  </td>
                </tr>
              )}
            </tbody>
          </table>
        </div>
      </section>
    </div>
  );
}
</file>

<file path="frontend/src/pages/ReportesCreditosGeneradosConsumidos.jsx">
import React, { useEffect, useState } from "react";
import { getReporteCreditosGeneradosVsConsumidos } from "../services/api";

function hoyISO() {
  return new Date().toISOString().slice(0, 10);
}

function hace30DiasISO() {
  const d = new Date(Date.now() - 30 * 24 * 60 * 60 * 1000);
  return d.toISOString().slice(0, 10);
}

export default function ReportesCreditosGenerados() {
  const [desde, setDesde] = useState(hace30DiasISO());
  const [hasta, setHasta] = useState(hoyISO());
  const [resumen, setResumen] = useState(null);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState("");

  async function cargar() {
    try {
      setLoading(true);
      setError("");
      const res = await getReporteCreditosGeneradosVsConsumidos({
        desde,
        hasta,
      });
      setResumen(res || null);
    } catch (e) {
      console.error(e);
      setError("Error cargando resumen de créditos");
      setResumen(null);
    } finally {
      setLoading(false);
    }
  }

  useEffect(() => {
    cargar();
  }, []);

  function handleSubmit(e) {
    e.preventDefault();
    cargar();
  }

  return (
    <div className="p-4 space-y-6">
      <header className="flex flex-col md:flex-row md:items-end md:justify-between gap-3">
        <div>
          <h1 className="text-2xl font-bold">
            Créditos generados vs consumidos
          </h1>
          <p className="text-sm text-gray-500">
            Resumen global de créditos emitidos, gastados y saldo neto.
          </p>
        </div>

        <form
          onSubmit={handleSubmit}
          className="flex flex-wrap gap-2 items-end"
        >
          <div className="flex flex-col text-sm">
            <label className="mb-1 font-medium">Desde</label>
            <input
              type="date"
              value={desde}
              onChange={(e) => setDesde(e.target.value)}
              className="border rounded px-2 py-1 text-sm"
            />
          </div>
          <div className="flex flex-col text-sm">
            <label className="mb-1 font-medium">Hasta</label>
            <input
              type="date"
              value={hasta}
              onChange={(e) => setHasta(e.target.value)}
              className="border rounded px-2 py-1 text-sm"
            />
          </div>
          <button
            type="submit"
            className="bg-emerald-600 text-white px-3 py-1.5 rounded text-sm"
          >
            {loading ? "Cargando…" : "Actualizar"}
          </button>
        </form>
      </header>

      {error && (
        <div className="bg-red-50 border-red-200 border text-red-700 text-sm px-3 py-2 rounded">
          {error}
        </div>
      )}

      <section className="border rounded p-4 bg-white text-sm">
        {resumen ? (
          <ul className="space-y-1">
            <li>
              <span className="font-semibold">Créditos generados:</span>{" "}
              {resumen.creditos_generados}
            </li>
            <li>
              <span className="font-semibold">Créditos consumidos:</span>{" "}
              {resumen.creditos_consumidos}
            </li>
            <li>
              <span className="font-semibold">Saldo neto:</span>{" "}
              {resumen.saldo_neto}
            </li>
          </ul>
        ) : (
          <p className="text-gray-500">
            Sin datos de créditos generados/consumidos para el rango.
          </p>
        )}
      </section>
    </div>
  );
}
</file>

<file path="frontend/src/pages/ReportesDashboard.jsx">
import { useEffect, useState, useMemo } from "react";
import {
  getReporteUsuariosActivos,
  getReporteIngresosCreditos,
  getReporteCreditosGeneradosVsConsumidos,
  getReporteIntercambiosCategoria,
  getReportePublicacionesVsIntercambios,
  getReporteImpactoAcumulado,
} from "../services/api";

import {
  ResponsiveContainer,
  BarChart,
  Bar,
  XAxis,
  YAxis,
  CartesianGrid,
  Tooltip,
  Legend,
} from "recharts";

/* Utilidades */
function hoyISO() {
  return new Date().toISOString().slice(0, 10);
}

function hace30DiasISO() {
  const d = new Date(Date.now() - 30 * 24 * 60 * 60 * 1000);
  return d.toISOString().slice(0, 10);
}

const nf = new Intl.NumberFormat("es-BO");

export default function ReportesDashboard() {
  const [desde, setDesde] = useState(hace30DiasISO());
  const [hasta, setHasta] = useState(hoyISO());

  const [usuariosActivos, setUsuariosActivos] = useState([]);
  const [ingresos, setIngresos] = useState([]);
  const [intercambiosCat, setIntercambiosCat] = useState([]);
  const [pubVsInt, setPubVsInt] = useState([]);
  const [credResumen, setCredResumen] = useState(null);
  const [impacto, setImpacto] = useState([]);

  const [tipoReporte, setTipoReporte] = useState("2"); // mensual
  const [idPeriodo, setIdPeriodo] = useState("1");

  const [loading, setLoading] = useState(false);
  const [loadingImpacto, setLoadingImpacto] = useState(false);
  const [error, setError] = useState("");

/*     Carga de datos*/

  async function cargarDatosBasicos() {
    try {
      setLoading(true);
      setError("");

      const [activos, ing, cgvc, interc, pubInt] = await Promise.all([
        getReporteUsuariosActivos({ desde, hasta }),
        getReporteIngresosCreditos({ desde, hasta }),
        getReporteCreditosGeneradosVsConsumidos({ desde, hasta }),
        getReporteIntercambiosCategoria({ desde, hasta }),
        getReportePublicacionesVsIntercambios({ desde, hasta }),
      ]);

      setUsuariosActivos(Array.isArray(activos) ? activos : []);
      setIngresos(Array.isArray(ing) ? ing : []);
      setIntercambiosCat(Array.isArray(interc) ? interc : []);
      setPubVsInt(Array.isArray(pubInt) ? pubInt : []);
      setCredResumen(cgvc || null);
    } catch (e) {
      console.error(e);
      setError("Error cargando datos de reportes");
      setUsuariosActivos([]);
      setIngresos([]);
      setIntercambiosCat([]);
      setPubVsInt([]);
      setCredResumen(null);
    } finally {
      setLoading(false);
    }
  }

  async function cargarImpacto() {
    try {
      setLoadingImpacto(true);
      setError("");

      const datos = await getReporteImpactoAcumulado({
        idTipoReporte: tipoReporte,
        idPeriodo,
      });

      setImpacto(Array.isArray(datos) ? datos : []);
    } catch (e) {
      console.error(e);
      setError("Error cargando impacto ambiental");
      setImpacto([]);
    } finally {
      setLoadingImpacto(false);
    }
  }

  function onSubmitRango(e) {
    e.preventDefault();
    cargarDatosBasicos();
  }

  useEffect(() => {
    cargarDatosBasicos();
  }, []);

  /* Datos preparados para gráficos */

  // Ingresos por día
  const ingresosChartData = useMemo(
    () =>
      ingresos.map((r) => ({
        fecha: r.fecha?.slice(0, 10) || "",
        total_bs: Number(r.total_bs ?? 0),
        total_creditos: Number(r.total_creditos ?? 0),
      })),
    [ingresos]
  );

  // Intercambios por categoría
  const intercambiosChartData = useMemo(
    () =>
      intercambiosCat.map((c) => ({
        categoria: c.categoria,
        total_intercambios: Number(c.total_intercambios ?? 0),
      })),
    [intercambiosCat]
  );

  // Publicaciones vs intercambios
  const pubVsIntChartData = useMemo(
    () =>
      pubVsInt.map((p) => ({
        categoria: p.categoria,
        publicaciones: Number(p.publicaciones ?? 0),
        intercambios: Number(p.intercambios ?? 0),
      })),
    [pubVsInt]
  );

  // Créditos generados/consumidos/saldo
  const credChartData = useMemo(() => {
    if (!credResumen) return [];
    return [
      {
        nombre: "Generados",
        valor: Number(credResumen.creditos_generados ?? 0),
      },
      {
        nombre: "Consumidos",
        valor: Number(credResumen.creditos_consumidos ?? 0),
      },
      {
        nombre: "Saldo neto",
        valor: Number(credResumen.saldo_neto ?? 0),
      },
    ];
  }, [credResumen]);

  // Impacto ambiental por usuario
  const impactoChartData = useMemo(
    () =>
      impacto.map((r) => ({
        usuario: r.id_usuario ?? "GLOBAL",
        co2: Number(r.total_co2_ahorrado ?? 0),
        agua: Number(r.total_agua_ahorrada ?? 0),
        energia: Number(r.total_energia_ahorrada ?? 0),
      })),
    [impacto]
  );

  return (
    <div className="min-h-screen bg-slate-100 px-4 py-6 lg:px-8">
      {/* HEADER */}
      <header className="mb-6 flex flex-col gap-4 border-b border-slate-200 pb-4 md:flex-row md:items-end md:justify-between">
        <div>
          <h1 className="text-2xl font-semibold text-slate-900">
            Dashboard de reportes
          </h1>
          <p className="mt-1 text-sm text-slate-500">
            Actividad del sistema, créditos e impacto ambiental.
          </p>
          <p className="mt-1 text-xs text-slate-400">
            Rango seleccionado:{" "}
            <span className="font-medium text-slate-600">{desde}</span> –{" "}
            <span className="font-medium text-slate-600">{hasta}</span>
          </p>
        </div>

        <form
          onSubmit={onSubmitRango}
          className="flex flex-wrap items-end gap-3 rounded-lg bg-white px-4 py-3 shadow-sm"
        >
          <div className="flex flex-col text-xs">
            <label className="mb-1 font-medium text-slate-600">Desde</label>
            <input
              type="date"
              value={desde}
              onChange={(e) => setDesde(e.target.value)}
              className="rounded-md border border-slate-300 px-2 py-1 text-sm focus:border-emerald-500 focus:outline-none focus:ring-1 focus:ring-emerald-500"
            />
          </div>

          <div className="flex flex-col text-xs">
            <label className="mb-1 font-medium text-slate-600">Hasta</label>
            <input
              type="date"
              value={hasta}
              onChange={(e) => setHasta(e.target.value)}
              className="rounded-md border border-slate-300 px-2 py-1 text-sm focus:border-emerald-500 focus:outline-none focus:ring-1 focus:ring-emerald-500"
            />
          </div>

          <button
            type="submit"
            className="inline-flex items-center rounded-md bg-emerald-600 px-3 py-1.5 text-sm font-medium text-white shadow-sm hover:bg-emerald-700 focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:ring-offset-1"
          >
            {loading ? "Cargando…" : "Actualizar datos"}
          </button>
        </form>
      </header>

      {error && (
        <div className="mb-4 rounded-md border border-red-200 bg-red-50 px-3 py-2 text-sm text-red-700">
          {error}
        </div>
      )}

      {/* 1) RESUMEN RÁPIDO */}
      <section className="mb-6 space-y-2">
        <h2 className="text-sm font-semibold text-slate-800">
          Resumen general
        </h2>
        <div className="grid gap-4 text-sm md:grid-cols-3">
          <div className="rounded-lg border border-slate-200 bg-white p-4 shadow-sm">
            <p className="text-xs font-medium uppercase tracking-wide text-slate-500">
              Usuarios activos
            </p>
            <p className="mt-2 text-3xl font-semibold text-slate-900">
              {nf.format(usuariosActivos.length)}
            </p>
            <p className="mt-2 text-xs text-slate-500">
              Usuarios con actividad en el rango.
            </p>
          </div>

          <div className="rounded-lg border border-slate-200 bg-white p-4 shadow-sm">
            <p className="text-xs font-medium uppercase tracking-wide text-slate-500">
              Días con ingresos
            </p>
            <p className="mt-2 text-3xl font-semibold text-slate-900">
              {nf.format(ingresosChartData.length)}
            </p>
            <p className="mt-2 text-xs text-slate-500">
              Días con ventas de créditos registradas.
            </p>
          </div>

          <div className="rounded-lg border border-slate-200 bg-white p-4 shadow-sm">
            <p className="text-xs font-medium uppercase tracking-wide text-slate-500">
              Categorías con intercambios
            </p>
            <p className="mt-2 text-3xl font-semibold text-slate-900">
              {nf.format(intercambiosChartData.length)}
            </p>
            <p className="mt-2 text-xs text-slate-500">
              Categorías en las que hubo al menos un intercambio.
            </p>
          </div>
        </div>
      </section>

      {/* 2) INGRESOS POR DÍA */}
      <section className="mb-6 space-y-2">
        <div>
          <h2 className="text-sm font-semibold text-slate-800">
            Ingresos por venta de créditos
          </h2>
          <p className="text-xs text-slate-500">
            Monto total diario en bolivianos.
          </p>
        </div>

        <div className="h-80 w-full rounded-lg border border-slate-200 bg-white p-4 shadow-sm">
          {ingresosChartData.length > 0 ? (
            <ResponsiveContainer width="100%" height="100%">
              <BarChart
                data={ingresosChartData}
                margin={{ top: 12, right: 16, left: 0, bottom: 8 }}
              >
                <CartesianGrid strokeDasharray="3 3" stroke="#e5e7eb" />
                <XAxis
                  dataKey="fecha"
                  tick={{ fontSize: 11, fill: "#6b7280" }}
                  tickLine={false}
                />
                <YAxis
                  tick={{ fontSize: 11, fill: "#6b7280" }}
                  tickLine={false}
                />
                <Tooltip />
                <Legend />
                <Bar
                  dataKey="total_bs"
                  name="Monto (Bs)"
                  fill="#22c55e"
                  radius={[6, 6, 0, 0]}
                  barSize={30}
                />
              </BarChart>
            </ResponsiveContainer>
          ) : (
            <div className="flex h-full w-full items-center justify-center text-xs text-slate-400">
              Sin datos de ingresos en el rango.
            </div>
          )}
        </div>
      </section>

      {/* 3) CRÉDITOS GENERADOS / CONSUMIDOS */}
      <section className="mb-6 space-y-2">
        <div>
          <h2 className="text-sm font-semibold text-slate-800">
            Créditos generados vs consumidos
          </h2>
          <p className="text-xs text-slate-500">
            Resumen global de créditos y saldo neto.
          </p>
        </div>

        <div className="h-80 w-full rounded-lg border border-slate-200 bg-white p-4 shadow-sm">
          {credChartData.length > 0 ? (
            <ResponsiveContainer width="100%" height="100%">
              <BarChart
                data={credChartData}
                margin={{ top: 12, right: 16, left: 0, bottom: 8 }}
              >
                <CartesianGrid strokeDasharray="3 3" stroke="#e5e7eb" />
                <XAxis
                  dataKey="nombre"
                  tick={{ fontSize: 11, fill: "#6b7280" }}
                  tickLine={false}
                />
                <YAxis
                  tick={{ fontSize: 11, fill: "#6b7280" }}
                  tickLine={false}
                />
                <Tooltip />
                <Bar
                  dataKey="valor"
                  name="Créditos"
                  fill="#22c55e"
                  radius={[6, 6, 0, 0]}
                  barSize={40}
                />
              </BarChart>
            </ResponsiveContainer>
          ) : (
            <div className="flex h-full w-full items-center justify-center text-xs text-slate-400">
              Sin datos de créditos para el rango.
            </div>
          )}
        </div>
      </section>

      {/* 4) INTERCAMBIOS POR CATEGORÍA */}
      <section className="mb-6 space-y-2">
        <div>
          <h2 className="text-sm font-semibold text-slate-800">
            Intercambios por categoría
          </h2>
          <p className="text-xs text-slate-500">
            Total de intercambios registrados por categoría.
          </p>
        </div>

        <div className="h-80 w-full rounded-lg border border-slate-200 bg-white p-4 shadow-sm">
          {intercambiosChartData.length > 0 ? (
            <ResponsiveContainer width="100%" height="100%">
              <BarChart
                data={intercambiosChartData}
                margin={{ top: 12, right: 16, left: 0, bottom: 40 }}
              >
                <CartesianGrid strokeDasharray="3 3" stroke="#e5e7eb" />
                <XAxis
                  dataKey="categoria"
                  tick={{ fontSize: 10, fill: "#6b7280" }}
                  tickLine={false}
                  interval={0}
                  angle={-20}
                  textAnchor="end"
                  height={50}
                />
                <YAxis
                  tick={{ fontSize: 11, fill: "#6b7280" }}
                  tickLine={false}
                />
                <Tooltip />
                <Bar
                  dataKey="total_intercambios"
                  name="Intercambios"
                  fill="#22c55e"
                  radius={[6, 6, 0, 0]}
                  barSize={30}
                />
              </BarChart>
            </ResponsiveContainer>
          ) : (
            <div className="flex h-full w-full items-center justify-center text-xs text-slate-400">
              No hay intercambios en el rango.
            </div>
          )}
        </div>
      </section>

      {/* 5) PUBLICACIONES VS INTERCAMBIOS */}
      <section className="mb-6 space-y-2">
        <div>
          <h2 className="text-sm font-semibold text-slate-800">
            Publicaciones vs intercambios
          </h2>
          <p className="text-xs text-slate-500">
            Comparación por categoría entre publicaciones e intercambios.
          </p>
        </div>

        <div className="h-80 w-full rounded-lg border border-slate-200 bg-white p-4 shadow-sm">
          {pubVsIntChartData.length > 0 ? (
            <ResponsiveContainer width="100%" height="100%">
              <BarChart
                data={pubVsIntChartData}
                margin={{ top: 12, right: 16, left: 0, bottom: 40 }}
              >
                <CartesianGrid strokeDasharray="3 3" stroke="#e5e7eb" />
                <XAxis
                  dataKey="categoria"
                  tick={{ fontSize: 10, fill: "#6b7280" }}
                  tickLine={false}
                  interval={0}
                  angle={-20}
                  textAnchor="end"
                  height={50}
                />
                <YAxis
                  tick={{ fontSize: 11, fill: "#6b7280" }}
                  tickLine={false}
                />
                <Tooltip />
                <Legend />
                <Bar
                  dataKey="publicaciones"
                  name="Publicaciones"
                  fill="#22c55e"
                  radius={[6, 6, 0, 0]}
                  barSize={26}
                />
                <Bar
                  dataKey="intercambios"
                  name="Intercambios"
                  fill="#16a34a"
                  radius={[6, 6, 0, 0]}
                  barSize={26}
                />
              </BarChart>
            </ResponsiveContainer>
          ) : (
            <div className="flex h-full w-full items-center justify-center text-xs text-slate-400">
              Sin datos de publicaciones/intercambios.
            </div>
          )}
        </div>
      </section>

      {/* 6) IMPACTO AMBIENTAL */}
      <section className="mb-2 space-y-3">
        <div className="flex flex-col gap-3 md:flex-row md:items-end md:justify-between">
          <div>
            <h2 className="text-sm font-semibold text-slate-800">
              Impacto ambiental acumulado
            </h2>
            <p className="text-xs text-slate-500">
              CO₂ ahorrado por usuario según el período seleccionado.
            </p>
          </div>

          <div className="flex flex-wrap items-end gap-3 rounded-lg bg-white px-4 py-3 text-sm shadow-sm">
            <div className="flex flex-col">
              <label className="mb-1 text-xs font-medium text-slate-600">
                Tipo de período
              </label>
              <select
                value={tipoReporte}
                onChange={(e) => setTipoReporte(e.target.value)}
                className="w-32 rounded-md border border-slate-300 px-2 py-1 text-sm focus:border-emerald-500 focus:outline-none focus:ring-1 focus:ring-emerald-500"
              >
                <option value="1">Diario</option>
                <option value="2">Mensual</option>
                <option value="3">Anual</option>
              </select>
            </div>

            <div className="flex flex-col">
              <label className="mb-1 text-xs font-medium text-slate-600">
                ID período
              </label>
              <input
                type="number"
                min="1"
                value={idPeriodo}
                onChange={(e) => setIdPeriodo(e.target.value)}
                className="w-24 rounded-md border border-slate-300 px-2 py-1 text-sm focus:border-emerald-500 focus:outline-none focus:ring-1 focus:ring-emerald-500"
              />
            </div>

            <button
              type="button"
              onClick={cargarImpacto}
              className="inline-flex items-center rounded-md bg-emerald-600 px-3 py-1.5 text-sm font-medium text-white shadow-sm hover:bg-emerald-700 focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:ring-offset-1"
            >
              {loadingImpacto ? "Cargando…" : "Actualizar"}
            </button>
          </div>
        </div>

        <div className="h-80 w-full rounded-lg border border-slate-200 bg-white p-4 shadow-sm">
          {impactoChartData.length > 0 ? (
            <ResponsiveContainer width="100%" height="100%">
              <BarChart
                data={impactoChartData}
                margin={{ top: 12, right: 16, left: 0, bottom: 8 }}
              >
                <CartesianGrid strokeDasharray="3 3" stroke="#e5e7eb" />
                <XAxis
                  dataKey="usuario"
                  tick={{ fontSize: 10, fill: "#6b7280" }}
                  tickLine={false}
                />
                <YAxis
                  tick={{ fontSize: 11, fill: "#6b7280" }}
                  tickLine={false}
                />
                <Tooltip />
                <Legend />
                <Bar
                  dataKey="co2"
                  name="CO₂ (kg)"
                  fill="#22c55e"
                  radius={[6, 6, 0, 0]}
                  barSize={30}
                />
                
                <Bar dataKey="agua" name="Agua (L)" fill="#0ea5e9" radius={[6,6,0,0]} />
                <Bar dataKey="energia" name="Energía (kWh)" fill="#eab308" radius={[6,6,0,0]} />
                
              </BarChart>
            </ResponsiveContainer>
          ) : (
            <div className="flex h-full w-full items-center justify-center text-xs text-slate-400">
              Sin datos de impacto para ese período.
            </div>
          )}
        </div>
      </section>
    </div>
  );
}
</file>

<file path="frontend/src/pages/ReportesImpactoAcumulado.jsx">
import React, { useState } from "react";
import { getReporteImpactoAcumulado } from "../services/api";

export default function ReportesImpactoAcumulado() {
  const [tipoReporte, setTipoReporte] = useState("1"); // 1=Mensual
  const [idPeriodo, setIdPeriodo] = useState("1");
  const [datos, setDatos] = useState([]);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState("");

  async function cargar() {
    try {
      setLoading(true);
      setError("");
      const res = await getReporteImpactoAcumulado({
        idTipoReporte: tipoReporte,
        idPeriodo,
      });
      setDatos(Array.isArray(res) ? res : []);
    } catch (e) {
      console.error(e);
      setError("Error cargando impacto acumulado");
      setDatos([]);
    } finally {
      setLoading(false);
    }
  }

  return (
    <div className="p-4 space-y-6">
      <header className="flex flex-col md:flex-row md:items-end md:justify-between gap-3">
        <div>
          <h1 className="text-2xl font-bold">Impacto ambiental acumulado</h1>
          <p className="text-sm text-gray-500">
            Datos provenientes de la tabla REPORTE_IMPACTO (por período).
          </p>
        </div>

        <div className="flex flex-wrap gap-2 items-end text-sm">
          <div className="flex flex-col">
            <label className="mb-1 font-medium">Tipo de reporte</label>
            <select
              value={tipoReporte}
              onChange={(e) => setTipoReporte(e.target.value)}
              className="border rounded px-2 py-1 text-sm"
            >
              <option value="1">Mensual</option>
              <option value="2">Diario</option>
              <option value="3">Anual</option>
            </select>
          </div>

          <div className="flex flex-col">
            <label className="mb-1 font-medium">ID período</label>
            <input
              type="number"
              min="1"
              value={idPeriodo}
              onChange={(e) => setIdPeriodo(e.target.value)}
              className="border rounded px-2 py-1 text-sm w-24"
            />
          </div>

          <button
            type="button"
            onClick={cargar}
            className="bg-emerald-600 text-white px-3 py-1.5 rounded text-sm"
          >
            {loading ? "Cargando…" : "Actualizar"}
          </button>
        </div>
      </header>

      {error && (
        <div className="bg-red-50 border-red-200 border text-red-700 text-sm px-3 py-2 rounded">
          {error}
        </div>
      )}

      <section>
        <div className="overflow-x-auto border rounded bg-white">
          <table className="min-w-full text-sm">
            <thead className="bg-gray-100">
              <tr>
                <th className="px-2 py-1 text-left">Usuario (ID)</th>
                <th className="px-2 py-1 text-right">CO₂ total (kg)</th>
                <th className="px-2 py-1 text-right">Agua total (L)</th>
                <th className="px-2 py-1 text-right">Energía total (kWh)</th>
                <th className="px-2 py-1 text-right">Transacciones</th>
                <th className="px-2 py-1 text-right">Usuarios activos</th>
              </tr>
            </thead>
            <tbody>
              {datos.map((r, i) => (
                <tr key={i} className="border-t">
                  <td className="px-2 py-1">{r.id_usuario ?? "GLOBAL"}</td>
                  <td className="px-2 py-1 text-right">
                    {r.total_co2_ahorrado}
                  </td>
                  <td className="px-2 py-1 text-right">
                    {r.total_agua_ahorrada}
                  </td>
                  <td className="px-2 py-1 text-right">
                    {r.total_energia_ahorrada}
                  </td>
                  <td className="px-2 py-1 text-right">
                    {r.total_transacciones}
                  </td>
                  <td className="px-2 py-1 text-right">
                    {r.total_usuarios_activos}
                  </td>
                </tr>
              ))}
              {datos.length === 0 && (
                <tr>
                  <td
                    className="px-2 py-2 text-center text-gray-400"
                    colSpan={6}
                  >
                    Sin datos en REPORTE_IMPACTO para ese período.
                  </td>
                </tr>
              )}
            </tbody>
          </table>
        </div>
      </section>
    </div>
  );
}
</file>

<file path="frontend/src/pages/ReportesImpactoCategoria.jsx">
import React, { useState } from "react";
import { getReporteImpactoPorCategoria } from "../services/api";

export default function ReportesImpactoCategoria() {
  const [idPeriodo, setIdPeriodo] = useState("1");
  const [datos, setDatos] = useState([]);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState("");

  async function cargar() {
    try {
      setLoading(true);
      setError("");
      const res = await getReporteImpactoPorCategoria({ idPeriodo });
      setDatos(Array.isArray(res) ? res : []);
    } catch (e) {
      console.error(e);
      setError("Error cargando impacto por categoría");
      setDatos([]);
    } finally {
      setLoading(false);
    }
  }

  return (
    <div className="p-4 space-y-6">
      <header className="flex flex-col md:flex-row md:items-end md:justify-between gap-3">
        <div>
          <h1 className="text-2xl font-bold">
            Impacto ambiental por categoría
          </h1>
          <p className="text-sm text-gray-500">
            Suma de CO₂, agua y energía ahorrada por cada categoría (tabla
            IMPACTO_AMBIENTAL).
          </p>
        </div>

        <div className="flex flex-wrap gap-2 items-end text-sm">
          <div className="flex flex-col">
            <label className="mb-1 font-medium">ID período</label>
            <input
              type="number"
              min="1"
              value={idPeriodo}
              onChange={(e) => setIdPeriodo(e.target.value)}
              className="border rounded px-2 py-1 text-sm w-24"
            />
          </div>
          <button
            type="button"
            onClick={cargar}
            className="bg-emerald-600 text-white px-3 py-1.5 rounded text-sm"
          >
            {loading ? "Cargando…" : "Actualizar"}
          </button>
        </div>
      </header>

      {error && (
        <div className="bg-red-50 border-red-200 border text-red-700 text-sm px-3 py-2 rounded">
          {error}
        </div>
      )}

      <section>
        <div className="overflow-x-auto border rounded bg-white">
          <table className="min-w-full text-sm">
            <thead className="bg-gray-100">
              <tr>
                <th className="px-2 py-1 text-left">Categoría</th>
                <th className="px-2 py-1 text-right">CO₂ total (kg)</th>
                <th className="px-2 py-1 text-right">Agua total (L)</th>
                <th className="px-2 py-1 text-right">Energía total (kWh)</th>
              </tr>
            </thead>
            <tbody>
              {datos.map((c, i) => (
                <tr key={i} className="border-t">
                  <td className="px-2 py-1">{c.categoria}</td>
                  <td className="px-2 py-1 text-right">{c.co2_total}</td>
                  <td className="px-2 py-1 text-right">{c.agua_total}</td>
                  <td className="px-2 py-1 text-right">{c.energia_total}</td>
                </tr>
              ))}
              {datos.length === 0 && (
                <tr>
                  <td
                    className="px-2 py-2 text-center text-gray-400"
                    colSpan={4}
                  >
                    Sin impacto registrado para ese período.
                  </td>
                </tr>
              )}
            </tbody>
          </table>
        </div>
      </section>
    </div>
  );
}
</file>

<file path="frontend/src/pages/ReportesIngresosCreditos.jsx">
import React, { useEffect, useState } from "react";
import { getReporteIngresosCreditos } from "../services/api";

function hoyISO() {
  return new Date().toISOString().slice(0, 10);
}

function hace30DiasISO() {
  const d = new Date(Date.now() - 30 * 24 * 60 * 60 * 1000);
  return d.toISOString().slice(0, 10);
}

export default function ReportesIngresosCreditos() {
  const [desde, setDesde] = useState(hace30DiasISO());
  const [hasta, setHasta] = useState(hoyISO());
  const [datos, setDatos] = useState([]);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState("");

  async function cargar() {
    try {
      setLoading(true);
      setError("");
      const res = await getReporteIngresosCreditos({ desde, hasta });
      setDatos(Array.isArray(res) ? res : []);
    } catch (e) {
      console.error(e);
      setError("Error cargando ingresos por créditos");
      setDatos([]);
    } finally {
      setLoading(false);
    }
  }

  useEffect(() => {
    cargar();
  }, []);

  function handleSubmit(e) {
    e.preventDefault();
    cargar();
  }

  return (
    <div className="p-4 space-y-6">
      <header className="flex flex-col md:flex-row md:items-end md:justify-between gap-3">
        <div>
          <h1 className="text-2xl font-bold">Ingresos por venta de créditos</h1>
          <p className="text-sm text-gray-500">
            Créditos vendidos y monto recaudado por día.
          </p>
        </div>

        <form
          onSubmit={handleSubmit}
          className="flex flex-wrap gap-2 items-end"
        >
          <div className="flex flex-col text-sm">
            <label className="mb-1 font-medium">Desde</label>
            <input
              type="date"
              value={desde}
              onChange={(e) => setDesde(e.target.value)}
              className="border rounded px-2 py-1 text-sm"
            />
          </div>
          <div className="flex flex-col text-sm">
            <label className="mb-1 font-medium">Hasta</label>
            <input
              type="date"
              value={hasta}
              onChange={(e) => setHasta(e.target.value)}
              className="border rounded px-2 py-1 text-sm"
            />
          </div>
          <button
            type="submit"
            className="bg-emerald-600 text-white px-3 py-1.5 rounded text-sm"
          >
            {loading ? "Cargando…" : "Actualizar"}
          </button>
        </form>
      </header>

      {error && (
        <div className="bg-red-50 border-red-200 border text-red-700 text-sm px-3 py-2 rounded">
          {error}
        </div>
      )}

      <section>
        <div className="overflow-x-auto border rounded bg-white">
          <table className="min-w-full text-sm">
            <thead className="bg-gray-100">
              <tr>
                <th className="px-2 py-1 text-left">Fecha</th>
                <th className="px-2 py-1 text-right">Créditos</th>
                <th className="px-2 py-1 text-right">Monto (Bs)</th>
              </tr>
            </thead>
            <tbody>
              {datos.map((r, i) => (
                <tr key={i} className="border-t">
                  <td className="px-2 py-1">{r.fecha}</td>
                  <td className="px-2 py-1 text-right">{r.total_creditos}</td>
                  <td className="px-2 py-1 text-right">{r.total_bs}</td>
                </tr>
              ))}
              {datos.length === 0 && (
                <tr>
                  <td
                    className="px-2 py-2 text-center text-gray-400"
                    colSpan={3}
                  >
                    Sin compras de créditos en el rango.
                  </td>
                </tr>
              )}
            </tbody>
          </table>
        </div>
      </section>
    </div>
  );
}
</file>

<file path="frontend/src/pages/ReportesIntercambiosCategoria.jsx">
import React, { useEffect, useState } from "react";
import { getReporteIntercambiosCategoria } from "../services/api";

function hoyISO() {
  return new Date().toISOString().slice(0, 10);
}

function hace30DiasISO() {
  const d = new Date(Date.now() - 30 * 24 * 60 * 60 * 1000);
  return d.toISOString().slice(0, 10);
}

export default function ReportesIntercambiosCategoria() {
  const [desde, setDesde] = useState(hace30DiasISO());
  const [hasta, setHasta] = useState(hoyISO());
  const [datos, setDatos] = useState([]);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState("");

  async function cargar() {
    try {
      setLoading(true);
      setError("");
      const res = await getReporteIntercambiosCategoria({ desde, hasta });
      setDatos(Array.isArray(res) ? res : []);
    } catch (e) {
      console.error(e);
      setError("Error cargando intercambios por categoría");
      setDatos([]);
    } finally {
      setLoading(false);
    }
  }

  useEffect(() => {
    cargar();
  }, []);

  function handleSubmit(e) {
    e.preventDefault();
    cargar();
  }

  return (
    <div className="p-4 space-y-6">
      <header className="flex flex-col md:flex-row md:items-end md:justify-between gap-3">
        <div>
          <h1 className="text-2xl font-bold">Intercambios por categoría</h1>
          <p className="text-sm text-gray-500">
            Número de intercambios agrupados por categoría de publicación.
          </p>
        </div>

        <form
          onSubmit={handleSubmit}
          className="flex flex-wrap gap-2 items-end"
        >
          <div className="flex flex-col text-sm">
            <label className="mb-1 font-medium">Desde</label>
            <input
              type="date"
              value={desde}
              onChange={(e) => setDesde(e.target.value)}
              className="border rounded px-2 py-1 text-sm"
            />
          </div>
          <div className="flex flex-col text-sm">
            <label className="mb-1 font-medium">Hasta</label>
            <input
              type="date"
              value={hasta}
              onChange={(e) => setHasta(e.target.value)}
              className="border rounded px-2 py-1 text-sm"
            />
          </div>
          <button
            type="submit"
            className="bg-emerald-600 text-white px-3 py-1.5 rounded text-sm"
          >
            {loading ? "Cargando…" : "Actualizar"}
          </button>
        </form>
      </header>

      {error && (
        <div className="bg-red-50 border-red-200 border text-red-700 text-sm px-3 py-2 rounded">
          {error}
        </div>
      )}

      <section>
        <div className="overflow-x-auto border rounded bg-white">
          <table className="min-w-full text-sm">
            <thead className="bg-gray-100">
              <tr>
                <th className="px-2 py-1 text-left">Categoría</th>
                <th className="px-2 py-1 text-right">Intercambios</th>
              </tr>
            </thead>
            <tbody>
              {datos.map((c, i) => (
                <tr key={i} className="border-t">
                  <td className="px-2 py-1">{c.categoria}</td>
                  <td className="px-2 py-1 text-right">
                    {c.total_intercambios}
                  </td>
                </tr>
              ))}
              {datos.length === 0 && (
                <tr>
                  <td
                    className="px-2 py-2 text-center text-gray-400"
                    colSpan={2}
                  >
                    No hay intercambios en el rango.
                  </td>
                </tr>
              )}
            </tbody>
          </table>
        </div>
      </section>
    </div>
  );
}
</file>

<file path="frontend/src/pages/ReportesPublicacionesVsIntercambios.jsx">
import React, { useEffect, useState } from "react";
import { getReportePublicacionesVsIntercambios } from "../services/api";

function hoyISO() {
  return new Date().toISOString().slice(0, 10);
}

function hace30DiasISO() {
  const d = new Date(Date.now() - 30 * 24 * 60 * 60 * 1000);
  return d.toISOString().slice(0, 10);
}

export default function ReportesPublicacionesIntercambios() {
  const [desde, setDesde] = useState(hace30DiasISO());
  const [hasta, setHasta] = useState(hoyISO());
  const [datos, setDatos] = useState([]);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState("");

  async function cargar() {
    try {
      setLoading(true);
      setError("");
      const res = await getReportePublicacionesVsIntercambios({
        desde,
        hasta,
      });
      setDatos(Array.isArray(res) ? res : []);
    } catch (e) {
      console.error(e);
      setError("Error cargando publicaciones vs intercambios");
      setDatos([]);
    } finally {
      setLoading(false);
    }
  }

  useEffect(() => {
    cargar();
  }, []);

  function handleSubmit(e) {
    e.preventDefault();
    cargar();
  }

  return (
    <div className="p-4 space-y-6">
      <header className="flex flex-col md:flex-row md:items-end md:justify-between gap-3">
        <div>
          <h1 className="text-2xl font-bold">
            Publicaciones vs intercambios por categoría
          </h1>
          <p className="text-sm text-gray-500">
            Relación entre publicaciones creadas y las que se concretan como
            intercambio.
          </p>
        </div>

        <form
          onSubmit={handleSubmit}
          className="flex flex-wrap gap-2 items-end"
        >
          <div className="flex flex-col text-sm">
            <label className="mb-1 font-medium">Desde</label>
            <input
              type="date"
              value={desde}
              onChange={(e) => setDesde(e.target.value)}
              className="border rounded px-2 py-1 text-sm"
            />
          </div>
          <div className="flex flex-col text-sm">
            <label className="mb-1 font-medium">Hasta</label>
            <input
              type="date"
              value={hasta}
              onChange={(e) => setHasta(e.target.value)}
              className="border rounded px-2 py-1 text-sm"
            />
          </div>
          <button
            type="submit"
            className="bg-emerald-600 text-white px-3 py-1.5 rounded text-sm"
          >
            {loading ? "Cargando…" : "Actualizar"}
          </button>
        </form>
      </header>

      {error && (
        <div className="bg-red-50 border-red-200 border text-red-700 text-sm px-3 py-2 rounded">
          {error}
        </div>
      )}

      <section>
        <div className="overflow-x-auto border rounded bg-white">
          <table className="min-w-full text-sm">
            <thead className="bg-gray-100">
              <tr>
                <th className="px-2 py-1 text-left">Categoría</th>
                <th className="px-2 py-1 text-right">Publicaciones</th>
                <th className="px-2 py-1 text-right">Intercambios</th>
                <th className="px-2 py-1 text-right">Ratio</th>
              </tr>
            </thead>
            <tbody>
              {datos.map((p, i) => (
                <tr key={i} className="border-t">
                  <td className="px-2 py-1">{p.categoria}</td>
                  <td className="px-2 py-1 text-right">{p.publicaciones}</td>
                  <td className="px-2 py-1 text-right">{p.intercambios}</td>
                  <td className="px-2 py-1 text-right">
                    {p.ratio_intercambio ?? "-"}
                  </td>
                </tr>
              ))}
              {datos.length === 0 && (
                <tr>
                  <td
                    className="px-2 py-2 text-center text-gray-400"
                    colSpan={4}
                  >
                    Sin datos para el rango.
                  </td>
                </tr>
              )}
            </tbody>
          </table>
        </div>
      </section>
    </div>
  );
}
</file>

<file path="frontend/src/pages/ReportesRankingUsuarios.jsx">
import React, { useState } from "react";
import { getReporteRankingUsuarios } from "../services/api";

export default function ReportesRankingUsuarios() {
  const [idPeriodo, setIdPeriodo] = useState("");
  const [limit, setLimit] = useState(10);
  const [datos, setDatos] = useState([]);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState("");

  async function cargar() {
    try {
      setLoading(true);
      setError("");
      const res = await getReporteRankingUsuarios({ idPeriodo, limit });
      setDatos(Array.isArray(res) ? res : []);
    } catch (e) {
      console.error(e);
      setError("Error cargando ranking de usuarios");
      setDatos([]);
    } finally {
      setLoading(false);
    }
  }

  return (
    <div className="p-4 space-y-6">
      <header className="flex flex-col md:flex-row md:items-end md:justify-between gap-3">
        <div>
          <h1 className="text-2xl font-bold">Ranking de usuarios por impacto</h1>
          <p className="text-sm text-gray-500">
            Usuarios ordenados por impacto ambiental (CO₂, agua, energía).
          </p>
        </div>

        <div className="flex flex-wrap gap-2 items-end text-sm">
          <div className="flex flex-col">
            <label className="mb-1 font-medium">ID período (opcional)</label>
            <input
              type="number"
              min="1"
              value={idPeriodo}
              onChange={(e) => setIdPeriodo(e.target.value)}
              className="border rounded px-2 py-1 text-sm w-24"
              placeholder="ej. 1"
            />
          </div>
          <div className="flex flex-col">
            <label className="mb-1 font-medium">Top N</label>
            <input
              type="number"
              min="1"
              value={limit}
              onChange={(e) => setLimit(Number(e.target.value))}
              className="border rounded px-2 py-1 text-sm w-20"
            />
          </div>
          <button
            type="button"
            onClick={cargar}
            className="bg-emerald-600 text-white px-3 py-1.5 rounded text-sm"
          >
            {loading ? "Cargando…" : "Actualizar"}
          </button>
        </div>
      </header>

      {error && (
        <div className="bg-red-50 border-red-200 border text-red-700 text-sm px-3 py-2 rounded">
          {error}
        </div>
      )}

      <section>
        <div className="overflow-x-auto border rounded bg-white">
          <table className="min-w-full text-sm">
            <thead className="bg-gray-100">
              <tr>
                <th className="px-2 py-1 text-left">Usuario (ID)</th>
                <th className="px-2 py-1 text-right">CO₂ total (kg)</th>
                <th className="px-2 py-1 text-right">Agua total (L)</th>
                <th className="px-2 py-1 text-right">Energía total (kWh)</th>
                <th className="px-2 py-1 text-right">Transacciones</th>
              </tr>
            </thead>
            <tbody>
              {datos.map((r, i) => (
                <tr key={i} className="border-t">
                  <td className="px-2 py-1">{r.id_usuario}</td>
                  <td className="px-2 py-1 text-right">{r.co2_total}</td>
                  <td className="px-2 py-1 text-right">{r.agua_total}</td>
                  <td className="px-2 py-1 text-right">{r.energia_total}</td>
                  <td className="px-2 py-1 text-right">{r.transacciones}</td>
                </tr>
              ))}
              {datos.length === 0 && (
                <tr>
                  <td
                    className="px-2 py-2 text-center text-gray-400"
                    colSpan={5}
                  >
                    Sin datos de ranking para los filtros actuales.
                  </td>
                </tr>
              )}
            </tbody>
          </table>
        </div>
      </section>
    </div>
  );
}
</file>

<file path="frontend/src/pages/ReportesSaldosUsuarios.jsx">
import React, { useEffect, useState } from "react";
import { getReporteSaldosUsuarios } from "../services/api";

export default function ReportesSaldosUsuarios() {
  const [limit, setLimit] = useState(20);
  const [datos, setDatos] = useState([]);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState("");

  async function cargar() {
    try {
      setLoading(true);
      setError("");
      const res = await getReporteSaldosUsuarios({ limit });
      setDatos(Array.isArray(res) ? res : []);
    } catch (e) {
      console.error(e);
      setError("Error cargando saldos de usuarios");
      setDatos([]);
    } finally {
      setLoading(false);
    }
  }

  useEffect(() => {
    cargar();
  }, []);

  return (
    <div className="p-4 space-y-6">
      <header className="flex flex-col md:flex-row md:items-end md:justify-between gap-3">
        <div>
          <h1 className="text-2xl font-bold">Saldos de créditos por usuario</h1>
          <p className="text-sm text-gray-500">
            Top de usuarios con mayor saldo en su billetera.
          </p>
        </div>

        <div className="flex flex-wrap gap-2 items-end text-sm">
          <div className="flex flex-col">
            <label className="mb-1 font-medium">Top N</label>
            <input
              type="number"
              min="1"
              value={limit}
              onChange={(e) => setLimit(Number(e.target.value))}
              className="border rounded px-2 py-1 text-sm w-20"
            />
          </div>
          <button
            type="button"
            onClick={cargar}
            className="bg-emerald-600 text-white px-3 py-1.5 rounded text-sm"
          >
            {loading ? "Cargando…" : "Actualizar"}
          </button>
        </div>
      </header>

      {error && (
        <div className="bg-red-50 border-red-200 border text-red-700 text-sm px-3 py-2 rounded">
          {error}
        </div>
      )}

      <section>
        <div className="overflow-x-auto border rounded bg-white">
          <table className="min-w-full text-sm">
            <thead className="bg-gray-100">
              <tr>
                <th className="px-2 py-1 text-left">Usuario</th>
                <th className="px-2 py-1 text-left">Correo</th>
                <th className="px-2 py-1 text-right">Saldo créditos</th>
              </tr>
            </thead>
            <tbody>
              {datos.map((u, i) => (
                <tr key={i} className="border-t">
                  <td className="px-2 py-1">{u.nombre}</td>
                  <td className="px-2 py-1">{u.correo}</td>
                  <td className="px-2 py-1 text-right">
                    {u.saldo_creditos}
                  </td>
                </tr>
              ))}
              {datos.length === 0 && (
                <tr>
                  <td
                    className="px-2 py-2 text-center text-gray-400"
                    colSpan={3}
                  >
                    Sin datos de saldos para mostrar.
                  </td>
                </tr>
              )}
            </tbody>
          </table>
        </div>
      </section>
    </div>
  );
}
</file>

<file path="frontend/src/pages/ReportesUsuarios.jsx">
import React, { useEffect, useState } from "react";
import {
  getReporteUsuariosActivos,
  getReporteUsuariosAbandonados,
  getReporteUsuariosNuevos,
} from "../services/api";

function hoyISO() {
  return new Date().toISOString().slice(0, 10);
}

function hace30DiasISO() {
  const d = new Date(Date.now() - 30 * 24 * 60 * 60 * 1000);
  return d.toISOString().slice(0, 10);
}

export default function ReportesUsuarios() {
  const [desde, setDesde] = useState(hace30DiasISO());
  const [hasta, setHasta] = useState(hoyISO());

  const [activos, setActivos] = useState([]);
  const [abandonados, setAbandonados] = useState([]);
  const [nuevos, setNuevos] = useState([]);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState("");

  async function cargar() {
    try {
      setLoading(true);
      setError("");
      const [a, b, n] = await Promise.all([
        getReporteUsuariosActivos({ desde, hasta }),
        getReporteUsuariosAbandonados({ desde, hasta }),
        getReporteUsuariosNuevos({ desde, hasta }),
      ]);
      setActivos(Array.isArray(a) ? a : []);
      setAbandonados(Array.isArray(b) ? b : []);
      setNuevos(Array.isArray(n) ? n : []);
    } catch (e) {
      console.error(e);
      setError("Error cargando reportes de usuarios");
      setActivos([]);
      setAbandonados([]);
      setNuevos([]);
    } finally {
      setLoading(false);
    }
  }

  useEffect(() => {
    cargar();
  }, []);

  function handleSubmit(e) {
    e.preventDefault();
    cargar();
  }

  return (
    <div className="p-4 space-y-6">
      <header className="flex flex-col md:flex-row md:items-end md:justify-between gap-3">
        <div>
          <h1 className="text-2xl font-bold">Reporte de usuarios</h1>
          <p className="text-sm text-gray-500">
            Usuarios activos, abandonados y nuevos (primer login).
          </p>
        </div>

        <form
          onSubmit={handleSubmit}
          className="flex flex-wrap gap-2 items-end"
        >
          <div className="flex flex-col text-sm">
            <label className="mb-1 font-medium">Desde</label>
            <input
              type="date"
              value={desde}
              onChange={(e) => setDesde(e.target.value)}
              className="border rounded px-2 py-1 text-sm"
            />
          </div>
          <div className="flex flex-col text-sm">
            <label className="mb-1 font-medium">Hasta</label>
            <input
              type="date"
              value={hasta}
              onChange={(e) => setHasta(e.target.value)}
              className="border rounded px-2 py-1 text-sm"
            />
          </div>
          <button
            type="submit"
            className="bg-emerald-600 text-white px-3 py-1.5 rounded text-sm"
          >
            {loading ? "Cargando…" : "Actualizar"}
          </button>
        </form>
      </header>

      {error && (
        <div className="bg-red-50 border border-red-200 text-red-700 text-sm px-3 py-2 rounded">
          {error}
        </div>
      )}

      {/* Usuarios activos */}
      <section className="space-y-2">
        <h2 className="font-semibold">Usuarios activos ({activos.length})</h2>
        <div className="overflow-x-auto border rounded bg-white">
          <table className="min-w-full text-xs">
            <thead className="bg-gray-100">
              <tr>
                <th className="px-2 py-1 text-left">Usuario</th>
                <th className="px-2 py-1 text-left">Correo</th>
                <th className="px-2 py-1 text-right">Primera actividad</th>
                <th className="px-2 py-1 text-right">Última actividad</th>
                <th className="px-2 py-1 text-right">Total acciones</th>
              </tr>
            </thead>
            <tbody>
              {activos.map((u, i) => (
                <tr key={i} className="border-t">
                  <td className="px-2 py-1">{u.nombre}</td>
                  <td className="px-2 py-1">{u.correo}</td>
                  <td className="px-2 py-1 text-right">
                    {u.primera_actividad || "-"}
                  </td>
                  <td className="px-2 py-1 text-right">
                    {u.ultima_actividad || "-"}
                  </td>
                  <td className="px-2 py-1 text-right">{u.total_acciones}</td>
                </tr>
              ))}
              {activos.length === 0 && (
                <tr>
                  <td
                    className="px-2 py-2 text-center text-gray-400"
                    colSpan={5}
                  >
                    Sin datos en el rango.
                  </td>
                </tr>
              )}
            </tbody>
          </table>
        </div>
      </section>

      {/* Usuarios abandonados */}
      <section className="space-y-2">
        <h2 className="font-semibold">
          Usuarios abandonados ({abandonados.length})
        </h2>
        <div className="overflow-x-auto border rounded bg-white">
          <table className="min-w-full text-xs">
            <thead className="bg-gray-100">
              <tr>
                <th className="px-2 py-1 text-left">Usuario</th>
                <th className="px-2 py-1 text-left">Correo</th>
                <th className="px-2 py-1 text-right">Estado</th>
              </tr>
            </thead>
            <tbody>
              {abandonados.map((u, i) => (
                <tr key={i} className="border-t">
                  <td className="px-2 py-1">{u.nombre}</td>
                  <td className="px-2 py-1">{u.correo}</td>
                  <td className="px-2 py-1 text-right">{u.estado}</td>
                </tr>
              ))}
              {abandonados.length === 0 && (
                <tr>
                  <td
                    className="px-2 py-2 text-center text-gray-400"
                    colSpan={3}
                  >
                    Sin datos en el rango.
                  </td>
                </tr>
              )}
            </tbody>
          </table>
        </div>
      </section>

      {/* Usuarios nuevos (primer login) */}
      <section className="space-y-2">
        <h2 className="font-semibold">
          Usuarios nuevos (primer login) ({nuevos.length})
        </h2>
        <div className="overflow-x-auto border rounded bg-white">
          <table className="min-w-full text-xs">
            <thead className="bg-gray-100">
              <tr>
                <th className="px-2 py-1 text-left">Usuario</th>
                <th className="px-2 py-1 text-left">Correo</th>
                <th className="px-2 py-1 text-right">Fecha primer login</th>
              </tr>
            </thead>
            <tbody>
              {nuevos.map((u, i) => (
                <tr key={i} className="border-t">
                  <td className="px-2 py-1">{u.nombre}</td>
                  <td className="px-2 py-1">{u.correo}</td>
                  <td className="px-2 py-1 text-right">
                    {u.fecha_primer_login}
                  </td>
                </tr>
              ))}
              {nuevos.length === 0 && (
                <tr>
                  <td
                    className="px-2 py-2 text-center text-gray-400"
                    colSpan={3}
                  >
                    Sin usuarios nuevos en el rango.
                  </td>
                </tr>
              )}
            </tbody>
          </table>
        </div>
      </section>
    </div>
  );
}
</file>

<file path="frontend/src/pages/ReportesUsuariosPremium.jsx">
import React, { useEffect, useState } from "react";
import { getReporteUsuariosPremium } from "../services/api";

function hoyISO() {
  return new Date().toISOString().slice(0, 10);
}

function hace30DiasISO() {
  const d = new Date(Date.now() - 30 * 24 * 60 * 60 * 1000);
  return d.toISOString().slice(0, 10);
}

export default function ReportesUsuariosPremium() {
  const [desde, setDesde] = useState(hace30DiasISO());
  const [hasta, setHasta] = useState(hoyISO());
  const [datos, setDatos] = useState([]);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState("");

  async function cargar() {
    try {
      setLoading(true);
      setError("");
      const res = await getReporteUsuariosPremium({ desde, hasta });
      setDatos(Array.isArray(res) ? res : []);
    } catch (e) {
      console.error(e);
      setError("Error cargando reporte de usuarios premium");
      setDatos([]);
    } finally {
      setLoading(false);
    }
  }

  useEffect(() => {
    cargar();
  }, []);

  function handleSubmit(e) {
    e.preventDefault();
    cargar();
  }

  return (
    <div className="p-4 space-y-6">
      <header className="flex flex-col md:flex-row md:items-end md:justify-between gap-3">
        <div>
          <h1 className="text-2xl font-bold">Usuarios premium</h1>
          <p className="text-sm text-gray-500">
            Adopción del plan premium e ingresos por suscripción.
          </p>
        </div>

        <form
          onSubmit={handleSubmit}
          className="flex flex-wrap gap-2 items-end"
        >
          <div className="flex flex-col text-sm">
            <label className="mb-1 font-medium">Desde</label>
            <input
              type="date"
              value={desde}
              onChange={(e) => setDesde(e.target.value)}
              className="border rounded px-2 py-1 text-sm"
            />
          </div>
          <div className="flex flex-col text-sm">
            <label className="mb-1 font-medium">Hasta</label>
            <input
              type="date"
              value={hasta}
              onChange={(e) => setHasta(e.target.value)}
              className="border rounded px-2 py-1 text-sm"
            />
          </div>
          <button
            type="submit"
            className="bg-emerald-600 text-white px-3 py-1.5 rounded text-sm"
          >
            {loading ? "Cargando…" : "Actualizar"}
          </button>
        </form>
      </header>

      {error && (
        <div className="bg-red-50 border-red-200 border text-red-700 text-sm px-3 py-2 rounded">
          {error}
        </div>
      )}

      <section>
        <div className="overflow-x-auto border rounded bg-white">
          <table className="min-w-full text-sm">
            <thead className="bg-gray-100">
              <tr>
                <th className="px-2 py-1 text-left">Desde</th>
                <th className="px-2 py-1 text-left">Hasta</th>
                <th className="px-2 py-1 text-right">Usuarios activos</th>
                <th className="px-2 py-1 text-right">Nuevos premium</th>
                <th className="px-2 py-1 text-right">Premium activos</th>
                <th className="px-2 py-1 text-right">Ingresos (Bs)</th>
                <th className="px-2 py-1 text-right">% adopción</th>
              </tr>
            </thead>
            <tbody>
              {datos.map((r, i) => (
                <tr key={i} className="border-t">
                  <td className="px-2 py-1">{r.desde}</td>
                  <td className="px-2 py-1">{r.hasta}</td>
                  <td className="px-2 py-1 text-right">
                    {r.total_usuarios_activos}
                  </td>
                  <td className="px-2 py-1 text-right">
                    {r.usuarios_nuevos_premium}
                  </td>
                  <td className="px-2 py-1 text-right">
                    {r.usuarios_premium_activos}
                  </td>
                  <td className="px-2 py-1 text-right">
                    {r.ingresos_suscripcion_bs}
                  </td>
                  <td className="px-2 py-1 text-right">
                    {r.porcentaje_adopcion_premium}%
                  </td>
                </tr>
              ))}
              {datos.length === 0 && (
                <tr>
                  <td
                    className="px-2 py-2 text-center text-gray-400"
                    colSpan={7}
                  >
                    Sin datos de suscripciones premium en el rango.
                  </td>
                </tr>
              )}
            </tbody>
          </table>
        </div>
      </section>
    </div>
  );
}
</file>

<file path="frontend/src/router.jsx">
// frontend/src/router.jsx
import React from "react";
import { Routes, Route, Navigate } from "react-router-dom";
import ProtectedRoute from "./components/ProtectedRoute.jsx";
import Layout from "./components/Layout.jsx";

// Páginas base
import Login from "./pages/Login.jsx";
import Home from "./pages/Home.jsx";
import NotFound from "./pages/NotFound.jsx";

// Índice de reportes + botón a dashboard
import Reportes from "./pages/Reportes.jsx";

// Dashboard con gráficas (ya lo tienes creado)
import ReportesDashboard from "./pages/ReportesDashboard.jsx";

// Páginas individuales de reportes (tablas)
import ReportesUsuarios from "./pages/ReportesUsuarios.jsx";
import ReportesIngresosCreditos from "./pages/ReportesIngresosCreditos.jsx";
import ReportesCreditosGeneradosConsumidos from "./pages/ReportesCreditosGeneradosConsumidos.jsx";
import ReportesIntercambiosCategoria from "./pages/ReportesIntercambiosCategoria.jsx";
import ReportesPublicacionesVsIntercambios from "./pages/ReportesPublicacionesVsIntercambios.jsx";
import ReportesImpactoAcumulado from "./pages/ReportesImpactoAcumulado.jsx";

import ReportesRankingUsuarios from "./pages/ReportesRankingUsuarios.jsx";
import ReportesUsuariosPremium from "./pages/ReportesUsuariosPremium.jsx";
import ReportesSaldosUsuarios from "./pages/ReportesSaldosUsuarios.jsx";
import ReportesActividadesSostenibles from "./pages/ReportesActividadesSostenibles.jsx";
import ReportesImpactoCategoria from "./pages/ReportesImpactoCategoria.jsx";

import BackendLab from "./pages/BackendLab.jsx";

export default function AppRouter() {
  return (
    <Routes>
      {/* Ruta raíz → /home */}
      <Route path="/" element={<Navigate to="/home" replace />} />

      {/* Login público */}
      <Route path="/login" element={<Login />} />

      {/* Home protegido */}
      <Route
        path="/home"
        element={
          <ProtectedRoute>
            <Layout>
              <Home />
            </Layout>
          </ProtectedRoute>
        }
      />

      {/* Índice de reportes (lista de tarjetas + botón al dashboard) */}
      <Route
        path="/reportes"
        element={
          <ProtectedRoute>
            <Layout>
              <Reportes />
            </Layout>
          </ProtectedRoute>
        }
      />

      {/* Páginas individuales de reportes (tablas) */}
      <Route
        path="/reportes/usuarios"
        element={
          <ProtectedRoute>
            <Layout>
              <ReportesUsuarios />
            </Layout>
          </ProtectedRoute>
        }
      />

      <Route
        path="/reportes/ingresos-creditos"
        element={
          <ProtectedRoute>
            <Layout>
              <ReportesIngresosCreditos />
            </Layout>
          </ProtectedRoute>
        }
      />

      <Route
        path="/reportes/creditos-generados-consumidos"
        element={
          <ProtectedRoute>
            <Layout>
              <ReportesCreditosGeneradosConsumidos />
            </Layout>
          </ProtectedRoute>
        }
      />

      <Route
        path="/reportes/intercambios-categoria"
        element={
          <ProtectedRoute>
            <Layout>
              <ReportesIntercambiosCategoria />
            </Layout>
          </ProtectedRoute>
        }
      />

      <Route
        path="/reportes/publicaciones-intercambios"
        element={
          <ProtectedRoute>
            <Layout>
              <ReportesPublicacionesVsIntercambios />
            </Layout>
          </ProtectedRoute>
        }
      />

      <Route
        path="/reportes/impacto-acumulado"
        element={
          <ProtectedRoute>
            <Layout>
              <ReportesImpactoAcumulado />
            </Layout>
          </ProtectedRoute>
        }
      />

      <Route
        path="/reportes/ranking-usuarios"
        element={
          <ProtectedRoute>
            <Layout>
              <ReportesRankingUsuarios />
            </Layout>
          </ProtectedRoute>
        }
      />

      <Route
        path="/reportes/usuarios-premium"
        element={
          <ProtectedRoute>
            <Layout>
              <ReportesUsuariosPremium />
            </Layout>
          </ProtectedRoute>
        }
      />

      <Route
        path="/reportes/saldos-usuarios"
        element={
          <ProtectedRoute>
            <Layout>
              <ReportesSaldosUsuarios />
            </Layout>
          </ProtectedRoute>
        }
      />

      <Route
        path="/reportes/actividades-sostenibles"
        element={
          <ProtectedRoute>
            <Layout>
              <ReportesActividadesSostenibles />
            </Layout>
          </ProtectedRoute>
        }
      />

      <Route
        path="/reportes/impacto-categoria"
        element={
          <ProtectedRoute>
            <Layout>
              <ReportesImpactoCategoria />
            </Layout>
          </ProtectedRoute>
        }
      />

      {/* Dashboard con gráficos de reportes */}
      <Route
        path="/reportes-dashboard"
        element={
          <ProtectedRoute>
            <Layout>
              <ReportesDashboard />
            </Layout>
          </ProtectedRoute>
        }
      />

      <Route
        path="/backend-lab"
        element={
          <ProtectedRoute>
            <Layout>
              <BackendLab />
            </Layout>
          </ProtectedRoute>
        }
      />

      {/* 404 */}
      <Route path="*" element={<NotFound />} />
    </Routes>
  );
}
</file>

<file path="frontend/src/services/api.js">
// frontend/src/services/api.js
const API_URL = import.meta.env.VITE_API_URL ?? "http://localhost:4000/api";

function authHeaders() {
  const token = localStorage.getItem("token");
  if (!token) return {};
  return {
    Authorization: `Bearer ${token}`,
  };
}

export async function api(path, { method = "GET", body, headers = {} } = {}) {
  const isJsonBody = body && !(body instanceof FormData);

  const res = await fetch(`${API_URL}${path}`, {
    method,
    headers: {
      ...(isJsonBody ? { "Content-Type": "application/json" } : {}),
      ...authHeaders(),
      ...headers,
    },
    body: isJsonBody ? JSON.stringify(body) : body,
  });

  const text = await res.text();

  if (!res.ok) {
    let message =
      res.statusText || `Error HTTP ${res.status}` || "Error en la solicitud";

    if (text) {
      try {
        const parsed = JSON.parse(text);
        if (parsed && parsed.message) {
          message = parsed.message;
        }
      } catch {
        message = text;
      }
    }

    throw new Error(message);
  }

  if (!text) {
    return null;
  }

  try {
    return JSON.parse(text);
  } catch {
    console.warn("Respuesta no JSON para", path, "=>", text);
    return text;
  }
}

export async function login({ correo, password }) {
  const data = await api("/auth/login", {
    method: "POST",
    body: { correo, password },
  });

  if (data?.token) {
    localStorage.setItem("token", data.token);
    if (data.usuario) {
      localStorage.setItem("usuario", JSON.stringify(data.usuario));
    }
  }

  return data;
}

export function logout() {
  localStorage.removeItem("token");
  localStorage.removeItem("usuario");
}

export async function getHealth() {
  return api("/health");
}

function buildRangeQuery(desde, hasta) {
  const params = new URLSearchParams();
  if (desde) params.append("desde", desde);
  if (hasta) params.append("hasta", hasta);
  const qs = params.toString();
  return qs ? `?${qs}` : "";
}

export async function register({ nombre, apellido, correo, password, telefono }) {
  return api("/auth/register", {
    method: "POST",
    body: { nombre, apellido, correo, password, telefono },
  });
}

//REPORTES

// Usuarios activos
export function getReporteUsuariosActivos({ desde, hasta } = {}) {
  return api(`/reportes/usuarios-activos${buildRangeQuery(desde, hasta)}`);
}

// Usuarios abandonados
export function getReporteUsuariosAbandonados({ desde, hasta } = {}) {
  return api(`/reportes/usuarios-abandonados${buildRangeQuery(desde, hasta)}`);
}

// Ingresos por venta de créditos
export function getReporteIngresosCreditos({ desde, hasta } = {}) {
  return api(`/reportes/ingresos-creditos${buildRangeQuery(desde, hasta)}`);
}

// Créditos generados vs consumidos
export function getReporteCreditosGeneradosVsConsumidos({ desde, hasta } = {}) {
  return api(
    `/reportes/creditos-generados-consumidos${buildRangeQuery(desde, hasta)}`
  );
}

// Intercambios por categoría
export function getReporteIntercambiosCategoria({ desde, hasta } = {}) {
  return api(
    `/reportes/intercambios-categoria${buildRangeQuery(desde, hasta)}`
  );
}

// Publicaciones vs intercambios
export function getReportePublicacionesVsIntercambios({ desde, hasta } = {}) {
  return api(
    `/reportes/publicaciones-vs-intercambios${buildRangeQuery(desde, hasta)}`
  );
}

// Impacto acumulado (REPORTE_IMPACTO)
export function getReporteImpactoAcumulado({ idTipoReporte, idPeriodo }) {
  const params = new URLSearchParams();
  if (idTipoReporte != null) params.append("idTipoReporte", idTipoReporte);
  if (idPeriodo != null) params.append("idPeriodo", idPeriodo);
  const qs = params.toString();
  return api(`/reportes/impacto-acumulado?${qs}`);
}

//REPORTES 

// Ranking de usuarios por impacto
export function getReporteRankingUsuarios({ idPeriodo = null, limit = 10 } = {}) {
  const params = new URLSearchParams();
  if (idPeriodo != null && idPeriodo !== "") {
    params.append("idPeriodo", idPeriodo);
  }
  if (limit != null) {
    params.append("limit", String(limit));
  }
  const qs = params.toString();
  return api(`/reportes/ranking-usuarios?${qs}`);
}

// Usuarios premium
export function getReporteUsuariosPremium({ desde, hasta } = {}) {
  return api(`/reportes/usuarios-premium${buildRangeQuery(desde, hasta)}`);
}

// Usuarios nuevos (primer login)
export function getReporteUsuariosNuevos({ desde, hasta } = {}) {
  return api(`/reportes/usuarios-nuevos${buildRangeQuery(desde, hasta)}`);
}

// Saldos de créditos por usuario (top N)
export function getReporteSaldosUsuarios({ limit = 20 } = {}) {
  const params = new URLSearchParams();
  params.append("limit", String(limit));
  const qs = params.toString();
  return api(`/reportes/saldos-usuarios?${qs}`);
}

// Actividades sostenibles por usuario
export function getReporteActividadesSostenibles({ desde, hasta } = {}) {
  return api(
    `/reportes/actividades-sostenibles${buildRangeQuery(desde, hasta)}`
  );
}

// Impacto ambiental por categoría
export function getReporteImpactoPorCategoria({ idPeriodo }) {
  const params = new URLSearchParams();
  if (idPeriodo != null) params.append("idPeriodo", idPeriodo);
  const qs = params.toString();
  return api(`/reportes/impacto-categoria?${qs}`);
}
</file>

<file path="frontend/tailwind.config.js">
/** @type {import('tailwindcss').Config} */
module.exports = {
  content: [
    "./index.html",
    "./src/**/*.{js,jsx,ts,tsx}"
  ],
  theme: {
    extend: {}
  },
  plugins: []
};
</file>

<file path="frontend/vite.config.js">
import { defineConfig } from "vite";
import react from "@vitejs/plugin-react";

export default defineConfig({
  plugins: [react()],
  server: {
    port: 5173
  }
});
</file>

<file path="package.json">
{
  "name": "iu-db-monorepo",
  "private": true,
  "version": "0.1.0",
  "scripts": {
    "dev": "npm-run-all --parallel dev:front dev:back",
    "dev:front": "npm --prefix frontend run dev",
    "dev:back": "npm --prefix backend run dev",
    "build": "npm-run-all build:front build:back",
    "build:front": "npm --prefix frontend run build",
    "build:back": "npm --prefix backend run build",
    "db:migrate": "npm --prefix backend run prisma:migrate",
    "db:seed": "npm --prefix backend run prisma:seed"
  },
  "devDependencies": {
    "npm-run-all": "^4.1.5"
  }
}
</file>

<file path="README.md">
# Monorepo: UI + API + DB (React + Vite + Tailwind / Node + Express + Prisma / MySQL)

## Dev rápido
```bash
# en la raíz
npm install
npm run dev
```

## Requisitos
- Node 18+
- Docker (opcional para DB)

## Estructura
- `frontend/` React + Vite + Tailwind
- `backend/`  Node + Express + Prisma (MySQL)
- `infra/db/` SQL de init y seeds
</file>

</files>
</file>

<file path="base de datos/pruebas_finales(ejemplo de jose).sql">
USE CREDITOS_VERDES2;

-- -------------------------------------------------------------------
-- 0) Asegurar equivalencia de impacto para Tecnología (por si acaso)
-- -------------------------------------------------------------------
INSERT IGNORE INTO EQUIVALENCIA_IMPACTO (id_categoria, id_um, co2_por_unidad, agua_por_unidad, energia_por_unidad)
SELECT
  (SELECT id_categoria FROM CATEGORIA WHERE nombre = 'Tecnología' LIMIT 1),
  (SELECT id_um FROM UNIDAD_MEDIDA WHERE simbolo = 'u' LIMIT 1),
  8.000000,
  30.000000,
  3.500000;

-- ===========================================================
-- 1) Nuevos usuarios compradores + billeteras
-- ===========================================================
INSERT INTO USUARIO (id_rol, estado, nombre, apellido, correo, telefono, url_perfil)
VALUES
  ((SELECT id_rol FROM ROL WHERE nombre='COMPRADOR'),'ACTIVO','Bruno','Rojas','bruno@demo.com','70000006','/p/bruno'),
  ((SELECT id_rol FROM ROL WHERE nombre='COMPRADOR'),'ACTIVO','Elena','Suarez','elena@demo.com','70000007','/p/elena'),
  ((SELECT id_rol FROM ROL WHERE nombre='COMPRADOR'),'ACTIVO','Fernando','Almeida','fernando@demo.com','70000008','/p/fernando'),
  ((SELECT id_rol FROM ROL WHERE nombre='COMPRADOR'),'ACTIVO','Gaby','Flores','gaby@demo.com','70000009','/p/gaby'),
  ((SELECT id_rol FROM ROL WHERE nombre='COMPRADOR'),'ACTIVO','Hugo','Vargas','hugo@demo.com','70000010','/p/hugo'),
  ((SELECT id_rol FROM ROL WHERE nombre='COMPRADOR'),'ACTIVO','Irene','Paz','irene@demo.com','70000011','/p/irene'),
  ((SELECT id_rol FROM ROL WHERE nombre='COMPRADOR'),'ACTIVO','Jorge','Campos','jorge@demo.com','70000012','/p/jorge');

-- Nuevos vendedores extra
INSERT INTO USUARIO (id_rol, estado, nombre, apellido, correo, telefono, url_perfil)
VALUES
  ((SELECT id_rol FROM ROL WHERE nombre='VENDEDOR'),'ACTIVO','Eco','Store','eco1@demo.com','70000013','/p/eco1'),
  ((SELECT id_rol FROM ROL WHERE nombre='VENDEDOR'),'ACTIVO','ReUse','Market','eco2@demo.com','70000014','/p/eco2');

-- Crear billetera para TODOS los usuarios nuevos (si no tienen)
INSERT INTO BILLETERA (id_usuario, estado, saldo_creditos, saldo_bs, cuenta_bancaria)
SELECT u.id_usuario, 'ACTIVA', 0, 0.00, NULL
FROM USUARIO u
LEFT JOIN BILLETERA b ON b.id_usuario = u.id_usuario
WHERE u.correo IN (
  'bruno@demo.com','elena@demo.com','fernando@demo.com',
  'gaby@demo.com','hugo@demo.com','irene@demo.com','jorge@demo.com',
  'eco1@demo.com','eco2@demo.com'
)
AND b.id_billetera IS NULL;

-- ===========================================================
-- 2) Más productos / servicios / publicaciones
-- ===========================================================

-- Productos Bicicletas (venden Marta y eco1)
INSERT INTO PRODUCTO (id_categoria, nombre, descripcion, precio, peso)
SELECT
  (SELECT id_categoria FROM CATEGORIA WHERE nombre='Bicicletas'),
  'Bici Urbana Eco',
  'Bicicleta urbana reacondicionada con cuadro de aluminio.',
  1500.00,
  14.2;

INSERT INTO PRODUCTO (id_categoria, nombre, descripcion, precio, peso)
SELECT
  (SELECT id_categoria FROM CATEGORIA WHERE nombre='Bicicletas'),
  'Bici Plegable Ciudad',
  'Bicicleta plegable ideal para transporte multimodal.',
  1300.00,
  13.0;

-- Productos Tecnología (vende eco2)
INSERT INTO PRODUCTO (id_categoria, nombre, descripcion, precio, peso)
SELECT
  (SELECT id_categoria FROM CATEGORIA WHERE nombre='Tecnología'),
  'Laptop Reacondicionada i5',
  'Laptop reacondicionada con SSD de 256GB y 8GB RAM.',
  2200.00,
  2.1;

INSERT INTO PRODUCTO (id_categoria, nombre, descripcion, precio, peso)
SELECT
  (SELECT id_categoria FROM CATEGORIA WHERE nombre='Tecnología'),
  'Monitor 24 Reciclado',
  'Monitor de 24" reacondicionado, ideal oficina.',
  900.00,
  3.2;

-- Publicaciones de esos productos
INSERT INTO PUBLICACION
  (id_usuario, id_categoria, id_tipo_publicacion, estado, id_ubicacion,
   titulo, descripcion, valor_creditos, imagen_url)
SELECT
  (SELECT id_usuario FROM USUARIO WHERE correo='marta@demo.com'),
  (SELECT id_categoria FROM CATEGORIA WHERE nombre='Bicicletas'),
  (SELECT id_tipo_publicacion FROM TIPO_PUBLICACION WHERE nombre='PRODUCTO'),
  'PUBLICADA',
  (SELECT id_ubicacion FROM UBICACION WHERE ciudad='Cochabamba'),
  'Bici Urbana Eco',
  'Reacondicionada, frenos en V, lista para uso diario.',
  320,
  'https://img/bici_urbana_eco.jpg';

INSERT INTO PUBLICACION_PRODUCTO
SELECT
  (SELECT id_publicacion FROM PUBLICACION WHERE titulo='Bici Urbana Eco' LIMIT 1),
  (SELECT id_producto   FROM PRODUCTO   WHERE nombre='Bici Urbana Eco' LIMIT 1),
  1.0000,
  (SELECT id_um FROM UNIDAD_MEDIDA WHERE simbolo='u');

INSERT INTO PUBLICACION
  (id_usuario, id_categoria, id_tipo_publicacion, estado, id_ubicacion,
   titulo, descripcion, valor_creditos, imagen_url)
SELECT
  (SELECT id_usuario FROM USUARIO WHERE correo='eco1@demo.com'),
  (SELECT id_categoria FROM CATEGORIA WHERE nombre='Bicicletas'),
  (SELECT id_tipo_publicacion FROM TIPO_PUBLICACION WHERE nombre='PRODUCTO'),
  'PUBLICADA',
  (SELECT id_ubicacion FROM UBICACION WHERE ciudad='La Paz'),
  'Bici Plegable Ciudad',
  'Fácil de transportar, incluye canastillo frontal.',
  280,
  'https://img/bici_plegable.jpg';

INSERT INTO PUBLICACION_PRODUCTO
SELECT
  (SELECT id_publicacion FROM PUBLICACION WHERE titulo='Bici Plegable Ciudad' LIMIT 1),
  (SELECT id_producto   FROM PRODUCTO   WHERE nombre='Bici Plegable Ciudad' LIMIT 1),
  1.0000,
  (SELECT id_um FROM UNIDAD_MEDIDA WHERE simbolo='u');

-- Publicaciones Tecnología (eco2)
INSERT INTO PUBLICACION
  (id_usuario, id_categoria, id_tipo_publicacion, estado, id_ubicacion,
   titulo, descripcion, valor_creditos, imagen_url)
SELECT
  (SELECT id_usuario FROM USUARIO WHERE correo='eco2@demo.com'),
  (SELECT id_categoria FROM CATEGORIA WHERE nombre='Tecnología'),
  (SELECT id_tipo_publicacion FROM TIPO_PUBLICACION WHERE nombre='PRODUCTO'),
  'PUBLICADA',
  (SELECT id_ubicacion FROM UBICACION WHERE ciudad='Santa Cruz'),
  'Laptop Reacondicionada i5',
  'Ideal para teletrabajo y estudio.',
  350,
  'https://img/laptop_reuse.jpg';

INSERT INTO PUBLICACION_PRODUCTO
SELECT
  (SELECT id_publicacion FROM PUBLICACION WHERE titulo='Laptop Reacondicionada i5' LIMIT 1),
  (SELECT id_producto   FROM PRODUCTO   WHERE nombre='Laptop Reacondicionada i5' LIMIT 1),
  1.0000,
  (SELECT id_um FROM UNIDAD_MEDIDA WHERE simbolo='u');

INSERT INTO PUBLICACION
  (id_usuario, id_categoria, id_tipo_publicacion, estado, id_ubicacion,
   titulo, descripcion, valor_creditos, imagen_url)
SELECT
  (SELECT id_usuario FROM USUARIO WHERE correo='eco2@demo.com'),
  (SELECT id_categoria FROM CATEGORIA WHERE nombre='Tecnología'),
  (SELECT id_tipo_publicacion FROM TIPO_PUBLICACION WHERE nombre='PRODUCTO'),
  'PUBLICADA',
  (SELECT id_ubicacion FROM UBICACION WHERE ciudad='Cochabamba'),
  'Monitor 24 Reciclado',
  'Pantalla 24" reacondicionada, 75Hz, entrada HDMI.',
  220,
  'https://img/monitor_reciclado.jpg';

INSERT INTO PUBLICACION_PRODUCTO
SELECT
  (SELECT id_publicacion FROM PUBLICACION WHERE titulo='Monitor 24 Reciclado' LIMIT 1),
  (SELECT id_producto   FROM PRODUCTO   WHERE nombre='Monitor 24 Reciclado' LIMIT 1),
  1.0000,
  (SELECT id_um FROM UNIDAD_MEDIDA WHERE simbolo='u');

-- Servicios de tecnología adicionales (los vende Marta)
INSERT INTO SERVICIO (id_categoria, estado, nombre, descripcion, precio, duracion_min)
SELECT
  (SELECT id_categoria FROM CATEGORIA WHERE nombre='Tecnología'),
  'ACTIVO',
  'Mantenimiento laptop básico',
  'Limpieza interna y cambio de pasta térmica.',
  100.00,
  60;

INSERT INTO PUBLICACION
  (id_usuario, id_categoria, id_tipo_publicacion, estado, id_ubicacion,
   titulo, descripcion, valor_creditos, imagen_url)
SELECT
  (SELECT id_usuario FROM USUARIO WHERE correo='marta@demo.com'),
  (SELECT id_categoria FROM CATEGORIA WHERE nombre='Tecnología'),
  (SELECT id_tipo_publicacion FROM TIPO_PUBLICACION WHERE nombre='SERVICIO'),
  'PUBLICADA',
  (SELECT id_ubicacion FROM UBICACION WHERE ciudad='Cochabamba'),
  'Mantenimiento laptop básico',
  'Incluye limpieza general y revisión de temperatura.',
  110,
  'https://img/serv_mant_laptop.jpg';

INSERT INTO PUBLICACION_SERVICIO
SELECT
  (SELECT id_publicacion FROM PUBLICACION WHERE titulo='Mantenimiento laptop básico' LIMIT 1),
  (SELECT id_servicio   FROM SERVICIO   WHERE nombre='Mantenimiento laptop básico' LIMIT 1),
  'L-S 09:00-12:00';

-- ===========================================================
-- 3) Compras de créditos masivas (≈ 20 operaciones)
--    Cada usuario compra varios paquetes
-- ===========================================================

-- Usuarios que van a comprar créditos
SET @compradores := 'ana@demo.com,carla@demo.com,diego@demo.com,bruno@demo.com,elena@demo.com,fernando@demo.com,gaby@demo.com,hugo@demo.com,irene@demo.com,jorge@demo.com';

-- Ana (2 recargas)
CALL sp_compra_creditos_aprobar(
  (SELECT id_usuario FROM USUARIO WHERE correo='ana@demo.com'),
  (SELECT id_paquete FROM PAQUETE_CREDITOS WHERE nombre='Pack 500'),
  'PAY-ANA-002'
);
CALL sp_compra_creditos_aprobar(
  (SELECT id_usuario FROM USUARIO WHERE correo='ana@demo.com'),
  (SELECT id_paquete FROM PAQUETE_CREDITOS WHERE nombre='Pack 100'),
  'PAY-ANA-003'
);

-- Carla
CALL sp_compra_creditos_aprobar(
  (SELECT id_usuario FROM USUARIO WHERE correo='carla@demo.com'),
  (SELECT id_paquete FROM PAQUETE_CREDITOS WHERE nombre='Pack 500'),
  'PAY-CARLA-002'
);
CALL sp_compra_creditos_aprobar(
  (SELECT id_usuario FROM USUARIO WHERE correo='carla@demo.com'),
  (SELECT id_paquete FROM PAQUETE_CREDITOS WHERE nombre='Pack 100'),
  'PAY-CARLA-003'
);

-- Diego
CALL sp_compra_creditos_aprobar(
  (SELECT id_usuario FROM USUARIO WHERE correo='diego@demo.com'),
  (SELECT id_paquete FROM PAQUETE_CREDITOS WHERE nombre='Pack 500'),
  'PAY-DIEGO-002'
);
CALL sp_compra_creditos_aprobar(
  (SELECT id_usuario FROM USUARIO WHERE correo='diego@demo.com'),
  (SELECT id_paquete FROM PAQUETE_CREDITOS WHERE nombre='Pack 100'),
  'PAY-DIEGO-003'
);

-- Bruno
CALL sp_compra_creditos_aprobar(
  (SELECT id_usuario FROM USUARIO WHERE correo='bruno@demo.com'),
  (SELECT id_paquete FROM PAQUETE_CREDITOS WHERE nombre='Pack 500'),
  'PAY-BRUNO-001'
);
CALL sp_compra_creditos_aprobar(
  (SELECT id_usuario FROM USUARIO WHERE correo='bruno@demo.com'),
  (SELECT id_paquete FROM PAQUETE_CREDITOS WHERE nombre='Pack 100'),
  'PAY-BRUNO-002'
);

-- Elena
CALL sp_compra_creditos_aprobar(
  (SELECT id_usuario FROM USUARIO WHERE correo='elena@demo.com'),
  (SELECT id_paquete FROM PAQUETE_CREDITOS WHERE nombre='Pack 500'),
  'PAY-ELENA-001'
);
CALL sp_compra_creditos_aprobar(
  (SELECT id_usuario FROM USUARIO WHERE correo='elena@demo.com'),
  (SELECT id_paquete FROM PAQUETE_CREDITOS WHERE nombre='Pack 100'),
  'PAY-ELENA-002'
);

-- Fernando
CALL sp_compra_creditos_aprobar(
  (SELECT id_usuario FROM USUARIO WHERE correo='fernando@demo.com'),
  (SELECT id_paquete FROM PAQUETE_CREDITOS WHERE nombre='Pack 500'),
  'PAY-FERNANDO-001'
);
CALL sp_compra_creditos_aprobar(
  (SELECT id_usuario FROM USUARIO WHERE correo='fernando@demo.com'),
  (SELECT id_paquete FROM PAQUETE_CREDITOS WHERE nombre='Pack 100'),
  'PAY-FERNANDO-002'
);

-- Gaby
CALL sp_compra_creditos_aprobar(
  (SELECT id_usuario FROM USUARIO WHERE correo='gaby@demo.com'),
  (SELECT id_paquete FROM PAQUETE_CREDITOS WHERE nombre='Pack 500'),
  'PAY-GABY-001'
);

-- Hugo
CALL sp_compra_creditos_aprobar(
  (SELECT id_usuario FROM USUARIO WHERE correo='hugo@demo.com'),
  (SELECT id_paquete FROM PAQUETE_CREDITOS WHERE nombre='Pack 500'),
  'PAY-HUGO-001'
);

-- Irene
CALL sp_compra_creditos_aprobar(
  (SELECT id_usuario FROM USUARIO WHERE correo='irene@demo.com'),
  (SELECT id_paquete FROM PAQUETE_CREDITOS WHERE nombre='Pack 500'),
  'PAY-IRENE-001'
);

-- Jorge
CALL sp_compra_creditos_aprobar(
  (SELECT id_usuario FROM USUARIO WHERE correo='jorge@demo.com'),
  (SELECT id_paquete FROM PAQUETE_CREDITOS WHERE nombre='Pack 500'),
  'PAY-JORGE-001'
);

-- ===========================================================
-- 4) Intercambios masivos (≈ 20 operaciones)
--    Cada comprador adquiere productos/servicios distintos
-- ===========================================================

-- Función auxiliar mental:
-- Bici Urbana Eco        -> 320 créditos
-- Bici Plegable Ciudad   -> 280 créditos
-- Laptop Reacondicionada -> 350 créditos
-- Monitor 24 Reciclado   -> 220 créditos
-- Mantenimiento laptop   -> 110 créditos
-- Mantenimiento y limpieza de PC (seed original) -> 120 créditos
-- Bicicleta montaña Pro  -> 450 créditos

-- 4.1 Ana compra Bici Urbana Eco y servicio de mantenimiento
CALL sp_realizar_intercambio(
  (SELECT id_usuario FROM USUARIO WHERE correo='ana@demo.com'),
  (SELECT id_publicacion FROM PUBLICACION WHERE titulo='Bici Urbana Eco' LIMIT 1),
  320
);
SET @id_tx = (SELECT MAX(id_transaccion) FROM TRANSACCION);
UPDATE TRANSACCION SET estado='COMPLETADA' WHERE id_transaccion=@id_tx;

CALL sp_realizar_intercambio(
  (SELECT id_usuario FROM USUARIO WHERE correo='ana@demo.com'),
  (SELECT id_publicacion FROM PUBLICACION WHERE titulo='Mantenimiento laptop básico' LIMIT 1),
  110
);
SET @id_tx = (SELECT MAX(id_transaccion) FROM TRANSACCION);
UPDATE TRANSACCION SET estado='COMPLETADA' WHERE id_transaccion=@id_tx;

-- 4.2 Carla compra servicio "Mantenimiento y limpieza de PC" y Monitor
CALL sp_realizar_intercambio(
  (SELECT id_usuario FROM USUARIO WHERE correo='carla@demo.com'),
  (SELECT id_publicacion FROM PUBLICACION WHERE titulo='Mantenimiento y limpieza de PC' LIMIT 1),
  120
);
SET @id_tx = (SELECT MAX(id_transaccion) FROM TRANSACCION);
UPDATE TRANSACCION SET estado='COMPLETADA' WHERE id_transaccion=@id_tx;

CALL sp_realizar_intercambio(
  (SELECT id_usuario FROM USUARIO WHERE correo='carla@demo.com'),
  (SELECT id_publicacion FROM PUBLICACION WHERE titulo='Monitor 24 Reciclado' LIMIT 1),
  220
);
SET @id_tx = (SELECT MAX(id_transaccion) FROM TRANSACCION);
UPDATE TRANSACCION SET estado='COMPLETADA' WHERE id_transaccion=@id_tx;

-- 4.3 Diego compra Bici Plegable Ciudad
CALL sp_realizar_intercambio(
  (SELECT id_usuario FROM USUARIO WHERE correo='diego@demo.com'),
  (SELECT id_publicacion FROM PUBLICACION WHERE titulo='Bici Plegable Ciudad' LIMIT 1),
  280
);
SET @id_tx = (SELECT MAX(id_transaccion) FROM TRANSACCION);
UPDATE TRANSACCION SET estado='COMPLETADA' WHERE id_transaccion=@id_tx;

-- 4.4 Bruno compra Laptop Reacondicionada y servicio de mantenimiento
CALL sp_realizar_intercambio(
  (SELECT id_usuario FROM USUARIO WHERE correo='bruno@demo.com'),
  (SELECT id_publicacion FROM PUBLICACION WHERE titulo='Laptop Reacondicionada i5' LIMIT 1),
  350
);
SET @id_tx = (SELECT MAX(id_transaccion) FROM TRANSACCION);
UPDATE TRANSACCION SET estado='COMPLETADA' WHERE id_transaccion=@id_tx;

CALL sp_realizar_intercambio(
  (SELECT id_usuario FROM USUARIO WHERE correo='bruno@demo.com'),
  (SELECT id_publicacion FROM PUBLICACION WHERE titulo='Mantenimiento laptop básico' LIMIT 1),
  110
);
SET @id_tx = (SELECT MAX(id_transaccion) FROM TRANSACCION);
UPDATE TRANSACCION SET estado='COMPLETADA' WHERE id_transaccion=@id_tx;

-- 4.5 Elena compra Monitor y servicio
CALL sp_realizar_intercambio(
  (SELECT id_usuario FROM USUARIO WHERE correo='elena@demo.com'),
  (SELECT id_publicacion FROM PUBLICACION WHERE titulo='Monitor 24 Reciclado' LIMIT 1),
  220
);
SET @id_tx = (SELECT MAX(id_transaccion) FROM TRANSACCION);
UPDATE TRANSACCION SET estado='COMPLETADA' WHERE id_transaccion=@id_tx;

CALL sp_realizar_intercambio(
  (SELECT id_usuario FROM USUARIO WHERE correo='elena@demo.com'),
  (SELECT id_publicacion FROM PUBLICACION WHERE titulo='Formateo e instalación de Windows' LIMIT 1),
  90
);
SET @id_tx = (SELECT MAX(id_transaccion) FROM TRANSACCION);
UPDATE TRANSACCION SET estado='COMPLETADA' WHERE id_transaccion=@id_tx;

-- 4.6 Fernando compra Bici Urbana Eco
CALL sp_realizar_intercambio(
  (SELECT id_usuario FROM USUARIO WHERE correo='fernando@demo.com'),
  (SELECT id_publicacion FROM PUBLICACION WHERE titulo='Bici Urbana Eco' LIMIT 1),
  320
);
SET @id_tx = (SELECT MAX(id_transaccion) FROM TRANSACCION);
UPDATE TRANSACCION SET estado='COMPLETADA' WHERE id_transaccion=@id_tx;

-- 4.7 Gaby compra servicio "Formateo e instalación de Windows"
CALL sp_realizar_intercambio(
  (SELECT id_usuario FROM USUARIO WHERE correo='gaby@demo.com'),
  (SELECT id_publicacion FROM PUBLICACION WHERE titulo='Formateo e instalación de Windows' LIMIT 1),
  90
);
SET @id_tx = (SELECT MAX(id_transaccion) FROM TRANSACCION);
UPDATE TRANSACCION SET estado='COMPLETADA' WHERE id_transaccion=@id_tx;

-- 4.8 Hugo compra "Mantenimiento y limpieza de PC"
CALL sp_realizar_intercambio(
  (SELECT id_usuario FROM USUARIO WHERE correo='hugo@demo.com'),
  (SELECT id_publicacion FROM PUBLICACION WHERE titulo='Mantenimiento y limpieza de PC' LIMIT 1),
  120
);
SET @id_tx = (SELECT MAX(id_transaccion) FROM TRANSACCION);
UPDATE TRANSACCION SET estado='COMPLETADA' WHERE id_transaccion=@id_tx;

-- 4.9 Irene compra "Bicicleta montaña Pro"
CALL sp_realizar_intercambio(
  (SELECT id_usuario FROM USUARIO WHERE correo='irene@demo.com'),
  (SELECT id_publicacion FROM PUBLICACION WHERE titulo='Bicicleta montaña Pro' LIMIT 1),
  450
);
SET @id_tx = (SELECT MAX(id_transaccion) FROM TRANSACCION);
UPDATE TRANSACCION SET estado='COMPLETADA' WHERE id_transaccion=@id_tx;

-- 4.10 Jorge compra "Bici Plegable Ciudad"
CALL sp_realizar_intercambio(
  (SELECT id_usuario FROM USUARIO WHERE correo='jorge@demo.com'),
  (SELECT id_publicacion FROM PUBLICACION WHERE titulo='Bici Plegable Ciudad' LIMIT 1),
  280
);
SET @id_tx = (SELECT MAX(id_transaccion) FROM TRANSACCION);
UPDATE TRANSACCION SET estado='COMPLETADA' WHERE id_transaccion=@id_tx;

-- ===========================================================
-- 5) Actividades sostenibles masivas (≈ 10 operaciones)
-- ===========================================================

CALL sp_registrar_actividad_sostenible(
  (SELECT id_usuario FROM USUARIO WHERE correo='ana@demo.com'),
  (SELECT id_tipo_actividad FROM TIPO_ACTIVIDAD WHERE nombre='RECICLAJE'),
  'Entregó 4kg de papel para reciclaje', 12,
  'https://evidencias/reciclaje_ana.jpg'
);

CALL sp_registrar_actividad_sostenible(
  (SELECT id_usuario FROM USUARIO WHERE correo='bruno@demo.com'),
  (SELECT id_tipo_actividad FROM TIPO_ACTIVIDAD WHERE nombre='RECICLAJE'),
  'Entregó 6kg de plástico para reciclaje', 18,
  'https://evidencias/reciclaje_bruno.jpg'
);

CALL sp_registrar_actividad_sostenible(
  (SELECT id_usuario FROM USUARIO WHERE correo='elena@demo.com'),
  (SELECT id_tipo_actividad FROM TIPO_ACTIVIDAD WHERE nombre='RECICLAJE'),
  'Entregó 10kg de cartón', 25,
  'https://evidencias/reciclaje_elena.jpg'
);

CALL sp_registrar_actividad_sostenible(
  (SELECT id_usuario FROM USUARIO WHERE correo='fernando@demo.com'),
  (SELECT id_tipo_actividad FROM TIPO_ACTIVIDAD WHERE nombre='RECICLAJE'),
  'Donó componentes electrónicos para reciclaje', 20,
  'https://evidencias/reciclaje_fernando.jpg'
);

CALL sp_registrar_actividad_sostenible(
  (SELECT id_usuario FROM USUARIO WHERE correo='gaby@demo.com'),
  (SELECT id_tipo_actividad FROM TIPO_ACTIVIDAD WHERE nombre='RECICLAJE'),
  'Recogió residuos en su barrio', 15,
  'https://evidencias/reciclaje_gaby.jpg'
);

CALL sp_registrar_actividad_sostenible(
  (SELECT id_usuario FROM USUARIO WHERE correo='hugo@demo.com'),
  (SELECT id_tipo_actividad FROM TIPO_ACTIVIDAD WHERE nombre='RECICLAJE'),
  'Separó vidrio y plástico en su hogar', 10,
  'https://evidencias/reciclaje_hugo.jpg'
);

CALL sp_registrar_actividad_sostenible(
  (SELECT id_usuario FROM USUARIO WHERE correo='irene@demo.com'),
  (SELECT id_tipo_actividad FROM TIPO_ACTIVIDAD WHERE nombre='RECICLAJE'),
  'Participó en campaña de recolección de e-waste', 22,
  'https://evidencias/reciclaje_irene.jpg'
);

CALL sp_registrar_actividad_sostenible(
  (SELECT id_usuario FROM USUARIO WHERE correo='jorge@demo.com'),
  (SELECT id_tipo_actividad FROM TIPO_ACTIVIDAD WHERE nombre='RECICLAJE'),
  'Entregó pilas usadas para disposición adecuada', 8,
  'https://evidencias/reciclaje_jorge.jpg'
);


/*Desde de aqui ya se implementaron pruebas grandes*/
INSERT IGNORE INTO EQUIVALENCIA_IMPACTO (id_categoria, id_um, co2_por_unidad, agua_por_unidad, energia_por_unidad)
SELECT
  (SELECT id_categoria FROM CATEGORIA WHERE nombre = 'Tecnología' LIMIT 1),
  (SELECT id_um FROM UNIDAD_MEDIDA WHERE simbolo = 'u' LIMIT 1),
  8.000000,
  30.000000,
  3.500000;

/* ===========================================================
   1) Nuevos USUARIOS (≈ 24 compradores + 8 vendedores)
   =========================================================== */

-- 1.1 Compradores NUEVOS
INSERT INTO USUARIO (id_rol, estado, nombre, apellido, correo, telefono, url_perfil)
VALUES
  ((SELECT id_rol FROM ROL WHERE nombre='COMPRADOR'),'ACTIVO','Camila','Rios','camila@demo.com','71000001','/p/camila'),
  ((SELECT id_rol FROM ROL WHERE nombre='COMPRADOR'),'ACTIVO','Daniel','Torres','daniel@demo.com','71000002','/p/daniel'),
  ((SELECT id_rol FROM ROL WHERE nombre='COMPRADOR'),'ACTIVO','Sofia','Mendez','sofia@demo.com','71000003','/p/sofia'),
  ((SELECT id_rol FROM ROL WHERE nombre='COMPRADOR'),'ACTIVO','Pablo','Lima','pablo@demo.com','71000004','/p/pablo'),
  ((SELECT id_rol FROM ROL WHERE nombre='COMPRADOR'),'ACTIVO','Laura','Guzman','laura@demo.com','71000005','/p/laura'),
  ((SELECT id_rol FROM ROL WHERE nombre='COMPRADOR'),'ACTIVO','Andres','Zeballos','andres@demo.com','71000006','/p/andres'),
  ((SELECT id_rol FROM ROL WHERE nombre='COMPRADOR'),'ACTIVO','Valeria','Nuñez','valeria@demo.com','71000007','/p/valeria'),
  ((SELECT id_rol FROM ROL WHERE nombre='COMPRADOR'),'ACTIVO','Roberto','Aguilar','roberto@demo.com','71000008','/p/roberto'),
  ((SELECT id_rol FROM ROL WHERE nombre='COMPRADOR'),'ACTIVO','Natalia','Cruz','natalia@demo.com','71000009','/p/natalia'),
  ((SELECT id_rol FROM ROL WHERE nombre='COMPRADOR'),'ACTIVO','Sergio','Rojas','sergio@demo.com','71000010','/p/sergio'),
  ((SELECT id_rol FROM ROL WHERE nombre='COMPRADOR'),'ACTIVO','Patricia','Salas','patricia@demo.com','71000011','/p/patricia'),
  ((SELECT id_rol FROM ROL WHERE nombre='COMPRADOR'),'ACTIVO','Marcos','Quiroga','marcos@demo.com','71000012','/p/marcos'),
  ((SELECT id_rol FROM ROL WHERE nombre='COMPRADOR'),'ACTIVO','Lucia','Delgado','lucia@demo.com','71000013','/p/lucia'),
  ((SELECT id_rol FROM ROL WHERE nombre='COMPRADOR'),'ACTIVO','Ricardo','Vega','ricardo@demo.com','71000014','/p/ricardo'),
  ((SELECT id_rol FROM ROL WHERE nombre='COMPRADOR'),'ACTIVO','Melissa','Campos','melissa@demo.com','71000015','/p/melissa'),
  ((SELECT id_rol FROM ROL WHERE nombre='COMPRADOR'),'ACTIVO','Tomas','Herrera','tomas@demo.com','71000016','/p/tomas'),
  ((SELECT id_rol FROM ROL WHERE nombre='COMPRADOR'),'ACTIVO','Cecilia','Paredes','cecilia@demo.com','71000017','/p/cecilia'),
  ((SELECT id_rol FROM ROL WHERE nombre='COMPRADOR'),'ACTIVO','German','Lara','german@demo.com','71000018','/p/german'),
  ((SELECT id_rol FROM ROL WHERE nombre='COMPRADOR'),'ACTIVO','Roxana','Villaroel','roxana@demo.com','71000019','/p/roxana'),
  ((SELECT id_rol FROM ROL WHERE nombre='COMPRADOR'),'ACTIVO','Kevin','Lopez','kevin@demo.com','71000020','/p/kevin'),
  ((SELECT id_rol FROM ROL WHERE nombre='COMPRADOR'),'ACTIVO','Mauro','Ibañez','mauro@demo.com','71000021','/p/mauro'),
  ((SELECT id_rol FROM ROL WHERE nombre='COMPRADOR'),'ACTIVO','Dana','Gomez','dana@demo.com','71000022','/p/dana'),
  ((SELECT id_rol FROM ROL WHERE nombre='COMPRADOR'),'ACTIVO','Helena','Ramos','helena@demo.com','71000023','/p/helena'),
  ((SELECT id_rol FROM ROL WHERE nombre='COMPRADOR'),'ACTIVO','Oscar','Medina','oscar@demo.com','71000024','/p/oscar');

-- 1.2 Vendedores NUEVOS
INSERT INTO USUARIO (id_rol, estado, nombre, apellido, correo, telefono, url_perfil)
VALUES
  ((SELECT id_rol FROM ROL WHERE nombre='VENDEDOR'),'ACTIVO','Green','Store','greenstore@demo.com','72000001','/p/greenstore'),
  ((SELECT id_rol FROM ROL WHERE nombre='VENDEDOR'),'ACTIVO','Bici','Plus','biciplus@demo.com','72000002','/p/biciplus'),
  ((SELECT id_rol FROM ROL WHERE nombre='VENDEDOR'),'ACTIVO','EcoTech','Solutions','ecotech@demo.com','72000003','/p/ecotech'),
  ((SELECT id_rol FROM ROL WHERE nombre='VENDEDOR'),'ACTIVO','Zero','Waste','zerowaste@demo.com','72000004','/p/zerowaste'),
  ((SELECT id_rol FROM ROL WHERE nombre='VENDEDOR'),'ACTIVO','Repara','PC','reparapc@demo.com','72000005','/p/reparapc'),
  ((SELECT id_rol FROM ROL WHERE nombre='VENDEDOR'),'ACTIVO','Recicla','YA','reciclaya@demo.com','72000006','/p/reciclaya'),
  ((SELECT id_rol FROM ROL WHERE nombre='VENDEDOR'),'ACTIVO','Eco','Market3','ecomarket3@demo.com','72000007','/p/ecomarket3'),
  ((SELECT id_rol FROM ROL WHERE nombre='VENDEDOR'),'ACTIVO','Tech','Refurb','techrefurb@demo.com','72000008','/p/techrefurb');

-- 1.3 Crear BILLETERA para todos los nuevos (si no tienen)
INSERT INTO BILLETERA (id_usuario, estado, saldo_creditos, saldo_bs, cuenta_bancaria)
SELECT u.id_usuario, 'ACTIVA', 0, 0.00, NULL
FROM USUARIO u
LEFT JOIN BILLETERA b ON b.id_usuario = u.id_usuario
WHERE u.correo IN (
  'camila@demo.com','daniel@demo.com','sofia@demo.com','pablo@demo.com',
  'laura@demo.com','andres@demo.com','valeria@demo.com','roberto@demo.com',
  'natalia@demo.com','sergio@demo.com','patricia@demo.com','marcos@demo.com',
  'lucia@demo.com','ricardo@demo.com','melissa@demo.com','tomas@demo.com',
  'cecilia@demo.com','german@demo.com','roxana@demo.com','kevin@demo.com',
  'mauro@demo.com','dana@demo.com','helena@demo.com','oscar@demo.com',
  'greenstore@demo.com','biciplus@demo.com','ecotech@demo.com',
  'zerowaste@demo.com','reparapc@demo.com','reciclaya@demo.com',
  'ecomarket3@demo.com','techrefurb@demo.com'
)
AND b.id_billetera IS NULL;

/* ===========================================================
   2) Productos / servicios extra para nuevos vendedores
   (reutilizan categorías Bicicletas y Tecnología)
   =========================================================== */

-- 2.1 Productos de BiciPlus
INSERT INTO PRODUCTO (id_categoria, nombre, descripcion, precio, peso)
SELECT
  (SELECT id_categoria FROM CATEGORIA WHERE nombre='Bicicletas'),
  'Bici Urbana Basic',
  'Bicicleta urbana básica reacondicionada.',
  1100.00,
  14.0;

INSERT INTO PUBLICACION
  (id_usuario, id_categoria, id_tipo_publicacion, estado, id_ubicacion,
   titulo, descripcion, valor_creditos, imagen_url)
SELECT
  (SELECT id_usuario FROM USUARIO WHERE correo='biciplus@demo.com'),
  (SELECT id_categoria FROM CATEGORIA WHERE nombre='Bicicletas'),
  (SELECT id_tipo_publicacion FROM TIPO_PUBLICACION WHERE nombre='PRODUCTO'),
  'PUBLICADA',
  (SELECT id_ubicacion FROM UBICACION WHERE ciudad='Cochabamba'),
  'Bici Urbana Basic',
  'Ideal para uso diario en ciudad.',
  250,
  'https://img/bici_basic.jpg';

INSERT INTO PUBLICACION_PRODUCTO
SELECT
  (SELECT id_publicacion FROM PUBLICACION WHERE titulo='Bici Urbana Basic' LIMIT 1),
  (SELECT id_producto   FROM PRODUCTO   WHERE nombre='Bici Urbana Basic' LIMIT 1),
  1.0000,
  (SELECT id_um FROM UNIDAD_MEDIDA WHERE simbolo='u');

-- 2.2 Productos de GreenStore (Tecnología)
INSERT INTO PRODUCTO (id_categoria, nombre, descripcion, precio, peso)
SELECT
  (SELECT id_categoria FROM CATEGORIA WHERE nombre='Tecnología'),
  'PC Oficina Reacondicionada',
  'CPU compacta para oficina, 8GB RAM, SSD 240GB.',
  1800.00,
  5.5;

INSERT INTO PUBLICACION
  (id_usuario, id_categoria, id_tipo_publicacion, estado, id_ubicacion,
   titulo, descripcion, valor_creditos, imagen_url)
SELECT
  (SELECT id_usuario FROM USUARIO WHERE correo='greenstore@demo.com'),
  (SELECT id_categoria FROM CATEGORIA WHERE nombre='Tecnología'),
  (SELECT id_tipo_publicacion FROM TIPO_PUBLICACION WHERE nombre='PRODUCTO'),
  'PUBLICADA',
  (SELECT id_ubicacion FROM UBICACION WHERE ciudad='La Paz'),
  'PC Oficina Reacondicionada',
  'Equipo compacto, ideal para ofimática.',
  300,
  'https://img/pc_oficina.jpg';

INSERT INTO PUBLICACION_PRODUCTO
SELECT
  (SELECT id_publicacion FROM PUBLICACION WHERE titulo='PC Oficina Reacondicionada' LIMIT 1),
  (SELECT id_producto   FROM PRODUCTO   WHERE nombre='PC Oficina Reacondicionada' LIMIT 1),
  1.0000,
  (SELECT id_um FROM UNIDAD_MEDIDA WHERE simbolo='u');

-- 2.3 Servicios de ReparaPC
INSERT INTO SERVICIO (id_categoria, estado, nombre, descripcion, precio, duracion_min)
SELECT
  (SELECT id_categoria FROM CATEGORIA WHERE nombre='Tecnología'),
  'ACTIVO',
  'Reparación avanzada de PC',
  'Diagnóstico y reparación de fallas de hardware.',
  150.00,
  90;

INSERT INTO PUBLICACION
  (id_usuario, id_categoria, id_tipo_publicacion, estado, id_ubicacion,
   titulo, descripcion, valor_creditos, imagen_url)
SELECT
  (SELECT id_usuario FROM USUARIO WHERE correo='reparapc@demo.com'),
  (SELECT id_categoria FROM CATEGORIA WHERE nombre='Tecnología'),
  (SELECT id_tipo_publicacion FROM TIPO_PUBLICACION WHERE nombre='SERVICIO'),
  'PUBLICADA',
  (SELECT id_ubicacion FROM UBICACION WHERE ciudad='Santa Cruz'),
  'Reparación avanzada de PC',
  'Incluye cambio de piezas y pruebas de estabilidad.',
  140,
  'https://img/serv_reparacion_pc.jpg';

INSERT INTO PUBLICACION_SERVICIO
SELECT
  (SELECT id_publicacion FROM PUBLICACION WHERE titulo='Reparación avanzada de PC' LIMIT 1),
  (SELECT id_servicio   FROM SERVICIO   WHERE nombre='Reparación avanzada de PC' LIMIT 1),
  'L-S 15:00-19:00';

/* ===========================================================
   3) Compras de créditos extra (cada nuevo comprador recarga)
   =========================================================== */

-- Todos compran al menos un Pack 500
CALL sp_compra_creditos_aprobar(
  (SELECT id_usuario FROM USUARIO WHERE correo='camila@demo.com'),
  (SELECT id_paquete FROM PAQUETE_CREDITOS WHERE nombre='Pack 500'),
  'PAY-CAMILA-001'
);
CALL sp_compra_creditos_aprobar(
  (SELECT id_usuario FROM USUARIO WHERE correo='daniel@demo.com'),
  (SELECT id_paquete FROM PAQUETE_CREDITOS WHERE nombre='Pack 500'),
  'PAY-DANIEL-001'
);
CALL sp_compra_creditos_aprobar(
  (SELECT id_usuario FROM USUARIO WHERE correo='sofia@demo.com'),
  (SELECT id_paquete FROM PAQUETE_CREDITOS WHERE nombre='Pack 500'),
  'PAY-SOFIA-001'
);
CALL sp_compra_creditos_aprobar(
  (SELECT id_usuario FROM USUARIO WHERE correo='pablo@demo.com'),
  (SELECT id_paquete FROM PAQUETE_CREDITOS WHERE nombre='Pack 500'),
  'PAY-PABLO-001'
);
CALL sp_compra_creditos_aprobar(
  (SELECT id_usuario FROM USUARIO WHERE correo='laura@demo.com'),
  (SELECT id_paquete FROM PAQUETE_CREDITOS WHERE nombre='Pack 500'),
  'PAY-LAURA-001'
);
CALL sp_compra_creditos_aprobar(
  (SELECT id_usuario FROM USUARIO WHERE correo='andres@demo.com'),
  (SELECT id_paquete FROM PAQUETE_CREDITOS WHERE nombre='Pack 500'),
  'PAY-ANDRES-001'
);
CALL sp_compra_creditos_aprobar(
  (SELECT id_usuario FROM USUARIO WHERE correo='valeria@demo.com'),
  (SELECT id_paquete FROM PAQUETE_CREDITOS WHERE nombre='Pack 500'),
  'PAY-VALERIA-001'
);
CALL sp_compra_creditos_aprobar(
  (SELECT id_usuario FROM USUARIO WHERE correo='roberto@demo.com'),
  (SELECT id_paquete FROM PAQUETE_CREDITOS WHERE nombre='Pack 500'),
  'PAY-ROBERTO-001'
);
CALL sp_compra_creditos_aprobar(
  (SELECT id_usuario FROM USUARIO WHERE correo='natalia@demo.com'),
  (SELECT id_paquete FROM PAQUETE_CREDITOS WHERE nombre='Pack 500'),
  'PAY-NATALIA-001'
);
CALL sp_compra_creditos_aprobar(
  (SELECT id_usuario FROM USUARIO WHERE correo='sergio@demo.com'),
  (SELECT id_paquete FROM PAQUETE_CREDITOS WHERE nombre='Pack 500'),
  'PAY-SERGIO-001'
);
CALL sp_compra_creditos_aprobar(
  (SELECT id_usuario FROM USUARIO WHERE correo='patricia@demo.com'),
  (SELECT id_paquete FROM PAQUETE_CREDITOS WHERE nombre='Pack 500'),
  'PAY-PATRICIA-001'
);
CALL sp_compra_creditos_aprobar(
  (SELECT id_usuario FROM USUARIO WHERE correo='marcos@demo.com'),
  (SELECT id_paquete FROM PAQUETE_CREDITOS WHERE nombre='Pack 500'),
  'PAY-MARCOS-001'
);
CALL sp_compra_creditos_aprobar(
  (SELECT id_usuario FROM USUARIO WHERE correo='lucia@demo.com'),
  (SELECT id_paquete FROM PAQUETE_CREDITOS WHERE nombre='Pack 500'),
  'PAY-LUCIA-001'
);
CALL sp_compra_creditos_aprobar(
  (SELECT id_usuario FROM USUARIO WHERE correo='ricardo@demo.com'),
  (SELECT id_paquete FROM PAQUETE_CREDITOS WHERE nombre='Pack 500'),
  'PAY-RICARDO-001'
);
CALL sp_compra_creditos_aprobar(
  (SELECT id_usuario FROM USUARIO WHERE correo='melissa@demo.com'),
  (SELECT id_paquete FROM PAQUETE_CREDITOS WHERE nombre='Pack 500'),
  'PAY-MELISSA-001'
);
CALL sp_compra_creditos_aprobar(
  (SELECT id_usuario FROM USUARIO WHERE correo='tomas@demo.com'),
  (SELECT id_paquete FROM PAQUETE_CREDITOS WHERE nombre='Pack 500'),
  'PAY-TOMAS-001'
);
CALL sp_compra_creditos_aprobar(
  (SELECT id_usuario FROM USUARIO WHERE correo='cecilia@demo.com'),
  (SELECT id_paquete FROM PAQUETE_CREDITOS WHERE nombre='Pack 500'),
  'PAY-CECILIA-001'
);
CALL sp_compra_creditos_aprobar(
  (SELECT id_usuario FROM USUARIO WHERE correo='german@demo.com'),
  (SELECT id_paquete FROM PAQUETE_CREDITOS WHERE nombre='Pack 500'),
  'PAY-GERMAN-001'
);
CALL sp_compra_creditos_aprobar(
  (SELECT id_usuario FROM USUARIO WHERE correo='roxana@demo.com'),
  (SELECT id_paquete FROM PAQUETE_CREDITOS WHERE nombre='Pack 500'),
  'PAY-ROXANA-001'
);
CALL sp_compra_creditos_aprobar(
  (SELECT id_usuario FROM USUARIO WHERE correo='kevin@demo.com'),
  (SELECT id_paquete FROM PAQUETE_CREDITOS WHERE nombre='Pack 500'),
  'PAY-KEVIN-001'
);
CALL sp_compra_creditos_aprobar(
  (SELECT id_usuario FROM USUARIO WHERE correo='mauro@demo.com'),
  (SELECT id_paquete FROM PAQUETE_CREDITOS WHERE nombre='Pack 500'),
  'PAY-MAURO-001'
);
CALL sp_compra_creditos_aprobar(
  (SELECT id_usuario FROM USUARIO WHERE correo='dana@demo.com'),
  (SELECT id_paquete FROM PAQUETE_CREDITOS WHERE nombre='Pack 500'),
  'PAY-DANA-001'
);
CALL sp_compra_creditos_aprobar(
  (SELECT id_usuario FROM USUARIO WHERE correo='helena@demo.com'),
  (SELECT id_paquete FROM PAQUETE_CREDITOS WHERE nombre='Pack 500'),
  'PAY-HELENA-001'
);
CALL sp_compra_creditos_aprobar(
  (SELECT id_usuario FROM USUARIO WHERE correo='oscar@demo.com'),
  (SELECT id_paquete FROM PAQUETE_CREDITOS WHERE nombre='Pack 500'),
  'PAY-OSCAR-001'
);

/* ===========================================================
   4) Intercambios extra
   (cada comprador hace al menos un intercambio)
   =========================================================== */

-- Notas de créditos:
-- Bici Urbana Eco          320
-- Bici Plegable Ciudad     280
-- Bici Urbana Basic        250
-- Laptop Reacondicionada   350
-- Monitor 24 Reciclado     220
-- Mantenimiento laptop     110
-- Repr. avanzada PC        140
-- Mantenimiento y limpieza PC 120
-- Formateo e instalación Windows 90
-- PC Oficina Reacondicionada 300

-- 4.1 Algunos compran bicicletas
CALL sp_realizar_intercambio(
  (SELECT id_usuario FROM USUARIO WHERE correo='camila@demo.com'),
  (SELECT id_publicacion FROM PUBLICACION WHERE titulo='Bici Urbana Eco' LIMIT 1),
  320
); SET @id_tx := (SELECT MAX(id_transaccion) FROM TRANSACCION);
UPDATE TRANSACCION SET estado='COMPLETADA' WHERE id_transaccion=@id_tx;

CALL sp_realizar_intercambio(
  (SELECT id_usuario FROM USUARIO WHERE correo='daniel@demo.com'),
  (SELECT id_publicacion FROM PUBLICACION WHERE titulo='Bici Plegable Ciudad' LIMIT 1),
  280
); SET @id_tx := (SELECT MAX(id_transaccion) FROM TRANSACCION);
UPDATE TRANSACCION SET estado='COMPLETADA' WHERE id_transaccion=@id_tx;

CALL sp_realizar_intercambio(
  (SELECT id_usuario FROM USUARIO WHERE correo='sofia@demo.com'),
  (SELECT id_publicacion FROM PUBLICACION WHERE titulo='Bici Urbana Basic' LIMIT 1),
  250
); SET @id_tx := (SELECT MAX(id_transaccion) FROM TRANSACCION);
UPDATE TRANSACCION SET estado='COMPLETADA' WHERE id_transaccion=@id_tx;

CALL sp_realizar_intercambio(
  (SELECT id_usuario FROM USUARIO WHERE correo='pablo@demo.com'),
  (SELECT id_publicacion FROM PUBLICACION WHERE titulo='Bicicleta montaña Pro' LIMIT 1),
  450
); SET @id_tx := (SELECT MAX(id_transaccion) FROM TRANSACCION);
UPDATE TRANSACCION SET estado='COMPLETADA' WHERE id_transaccion=@id_tx;

-- 4.2 Otros compran productos de tecnología
CALL sp_realizar_intercambio(
  (SELECT id_usuario FROM USUARIO WHERE correo='laura@demo.com'),
  (SELECT id_publicacion FROM PUBLICACION WHERE titulo='Laptop Reacondicionada i5' LIMIT 1),
  350
); SET @id_tx := (SELECT MAX(id_transaccion) FROM TRANSACCION);
UPDATE TRANSACCION SET estado='COMPLETADA' WHERE id_transaccion=@id_tx;

CALL sp_realizar_intercambio(
  (SELECT id_usuario FROM USUARIO WHERE correo='andres@demo.com'),
  (SELECT id_publicacion FROM PUBLICACION WHERE titulo='Monitor 24 Reciclado' LIMIT 1),
  220
); SET @id_tx := (SELECT MAX(id_transaccion) FROM TRANSACCION);
UPDATE TRANSACCION SET estado='COMPLETADA' WHERE id_transaccion=@id_tx;

CALL sp_realizar_intercambio(
  (SELECT id_usuario FROM USUARIO WHERE correo='valeria@demo.com'),
  (SELECT id_publicacion FROM PUBLICACION WHERE titulo='PC Oficina Reacondicionada' LIMIT 1),
  300
); SET @id_tx := (SELECT MAX(id_transaccion) FROM TRANSACCION);
UPDATE TRANSACCION SET estado='COMPLETADA' WHERE id_transaccion=@id_tx;

CALL sp_realizar_intercambio(
  (SELECT id_usuario FROM USUARIO WHERE correo='roberto@demo.com'),
  (SELECT id_publicacion FROM PUBLICACION WHERE titulo='Laptop Reacondicionada i5' LIMIT 1),
  350
); SET @id_tx := (SELECT MAX(id_transaccion) FROM TRANSACCION);
UPDATE TRANSACCION SET estado='COMPLETADA' WHERE id_transaccion=@id_tx;

-- 4.3 Otros compran servicios
CALL sp_realizar_intercambio(
  (SELECT id_usuario FROM USUARIO WHERE correo='natalia@demo.com'),
  (SELECT id_publicacion FROM PUBLICACION WHERE titulo='Mantenimiento laptop básico' LIMIT 1),
  110
); SET @id_tx := (SELECT MAX(id_transaccion) FROM TRANSACCION);
UPDATE TRANSACCION SET estado='COMPLETADA' WHERE id_transaccion=@id_tx;

CALL sp_realizar_intercambio(
  (SELECT id_usuario FROM USUARIO WHERE correo='sergio@demo.com'),
  (SELECT id_publicacion FROM PUBLICACION WHERE titulo='Reparación avanzada de PC' LIMIT 1),
  140
); SET @id_tx := (SELECT MAX(id_transaccion) FROM TRANSACCION);
UPDATE TRANSACCION SET estado='COMPLETADA' WHERE id_transaccion=@id_tx;

CALL sp_realizar_intercambio(
  (SELECT id_usuario FROM USUARIO WHERE correo='patricia@demo.com'),
  (SELECT id_publicacion FROM PUBLICACION WHERE titulo='Mantenimiento y limpieza de PC' LIMIT 1),
  120
); SET @id_tx := (SELECT MAX(id_transaccion) FROM TRANSACCION);
UPDATE TRANSACCION SET estado='COMPLETADA' WHERE id_transaccion=@id_tx;

CALL sp_realizar_intercambio(
  (SELECT id_usuario FROM USUARIO WHERE correo='marcos@demo.com'),
  (SELECT id_publicacion FROM PUBLICACION WHERE titulo='Formateo e instalación de Windows' LIMIT 1),
  90
); SET @id_tx := (SELECT MAX(id_transaccion) FROM TRANSACCION);
UPDATE TRANSACCION SET estado='COMPLETADA' WHERE id_transaccion=@id_tx;

CALL sp_realizar_intercambio(
  (SELECT id_usuario FROM USUARIO WHERE correo='lucia@demo.com'),
  (SELECT id_publicacion FROM PUBLICACION WHERE titulo='Mantenimiento laptop básico' LIMIT 1),
  110
); SET @id_tx := (SELECT MAX(id_transaccion) FROM TRANSACCION);
UPDATE TRANSACCION SET estado='COMPLETADA' WHERE id_transaccion=@id_tx;

CALL sp_realizar_intercambio(
  (SELECT id_usuario FROM USUARIO WHERE correo='ricardo@demo.com'),
  (SELECT id_publicacion FROM PUBLICACION WHERE titulo='Reparación avanzada de PC' LIMIT 1),
  140
); SET @id_tx := (SELECT MAX(id_transaccion) FROM TRANSACCION);
UPDATE TRANSACCION SET estado='COMPLETADA' WHERE id_transaccion=@id_tx;

-- 4.4 Algunos hacen 2 operaciones
CALL sp_realizar_intercambio(
  (SELECT id_usuario FROM USUARIO WHERE correo='melissa@demo.com'),
  (SELECT id_publicacion FROM PUBLICACION WHERE titulo='Bici Urbana Basic' LIMIT 1),
  250
); SET @id_tx := (SELECT MAX(id_transaccion) FROM TRANSACCION);
UPDATE TRANSACCION SET estado='COMPLETADA' WHERE id_transaccion=@id_tx;

CALL sp_realizar_intercambio(
  (SELECT id_usuario FROM USUARIO WHERE correo='melissa@demo.com'),
  (SELECT id_publicacion FROM PUBLICACION WHERE titulo='Mantenimiento laptop básico' LIMIT 1),
  110
); SET @id_tx := (SELECT MAX(id_transaccion) FROM TRANSACCION);
UPDATE TRANSACCION SET estado='COMPLETADA' WHERE id_transaccion=@id_tx;

CALL sp_realizar_intercambio(
  (SELECT id_usuario FROM USUARIO WHERE correo='tomas@demo.com'),
  (SELECT id_publicacion FROM PUBLICACION WHERE titulo='Laptop Reacondicionada i5' LIMIT 1),
  350
); SET @id_tx := (SELECT MAX(id_transaccion) FROM TRANSACCION);
UPDATE TRANSACCION SET estado='COMPLETADA' WHERE id_transaccion=@id_tx;

CALL sp_realizar_intercambio(
  (SELECT id_usuario FROM USUARIO WHERE correo='cecilia@demo.com'),
  (SELECT id_publicacion FROM PUBLICACION WHERE titulo='PC Oficina Reacondicionada' LIMIT 1),
  300
); SET @id_tx := (SELECT MAX(id_transaccion) FROM TRANSACCION);
UPDATE TRANSACCION SET estado='COMPLETADA' WHERE id_transaccion=@id_tx;

CALL sp_realizar_intercambio(
  (SELECT id_usuario FROM USUARIO WHERE correo='german@demo.com'),
  (SELECT id_publicacion FROM PUBLICACION WHERE titulo='Monitor 24 Reciclado' LIMIT 1),
  220
); SET @id_tx := (SELECT MAX(id_transaccion) FROM TRANSACCION);
UPDATE TRANSACCION SET estado='COMPLETADA' WHERE id_transaccion=@id_tx;

CALL sp_realizar_intercambio(
  (SELECT id_usuario FROM USUARIO WHERE correo='roxana@demo.com'),
  (SELECT id_publicacion FROM PUBLICACION WHERE titulo='Bici Urbana Eco' LIMIT 1),
  320
); SET @id_tx := (SELECT MAX(id_transaccion) FROM TRANSACCION);
UPDATE TRANSACCION SET estado='COMPLETADA' WHERE id_transaccion=@id_tx;

CALL sp_realizar_intercambio(
  (SELECT id_usuario FROM USUARIO WHERE correo='kevin@demo.com'),
  (SELECT id_publicacion FROM PUBLICACION WHERE titulo='Mantenimiento y limpieza de PC' LIMIT 1),
  120
); SET @id_tx := (SELECT MAX(id_transaccion) FROM TRANSACCION);
UPDATE TRANSACCION SET estado='COMPLETADA' WHERE id_transaccion=@id_tx;

CALL sp_realizar_intercambio(
  (SELECT id_usuario FROM USUARIO WHERE correo='mauro@demo.com'),
  (SELECT id_publicacion FROM PUBLICACION WHERE titulo='Formateo e instalación de Windows' LIMIT 1),
  90
); SET @id_tx := (SELECT MAX(id_transaccion) FROM TRANSACCION);
UPDATE TRANSACCION SET estado='COMPLETADA' WHERE id_transaccion=@id_tx;

CALL sp_realizar_intercambio(
  (SELECT id_usuario FROM USUARIO WHERE correo='dana@demo.com'),
  (SELECT id_publicacion FROM PUBLICACION WHERE titulo='Mantenimiento laptop básico' LIMIT 1),
  110
); SET @id_tx := (SELECT MAX(id_transaccion) FROM TRANSACCION);
UPDATE TRANSACCION SET estado='COMPLETADA' WHERE id_transaccion=@id_tx;

CALL sp_realizar_intercambio(
  (SELECT id_usuario FROM USUARIO WHERE correo='helena@demo.com'),
  (SELECT id_publicacion FROM PUBLICACION WHERE titulo='Bici Plegable Ciudad' LIMIT 1),
  280
); SET @id_tx := (SELECT MAX(id_transaccion) FROM TRANSACCION);
UPDATE TRANSACCION SET estado='COMPLETADA' WHERE id_transaccion=@id_tx;

CALL sp_realizar_intercambio(
  (SELECT id_usuario FROM USUARIO WHERE correo='oscar@demo.com'),
  (SELECT id_publicacion FROM PUBLICACION WHERE titulo='PC Oficina Reacondicionada' LIMIT 1),
  300
); SET @id_tx := (SELECT MAX(id_transaccion) FROM TRANSACCION);
UPDATE TRANSACCION SET estado='COMPLETADA' WHERE id_transaccion=@id_tx;

/* ===========================================================
   5) Actividades sostenibles extra
   =========================================================== */

CALL sp_registrar_actividad_sostenible(
  (SELECT id_usuario FROM USUARIO WHERE correo='camila@demo.com'),
  (SELECT id_tipo_actividad FROM TIPO_ACTIVIDAD WHERE nombre='RECICLAJE'),
  'Participó en jornada de reciclaje de plástico', 15,
  'https://evidencias/reciclaje_camila.jpg'
);

CALL sp_registrar_actividad_sostenible(
  (SELECT id_usuario FROM USUARIO WHERE correo='daniel@demo.com'),
  (SELECT id_tipo_actividad FROM TIPO_ACTIVIDAD WHERE nombre='RECICLAJE'),
  'Entregó 5kg de papel usado', 12,
  'https://evidencias/reciclaje_daniel.jpg'
);

CALL sp_registrar_actividad_sostenible(
  (SELECT id_usuario FROM USUARIO WHERE correo='sofia@demo.com'),
  (SELECT id_tipo_actividad FROM TIPO_ACTIVIDAD WHERE nombre='RECICLAJE'),
  'Recolectó botellas PET en su barrio', 18,
  'https://evidencias/reciclaje_sofia.jpg'
);

CALL sp_registrar_actividad_sostenible(
  (SELECT id_usuario FROM USUARIO WHERE correo='pablo@demo.com'),
  (SELECT id_tipo_actividad FROM TIPO_ACTIVIDAD WHERE nombre='RECICLAJE'),
  'Donó electrónicos viejos a reciclaje', 20,
  'https://evidencias/reciclaje_pablo.jpg'
);

CALL sp_registrar_actividad_sostenible(
  (SELECT id_usuario FROM USUARIO WHERE correo='laura@demo.com'),
  (SELECT id_tipo_actividad FROM TIPO_ACTIVIDAD WHERE nombre='RECICLAJE'),
  'Separó residuos en su oficina por todo el mes', 25,
  'https://evidencias/reciclaje_laura.jpg'
);

CALL sp_registrar_actividad_sostenible(
  (SELECT id_usuario FROM USUARIO WHERE correo='andres@demo.com'),
  (SELECT id_tipo_actividad FROM TIPO_ACTIVIDAD WHERE nombre='RECICLAJE'),
  'Apoyó campaña de recolección de vidrio', 16,
  'https://evidencias/reciclaje_andres.jpg'
);

CALL sp_registrar_actividad_sostenible(
  (SELECT id_usuario FROM USUARIO WHERE correo='valeria@demo.com'),
  (SELECT id_tipo_actividad FROM TIPO_ACTIVIDAD WHERE nombre='RECICLAJE'),
  'Entregó 3kg de latas de aluminio', 10,
  'https://evidencias/reciclaje_valeria.jpg'
);

CALL sp_registrar_actividad_sostenible(
  (SELECT id_usuario FROM USUARIO WHERE correo='roberto@demo.com'),
  (SELECT id_tipo_actividad FROM TIPO_ACTIVIDAD WHERE nombre='RECICLAJE'),
  'Organizó punto de acopio de pilas', 22,
  'https://evidencias/reciclaje_roberto.jpg'
);

CALL sp_registrar_actividad_sostenible(
  (SELECT id_usuario FROM USUARIO WHERE correo='natalia@demo.com'),
  (SELECT id_tipo_actividad FROM TIPO_ACTIVIDAD WHERE nombre='RECICLAJE'),
  'Participó en limpieza de río urbano', 30,
  'https://evidencias/reciclaje_natalia.jpg'
);

CALL sp_registrar_actividad_sostenible(
  (SELECT id_usuario FROM USUARIO WHERE correo='sergio@demo.com'),
  (SELECT id_tipo_actividad FROM TIPO_ACTIVIDAD WHERE nombre='RECICLAJE'),
  'Apoyó campaña de recuperación de e-waste', 18,
  'https://evidencias/reciclaje_sergio.jpg'
);

/* ===========================================================
   6) Regenerar reporte de impacto para 2025-11
   =========================================================== */

CALL sp_generar_reporte_impacto(
  (SELECT id_tipo_reporte FROM TIPO_REPORTE WHERE nombre='MENSUAL'),
  (SELECT id_periodo FROM PERIODO WHERE nombre='2025-11'),
  NULL
);

/* ===========================================================
   7) Chequeo rápido de saldos de algunos usuarios
   =========================================================== */

SELECT u.correo, b.saldo_creditos
FROM USUARIO u
LEFT JOIN BILLETERA b ON b.id_usuario = u.id_usuario
WHERE u.correo IN (
  'ana@demo.com','luis@demo.com','carla@demo.com','diego@demo.com','marta@demo.com',
  'bruno@demo.com','elena@demo.com','fernando@demo.com','gaby@demo.com',
  'camila@demo.com','daniel@demo.com','sofia@demo.com','pablo@demo.com','laura@demo.com',
  'andres@demo.com','valeria@demo.com','roberto@demo.com','natalia@demo.com',
  'sergio@demo.com','patricia@demo.com','marcos@demo.com','lucia@demo.com',
  'ricardo@demo.com','melissa@demo.com','tomas@demo.com','cecilia@demo.com',
  'german@demo.com','roxana@demo.com','kevin@demo.com','mauro@demo.com',
  'dana@demo.com','helena@demo.com','oscar@demo.com'
)
ORDER BY u.correo;

SELECT *
FROM REPORTE_IMPACTO
WHERE id_periodo = 1
  AND id_tipo_reporte = (SELECT id_tipo_reporte FROM TIPO_REPORTE WHERE nombre='MENSUAL');
</file>

<file path="digital-barder/.gitignore">
node_modules
dist
.env
.env.*
.prisma
.DS_Store
</file>

<file path="digital-barder/backend/Dockerfile">
# simple dev image; optional
FROM node:18-alpine
WORKDIR /app
COPY package*.json ./
RUN npm install
COPY . .
EXPOSE 4000
CMD ["npm","run","start"]
</file>

<file path="digital-barder/backend/prisma/seed.js">
import { PrismaClient } from '@prisma/client'
import bcrypt from 'bcryptjs'
const prisma = new PrismaClient()

async function main() {
  const [adminRole, userRole] = await Promise.all([
    prisma.role.upsert({ where: { name: 'ADMIN' }, update: {}, create: { name: 'ADMIN' } }),
    prisma.role.upsert({ where: { name: 'USER' }, update: {}, create: { name: 'USER' } }),
  ])

  const passwordHash = await bcrypt.hash('demo123', 10)
  const admin = await prisma.user.upsert({
    where: { email: 'demo@demo.com' },
    update: {},
    create: { email: 'demo@demo.com', name: 'Admin Demo', passwordHash, roleId: adminRole.id }
  })

  await prisma.wallet.upsert({
    where: { userId: admin.id },
    update: {},
    create: { userId: admin.id, credits: 1000 }
  })

  console.log('Seed listo:', { admin: admin.email })
}

main().catch(e=>{console.error(e); process.exit(1)}).finally(()=>prisma.$disconnect())
</file>

<file path="digital-barder/backend/src/middlewares/auth.js">
// src/middlewares/auth.js
import jwt from "jsonwebtoken";

// Middleware principal: requiere token válido
export function authMiddleware(req, res, next) {
  const authHeader = req.headers.authorization;

  // Esperamos "Authorization: Bearer <token>"
  if (!authHeader || !authHeader.startsWith("Bearer ")) {
    return res.status(401).json({ message: "Token de autenticación faltante" });
  }

  const token = authHeader.split(" ")[1];

  try {
    const payload = jwt.verify(token, process.env.JWT_SECRET);
    // En el payload nosotros pusimos: id_usuario, correo, rol
    req.user = payload;
    next();
  } catch (err) {
    return res
      .status(401)
      .json({ message: "Token inválido o expirado" });
  }
}

// Versión opcional: si hay token lo lee, si no, deja pasar
export function optionalAuth(req, _res, next) {
  const authHeader = req.headers.authorization;
  if (!authHeader || !authHeader.startsWith("Bearer ")) {
    return next();
  }

  const token = authHeader.split(" ")[1];

  try {
    const payload = jwt.verify(token, process.env.JWT_SECRET);
    req.user = payload;
  } catch {
    // si falla, simplemente no ponemos req.user
  }
  next();
}
</file>

<file path="digital-barder/backend/src/middlewares/isAdmin.js">
// src/middlewares/isAdmin.js

// Middleware simple: solo ADMIN
export function isAdmin(req, res, next) {
  if (!req.user) {
    return res.status(401).json({ message: "No autenticado" });
  }

  if (req.user.rol !== "ADMIN") {
    return res.status(403).json({ message: "Acceso solo para administradores" });
  }

  next();
}

// Middleware más general: aceptar varios roles
export function hasRole(...rolesPermitidos) {
  return (req, res, next) => {
    if (!req.user) {
      return res.status(401).json({ message: "No autenticado" });
    }

    if (!rolesPermitidos.includes(req.user.rol)) {
      return res.status(403).json({ message: "No tienes permisos suficientes" });
    }

    next();
  };
}
</file>

<file path="digital-barder/backend/src/modules/actividades/actividades.controller.js">
import {
  registrarActividadService,
  misActividadesService,
} from "./actividades.service.js";

export const registrarActividadController = async (req, res, next) => {
  try {
    const idUsuario = req.user.id_usuario;
    const { id_tipo_actividad, descripcion, creditos_otorgados, evidencia_url } = req.body;

    const result = await registrarActividadService({
      idUsuario,
      id_tipo_actividad,
      descripcion,
      creditos_otorgados,
      evidencia_url,
    });

    res.status(201).json(result);
  } catch (e) { next(e); }
};

export const misActividadesController = async (req, res, next) => {
  try { res.json(await misActividadesService(req.user.id_usuario)); }
  catch (e) { next(e); }
};
</file>

<file path="digital-barder/backend/src/modules/actividades/actividades.routes.js">
import { Router } from "express";
import { authMiddleware } from "../../middlewares/auth.js";
import {
  registrarActividadController,
  misActividadesController,
} from "./actividades.controller.js";

const router = Router();

router.use(authMiddleware);

router.post("/", registrarActividadController);
router.get("/mias", misActividadesController);

export default router;
</file>

<file path="digital-barder/backend/src/modules/actividades/actividades.service.js">
import { prisma } from "../../config/prisma.js";

export async function registrarActividadService({
  idUsuario,
  id_tipo_actividad,
  descripcion,
  creditos_otorgados,
  evidencia_url,
}) {
  if (!id_tipo_actividad || !descripcion || !creditos_otorgados) {
    const err = new Error("id_tipo_actividad, descripcion y creditos_otorgados son obligatorios");
    err.status = 400;
    throw err;
  }

  await prisma.$executeRawUnsafe(
    "CALL sp_registrar_actividad_sostenible(?, ?, ?, ?, ?)",
    idUsuario,
    id_tipo_actividad,
    descripcion,
    creditos_otorgados,
    evidencia_url || null
  );

  // devolver ultima actividad del usuario
  const [act] = await prisma.$queryRaw`
    SELECT *
    FROM ACTIVIDAD_SOSTENIBLE
    WHERE id_usuario = ${idUsuario}
    ORDER BY creado_en DESC, id_actividad DESC
    LIMIT 1
  `;
  return act;
}

export async function misActividadesService(idUsuario) {
  return prisma.$queryRaw`
    SELECT * FROM ACTIVIDAD_SOSTENIBLE
    WHERE id_usuario = ${idUsuario}
    ORDER BY creado_en DESC
  `;
}
</file>

<file path="digital-barder/backend/src/modules/catalogos/catalogos.controller.js">
import {
  listarCategorias,
  listarUnidadesMedida,
  listarPaquetesCreditos,
  listarTiposActividad,
  listarTiposPromocion,
  listarUbicacionesPublicidad,
  listarTiposLogro,
} from "./catalogos.service.js";

export const getCategorias = async (_req, res, next) => {
  try { res.json(await listarCategorias()); } catch (e) { next(e); }
};
export const getUnidadesMedida = async (_req, res, next) => {
  try { res.json(await listarUnidadesMedida()); } catch (e) { next(e); }
};
export const getPaquetesCreditos = async (_req, res, next) => {
  try { res.json(await listarPaquetesCreditos()); } catch (e) { next(e); }
};
export const getTiposActividad = async (_req, res, next) => {
  try { res.json(await listarTiposActividad()); } catch (e) { next(e); }
};
export const getTiposPromocion = async (_req, res, next) => {
  try { res.json(await listarTiposPromocion()); } catch (e) { next(e); }
};
export const getUbicacionesPublicidad = async (_req, res, next) => {
  try { res.json(await listarUbicacionesPublicidad()); } catch (e) { next(e); }
};
export const getTiposLogro = async (_req, res, next) => {
  try { res.json(await listarTiposLogro()); } catch (e) { next(e); }
};
</file>

<file path="digital-barder/backend/src/modules/catalogos/catalogos.routes.js">
import { Router } from "express";
import {
  getCategorias,
  getUnidadesMedida,
  getPaquetesCreditos,
  getTiposActividad,
  getTiposPromocion,
  getUbicacionesPublicidad,
  getTiposLogro,
} from "./catalogos.controller.js";

const router = Router();

router.get("/categorias", getCategorias);
router.get("/unidades-medida", getUnidadesMedida);
router.get("/paquetes-creditos", getPaquetesCreditos);
router.get("/tipos-actividad", getTiposActividad);
router.get("/tipos-promocion", getTiposPromocion);
router.get("/ubicaciones-publicidad", getUbicacionesPublicidad);
router.get("/tipos-logro", getTiposLogro);

export default router;
</file>

<file path="digital-barder/backend/src/modules/catalogos/catalogos.service.js">
import { prisma } from "../../config/prisma.js";

export const listarCategorias = () =>
  prisma.$queryRaw`SELECT * FROM CATEGORIA ORDER BY nombre`;

export const listarUnidadesMedida = () =>
  prisma.$queryRaw`SELECT * FROM UNIDAD_MEDIDA ORDER BY nombre`;

export const listarPaquetesCreditos = () =>
  prisma.$queryRaw`SELECT * FROM PAQUETE_CREDITOS WHERE activo = TRUE ORDER BY cantidad_creditos`;

export const listarTiposActividad = () =>
  prisma.$queryRaw`SELECT * FROM TIPO_ACTIVIDAD ORDER BY nombre`;

export const listarTiposPromocion = () =>
  prisma.$queryRaw`SELECT * FROM TIPO_PROMOCION ORDER BY nombre`;

export const listarUbicacionesPublicidad = () =>
  prisma.$queryRaw`SELECT * FROM UBICACION_PUBLICIDAD ORDER BY nombre`;

export const listarTiposLogro = () =>
  prisma.$queryRaw`SELECT * FROM TIPO_LOGRO ORDER BY nombre`;
</file>

<file path="digital-barder/backend/src/modules/intercambios/intercambios.service.js">
import { prisma } from "../../config/prisma.js";

export async function crearIntercambioService({ idComprador, id_publicacion, creditos }) {
  if (!id_publicacion || !creditos) {
    const err = new Error("id_publicacion y creditos son obligatorios");
    err.status = 400;
    throw err;
  }

  await prisma.$executeRawUnsafe(
    "CALL sp_realizar_intercambio(?, ?, ?)",
    idComprador,
    id_publicacion,
    creditos
  );

  // La última transacción creada
  const [tx] = await prisma.$queryRaw`
    SELECT *
    FROM TRANSACCION
    WHERE id_comprador = ${idComprador}
    ORDER BY id_transaccion DESC
    LIMIT 1
  `;
  return tx;
}

export async function misComprasService(idUsuario) {
  return prisma.$queryRaw`
    SELECT t.*, p.titulo
    FROM TRANSACCION t
    JOIN PUBLICACION p ON p.id_publicacion = t.id_publicacion
    WHERE t.id_comprador = ${idUsuario}
    ORDER BY t.creado_en DESC
  `;
}

export async function misVentasService(idUsuario) {
  return prisma.$queryRaw`
    SELECT t.*, p.titulo
    FROM TRANSACCION t
    JOIN PUBLICACION p ON p.id_publicacion = t.id_publicacion
    WHERE t.id_vendedor = ${idUsuario}
    ORDER BY t.creado_en DESC
  `;
}

export async function detalleTransaccionService(idTransaccion) {
  const [row] = await prisma.$queryRaw`
    SELECT t.*, p.titulo, p.descripcion, p.valor_creditos
    FROM TRANSACCION t
    JOIN PUBLICACION p ON p.id_publicacion = t.id_publicacion
    WHERE t.id_transaccion = ${idTransaccion}
    LIMIT 1
  `;
  if (!row) {
    const err = new Error("Transacción no encontrada");
    err.status = 404;
    throw err;
  }
  return row;
}
</file>

<file path="digital-barder/backend/src/modules/logros/logros.controller.js">
import {
  misLogrosService,
  listarLogrosService,
} from "./logros.service.js";

export const misLogrosController = async (req, res, next) => {
  try { res.json(await misLogrosService(req.user.id_usuario)); }
  catch (e) { next(e); }
};

export const listarLogrosController = async (_req, res, next) => {
  try { res.json(await listarLogrosService()); }
  catch (e) { next(e); }
};
</file>

<file path="digital-barder/backend/src/modules/logros/logros.routes.js">
import { Router } from "express";
import { authMiddleware } from "../../middlewares/auth.js";
import { isAdmin } from "../../middlewares/isAdmin.js";
import {
  misLogrosController,
  listarLogrosController,
} from "./logros.controller.js";

const router = Router();

router.use(authMiddleware);

router.get("/mios", misLogrosController);

// sólo admin ve catálogo completo
router.get("/", isAdmin, listarLogrosController);

export default router;
</file>

<file path="digital-barder/backend/src/modules/logros/logros.service.js">
import { prisma } from "../../config/prisma.js";

export const listarLogrosService = () =>
  prisma.$queryRaw`
    SELECT l.*, tl.nombre AS tipo_logro
    FROM LOGRO l
    JOIN TIPO_LOGRO tl ON tl.id_tipo_logro = l.id_tipo_logro
    ORDER BY l.id_logro
  `;

export const misLogrosService = (idUsuario) =>
  prisma.$queryRaw`
    SELECT ul.*, l.nombre, l.descripcion, l.meta_requerida, l.creditos_recompensa
    FROM USUARIO_LOGRO ul
    JOIN LOGRO l ON l.id_logro = ul.id_logro
    WHERE ul.id_usuario = ${idUsuario}
    ORDER BY l.id_logro
  `;
</file>

<file path="digital-barder/backend/src/modules/premium/premium.controller.js">
// premium.controller.js
import { miPlanPremiumService } from "./premium.service.js";

export const miPlanPremiumController = async (req, res, next) => {
  try { res.json(await miPlanPremiumService(req.user.id_usuario)); }
  catch (e) { next(e); }
};
</file>

<file path="digital-barder/backend/src/modules/premium/premium.routes.js">
// premium.routes.js
import { Router } from "express";
import { authMiddleware } from "../../middlewares/auth.js";
import {
  miPlanPremiumController,
} from "./premium.controller.js";

const router = Router();
router.use(authMiddleware);

router.get("/mi-plan", miPlanPremiumController);

export default router;
</file>

<file path="digital-barder/backend/src/modules/premium/premium.service.js">
// premium.service.js
import { prisma } from "../../config/prisma.js";

export const miPlanPremiumService = (idUsuario) =>
  prisma.$queryRaw`
    SELECT * FROM SUSCRIPCION_PREMIUM
    WHERE id_usuario = ${idUsuario}
    ORDER BY fecha_inicio DESC
    LIMIT 1
  `;
</file>

<file path="digital-barder/backend/src/modules/promociones/promociones.controller.js">
import {
  listarPromocionesService,
  crearPromocionService,
  actualizarEstadoPromocionService,
  vincularPublicacionService,
} from "./promociones.service.js";

export const listarPromocionesController = async (_req, res, next) => {
  try { res.json(await listarPromocionesService()); } catch (e) { next(e); }
};

export const crearPromocionController = async (req, res, next) => {
  try { res.status(201).json(await crearPromocionService(req.body)); }
  catch (e) { next(e); }
};

export const actualizarEstadoPromocionController = async (req, res, next) => {
  try {
    const id = +req.params.id;
    const { estado } = req.body;
    res.json(await actualizarEstadoPromocionService(id, estado));
  } catch (e) { next(e); }
};

export const vincularPublicacionController = async (req, res, next) => {
  try {
    const idPromocion = +req.params.id;
    const { id_publicacion } = req.body;
    await vincularPublicacionService(idPromocion, id_publicacion);
    res.status(201).json({ message: "Publicación vinculada" });
  } catch (e) { next(e); }
};
</file>

<file path="digital-barder/backend/src/modules/promociones/promociones.routes.js">
import { Router } from "express";
import { authMiddleware } from "../../middlewares/auth.js";
import { isAdmin } from "../../middlewares/isAdmin.js";
import {
  listarPromocionesController,
  crearPromocionController,
  actualizarEstadoPromocionController,
  vincularPublicacionController,
} from "./promociones.controller.js";

const router = Router();

router.use(authMiddleware, isAdmin);

router.get("/", listarPromocionesController);
router.post("/", crearPromocionController);
router.patch("/:id/estado", actualizarEstadoPromocionController);
router.post("/:id/publicaciones", vincularPublicacionController);

export default router;
</file>

<file path="digital-barder/backend/src/modules/promociones/promociones.service.js">
import { prisma } from "../../config/prisma.js";

export const listarPromocionesService = () =>
  prisma.$queryRaw`
    SELECT * FROM PROMOCION
    ORDER BY fecha_inicio DESC
  `;

export async function crearPromocionService(body) {
  const {
    id_tipo_promocion,
    nombre,
    descripcion,
    creditos_otorgados,
    fecha_inicio,
    fecha_fin,
    estado = "ACTIVA",
  } = body;

  if (!id_tipo_promocion || !nombre || !creditos_otorgados || !fecha_inicio || !fecha_fin) {
    const err = new Error("Faltan datos obligatorios de promoción");
    err.status = 400;
    throw err;
  }

  await prisma.$queryRaw`
    INSERT INTO PROMOCION
      (id_tipo_promocion, nombre, descripcion, creditos_otorgados,
       fecha_inicio, fecha_fin, estado)
    VALUES
      (${id_tipo_promocion}, ${nombre}, ${descripcion || null}, ${creditos_otorgados},
       ${fecha_inicio}, ${fecha_fin}, ${estado})
  `;

  const [row] = await prisma.$queryRaw`
    SELECT * FROM PROMOCION
    WHERE id_promocion = LAST_INSERT_ID()
    LIMIT 1
  `;
  return row;
}

export async function actualizarEstadoPromocionService(idPromocion, estado) {
  await prisma.$queryRaw`
    UPDATE PROMOCION
    SET estado = ${estado}
    WHERE id_promocion = ${idPromocion}
  `;
  const [row] = await prisma.$queryRaw`
    SELECT * FROM PROMOCION
    WHERE id_promocion = ${idPromocion}
    LIMIT 1
  `;
  return row;
}

export async function vincularPublicacionService(idPromocion, idPublicacion) {
  if (!idPublicacion) {
    const err = new Error("id_publicacion es obligatorio");
    err.status = 400;
    throw err;
  }
  await prisma.$queryRaw`
    INSERT IGNORE INTO PROMOCION_PUBLICACION (id_promocion, id_publicacion)
    VALUES (${idPromocion}, ${idPublicacion})
  `;
}
</file>

<file path="digital-barder/backend/src/modules/publicaciones/publicaciones.service.js">
import { prisma } from "../../config/prisma.js";

// Listar básicas (sin joins pesados)
export async function listarPublicacionesService({ categoria, estado }) {
  let where = "WHERE 1=1";
  const params = [];

  if (categoria) {
    where += " AND p.id_categoria = ?";
    params.push(parseInt(categoria, 10));
  }
  if (estado) {
    where += " AND p.estado = ?";
    params.push(estado);
  }

  const sql = `
    SELECT p.id_publicacion, p.titulo, p.descripcion, p.valor_creditos,
           p.estado, p.imagen_url, c.nombre AS categoria, u.nombre AS usuario
    FROM PUBLICACION p
    JOIN CATEGORIA c ON c.id_categoria = p.id_categoria
    JOIN USUARIO u ON u.id_usuario = p.id_usuario
    ${where}
    ORDER BY p.creado_en DESC
  `;
  // @ts-ignore
  return prisma.$queryRawUnsafe(sql, ...params);
}

export async function obtenerPublicacionService(idPublicacion) {
  const [row] = await prisma.$queryRaw`
    SELECT p.*, c.nombre AS categoria, u.nombre AS usuario
    FROM PUBLICACION p
    JOIN CATEGORIA c ON c.id_categoria = p.id_categoria
    JOIN USUARIO u ON u.id_usuario = p.id_usuario
    WHERE p.id_publicacion = ${idPublicacion}
    LIMIT 1
  `;
  if (!row) {
    const err = new Error("Publicación no encontrada");
    err.status = 404;
    throw err;
  }
  return row;
}

export async function misPublicacionesService(idUsuario) {
  return prisma.$queryRaw`
    SELECT p.*
    FROM PUBLICACION p
    WHERE p.id_usuario = ${idUsuario}
    ORDER BY p.creado_en DESC
  `;
}

// Crear PRODUCTO + PUBLICACION + PUBLICACION_PRODUCTO
export async function crearPublicacionProductoService(idUsuario, body) {
  const {
    titulo,
    descripcion,
    id_categoria,
    valor_creditos,
    imagen_url,
    producto,         // { nombre, descripcion, precio, peso }
    cantidad,
    id_um,
  } = body;

  if (!titulo || !descripcion || !id_categoria || !valor_creditos || !producto || !cantidad || !id_um) {
    const err = new Error("Faltan datos obligatorios");
    err.status = 400;
    throw err;
  }

  return prisma.$transaction(async (tx) => {
    const prod = await tx.$queryRaw`
      INSERT INTO PRODUCTO (id_categoria, nombre, descripcion, precio, peso)
      VALUES (${id_categoria}, ${producto.nombre}, ${producto.descripcion || null},
              ${producto.precio || null}, ${producto.peso || null})
    `;

    const [newProd] = await tx.$queryRaw`
      SELECT * FROM PRODUCTO
      WHERE id_producto = LAST_INSERT_ID()
      LIMIT 1
    `;

    const tipoProducto = await tx.$queryRaw`
      SELECT id_tipo_publicacion
      FROM TIPO_PUBLICACION
      WHERE nombre = 'PRODUCTO'
      LIMIT 1
    `;
    if (!tipoProducto.length) {
      const err = new Error("No existe TIPO_PUBLICACION PRODUCTO");
      err.status = 500;
      throw err;
    }

    await tx.$queryRaw`
      INSERT INTO PUBLICACION
        (id_usuario, id_categoria, id_tipo_publicacion, titulo, descripcion, valor_creditos, imagen_url)
      VALUES
        (${idUsuario}, ${id_categoria}, ${tipoProducto[0].id_tipo_publicacion},
         ${titulo}, ${descripcion}, ${valor_creditos}, ${imagen_url || null})
    `;

    const [pub] = await tx.$queryRaw`
      SELECT * FROM PUBLICACION WHERE id_publicacion = LAST_INSERT_ID() LIMIT 1
    `;

    await tx.$queryRaw`
      INSERT INTO PUBLICACION_PRODUCTO (id_publicacion, id_producto, cantidad, id_um)
      VALUES (${pub.id_publicacion}, ${newProd.id_producto}, ${cantidad}, ${id_um})
    `;

    return pub;
  });
}

// Crear SERVICIO + PUBLICACION + PUBLICACION_SERVICIO
export async function crearPublicacionServicioService(idUsuario, body) {
  const {
    titulo,
    descripcion,
    id_categoria,
    valor_creditos,
    imagen_url,
    servicio, // { nombre, descripcion, precio, duracion_min }
    horario,
  } = body;

  if (!titulo || !descripcion || !id_categoria || !valor_creditos || !servicio || !horario) {
    const err = new Error("Faltan datos obligatorios");
    err.status = 400;
    throw err;
  }

  return prisma.$transaction(async (tx) => {
    await tx.$queryRaw`
      INSERT INTO SERVICIO (id_categoria, estado, nombre, descripcion, precio, duracion_min)
      VALUES (${id_categoria}, 'ACTIVO', ${servicio.nombre}, ${servicio.descripcion || null},
              ${servicio.precio || null}, ${servicio.duracion_min || null})
    `;

    const [serv] = await tx.$queryRaw`
      SELECT * FROM SERVICIO WHERE id_servicio = LAST_INSERT_ID() LIMIT 1
    `;

    const tipoServicio = await tx.$queryRaw`
      SELECT id_tipo_publicacion
      FROM TIPO_PUBLICACION
      WHERE nombre = 'SERVICIO'
      LIMIT 1
    `;
    if (!tipoServicio.length) {
      const err = new Error("No existe TIPO_PUBLICACION SERVICIO");
      err.status = 500;
      throw err;
    }

    await tx.$queryRaw`
      INSERT INTO PUBLICACION
        (id_usuario, id_categoria, id_tipo_publicacion, titulo, descripcion, valor_creditos, imagen_url)
      VALUES
        (${idUsuario}, ${id_categoria}, ${tipoServicio[0].id_tipo_publicacion},
         ${titulo}, ${descripcion}, ${valor_creditos}, ${imagen_url || null})
    `;

    const [pub] = await tx.$queryRaw`
      SELECT * FROM PUBLICACION WHERE id_publicacion = LAST_INSERT_ID() LIMIT 1
    `;

    await tx.$queryRaw`
      INSERT INTO PUBLICACION_SERVICIO (id_publicacion, id_servicio, horario)
      VALUES (${pub.id_publicacion}, ${serv.id_servicio}, ${horario})
    `;

    return pub;
  });
}

// Búsqueda FULLTEXT
export async function buscarPublicacionesService(q) {
  if (!q.trim()) return [];
  return prisma.$queryRawUnsafe(
    `
    SELECT id_publicacion, titulo, descripcion, valor_creditos, imagen_url
    FROM PUBLICACION
    WHERE MATCH(titulo, descripcion) AGAINST (? IN NATURAL LANGUAGE MODE)
      AND estado = 'PUBLICADA'
    ORDER BY creado_en DESC
    `,
    q
  );
}

// Calificaciones
export async function crearCalificacionService({
  idUsuario,
  idPublicacion,
  estrellas,
  comentario,
}) {
  if (!estrellas) {
    const err = new Error("estrellas es obligatorio");
    err.status = 400;
    throw err;
  }

  await prisma.$queryRaw`
    INSERT INTO CALIFICACION (id_usuario, id_publicacion, estrellas, comentario)
    VALUES (${idUsuario}, ${idPublicacion}, ${estrellas}, ${comentario || null})
    ON DUPLICATE KEY UPDATE
      estrellas = VALUES(estrellas),
      comentario = VALUES(comentario)
  `;

  const [row] = await prisma.$queryRaw`
    SELECT * FROM CALIFICACION
    WHERE id_usuario = ${idUsuario} AND id_publicacion = ${idPublicacion}
    LIMIT 1
  `;
  return row;
}

export async function listarCalificacionesService(idPublicacion) {
  return prisma.$queryRaw`
    SELECT c.*, u.nombre
    FROM CALIFICACION c
    JOIN USUARIO u ON u.id_usuario = c.id_usuario
    WHERE c.id_publicacion = ${idPublicacion}
    ORDER BY c.id_calificacion DESC
  `;
}
</file>

<file path="digital-barder/backend/src/modules/publicidad/publicidad.controller.js">
// src/modules/publicidad/publicidad.controller.js

// Servicios propios del módulo PUBLICIDAD
import {
  crearPublicidadService,
  listarPublicidadActivaService,
  listarPublicidadAdminService,
} from "./publicidad.service.js";

// Servicio del módulo PUBLICACIONES (ruta correcta)
import { buscarPublicacionesService } from "../publicaciones/publicaciones.service.js";

/**
 * Convierte BigInt, Date, Prisma.Decimal, etc. en tipos JSON-safe
 */
function toPlain(value) {
  if (typeof value === "bigint") return Number(value);

  if (value instanceof Date)
    return value.toISOString().slice(0, 19).replace("T", " ");

  if (value && typeof value === "object") {
    if (typeof value.toNumber === "function") {
      return value.toNumber();
    }

    const prim = value.valueOf?.();
    if (prim != null && typeof prim !== "object") return prim;

    if (Array.isArray(value)) return value.map((v) => toPlain(v));

    const out = {};
    for (const [k, v] of Object.entries(value)) out[k] = toPlain(v);
    return out;
  }

  return value;
}

/**
 * POST /api/publicidad
 * Crear anuncio publicitario (solo admin)
 */
export const crearPublicidadController = async (req, res, next) => {
  try {
    const idUsuario = req.user.id_usuario;
    const data = await crearPublicidadService(idUsuario, req.body);
    res.status(201).json(toPlain(data));
  } catch (err) {
    next(err);
  }
};

/**
 * GET /api/publicidad/activa
 * Publicidad visible para el FRONT (solo activas y en rango)
 */
export const listarPublicidadActivaController = async (req, res, next) => {
  try {
    const data = await listarPublicidadActivaService();
    res.json(toPlain(data));
  } catch (err) {
    next(err);
  }
};

/**
 * GET /api/publicidad/admin
 * Lista TODA la publicidad (panel administrador)
 */
export const listarPublicidadAdminController = async (req, res, next) => {
  try {
    const data = await listarPublicidadAdminService();
    res.json(toPlain(data));
  } catch (err) {
    next(err);
  }
};

/**
 * GET /api/publicidad/buscar-publicaciones?q=
 * Buscar publicaciones para vincularlas a un banner
 */
export const buscarPublicacionesParaPublicidadController = async (
  req,
  res,
  next
) => {
  try {
    const q = req.query.q || "";
    const data = await buscarPublicacionesService(q);
    res.json(toPlain(data));
  } catch (err) {
    next(err);
  }
};
</file>

<file path="digital-barder/backend/src/modules/publicidad/publicidad.routes.js">
import { Router } from "express";
import { authMiddleware } from "../../middlewares/auth.js";
import {
  listarPublicidadActivaController,
  crearPublicidadController,
} from "./publicidad.controller.js";

const router = Router();

router.get("/", listarPublicidadActivaController);

router.use(authMiddleware);
router.post("/", crearPublicidadController);

export default router;
</file>

<file path="digital-barder/backend/src/modules/publicidad/publicidad.service.js">
// src/modules/publicidad/publicidad.service.js
import { prisma } from "../../config/prisma.js";

// Publicidad visible para el FRONT (activa y en rango de fechas)
export const listarPublicidadActivaService = () =>
  prisma.$queryRaw`
    SELECT p.*, u.nombre AS usuario
    FROM PUBLICIDAD p
    JOIN USUARIO u ON u.id_usuario = p.id_usuario
    WHERE p.estado = 'ACTIVA'
      AND NOW() BETWEEN p.fecha_inicio AND p.fecha_fin
    ORDER BY p.fecha_inicio DESC, p.id_publicidad DESC
  `;

// Publicidad para ADMIN (toda la publicidad)
export const listarPublicidadAdminService = () =>
  prisma.$queryRaw`
    SELECT p.*, u.nombre AS usuario
    FROM PUBLICIDAD p
    JOIN USUARIO u ON u.id_usuario = p.id_usuario
    ORDER BY p.fecha_inicio DESC, p.id_publicidad DESC
  `;

// Crear una nueva PUBLICIDAD
export const crearPublicidadService = async (idUsuario, body) => {
  const {
    id_ubicacion,
    titulo,
    descripcion,
    url_destino,
    fecha_inicio,
    fecha_fin,
    costo_creditos,
  } = body;

  if (!id_ubicacion || !titulo || !fecha_inicio || !fecha_fin || !costo_creditos) {
    const err = new Error("Faltan datos obligatorios de publicidad");
    err.status = 400;
    throw err;
  }

  // INSERT
  await prisma.$queryRaw`
    INSERT INTO PUBLICIDAD
      (id_usuario, id_ubicacion, estado, titulo, descripcion, url_destino,
       fecha_inicio, fecha_fin, costo_creditos)
    VALUES
      (
        ${idUsuario},
        ${id_ubicacion},
        'PROGRAMADA',
        ${titulo},
        ${descripcion || null},
        ${url_destino || null},
        ${fecha_inicio},
        ${fecha_fin},
        ${costo_creditos}
      )
  `;

  // Devolver el registro recién creado
  const [row] = await prisma.$queryRaw`
    SELECT *
    FROM PUBLICIDAD
    WHERE id_publicidad = LAST_INSERT_ID()
    LIMIT 1
  `;
  return row;
};
</file>

<file path="digital-barder/backend/src/modules/reportes/reportes.service.js">
// src/modules/reportes/reportes.service.js
import { prisma } from "../../config/prisma.js";

function rangoFechas({ desde, hasta }) {
  return [desde || "2000-01-01", hasta || "2100-01-01"];
}

export async function repUsuariosActivosService(r) {
  const [rows] = await prisma.$queryRawUnsafe(
    "CALL sp_rep_usuarios_activos(?, ?)",
    ...rangoFechas(r)
  );
  return rows;
}

export async function repUsuariosAbandonadosService(r) {
  const [rows] = await prisma.$queryRawUnsafe(
    "CALL sp_rep_usuarios_abandonados(?, ?)",
    ...rangoFechas(r)
  );
  return rows;
}

export async function repIngresosCreditosService(r) {
  const [rows] = await prisma.$queryRawUnsafe(
    "CALL sp_rep_ingresos_creditos(?, ?)",
    ...rangoFechas(r)
  );
  return rows;
}

export async function repCreditosGenConsService(r) {
  const [rows] = await prisma.$queryRawUnsafe(
    "CALL sp_rep_creditos_generados_vs_consumidos(?, ?)",
    ...rangoFechas(r)
  );
  return rows;
}

export async function repIntercambiosCategoriaService(r) {
  const [rows] = await prisma.$queryRawUnsafe(
    "CALL sp_rep_intercambios_por_categoria(?, ?)",
    ...rangoFechas(r)
  );
  return rows;
}

export async function repPublicacionesVsIntercambiosService(r) {
  const [rows] = await prisma.$queryRawUnsafe(
    "CALL sp_rep_publicaciones_vs_intercambios(?, ?)",
    ...rangoFechas(r)
  );
  return rows;
}

export async function repImpactoAcumuladoService(tipoReporte, periodo) {
  const [rows] = await prisma.$queryRawUnsafe(
    "CALL sp_generar_reporte_impacto(?, ?, NULL)",
    tipoReporte,
    periodo,
  );
  return rows;
}


export async function rankingUsuariosService(idPeriodo, limit) {
  const [rows] = await prisma.$queryRawUnsafe(
    "CALL sp_obtener_ranking_usuarios(?, ?)",
    idPeriodo ?? null,
    limit ?? null
  );
  return rows;
}
</file>

<file path="digital-barder/backend/src/modules/uploads/multer.js">
// uploads/multer.js
import multer from "multer";
import { v4 as uuid } from "uuid";
import path from "path";

const storage = multer.diskStorage({
  destination: (req, file, cb) => {
    cb(null, "uploads_storage"); // carpeta real donde iran las imágenes
  },
  filename: (req, file, cb) => {
    const unique = uuid();
    const ext = path.extname(file.originalname);
    cb(null, unique + ext);
  },
});

export const upload = multer({ storage });
</file>

<file path="digital-barder/backend/src/modules/uploads/uploads.controller.js">
import { procesarArchivoService } from "./uploads.service.js";

export const subirArchivoController = async (req, res, next) => {
  try {
    if (!req.file) {
      return res.status(400).json({ message: "No enviaste ningún archivo" });
    }

    const url = await procesarArchivoService(req.file);

    res.json({
      message: "Archivo subido correctamente",
      url,
    });
  } catch (err) {
    next(err);
  }
};
</file>

<file path="digital-barder/backend/src/modules/uploads/uploads.routes.js">
import { Router } from "express";
import { authMiddleware } from "../../middlewares/auth.js";
import { upload } from "./multer.js";
import { subirArchivoController } from "./uploads.controller.js";

const router = Router();

// Ruta protegida: requiere login
router.post("/", authMiddleware, upload.single("archivo"), subirArchivoController);

export default router;
</file>

<file path="digital-barder/backend/src/modules/uploads/uploads.service.js">
import path from "path";

export async function procesarArchivoService(file) {
  // URL pública final (ajústala según tu hosting)
  const url = `/uploads/${file.filename}`;

  // Puedes almacenar archivo en S3, Cloudinary o FS local.
  // Aquí usamos local para desarrollo.
  
  return url;
}
</file>

<file path="digital-barder/backend/src/modules/usuarios/usuarios.service.js">
import bcrypt from "bcryptjs";
import { prisma } from "../../config/prisma.js";

export async function listarUsuariosService() {
  const rows = await prisma.$queryRaw`
    SELECT u.id_usuario, u.nombre, u.apellido, u.correo, u.telefono,
           u.estado, r.nombre AS rol
    FROM USUARIO u
    JOIN ROL r ON r.id_rol = u.id_rol
    ORDER BY u.id_usuario DESC
  `;
  return rows;
}

export async function crearUsuarioAdminService({
  nombre,
  apellido,
  correo,
  telefono,
  password,
  id_rol,
  estado = "ACTIVO",
}) {
  if (!nombre || !correo || !password || !id_rol) {
    const err = new Error("nombre, correo, password e id_rol son obligatorios");
    err.status = 400;
    throw err;
  }

  const existente = await prisma.$queryRaw`
    SELECT id_usuario FROM USUARIO WHERE correo = ${correo} LIMIT 1
  `;
  if (existente.length) {
    const error = new Error("El correo ya está registrado");
    error.status = 409;
    throw error;
  }

  const hash = await bcrypt.hash(password, 10);

  await prisma.$queryRaw`
    INSERT INTO USUARIO (id_rol, estado, nombre, apellido, correo, password_hash, telefono, url_perfil)
    VALUES (${id_rol}, ${estado}, ${nombre}, ${apellido || null}, ${correo}, ${hash},
            ${telefono || null}, NULL)
  `;

  const rows = await prisma.$queryRaw`
    SELECT u.id_usuario, u.nombre, u.apellido, u.correo, u.telefono,
           u.estado, r.nombre AS rol
    FROM USUARIO u
    JOIN ROL r ON r.id_rol = u.id_rol
    WHERE u.correo = ${correo}
    LIMIT 1
  `;
  return rows[0];
}

export async function actualizarUsuarioService(idUsuario, data) {
  const { nombre, apellido, telefono, id_rol } = data;

  await prisma.$queryRaw`
    UPDATE USUARIO
    SET nombre = COALESCE(${nombre}, nombre),
        apellido = COALESCE(${apellido}, apellido),
        telefono = COALESCE(${telefono}, telefono),
        id_rol = COALESCE(${id_rol}, id_rol)
    WHERE id_usuario = ${idUsuario}
  `;

  const rows = await prisma.$queryRaw`
    SELECT u.id_usuario, u.nombre, u.apellido, u.correo, u.telefono,
           u.estado, r.nombre AS rol
    FROM USUARIO u
    JOIN ROL r ON r.id_rol = u.id_rol
    WHERE u.id_usuario = ${idUsuario}
    LIMIT 1
  `;
  if (!rows.length) {
    const err = new Error("Usuario no encontrado");
    err.status = 404;
    throw err;
  }
  return rows[0];
}

export async function cambiarEstadoUsuarioService(idUsuario, estado) {
  if (!estado) {
    const err = new Error("estado es obligatorio");
    err.status = 400;
    throw err;
  }

  await prisma.$queryRaw`
    UPDATE USUARIO
    SET estado = ${estado}
    WHERE id_usuario = ${idUsuario}
  `;

  const rows = await prisma.$queryRaw`
    SELECT u.id_usuario, u.nombre, u.apellido, u.correo, u.telefono,
           u.estado, r.nombre AS rol
    FROM USUARIO u
    JOIN ROL r ON r.id_rol = u.id_rol
    WHERE u.id_usuario = ${idUsuario}
    LIMIT 1
  `;
  if (!rows.length) {
    const err = new Error("Usuario no encontrado");
    err.status = 404;
    throw err;
  }
  return rows[0];
}

export async function obtenerHistorialUsuarioService(idUsuario) {
  // Llama a tu SP sp_obtener_historial_usuario
  const result = await prisma.$queryRawUnsafe(
    "CALL sp_obtener_historial_usuario(?)",
    idUsuario
  );
  // En MySQL, CALL devuelve [rows, meta]; nos quedamos con rows[0]
  return result[0] || result;
}
</file>

<file path="digital-barder/backend/src/modules/wallet/wallet.service.js">
import { prisma } from "../../config/prisma.js";

// Helper para convertir BigInt / Decimal a Number
function toNumberSafe(value, def = 0) {
  if (value == null) return def;

  if (typeof value === "bigint") return Number(value);

  if (typeof value === "object" && typeof value.toNumber === "function") {
    return value.toNumber();
  }

  const num = Number(value);
  return Number.isNaN(num) ? def : num;
}

function normalizeBilleteraRow(row) {
  if (!row) {
    return {
      saldo_creditos: 0,
      saldo_bs: 0,
    };
  }

  return {
    saldo_creditos: toNumberSafe(row.saldo_creditos, 0),
    saldo_bs: toNumberSafe(row.saldo_bs, 0),
  };
}

export async function obtenerMisCreditosService(idUsuario) {
  const rows = await prisma.$queryRaw`
    SELECT saldo_creditos, saldo_bs
    FROM BILLETERA
    WHERE id_usuario = ${idUsuario}
    LIMIT 1
  `;

  return normalizeBilleteraRow(rows[0]);
}

export async function obtenerMisMovimientosService(idUsuario) {
  const rows = await prisma.$queryRaw`
    SELECT m.id_movimiento,
           m.cantidad,
           m.saldo_anterior,
           m.saldo_posterior,
           m.id_referencia,
           m.creado_en,
           tm.nombre AS tipo_movimiento,
           tr.nombre AS tipo_referencia
    FROM MOVIMIENTO_CREDITOS m
    JOIN TIPO_MOVIMIENTO tm ON tm.id_tipo_movimiento = m.id_tipo_movimiento
    JOIN TIPO_REFERENCIA tr ON tr.id_tipo_referencia = m.id_tipo_referencia
    WHERE m.id_usuario = ${idUsuario}
    ORDER BY m.creado_en DESC, m.id_movimiento DESC
  `;

  // si quieres, aquí también podrías normalizar BigInt, pero por ahora lo dejamos
  return rows;
}

export async function comprarCreditosService({
  idUsuario,
  idPaquete,
  idTransaccionPago,
}) {
  // Llamar al SP
  await prisma.$executeRawUnsafe(
    "CALL sp_compra_creditos_aprobar(?, ?, ?)",
    idUsuario,
    idPaquete,
    idTransaccionPago
  );

  const rows = await prisma.$queryRaw`
    SELECT saldo_creditos, saldo_bs
    FROM BILLETERA
    WHERE id_usuario = ${idUsuario}
    LIMIT 1
  `;

  return normalizeBilleteraRow(rows[0]);
}

export async function obtenerMisComprasService(idUsuario) {
  const rows = await prisma.$queryRaw`
    SELECT c.id_compra,
           c.id_paquete,
           p.nombre AS paquete,
           p.cantidad_creditos,
           c.monto_bs,
           c.estado,
           c.id_transaccion_pago,
           c.creado_en
    FROM COMPRA_CREDITOS c
    JOIN PAQUETE_CREDITOS p ON p.id_paquete = c.id_paquete
    WHERE c.id_usuario = ${idUsuario}
    ORDER BY c.creado_en DESC, c.id_compra DESC
  `;
  return rows;
}
</file>

<file path="digital-barder/backend/utils/jsonBigInt.js">
export function toJsonSafe(value) {
  if (typeof value === "bigint") {
    return Number(value);            // <- si prefieres string: value.toString()
  }

  if (Array.isArray(value)) {
    return value.map(toJsonSafe);
  }

  if (value !== null && typeof value === "object") {
    const out = {};
    for (const key in value) {
      out[key] = toJsonSafe(value[key]);
    }
    return out;
  }

  return value;
}
</file>

<file path="digital-barder/docker-compose.yml">
version: "3.9"
services:
  db:
    image: mysql:8.0
    restart: unless-stopped
    environment:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_DATABASE: appdb
    ports:
      - "3306:3306"
    volumes:
      - db_data:/var/lib/mysql
      - ./infra/db/init.sql:/docker-entrypoint-initdb.d/1-init.sql
      - ./infra/db/seed.sql:/docker-entrypoint-initdb.d/2-seed.sql
  backend:
    build: ./backend
    working_dir: /app
    env_file: ./backend/.env
    depends_on:
      - db
    ports:
      - "4000:4000"
    command: sh -c "npx prisma migrate deploy && node src/server.js"
    volumes:
      - ./backend:/app
  frontend:
    build: ./frontend
    working_dir: /app
    ports:
      - "5173:5173"
    environment:
      - VITE_API_URL=http://localhost:4000/api
    command: npm run dev -- --host
    volumes:
      - ./frontend:/app
volumes:
  db_data:
</file>

<file path="digital-barder/frontend/src/App.jsx">
import React from "react";
import AppRouter from "./router.jsx";

export default function App() {
  return <AppRouter />;
}
</file>

<file path="digital-barder/frontend/src/components/Layout.jsx">
import React from "react";
import Navbar from "./Navbar.jsx";

export default function Layout({ children }) {
  return (
    <div className="min-h-screen flex flex-col">
      <Navbar />
      <main className="flex-1 max-w-6xl w-full mx-auto px-4 py-4">
        {children}
      </main>
    </div>
  );
}
</file>

<file path="digital-barder/frontend/src/components/Navbar.jsx">
import React from "react";
import { useNavigate } from "react-router-dom";
import { logout } from "../services/api.js";

export default function Navbar() {
  const navigate = useNavigate();
  const usuarioJson = localStorage.getItem("usuario");
  let usuario = null;

  try {
    usuario = usuarioJson ? JSON.parse(usuarioJson) : null;
  } catch {
    usuario = null;
  }

  const handleLogout = () => {
    logout();
    navigate("/login");
  };

  return (
    <header className="w-full bg-white border-b border-gray-200 px-4 py-2 flex items-center justify-between">
      <div className="flex items-center gap-2">
        <span className="font-bold text-lg text-blue-700">Digital Barter</span>
        <span className="text-xs text-gray-500 hidden sm:inline">
          Panel principal
        </span>
      </div>

      <div className="flex items-center gap-3">
        {usuario && (
          <div className="text-right">
            <p className="text-sm font-medium">
              {usuario.nombre ?? usuario.correo ?? "Usuario"}
            </p>
            <p className="text-xs text-gray-500">
              {usuario.rol ?? "Rol no asignado"}
            </p>
          </div>
        )}
        <button
          type="button"
          onClick={handleLogout}
          className="px-3 py-1 text-xs rounded-md border border-gray-300 hover:bg-gray-100"
        >
          Cerrar sesión
        </button>
      </div>
    </header>
  );
}
</file>

<file path="digital-barder/frontend/src/pages/NotFound.jsx">
import React from "react";
import { Link } from "react-router-dom";

export default function NotFound() {
  return (
    <div className="min-h-screen flex flex-col items-center justify-center bg-gray-100">
      <div className="bg-white px-6 py-5 rounded-lg shadow-sm border border-gray-200 text-center max-w-sm">
        <h1 className="text-3xl font-bold text-gray-900 mb-2">404</h1>
        <p className="text-sm text-gray-500 mb-4">
          La página que buscas no existe.
        </p>
        <Link to="/home" className="btn-primary">
          Volver al inicio
        </Link>
      </div>
    </div>
  );
}
</file>

<file path="digital-barder/frontend/src/pages/ReportesActividadesSostenibles.jsx">
import React, { useEffect, useState } from "react";
import { getReporteActividadesSostenibles } from "../services/api";

function hoyISO() {
  return new Date().toISOString().slice(0, 10);
}

function hace30DiasISO() {
  const d = new Date(Date.now() - 30 * 24 * 60 * 60 * 1000);
  return d.toISOString().slice(0, 10);
}

export default function ReportesActividadesSostenibles() {
  const [desde, setDesde] = useState(hace30DiasISO());
  const [hasta, setHasta] = useState(hoyISO());
  const [datos, setDatos] = useState([]);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState("");

  async function cargar() {
    try {
      setLoading(true);
      setError("");
      const res = await getReporteActividadesSostenibles({ desde, hasta });
      setDatos(Array.isArray(res) ? res : []);
    } catch (e) {
      console.error(e);
      setError("Error cargando actividades sostenibles");
      setDatos([]);
    } finally {
      setLoading(false);
    }
  }

  useEffect(() => {
    cargar();
  }, []);

  function handleSubmit(e) {
    e.preventDefault();
    cargar();
  }

  return (
    <div className="p-4 space-y-6">
      <header className="flex flex-col md:flex-row md:items-end md:justify-between gap-3">
        <div>
          <h1 className="text-2xl font-bold">
            Actividades sostenibles por usuario
          </h1>
          <p className="text-sm text-gray-500">
            Cantidad de actividades y créditos otorgados en el rango.
          </p>
        </div>

        <form
          onSubmit={handleSubmit}
          className="flex flex-wrap gap-2 items-end"
        >
          <div className="flex flex-col text-sm">
            <label className="mb-1 font-medium">Desde</label>
            <input
              type="date"
              value={desde}
              onChange={(e) => setDesde(e.target.value)}
              className="border rounded px-2 py-1 text-sm"
            />
          </div>
          <div className="flex flex-col text-sm">
            <label className="mb-1 font-medium">Hasta</label>
            <input
              type="date"
              value={hasta}
              onChange={(e) => setHasta(e.target.value)}
              className="border rounded px-2 py-1 text-sm"
            />
          </div>
          <button
            type="submit"
            className="bg-emerald-600 text-white px-3 py-1.5 rounded text-sm"
          >
            {loading ? "Cargando…" : "Actualizar"}
          </button>
        </form>
      </header>

      {error && (
        <div className="bg-red-50 border-red-200 border text-red-700 text-sm px-3 py-2 rounded">
          {error}
        </div>
      )}

      <section>
        <div className="overflow-x-auto border rounded bg-white">
          <table className="min-w-full text-sm">
            <thead className="bg-gray-100">
              <tr>
                <th className="px-2 py-1 text-left">Usuario</th>
                <th className="px-2 py-1 text-left">Correo</th>
                <th className="px-2 py-1 text-right">Total actividades</th>
                <th className="px-2 py-1 text-right">Créditos otorgados</th>
              </tr>
            </thead>
            <tbody>
              {datos.map((a, i) => (
                <tr key={i} className="border-t">
                  <td className="px-2 py-1">{a.nombre}</td>
                  <td className="px-2 py-1">{a.correo}</td>
                  <td className="px-2 py-1 text-right">
                    {a.total_actividades}
                  </td>
                  <td className="px-2 py-1 text-right">
                    {a.creditos_otorgados}
                  </td>
                </tr>
              ))}
              {datos.length === 0 && (
                <tr>
                  <td
                    className="px-2 py-2 text-center text-gray-400"
                    colSpan={4}
                  >
                    Sin actividades sostenibles en el rango.
                  </td>
                </tr>
              )}
            </tbody>
          </table>
        </div>
      </section>
    </div>
  );
}
</file>

<file path="digital-barder/frontend/src/pages/ReportesCreditosGeneradosConsumidos.jsx">
import React, { useEffect, useState } from "react";
import { getReporteCreditosGeneradosVsConsumidos } from "../services/api";

function hoyISO() {
  return new Date().toISOString().slice(0, 10);
}

function hace30DiasISO() {
  const d = new Date(Date.now() - 30 * 24 * 60 * 60 * 1000);
  return d.toISOString().slice(0, 10);
}

export default function ReportesCreditosGenerados() {
  const [desde, setDesde] = useState(hace30DiasISO());
  const [hasta, setHasta] = useState(hoyISO());
  const [resumen, setResumen] = useState(null);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState("");

  async function cargar() {
    try {
      setLoading(true);
      setError("");
      const res = await getReporteCreditosGeneradosVsConsumidos({
        desde,
        hasta,
      });
      setResumen(res || null);
    } catch (e) {
      console.error(e);
      setError("Error cargando resumen de créditos");
      setResumen(null);
    } finally {
      setLoading(false);
    }
  }

  useEffect(() => {
    cargar();
  }, []);

  function handleSubmit(e) {
    e.preventDefault();
    cargar();
  }

  return (
    <div className="p-4 space-y-6">
      <header className="flex flex-col md:flex-row md:items-end md:justify-between gap-3">
        <div>
          <h1 className="text-2xl font-bold">
            Créditos generados vs consumidos
          </h1>
          <p className="text-sm text-gray-500">
            Resumen global de créditos emitidos, gastados y saldo neto.
          </p>
        </div>

        <form
          onSubmit={handleSubmit}
          className="flex flex-wrap gap-2 items-end"
        >
          <div className="flex flex-col text-sm">
            <label className="mb-1 font-medium">Desde</label>
            <input
              type="date"
              value={desde}
              onChange={(e) => setDesde(e.target.value)}
              className="border rounded px-2 py-1 text-sm"
            />
          </div>
          <div className="flex flex-col text-sm">
            <label className="mb-1 font-medium">Hasta</label>
            <input
              type="date"
              value={hasta}
              onChange={(e) => setHasta(e.target.value)}
              className="border rounded px-2 py-1 text-sm"
            />
          </div>
          <button
            type="submit"
            className="bg-emerald-600 text-white px-3 py-1.5 rounded text-sm"
          >
            {loading ? "Cargando…" : "Actualizar"}
          </button>
        </form>
      </header>

      {error && (
        <div className="bg-red-50 border-red-200 border text-red-700 text-sm px-3 py-2 rounded">
          {error}
        </div>
      )}

      <section className="border rounded p-4 bg-white text-sm">
        {resumen ? (
          <ul className="space-y-1">
            <li>
              <span className="font-semibold">Créditos generados:</span>{" "}
              {resumen.creditos_generados}
            </li>
            <li>
              <span className="font-semibold">Créditos consumidos:</span>{" "}
              {resumen.creditos_consumidos}
            </li>
            <li>
              <span className="font-semibold">Saldo neto:</span>{" "}
              {resumen.saldo_neto}
            </li>
          </ul>
        ) : (
          <p className="text-gray-500">
            Sin datos de créditos generados/consumidos para el rango.
          </p>
        )}
      </section>
    </div>
  );
}
</file>

<file path="digital-barder/frontend/src/pages/ReportesImpactoAcumulado.jsx">
import React, { useState } from "react";
import { getReporteImpactoAcumulado } from "../services/api";

export default function ReportesImpactoAcumulado() {
  const [tipoReporte, setTipoReporte] = useState("1"); // 1=Mensual
  const [idPeriodo, setIdPeriodo] = useState("1");
  const [datos, setDatos] = useState([]);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState("");

  async function cargar() {
    try {
      setLoading(true);
      setError("");
      const res = await getReporteImpactoAcumulado({
        idTipoReporte: tipoReporte,
        idPeriodo,
      });
      setDatos(Array.isArray(res) ? res : []);
    } catch (e) {
      console.error(e);
      setError("Error cargando impacto acumulado");
      setDatos([]);
    } finally {
      setLoading(false);
    }
  }

  return (
    <div className="p-4 space-y-6">
      <header className="flex flex-col md:flex-row md:items-end md:justify-between gap-3">
        <div>
          <h1 className="text-2xl font-bold">Impacto ambiental acumulado</h1>
          <p className="text-sm text-gray-500">
            Datos provenientes de la tabla REPORTE_IMPACTO (por período).
          </p>
        </div>

        <div className="flex flex-wrap gap-2 items-end text-sm">
          <div className="flex flex-col">
            <label className="mb-1 font-medium">Tipo de reporte</label>
            <select
              value={tipoReporte}
              onChange={(e) => setTipoReporte(e.target.value)}
              className="border rounded px-2 py-1 text-sm"
            >
              <option value="1">Mensual</option>
              <option value="2">Diario</option>
              <option value="3">Anual</option>
            </select>
          </div>

          <div className="flex flex-col">
            <label className="mb-1 font-medium">ID período</label>
            <input
              type="number"
              min="1"
              value={idPeriodo}
              onChange={(e) => setIdPeriodo(e.target.value)}
              className="border rounded px-2 py-1 text-sm w-24"
            />
          </div>

          <button
            type="button"
            onClick={cargar}
            className="bg-emerald-600 text-white px-3 py-1.5 rounded text-sm"
          >
            {loading ? "Cargando…" : "Actualizar"}
          </button>
        </div>
      </header>

      {error && (
        <div className="bg-red-50 border-red-200 border text-red-700 text-sm px-3 py-2 rounded">
          {error}
        </div>
      )}

      <section>
        <div className="overflow-x-auto border rounded bg-white">
          <table className="min-w-full text-sm">
            <thead className="bg-gray-100">
              <tr>
                <th className="px-2 py-1 text-left">Usuario (ID)</th>
                <th className="px-2 py-1 text-right">CO₂ total (kg)</th>
                <th className="px-2 py-1 text-right">Agua total (L)</th>
                <th className="px-2 py-1 text-right">Energía total (kWh)</th>
                <th className="px-2 py-1 text-right">Transacciones</th>
                <th className="px-2 py-1 text-right">Usuarios activos</th>
              </tr>
            </thead>
            <tbody>
              {datos.map((r, i) => (
                <tr key={i} className="border-t">
                  <td className="px-2 py-1">{r.id_usuario ?? "GLOBAL"}</td>
                  <td className="px-2 py-1 text-right">
                    {r.total_co2_ahorrado}
                  </td>
                  <td className="px-2 py-1 text-right">
                    {r.total_agua_ahorrada}
                  </td>
                  <td className="px-2 py-1 text-right">
                    {r.total_energia_ahorrada}
                  </td>
                  <td className="px-2 py-1 text-right">
                    {r.total_transacciones}
                  </td>
                  <td className="px-2 py-1 text-right">
                    {r.total_usuarios_activos}
                  </td>
                </tr>
              ))}
              {datos.length === 0 && (
                <tr>
                  <td
                    className="px-2 py-2 text-center text-gray-400"
                    colSpan={6}
                  >
                    Sin datos en REPORTE_IMPACTO para ese período.
                  </td>
                </tr>
              )}
            </tbody>
          </table>
        </div>
      </section>
    </div>
  );
}
</file>

<file path="digital-barder/frontend/src/pages/ReportesImpactoCategoria.jsx">
import React, { useState } from "react";
import { getReporteImpactoPorCategoria } from "../services/api";

export default function ReportesImpactoCategoria() {
  const [idPeriodo, setIdPeriodo] = useState("1");
  const [datos, setDatos] = useState([]);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState("");

  async function cargar() {
    try {
      setLoading(true);
      setError("");
      const res = await getReporteImpactoPorCategoria({ idPeriodo });
      setDatos(Array.isArray(res) ? res : []);
    } catch (e) {
      console.error(e);
      setError("Error cargando impacto por categoría");
      setDatos([]);
    } finally {
      setLoading(false);
    }
  }

  return (
    <div className="p-4 space-y-6">
      <header className="flex flex-col md:flex-row md:items-end md:justify-between gap-3">
        <div>
          <h1 className="text-2xl font-bold">
            Impacto ambiental por categoría
          </h1>
          <p className="text-sm text-gray-500">
            Suma de CO₂, agua y energía ahorrada por cada categoría (tabla
            IMPACTO_AMBIENTAL).
          </p>
        </div>

        <div className="flex flex-wrap gap-2 items-end text-sm">
          <div className="flex flex-col">
            <label className="mb-1 font-medium">ID período</label>
            <input
              type="number"
              min="1"
              value={idPeriodo}
              onChange={(e) => setIdPeriodo(e.target.value)}
              className="border rounded px-2 py-1 text-sm w-24"
            />
          </div>
          <button
            type="button"
            onClick={cargar}
            className="bg-emerald-600 text-white px-3 py-1.5 rounded text-sm"
          >
            {loading ? "Cargando…" : "Actualizar"}
          </button>
        </div>
      </header>

      {error && (
        <div className="bg-red-50 border-red-200 border text-red-700 text-sm px-3 py-2 rounded">
          {error}
        </div>
      )}

      <section>
        <div className="overflow-x-auto border rounded bg-white">
          <table className="min-w-full text-sm">
            <thead className="bg-gray-100">
              <tr>
                <th className="px-2 py-1 text-left">Categoría</th>
                <th className="px-2 py-1 text-right">CO₂ total (kg)</th>
                <th className="px-2 py-1 text-right">Agua total (L)</th>
                <th className="px-2 py-1 text-right">Energía total (kWh)</th>
              </tr>
            </thead>
            <tbody>
              {datos.map((c, i) => (
                <tr key={i} className="border-t">
                  <td className="px-2 py-1">{c.categoria}</td>
                  <td className="px-2 py-1 text-right">{c.co2_total}</td>
                  <td className="px-2 py-1 text-right">{c.agua_total}</td>
                  <td className="px-2 py-1 text-right">{c.energia_total}</td>
                </tr>
              ))}
              {datos.length === 0 && (
                <tr>
                  <td
                    className="px-2 py-2 text-center text-gray-400"
                    colSpan={4}
                  >
                    Sin impacto registrado para ese período.
                  </td>
                </tr>
              )}
            </tbody>
          </table>
        </div>
      </section>
    </div>
  );
}
</file>

<file path="digital-barder/frontend/src/pages/ReportesIngresosCreditos.jsx">
import React, { useEffect, useState } from "react";
import { getReporteIngresosCreditos } from "../services/api";

function hoyISO() {
  return new Date().toISOString().slice(0, 10);
}

function hace30DiasISO() {
  const d = new Date(Date.now() - 30 * 24 * 60 * 60 * 1000);
  return d.toISOString().slice(0, 10);
}

export default function ReportesIngresosCreditos() {
  const [desde, setDesde] = useState(hace30DiasISO());
  const [hasta, setHasta] = useState(hoyISO());
  const [datos, setDatos] = useState([]);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState("");

  async function cargar() {
    try {
      setLoading(true);
      setError("");
      const res = await getReporteIngresosCreditos({ desde, hasta });
      setDatos(Array.isArray(res) ? res : []);
    } catch (e) {
      console.error(e);
      setError("Error cargando ingresos por créditos");
      setDatos([]);
    } finally {
      setLoading(false);
    }
  }

  useEffect(() => {
    cargar();
  }, []);

  function handleSubmit(e) {
    e.preventDefault();
    cargar();
  }

  return (
    <div className="p-4 space-y-6">
      <header className="flex flex-col md:flex-row md:items-end md:justify-between gap-3">
        <div>
          <h1 className="text-2xl font-bold">Ingresos por venta de créditos</h1>
          <p className="text-sm text-gray-500">
            Créditos vendidos y monto recaudado por día.
          </p>
        </div>

        <form
          onSubmit={handleSubmit}
          className="flex flex-wrap gap-2 items-end"
        >
          <div className="flex flex-col text-sm">
            <label className="mb-1 font-medium">Desde</label>
            <input
              type="date"
              value={desde}
              onChange={(e) => setDesde(e.target.value)}
              className="border rounded px-2 py-1 text-sm"
            />
          </div>
          <div className="flex flex-col text-sm">
            <label className="mb-1 font-medium">Hasta</label>
            <input
              type="date"
              value={hasta}
              onChange={(e) => setHasta(e.target.value)}
              className="border rounded px-2 py-1 text-sm"
            />
          </div>
          <button
            type="submit"
            className="bg-emerald-600 text-white px-3 py-1.5 rounded text-sm"
          >
            {loading ? "Cargando…" : "Actualizar"}
          </button>
        </form>
      </header>

      {error && (
        <div className="bg-red-50 border-red-200 border text-red-700 text-sm px-3 py-2 rounded">
          {error}
        </div>
      )}

      <section>
        <div className="overflow-x-auto border rounded bg-white">
          <table className="min-w-full text-sm">
            <thead className="bg-gray-100">
              <tr>
                <th className="px-2 py-1 text-left">Fecha</th>
                <th className="px-2 py-1 text-right">Créditos</th>
                <th className="px-2 py-1 text-right">Monto (Bs)</th>
              </tr>
            </thead>
            <tbody>
              {datos.map((r, i) => (
                <tr key={i} className="border-t">
                  <td className="px-2 py-1">{r.fecha}</td>
                  <td className="px-2 py-1 text-right">{r.total_creditos}</td>
                  <td className="px-2 py-1 text-right">{r.total_bs}</td>
                </tr>
              ))}
              {datos.length === 0 && (
                <tr>
                  <td
                    className="px-2 py-2 text-center text-gray-400"
                    colSpan={3}
                  >
                    Sin compras de créditos en el rango.
                  </td>
                </tr>
              )}
            </tbody>
          </table>
        </div>
      </section>
    </div>
  );
}
</file>

<file path="digital-barder/frontend/src/pages/ReportesIntercambiosCategoria.jsx">
import React, { useEffect, useState } from "react";
import { getReporteIntercambiosCategoria } from "../services/api";

function hoyISO() {
  return new Date().toISOString().slice(0, 10);
}

function hace30DiasISO() {
  const d = new Date(Date.now() - 30 * 24 * 60 * 60 * 1000);
  return d.toISOString().slice(0, 10);
}

export default function ReportesIntercambiosCategoria() {
  const [desde, setDesde] = useState(hace30DiasISO());
  const [hasta, setHasta] = useState(hoyISO());
  const [datos, setDatos] = useState([]);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState("");

  async function cargar() {
    try {
      setLoading(true);
      setError("");
      const res = await getReporteIntercambiosCategoria({ desde, hasta });
      setDatos(Array.isArray(res) ? res : []);
    } catch (e) {
      console.error(e);
      setError("Error cargando intercambios por categoría");
      setDatos([]);
    } finally {
      setLoading(false);
    }
  }

  useEffect(() => {
    cargar();
  }, []);

  function handleSubmit(e) {
    e.preventDefault();
    cargar();
  }

  return (
    <div className="p-4 space-y-6">
      <header className="flex flex-col md:flex-row md:items-end md:justify-between gap-3">
        <div>
          <h1 className="text-2xl font-bold">Intercambios por categoría</h1>
          <p className="text-sm text-gray-500">
            Número de intercambios agrupados por categoría de publicación.
          </p>
        </div>

        <form
          onSubmit={handleSubmit}
          className="flex flex-wrap gap-2 items-end"
        >
          <div className="flex flex-col text-sm">
            <label className="mb-1 font-medium">Desde</label>
            <input
              type="date"
              value={desde}
              onChange={(e) => setDesde(e.target.value)}
              className="border rounded px-2 py-1 text-sm"
            />
          </div>
          <div className="flex flex-col text-sm">
            <label className="mb-1 font-medium">Hasta</label>
            <input
              type="date"
              value={hasta}
              onChange={(e) => setHasta(e.target.value)}
              className="border rounded px-2 py-1 text-sm"
            />
          </div>
          <button
            type="submit"
            className="bg-emerald-600 text-white px-3 py-1.5 rounded text-sm"
          >
            {loading ? "Cargando…" : "Actualizar"}
          </button>
        </form>
      </header>

      {error && (
        <div className="bg-red-50 border-red-200 border text-red-700 text-sm px-3 py-2 rounded">
          {error}
        </div>
      )}

      <section>
        <div className="overflow-x-auto border rounded bg-white">
          <table className="min-w-full text-sm">
            <thead className="bg-gray-100">
              <tr>
                <th className="px-2 py-1 text-left">Categoría</th>
                <th className="px-2 py-1 text-right">Intercambios</th>
              </tr>
            </thead>
            <tbody>
              {datos.map((c, i) => (
                <tr key={i} className="border-t">
                  <td className="px-2 py-1">{c.categoria}</td>
                  <td className="px-2 py-1 text-right">
                    {c.total_intercambios}
                  </td>
                </tr>
              ))}
              {datos.length === 0 && (
                <tr>
                  <td
                    className="px-2 py-2 text-center text-gray-400"
                    colSpan={2}
                  >
                    No hay intercambios en el rango.
                  </td>
                </tr>
              )}
            </tbody>
          </table>
        </div>
      </section>
    </div>
  );
}
</file>

<file path="digital-barder/frontend/src/pages/ReportesPublicacionesVsIntercambios.jsx">
import React, { useEffect, useState } from "react";
import { getReportePublicacionesVsIntercambios } from "../services/api";

function hoyISO() {
  return new Date().toISOString().slice(0, 10);
}

function hace30DiasISO() {
  const d = new Date(Date.now() - 30 * 24 * 60 * 60 * 1000);
  return d.toISOString().slice(0, 10);
}

export default function ReportesPublicacionesIntercambios() {
  const [desde, setDesde] = useState(hace30DiasISO());
  const [hasta, setHasta] = useState(hoyISO());
  const [datos, setDatos] = useState([]);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState("");

  async function cargar() {
    try {
      setLoading(true);
      setError("");
      const res = await getReportePublicacionesVsIntercambios({
        desde,
        hasta,
      });
      setDatos(Array.isArray(res) ? res : []);
    } catch (e) {
      console.error(e);
      setError("Error cargando publicaciones vs intercambios");
      setDatos([]);
    } finally {
      setLoading(false);
    }
  }

  useEffect(() => {
    cargar();
  }, []);

  function handleSubmit(e) {
    e.preventDefault();
    cargar();
  }

  return (
    <div className="p-4 space-y-6">
      <header className="flex flex-col md:flex-row md:items-end md:justify-between gap-3">
        <div>
          <h1 className="text-2xl font-bold">
            Publicaciones vs intercambios por categoría
          </h1>
          <p className="text-sm text-gray-500">
            Relación entre publicaciones creadas y las que se concretan como
            intercambio.
          </p>
        </div>

        <form
          onSubmit={handleSubmit}
          className="flex flex-wrap gap-2 items-end"
        >
          <div className="flex flex-col text-sm">
            <label className="mb-1 font-medium">Desde</label>
            <input
              type="date"
              value={desde}
              onChange={(e) => setDesde(e.target.value)}
              className="border rounded px-2 py-1 text-sm"
            />
          </div>
          <div className="flex flex-col text-sm">
            <label className="mb-1 font-medium">Hasta</label>
            <input
              type="date"
              value={hasta}
              onChange={(e) => setHasta(e.target.value)}
              className="border rounded px-2 py-1 text-sm"
            />
          </div>
          <button
            type="submit"
            className="bg-emerald-600 text-white px-3 py-1.5 rounded text-sm"
          >
            {loading ? "Cargando…" : "Actualizar"}
          </button>
        </form>
      </header>

      {error && (
        <div className="bg-red-50 border-red-200 border text-red-700 text-sm px-3 py-2 rounded">
          {error}
        </div>
      )}

      <section>
        <div className="overflow-x-auto border rounded bg-white">
          <table className="min-w-full text-sm">
            <thead className="bg-gray-100">
              <tr>
                <th className="px-2 py-1 text-left">Categoría</th>
                <th className="px-2 py-1 text-right">Publicaciones</th>
                <th className="px-2 py-1 text-right">Intercambios</th>
                <th className="px-2 py-1 text-right">Ratio</th>
              </tr>
            </thead>
            <tbody>
              {datos.map((p, i) => (
                <tr key={i} className="border-t">
                  <td className="px-2 py-1">{p.categoria}</td>
                  <td className="px-2 py-1 text-right">{p.publicaciones}</td>
                  <td className="px-2 py-1 text-right">{p.intercambios}</td>
                  <td className="px-2 py-1 text-right">
                    {p.ratio_intercambio ?? "-"}
                  </td>
                </tr>
              ))}
              {datos.length === 0 && (
                <tr>
                  <td
                    className="px-2 py-2 text-center text-gray-400"
                    colSpan={4}
                  >
                    Sin datos para el rango.
                  </td>
                </tr>
              )}
            </tbody>
          </table>
        </div>
      </section>
    </div>
  );
}
</file>

<file path="digital-barder/frontend/src/pages/ReportesRankingUsuarios.jsx">
import React, { useState } from "react";
import { getReporteRankingUsuarios } from "../services/api";

export default function ReportesRankingUsuarios() {
  const [idPeriodo, setIdPeriodo] = useState("");
  const [limit, setLimit] = useState(10);
  const [datos, setDatos] = useState([]);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState("");

  async function cargar() {
    try {
      setLoading(true);
      setError("");
      const res = await getReporteRankingUsuarios({ idPeriodo, limit });
      setDatos(Array.isArray(res) ? res : []);
    } catch (e) {
      console.error(e);
      setError("Error cargando ranking de usuarios");
      setDatos([]);
    } finally {
      setLoading(false);
    }
  }

  return (
    <div className="p-4 space-y-6">
      <header className="flex flex-col md:flex-row md:items-end md:justify-between gap-3">
        <div>
          <h1 className="text-2xl font-bold">Ranking de usuarios por impacto</h1>
          <p className="text-sm text-gray-500">
            Usuarios ordenados por impacto ambiental (CO₂, agua, energía).
          </p>
        </div>

        <div className="flex flex-wrap gap-2 items-end text-sm">
          <div className="flex flex-col">
            <label className="mb-1 font-medium">ID período (opcional)</label>
            <input
              type="number"
              min="1"
              value={idPeriodo}
              onChange={(e) => setIdPeriodo(e.target.value)}
              className="border rounded px-2 py-1 text-sm w-24"
              placeholder="ej. 1"
            />
          </div>
          <div className="flex flex-col">
            <label className="mb-1 font-medium">Top N</label>
            <input
              type="number"
              min="1"
              value={limit}
              onChange={(e) => setLimit(Number(e.target.value))}
              className="border rounded px-2 py-1 text-sm w-20"
            />
          </div>
          <button
            type="button"
            onClick={cargar}
            className="bg-emerald-600 text-white px-3 py-1.5 rounded text-sm"
          >
            {loading ? "Cargando…" : "Actualizar"}
          </button>
        </div>
      </header>

      {error && (
        <div className="bg-red-50 border-red-200 border text-red-700 text-sm px-3 py-2 rounded">
          {error}
        </div>
      )}

      <section>
        <div className="overflow-x-auto border rounded bg-white">
          <table className="min-w-full text-sm">
            <thead className="bg-gray-100">
              <tr>
                <th className="px-2 py-1 text-left">Usuario (ID)</th>
                <th className="px-2 py-1 text-right">CO₂ total (kg)</th>
                <th className="px-2 py-1 text-right">Agua total (L)</th>
                <th className="px-2 py-1 text-right">Energía total (kWh)</th>
                <th className="px-2 py-1 text-right">Transacciones</th>
              </tr>
            </thead>
            <tbody>
              {datos.map((r, i) => (
                <tr key={i} className="border-t">
                  <td className="px-2 py-1">{r.id_usuario}</td>
                  <td className="px-2 py-1 text-right">{r.co2_total}</td>
                  <td className="px-2 py-1 text-right">{r.agua_total}</td>
                  <td className="px-2 py-1 text-right">{r.energia_total}</td>
                  <td className="px-2 py-1 text-right">{r.transacciones}</td>
                </tr>
              ))}
              {datos.length === 0 && (
                <tr>
                  <td
                    className="px-2 py-2 text-center text-gray-400"
                    colSpan={5}
                  >
                    Sin datos de ranking para los filtros actuales.
                  </td>
                </tr>
              )}
            </tbody>
          </table>
        </div>
      </section>
    </div>
  );
}
</file>

<file path="digital-barder/frontend/src/pages/ReportesSaldosUsuarios.jsx">
import React, { useEffect, useState } from "react";
import { getReporteSaldosUsuarios } from "../services/api";

export default function ReportesSaldosUsuarios() {
  const [limit, setLimit] = useState(20);
  const [datos, setDatos] = useState([]);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState("");

  async function cargar() {
    try {
      setLoading(true);
      setError("");
      const res = await getReporteSaldosUsuarios({ limit });
      setDatos(Array.isArray(res) ? res : []);
    } catch (e) {
      console.error(e);
      setError("Error cargando saldos de usuarios");
      setDatos([]);
    } finally {
      setLoading(false);
    }
  }

  useEffect(() => {
    cargar();
  }, []);

  return (
    <div className="p-4 space-y-6">
      <header className="flex flex-col md:flex-row md:items-end md:justify-between gap-3">
        <div>
          <h1 className="text-2xl font-bold">Saldos de créditos por usuario</h1>
          <p className="text-sm text-gray-500">
            Top de usuarios con mayor saldo en su billetera.
          </p>
        </div>

        <div className="flex flex-wrap gap-2 items-end text-sm">
          <div className="flex flex-col">
            <label className="mb-1 font-medium">Top N</label>
            <input
              type="number"
              min="1"
              value={limit}
              onChange={(e) => setLimit(Number(e.target.value))}
              className="border rounded px-2 py-1 text-sm w-20"
            />
          </div>
          <button
            type="button"
            onClick={cargar}
            className="bg-emerald-600 text-white px-3 py-1.5 rounded text-sm"
          >
            {loading ? "Cargando…" : "Actualizar"}
          </button>
        </div>
      </header>

      {error && (
        <div className="bg-red-50 border-red-200 border text-red-700 text-sm px-3 py-2 rounded">
          {error}
        </div>
      )}

      <section>
        <div className="overflow-x-auto border rounded bg-white">
          <table className="min-w-full text-sm">
            <thead className="bg-gray-100">
              <tr>
                <th className="px-2 py-1 text-left">Usuario</th>
                <th className="px-2 py-1 text-left">Correo</th>
                <th className="px-2 py-1 text-right">Saldo créditos</th>
              </tr>
            </thead>
            <tbody>
              {datos.map((u, i) => (
                <tr key={i} className="border-t">
                  <td className="px-2 py-1">{u.nombre}</td>
                  <td className="px-2 py-1">{u.correo}</td>
                  <td className="px-2 py-1 text-right">
                    {u.saldo_creditos}
                  </td>
                </tr>
              ))}
              {datos.length === 0 && (
                <tr>
                  <td
                    className="px-2 py-2 text-center text-gray-400"
                    colSpan={3}
                  >
                    Sin datos de saldos para mostrar.
                  </td>
                </tr>
              )}
            </tbody>
          </table>
        </div>
      </section>
    </div>
  );
}
</file>

<file path="digital-barder/frontend/src/pages/ReportesUsuarios.jsx">
import React, { useEffect, useState } from "react";
import {
  getReporteUsuariosActivos,
  getReporteUsuariosAbandonados,
  getReporteUsuariosNuevos,
} from "../services/api";

function hoyISO() {
  return new Date().toISOString().slice(0, 10);
}

function hace30DiasISO() {
  const d = new Date(Date.now() - 30 * 24 * 60 * 60 * 1000);
  return d.toISOString().slice(0, 10);
}

export default function ReportesUsuarios() {
  const [desde, setDesde] = useState(hace30DiasISO());
  const [hasta, setHasta] = useState(hoyISO());

  const [activos, setActivos] = useState([]);
  const [abandonados, setAbandonados] = useState([]);
  const [nuevos, setNuevos] = useState([]);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState("");

  async function cargar() {
    try {
      setLoading(true);
      setError("");
      const [a, b, n] = await Promise.all([
        getReporteUsuariosActivos({ desde, hasta }),
        getReporteUsuariosAbandonados({ desde, hasta }),
        getReporteUsuariosNuevos({ desde, hasta }),
      ]);
      setActivos(Array.isArray(a) ? a : []);
      setAbandonados(Array.isArray(b) ? b : []);
      setNuevos(Array.isArray(n) ? n : []);
    } catch (e) {
      console.error(e);
      setError("Error cargando reportes de usuarios");
      setActivos([]);
      setAbandonados([]);
      setNuevos([]);
    } finally {
      setLoading(false);
    }
  }

  useEffect(() => {
    cargar();
  }, []);

  function handleSubmit(e) {
    e.preventDefault();
    cargar();
  }

  return (
    <div className="p-4 space-y-6">
      <header className="flex flex-col md:flex-row md:items-end md:justify-between gap-3">
        <div>
          <h1 className="text-2xl font-bold">Reporte de usuarios</h1>
          <p className="text-sm text-gray-500">
            Usuarios activos, abandonados y nuevos (primer login).
          </p>
        </div>

        <form
          onSubmit={handleSubmit}
          className="flex flex-wrap gap-2 items-end"
        >
          <div className="flex flex-col text-sm">
            <label className="mb-1 font-medium">Desde</label>
            <input
              type="date"
              value={desde}
              onChange={(e) => setDesde(e.target.value)}
              className="border rounded px-2 py-1 text-sm"
            />
          </div>
          <div className="flex flex-col text-sm">
            <label className="mb-1 font-medium">Hasta</label>
            <input
              type="date"
              value={hasta}
              onChange={(e) => setHasta(e.target.value)}
              className="border rounded px-2 py-1 text-sm"
            />
          </div>
          <button
            type="submit"
            className="bg-emerald-600 text-white px-3 py-1.5 rounded text-sm"
          >
            {loading ? "Cargando…" : "Actualizar"}
          </button>
        </form>
      </header>

      {error && (
        <div className="bg-red-50 border border-red-200 text-red-700 text-sm px-3 py-2 rounded">
          {error}
        </div>
      )}

      {/* Usuarios activos */}
      <section className="space-y-2">
        <h2 className="font-semibold">Usuarios activos ({activos.length})</h2>
        <div className="overflow-x-auto border rounded bg-white">
          <table className="min-w-full text-xs">
            <thead className="bg-gray-100">
              <tr>
                <th className="px-2 py-1 text-left">Usuario</th>
                <th className="px-2 py-1 text-left">Correo</th>
                <th className="px-2 py-1 text-right">Primera actividad</th>
                <th className="px-2 py-1 text-right">Última actividad</th>
                <th className="px-2 py-1 text-right">Total acciones</th>
              </tr>
            </thead>
            <tbody>
              {activos.map((u, i) => (
                <tr key={i} className="border-t">
                  <td className="px-2 py-1">{u.nombre}</td>
                  <td className="px-2 py-1">{u.correo}</td>
                  <td className="px-2 py-1 text-right">
                    {u.primera_actividad || "-"}
                  </td>
                  <td className="px-2 py-1 text-right">
                    {u.ultima_actividad || "-"}
                  </td>
                  <td className="px-2 py-1 text-right">{u.total_acciones}</td>
                </tr>
              ))}
              {activos.length === 0 && (
                <tr>
                  <td
                    className="px-2 py-2 text-center text-gray-400"
                    colSpan={5}
                  >
                    Sin datos en el rango.
                  </td>
                </tr>
              )}
            </tbody>
          </table>
        </div>
      </section>

      {/* Usuarios abandonados */}
      <section className="space-y-2">
        <h2 className="font-semibold">
          Usuarios abandonados ({abandonados.length})
        </h2>
        <div className="overflow-x-auto border rounded bg-white">
          <table className="min-w-full text-xs">
            <thead className="bg-gray-100">
              <tr>
                <th className="px-2 py-1 text-left">Usuario</th>
                <th className="px-2 py-1 text-left">Correo</th>
                <th className="px-2 py-1 text-right">Estado</th>
              </tr>
            </thead>
            <tbody>
              {abandonados.map((u, i) => (
                <tr key={i} className="border-t">
                  <td className="px-2 py-1">{u.nombre}</td>
                  <td className="px-2 py-1">{u.correo}</td>
                  <td className="px-2 py-1 text-right">{u.estado}</td>
                </tr>
              ))}
              {abandonados.length === 0 && (
                <tr>
                  <td
                    className="px-2 py-2 text-center text-gray-400"
                    colSpan={3}
                  >
                    Sin datos en el rango.
                  </td>
                </tr>
              )}
            </tbody>
          </table>
        </div>
      </section>

      {/* Usuarios nuevos (primer login) */}
      <section className="space-y-2">
        <h2 className="font-semibold">
          Usuarios nuevos (primer login) ({nuevos.length})
        </h2>
        <div className="overflow-x-auto border rounded bg-white">
          <table className="min-w-full text-xs">
            <thead className="bg-gray-100">
              <tr>
                <th className="px-2 py-1 text-left">Usuario</th>
                <th className="px-2 py-1 text-left">Correo</th>
                <th className="px-2 py-1 text-right">Fecha primer login</th>
              </tr>
            </thead>
            <tbody>
              {nuevos.map((u, i) => (
                <tr key={i} className="border-t">
                  <td className="px-2 py-1">{u.nombre}</td>
                  <td className="px-2 py-1">{u.correo}</td>
                  <td className="px-2 py-1 text-right">
                    {u.fecha_primer_login}
                  </td>
                </tr>
              ))}
              {nuevos.length === 0 && (
                <tr>
                  <td
                    className="px-2 py-2 text-center text-gray-400"
                    colSpan={3}
                  >
                    Sin usuarios nuevos en el rango.
                  </td>
                </tr>
              )}
            </tbody>
          </table>
        </div>
      </section>
    </div>
  );
}
</file>

<file path="digital-barder/frontend/src/pages/ReportesUsuariosPremium.jsx">
import React, { useEffect, useState } from "react";
import { getReporteUsuariosPremium } from "../services/api";

function hoyISO() {
  return new Date().toISOString().slice(0, 10);
}

function hace30DiasISO() {
  const d = new Date(Date.now() - 30 * 24 * 60 * 60 * 1000);
  return d.toISOString().slice(0, 10);
}

export default function ReportesUsuariosPremium() {
  const [desde, setDesde] = useState(hace30DiasISO());
  const [hasta, setHasta] = useState(hoyISO());
  const [datos, setDatos] = useState([]);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState("");

  async function cargar() {
    try {
      setLoading(true);
      setError("");
      const res = await getReporteUsuariosPremium({ desde, hasta });
      setDatos(Array.isArray(res) ? res : []);
    } catch (e) {
      console.error(e);
      setError("Error cargando reporte de usuarios premium");
      setDatos([]);
    } finally {
      setLoading(false);
    }
  }

  useEffect(() => {
    cargar();
  }, []);

  function handleSubmit(e) {
    e.preventDefault();
    cargar();
  }

  return (
    <div className="p-4 space-y-6">
      <header className="flex flex-col md:flex-row md:items-end md:justify-between gap-3">
        <div>
          <h1 className="text-2xl font-bold">Usuarios premium</h1>
          <p className="text-sm text-gray-500">
            Adopción del plan premium e ingresos por suscripción.
          </p>
        </div>

        <form
          onSubmit={handleSubmit}
          className="flex flex-wrap gap-2 items-end"
        >
          <div className="flex flex-col text-sm">
            <label className="mb-1 font-medium">Desde</label>
            <input
              type="date"
              value={desde}
              onChange={(e) => setDesde(e.target.value)}
              className="border rounded px-2 py-1 text-sm"
            />
          </div>
          <div className="flex flex-col text-sm">
            <label className="mb-1 font-medium">Hasta</label>
            <input
              type="date"
              value={hasta}
              onChange={(e) => setHasta(e.target.value)}
              className="border rounded px-2 py-1 text-sm"
            />
          </div>
          <button
            type="submit"
            className="bg-emerald-600 text-white px-3 py-1.5 rounded text-sm"
          >
            {loading ? "Cargando…" : "Actualizar"}
          </button>
        </form>
      </header>

      {error && (
        <div className="bg-red-50 border-red-200 border text-red-700 text-sm px-3 py-2 rounded">
          {error}
        </div>
      )}

      <section>
        <div className="overflow-x-auto border rounded bg-white">
          <table className="min-w-full text-sm">
            <thead className="bg-gray-100">
              <tr>
                <th className="px-2 py-1 text-left">Desde</th>
                <th className="px-2 py-1 text-left">Hasta</th>
                <th className="px-2 py-1 text-right">Usuarios activos</th>
                <th className="px-2 py-1 text-right">Nuevos premium</th>
                <th className="px-2 py-1 text-right">Premium activos</th>
                <th className="px-2 py-1 text-right">Ingresos (Bs)</th>
                <th className="px-2 py-1 text-right">% adopción</th>
              </tr>
            </thead>
            <tbody>
              {datos.map((r, i) => (
                <tr key={i} className="border-t">
                  <td className="px-2 py-1">{r.desde}</td>
                  <td className="px-2 py-1">{r.hasta}</td>
                  <td className="px-2 py-1 text-right">
                    {r.total_usuarios_activos}
                  </td>
                  <td className="px-2 py-1 text-right">
                    {r.usuarios_nuevos_premium}
                  </td>
                  <td className="px-2 py-1 text-right">
                    {r.usuarios_premium_activos}
                  </td>
                  <td className="px-2 py-1 text-right">
                    {r.ingresos_suscripcion_bs}
                  </td>
                  <td className="px-2 py-1 text-right">
                    {r.porcentaje_adopcion_premium}%
                  </td>
                </tr>
              ))}
              {datos.length === 0 && (
                <tr>
                  <td
                    className="px-2 py-2 text-center text-gray-400"
                    colSpan={7}
                  >
                    Sin datos de suscripciones premium en el rango.
                  </td>
                </tr>
              )}
            </tbody>
          </table>
        </div>
      </section>
    </div>
  );
}
</file>

<file path="digital-barder/package.json">
{
  "name": "iu-db-monorepo",
  "private": true,
  "version": "0.1.0",
  "scripts": {
    "dev": "npm-run-all --parallel dev:front dev:back",
    "dev:front": "npm --prefix frontend run dev",
    "dev:back": "npm --prefix backend run dev",
    "build": "npm-run-all build:front build:back",
    "build:front": "npm --prefix frontend run build",
    "build:back": "npm --prefix backend run build",
    "db:migrate": "npm --prefix backend run prisma:migrate",
    "db:seed": "npm --prefix backend run prisma:seed"
  },
  "devDependencies": {
    "npm-run-all": "^4.1.5"
  }
}
</file>

<file path="digital-barder/README.md">
# Monorepo: UI + API + DB (React + Vite + Tailwind / Node + Express + Prisma / MySQL)

## Dev rápido
```bash
# en la raíz
npm install
npm run dev
```

## Requisitos
- Node 18+
- Docker (opcional para DB)

## Estructura
- `frontend/` React + Vite + Tailwind
- `backend/`  Node + Express + Prisma (MySQL)
- `infra/db/` SQL de init y seeds
</file>

<file path="README.md">
# tbd-2-2025
base de datos de taller de base de datos
</file>

<file path="base de datos/Poblado_de_Datos_German.sql">
use creditos_verdes2;

-- POBLAR LA BD

-- FUNCION QUE GENERA STRINGS ALEATORIOS
DROP FUNCTION IF EXISTS rand_str;
DELIMITER $$
CREATE FUNCTION rand_str(n INT)
RETURNS VARCHAR(255)
DETERMINISTIC
BEGIN
  DECLARE chars VARCHAR(80) DEFAULT 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ';
  DECLARE outp VARCHAR(255) DEFAULT '';
  DECLARE i INT DEFAULT 0;
  WHILE i < n DO
    SET outp = CONCAT(outp, SUBSTRING(chars, FLOOR(1 + RAND()*52), 1));
    SET i = i + 1;
  END WHILE;
  RETURN outp;
END$$
DELIMITER ;

-- PROCEDIMIENTO QUE CREARA 500 USUARIOS + BILLETERAS
DELIMITER $$
CREATE PROCEDURE poblar_usuarios()
BEGIN
  DECLARE i INT DEFAULT 1;

  WHILE i <= 500 DO
    INSERT INTO USUARIO(id_rol, estado, nombre, apellido, correo, password_hash, telefono, url_perfil)
    VALUES (
      (SELECT id_rol FROM ROL WHERE nombre='COMPRADOR'),
      'ACTIVO',
      CONCAT('Usuario', i),
      CONCAT('Demo', i),
      CONCAT('u', i, '@test.com'),
      'HASH123',
      CONCAT('+5917', LPAD(FLOOR(RAND()*90000)+10000, 5, '0')),
      CONCAT('/p/u', i)
    );

    INSERT INTO BILLETERA(id_usuario, estado, saldo_creditos, saldo_bs)
    VALUES (LAST_INSERT_ID(),'ACTIVA',0,0);

    SET i = i + 1;
  END WHILE;
END$$
DELIMITER ;
-- DROP PROCEDURE poblar_usuarios;
-- EJECUTAMOS EL PROCEDIMIENTO:
CALL poblar_usuarios();
-- select * from usuario;

-- POBLADO DE CATEGORIAS, UNIDAD DE MEDIDA Y UBICACION
INSERT INTO CATEGORIA (nombre, descripcion)
SELECT CONCAT('Cat', n), 'Categoria generada'
FROM (
  SELECT ROW_NUMBER() OVER () AS n FROM INFORMATION_SCHEMA.COLUMNS LIMIT 200
) t;

INSERT INTO UNIDAD_MEDIDA (nombre, simbolo)
SELECT CONCAT('UM', n), CONCAT('u', n)
FROM (
  SELECT ROW_NUMBER() OVER () AS n FROM INFORMATION_SCHEMA.COLUMNS LIMIT 50
) t;

INSERT INTO UBICACION (direccion, ciudad, provincia, latitud, longitud)
SELECT CONCAT('Dir', n), 'CiudadTest', 'ProvTest', -17.3 + RAND()/10, -66.2 + RAND()/10
FROM (
  SELECT ROW_NUMBER() OVER () AS n FROM INFORMATION_SCHEMA.COLUMNS LIMIT 50
) t;

-- CREACION DE PROCEDIMIENTO QUE CREARA 1000 PRODUCTOS
DELIMITER $$
CREATE PROCEDURE poblar_productos()
BEGIN
  DECLARE i INT DEFAULT 1;
  DECLARE cat INT;

  WHILE i <= 1000 DO
    SET cat = (SELECT id_categoria FROM CATEGORIA ORDER BY RAND() LIMIT 1);

    INSERT INTO PRODUCTO(id_categoria, nombre, descripcion, precio, peso)
    VALUES (cat, CONCAT('Prod', i), 'Producto generico',
            FLOOR(RAND()*500)+50,
            (RAND()*5)+1);
    SET i = i + 1;
  END WHILE;
END$$
DELIMITER ;
-- LLAMAMOS A LA FUNCION QUE CREARA LOS 1000 PRODUCTOS
CALL poblar_productos();
-- select * from producto;

-- PROCEDIMIENTO QUE CREARA SERVICIOS ALEATORIOS
DELIMITER $$
CREATE PROCEDURE poblar_servicios()
BEGIN
  DECLARE i INT DEFAULT 1;
  DECLARE cat INT;

  WHILE i <= 500 DO
    SET cat = (SELECT id_categoria FROM CATEGORIA ORDER BY RAND() LIMIT 1);

    INSERT INTO SERVICIO(id_categoria, estado, nombre, descripcion, precio, duracion_min)
    VALUES (cat, 'ACTIVO',
            CONCAT('Serv', i),
            'Servicio generico',
            FLOOR(RAND()*150)+20,
            FLOOR(RAND()*120)+30);

    SET i = i + 1;
  END WHILE;
END$$
DELIMITER ;
-- LLAMAMOS AL PROCEDIMIENTO QUE CREARA 500 SERVICIOS
CALL poblar_servicios();
-- select * from servicio;

-- PROCEDIMIENTO QUE CREARA PUBLICACIONES 
DELIMITER $$
CREATE PROCEDURE poblar_publicaciones()
BEGIN
  DECLARE i INT DEFAULT 1;
  DECLARE usr INT;
  DECLARE cat INT;
  DECLARE ub INT;
  DECLARE tpub INT;

  WHILE i <= 3000 DO
    SET usr = (SELECT id_usuario FROM USUARIO ORDER BY RAND() LIMIT 1);
    SET cat = (SELECT id_categoria FROM CATEGORIA ORDER BY RAND() LIMIT 1);
    SET ub  = (SELECT id_ubicacion FROM UBICACION ORDER BY RAND() LIMIT 1);
    SET tpub = (SELECT id_tipo_publicacion FROM TIPO_PUBLICACION ORDER BY RAND() LIMIT 1);

    INSERT INTO PUBLICACION
    (id_usuario, id_categoria, id_tipo_publicacion, estado, id_ubicacion, titulo, descripcion, valor_creditos)
    VALUES (
      usr, cat, tpub, 'PUBLICADA', ub,
      CONCAT('Publicacion ', i),
      'Descripcion generada',
      FLOOR(RAND()*200)+20
    );

    SET i = i + 1;
  END WHILE;
END$$
DELIMITER ;
-- LLAMAMOS AL PROC QUE CREARAR 1000 PUBLICACIONES ENTRE SERVICIOS Y PRODUCTOS
CALL poblar_publicaciones();
-- select * from publicacion;

-- VINCULAMOS A PUBLICACIONES CON PRODUCTO O SERVICIO SEGUN CORRESPONDA
INSERT INTO PUBLICACION_PRODUCTO(id_publicacion, id_producto, cantidad, id_um)
SELECT p.id_publicacion,
       (SELECT id_producto FROM PRODUCTO ORDER BY RAND() LIMIT 1),
       1,
       (SELECT id_um FROM UNIDAD_MEDIDA ORDER BY RAND() LIMIT 1)
FROM PUBLICACION p
JOIN TIPO_PUBLICACION tp ON tp.id_tipo_publicacion = p.id_tipo_publicacion
WHERE tp.nombre = 'PRODUCTO';

INSERT INTO PUBLICACION_SERVICIO(id_publicacion, id_servicio, horario)
SELECT p.id_publicacion,
       (SELECT id_servicio FROM SERVICIO ORDER BY RAND() LIMIT 1),
       'L-V 09:00-18:00'
FROM PUBLICACION p
JOIN TIPO_PUBLICACION tp ON tp.id_tipo_publicacion = p.id_tipo_publicacion
WHERE tp.nombre = 'SERVICIO';

-- PROC QUE POBLARA LA COMPRA DE CREDITOS
DELIMITER $$
CREATE PROCEDURE poblar_recargas()
BEGIN
  DECLARE i INT DEFAULT 1;
  DECLARE usr INT;
  DECLARE paq INT;

  WHILE i <= 800 DO
    SET usr = (SELECT id_usuario FROM USUARIO ORDER BY RAND() LIMIT 1);
    SET paq = (SELECT id_paquete FROM PAQUETE_CREDITOS ORDER BY RAND() LIMIT 1);

    CALL sp_compra_creditos_aprobar(usr, paq, CONCAT('TXREC', i));
    SET i = i + 1;
  END WHILE;
END$$
DELIMITER ;

CALL poblar_recargas();

-- POBLAR INTERCAMBIOS REALES 

-- PRIMERO CREAMOS PERIODO PARA QUE NO FALLE LA POBLACION
INSERT INTO PERIODO (nombre, descripcion, fecha_inicio, fecha_fin)
SELECT '2025-12', 'Diciembre 2025', '2025-12-01', '2025-12-31'
WHERE NOT EXISTS (SELECT 1 FROM PERIODO);


-- EQUIVALENCIAS PARA TODAS LAS CATEGORÍAS SIN EQUIVALENCIA
INSERT INTO EQUIVALENCIA_IMPACTO (id_categoria, co2_por_unidad, agua_por_unidad, energia_por_unidad)
SELECT c.id_categoria, 0.2, 1.5, 0.05
FROM CATEGORIA c
WHERE NOT EXISTS (
  SELECT 1
  FROM EQUIVALENCIA_IMPACTO e
  WHERE e.id_categoria = c.id_categoria
);

-- AGREGAR VALORES POR DEFECTO PARA NO ROMPER TRIGGERS
ALTER TABLE IMPACTO_AMBIENTAL 
MODIFY co2_ahorrado DECIMAL(18,6) NOT NULL DEFAULT 0,
MODIFY agua_ahorrada DECIMAL(18,6) NOT NULL DEFAULT 0,
MODIFY energia_ahorrada DECIMAL(18,6) NOT NULL DEFAULT 0;

-- PROC PARA POBLAR INTERCAMBIOS
DROP PROCEDURE IF EXISTS poblar_intercambios;
DELIMITER $$

CREATE PROCEDURE poblar_intercambios()
BEGIN
  DECLARE i INT DEFAULT 1;
  DECLARE comp INT;
  DECLARE pub INT;
  DECLARE precio DECIMAL(15,2);
  DECLARE vendedor INT;
  DECLARE v_err INT DEFAULT 0;

  -- Cualquier error SQL dentro del procedimiento NO lo corta,
  -- sólo setea v_err = 1 y continúa.
  DECLARE CONTINUE HANDLER FOR SQLEXCEPTION
  BEGIN
    SET v_err = 1;
  END;

  WHILE i <= 1200 DO
    
    -- comprador aleatorio
    SET comp = (
      SELECT id_usuario
      FROM USUARIO
      ORDER BY RAND()
      LIMIT 1
    );

    -- publicación aleatoria con equivalencia ambiental
    SET pub = (
      SELECT p.id_publicacion
      FROM PUBLICACION p
      JOIN CATEGORIA c ON c.id_categoria = p.id_categoria
      JOIN EQUIVALENCIA_IMPACTO e ON e.id_categoria = c.id_categoria
      ORDER BY RAND()
      LIMIT 1
    );

    -- precio + vendedor de esa publicación
    SELECT valor_creditos, id_usuario
    INTO precio, vendedor
    FROM PUBLICACION
    WHERE id_publicacion = pub;

    -- evita que el comprador sea el mismo que el vendedor
    IF comp <> vendedor THEN
      SET v_err = 0;
      CALL sp_realizar_intercambio(comp, pub, precio);
      -- si aquí hay "Saldo insuficiente" u otro error:
      -- sp_realizar_intercambio hace ROLLBACK de esa transacción
      -- y el handler pone v_err=1, pero el WHILE sigue.
    END IF;

    SET i = i + 1;
  END WHILE;

END$$
DELIMITER ;

-- LLAMAMOS AL PROC PARA POBLAR INTERCAMBIOS
call poblar_intercambios();
select * from transaccion;
select * from bitacora_intercambio;



-- POBLAR ACTIVIDADES SOSTENIBLES
DELIMITER $$
CREATE PROCEDURE poblar_actividades()
BEGIN
  DECLARE i INT DEFAULT 1;
  DECLARE usr INT;
  DECLARE tipo INT;

  WHILE i <= 1000 DO
    SET usr  = (SELECT id_usuario FROM USUARIO ORDER BY RAND() LIMIT 1);
    SET tipo = (SELECT id_tipo_actividad FROM TIPO_ACTIVIDAD ORDER BY RAND() LIMIT 1);

    CALL sp_registrar_actividad_sostenible(
      usr, tipo, 'Actividad generada', FLOOR(RAND()*30)+5, NULL
    );

    SET i = i + 1;
  END WHILE;
END$$
DELIMITER ;

CALL poblar_actividades();
SELECT * FROM TRANSACCION LIMIT 1000;
SELECT * FROM BITACORA_INTERCAMBIO LIMIT 1000;
SELECT * FROM IMPACTO_AMBIENTAL LIMIT 1000;

SELECT * FROM MOVIMIENTO_CREDITOS LIMIT 100;
SELECT * FROM BILLETERA LIMIT 100;
</file>

<file path="base de datos/primera_ronda.sql">
USE CREDITOS_VERDES2;

-- 0) Asegurar equivalencia de impacto para Tecnología (por si acaso)

INSERT IGNORE INTO EQUIVALENCIA_IMPACTO (id_categoria, id_um, co2_por_unidad, agua_por_unidad, energia_por_unidad)
SELECT
  (SELECT id_categoria FROM CATEGORIA WHERE nombre = 'Tecnología' LIMIT 1),
  (SELECT id_um FROM UNIDAD_MEDIDA WHERE simbolo = 'u' LIMIT 1),
  8.000000,
  30.000000,
  3.500000;

-- 1) Nuevos usuarios compradores + billeteras

INSERT INTO USUARIO (id_rol, estado, nombre, apellido, correo, telefono, url_perfil)
VALUES
  ((SELECT id_rol FROM ROL WHERE nombre='COMPRADOR'),'ACTIVO','Bruno','Rojas','bruno@demo.com','70000006','/p/bruno'),
  ((SELECT id_rol FROM ROL WHERE nombre='COMPRADOR'),'ACTIVO','Elena','Suarez','elena@demo.com','70000007','/p/elena'),
  ((SELECT id_rol FROM ROL WHERE nombre='COMPRADOR'),'ACTIVO','Fernando','Almeida','fernando@demo.com','70000008','/p/fernando'),
  ((SELECT id_rol FROM ROL WHERE nombre='COMPRADOR'),'ACTIVO','Gaby','Flores','gaby@demo.com','70000009','/p/gaby'),
  ((SELECT id_rol FROM ROL WHERE nombre='COMPRADOR'),'ACTIVO','Hugo','Vargas','hugo@demo.com','70000010','/p/hugo'),
  ((SELECT id_rol FROM ROL WHERE nombre='COMPRADOR'),'ACTIVO','Irene','Paz','irene@demo.com','70000011','/p/irene'),
  ((SELECT id_rol FROM ROL WHERE nombre='COMPRADOR'),'ACTIVO','Jorge','Campos','jorge@demo.com','70000012','/p/jorge');

-- Nuevos vendedores extra
INSERT INTO USUARIO (id_rol, estado, nombre, apellido, correo, telefono, url_perfil)
VALUES
  ((SELECT id_rol FROM ROL WHERE nombre='VENDEDOR'),'ACTIVO','Eco','Store','eco1@demo.com','70000013','/p/eco1'),
  ((SELECT id_rol FROM ROL WHERE nombre='VENDEDOR'),'ACTIVO','ReUse','Market','eco2@demo.com','70000014','/p/eco2');

-- Crear billetera para TODOS los usuarios nuevos (si no tienen)
INSERT INTO BILLETERA (id_usuario, estado, saldo_creditos, saldo_bs, cuenta_bancaria)
SELECT u.id_usuario, 'ACTIVA', 0, 0.00, NULL
FROM USUARIO u
LEFT JOIN BILLETERA b ON b.id_usuario = u.id_usuario
WHERE u.correo IN (
  'bruno@demo.com','elena@demo.com','fernando@demo.com',
  'gaby@demo.com','hugo@demo.com','irene@demo.com','jorge@demo.com',
  'eco1@demo.com','eco2@demo.com'
)
AND b.id_billetera IS NULL;

-- 2) Más productos / servicios / publicaciones

-- Productos Bicicletas (venden Marta y eco1)
INSERT INTO PRODUCTO (id_categoria, nombre, descripcion, precio, peso)
SELECT
  (SELECT id_categoria FROM CATEGORIA WHERE nombre='Bicicletas'),
  'Bici Urbana Eco',
  'Bicicleta urbana reacondicionada con cuadro de aluminio.',
  1500.00,
  14.2;

INSERT INTO PRODUCTO (id_categoria, nombre, descripcion, precio, peso)
SELECT
  (SELECT id_categoria FROM CATEGORIA WHERE nombre='Bicicletas'),
  'Bici Plegable Ciudad',
  'Bicicleta plegable ideal para transporte multimodal.',
  1300.00,
  13.0;

-- Productos Tecnología (vende eco2)
INSERT INTO PRODUCTO (id_categoria, nombre, descripcion, precio, peso)
SELECT
  (SELECT id_categoria FROM CATEGORIA WHERE nombre='Tecnología'),
  'Laptop Reacondicionada i5',
  'Laptop reacondicionada con SSD de 256GB y 8GB RAM.',
  2200.00,
  2.1;

INSERT INTO PRODUCTO (id_categoria, nombre, descripcion, precio, peso)
SELECT
  (SELECT id_categoria FROM CATEGORIA WHERE nombre='Tecnología'),
  'Monitor 24 Reciclado',
  'Monitor de 24" reacondicionado, ideal oficina.',
  900.00,
  3.2;

-- Publicaciones de esos productos
INSERT INTO PUBLICACION
  (id_usuario, id_categoria, id_tipo_publicacion, estado, id_ubicacion,
   titulo, descripcion, valor_creditos, imagen_url)
SELECT
  (SELECT id_usuario FROM USUARIO WHERE correo='marta@demo.com'),
  (SELECT id_categoria FROM CATEGORIA WHERE nombre='Bicicletas'),
  (SELECT id_tipo_publicacion FROM TIPO_PUBLICACION WHERE nombre='PRODUCTO'),
  'PUBLICADA',
  (SELECT id_ubicacion FROM UBICACION WHERE ciudad='Cochabamba'),
  'Bici Urbana Eco',
  'Reacondicionada, frenos en V, lista para uso diario.',
  320,
  'https://img/bici_urbana_eco.jpg';

INSERT INTO PUBLICACION_PRODUCTO
SELECT
  (SELECT id_publicacion FROM PUBLICACION WHERE titulo='Bici Urbana Eco' LIMIT 1),
  (SELECT id_producto   FROM PRODUCTO   WHERE nombre='Bici Urbana Eco' LIMIT 1),
  1.0000,
  (SELECT id_um FROM UNIDAD_MEDIDA WHERE simbolo='u');

INSERT INTO PUBLICACION
  (id_usuario, id_categoria, id_tipo_publicacion, estado, id_ubicacion,
   titulo, descripcion, valor_creditos, imagen_url)
SELECT
  (SELECT id_usuario FROM USUARIO WHERE correo='eco1@demo.com'),
  (SELECT id_categoria FROM CATEGORIA WHERE nombre='Bicicletas'),
  (SELECT id_tipo_publicacion FROM TIPO_PUBLICACION WHERE nombre='PRODUCTO'),
  'PUBLICADA',
  (SELECT id_ubicacion FROM UBICACION WHERE ciudad='La Paz'),
  'Bici Plegable Ciudad',
  'Fácil de transportar, incluye canastillo frontal.',
  280,
  'https://img/bici_plegable.jpg';

INSERT INTO PUBLICACION_PRODUCTO
SELECT
  (SELECT id_publicacion FROM PUBLICACION WHERE titulo='Bici Plegable Ciudad' LIMIT 1),
  (SELECT id_producto   FROM PRODUCTO   WHERE nombre='Bici Plegable Ciudad' LIMIT 1),
  1.0000,
  (SELECT id_um FROM UNIDAD_MEDIDA WHERE simbolo='u');

-- Publicaciones Tecnología (eco2)
INSERT INTO PUBLICACION
  (id_usuario, id_categoria, id_tipo_publicacion, estado, id_ubicacion,
   titulo, descripcion, valor_creditos, imagen_url)
SELECT
  (SELECT id_usuario FROM USUARIO WHERE correo='eco2@demo.com'),
  (SELECT id_categoria FROM CATEGORIA WHERE nombre='Tecnología'),
  (SELECT id_tipo_publicacion FROM TIPO_PUBLICACION WHERE nombre='PRODUCTO'),
  'PUBLICADA',
  (SELECT id_ubicacion FROM UBICACION WHERE ciudad='Santa Cruz'),
  'Laptop Reacondicionada i5',
  'Ideal para teletrabajo y estudio.',
  350,
  'https://img/laptop_reuse.jpg';

INSERT INTO PUBLICACION_PRODUCTO
SELECT
  (SELECT id_publicacion FROM PUBLICACION WHERE titulo='Laptop Reacondicionada i5' LIMIT 1),
  (SELECT id_producto   FROM PRODUCTO   WHERE nombre='Laptop Reacondicionada i5' LIMIT 1),
  1.0000,
  (SELECT id_um FROM UNIDAD_MEDIDA WHERE simbolo='u');

INSERT INTO PUBLICACION
  (id_usuario, id_categoria, id_tipo_publicacion, estado, id_ubicacion,
   titulo, descripcion, valor_creditos, imagen_url)
SELECT
  (SELECT id_usuario FROM USUARIO WHERE correo='eco2@demo.com'),
  (SELECT id_categoria FROM CATEGORIA WHERE nombre='Tecnología'),
  (SELECT id_tipo_publicacion FROM TIPO_PUBLICACION WHERE nombre='PRODUCTO'),
  'PUBLICADA',
  (SELECT id_ubicacion FROM UBICACION WHERE ciudad='Cochabamba'),
  'Monitor 24 Reciclado',
  'Pantalla 24" reacondicionada, 75Hz, entrada HDMI.',
  220,
  'https://img/monitor_reciclado.jpg';

INSERT INTO PUBLICACION_PRODUCTO
SELECT
  (SELECT id_publicacion FROM PUBLICACION WHERE titulo='Monitor 24 Reciclado' LIMIT 1),
  (SELECT id_producto   FROM PRODUCTO   WHERE nombre='Monitor 24 Reciclado' LIMIT 1),
  1.0000,
  (SELECT id_um FROM UNIDAD_MEDIDA WHERE simbolo='u');

-- Servicios de tecnología adicionales (los vende Marta)
INSERT INTO SERVICIO (id_categoria, estado, nombre, descripcion, precio, duracion_min)
SELECT
  (SELECT id_categoria FROM CATEGORIA WHERE nombre='Tecnología'),
  'ACTIVO',
  'Mantenimiento laptop básico',
  'Limpieza interna y cambio de pasta térmica.',
  100.00,
  60;

INSERT INTO PUBLICACION
  (id_usuario, id_categoria, id_tipo_publicacion, estado, id_ubicacion,
   titulo, descripcion, valor_creditos, imagen_url)
SELECT
  (SELECT id_usuario FROM USUARIO WHERE correo='marta@demo.com'),
  (SELECT id_categoria FROM CATEGORIA WHERE nombre='Tecnología'),
  (SELECT id_tipo_publicacion FROM TIPO_PUBLICACION WHERE nombre='SERVICIO'),
  'PUBLICADA',
  (SELECT id_ubicacion FROM UBICACION WHERE ciudad='Cochabamba'),
  'Mantenimiento laptop básico',
  'Incluye limpieza general y revisión de temperatura.',
  110,
  'https://img/serv_mant_laptop.jpg';

INSERT INTO PUBLICACION_SERVICIO
SELECT
  (SELECT id_publicacion FROM PUBLICACION WHERE titulo='Mantenimiento laptop básico' LIMIT 1),
  (SELECT id_servicio   FROM SERVICIO   WHERE nombre='Mantenimiento laptop básico' LIMIT 1),
  'L-S 09:00-12:00';

-- 3) Compras de créditos masivas (≈ 20 operaciones)
--    Cada usuario compra varios paquetes

-- Usuarios que van a comprar créditos
SET @compradores := 'ana@demo.com,carla@demo.com,diego@demo.com,bruno@demo.com,elena@demo.com,fernando@demo.com,gaby@demo.com,hugo@demo.com,irene@demo.com,jorge@demo.com';

-- Ana (2 recargas)
CALL sp_compra_creditos_aprobar(
  (SELECT id_usuario FROM USUARIO WHERE correo='ana@demo.com'),
  (SELECT id_paquete FROM PAQUETE_CREDITOS WHERE nombre='Pack 500'),
  'PAY-ANA-002'
);
CALL sp_compra_creditos_aprobar(
  (SELECT id_usuario FROM USUARIO WHERE correo='ana@demo.com'),
  (SELECT id_paquete FROM PAQUETE_CREDITOS WHERE nombre='Pack 100'),
  'PAY-ANA-003'
);

-- Carla
CALL sp_compra_creditos_aprobar(
  (SELECT id_usuario FROM USUARIO WHERE correo='carla@demo.com'),
  (SELECT id_paquete FROM PAQUETE_CREDITOS WHERE nombre='Pack 500'),
  'PAY-CARLA-002'
);
CALL sp_compra_creditos_aprobar(
  (SELECT id_usuario FROM USUARIO WHERE correo='carla@demo.com'),
  (SELECT id_paquete FROM PAQUETE_CREDITOS WHERE nombre='Pack 100'),
  'PAY-CARLA-003'
);

-- Diego
CALL sp_compra_creditos_aprobar(
  (SELECT id_usuario FROM USUARIO WHERE correo='diego@demo.com'),
  (SELECT id_paquete FROM PAQUETE_CREDITOS WHERE nombre='Pack 500'),
  'PAY-DIEGO-002'
);
CALL sp_compra_creditos_aprobar(
  (SELECT id_usuario FROM USUARIO WHERE correo='diego@demo.com'),
  (SELECT id_paquete FROM PAQUETE_CREDITOS WHERE nombre='Pack 100'),
  'PAY-DIEGO-003'
);

-- Bruno
CALL sp_compra_creditos_aprobar(
  (SELECT id_usuario FROM USUARIO WHERE correo='bruno@demo.com'),
  (SELECT id_paquete FROM PAQUETE_CREDITOS WHERE nombre='Pack 500'),
  'PAY-BRUNO-001'
);
CALL sp_compra_creditos_aprobar(
  (SELECT id_usuario FROM USUARIO WHERE correo='bruno@demo.com'),
  (SELECT id_paquete FROM PAQUETE_CREDITOS WHERE nombre='Pack 100'),
  'PAY-BRUNO-002'
);

-- Elena
CALL sp_compra_creditos_aprobar(
  (SELECT id_usuario FROM USUARIO WHERE correo='elena@demo.com'),
  (SELECT id_paquete FROM PAQUETE_CREDITOS WHERE nombre='Pack 500'),
  'PAY-ELENA-001'
);
CALL sp_compra_creditos_aprobar(
  (SELECT id_usuario FROM USUARIO WHERE correo='elena@demo.com'),
  (SELECT id_paquete FROM PAQUETE_CREDITOS WHERE nombre='Pack 100'),
  'PAY-ELENA-002'
);

-- Fernando
CALL sp_compra_creditos_aprobar(
  (SELECT id_usuario FROM USUARIO WHERE correo='fernando@demo.com'),
  (SELECT id_paquete FROM PAQUETE_CREDITOS WHERE nombre='Pack 500'),
  'PAY-FERNANDO-001'
);
CALL sp_compra_creditos_aprobar(
  (SELECT id_usuario FROM USUARIO WHERE correo='fernando@demo.com'),
  (SELECT id_paquete FROM PAQUETE_CREDITOS WHERE nombre='Pack 100'),
  'PAY-FERNANDO-002'
);

-- Gaby
CALL sp_compra_creditos_aprobar(
  (SELECT id_usuario FROM USUARIO WHERE correo='gaby@demo.com'),
  (SELECT id_paquete FROM PAQUETE_CREDITOS WHERE nombre='Pack 500'),
  'PAY-GABY-001'
);

-- Hugo
CALL sp_compra_creditos_aprobar(
  (SELECT id_usuario FROM USUARIO WHERE correo='hugo@demo.com'),
  (SELECT id_paquete FROM PAQUETE_CREDITOS WHERE nombre='Pack 500'),
  'PAY-HUGO-001'
);

-- Irene
CALL sp_compra_creditos_aprobar(
  (SELECT id_usuario FROM USUARIO WHERE correo='irene@demo.com'),
  (SELECT id_paquete FROM PAQUETE_CREDITOS WHERE nombre='Pack 500'),
  'PAY-IRENE-001'
);

-- Jorge
CALL sp_compra_creditos_aprobar(
  (SELECT id_usuario FROM USUARIO WHERE correo='jorge@demo.com'),
  (SELECT id_paquete FROM PAQUETE_CREDITOS WHERE nombre='Pack 500'),
  'PAY-JORGE-001'
);

-- 4) Intercambios masivos (≈ 20 operaciones)
--    Cada comprador adquiere productos/servicios distintos

-- Función auxiliar mental:
-- Bici Urbana Eco        -> 320 créditos
-- Bici Plegable Ciudad   -> 280 créditos
-- Laptop Reacondicionada -> 350 créditos
-- Monitor 24 Reciclado   -> 220 créditos
-- Mantenimiento laptop   -> 110 créditos
-- Mantenimiento y limpieza de PC (seed original) -> 120 créditos
-- Bicicleta montaña Pro  -> 450 créditos

-- 4.1 Ana compra Bici Urbana Eco y servicio de mantenimiento
CALL sp_realizar_intercambio(
  (SELECT id_usuario FROM USUARIO WHERE correo='ana@demo.com'),
  (SELECT id_publicacion FROM PUBLICACION WHERE titulo='Bici Urbana Eco' LIMIT 1),
  320
);
SET @id_tx = (SELECT MAX(id_transaccion) FROM TRANSACCION);
UPDATE TRANSACCION SET estado='COMPLETADA' WHERE id_transaccion=@id_tx;

CALL sp_realizar_intercambio(
  (SELECT id_usuario FROM USUARIO WHERE correo='ana@demo.com'),
  (SELECT id_publicacion FROM PUBLICACION WHERE titulo='Mantenimiento laptop básico' LIMIT 1),
  110
);
SET @id_tx = (SELECT MAX(id_transaccion) FROM TRANSACCION);
UPDATE TRANSACCION SET estado='COMPLETADA' WHERE id_transaccion=@id_tx;

-- 4.2 Carla compra servicio "Mantenimiento y limpieza de PC" y Monitor
CALL sp_realizar_intercambio(
  (SELECT id_usuario FROM USUARIO WHERE correo='carla@demo.com'),
  (SELECT id_publicacion FROM PUBLICACION WHERE titulo='Mantenimiento y limpieza de PC' LIMIT 1),
  120
);
SET @id_tx = (SELECT MAX(id_transaccion) FROM TRANSACCION);
UPDATE TRANSACCION SET estado='COMPLETADA' WHERE id_transaccion=@id_tx;

CALL sp_realizar_intercambio(
  (SELECT id_usuario FROM USUARIO WHERE correo='carla@demo.com'),
  (SELECT id_publicacion FROM PUBLICACION WHERE titulo='Monitor 24 Reciclado' LIMIT 1),
  220
);
SET @id_tx = (SELECT MAX(id_transaccion) FROM TRANSACCION);
UPDATE TRANSACCION SET estado='COMPLETADA' WHERE id_transaccion=@id_tx;

-- 4.3 Diego compra Bici Plegable Ciudad
CALL sp_realizar_intercambio(
  (SELECT id_usuario FROM USUARIO WHERE correo='diego@demo.com'),
  (SELECT id_publicacion FROM PUBLICACION WHERE titulo='Bici Plegable Ciudad' LIMIT 1),
  280
);
SET @id_tx = (SELECT MAX(id_transaccion) FROM TRANSACCION);
UPDATE TRANSACCION SET estado='COMPLETADA' WHERE id_transaccion=@id_tx;

-- 4.4 Bruno compra Laptop Reacondicionada y servicio de mantenimiento
CALL sp_realizar_intercambio(
  (SELECT id_usuario FROM USUARIO WHERE correo='bruno@demo.com'),
  (SELECT id_publicacion FROM PUBLICACION WHERE titulo='Laptop Reacondicionada i5' LIMIT 1),
  350
);
SET @id_tx = (SELECT MAX(id_transaccion) FROM TRANSACCION);
UPDATE TRANSACCION SET estado='COMPLETADA' WHERE id_transaccion=@id_tx;

CALL sp_realizar_intercambio(
  (SELECT id_usuario FROM USUARIO WHERE correo='bruno@demo.com'),
  (SELECT id_publicacion FROM PUBLICACION WHERE titulo='Mantenimiento laptop básico' LIMIT 1),
  110
);
SET @id_tx = (SELECT MAX(id_transaccion) FROM TRANSACCION);
UPDATE TRANSACCION SET estado='COMPLETADA' WHERE id_transaccion=@id_tx;

-- 4.5 Elena compra Monitor y servicio
CALL sp_realizar_intercambio(
  (SELECT id_usuario FROM USUARIO WHERE correo='elena@demo.com'),
  (SELECT id_publicacion FROM PUBLICACION WHERE titulo='Monitor 24 Reciclado' LIMIT 1),
  220
);
SET @id_tx = (SELECT MAX(id_transaccion) FROM TRANSACCION);
UPDATE TRANSACCION SET estado='COMPLETADA' WHERE id_transaccion=@id_tx;

CALL sp_realizar_intercambio(
  (SELECT id_usuario FROM USUARIO WHERE correo='elena@demo.com'),
  (SELECT id_publicacion FROM PUBLICACION WHERE titulo='Formateo e instalación de Windows' LIMIT 1),
  90
);
SET @id_tx = (SELECT MAX(id_transaccion) FROM TRANSACCION);
UPDATE TRANSACCION SET estado='COMPLETADA' WHERE id_transaccion=@id_tx;

-- 4.6 Fernando compra Bici Urbana Eco
CALL sp_realizar_intercambio(
  (SELECT id_usuario FROM USUARIO WHERE correo='fernando@demo.com'),
  (SELECT id_publicacion FROM PUBLICACION WHERE titulo='Bici Urbana Eco' LIMIT 1),
  320
);
SET @id_tx = (SELECT MAX(id_transaccion) FROM TRANSACCION);
UPDATE TRANSACCION SET estado='COMPLETADA' WHERE id_transaccion=@id_tx;

-- 4.7 Gaby compra servicio "Formateo e instalación de Windows"
CALL sp_realizar_intercambio(
  (SELECT id_usuario FROM USUARIO WHERE correo='gaby@demo.com'),
  (SELECT id_publicacion FROM PUBLICACION WHERE titulo='Formateo e instalación de Windows' LIMIT 1),
  90
);
SET @id_tx = (SELECT MAX(id_transaccion) FROM TRANSACCION);
UPDATE TRANSACCION SET estado='COMPLETADA' WHERE id_transaccion=@id_tx;

-- 4.8 Hugo compra "Mantenimiento y limpieza de PC"
CALL sp_realizar_intercambio(
  (SELECT id_usuario FROM USUARIO WHERE correo='hugo@demo.com'),
  (SELECT id_publicacion FROM PUBLICACION WHERE titulo='Mantenimiento y limpieza de PC' LIMIT 1),
  120
);
SET @id_tx = (SELECT MAX(id_transaccion) FROM TRANSACCION);
UPDATE TRANSACCION SET estado='COMPLETADA' WHERE id_transaccion=@id_tx;

-- 4.9 Irene compra "Bicicleta montaña Pro"
CALL sp_realizar_intercambio(
  (SELECT id_usuario FROM USUARIO WHERE correo='irene@demo.com'),
  (SELECT id_publicacion FROM PUBLICACION WHERE titulo='Bicicleta montaña Pro' LIMIT 1),
  450
);
SET @id_tx = (SELECT MAX(id_transaccion) FROM TRANSACCION);
UPDATE TRANSACCION SET estado='COMPLETADA' WHERE id_transaccion=@id_tx;

-- 4.10 Jorge compra "Bici Plegable Ciudad"
CALL sp_realizar_intercambio(
  (SELECT id_usuario FROM USUARIO WHERE correo='jorge@demo.com'),
  (SELECT id_publicacion FROM PUBLICACION WHERE titulo='Bici Plegable Ciudad' LIMIT 1),
  280
);
SET @id_tx = (SELECT MAX(id_transaccion) FROM TRANSACCION);
UPDATE TRANSACCION SET estado='COMPLETADA' WHERE id_transaccion=@id_tx;

-- 5) Actividades sostenibles masivas (≈ 10 operaciones)

CALL sp_registrar_actividad_sostenible(
  (SELECT id_usuario FROM USUARIO WHERE correo='ana@demo.com'),
  (SELECT id_tipo_actividad FROM TIPO_ACTIVIDAD WHERE nombre='RECICLAJE'),
  'Entregó 4kg de papel para reciclaje', 12,
  'https://evidencias/reciclaje_ana.jpg'
);

CALL sp_registrar_actividad_sostenible(
  (SELECT id_usuario FROM USUARIO WHERE correo='bruno@demo.com'),
  (SELECT id_tipo_actividad FROM TIPO_ACTIVIDAD WHERE nombre='RECICLAJE'),
  'Entregó 6kg de plástico para reciclaje', 18,
  'https://evidencias/reciclaje_bruno.jpg'
);

CALL sp_registrar_actividad_sostenible(
  (SELECT id_usuario FROM USUARIO WHERE correo='elena@demo.com'),
  (SELECT id_tipo_actividad FROM TIPO_ACTIVIDAD WHERE nombre='RECICLAJE'),
  'Entregó 10kg de cartón', 25,
  'https://evidencias/reciclaje_elena.jpg'
);

CALL sp_registrar_actividad_sostenible(
  (SELECT id_usuario FROM USUARIO WHERE correo='fernando@demo.com'),
  (SELECT id_tipo_actividad FROM TIPO_ACTIVIDAD WHERE nombre='RECICLAJE'),
  'Donó componentes electrónicos para reciclaje', 20,
  'https://evidencias/reciclaje_fernando.jpg'
);

CALL sp_registrar_actividad_sostenible(
  (SELECT id_usuario FROM USUARIO WHERE correo='gaby@demo.com'),
  (SELECT id_tipo_actividad FROM TIPO_ACTIVIDAD WHERE nombre='RECICLAJE'),
  'Recogió residuos en su barrio', 15,
  'https://evidencias/reciclaje_gaby.jpg'
);

CALL sp_registrar_actividad_sostenible(
  (SELECT id_usuario FROM USUARIO WHERE correo='hugo@demo.com'),
  (SELECT id_tipo_actividad FROM TIPO_ACTIVIDAD WHERE nombre='RECICLAJE'),
  'Separó vidrio y plástico en su hogar', 10,
  'https://evidencias/reciclaje_hugo.jpg'
);

CALL sp_registrar_actividad_sostenible(
  (SELECT id_usuario FROM USUARIO WHERE correo='irene@demo.com'),
  (SELECT id_tipo_actividad FROM TIPO_ACTIVIDAD WHERE nombre='RECICLAJE'),
  'Participó en campaña de recolección de e-waste', 22,
  'https://evidencias/reciclaje_irene.jpg'
);

CALL sp_registrar_actividad_sostenible(
  (SELECT id_usuario FROM USUARIO WHERE correo='jorge@demo.com'),
  (SELECT id_tipo_actividad FROM TIPO_ACTIVIDAD WHERE nombre='RECICLAJE'),
  'Entregó pilas usadas para disposición adecuada', 8,
  'https://evidencias/reciclaje_jorge.jpg'
);

-- 6) Regenerar reporte de impacto mensual

CALL sp_generar_reporte_impacto(
  (SELECT id_tipo_reporte FROM TIPO_REPORTE WHERE nombre='MENSUAL'),
  (SELECT id_periodo FROM PERIODO WHERE nombre='2025-11'),
  NULL
);

-- Chequeo rápido de saldos y actividad
SELECT u.correo, b.saldo_creditos
FROM USUARIO u
LEFT JOIN BILLETERA b ON b.id_usuario = u.id_usuario
WHERE u.correo IN (
  'ana@demo.com','luis@demo.com','carla@demo.com','diego@demo.com','marta@demo.com',
  'bruno@demo.com','elena@demo.com','fernando@demo.com','gaby@demo.com',
  'hugo@demo.com','irene@demo.com','jorge@demo.com'
)
ORDER BY u.correo;
-- 1) Usuarios extra + billeteras

USE CREDITOS_VERDES2;

-- Verificar IDs (solo para ver qué hay)
SELECT id_categoria, nombre FROM CATEGORIA;
SELECT id_um, simbolo FROM UNIDAD_MEDIDA;

-- Crear equivalencia de impacto para la categoría "Tecnología"
INSERT IGNORE INTO EQUIVALENCIA_IMPACTO (id_categoria, id_um, co2_por_unidad, agua_por_unidad, energia_por_unidad)
SELECT
  (SELECT id_categoria FROM CATEGORIA WHERE nombre = 'Tecnología' LIMIT 1),
  (SELECT id_um FROM UNIDAD_MEDIDA WHERE simbolo = 'u' LIMIT 1),
  8.000000,   -- CO₂ por unidad (valor de ejemplo)
  30.000000,  -- Agua por unidad (ejemplo)
  3.500000;   -- Energía por unidad (ejemplo)

INSERT INTO USUARIO (id_rol, estado, nombre, apellido, correo, telefono, url_perfil)
VALUES
  ((SELECT id_rol FROM ROL WHERE nombre='COMPRADOR'),'ACTIVO','Carla','Mendez','carla@demo.com','70000003','/p/carla'),
  ((SELECT id_rol FROM ROL WHERE nombre='COMPRADOR'),'ACTIVO','Diego','Salazar','diego@demo.com','70000004','/p/diego'),
  ((SELECT id_rol FROM ROL WHERE nombre='VENDEDOR'),'ACTIVO','Marta','Lopez','marta@demo.com','70000005','/p/marta');

-- Crear billetera para esos usuarios (si no existe)
INSERT INTO BILLETERA (id_usuario, estado, saldo_creditos, saldo_bs, cuenta_bancaria)
SELECT u.id_usuario, 'ACTIVA', 0, 0.00, NULL
FROM USUARIO u
LEFT JOIN BILLETERA b ON b.id_usuario = u.id_usuario
WHERE u.correo IN ('carla@demo.com','diego@demo.com','marta@demo.com')
  AND b.id_billetera IS NULL;

-- 2) Productos / servicios extra publicados
--    (para tener más categorías en reportes)

-- Producto extra 1 (vendedor: Marta)
INSERT INTO PRODUCTO (id_categoria, nombre, descripcion, precio, peso)
SELECT
  (SELECT id_categoria FROM CATEGORIA WHERE nombre='Bicicletas'),
  'Bici Montaña Pro',
  'Bicicleta de montaña, frenos de disco, suspensión delantera.',
  1800.00,
  15.8;

INSERT INTO PUBLICACION
  (id_usuario, id_categoria, id_tipo_publicacion, estado, id_ubicacion, titulo, descripcion, valor_creditos, imagen_url)
SELECT
  (SELECT id_usuario FROM USUARIO WHERE correo='marta@demo.com'),
  (SELECT id_categoria FROM CATEGORIA WHERE nombre='Bicicletas'),
  (SELECT id_tipo_publicacion FROM TIPO_PUBLICACION WHERE nombre='PRODUCTO'),
  'PUBLICADA',
  (SELECT id_ubicacion FROM UBICACION WHERE ciudad='La Paz'),
  'Bicicleta montaña Pro',
  'Ideal para senderos y caminos rurales.',
  450,
  'https://img/bici2.jpg';

INSERT INTO PUBLICACION_PRODUCTO
SELECT
  (SELECT id_publicacion FROM PUBLICACION WHERE titulo='Bicicleta montaña Pro' LIMIT 1),
  (SELECT id_producto   FROM PRODUCTO     WHERE nombre='Bici Montaña Pro' LIMIT 1),
  1.0000,
  (SELECT id_um FROM UNIDAD_MEDIDA WHERE simbolo='u');

-- Servicio extra (vendedor: Marta)
INSERT INTO SERVICIO (id_categoria, estado, nombre, descripcion, precio, duracion_min)
SELECT
  (SELECT id_categoria FROM CATEGORIA WHERE nombre='Tecnología'),
  'ACTIVO',
  'Formateo e instalación SO',
  'Instalación de sistema operativo + drivers básicos.',
  80.00,
  45;

INSERT INTO PUBLICACION
  (id_usuario, id_categoria, id_tipo_publicacion, estado, id_ubicacion, titulo, descripcion, valor_creditos, imagen_url)
SELECT
  (SELECT id_usuario FROM USUARIO WHERE correo='marta@demo.com'),
  (SELECT id_categoria FROM CATEGORIA WHERE nombre='Tecnología'),
  (SELECT id_tipo_publicacion FROM TIPO_PUBLICACION WHERE nombre='SERVICIO'),
  'PUBLICADA',
  (SELECT id_ubicacion FROM UBICACION WHERE ciudad='Cochabamba'),
  'Formateo e instalación de Windows',
  'Incluye backup básico de documentos.',
  90,
  'https://img/serv2.jpg';

INSERT INTO PUBLICACION_SERVICIO
SELECT
  (SELECT id_publicacion FROM PUBLICACION WHERE titulo='Formateo e instalación de Windows' LIMIT 1),
  (SELECT id_servicio   FROM SERVICIO     WHERE nombre='Formateo e instalación SO' LIMIT 1),
  'L-V 14:00-18:00';

-- 3) Compras de créditos (RECARGA) usando SP

-- Carla compra Pack 100
CALL sp_compra_creditos_aprobar(
  (SELECT id_usuario FROM USUARIO WHERE correo='carla@demo.com'),
  (SELECT id_paquete FROM PAQUETE_CREDITOS WHERE nombre='Pack 500'),
  'PAY-DEMO-002'
);

-- Diego compra Pack 500
CALL sp_compra_creditos_aprobar(
  (SELECT id_usuario FROM USUARIO WHERE correo='diego@demo.com'),
  (SELECT id_paquete FROM PAQUETE_CREDITOS WHERE nombre='Pack 500'),
  'PAY-DEMO-003'
);

-- 4) Intercambios extra (TRANSACCIONES)

-- Carla compra el servicio "Mantenimiento y limpieza de PC" de Luis (120 créditos)
CALL sp_compra_creditos_aprobar(
  (SELECT id_usuario FROM USUARIO WHERE correo='carla@demo.com'),
  (SELECT id_paquete FROM PAQUETE_CREDITOS WHERE nombre='Pack 500'),
  'PAGO-CARLA-001'
);
CALL sp_realizar_intercambio(
  (SELECT id_usuario FROM USUARIO WHERE correo='carla@demo.com'),
  (SELECT id_publicacion FROM PUBLICACION WHERE titulo='Mantenimiento y limpieza de PC' LIMIT 1),
  120
);

SET @id_tx_carla_pc = (SELECT MAX(id_transaccion) FROM TRANSACCION);
UPDATE TRANSACCION
SET estado = 'COMPLETADA'
WHERE id_transaccion = @id_tx_carla_pc;

-- Diego compra "Bicicleta montaña Pro" de Marta (450 créditos)
CALL sp_realizar_intercambio(
  (SELECT id_usuario FROM USUARIO WHERE correo='diego@demo.com'),
  (SELECT id_publicacion FROM PUBLICACION WHERE titulo='Bicicleta montaña Pro' LIMIT 1),
  450
);

SET @id_tx_diego_bici = (SELECT MAX(id_transaccion) FROM TRANSACCION);
UPDATE TRANSACCION
SET estado = 'COMPLETADA'
WHERE id_transaccion = @id_tx_diego_bici;

-- 5) Actividades sostenibles extra

CALL sp_registrar_actividad_sostenible(
  (SELECT id_usuario FROM USUARIO WHERE correo='carla@demo.com'),
  (SELECT id_tipo_actividad FROM TIPO_ACTIVIDAD WHERE nombre='RECICLAJE'),
  'Entregó 3kg de plástico para reciclaje', 10,
  'https://evidencias/reciclaje2.jpg'
);

CALL sp_registrar_actividad_sostenible(
  (SELECT id_usuario FROM USUARIO WHERE correo='diego@demo.com'),
  (SELECT id_tipo_actividad FROM TIPO_ACTIVIDAD WHERE nombre='RECICLAJE'),
  'Entregó 8kg de vidrio para reciclaje', 20,
  'https://evidencias/reciclaje3.jpg'
);

-- 6) Regenerar reporte de impacto MENSUAL

CALL sp_generar_reporte_impacto(
  (SELECT id_tipo_reporte FROM TIPO_REPORTE WHERE nombre='MENSUAL'),
  (SELECT id_periodo FROM PERIODO WHERE nombre='2025-11'),
  NULL
);

-- Puedes verificar rápido:
SELECT u.correo, b.saldo_creditos
FROM USUARIO u
LEFT JOIN BILLETERA b ON b.id_usuario = u.id_usuario
WHERE u.correo IN ('ana@demo.com','luis@demo.com','carla@demo.com','diego@demo.com','marta@demo.com');

USE CREDITOS_VERDES2;

-- 0) Asegurar equivalencia de impacto para Tecnología (seguro)

INSERT IGNORE INTO EQUIVALENCIA_IMPACTO (id_categoria, id_um, co2_por_unidad, agua_por_unidad, energia_por_unidad)
SELECT
  (SELECT id_categoria FROM CATEGORIA WHERE nombre = 'Tecnología' LIMIT 1),
  (SELECT id_um FROM UNIDAD_MEDIDA WHERE simbolo = 'u' LIMIT 1),
  8.000000,
  30.000000,
  3.500000;
/* 1) Nuevos USUARIOS (≈ 24 compradores + 8 vendedores)*/

-- 1.1 Compradores NUEVOS
INSERT INTO USUARIO (id_rol, estado, nombre, apellido, correo, telefono, url_perfil)
VALUES
  ((SELECT id_rol FROM ROL WHERE nombre='COMPRADOR'),'ACTIVO','Camila','Rios','camila@demo.com','71000001','/p/camila'),
  ((SELECT id_rol FROM ROL WHERE nombre='COMPRADOR'),'ACTIVO','Daniel','Torres','daniel@demo.com','71000002','/p/daniel'),
  ((SELECT id_rol FROM ROL WHERE nombre='COMPRADOR'),'ACTIVO','Sofia','Mendez','sofia@demo.com','71000003','/p/sofia'),
  ((SELECT id_rol FROM ROL WHERE nombre='COMPRADOR'),'ACTIVO','Pablo','Lima','pablo@demo.com','71000004','/p/pablo'),
  ((SELECT id_rol FROM ROL WHERE nombre='COMPRADOR'),'ACTIVO','Laura','Guzman','laura@demo.com','71000005','/p/laura'),
  ((SELECT id_rol FROM ROL WHERE nombre='COMPRADOR'),'ACTIVO','Andres','Zeballos','andres@demo.com','71000006','/p/andres'),
  ((SELECT id_rol FROM ROL WHERE nombre='COMPRADOR'),'ACTIVO','Valeria','Nuñez','valeria@demo.com','71000007','/p/valeria'),
  ((SELECT id_rol FROM ROL WHERE nombre='COMPRADOR'),'ACTIVO','Roberto','Aguilar','roberto@demo.com','71000008','/p/roberto'),
  ((SELECT id_rol FROM ROL WHERE nombre='COMPRADOR'),'ACTIVO','Natalia','Cruz','natalia@demo.com','71000009','/p/natalia'),
  ((SELECT id_rol FROM ROL WHERE nombre='COMPRADOR'),'ACTIVO','Sergio','Rojas','sergio@demo.com','71000010','/p/sergio'),
  ((SELECT id_rol FROM ROL WHERE nombre='COMPRADOR'),'ACTIVO','Patricia','Salas','patricia@demo.com','71000011','/p/patricia'),
  ((SELECT id_rol FROM ROL WHERE nombre='COMPRADOR'),'ACTIVO','Marcos','Quiroga','marcos@demo.com','71000012','/p/marcos'),
  ((SELECT id_rol FROM ROL WHERE nombre='COMPRADOR'),'ACTIVO','Lucia','Delgado','lucia@demo.com','71000013','/p/lucia'),
  ((SELECT id_rol FROM ROL WHERE nombre='COMPRADOR'),'ACTIVO','Ricardo','Vega','ricardo@demo.com','71000014','/p/ricardo'),
  ((SELECT id_rol FROM ROL WHERE nombre='COMPRADOR'),'ACTIVO','Melissa','Campos','melissa@demo.com','71000015','/p/melissa'),
  ((SELECT id_rol FROM ROL WHERE nombre='COMPRADOR'),'ACTIVO','Tomas','Herrera','tomas@demo.com','71000016','/p/tomas'),
  ((SELECT id_rol FROM ROL WHERE nombre='COMPRADOR'),'ACTIVO','Cecilia','Paredes','cecilia@demo.com','71000017','/p/cecilia'),
  ((SELECT id_rol FROM ROL WHERE nombre='COMPRADOR'),'ACTIVO','German','Lara','german@demo.com','71000018','/p/german'),
  ((SELECT id_rol FROM ROL WHERE nombre='COMPRADOR'),'ACTIVO','Roxana','Villaroel','roxana@demo.com','71000019','/p/roxana'),
  ((SELECT id_rol FROM ROL WHERE nombre='COMPRADOR'),'ACTIVO','Kevin','Lopez','kevin@demo.com','71000020','/p/kevin'),
  ((SELECT id_rol FROM ROL WHERE nombre='COMPRADOR'),'ACTIVO','Mauro','Ibañez','mauro@demo.com','71000021','/p/mauro'),
  ((SELECT id_rol FROM ROL WHERE nombre='COMPRADOR'),'ACTIVO','Dana','Gomez','dana@demo.com','71000022','/p/dana'),
  ((SELECT id_rol FROM ROL WHERE nombre='COMPRADOR'),'ACTIVO','Helena','Ramos','helena@demo.com','71000023','/p/helena'),
  ((SELECT id_rol FROM ROL WHERE nombre='COMPRADOR'),'ACTIVO','Oscar','Medina','oscar@demo.com','71000024','/p/oscar');

-- 1.2 Vendedores NUEVOS
INSERT INTO USUARIO (id_rol, estado, nombre, apellido, correo, telefono, url_perfil)
VALUES
  ((SELECT id_rol FROM ROL WHERE nombre='VENDEDOR'),'ACTIVO','Green','Store','greenstore@demo.com','72000001','/p/greenstore'),
  ((SELECT id_rol FROM ROL WHERE nombre='VENDEDOR'),'ACTIVO','Bici','Plus','biciplus@demo.com','72000002','/p/biciplus'),
  ((SELECT id_rol FROM ROL WHERE nombre='VENDEDOR'),'ACTIVO','EcoTech','Solutions','ecotech@demo.com','72000003','/p/ecotech'),
  ((SELECT id_rol FROM ROL WHERE nombre='VENDEDOR'),'ACTIVO','Zero','Waste','zerowaste@demo.com','72000004','/p/zerowaste'),
  ((SELECT id_rol FROM ROL WHERE nombre='VENDEDOR'),'ACTIVO','Repara','PC','reparapc@demo.com','72000005','/p/reparapc'),
  ((SELECT id_rol FROM ROL WHERE nombre='VENDEDOR'),'ACTIVO','Recicla','YA','reciclaya@demo.com','72000006','/p/reciclaya'),
  ((SELECT id_rol FROM ROL WHERE nombre='VENDEDOR'),'ACTIVO','Eco','Market3','ecomarket3@demo.com','72000007','/p/ecomarket3'),
  ((SELECT id_rol FROM ROL WHERE nombre='VENDEDOR'),'ACTIVO','Tech','Refurb','techrefurb@demo.com','72000008','/p/techrefurb');

-- 1.3 Crear BILLETERA para todos los nuevos (si no tienen)
INSERT INTO BILLETERA (id_usuario, estado, saldo_creditos, saldo_bs, cuenta_bancaria)
SELECT u.id_usuario, 'ACTIVA', 0, 0.00, NULL
FROM USUARIO u
LEFT JOIN BILLETERA b ON b.id_usuario = u.id_usuario
WHERE u.correo IN (
  'camila@demo.com','daniel@demo.com','sofia@demo.com','pablo@demo.com',
  'laura@demo.com','andres@demo.com','valeria@demo.com','roberto@demo.com',
  'natalia@demo.com','sergio@demo.com','patricia@demo.com','marcos@demo.com',
  'lucia@demo.com','ricardo@demo.com','melissa@demo.com','tomas@demo.com',
  'cecilia@demo.com','german@demo.com','roxana@demo.com','kevin@demo.com',
  'mauro@demo.com','dana@demo.com','helena@demo.com','oscar@demo.com',
  'greenstore@demo.com','biciplus@demo.com','ecotech@demo.com',
  'zerowaste@demo.com','reparapc@demo.com','reciclaya@demo.com',
  'ecomarket3@demo.com','techrefurb@demo.com'
)
AND b.id_billetera IS NULL;

/* 2) Productos / servicios extra para nuevos vendedores
   (reutilizan categorías Bicicletas y Tecnología)*/

-- 2.1 Productos de BiciPlus
INSERT INTO PRODUCTO (id_categoria, nombre, descripcion, precio, peso)
SELECT
  (SELECT id_categoria FROM CATEGORIA WHERE nombre='Bicicletas'),
  'Bici Urbana Basic',
  'Bicicleta urbana básica reacondicionada.',
  1100.00,
  14.0;

INSERT INTO PUBLICACION
  (id_usuario, id_categoria, id_tipo_publicacion, estado, id_ubicacion,
   titulo, descripcion, valor_creditos, imagen_url)
SELECT
  (SELECT id_usuario FROM USUARIO WHERE correo='biciplus@demo.com'),
  (SELECT id_categoria FROM CATEGORIA WHERE nombre='Bicicletas'),
  (SELECT id_tipo_publicacion FROM TIPO_PUBLICACION WHERE nombre='PRODUCTO'),
  'PUBLICADA',
  (SELECT id_ubicacion FROM UBICACION WHERE ciudad='Cochabamba'),
  'Bici Urbana Basic',
  'Ideal para uso diario en ciudad.',
  250,
  'https://img/bici_basic.jpg';

INSERT INTO PUBLICACION_PRODUCTO
SELECT
  (SELECT id_publicacion FROM PUBLICACION WHERE titulo='Bici Urbana Basic' LIMIT 1),
  (SELECT id_producto   FROM PRODUCTO   WHERE nombre='Bici Urbana Basic' LIMIT 1),
  1.0000,
  (SELECT id_um FROM UNIDAD_MEDIDA WHERE simbolo='u');

-- 2.2 Productos de GreenStore (Tecnología)
INSERT INTO PRODUCTO (id_categoria, nombre, descripcion, precio, peso)
SELECT
  (SELECT id_categoria FROM CATEGORIA WHERE nombre='Tecnología'),
  'PC Oficina Reacondicionada',
  'CPU compacta para oficina, 8GB RAM, SSD 240GB.',
  1800.00,
  5.5;

INSERT INTO PUBLICACION
  (id_usuario, id_categoria, id_tipo_publicacion, estado, id_ubicacion,
   titulo, descripcion, valor_creditos, imagen_url)
SELECT
  (SELECT id_usuario FROM USUARIO WHERE correo='greenstore@demo.com'),
  (SELECT id_categoria FROM CATEGORIA WHERE nombre='Tecnología'),
  (SELECT id_tipo_publicacion FROM TIPO_PUBLICACION WHERE nombre='PRODUCTO'),
  'PUBLICADA',
  (SELECT id_ubicacion FROM UBICACION WHERE ciudad='La Paz'),
  'PC Oficina Reacondicionada',
  'Equipo compacto, ideal para ofimática.',
  300,
  'https://img/pc_oficina.jpg';

INSERT INTO PUBLICACION_PRODUCTO
SELECT
  (SELECT id_publicacion FROM PUBLICACION WHERE titulo='PC Oficina Reacondicionada' LIMIT 1),
  (SELECT id_producto   FROM PRODUCTO   WHERE nombre='PC Oficina Reacondicionada' LIMIT 1),
  1.0000,
  (SELECT id_um FROM UNIDAD_MEDIDA WHERE simbolo='u');

-- 2.3 Servicios de ReparaPC
INSERT INTO SERVICIO (id_categoria, estado, nombre, descripcion, precio, duracion_min)
SELECT
  (SELECT id_categoria FROM CATEGORIA WHERE nombre='Tecnología'),
  'ACTIVO',
  'Reparación avanzada de PC',
  'Diagnóstico y reparación de fallas de hardware.',
  150.00,
  90;

INSERT INTO PUBLICACION
  (id_usuario, id_categoria, id_tipo_publicacion, estado, id_ubicacion,
   titulo, descripcion, valor_creditos, imagen_url)
SELECT
  (SELECT id_usuario FROM USUARIO WHERE correo='reparapc@demo.com'),
  (SELECT id_categoria FROM CATEGORIA WHERE nombre='Tecnología'),
  (SELECT id_tipo_publicacion FROM TIPO_PUBLICACION WHERE nombre='SERVICIO'),
  'PUBLICADA',
  (SELECT id_ubicacion FROM UBICACION WHERE ciudad='Santa Cruz'),
  'Reparación avanzada de PC',
  'Incluye cambio de piezas y pruebas de estabilidad.',
  140,
  'https://img/serv_reparacion_pc.jpg';

INSERT INTO PUBLICACION_SERVICIO
SELECT
  (SELECT id_publicacion FROM PUBLICACION WHERE titulo='Reparación avanzada de PC' LIMIT 1),
  (SELECT id_servicio   FROM SERVICIO   WHERE nombre='Reparación avanzada de PC' LIMIT 1),
  'L-S 15:00-19:00';

/*    3) Compras de créditos extra (cada nuevo comprador recarga) */

-- Todos compran al menos un Pack 500
CALL sp_compra_creditos_aprobar(
  (SELECT id_usuario FROM USUARIO WHERE correo='camila@demo.com'),
  (SELECT id_paquete FROM PAQUETE_CREDITOS WHERE nombre='Pack 500'),
  'PAY-CAMILA-001'
);
CALL sp_compra_creditos_aprobar(
  (SELECT id_usuario FROM USUARIO WHERE correo='daniel@demo.com'),
  (SELECT id_paquete FROM PAQUETE_CREDITOS WHERE nombre='Pack 500'),
  'PAY-DANIEL-001'
);
CALL sp_compra_creditos_aprobar(
  (SELECT id_usuario FROM USUARIO WHERE correo='sofia@demo.com'),
  (SELECT id_paquete FROM PAQUETE_CREDITOS WHERE nombre='Pack 500'),
  'PAY-SOFIA-001'
);
CALL sp_compra_creditos_aprobar(
  (SELECT id_usuario FROM USUARIO WHERE correo='pablo@demo.com'),
  (SELECT id_paquete FROM PAQUETE_CREDITOS WHERE nombre='Pack 500'),
  'PAY-PABLO-001'
);
CALL sp_compra_creditos_aprobar(
  (SELECT id_usuario FROM USUARIO WHERE correo='laura@demo.com'),
  (SELECT id_paquete FROM PAQUETE_CREDITOS WHERE nombre='Pack 500'),
  'PAY-LAURA-001'
);
CALL sp_compra_creditos_aprobar(
  (SELECT id_usuario FROM USUARIO WHERE correo='andres@demo.com'),
  (SELECT id_paquete FROM PAQUETE_CREDITOS WHERE nombre='Pack 500'),
  'PAY-ANDRES-001'
);
CALL sp_compra_creditos_aprobar(
  (SELECT id_usuario FROM USUARIO WHERE correo='valeria@demo.com'),
  (SELECT id_paquete FROM PAQUETE_CREDITOS WHERE nombre='Pack 500'),
  'PAY-VALERIA-001'
);
CALL sp_compra_creditos_aprobar(
  (SELECT id_usuario FROM USUARIO WHERE correo='roberto@demo.com'),
  (SELECT id_paquete FROM PAQUETE_CREDITOS WHERE nombre='Pack 500'),
  'PAY-ROBERTO-001'
);
CALL sp_compra_creditos_aprobar(
  (SELECT id_usuario FROM USUARIO WHERE correo='natalia@demo.com'),
  (SELECT id_paquete FROM PAQUETE_CREDITOS WHERE nombre='Pack 500'),
  'PAY-NATALIA-001'
);
CALL sp_compra_creditos_aprobar(
  (SELECT id_usuario FROM USUARIO WHERE correo='sergio@demo.com'),
  (SELECT id_paquete FROM PAQUETE_CREDITOS WHERE nombre='Pack 500'),
  'PAY-SERGIO-001'
);
CALL sp_compra_creditos_aprobar(
  (SELECT id_usuario FROM USUARIO WHERE correo='patricia@demo.com'),
  (SELECT id_paquete FROM PAQUETE_CREDITOS WHERE nombre='Pack 500'),
  'PAY-PATRICIA-001'
);
CALL sp_compra_creditos_aprobar(
  (SELECT id_usuario FROM USUARIO WHERE correo='marcos@demo.com'),
  (SELECT id_paquete FROM PAQUETE_CREDITOS WHERE nombre='Pack 500'),
  'PAY-MARCOS-001'
);
CALL sp_compra_creditos_aprobar(
  (SELECT id_usuario FROM USUARIO WHERE correo='lucia@demo.com'),
  (SELECT id_paquete FROM PAQUETE_CREDITOS WHERE nombre='Pack 500'),
  'PAY-LUCIA-001'
);
CALL sp_compra_creditos_aprobar(
  (SELECT id_usuario FROM USUARIO WHERE correo='ricardo@demo.com'),
  (SELECT id_paquete FROM PAQUETE_CREDITOS WHERE nombre='Pack 500'),
  'PAY-RICARDO-001'
);
CALL sp_compra_creditos_aprobar(
  (SELECT id_usuario FROM USUARIO WHERE correo='melissa@demo.com'),
  (SELECT id_paquete FROM PAQUETE_CREDITOS WHERE nombre='Pack 500'),
  'PAY-MELISSA-001'
);
CALL sp_compra_creditos_aprobar(
  (SELECT id_usuario FROM USUARIO WHERE correo='tomas@demo.com'),
  (SELECT id_paquete FROM PAQUETE_CREDITOS WHERE nombre='Pack 500'),
  'PAY-TOMAS-001'
);
CALL sp_compra_creditos_aprobar(
  (SELECT id_usuario FROM USUARIO WHERE correo='cecilia@demo.com'),
  (SELECT id_paquete FROM PAQUETE_CREDITOS WHERE nombre='Pack 500'),
  'PAY-CECILIA-001'
);
CALL sp_compra_creditos_aprobar(
  (SELECT id_usuario FROM USUARIO WHERE correo='german@demo.com'),
  (SELECT id_paquete FROM PAQUETE_CREDITOS WHERE nombre='Pack 500'),
  'PAY-GERMAN-001'
);
CALL sp_compra_creditos_aprobar(
  (SELECT id_usuario FROM USUARIO WHERE correo='roxana@demo.com'),
  (SELECT id_paquete FROM PAQUETE_CREDITOS WHERE nombre='Pack 500'),
  'PAY-ROXANA-001'
);
CALL sp_compra_creditos_aprobar(
  (SELECT id_usuario FROM USUARIO WHERE correo='kevin@demo.com'),
  (SELECT id_paquete FROM PAQUETE_CREDITOS WHERE nombre='Pack 500'),
  'PAY-KEVIN-001'
);
CALL sp_compra_creditos_aprobar(
  (SELECT id_usuario FROM USUARIO WHERE correo='mauro@demo.com'),
  (SELECT id_paquete FROM PAQUETE_CREDITOS WHERE nombre='Pack 500'),
  'PAY-MAURO-001'
);
CALL sp_compra_creditos_aprobar(
  (SELECT id_usuario FROM USUARIO WHERE correo='dana@demo.com'),
  (SELECT id_paquete FROM PAQUETE_CREDITOS WHERE nombre='Pack 500'),
  'PAY-DANA-001'
);
CALL sp_compra_creditos_aprobar(
  (SELECT id_usuario FROM USUARIO WHERE correo='helena@demo.com'),
  (SELECT id_paquete FROM PAQUETE_CREDITOS WHERE nombre='Pack 500'),
  'PAY-HELENA-001'
);
CALL sp_compra_creditos_aprobar(
  (SELECT id_usuario FROM USUARIO WHERE correo='oscar@demo.com'),
  (SELECT id_paquete FROM PAQUETE_CREDITOS WHERE nombre='Pack 500'),
  'PAY-OSCAR-001'
);

/*    4) Intercambios extra
   (cada comprador hace al menos un intercambio)*/

-- Notas de créditos:
-- Bici Urbana Eco          320
-- Bici Plegable Ciudad     280
-- Bici Urbana Basic        250
-- Laptop Reacondicionada   350
-- Monitor 24 Reciclado     220
-- Mantenimiento laptop     110
-- Repr. avanzada PC        140
-- Mantenimiento y limpieza PC 120
-- Formateo e instalación Windows 90
-- PC Oficina Reacondicionada 300

-- 4.1 Algunos compran bicicletas
CALL sp_realizar_intercambio(
  (SELECT id_usuario FROM USUARIO WHERE correo='camila@demo.com'),
  (SELECT id_publicacion FROM PUBLICACION WHERE titulo='Bici Urbana Eco' LIMIT 1),
  320
); SET @id_tx := (SELECT MAX(id_transaccion) FROM TRANSACCION);
UPDATE TRANSACCION SET estado='COMPLETADA' WHERE id_transaccion=@id_tx;

CALL sp_realizar_intercambio(
  (SELECT id_usuario FROM USUARIO WHERE correo='daniel@demo.com'),
  (SELECT id_publicacion FROM PUBLICACION WHERE titulo='Bici Plegable Ciudad' LIMIT 1),
  280
); SET @id_tx := (SELECT MAX(id_transaccion) FROM TRANSACCION);
UPDATE TRANSACCION SET estado='COMPLETADA' WHERE id_transaccion=@id_tx;

CALL sp_realizar_intercambio(
  (SELECT id_usuario FROM USUARIO WHERE correo='sofia@demo.com'),
  (SELECT id_publicacion FROM PUBLICACION WHERE titulo='Bici Urbana Basic' LIMIT 1),
  250
); SET @id_tx := (SELECT MAX(id_transaccion) FROM TRANSACCION);
UPDATE TRANSACCION SET estado='COMPLETADA' WHERE id_transaccion=@id_tx;

CALL sp_realizar_intercambio(
  (SELECT id_usuario FROM USUARIO WHERE correo='pablo@demo.com'),
  (SELECT id_publicacion FROM PUBLICACION WHERE titulo='Bicicleta montaña Pro' LIMIT 1),
  450
); SET @id_tx := (SELECT MAX(id_transaccion) FROM TRANSACCION);
UPDATE TRANSACCION SET estado='COMPLETADA' WHERE id_transaccion=@id_tx;

-- 4.2 Otros compran productos de tecnología
CALL sp_realizar_intercambio(
  (SELECT id_usuario FROM USUARIO WHERE correo='laura@demo.com'),
  (SELECT id_publicacion FROM PUBLICACION WHERE titulo='Laptop Reacondicionada i5' LIMIT 1),
  350
); SET @id_tx := (SELECT MAX(id_transaccion) FROM TRANSACCION);
UPDATE TRANSACCION SET estado='COMPLETADA' WHERE id_transaccion=@id_tx;

CALL sp_realizar_intercambio(
  (SELECT id_usuario FROM USUARIO WHERE correo='andres@demo.com'),
  (SELECT id_publicacion FROM PUBLICACION WHERE titulo='Monitor 24 Reciclado' LIMIT 1),
  220
); SET @id_tx := (SELECT MAX(id_transaccion) FROM TRANSACCION);
UPDATE TRANSACCION SET estado='COMPLETADA' WHERE id_transaccion=@id_tx;

CALL sp_realizar_intercambio(
  (SELECT id_usuario FROM USUARIO WHERE correo='valeria@demo.com'),
  (SELECT id_publicacion FROM PUBLICACION WHERE titulo='PC Oficina Reacondicionada' LIMIT 1),
  300
); SET @id_tx := (SELECT MAX(id_transaccion) FROM TRANSACCION);
UPDATE TRANSACCION SET estado='COMPLETADA' WHERE id_transaccion=@id_tx;

CALL sp_realizar_intercambio(
  (SELECT id_usuario FROM USUARIO WHERE correo='roberto@demo.com'),
  (SELECT id_publicacion FROM PUBLICACION WHERE titulo='Laptop Reacondicionada i5' LIMIT 1),
  350
); SET @id_tx := (SELECT MAX(id_transaccion) FROM TRANSACCION);
UPDATE TRANSACCION SET estado='COMPLETADA' WHERE id_transaccion=@id_tx;

-- 4.3 Otros compran servicios
CALL sp_realizar_intercambio(
  (SELECT id_usuario FROM USUARIO WHERE correo='natalia@demo.com'),
  (SELECT id_publicacion FROM PUBLICACION WHERE titulo='Mantenimiento laptop básico' LIMIT 1),
  110
); SET @id_tx := (SELECT MAX(id_transaccion) FROM TRANSACCION);
UPDATE TRANSACCION SET estado='COMPLETADA' WHERE id_transaccion=@id_tx;

CALL sp_realizar_intercambio(
  (SELECT id_usuario FROM USUARIO WHERE correo='sergio@demo.com'),
  (SELECT id_publicacion FROM PUBLICACION WHERE titulo='Reparación avanzada de PC' LIMIT 1),
  140
); SET @id_tx := (SELECT MAX(id_transaccion) FROM TRANSACCION);
UPDATE TRANSACCION SET estado='COMPLETADA' WHERE id_transaccion=@id_tx;

CALL sp_realizar_intercambio(
  (SELECT id_usuario FROM USUARIO WHERE correo='patricia@demo.com'),
  (SELECT id_publicacion FROM PUBLICACION WHERE titulo='Mantenimiento y limpieza de PC' LIMIT 1),
  120
); SET @id_tx := (SELECT MAX(id_transaccion) FROM TRANSACCION);
UPDATE TRANSACCION SET estado='COMPLETADA' WHERE id_transaccion=@id_tx;

CALL sp_realizar_intercambio(
  (SELECT id_usuario FROM USUARIO WHERE correo='marcos@demo.com'),
  (SELECT id_publicacion FROM PUBLICACION WHERE titulo='Formateo e instalación de Windows' LIMIT 1),
  90
); SET @id_tx := (SELECT MAX(id_transaccion) FROM TRANSACCION);
UPDATE TRANSACCION SET estado='COMPLETADA' WHERE id_transaccion=@id_tx;

CALL sp_realizar_intercambio(
  (SELECT id_usuario FROM USUARIO WHERE correo='lucia@demo.com'),
  (SELECT id_publicacion FROM PUBLICACION WHERE titulo='Mantenimiento laptop básico' LIMIT 1),
  110
); SET @id_tx := (SELECT MAX(id_transaccion) FROM TRANSACCION);
UPDATE TRANSACCION SET estado='COMPLETADA' WHERE id_transaccion=@id_tx;

CALL sp_realizar_intercambio(
  (SELECT id_usuario FROM USUARIO WHERE correo='ricardo@demo.com'),
  (SELECT id_publicacion FROM PUBLICACION WHERE titulo='Reparación avanzada de PC' LIMIT 1),
  140
); SET @id_tx := (SELECT MAX(id_transaccion) FROM TRANSACCION);
UPDATE TRANSACCION SET estado='COMPLETADA' WHERE id_transaccion=@id_tx;

-- 4.4 Algunos hacen 2 operaciones
CALL sp_realizar_intercambio(
  (SELECT id_usuario FROM USUARIO WHERE correo='melissa@demo.com'),
  (SELECT id_publicacion FROM PUBLICACION WHERE titulo='Bici Urbana Basic' LIMIT 1),
  250
); SET @id_tx := (SELECT MAX(id_transaccion) FROM TRANSACCION);
UPDATE TRANSACCION SET estado='COMPLETADA' WHERE id_transaccion=@id_tx;

CALL sp_realizar_intercambio(
  (SELECT id_usuario FROM USUARIO WHERE correo='melissa@demo.com'),
  (SELECT id_publicacion FROM PUBLICACION WHERE titulo='Mantenimiento laptop básico' LIMIT 1),
  110
); SET @id_tx := (SELECT MAX(id_transaccion) FROM TRANSACCION);
UPDATE TRANSACCION SET estado='COMPLETADA' WHERE id_transaccion=@id_tx;

CALL sp_realizar_intercambio(
  (SELECT id_usuario FROM USUARIO WHERE correo='tomas@demo.com'),
  (SELECT id_publicacion FROM PUBLICACION WHERE titulo='Laptop Reacondicionada i5' LIMIT 1),
  350
); SET @id_tx := (SELECT MAX(id_transaccion) FROM TRANSACCION);
UPDATE TRANSACCION SET estado='COMPLETADA' WHERE id_transaccion=@id_tx;

CALL sp_realizar_intercambio(
  (SELECT id_usuario FROM USUARIO WHERE correo='cecilia@demo.com'),
  (SELECT id_publicacion FROM PUBLICACION WHERE titulo='PC Oficina Reacondicionada' LIMIT 1),
  300
); SET @id_tx := (SELECT MAX(id_transaccion) FROM TRANSACCION);
UPDATE TRANSACCION SET estado='COMPLETADA' WHERE id_transaccion=@id_tx;

CALL sp_realizar_intercambio(
  (SELECT id_usuario FROM USUARIO WHERE correo='german@demo.com'),
  (SELECT id_publicacion FROM PUBLICACION WHERE titulo='Monitor 24 Reciclado' LIMIT 1),
  220
); SET @id_tx := (SELECT MAX(id_transaccion) FROM TRANSACCION);
UPDATE TRANSACCION SET estado='COMPLETADA' WHERE id_transaccion=@id_tx;

CALL sp_realizar_intercambio(
  (SELECT id_usuario FROM USUARIO WHERE correo='roxana@demo.com'),
  (SELECT id_publicacion FROM PUBLICACION WHERE titulo='Bici Urbana Eco' LIMIT 1),
  320
); SET @id_tx := (SELECT MAX(id_transaccion) FROM TRANSACCION);
UPDATE TRANSACCION SET estado='COMPLETADA' WHERE id_transaccion=@id_tx;

CALL sp_realizar_intercambio(
  (SELECT id_usuario FROM USUARIO WHERE correo='kevin@demo.com'),
  (SELECT id_publicacion FROM PUBLICACION WHERE titulo='Mantenimiento y limpieza de PC' LIMIT 1),
  120
); SET @id_tx := (SELECT MAX(id_transaccion) FROM TRANSACCION);
UPDATE TRANSACCION SET estado='COMPLETADA' WHERE id_transaccion=@id_tx;

CALL sp_realizar_intercambio(
  (SELECT id_usuario FROM USUARIO WHERE correo='mauro@demo.com'),
  (SELECT id_publicacion FROM PUBLICACION WHERE titulo='Formateo e instalación de Windows' LIMIT 1),
  90
); SET @id_tx := (SELECT MAX(id_transaccion) FROM TRANSACCION);
UPDATE TRANSACCION SET estado='COMPLETADA' WHERE id_transaccion=@id_tx;

CALL sp_realizar_intercambio(
  (SELECT id_usuario FROM USUARIO WHERE correo='dana@demo.com'),
  (SELECT id_publicacion FROM PUBLICACION WHERE titulo='Mantenimiento laptop básico' LIMIT 1),
  110
); SET @id_tx := (SELECT MAX(id_transaccion) FROM TRANSACCION);
UPDATE TRANSACCION SET estado='COMPLETADA' WHERE id_transaccion=@id_tx;

CALL sp_realizar_intercambio(
  (SELECT id_usuario FROM USUARIO WHERE correo='helena@demo.com'),
  (SELECT id_publicacion FROM PUBLICACION WHERE titulo='Bici Plegable Ciudad' LIMIT 1),
  280
); SET @id_tx := (SELECT MAX(id_transaccion) FROM TRANSACCION);
UPDATE TRANSACCION SET estado='COMPLETADA' WHERE id_transaccion=@id_tx;

CALL sp_realizar_intercambio(
  (SELECT id_usuario FROM USUARIO WHERE correo='oscar@demo.com'),
  (SELECT id_publicacion FROM PUBLICACION WHERE titulo='PC Oficina Reacondicionada' LIMIT 1),
  300
); SET @id_tx := (SELECT MAX(id_transaccion) FROM TRANSACCION);
UPDATE TRANSACCION SET estado='COMPLETADA' WHERE id_transaccion=@id_tx;

/* 5) Actividades sostenibles extra*/

CALL sp_registrar_actividad_sostenible(
  (SELECT id_usuario FROM USUARIO WHERE correo='camila@demo.com'),
  (SELECT id_tipo_actividad FROM TIPO_ACTIVIDAD WHERE nombre='RECICLAJE'),
  'Participó en jornada de reciclaje de plástico', 15,
  'https://evidencias/reciclaje_camila.jpg'
);

CALL sp_registrar_actividad_sostenible(
  (SELECT id_usuario FROM USUARIO WHERE correo='daniel@demo.com'),
  (SELECT id_tipo_actividad FROM TIPO_ACTIVIDAD WHERE nombre='RECICLAJE'),
  'Entregó 5kg de papel usado', 12,
  'https://evidencias/reciclaje_daniel.jpg'
);

CALL sp_registrar_actividad_sostenible(
  (SELECT id_usuario FROM USUARIO WHERE correo='sofia@demo.com'),
  (SELECT id_tipo_actividad FROM TIPO_ACTIVIDAD WHERE nombre='RECICLAJE'),
  'Recolectó botellas PET en su barrio', 18,
  'https://evidencias/reciclaje_sofia.jpg'
);

CALL sp_registrar_actividad_sostenible(
  (SELECT id_usuario FROM USUARIO WHERE correo='pablo@demo.com'),
  (SELECT id_tipo_actividad FROM TIPO_ACTIVIDAD WHERE nombre='RECICLAJE'),
  'Donó electrónicos viejos a reciclaje', 20,
  'https://evidencias/reciclaje_pablo.jpg'
);

CALL sp_registrar_actividad_sostenible(
  (SELECT id_usuario FROM USUARIO WHERE correo='laura@demo.com'),
  (SELECT id_tipo_actividad FROM TIPO_ACTIVIDAD WHERE nombre='RECICLAJE'),
  'Separó residuos en su oficina por todo el mes', 25,
  'https://evidencias/reciclaje_laura.jpg'
);

CALL sp_registrar_actividad_sostenible(
  (SELECT id_usuario FROM USUARIO WHERE correo='andres@demo.com'),
  (SELECT id_tipo_actividad FROM TIPO_ACTIVIDAD WHERE nombre='RECICLAJE'),
  'Apoyó campaña de recolección de vidrio', 16,
  'https://evidencias/reciclaje_andres.jpg'
);

CALL sp_registrar_actividad_sostenible(
  (SELECT id_usuario FROM USUARIO WHERE correo='valeria@demo.com'),
  (SELECT id_tipo_actividad FROM TIPO_ACTIVIDAD WHERE nombre='RECICLAJE'),
  'Entregó 3kg de latas de aluminio', 10,
  'https://evidencias/reciclaje_valeria.jpg'
);

CALL sp_registrar_actividad_sostenible(
  (SELECT id_usuario FROM USUARIO WHERE correo='roberto@demo.com'),
  (SELECT id_tipo_actividad FROM TIPO_ACTIVIDAD WHERE nombre='RECICLAJE'),
  'Organizó punto de acopio de pilas', 22,
  'https://evidencias/reciclaje_roberto.jpg'
);

CALL sp_registrar_actividad_sostenible(
  (SELECT id_usuario FROM USUARIO WHERE correo='natalia@demo.com'),
  (SELECT id_tipo_actividad FROM TIPO_ACTIVIDAD WHERE nombre='RECICLAJE'),
  'Participó en limpieza de río urbano', 30,
  'https://evidencias/reciclaje_natalia.jpg'
);

CALL sp_registrar_actividad_sostenible(
  (SELECT id_usuario FROM USUARIO WHERE correo='sergio@demo.com'),
  (SELECT id_tipo_actividad FROM TIPO_ACTIVIDAD WHERE nombre='RECICLAJE'),
  'Apoyó campaña de recuperación de e-waste', 18,
  'https://evidencias/reciclaje_sergio.jpg'
);

/* 6) Regenerar reporte de impacto para 2025-11 */

CALL sp_generar_reporte_impacto(
  (SELECT id_tipo_reporte FROM TIPO_REPORTE WHERE nombre='MENSUAL'),
  (SELECT id_periodo FROM PERIODO WHERE nombre='2025-11'),
  NULL
);

/*    7) Chequeo rápido de saldos de algunos usuarios */

SELECT u.correo, b.saldo_creditos
FROM USUARIO u
LEFT JOIN BILLETERA b ON b.id_usuario = u.id_usuario
WHERE u.correo IN (
  'ana@demo.com','luis@demo.com','carla@demo.com','diego@demo.com','marta@demo.com',
  'bruno@demo.com','elena@demo.com','fernando@demo.com','gaby@demo.com',
  'camila@demo.com','daniel@demo.com','sofia@demo.com','pablo@demo.com','laura@demo.com',
  'andres@demo.com','valeria@demo.com','roberto@demo.com','natalia@demo.com',
  'sergio@demo.com','patricia@demo.com','marcos@demo.com','lucia@demo.com',
  'ricardo@demo.com','melissa@demo.com','tomas@demo.com','cecilia@demo.com',
  'german@demo.com','roxana@demo.com','kevin@demo.com','mauro@demo.com',
  'dana@demo.com','helena@demo.com','oscar@demo.com'
)
ORDER BY u.correo;

use creditos_verdes2;
INSERT IGNORE INTO SUSCRIPCION_PREMIUM (id_usuario, fecha_inicio, fecha_fin, estado, monto_bs)
SELECT
  id_usuario,
  '2025-11-05 10:00:00',
  '2025-12-05 10:00:00',
  'ACTIVA',
  30.00
FROM USUARIO
WHERE correo = 'ana@demo.com';

INSERT IGNORE INTO SUSCRIPCION_PREMIUM (id_usuario, fecha_inicio, fecha_fin, estado, monto_bs)
SELECT
  id_usuario,
  '2025-10-20 09:00:00',
  '2025-11-20 09:00:00',
  'VENCIDA',
  30.00
FROM USUARIO
WHERE correo = 'luis@demo.com';
</file>

<file path="base de datos/segunda_ronda.sql">
USE CREDITOS_VERDES2;

-- 0) Asegurar equivalencia de impacto para Tecnología (por si acaso)

INSERT IGNORE INTO EQUIVALENCIA_IMPACTO (id_categoria, id_um, co2_por_unidad, agua_por_unidad, energia_por_unidad)
SELECT
  (SELECT id_categoria FROM CATEGORIA WHERE nombre = 'Tecnología' LIMIT 1),
  (SELECT id_um FROM UNIDAD_MEDIDA WHERE simbolo = 'u' LIMIT 1),
  8.000000,
  30.000000,
  3.500000;

/*    1) Nuevos USUARIOS (12 compradores + 6 vendedores)*/

-- 1.1 Compradores NUEVOS (12)
INSERT INTO USUARIO (id_rol, estado, nombre, apellido, correo, telefono, url_perfil)
VALUES
  ((SELECT id_rol FROM ROL WHERE nombre='COMPRADOR'),'ACTIVO','Brenda','Molina','brenda@demo.com','73000001','/p/brenda03'),
  ((SELECT id_rol FROM ROL WHERE nombre='COMPRADOR'),'ACTIVO','Ignacio','Perez','ignacio@demo.com','73000002','/p/ignacio03'),
  ((SELECT id_rol FROM ROL WHERE nombre='COMPRADOR'),'ACTIVO','Julieta','Suarez','julieta@demo.com','73000003','/p/julieta03'),
  ((SELECT id_rol FROM ROL WHERE nombre='COMPRADOR'),'ACTIVO','Hugo','Montes','huugo@demo.com','73000004','/p/hugo03'),
  ((SELECT id_rol FROM ROL WHERE nombre='COMPRADOR'),'ACTIVO','Olivia','Arce','oliviaa@demo.com','73000005','/p/olivia03'),
  ((SELECT id_rol FROM ROL WHERE nombre='COMPRADOR'),'ACTIVO','Mateo','Flores','mateoo@demo.com','73000006','/p/mateo03'),
  ((SELECT id_rol FROM ROL WHERE nombre='COMPRADOR'),'ACTIVO','Carolina','Salvatierra','caroliina@demo.com','73000007','/p/carolina03'),
  ((SELECT id_rol FROM ROL WHERE nombre='COMPRADOR'),'ACTIVO','Esteban','Villarroel','estebann@demo.com','73000008','/p/esteban03'),
  ((SELECT id_rol FROM ROL WHERE nombre='COMPRADOR'),'ACTIVO','Paola','Mendez','paoula@demo.com','73000009','/p/paola03'),
  ((SELECT id_rol FROM ROL WHERE nombre='COMPRADOR'),'ACTIVO','Javier','Loayza','javieri@demo.com','73000010','/p/javier03'),
  ((SELECT id_rol FROM ROL WHERE nombre='COMPRADOR'),'ACTIVO','Noelia','Ruiz','noelial@demo.com','73000011','/p/noelia03'),
  ((SELECT id_rol FROM ROL WHERE nombre='COMPRADOR'),'ACTIVO','Franco','Gutierrez','francos@demo.com','73000012','/p/franco03');


-- 1.2 Vendedores NUEVOS (6)
INSERT INTO USUARIO (id_rol, estado, nombre, apellido, correo, telefono, url_perfil)
VALUES
  ((SELECT id_rol FROM ROL WHERE nombre='VENDEDOR'),'ACTIVO','EcoRuedas','SRL','ecoruedas@demo.com','74000001','/p/ecoruedas'),
  ((SELECT id_rol FROM ROL WHERE nombre='VENDEDOR'),'ACTIVO','Smart','Tech','smarttech@demo.com','74000002','/p/smarttech'),
  ((SELECT id_rol FROM ROL WHERE nombre='VENDEDOR'),'ACTIVO','Cleta','City','cletacity@demo.com','74000003','/p/cletacity'),
  ((SELECT id_rol FROM ROL WHERE nombre='VENDEDOR'),'ACTIVO','Green','Office','greenoffice@demo.com','74000004','/p/greenoffice'),
  ((SELECT id_rol FROM ROL WHERE nombre='VENDEDOR'),'ACTIVO','Compu','Fix','compufix@demo.com','74000005','/p/compufix'),
  ((SELECT id_rol FROM ROL WHERE nombre='VENDEDOR'),'ACTIVO','ReUse','Hub','reusehub@demo.com','74000006','/p/reusehub');

-- 1.3 Crear BILLETERA para todos los nuevos (si no tienen)
INSERT INTO BILLETERA (id_usuario, estado, saldo_creditos, saldo_bs, cuenta_bancaria)
SELECT u.id_usuario, 'ACTIVA', 0, 0.00, NULL
FROM USUARIO u
LEFT JOIN BILLETERA b ON b.id_usuario = u.id_usuario
WHERE u.correo IN (
  'brenda@demo.com','ignacio@demo.com','julieta@demo.com','hugo@demo.com',
  'olivia@demo.com','mateo@demo.com','carolina@demo.com','esteban@demo.com',
  'paola@demo.com','javier@demo.com','noelia@demo.com','franco@demo.com',
  'ecoruedas@demo.com','smarttech@demo.com','cletacity@demo.com',
  'greenoffice@demo.com','compufix@demo.com','reusehub@demo.com'
)
AND b.id_billetera IS NULL;

/*    2) Nuevos PRODUCTOS / SERVICIOS + PUBLICACIONES*/

-- 2.1 Bicicletas de EcoRuedas y CletaCity
INSERT INTO PRODUCTO (id_categoria, nombre, descripcion, precio, peso)
SELECT
  (SELECT id_categoria FROM CATEGORIA WHERE nombre='Bicicletas'),
  'Bici Híbrida Urbana',
  'Bicicleta híbrida para ciudad, reacondicionada.',
  1450.00,
  13.8;

INSERT INTO PRODUCTO (id_categoria, nombre, descripcion, precio, peso)
SELECT
  (SELECT id_categoria FROM CATEGORIA WHERE nombre='Bicicletas'),
  'Bici MTB Junior',
  'Bicicleta de montaña para jóvenes, reacondicionada.',
  980.00,
  12.5;

INSERT INTO PRODUCTO (id_categoria, nombre, descripcion, precio, peso)
SELECT
  (SELECT id_categoria FROM CATEGORIA WHERE nombre='Bicicletas'),
  'Bici Paseo Vintage',
  'Bicicleta de paseo estilo vintage reutilizada.',
  1300.00,
  14.2;

-- Publicaciones de Bicicletas
INSERT INTO PUBLICACION
  (id_usuario, id_categoria, id_tipo_publicacion, estado, id_ubicacion,
   titulo, descripcion, valor_creditos, imagen_url)
SELECT
  (SELECT id_usuario FROM USUARIO WHERE correo='ecoruedas@demo.com'),
  (SELECT id_categoria FROM CATEGORIA WHERE nombre='Bicicletas'),
  (SELECT id_tipo_publicacion FROM TIPO_PUBLICACION WHERE nombre='PRODUCTO'),
  'PUBLICADA',
  (SELECT id_ubicacion FROM UBICACION WHERE ciudad='La Paz'),
  'Bici Híbrida Urbana',
  'Ideal para uso diario y rutas ligeras, reacondicionada con componentes revisados.',
  340,
  'https://img/bici_hibrida_urbana.jpg';

INSERT INTO PUBLICACION_PRODUCTO
SELECT
  (SELECT id_publicacion FROM PUBLICACION WHERE titulo='Bici Híbrida Urbana' LIMIT 1),
  (SELECT id_producto   FROM PRODUCTO   WHERE nombre='Bici Híbrida Urbana' LIMIT 1),
  1.0000,
  (SELECT id_um FROM UNIDAD_MEDIDA WHERE simbolo='u');

INSERT INTO PUBLICACION
  (id_usuario, id_categoria, id_tipo_publicacion, estado, id_ubicacion,
   titulo, descripcion, valor_creditos, imagen_url)
SELECT
  (SELECT id_usuario FROM USUARIO WHERE correo='cletacity@demo.com'),
  (SELECT id_categoria FROM CATEGORIA WHERE nombre='Bicicletas'),
  (SELECT id_tipo_publicacion FROM TIPO_PUBLICACION WHERE nombre='PRODUCTO'),
  'PUBLICADA',
  (SELECT id_ubicacion FROM UBICACION WHERE ciudad='Cochabamba'),
  'Bici MTB Junior',
  'Bici de montaña reacondicionada para jóvenes, perfecta para parques y ciclovías.',
  260,
  'https://img/bici_mtb_junior.jpg';

INSERT INTO PUBLICACION_PRODUCTO
SELECT
  (SELECT id_publicacion FROM PUBLICACION WHERE titulo='Bici MTB Junior' LIMIT 1),
  (SELECT id_producto   FROM PRODUCTO   WHERE nombre='Bici MTB Junior' LIMIT 1),
  1.0000,
  (SELECT id_um FROM UNIDAD_MEDIDA WHERE simbolo='u');

INSERT INTO PUBLICACION
  (id_usuario, id_categoria, id_tipo_publicacion, estado, id_ubicacion,
   titulo, descripcion, valor_creditos, imagen_url)
SELECT
  (SELECT id_usuario FROM USUARIO WHERE correo='cletacity@demo.com'),
  (SELECT id_categoria FROM CATEGORIA WHERE nombre='Bicicletas'),
  (SELECT id_tipo_publicacion FROM TIPO_PUBLICACION WHERE nombre='PRODUCTO'),
  'PUBLICADA',
  (SELECT id_ubicacion FROM UBICACION WHERE ciudad='La Paz'),
  'Bici Paseo Vintage',
  'Bicicleta de paseo con canastillo y estilo retro, recuperada y ajustada.',
  280,
  'https://img/bici_paseo_vintage.jpg';

INSERT INTO PUBLICACION_PRODUCTO
SELECT
  (SELECT id_publicacion FROM PUBLICACION WHERE titulo='Bici Paseo Vintage' LIMIT 1),
  (SELECT id_producto   FROM PRODUCTO   WHERE nombre='Bici Paseo Vintage' LIMIT 1),
  1.0000,
  (SELECT id_um FROM UNIDAD_MEDIDA WHERE simbolo='u');

-- 2.2 Tecnología: productos de SmartTech y GreenOffice
INSERT INTO PRODUCTO (id_categoria, nombre, descripcion, precio, peso)
SELECT
  (SELECT id_categoria FROM CATEGORIA WHERE nombre='Tecnología'),
  'Mini PC Eco Oficina',
  'Mini PC de bajo consumo, reacondicionada para tareas de oficina.',
  1900.00,
  4.2;

INSERT INTO PRODUCTO (id_categoria, nombre, descripcion, precio, peso)
SELECT
  (SELECT id_categoria FROM CATEGORIA WHERE nombre='Tecnología'),
  'Monitor 27 Reciclado',
  'Monitor de 27 pulgadas reacondicionado, ideal para multitarea.',
  1350.00,
  5.8;

INSERT INTO PRODUCTO (id_categoria, nombre, descripcion, precio, peso)
SELECT
  (SELECT id_categoria FROM CATEGORIA WHERE nombre='Tecnología'),
  'Kit Oficina Reacondicionada',
  'Combo de PC y monitor reacondicionados para oficina sostenible.',
  2600.00,
  10.5;

INSERT INTO PUBLICACION
  (id_usuario, id_categoria, id_tipo_publicacion, estado, id_ubicacion,
   titulo, descripcion, valor_creditos, imagen_url)
SELECT
  (SELECT id_usuario FROM USUARIO WHERE correo='smarttech@demo.com'),
  (SELECT id_categoria FROM CATEGORIA WHERE nombre='Tecnología'),
  (SELECT id_tipo_publicacion FROM TIPO_PUBLICACION WHERE nombre='PRODUCTO'),
  'PUBLICADA',
  (SELECT id_ubicacion FROM UBICACION WHERE ciudad='La Paz'),
  'Mini PC Eco Oficina',
  'Equipo compacto y eficiente, ideal para reducir consumo energético.',
  320,
  'https://img/mini_pc_eco.jpg';

INSERT INTO PUBLICACION_PRODUCTO
SELECT
  (SELECT id_publicacion FROM PUBLICACION WHERE titulo='Mini PC Eco Oficina' LIMIT 1),
  (SELECT id_producto   FROM PRODUCTO   WHERE nombre='Mini PC Eco Oficina' LIMIT 1),
  1.0000,
  (SELECT id_um FROM UNIDAD_MEDIDA WHERE simbolo='u');

INSERT INTO PUBLICACION
  (id_usuario, id_categoria, id_tipo_publicacion, estado, id_ubicacion,
   titulo, descripcion, valor_creditos, imagen_url)
SELECT
  (SELECT id_usuario FROM USUARIO WHERE correo='greenoffice@demo.com'),
  (SELECT id_categoria FROM CATEGORIA WHERE nombre='Tecnología'),
  (SELECT id_tipo_publicacion FROM TIPO_PUBLICACION WHERE nombre='PRODUCTO'),
  'PUBLICADA',
  (SELECT id_ubicacion FROM UBICACION WHERE ciudad='Cochabamba'),
  'Monitor 27 Reciclado',
  'Pantalla de 27" reacondicionada, excelente para trabajo y estudio.',
  240,
  'https://img/monitor_27_reciclado.jpg';

INSERT INTO PUBLICACION_PRODUCTO
SELECT
  (SELECT id_publicacion FROM PUBLICACION WHERE titulo='Monitor 27 Reciclado' LIMIT 1),
  (SELECT id_producto   FROM PRODUCTO   WHERE nombre='Monitor 27 Reciclado' LIMIT 1),
  1.0000,
  (SELECT id_um FROM UNIDAD_MEDIDA WHERE simbolo='u');

INSERT INTO PUBLICACION
  (id_usuario, id_categoria, id_tipo_publicacion, estado, id_ubicacion,
   titulo, descripcion, valor_creditos, imagen_url)
SELECT
  (SELECT id_usuario FROM USUARIO WHERE correo='greenoffice@demo.com'),
  (SELECT id_categoria FROM CATEGORIA WHERE nombre='Tecnología'),
  (SELECT id_tipo_publicacion FROM TIPO_PUBLICACION WHERE nombre='PRODUCTO'),
  'PUBLICADA',
  (SELECT id_ubicacion FROM UBICACION WHERE ciudad='La Paz'),
  'Kit Oficina Reacondicionada',
  'Combo eco-friendly de PC + monitor reacondicionados.',
  280,
  'https://img/kit_oficina_reacondicionada.jpg';

INSERT INTO PUBLICACION_PRODUCTO
SELECT
  (SELECT id_publicacion FROM PUBLICACION WHERE titulo='Kit Oficina Reacondicionada' LIMIT 1),
  (SELECT id_producto   FROM PRODUCTO   WHERE nombre='Kit Oficina Reacondicionada' LIMIT 1),
  1.0000,
  (SELECT id_um FROM UNIDAD_MEDIDA WHERE simbolo='u');

-- 2.3 Servicio de tecnología (CompuFix)
INSERT INTO SERVICIO (id_categoria, estado, nombre, descripcion, precio, duracion_min)
SELECT
  (SELECT id_categoria FROM CATEGORIA WHERE nombre='Tecnología'),
  'ACTIVO',
  'Upgrade SSD + limpieza',
  'Servicio de instalación de SSD y limpieza interna completa.',
  130.00,
  75;

INSERT INTO PUBLICACION
  (id_usuario, id_categoria, id_tipo_publicacion, estado, id_ubicacion,
   titulo, descripcion, valor_creditos, imagen_url)
SELECT
  (SELECT id_usuario FROM USUARIO WHERE correo='compufix@demo.com'),
  (SELECT id_categoria FROM CATEGORIA WHERE nombre='Tecnología'),
  (SELECT id_tipo_publicacion FROM TIPO_PUBLICACION WHERE nombre='SERVICIO'),
  'PUBLICADA',
  (SELECT id_ubicacion FROM UBICACION WHERE ciudad='Cochabamba'),
  'Upgrade SSD + limpieza',
  'Mejora el rendimiento de tu PC y alarga su vida útil.',
  130,
  'https://img/upgrade_ssd_limpieza.jpg';

INSERT INTO PUBLICACION_SERVICIO
SELECT
  (SELECT id_publicacion FROM PUBLICACION WHERE titulo='Upgrade SSD + limpieza' LIMIT 1),
  (SELECT id_servicio   FROM SERVICIO   WHERE nombre='Upgrade SSD + limpieza' LIMIT 1),
  'L-S 10:00-18:00';

/*    3) Compras de créditos extra (Pack 500 para cada comprador nuevo)*/

CALL sp_compra_creditos_aprobar(
  (SELECT id_usuario FROM USUARIO WHERE correo='brenda@demo.com'),
  (SELECT id_paquete FROM PAQUETE_CREDITOS WHERE nombre='Pack 500'),
  'PAY-BRENDA-001'
);
CALL sp_compra_creditos_aprobar(
  (SELECT id_usuario FROM USUARIO WHERE correo='ignacio@demo.com'),
  (SELECT id_paquete FROM PAQUETE_CREDITOS WHERE nombre='Pack 500'),
  'PAY-IGNACIO-001'
);
CALL sp_compra_creditos_aprobar(
  (SELECT id_usuario FROM USUARIO WHERE correo='julieta@demo.com'),
  (SELECT id_paquete FROM PAQUETE_CREDITOS WHERE nombre='Pack 500'),
  'PAY-JULIETA-001'
);
CALL sp_compra_creditos_aprobar(
  (SELECT id_usuario FROM USUARIO WHERE correo='huugo@demo.com'),
  (SELECT id_paquete FROM PAQUETE_CREDITOS WHERE nombre='Pack 500'),
  'PAY-HUGO-002'
);
CALL sp_compra_creditos_aprobar(
  (SELECT id_usuario FROM USUARIO WHERE correo='oliviaa@demo.com'),
  (SELECT id_paquete FROM PAQUETE_CREDITOS WHERE nombre='Pack 500'),
  'PAY-OLIVIA-001'
);
CALL sp_compra_creditos_aprobar(
  (SELECT id_usuario FROM USUARIO WHERE correo='mateoo@demo.com'),
  (SELECT id_paquete FROM PAQUETE_CREDITOS WHERE nombre='Pack 500'),
  'PAY-MATEO-001'
);
CALL sp_compra_creditos_aprobar(
  (SELECT id_usuario FROM USUARIO WHERE correo='caroliina@demo.com'),
  (SELECT id_paquete FROM PAQUETE_CREDITOS WHERE nombre='Pack 500'),
  'PAY-CAROLINA-001'
);
CALL sp_compra_creditos_aprobar(
  (SELECT id_usuario FROM USUARIO WHERE correo='estebann@demo.com'),
  (SELECT id_paquete FROM PAQUETE_CREDITOS WHERE nombre='Pack 500'),
  'PAY-ESTEBAN-001'
);
CALL sp_compra_creditos_aprobar(
  (SELECT id_usuario FROM USUARIO WHERE correo='paoula@demo.com'),
  (SELECT id_paquete FROM PAQUETE_CREDITOS WHERE nombre='Pack 500'),
  'PAY-PAOLA-001'
);
CALL sp_compra_creditos_aprobar(
  (SELECT id_usuario FROM USUARIO WHERE correo='javieri@demo.com'),
  (SELECT id_paquete FROM PAQUETE_CREDITOS WHERE nombre='Pack 500'),
  'PAY-JAVIER-001'
);
CALL sp_compra_creditos_aprobar(
  (SELECT id_usuario FROM USUARIO WHERE correo='noelial@demo.com'),
  (SELECT id_paquete FROM PAQUETE_CREDITOS WHERE nombre='Pack 500'),
  'PAY-NOELIA-001'
);
CALL sp_compra_creditos_aprobar(
  (SELECT id_usuario FROM USUARIO WHERE correo='francos@demo.com'),
  (SELECT id_paquete FROM PAQUETE_CREDITOS WHERE nombre='Pack 500'),
  'PAY-FRANCO-001'
);

/*    4) Intercambios extra
   - Cada nuevo comprador hace al menos 1 intercambio
   - Todos los montos <= 500 créditos (saldo disponible)*/

-- 4.1 Bicicletas
CALL sp_realizar_intercambio(
  (SELECT id_usuario FROM USUARIO WHERE correo='brenda@demo.com'),
  (SELECT id_publicacion FROM PUBLICACION WHERE titulo='Bici Híbrida Urbana' LIMIT 1),
  340
); SET @id_tx := (SELECT MAX(id_transaccion) FROM TRANSACCION);
UPDATE TRANSACCION SET estado='COMPLETADA' WHERE id_transaccion=@id_tx;

CALL sp_realizar_intercambio(
  (SELECT id_usuario FROM USUARIO WHERE correo='ignacio@demo.com'),
  (SELECT id_publicacion FROM PUBLICACION WHERE titulo='Bici MTB Junior' LIMIT 1),
  260
); SET @id_tx := (SELECT MAX(id_transaccion) FROM TRANSACCION);
UPDATE TRANSACCION SET estado='COMPLETADA' WHERE id_transaccion=@id_tx;

CALL sp_realizar_intercambio(
  (SELECT id_usuario FROM USUARIO WHERE correo='julieta@demo.com'),
  (SELECT id_publicacion FROM PUBLICACION WHERE titulo='Bici Paseo Vintage' LIMIT 1),
  280
); SET @id_tx := (SELECT MAX(id_transaccion) FROM TRANSACCION);
UPDATE TRANSACCION SET estado='COMPLETADA' WHERE id_transaccion=@id_tx;

-- 4.2 Productos de tecnología
CALL sp_realizar_intercambio(
  (SELECT id_usuario FROM USUARIO WHERE correo='hugo@demo.com'),
  (SELECT id_publicacion FROM PUBLICACION WHERE titulo='Mini PC Eco Oficina' LIMIT 1),
  320
); SET @id_tx := (SELECT MAX(id_transaccion) FROM TRANSACCION);
UPDATE TRANSACCION SET estado='COMPLETADA' WHERE id_transaccion=@id_tx;

CALL sp_realizar_intercambio(
  (SELECT id_usuario FROM USUARIO WHERE correo='oliviaa@demo.com'),
  (SELECT id_publicacion FROM PUBLICACION WHERE titulo='Monitor 27 Reciclado' LIMIT 1),
  240
); SET @id_tx := (SELECT MAX(id_transaccion) FROM TRANSACCION);
UPDATE TRANSACCION SET estado='COMPLETADA' WHERE id_transaccion=@id_tx;

CALL sp_realizar_intercambio(
  (SELECT id_usuario FROM USUARIO WHERE correo='mateoo@demo.com'),
  (SELECT id_publicacion FROM PUBLICACION WHERE titulo='Kit Oficina Reacondicionada' LIMIT 1),
  100
); SET @id_tx := (SELECT MAX(id_transaccion) FROM TRANSACCION);
UPDATE TRANSACCION SET estado='COMPLETADA' WHERE id_transaccion=@id_tx;

-- 4.3 Servicios de tecnología
CALL sp_realizar_intercambio(
  (SELECT id_usuario FROM USUARIO WHERE correo='caroliina@demo.com'),
  (SELECT id_publicacion FROM PUBLICACION WHERE titulo='Upgrade SSD + limpieza' LIMIT 1),
  130
); SET @id_tx := (SELECT MAX(id_transaccion) FROM TRANSACCION);
UPDATE TRANSACCION SET estado='COMPLETADA' WHERE id_transaccion=@id_tx;

CALL sp_realizar_intercambio(
  (SELECT id_usuario FROM USUARIO WHERE correo='estebann@demo.com'),
  (SELECT id_publicacion FROM PUBLICACION WHERE titulo='Upgrade SSD + limpieza' LIMIT 1),
  130
); SET @id_tx := (SELECT MAX(id_transaccion) FROM TRANSACCION);
UPDATE TRANSACCION SET estado='COMPLETADA' WHERE id_transaccion=@id_tx;

CALL sp_realizar_intercambio(
  (SELECT id_usuario FROM USUARIO WHERE correo='paoula@demo.com'),
  (SELECT id_publicacion FROM PUBLICACION WHERE titulo='Bici MTB Junior' LIMIT 1),
  260
); SET @id_tx := (SELECT MAX(id_transaccion) FROM TRANSACCION);
UPDATE TRANSACCION SET estado='COMPLETADA' WHERE id_transaccion=@id_tx;

CALL sp_realizar_intercambio(
  (SELECT id_usuario FROM USUARIO WHERE correo='javieri@demo.com'),
  (SELECT id_publicacion FROM PUBLICACION WHERE titulo='Bici Híbrida Urbana' LIMIT 1),
  340
); SET @id_tx := (SELECT MAX(id_transaccion) FROM TRANSACCION);
UPDATE TRANSACCION SET estado='COMPLETADA' WHERE id_transaccion=@id_tx;

CALL sp_realizar_intercambio(
  (SELECT id_usuario FROM USUARIO WHERE correo='noelial@demo.com'),
  (SELECT id_publicacion FROM PUBLICACION WHERE titulo='Mini PC Eco Oficina' LIMIT 1),
  320
); SET @id_tx := (SELECT MAX(id_transaccion) FROM TRANSACCION);
UPDATE TRANSACCION SET estado='COMPLETADA' WHERE id_transaccion=@id_tx;

CALL sp_realizar_intercambio(
  (SELECT id_usuario FROM USUARIO WHERE correo='francos@demo.com'),
  (SELECT id_publicacion FROM PUBLICACION WHERE titulo='Bici Paseo Vintage' LIMIT 1),
  280
); SET @id_tx := (SELECT MAX(id_transaccion) FROM TRANSACCION);
UPDATE TRANSACCION SET estado='COMPLETADA' WHERE id_transaccion=@id_tx;

/*    5) Actividades sostenibles extra*/

CALL sp_registrar_actividad_sostenible(
  (SELECT id_usuario FROM USUARIO WHERE correo='brenda@demo.com'),
  (SELECT id_tipo_actividad FROM TIPO_ACTIVIDAD WHERE nombre='RECICLAJE'),
  'Clasificó residuos en su condominio durante una semana.',
  18,
  'https://evidencias/reciclaje_brenda.jpg'
);

CALL sp_registrar_actividad_sostenible(
  (SELECT id_usuario FROM USUARIO WHERE correo='ignacio@demo.com'),
  (SELECT id_tipo_actividad FROM TIPO_ACTIVIDAD WHERE nombre='RECICLAJE'),
  'Llevó 4kg de plástico a un punto de acopio.',
  14,
  'https://evidencias/reciclaje_ignacio.jpg'
);

CALL sp_registrar_actividad_sostenible(
  (SELECT id_usuario FROM USUARIO WHERE correo='julieta@demo.com'),
  (SELECT id_tipo_actividad FROM TIPO_ACTIVIDAD WHERE nombre='RECICLAJE'),
  'Organizó una mini campaña de reciclaje en su curso.',
  20,
  'https://evidencias/reciclaje_julieta.jpg'
);

CALL sp_registrar_actividad_sostenible(
  (SELECT id_usuario FROM USUARIO WHERE correo='hugo@demo.com'),
  (SELECT id_tipo_actividad FROM TIPO_ACTIVIDAD WHERE nombre='RECICLAJE'),
  'Recolectó y entregó chatarra electrónica.',
  22,
  'https://evidencias/reciclaje_hugo.jpg'
);

CALL sp_registrar_actividad_sostenible(
  (SELECT id_usuario FROM USUARIO WHERE correo='oliviaa@demo.com'),
  (SELECT id_tipo_actividad FROM TIPO_ACTIVIDAD WHERE nombre='RECICLAJE'),
  'Promovió el uso de botellas reutilizables en su oficina.',
  16,
  'https://evidencias/reciclaje_olivia.jpg'
);

CALL sp_registrar_actividad_sostenible(
  (SELECT id_usuario FROM USUARIO WHERE correo='mateoo@demo.com'),
  (SELECT id_tipo_actividad FROM TIPO_ACTIVIDAD WHERE nombre='RECICLAJE'),
  'Separó residuos orgánicos y los convirtió en compost.',
  24,
  'https://evidencias/reciclaje_mateo.jpg'
);

CALL sp_registrar_actividad_sostenible(
  (SELECT id_usuario FROM USUARIO WHERE correo='caroliina@demo.com'),
  (SELECT id_tipo_actividad FROM TIPO_ACTIVIDAD WHERE nombre='RECICLAJE'),
  'Participó en limpieza de una plaza céntrica.',
  15,
  'https://evidencias/reciclaje_carolina.jpg'
);

CALL sp_registrar_actividad_sostenible(
  (SELECT id_usuario FROM USUARIO WHERE correo='estebann@demo.com'),
  (SELECT id_tipo_actividad FROM TIPO_ACTIVIDAD WHERE nombre='RECICLAJE'),
  'Recolectó cartón y lo entregó a recicladores de base.',
  17,
  'https://evidencias/reciclaje_esteban.jpg'
);

CALL sp_registrar_actividad_sostenible(
  (SELECT id_usuario FROM USUARIO WHERE correo='paoula@demo.com'),
  (SELECT id_tipo_actividad FROM TIPO_ACTIVIDAD WHERE nombre='RECICLAJE'),
  'Redució el uso de bolsas plásticas en su negocio.',
  12,
  'https://evidencias/reciclaje_paola.jpg'
);

CALL sp_registrar_actividad_sostenible(
  (SELECT id_usuario FROM USUARIO WHERE correo='javieri@demo.com'),
  (SELECT id_tipo_actividad FROM TIPO_ACTIVIDAD WHERE nombre='RECICLAJE'),
  'Coordinó un punto móvil de reciclaje en su barrio.',
  21,
  'https://evidencias/reciclaje_javier.jpg'
);

/*    6) Más SUSCRIPCION_PREMIUM para alimentar sp_rep_usuarios_premium */

-- Algunas suscripciones nuevas ACTIVA en noviembre
INSERT IGNORE INTO SUSCRIPCION_PREMIUM (id_usuario, fecha_inicio, fecha_fin, estado, monto_bs)
SELECT
  id_usuario,
  '2025-11-10 08:00:00',
  '2025-12-10 08:00:00',
  'ACTIVA',
  35.00
FROM USUARIO
WHERE correo IN ('brenda@demo.com','ignacio@demo.com','julieta@demo.com');

INSERT IGNORE INTO SUSCRIPCION_PREMIUM (id_usuario, fecha_inicio, fecha_fin, estado, monto_bs)
SELECT
  id_usuario,
  '2025-11-15 09:30:00',
  '2025-12-15 09:30:00',
  'ACTIVA',
  35.00
FROM USUARIO
WHERE correo IN ('hugo@demo.com','olivia@demo.com');

-- Una suscripción ya VENCIDA (octubre-noviembre)
INSERT IGNORE INTO SUSCRIPCION_PREMIUM (id_usuario, fecha_inicio, fecha_fin, estado, monto_bs)
SELECT
  id_usuario,
  '2025-10-05 10:00:00',
  '2025-11-05 10:00:00',
  'VENCIDA',
  30.00
FROM USUARIO
WHERE correo = 'mateo@demo.com';

/*    7) Regenerar reporte de impacto para 2025-11 (global) */

CALL sp_generar_reporte_impacto(
  (SELECT id_tipo_reporte FROM TIPO_REPORTE WHERE nombre='MENSUAL'),
  (SELECT id_periodo FROM PERIODO WHERE nombre='2025-11'),
  NULL
);

/*    8) Chequeo rápido de saldos y premium*/

-- Créditos actuales de los nuevos compradores
SELECT u.correo, b.saldo_creditos
FROM USUARIO u
LEFT JOIN BILLETERA b ON b.id_usuario = u.id_usuario
WHERE u.correo IN (
  'brenda@demo.com','ignacio@demo.com','julieta@demo.com','hugo@demo.com',
  'oliviaa@demo.com','mateoo@demo.com','caroliina@demo.com','estebann@demo.com',
  'paoula@demo.com','javieri@demo.com','noelial@demo.com','francos@demo.com'
)
ORDER BY u.correo;

-- Suscripciones premium recientes
SELECT u.correo, s.fecha_inicio, s.fecha_fin, s.estado, s.monto_bs
FROM SUSCRIPCION_PREMIUM s
JOIN USUARIO u ON u.id_usuario = s.id_usuario
WHERE u.correo IN (
  'ana@demo.com','luis@demo.com',
  'brenda@demo.com','ignacio@demo.com','julieta@demo.com',
  'hugo@demo.com','oliviaa@demo.com','mateoo@demo.com'
)
ORDER BY s.fecha_inicio;

USE CREDITOS_VERDES2;

-- 0) Asegurar equivalencia de impacto para Tecnología (por si acaso)

INSERT IGNORE INTO EQUIVALENCIA_IMPACTO (id_categoria, id_um, co2_por_unidad, agua_por_unidad, energia_por_unidad)
SELECT
  (SELECT id_categoria FROM CATEGORIA WHERE nombre = 'Tecnología' LIMIT 1),
  (SELECT id_um FROM UNIDAD_MEDIDA WHERE simbolo = 'u' LIMIT 1),
  8.000000,
  30.000000,
  3.500000;

/*   1) Nuevos USUARIOS (10 compradores + 5 vendedores)*/

-- 1.1 Compradores NUEVOS (10) - dominio @batch3.com y urls /p3/...
INSERT INTO USUARIO (id_rol, estado, nombre, apellido, correo, telefono, url_perfil)
VALUES
  ((SELECT id_rol FROM ROL WHERE nombre='COMPRADOR'),'ACTIVO','Ariana','Campos','ariana@batch3.com','75000001','/p3/ariana'),
  ((SELECT id_rol FROM ROL WHERE nombre='COMPRADOR'),'ACTIVO','Bruno','Rios','bruno@batch3.com','75000002','/p3/bruno'),
  ((SELECT id_rol FROM ROL WHERE nombre='COMPRADOR'),'ACTIVO','Carla','Duarte','carla_b3@batch3.com','75000003','/p3/carla'),
  ((SELECT id_rol FROM ROL WHERE nombre='COMPRADOR'),'ACTIVO','Diego','Navarro','diego_b3@batch3.com','75000004','/p3/diego'),
  ((SELECT id_rol FROM ROL WHERE nombre='COMPRADOR'),'ACTIVO','Eva','Sanchez','eva@batch3.com','75000005','/p3/eva'),
  ((SELECT id_rol FROM ROL WHERE nombre='COMPRADOR'),'ACTIVO','Gabriel','Mendoza','gabriel@batch3.com','75000006','/p3/gabriel'),
  ((SELECT id_rol FROM ROL WHERE nombre='COMPRADOR'),'ACTIVO','Irina','Flores','irina@batch3.com','75000007','/p3/irina'),
  ((SELECT id_rol FROM ROL WHERE nombre='COMPRADOR'),'ACTIVO','Luis','Ortega','luis_b3@batch3.com','75000008','/p3/luis'),
  ((SELECT id_rol FROM ROL WHERE nombre='COMPRADOR'),'ACTIVO','Mariana','Guzman','mariana@batch3.com','75000009','/p3/mariana'),
  ((SELECT id_rol FROM ROL WHERE nombre='COMPRADOR'),'ACTIVO','Nicolas','Vera','nicolas@batch3.com','75000010','/p3/nicolas');

-- 1.2 Vendedores NUEVOS (5)
INSERT INTO USUARIO (id_rol, estado, nombre, apellido, correo, telefono, url_perfil)
VALUES
  ((SELECT id_rol FROM ROL WHERE nombre='VENDEDOR'),'ACTIVO','Bike','Planet','bikeplanet@batch3.com','76000001','/p3/bikeplanet'),
  ((SELECT id_rol FROM ROL WHERE nombre='VENDEDOR'),'ACTIVO','Refurb','Center','refurbcenter@batch3.com','76000002','/p3/refurbcenter'),
  ((SELECT id_rol FROM ROL WHERE nombre='VENDEDOR'),'ACTIVO','Eco','Devices','ecodevices@batch3.com','76000003','/p3/ecodevices'),
  ((SELECT id_rol FROM ROL WHERE nombre='VENDEDOR'),'ACTIVO','Office','Green','officegreen@batch3.com','76000004','/p3/officegreen'),
  ((SELECT id_rol FROM ROL WHERE nombre='VENDEDOR'),'ACTIVO','PC','Clinic','pcclinic@batch3.com','76000005','/p3/pcclinic');

-- 1.3 Crear BILLETERA para todos los nuevos (compradores + vendedores)
INSERT INTO BILLETERA (id_usuario, estado, saldo_creditos, saldo_bs, cuenta_bancaria)
SELECT u.id_usuario, 'ACTIVA', 0, 0.00, NULL
FROM USUARIO u
LEFT JOIN BILLETERA b ON b.id_usuario = u.id_usuario
WHERE u.correo IN (
  'ariana@batch3.com','bruno@batch3.com','carla_b3@batch3.com','diego_b3@batch3.com',
  'eva@batch3.com','gabriel@batch3.com','irina@batch3.com','luis_b3@batch3.com',
  'mariana@batch3.com','nicolas@batch3.com',
  'bikeplanet@batch3.com','refurbcenter@batch3.com','ecodevices@batch3.com',
  'officegreen@batch3.com','pcclinic@batch3.com'
)
AND b.id_billetera IS NULL;

/*    2) Nuevos PRODUCTOS / SERVICIOS + PUBLICACIONES    */

-- 2.1 Bicicletas (BikePlanet)
INSERT INTO PRODUCTO (id_categoria, nombre, descripcion, precio, peso)
SELECT
  (SELECT id_categoria FROM CATEGORIA WHERE nombre='Bicicletas'),
  'Bici Urbana Light B3',
  'Bicicleta urbana liviana reacondicionada.',
  1200.00,
  13.0;

INSERT INTO PRODUCTO (id_categoria, nombre, descripcion, precio, peso)
SELECT
  (SELECT id_categoria FROM CATEGORIA WHERE nombre='Bicicletas'),
  'Bici Montaña Pro B3',
  'Bicicleta de montaña avanzada reacondicionada.',
  1800.00,
  14.5;

INSERT INTO PRODUCTO (id_categoria, nombre, descripcion, precio, peso)
SELECT
  (SELECT id_categoria FROM CATEGORIA WHERE nombre='Bicicletas'),
  'Bici Niño B3',
  'Bicicleta para niños reacondicionada.',
  900.00,
  11.0;

-- Publicaciones Bicicletas
INSERT INTO PUBLICACION
  (id_usuario, id_categoria, id_tipo_publicacion, estado, id_ubicacion,
   titulo, descripcion, valor_creditos, imagen_url)
SELECT
  (SELECT id_usuario FROM USUARIO WHERE correo='bikeplanet@batch3.com'),
  (SELECT id_categoria FROM CATEGORIA WHERE nombre='Bicicletas'),
  (SELECT id_tipo_publicacion FROM TIPO_PUBLICACION WHERE nombre='PRODUCTO'),
  'PUBLICADA',
  (SELECT id_ubicacion FROM UBICACION WHERE ciudad='Cochabamba'),
  'Bici Urbana Light B3',
  'Bicicleta urbana liviana ideal para ciudad, reacondicionada.',
  230,
  'https://img/b3_bici_urbana_light.jpg';

INSERT INTO PUBLICACION_PRODUCTO
SELECT
  (SELECT id_publicacion FROM PUBLICACION WHERE titulo='Bici Urbana Light B3' LIMIT 1),
  (SELECT id_producto   FROM PRODUCTO   WHERE nombre='Bici Urbana Light B3' LIMIT 1),
  1.0000,
  (SELECT id_um FROM UNIDAD_MEDIDA WHERE simbolo='u');

INSERT INTO PUBLICACION
  (id_usuario, id_categoria, id_tipo_publicacion, estado, id_ubicacion,
   titulo, descripcion, valor_creditos, imagen_url)
SELECT
  (SELECT id_usuario FROM USUARIO WHERE correo='bikeplanet@batch3.com'),
  (SELECT id_categoria FROM CATEGORIA WHERE nombre='Bicicletas'),
  (SELECT id_tipo_publicacion FROM TIPO_PUBLICACION WHERE nombre='PRODUCTO'),
  'PUBLICADA',
  (SELECT id_ubicacion FROM UBICACION WHERE ciudad='La Paz'),
  'Bici Montaña Pro B3',
  'Bici de montaña reacondicionada para rutas exigentes.',
  360,
  'https://img/b3_bici_montana_pro.jpg';

INSERT INTO PUBLICACION_PRODUCTO
SELECT
  (SELECT id_publicacion FROM PUBLICACION WHERE titulo='Bici Montaña Pro B3' LIMIT 1),
  (SELECT id_producto   FROM PRODUCTO   WHERE nombre='Bici Montaña Pro B3' LIMIT 1),
  1.0000,
  (SELECT id_um FROM UNIDAD_MEDIDA WHERE simbolo='u');

INSERT INTO PUBLICACION
  (id_usuario, id_categoria, id_tipo_publicacion, estado, id_ubicacion,
   titulo, descripcion, valor_creditos, imagen_url)
SELECT
  (SELECT id_usuario FROM USUARIO WHERE correo='bikeplanet@batch3.com'),
  (SELECT id_categoria FROM CATEGORIA WHERE nombre='Bicicletas'),
  (SELECT id_tipo_publicacion FROM TIPO_PUBLICACION WHERE nombre='PRODUCTO'),
  'PUBLICADA',
  (SELECT id_ubicacion FROM UBICACION WHERE ciudad='Cochabamba'),
  'Bici Niño B3',
  'Bici para niños reacondicionada, ideal para parques.',
  180,
  'https://img/b3_bici_nino.jpg';

INSERT INTO PUBLICACION_PRODUCTO
SELECT
  (SELECT id_publicacion FROM PUBLICACION WHERE titulo='Bici Niño B3' LIMIT 1),
  (SELECT id_producto   FROM PRODUCTO   WHERE nombre='Bici Niño B3' LIMIT 1),
  1.0000,
  (SELECT id_um FROM UNIDAD_MEDIDA WHERE simbolo='u');

-- 2.2 Tecnología (RefurbCenter, EcoDevices, OfficeGreen)
INSERT INTO PRODUCTO (id_categoria, nombre, descripcion, precio, peso)
SELECT
  (SELECT id_categoria FROM CATEGORIA WHERE nombre='Tecnología'),
  'Laptop Eco B3',
  'Laptop reacondicionada de bajo consumo energético.',
  2200.00,
  4.0;

INSERT INTO PRODUCTO (id_categoria, nombre, descripcion, precio, peso)
SELECT
  (SELECT id_categoria FROM CATEGORIA WHERE nombre='Tecnología'),
  'Smartphone Reacondicionado B3',
  'Smartphone reacondicionado en excelente estado.',
  1400.00,
  0.4;

INSERT INTO PRODUCTO (id_categoria, nombre, descripcion, precio, peso)
SELECT
  (SELECT id_categoria FROM CATEGORIA WHERE nombre='Tecnología'),
  'Set Oficina Verde B3',
  'Combo PC + monitor reacondicionados para oficina.',
  2600.00,
  9.8;

INSERT INTO PUBLICACION
  (id_usuario, id_categoria, id_tipo_publicacion, estado, id_ubicacion,
   titulo, descripcion, valor_creditos, imagen_url)
SELECT
  (SELECT id_usuario FROM USUARIO WHERE correo='refurbcenter@batch3.com'),
  (SELECT id_categoria FROM CATEGORIA WHERE nombre='Tecnología'),
  (SELECT id_tipo_publicacion FROM TIPO_PUBLICACION WHERE nombre='PRODUCTO'),
  'PUBLICADA',
  (SELECT id_ubicacion FROM UBICACION WHERE ciudad='La Paz'),
  'Laptop Eco B3',
  'Laptop eficiente y reacondicionada, ideal para trabajo y estudio.',
  340,
  'https://img/b3_laptop_eco.jpg';

INSERT INTO PUBLICACION_PRODUCTO
SELECT
  (SELECT id_publicacion FROM PUBLICACION WHERE titulo='Laptop Eco B3' LIMIT 1),
  (SELECT id_producto   FROM PRODUCTO   WHERE nombre='Laptop Eco B3' LIMIT 1),
  1.0000,
  (SELECT id_um FROM UNIDAD_MEDIDA WHERE simbolo='u');

INSERT INTO PUBLICACION
  (id_usuario, id_categoria, id_tipo_publicacion, estado, id_ubicacion,
   titulo, descripcion, valor_creditos, imagen_url)
SELECT
  (SELECT id_usuario FROM USUARIO WHERE correo='ecodevices@batch3.com'),
  (SELECT id_categoria FROM CATEGORIA WHERE nombre='Tecnología'),
  (SELECT id_tipo_publicacion FROM TIPO_PUBLICACION WHERE nombre='PRODUCTO'),
  'PUBLICADA',
  (SELECT id_ubicacion FROM UBICACION WHERE ciudad='Cochabamba'),
  'Smartphone Reacondicionado B3',
  'Smartphone reacondicionado, reduciendo residuos electrónicos.',
  210,
  'https://img/b3_smartphone_reacondicionado.jpg';

INSERT INTO PUBLICACION_PRODUCTO
SELECT
  (SELECT id_publicacion FROM PUBLICACION WHERE titulo='Smartphone Reacondicionado B3' LIMIT 1),
  (SELECT id_producto   FROM PRODUCTO   WHERE nombre='Smartphone Reacondicionado B3' LIMIT 1),
  1.0000,
  (SELECT id_um FROM UNIDAD_MEDIDA WHERE simbolo='u');

INSERT INTO PUBLICACION
  (id_usuario, id_categoria, id_tipo_publicacion, estado, id_ubicacion,
   titulo, descripcion, valor_creditos, imagen_url)
SELECT
  (SELECT id_usuario FROM USUARIO WHERE correo='officegreen@batch3.com'),
  (SELECT id_categoria FROM CATEGORIA WHERE nombre='Tecnología'),
  (SELECT id_tipo_publicacion FROM TIPO_PUBLICACION WHERE nombre='PRODUCTO'),
  'PUBLICADA',
  (SELECT id_ubicacion FROM UBICACION WHERE ciudad='La Paz'),
  'Set Oficina Verde B3',
  'Combo eco-friendly de PC y monitor reacondicionados.',
  280,
  'https://img/b3_set_oficina_verde.jpg';

INSERT INTO PUBLICACION_PRODUCTO
SELECT
  (SELECT id_publicacion FROM PUBLICACION WHERE titulo='Set Oficina Verde B3' LIMIT 1),
  (SELECT id_producto   FROM PRODUCTO   WHERE nombre='Set Oficina Verde B3' LIMIT 1),
  1.0000,
  (SELECT id_um FROM UNIDAD_MEDIDA WHERE simbolo='u');

-- 2.3 Servicio de tecnología (PCClinic)
INSERT INTO SERVICIO (id_categoria, estado, nombre, descripcion, precio, duracion_min)
SELECT
  (SELECT id_categoria FROM CATEGORIA WHERE nombre='Tecnología'),
  'ACTIVO',
  'Mantenimiento completo B3',
  'Servicio de mantenimiento y limpieza profunda de PC.',
  120.00,
  80;

INSERT INTO PUBLICACION
  (id_usuario, id_categoria, id_tipo_publicacion, estado, id_ubicacion,
   titulo, descripcion, valor_creditos, imagen_url)
SELECT
  (SELECT id_usuario FROM USUARIO WHERE correo='pcclinic@batch3.com'),
  (SELECT id_categoria FROM CATEGORIA WHERE nombre='Tecnología'),
  (SELECT id_tipo_publicacion FROM TIPO_PUBLICACION WHERE nombre='SERVICIO'),
  'PUBLICADA',
  (SELECT id_ubicacion FROM UBICACION WHERE ciudad='Cochabamba'),
  'Mantenimiento completo B3',
  'Servicio para alargar la vida útil de tu equipo.',
  120,
  'https://img/b3_mantenimiento_completo.jpg';

INSERT INTO PUBLICACION_SERVICIO
SELECT
  (SELECT id_publicacion FROM PUBLICACION WHERE titulo='Mantenimiento completo B3' LIMIT 1),
  (SELECT id_servicio   FROM SERVICIO   WHERE nombre='Mantenimiento completo B3' LIMIT 1),
  'L-S 09:00-18:00';

/*    3) Compras de créditos extra (Pack 500 para cada comprador nuevo)    */

CALL sp_compra_creditos_aprobar(
  (SELECT id_usuario FROM USUARIO WHERE correo='ariana@batch3.com'),
  (SELECT id_paquete FROM PAQUETE_CREDITOS WHERE nombre='Pack 500'),
  'PAY-B3-ARIANA-001'
);
CALL sp_compra_creditos_aprobar(
  (SELECT id_usuario FROM USUARIO WHERE correo='bruno@batch3.com'),
  (SELECT id_paquete FROM PAQUETE_CREDITOS WHERE nombre='Pack 500'),
  'PAY-B3-BRUNO-001'
);
CALL sp_compra_creditos_aprobar(
  (SELECT id_usuario FROM USUARIO WHERE correo='carla_b3@batch3.com'),
  (SELECT id_paquete FROM PAQUETE_CREDITOS WHERE nombre='Pack 500'),
  'PAY-B3-CARLA-001'
);
CALL sp_compra_creditos_aprobar(
  (SELECT id_usuario FROM USUARIO WHERE correo='diego_b3@batch3.com'),
  (SELECT id_paquete FROM PAQUETE_CREDITOS WHERE nombre='Pack 500'),
  'PAY-B3-DIEGO-001'
);
CALL sp_compra_creditos_aprobar(
  (SELECT id_usuario FROM USUARIO WHERE correo='eva@batch3.com'),
  (SELECT id_paquete FROM PAQUETE_CREDITOS WHERE nombre='Pack 500'),
  'PAY-B3-EVA-001'
);
CALL sp_compra_creditos_aprobar(
  (SELECT id_usuario FROM USUARIO WHERE correo='gabriel@batch3.com'),
  (SELECT id_paquete FROM PAQUETE_CREDITOS WHERE nombre='Pack 500'),
  'PAY-B3-GABRIEL-001'
);
CALL sp_compra_creditos_aprobar(
  (SELECT id_usuario FROM USUARIO WHERE correo='irina@batch3.com'),
  (SELECT id_paquete FROM PAQUETE_CREDITOS WHERE nombre='Pack 500'),
  'PAY-B3-IRINA-001'
);
CALL sp_compra_creditos_aprobar(
  (SELECT id_usuario FROM USUARIO WHERE correo='luis_b3@batch3.com'),
  (SELECT id_paquete FROM PAQUETE_CREDITOS WHERE nombre='Pack 500'),
  'PAY-B3-LUIS-001'
);
CALL sp_compra_creditos_aprobar(
  (SELECT id_usuario FROM USUARIO WHERE correo='mariana@batch3.com'),
  (SELECT id_paquete FROM PAQUETE_CREDITOS WHERE nombre='Pack 500'),
  'PAY-B3-MARIANA-001'
);
CALL sp_compra_creditos_aprobar(
  (SELECT id_usuario FROM USUARIO WHERE correo='nicolas@batch3.com'),
  (SELECT id_paquete FROM PAQUETE_CREDITOS WHERE nombre='Pack 500'),
  'PAY-B3-NICOLAS-001'
);

/*   4) Intercambios extra
   - Cada comprador hace al menos 1 intercambio
   - Todos los montos <= 500 créditos*/

-- 4.1 Bicicletas
CALL sp_realizar_intercambio(
  (SELECT id_usuario FROM USUARIO WHERE correo='ariana@batch3.com'),
  (SELECT id_publicacion FROM PUBLICACION WHERE titulo='Bici Urbana Light B3' LIMIT 1),
  230
); SET @id_tx := (SELECT MAX(id_transaccion) FROM TRANSACCION);
UPDATE TRANSACCION SET estado='COMPLETADA' WHERE id_transaccion=@id_tx;

CALL sp_realizar_intercambio(
  (SELECT id_usuario FROM USUARIO WHERE correo='bruno@batch3.com'),
  (SELECT id_publicacion FROM PUBLICACION WHERE titulo='Bici Montaña Pro B3' LIMIT 1),
  360
); SET @id_tx := (SELECT MAX(id_transaccion) FROM TRANSACCION);
UPDATE TRANSACCION SET estado='COMPLETADA' WHERE id_transaccion=@id_tx;

CALL sp_realizar_intercambio(
  (SELECT id_usuario FROM USUARIO WHERE correo='carla_b3@batch3.com'),
  (SELECT id_publicacion FROM PUBLICACION WHERE titulo='Bici Niño B3' LIMIT 1),
  180
); SET @id_tx := (SELECT MAX(id_transaccion) FROM TRANSACCION);
UPDATE TRANSACCION SET estado='COMPLETADA' WHERE id_transaccion=@id_tx;

-- 4.2 Productos de tecnología
CALL sp_realizar_intercambio(
  (SELECT id_usuario FROM USUARIO WHERE correo='diego_b3@batch3.com'),
  (SELECT id_publicacion FROM PUBLICACION WHERE titulo='Laptop Eco B3' LIMIT 1),
  340
); SET @id_tx := (SELECT MAX(id_transaccion) FROM TRANSACCION);
UPDATE TRANSACCION SET estado='COMPLETADA' WHERE id_transaccion=@id_tx;

CALL sp_realizar_intercambio(
  (SELECT id_usuario FROM USUARIO WHERE correo='eva@batch3.com'),
  (SELECT id_publicacion FROM PUBLICACION WHERE titulo='Smartphone Reacondicionado B3' LIMIT 1),
  210
); SET @id_tx := (SELECT MAX(id_transaccion) FROM TRANSACCION);
UPDATE TRANSACCION SET estado='COMPLETADA' WHERE id_transaccion=@id_tx;

CALL sp_realizar_intercambio(
  (SELECT id_usuario FROM USUARIO WHERE correo='gabriel@batch3.com'),
  (SELECT id_publicacion FROM PUBLICACION WHERE titulo='Set Oficina Verde B3' LIMIT 1),
  280
); SET @id_tx := (SELECT MAX(id_transaccion) FROM TRANSACCION);
UPDATE TRANSACCION SET estado='COMPLETADA' WHERE id_transaccion=@id_tx;

-- 4.3 Servicios de tecnología
CALL sp_realizar_intercambio(
  (SELECT id_usuario FROM USUARIO WHERE correo='carla_b3@batch3.com'),
  (SELECT id_publicacion FROM PUBLICACION WHERE titulo='Mantenimiento completo B3' LIMIT 1),
  120
); SET @id_tx := (SELECT MAX(id_transaccion) FROM TRANSACCION);
UPDATE TRANSACCION SET estado='COMPLETADA' WHERE id_transaccion=@id_tx;

CALL sp_realizar_intercambio(
  (SELECT id_usuario FROM USUARIO WHERE correo='irina@batch3.com'),
  (SELECT id_publicacion FROM PUBLICACION WHERE titulo='Mantenimiento completo B3' LIMIT 1),
  120
); SET @id_tx := (SELECT MAX(id_transaccion) FROM TRANSACCION);
UPDATE TRANSACCION SET estado='COMPLETADA' WHERE id_transaccion=@id_tx;

-- 4.4 Más operaciones para otros compradores
CALL sp_realizar_intercambio(
  (SELECT id_usuario FROM USUARIO WHERE correo='luis_b3@batch3.com'),
  (SELECT id_publicacion FROM PUBLICACION WHERE titulo='Laptop Eco B3' LIMIT 1),
  340
); SET @id_tx := (SELECT MAX(id_transaccion) FROM TRANSACCION);
UPDATE TRANSACCION SET estado='COMPLETADA' WHERE id_transaccion=@id_tx;

CALL sp_realizar_intercambio(
  (SELECT id_usuario FROM USUARIO WHERE correo='mariana@batch3.com'),
  (SELECT id_publicacion FROM PUBLICACION WHERE titulo='Bici Urbana Light B3' LIMIT 1),
  230
); SET @id_tx := (SELECT MAX(id_transaccion) FROM TRANSACCION);
UPDATE TRANSACCION SET estado='COMPLETADA' WHERE id_transaccion=@id_tx;

CALL sp_realizar_intercambio(
  (SELECT id_usuario FROM USUARIO WHERE correo='nicolas@batch3.com'),
  (SELECT id_publicacion FROM PUBLICACION WHERE titulo='Smartphone Reacondicionado B3' LIMIT 1),
  210
); SET @id_tx := (SELECT MAX(id_transaccion) FROM TRANSACCION);
UPDATE TRANSACCION SET estado='COMPLETADA' WHERE id_transaccion=@id_tx;

CALL sp_realizar_intercambio(
  (SELECT id_usuario FROM USUARIO WHERE correo='nicolas@batch3.com'),
  (SELECT id_publicacion FROM PUBLICACION WHERE titulo='Mantenimiento completo B3' LIMIT 1),
  120
); SET @id_tx := (SELECT MAX(id_transaccion) FROM TRANSACCION);
UPDATE TRANSACCION SET estado='COMPLETADA' WHERE id_transaccion=@id_tx;

/*    5) Actividades sostenibles extra */

CALL sp_registrar_actividad_sostenible(
  (SELECT id_usuario FROM USUARIO WHERE correo='ariana@batch3.com'),
  (SELECT id_tipo_actividad FROM TIPO_ACTIVIDAD WHERE nombre='RECICLAJE'),
  'Participó en jornada de recolección de plástico en su barrio.',
  18,
  'https://evidencias/b3_reciclaje_ariana.jpg'
);

CALL sp_registrar_actividad_sostenible(
  (SELECT id_usuario FROM USUARIO WHERE correo='bruno@batch3.com'),
  (SELECT id_tipo_actividad FROM TIPO_ACTIVIDAD WHERE nombre='RECICLAJE'),
  'Entregó 6kg de papel y cartón a un punto de acopio.',
  16,
  'https://evidencias/b3_reciclaje_bruno.jpg'
);

CALL sp_registrar_actividad_sostenible(
  (SELECT id_usuario FROM USUARIO WHERE correo='carla_b3@batch3.com'),
  (SELECT id_tipo_actividad FROM TIPO_ACTIVIDAD WHERE nombre='RECICLAJE'),
  'Organizó una campaña de reciclaje en su facultad.',
  22,
  'https://evidencias/b3_reciclaje_carla.jpg'
);

CALL sp_registrar_actividad_sostenible(
  (SELECT id_usuario FROM USUARIO WHERE correo='diego_b3@batch3.com'),
  (SELECT id_tipo_actividad FROM TIPO_ACTIVIDAD WHERE nombre='RECICLAJE'),
  'Recolectó chatarra electrónica y la llevó a un centro autorizado.',
  20,
  'https://evidencias/b3_reciclaje_diego.jpg'
);

CALL sp_registrar_actividad_sostenible(
  (SELECT id_usuario FROM USUARIO WHERE correo='eva@batch3.com'),
  (SELECT id_tipo_actividad FROM TIPO_ACTIVIDAD WHERE nombre='RECICLAJE'),
  'Promovió el uso de bolsas reutilizables en su hogar.',
  12,
  'https://evidencias/b3_reciclaje_eva.jpg'
);

CALL sp_registrar_actividad_sostenible(
  (SELECT id_usuario FROM USUARIO WHERE correo='gabriel@batch3.com'),
  (SELECT id_tipo_actividad FROM TIPO_ACTIVIDAD WHERE nombre='RECICLAJE'),
  'Apoyó una limpieza de río urbano.',
  24,
  'https://evidencias/b3_reciclaje_gabriel.jpg'
);

CALL sp_registrar_actividad_sostenible(
  (SELECT id_usuario FROM USUARIO WHERE correo='irina@batch3.com'),
  (SELECT id_tipo_actividad FROM TIPO_ACTIVIDAD WHERE nombre='RECICLAJE'),
  'Implementó separación de residuos en su oficina.',
  17,
  'https://evidencias/b3_reciclaje_irina.jpg'
);

CALL sp_registrar_actividad_sostenible(
  (SELECT id_usuario FROM USUARIO WHERE correo='luis_b3@batch3.com'),
  (SELECT id_tipo_actividad FROM TIPO_ACTIVIDAD WHERE nombre='RECICLAJE'),
  'Entregó botellas PET en un punto verde.',
  14,
  'https://evidencias/b3_reciclaje_luis.jpg'
);

CALL sp_registrar_actividad_sostenible(
  (SELECT id_usuario FROM USUARIO WHERE correo='mariana@batch3.com'),
  (SELECT id_tipo_actividad FROM TIPO_ACTIVIDAD WHERE nombre='RECICLAJE'),
  'Redució el uso de envases desechables en su emprendimiento.',
  15,
  'https://evidencias/b3_reciclaje_mariana.jpg'
);

CALL sp_registrar_actividad_sostenible(
  (SELECT id_usuario FROM USUARIO WHERE correo='nicolas@batch3.com'),
  (SELECT id_tipo_actividad FROM TIPO_ACTIVIDAD WHERE nombre='RECICLAJE'),
  'Apoyó una campaña escolar de reciclaje de papel.',
  19,
  'https://evidencias/b3_reciclaje_nicolas.jpg'
);

/*    6) SUSCRIPCION_PREMIUM extra */

-- Suscripciones ACTIVA en noviembre
INSERT IGNORE INTO SUSCRIPCION_PREMIUM (id_usuario, fecha_inicio, fecha_fin, estado, monto_bs)
SELECT
  id_usuario,
  '2025-11-18 08:00:00',
  '2025-12-18 08:00:00',
  'ACTIVA',
  40.00
FROM USUARIO
WHERE correo IN ('ariana@batch3.com','bruno@batch3.com','carla_b3@batch3.com');

INSERT IGNORE INTO SUSCRIPCION_PREMIUM (id_usuario, fecha_inicio, fecha_fin, estado, monto_bs)
SELECT
  id_usuario,
  '2025-11-20 09:30:00',
  '2025-12-20 09:30:00',
  'ACTIVA',
  40.00
FROM USUARIO
WHERE correo IN ('diego_b3@batch3.com','eva@batch3.com');

-- Una suscripción VENCIDA (octubre-noviembre)
INSERT IGNORE INTO SUSCRIPCION_PREMIUM (id_usuario, fecha_inicio, fecha_fin, estado, monto_bs)
SELECT
  id_usuario,
  '2025-10-10 10:00:00',
  '2025-11-10 10:00:00',
  'VENCIDA',
  30.00
FROM USUARIO
WHERE correo = 'gabriel@batch3.com';

/*    7) Regenerar reporte de impacto para 2025-11    */

CALL sp_generar_reporte_impacto(
  (SELECT id_tipo_reporte FROM TIPO_REPORTE WHERE nombre='MENSUAL'),
  (SELECT id_periodo FROM PERIODO WHERE nombre='2025-11'),
  NULL
);

/*    8) Chequeos rápidos (opcional)    */

-- Créditos actuales de los nuevos compradores
SELECT u.correo, b.saldo_creditos
FROM USUARIO u
LEFT JOIN BILLETERA b ON b.id_usuario = u.id_usuario
WHERE u.correo IN (
  'ariana@batch3.com','bruno@batch3.com','carla_b3@batch3.com','diego_b3@batch3.com',
  'eva@batch3.com','gabriel@batch3.com','irina@batch3.com','luis_b3@batch3.com',
  'mariana@batch3.com','nicolas@batch3.com'
)
ORDER BY u.correo;

-- Suscripciones premium recientes BATCH 3
SELECT u.correo, s.fecha_inicio, s.fecha_fin, s.estado, s.monto_bs
FROM SUSCRIPCION_PREMIUM s
JOIN USUARIO u ON u.id_usuario = s.id_usuario
WHERE u.correo IN (
  'ariana@batch3.com','bruno@batch3.com','carla_b3@batch3.com',
  'diego_b3@batch3.com','eva@batch3.com','gabriel@batch3.com'
)
ORDER BY s.fecha_inicio;
</file>

<file path="digital-barder/backend/src/config/env.js">
// src/config/env.js
import 'dotenv/config'

export const env = {
  NODE_ENV: process.env.NODE_ENV ?? 'development',
  PORT: Number(process.env.PORT ?? 4000),
  DATABASE_URL: process.env.DATABASE_URL,
}
</file>

<file path="digital-barder/backend/src/config/prisma.js">
// src/config/prisma.js
import { PrismaClient } from '@prisma/client'

export const prisma = new PrismaClient({
    log: ['query', 'error', 'warn'],
})
</file>

<file path="digital-barder/backend/src/modules/auth/auth.service.js">
import bcrypt from "bcryptjs";
import jwt from "jsonwebtoken";
import { prisma } from "../../config/prisma.js";

// Helper: obtener id_rol por nombre
async function getRolId(nombreRol) {
  const rows = await prisma.$queryRaw`
    SELECT id_rol FROM ROL WHERE nombre = ${nombreRol} LIMIT 1
  `;
  if (!rows.length) {
    throw new Error(`No existe el rol ${nombreRol}`);
  }
  return rows[0].id_rol;
}

// Helper: obtener id_resultado de BITACORA_ACCESO (OK / FAIL)
async function getResultadoAccesoId(nombre) {
  const rows = await prisma.$queryRaw`
    SELECT id_resultado FROM RESULTADO_ACCESO WHERE nombre = ${nombre} LIMIT 1
  `;
  if (!rows.length) {
    throw new Error(`No existe RESULTADO_ACCESO '${nombre}'`);
  }
  return rows[0].id_resultado;
}

export async function registrarUsuarioService({
  nombre,
  apellido,
  correo,
  password,
  telefono,
}) {
  // ¿Correo ya existe?
  const existente = await prisma.$queryRaw`
    SELECT id_usuario FROM USUARIO WHERE correo = ${correo} LIMIT 1
  `;
  if (existente.length) {
    const error = new Error("El correo ya está registrado");
    error.status = 409;
    throw error;
  }

  const hash = await bcrypt.hash(password, 10);
  const idRolComprador = await getRolId("COMPRADOR");

  await prisma.$queryRaw`
    INSERT INTO USUARIO (id_rol, estado, nombre, apellido, correo, password_hash, telefono, url_perfil)
    VALUES (${idRolComprador}, 'ACTIVO', ${nombre}, ${apellido || null}, ${correo},
            ${hash}, ${telefono || null}, NULL)
  `;

  // Volver a leer el usuario insertado
  const usuarioRows = await prisma.$queryRaw`
    SELECT u.id_usuario, u.nombre, u.apellido, u.correo, u.telefono, r.nombre AS rol
    FROM USUARIO u
    JOIN ROL r ON r.id_rol = u.id_rol
    WHERE u.correo = ${correo}
    LIMIT 1
  `;

  return usuarioRows[0];
}

export async function loginService({ correo, password, ip, userAgent }) {
  const usuarios = await prisma.$queryRaw`
    SELECT u.id_usuario, u.password_hash, u.nombre, u.apellido, u.correo,
           u.estado, r.nombre AS rol
    FROM USUARIO u
    JOIN ROL r ON r.id_rol = u.id_rol
    WHERE u.correo = ${correo}
    LIMIT 1
  `;

  const user = usuarios[0];
  let resultadoNombre = "FAIL";

  if (!user) {
    const idFail = await getResultadoAccesoId(resultadoNombre);
    // Podrías registrar intento fallido sin usuario si quisieras
    const error = new Error("Credenciales inválidas");
    error.status = 401;
    throw error;
  }

  // ===== CAMBIO IMPORTANTE: compatibilidad con hashes bcrypt y texto plano =====
  let ok = false;

  try {
    // Si parece un hash bcrypt ($2a$, $2b$, $2y$...), usamos bcrypt.compare
    if (user.password_hash && user.password_hash.startsWith("$2")) {
      ok = await bcrypt.compare(password, user.password_hash);
    } else {
      // Si NO parece hash, asumimos que está en texto plano (ej: '123456')
      ok = password === user.password_hash;
    }
  } catch (e) {
    // Si bcrypt truena por hash inválido, hacemos fallback a texto plano
    ok = password === user.password_hash;
  }

  if (!ok) {
    const idFail = await getResultadoAccesoId(resultadoNombre);
    await prisma.$queryRaw`
      INSERT INTO BITACORA_ACCESO (id_usuario, fecha, direccion_ip, user_agent, id_resultado)
      VALUES (${user.id_usuario}, NOW(), ${ip}, ${userAgent}, ${idFail})
    `;
    const error = new Error("Credenciales inválidas");
    error.status = 401;
    throw error;
  }

  // Login correcto
  resultadoNombre = "OK";
  const idOk = await getResultadoAccesoId(resultadoNombre);
  await prisma.$queryRaw`
    INSERT INTO BITACORA_ACCESO (id_usuario, fecha, direccion_ip, user_agent, id_resultado)
    VALUES (${user.id_usuario}, NOW(), ${ip}, ${userAgent}, ${idOk})
  `;

  const payload = {
    id_usuario: user.id_usuario,
    correo: user.correo,
    rol: user.rol,
  };

  const token = jwt.sign(payload, process.env.JWT_SECRET, {
    expiresIn: "2h",
  });

  // No devolver hash
  delete user.password_hash;

  return {
    token,
    usuario: {
      id_usuario: user.id_usuario,
      nombre: user.nombre,
      apellido: user.apellido,
      correo: user.correo,
      rol: user.rol,
      estado: user.estado,
    },
  };
}

export async function obtenerPerfilService(idUsuario) {
  const rows = await prisma.$queryRaw`
    SELECT u.id_usuario, u.nombre, u.apellido, u.correo, u.telefono,
           u.estado, r.nombre AS rol
    FROM USUARIO u
    JOIN ROL r ON r.id_rol = u.id_rol
    WHERE u.id_usuario = ${idUsuario}
    LIMIT 1
  `;
  if (!rows.length) {
    const err = new Error("Usuario no encontrado");
    err.status = 404;
    throw err;
  }
  return rows[0];
}
</file>

<file path="digital-barder/backend/src/modules/usuarios/usuarios.controller.js">
import {
  listarUsuariosService,
  crearUsuarioAdminService,
  actualizarUsuarioService,
  cambiarEstadoUsuarioService,
  obtenerHistorialUsuarioService,
} from "./usuarios.service.js";

export async function listarUsuariosController(req, res, next) {
  try {
    const usuarios = await listarUsuariosService();
    res.json(usuarios);
  } catch (err) {
    next(err);
  }
}

export async function crearUsuarioAdminController(req, res, next) {
  try {
    const usuario = await crearUsuarioAdminService(req.body);
    res.status(201).json(usuario);
  } catch (err) {
    next(err);
  }
}

export async function actualizarUsuarioController(req, res, next) {
  try {
    const id = parseInt(req.params.id, 10);
    const usuario = await actualizarUsuarioService(id, req.body);
    res.json(usuario);
  } catch (err) {
    next(err);
  }
}

export async function cambiarEstadoUsuarioController(req, res, next) {
  try {
    const id = parseInt(req.params.id, 10);
    const { estado } = req.body;
    const usuario = await cambiarEstadoUsuarioService(id, estado);
    res.json(usuario);
  } catch (err) {
    next(err);
  }
}

export async function obtenerHistorialUsuarioController(req, res, next) {
  try {
    const id = parseInt(req.params.id, 10);
    const historial = await obtenerHistorialUsuarioService(id);
    res.json(historial);
  } catch (err) {
    next(err);
  }
}
</file>

<file path="digital-barder/backend/src/modules/usuarios/usuarios.routes.js">
import { Router } from "express";
import { authMiddleware } from "../../middlewares/auth.js";
import { isAdmin } from "../../middlewares/isAdmin.js";
import {
  listarUsuariosController,
  crearUsuarioAdminController,
  actualizarUsuarioController,
  cambiarEstadoUsuarioController,
  obtenerHistorialUsuarioController,
} from "./usuarios.controller.js";

const router = Router();

// Todo lo de aquí requiere admin
router.use(authMiddleware, isAdmin);

// GET /api/usuarios
router.get("/", listarUsuariosController);

// POST /api/usuarios
router.post("/", crearUsuarioAdminController);

// PUT /api/usuarios/:id
router.put("/:id", actualizarUsuarioController);

// PATCH /api/usuarios/:id/estado
router.patch("/:id/estado", cambiarEstadoUsuarioController);

// GET /api/usuarios/:id/historial
router.get("/:id/historial", obtenerHistorialUsuarioController);

export default router;
</file>

<file path="digital-barder/backend/src/server.js">
// src/server.js
import app from './app.js'
import { env } from './config/env.js'

const PORT = env.PORT

app.listen(PORT, () => {
    console.log(`🚀 API running on http://localhost:${PORT}`)
})
</file>

<file path="digital-barder/frontend/index.html">
<!doctype html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <title>Digital Barter</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  </head>
  <body class="bg-gray-100">
    <div id="root"></div>
    <script type="module" src="/src/main.jsx"></script>
  </body>
</html>
</file>

<file path="digital-barder/frontend/postcss.config.js">
module.exports = {
  plugins: {
    tailwindcss: {},
    autoprefixer: {}
  }
};
</file>

<file path="digital-barder/frontend/src/components/ProtectedRoute.jsx">
import React from "react";
import { Navigate, useLocation } from "react-router-dom";

export default function ProtectedRoute({ children }) {
  const token = localStorage.getItem("token");
  const location = useLocation();

  if (!token) {
    return <Navigate to="/login" state={{ from: location }} replace />;
  }

  return children;
}
</file>

<file path="digital-barder/frontend/src/index.css">
@tailwind base;
@tailwind components;
@tailwind utilities;

/* estilos globales */
body {
  @apply bg-gray-100 text-gray-900;
}

.btn-primary {
  @apply inline-flex items-center justify-center px-4 py-2 rounded-md bg-blue-600 text-white text-sm font-medium hover:bg-blue-700 transition;
}

.card {
  @apply bg-white rounded-lg shadow-sm border border-gray-200 p-4;
}
</file>

<file path="digital-barder/frontend/src/main.jsx">
import React from "react";
import ReactDOM from "react-dom/client";
import { BrowserRouter } from "react-router-dom";
import App from "./App.jsx";
import "./index.css";

ReactDOM.createRoot(document.getElementById("root")).render(
  <React.StrictMode>
    <BrowserRouter>
      <App />
    </BrowserRouter>
  </React.StrictMode>
);
</file>

<file path="digital-barder/frontend/src/pages/Login.jsx">
// frontend/src/pages/Login.jsx
import React, { useState, useEffect } from "react";
import { useNavigate, Link } from "react-router-dom";
import { login } from "../services/api";
import hojaLogo from "../assets/hoja.png";

const SLIDES = [
  {
    id: 1,
    title: "Crea una cuenta en Digital Barter",
    text: "Obtén 5 monedas Green Credits por tu primera sesión.",
    image:
      "https://images.pexels.com/photos/3184339/pexels-photo-3184339.jpeg?auto=compress&cs=tinysrgb&w=1600",
  },
  {
    id: 2,
    title: "Intercambia productos y servicios",
    text: "Ahorra dinero mientras ayudas al planeta.",
    image:
      "https://images.pexels.com/photos/3184291/pexels-photo-3184291.jpeg?auto=compress&cs=tinysrgb&w=1600",
  },
  {
    id: 3,
    title: "Gana Green Credits",
    text: "Recibe créditos verdes por cada intercambio sostenible.",
    image:
      "https://images.pexels.com/photos/8867432/pexels-photo-8867432.jpeg?auto=compress&cs=tinysrgb&w=1600",
  },
];

export default function Login() {
  const [correo, setCorreo] = useState("");
  const [password, setPassword] = useState("");
  const [error, setError] = useState("");
  const [loading, setLoading] = useState(false);

  const [slideIndex, setSlideIndex] = useState(0);

  const navigate = useNavigate();

  useEffect(() => {
    const id = setInterval(() => {
      setSlideIndex((prev) => (prev + 1) % SLIDES.length);
    }, 5000);
    return () => clearInterval(id);
  }, []);

  async function handleSubmit(e) {
    e.preventDefault();
    setError("");

    if (!correo || !password) {
      setError("Debes ingresar correo y contraseña.");
      return;
    }

    try {
      setLoading(true);
      const data = await login({ correo, password });

      if (!data?.token) {
        setError("No se recibió el token de autenticación.");
        return;
      }

      // Después del login te llevo a tu flujo de reportes
      navigate("/home");
    } catch (err) {
      console.error(err);
      setError(err.message || "Credenciales inválidas");
    } finally {
      setLoading(false);
    }
  }

  const currentSlide = SLIDES[slideIndex];

  return (
    <div className="min-h-screen bg-gradient-to-br from-[#012b20] via-[#013726] to-[#011711] text-white flex flex-col">
      {/* NAVBAR SUPERIOR */}
      <header className="flex items-center justify-between px-10 py-4">
        <div className="flex items-center gap-3">
          <div className="flex items-center justify-center w-10 h-10 rounded-full bg-white/10">
            <img
              src={hojaLogo}
              alt="Logo Digital Barter"
              className="w-7 h-7 object-contain"
            />
          </div>
          <div>
            <h1 className="text-2xl font-black leading-tight tracking-tight">
              Digital Barter
            </h1>
            <p className="text-sm text-green-300 font-semibold flex items-center gap-1">
              green credits
              <span className="inline-block w-2 h-2 rounded-full bg-green-400" />
            </p>
          </div>
        </div>

        <Link
          to="/register"
          className="px-5 py-2 rounded-full bg-white text-green-900 font-semibold text-sm hover:bg-gray-100 transition"
        >
          Crear Cuenta
        </Link>
      </header>

      {/* CONTENIDO PRINCIPAL */}
      <main className="flex-1 flex flex-col lg:flex-row items-center justify-center gap-10 px-6 lg:px-16 pb-10">
        {/* PANEL IZQUIERDO: CARRUSEL */}
        <section className="w-full max-w-md bg-black/20 rounded-3xl overflow-hidden shadow-2xl">
          <div className="relative h-80">
            <img
              src={currentSlide.image}
              alt={currentSlide.title}
              className="w-full h-full object-cover"
            />
            <div className="absolute inset-0 bg-gradient-to-t from-black/70 via-black/20 to-transparent" />
            <div className="absolute inset-0 flex flex-col justify-end p-6">
              <h2 className="text-xl font-bold mb-2">{currentSlide.title}</h2>
              <p className="text-sm text-gray-200 mb-4">{currentSlide.text}</p>

              {/* Puntos del carrusel */}
              <div className="flex gap-2">
                {SLIDES.map((s, idx) => (
                  <button
                    key={s.id}
                    onClick={() => setSlideIndex(idx)}
                    className={`w-2.5 h-2.5 rounded-full ${
                      idx === slideIndex ? "bg-white" : "bg-white/40"
                    }`}
                    aria-label={`Ir al slide ${idx + 1}`}
                  />
                ))}
              </div>
            </div>
          </div>
        </section>

        {/* PANEL DERECHO: FORM LOGIN */}
        <section className="w-full max-w-md bg-white/5 backdrop-blur-md rounded-3xl p-8 shadow-2xl">
          <h2 className="text-2xl font-bold mb-2 text-center">
            Iniciar sesión
          </h2>
          <p className="text-sm text-gray-200 mb-6 text-center">
            Ingresa para gestionar tus Green Credits.
          </p>

          {error && (
            <div className="mb-4 bg-red-500/20 border border-red-400 text-sm px-3 py-2 rounded-lg">
              {error}
            </div>
          )}

          <form className="space-y-4" onSubmit={handleSubmit}>
            <div>
              <label className="block text-sm mb-1">
                Correo electrónico o número de teléfono
              </label>
              <input
                type="text"
                value={correo}
                onChange={(e) => setCorreo(e.target.value)}
                className="w-full rounded-lg px-3 py-2 bg-white/10 border border-white/20 text-sm placeholder:text-gray-300 focus:outline-none focus:ring-2 focus:ring-green-400"
                placeholder="tucorreo@email.com"
              />
            </div>

            <div>
              <label className="block text-sm mb-1">Contraseña</label>
              <input
                type="password"
                value={password}
                onChange={(e) => setPassword(e.target.value)}
                className="w-full rounded-lg px-3 py-2 bg-white/10 border border-white/20 text-sm placeholder:text-gray-300 focus:outline-none focus:ring-2 focus:ring-green-400"
                placeholder="••••••••"
              />
            </div>

            <div className="flex justify-end text-xs text-gray-300 mb-1">
              <button
                type="button"
                className="hover:underline"
                onClick={() => alert("En el futuro aquí irá el flujo de recuperar contraseña.")}
              >
                ¿Has olvidado tu contraseña?
              </button>
            </div>

            <button
              type="submit"
              disabled={loading}
              className="w-full mt-2 bg-[#0a8f44] hover:bg-[#0cb652] disabled:opacity-60 disabled:cursor-not-allowed text-white font-semibold py-2.5 rounded-full text-sm transition"
            >
              {loading ? "Ingresando..." : "Iniciar sesión"}
            </button>
          </form>

          <p className="mt-6 text-xs text-center text-gray-200">
            ¿No tienes cuenta?{" "}
            <Link to="/register" className="font-semibold underline">
              Crear una cuenta
            </Link>
          </p>
        </section>
      </main>

      <footer className="text-xs text-gray-300 text-center pb-4">
        ¡Un poco más sobre nosotros!
      </footer>
    </div>
  );
}
</file>

<file path="digital-barder/frontend/src/pages/Register.jsx">
// frontend/src/pages/Register.jsx
import React, { useState, useEffect } from "react";
import { Link, useNavigate } from "react-router-dom";
import { register } from "../services/api";
import hojaLogo from "../assets/hoja.png";

const SLIDES = [
  {
    id: 1,
    title: "Crea una cuenta en Digital Barter",
    text: "Empieza a ganar Green Credits desde hoy.",
    image:
      "https://images.pexels.com/photos/3184328/pexels-photo-3184328.jpeg?auto=compress&cs=tinysrgb&w=1600",
  },
  {
    id: 2,
    title: "Comparte y reutiliza",
    text: "Publica productos y servicios que ya no usas.",
    image:
      "https://images.pexels.com/photos/3738088/pexels-photo-3738088.jpeg?auto=compress&cs=tinysrgb&w=1600",
  },
  {
    id: 3,
    title: "Impacto ambiental positivo",
    text: "Reduce CO₂, agua y energía con cada intercambio.",
    image:
      "https://images.pexels.com/photos/286763/pexels-photo-286763.jpeg?auto=compress&cs=tinysrgb&w=1600",
  },
];

export default function Register() {
  const [nombre, setNombre] = useState("");
  const [apellidos, setApellidos] = useState("");
  const [correo, setCorreo] = useState("");
  const [telefono, setTelefono] = useState("");
  const [password, setPassword] = useState("");
  const [password2, setPassword2] = useState("");

  const [dia, setDia] = useState("1");
  const [mes, setMes] = useState("ene.");
  const [anio, setAnio] = useState("2000");
  const [genero, setGenero] = useState("Hombre");

  const [error, setError] = useState("");
  const [ok, setOk] = useState("");
  const [loading, setLoading] = useState(false);
  const [slideIndex, setSlideIndex] = useState(0);

  const navigate = useNavigate();

  useEffect(() => {
    const id = setInterval(
      () => setSlideIndex((prev) => (prev + 1) % SLIDES.length),
      5000
    );
    return () => clearInterval(id);
  }, []);

  const currentSlide = SLIDES[slideIndex];

  async function handleSubmit(e) {
    e.preventDefault();
    setError("");
    setOk("");

    if (!nombre || !correo || !password || !password2) {
      setError("Nombre, correo y contraseñas son obligatorios.");
      return;
    }

    if (password !== password2) {
      setError("Las contraseñas no coinciden.");
      return;
    }

    try {
      setLoading(true);
      await register({
        nombre,
        apellido: apellidos,
        correo,
        password,
        telefono: telefono || undefined,
      });

      setOk("Cuenta creada correctamente. Ahora puedes iniciar sesión.");
      // Opcional: enviarte de una vez al login
      navigate("/login");
    } catch (err) {
      console.error(err);
      setError(err.message || "No se pudo registrar el usuario.");
    } finally {
      setLoading(false);
    }
  }

  const dias = Array.from({ length: 31 }, (_, i) => String(i + 1));
  const anios = Array.from({ length: 80 }, (_, i) =>
    String(2025 - i)
  );

  return (
    <div className="min-h-screen bg-gradient-to-br from-[#012b20] via-[#013726] to-[#011711] text-white flex flex-col">
      {/* NAVBAR SUPERIOR */}
      <header className="flex items-center justify-between px-10 py-4">
        <div className="flex items-center gap-3">
          <div className="flex items-center justify-center w-10 h-10 rounded-full bg-white/10">
            <img
              src={hojaLogo}
              alt="Logo Digital Barter"
              className="w-7 h-7 object-contain"
            />
          </div>
          <div>
            <h1 className="text-2xl font-black leading-tight tracking-tight">
              Digital Barter
            </h1>
            <p className="text-sm text-green-300 font-semibold flex items-center gap-1">
              green credits
              <span className="inline-block w-2 h-2 rounded-full bg-green-400" />
            </p>
          </div>
        </div>

        <Link
          to="/login"
          className="px-5 py-2 rounded-full bg-white text-green-900 font-semibold text-sm hover:bg-gray-100 transition"
        >
          Iniciar sesión
        </Link>
      </header>

      {/* CONTENIDO PRINCIPAL */}
      <main className="flex-1 flex flex-col lg:flex-row items-center justify-center gap-10 px-6 lg:px-16 pb-10">
        {/* PANEL IZQUIERDO: CARRUSEL */}
        <section className="w-full max-w-md bg-black/20 rounded-3xl overflow-hidden shadow-2xl">
          <div className="relative h-80">
            <img
              src={currentSlide.image}
              alt={currentSlide.title}
              className="w-full h-full object-cover"
            />
            <div className="absolute inset-0 bg-gradient-to-t from-black/70 via-black/20 to-transparent" />
            <div className="absolute inset-0 flex flex-col justify-end p-6">
              <h2 className="text-xl font-bold mb-2">{currentSlide.title}</h2>
              <p className="text-sm text-gray-200 mb-4">{currentSlide.text}</p>
              <div className="flex gap-2">
                {SLIDES.map((s, idx) => (
                  <button
                    key={s.id}
                    onClick={() => setSlideIndex(idx)}
                    className={`w-2.5 h-2.5 rounded-full ${
                      idx === slideIndex ? "bg-white" : "bg-white/40"
                    }`}
                  />
                ))}
              </div>
            </div>
          </div>
        </section>

        {/* PANEL DERECHO: FORM REGISTRO */}
        <section className="w-full max-w-md bg-white/5 backdrop-blur-md rounded-3xl p-8 shadow-2xl">
          <h2 className="text-2xl font-bold mb-2 text-center">Crea una Cuenta</h2>

          {error && (
            <div className="mb-4 bg-red-500/20 border border-red-400 text-sm px-3 py-2 rounded-lg">
              {error}
            </div>
          )}
          {ok && (
            <div className="mb-4 bg-green-500/20 border border-green-400 text-sm px-3 py-2 rounded-lg">
              {ok}
            </div>
          )}

          <form className="space-y-4" onSubmit={handleSubmit}>
            {/* Nombre y apellidos */}
            <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
              <div>
                <label className="block text-sm mb-1">Nombre</label>
                <input
                  type="text"
                  value={nombre}
                  onChange={(e) => setNombre(e.target.value)}
                  className="w-full rounded-lg px-3 py-2 bg-white/10 border border-white/20 text-sm focus:outline-none focus:ring-2 focus:ring-green-400"
                  placeholder="Nombre"
                />
              </div>
              <div>
                <label className="block text-sm mb-1">Apellidos</label>
                <input
                  type="text"
                  value={apellidos}
                  onChange={(e) => setApellidos(e.target.value)}
                  className="w-full rounded-lg px-3 py-2 bg-white/10 border border-white/20 text-sm focus:outline-none focus:ring-2 focus:ring-green-400"
                  placeholder="Apellidos"
                />
              </div>
            </div>

            {/* Fecha de nacimiento */}
            <div>
              <p className="text-xs mb-1">Fecha de nacimiento</p>
              <div className="grid grid-cols-3 gap-2">
                <select
                  value={dia}
                  onChange={(e) => setDia(e.target.value)}
                  className="rounded-lg px-2 py-2 bg-white/10 border border-white/20 text-sm"
                >
                  {dias.map((d) => (
                    <option key={d} value={d}>
                      {d}
                    </option>
                  ))}
                </select>

                <select
                  value={mes}
                  onChange={(e) => setMes(e.target.value)}
                  className="rounded-lg px-2 py-2 bg-white/10 border border-white/20 text-sm"
                >
                  <option>ene.</option>
                  <option>feb.</option>
                  <option>mar.</option>
                  <option>abr.</option>
                  <option>may.</option>
                  <option>jun.</option>
                  <option>jul.</option>
                  <option>ago.</option>
                  <option>sept.</option>
                  <option>oct.</option>
                  <option>nov.</option>
                  <option>dic.</option>
                </select>

                <select
                  value={anio}
                  onChange={(e) => setAnio(e.target.value)}
                  className="rounded-lg px-2 py-2 bg-white/10 border border-white/20 text-sm"
                >
                  {anios.map((a) => (
                    <option key={a} value={a}>
                      {a}
                    </option>
                  ))}
                </select>
              </div>
            </div>

            {/* Género */}
            <div>
              <p className="text-xs mb-1">Género</p>
              <div className="flex gap-3">
                <button
                  type="button"
                  onClick={() => setGenero("Hombre")}
                  className={`flex-1 flex items-center justify-center gap-2 px-3 py-2 rounded-full border text-sm ${
                    genero === "Hombre"
                      ? "bg-green-500 border-green-400"
                      : "bg-white/10 border-white/20"
                  }`}
                >
                  <span
                    className={`w-3 h-3 rounded-full border ${
                      genero === "Hombre"
                        ? "bg-white border-white"
                        : "bg-transparent border-white"
                    }`}
                  />
                  Hombre
                </button>
                <button
                  type="button"
                  onClick={() => setGenero("Mujer")}
                  className={`flex-1 flex items-center justify-center gap-2 px-3 py-2 rounded-full border text-sm ${
                    genero === "Mujer"
                      ? "bg-green-500 border-green-400"
                      : "bg-white/10 border-white/20"
                  }`}
                >
                  <span
                    className={`w-3 h-3 rounded-full border ${
                      genero === "Mujer"
                        ? "bg-white border-white"
                        : "bg-transparent border-white"
                    }`}
                  />
                  Mujer
                </button>
              </div>
            </div>

            {/* Contacto */}
            <div>
              <label className="block text-sm mb-1">
                Número de móvil o correo electrónico
              </label>
              <input
                type="text"
                value={correo}
                onChange={(e) => setCorreo(e.target.value)}
                className="w-full rounded-lg px-3 py-2 bg-white/10 border border-white/20 text-sm focus:outline-none focus:ring-2 focus:ring-green-400"
                placeholder="correo@ejemplo.com"
              />
            </div>

            <div>
              <label className="block text-sm mb-1">Teléfono (opcional)</label>
              <input
                type="tel"
                value={telefono}
                onChange={(e) => setTelefono(e.target.value)}
                className="w-full rounded-lg px-3 py-2 bg-white/10 border border-white/20 text-sm focus:outline-none focus:ring-2 focus:ring-green-400"
                placeholder="+591 70000000"
              />
            </div>

            {/* Contraseñas */}
            <div>
              <label className="block text-sm mb-1">Contraseña</label>
              <input
                type="password"
                value={password}
                onChange={(e) => setPassword(e.target.value)}
                className="w-full rounded-lg px-3 py-2 bg-white/10 border border-white/20 text-sm focus:outline-none focus:ring-2 focus:ring-green-400"
                placeholder="••••••••"
              />
            </div>
            <div>
              <label className="block text-sm mb-1">Confirmar contraseña</label>
              <input
                type="password"
                value={password2}
                onChange={(e) => setPassword2(e.target.value)}
                className="w-full rounded-lg px-3 py-2 bg-white/10 border border-white/20 text-sm focus:outline-none focus:ring-2 focus:ring-green-400"
                placeholder="••••••••"
              />
            </div>

            <button
              type="submit"
              disabled={loading}
              className="w-full mt-2 bg-[#0a8f44] hover:bg-[#0cb652] disabled:opacity-60 disabled:cursor-not-allowed text-white font-semibold py-2.5 rounded-full text-sm transition"
            >
              {loading ? "Registrando..." : "Registrar"}
            </button>
          </form>
        </section>
      </main>

      <footer className="text-xs text-gray-300 text-center pb-4">
        ¡Un poco más sobre nosotros!
      </footer>
    </div>
  );
}
</file>

<file path="digital-barder/frontend/tailwind.config.js">
/** @type {import('tailwindcss').Config} */
module.exports = {
  content: [
    "./index.html",
    "./src/**/*.{js,jsx,ts,tsx}"
  ],
  theme: {
    extend: {}
  },
  plugins: []
};
</file>

<file path="digital-barder/frontend/vite.config.js">
import { defineConfig } from "vite";
import react from "@vitejs/plugin-react";

export default defineConfig({
  plugins: [react()],
  server: {
    port: 5173
  }
});
</file>

<file path="base de datos/bd_tbd(oficial).sql">
DROP DATABASE IF EXISTS CREDITOS_VERDES2;
CREATE DATABASE CREDITOS_VERDES2
  CHARACTER SET utf8mb4
  COLLATE utf8mb4_unicode_ci;
USE CREDITOS_VERDES2;

SET NAMES utf8mb4;
SET FOREIGN_KEY_CHECKS = 0;

-- 1) CATÁLOGOS / BASE

CREATE TABLE ROL (
  id_rol INT PRIMARY KEY AUTO_INCREMENT,
  nombre VARCHAR(50) NOT NULL UNIQUE,
  descripcion VARCHAR(255)
) ENGINE=InnoDB;

CREATE TABLE PERMISO (
  id_permiso INT PRIMARY KEY AUTO_INCREMENT,
  nombre VARCHAR(100) NOT NULL UNIQUE,
  descripcion VARCHAR(255)
) ENGINE=InnoDB;

CREATE TABLE RESULTADO_ACCESO (
  id_resultado INT PRIMARY KEY AUTO_INCREMENT,
  nombre VARCHAR(50) NOT NULL UNIQUE,
  descripcion VARCHAR(255)
) ENGINE=InnoDB;

CREATE TABLE CATEGORIA (
  id_categoria INT PRIMARY KEY AUTO_INCREMENT,
  nombre VARCHAR(100) NOT NULL UNIQUE,
  descripcion VARCHAR(255)
) ENGINE=InnoDB;

CREATE TABLE UNIDAD_MEDIDA (
  id_um INT PRIMARY KEY AUTO_INCREMENT,
  nombre VARCHAR(100) NOT NULL UNIQUE,
  simbolo VARCHAR(20) NOT NULL UNIQUE
) ENGINE=InnoDB;

CREATE TABLE UBICACION (
  id_ubicacion INT PRIMARY KEY AUTO_INCREMENT,
  direccion VARCHAR(500) NOT NULL,
  ciudad VARCHAR(100),
  provincia VARCHAR(100),
  latitud DECIMAL(9,6),
  longitud DECIMAL(9,6)
) ENGINE=InnoDB;

CREATE TABLE TIPO_PUBLICACION (
  id_tipo_publicacion INT PRIMARY KEY AUTO_INCREMENT,
  nombre VARCHAR(50) NOT NULL UNIQUE,
  descripcion VARCHAR(255)
) ENGINE=InnoDB;

CREATE TABLE TIPO_REFERENCIA (
  id_tipo_referencia INT PRIMARY KEY AUTO_INCREMENT,
  nombre VARCHAR(30) NOT NULL UNIQUE
) ENGINE=InnoDB;

CREATE TABLE TIPO_MOVIMIENTO (
  id_tipo_movimiento INT PRIMARY KEY AUTO_INCREMENT,
  nombre VARCHAR(50) NOT NULL UNIQUE,
  descripcion VARCHAR(255)
) ENGINE=InnoDB;

CREATE TABLE SIGNO_MOVIMIENTO (
  id_signo INT PRIMARY KEY AUTO_INCREMENT,
  nombre VARCHAR(20) NOT NULL UNIQUE  -- POSITIVO | NEGATIVO
) ENGINE=InnoDB;

CREATE TABLE PAQUETE_CREDITOS (
  id_paquete INT PRIMARY KEY AUTO_INCREMENT,
  nombre VARCHAR(100) NOT NULL UNIQUE,
  cantidad_creditos BIGINT NOT NULL,
  precio_bs DECIMAL(12,2) NOT NULL,
  activo BOOLEAN NOT NULL DEFAULT TRUE
) ENGINE=InnoDB;

CREATE TABLE TIPO_PROMOCION (
  id_tipo_promocion INT PRIMARY KEY AUTO_INCREMENT,
  nombre VARCHAR(50) NOT NULL UNIQUE,
  descripcion VARCHAR(255)
) ENGINE=InnoDB;

CREATE TABLE TIPO_LOGRO (
  id_tipo_logro INT PRIMARY KEY AUTO_INCREMENT,
  nombre VARCHAR(50) NOT NULL UNIQUE,
  descripcion VARCHAR(255)
) ENGINE=InnoDB;

CREATE TABLE TIPO_ACTIVIDAD (
  id_tipo_actividad INT PRIMARY KEY AUTO_INCREMENT,
  nombre VARCHAR(100) NOT NULL UNIQUE,
  descripcion VARCHAR(255)
) ENGINE=InnoDB;

CREATE TABLE UBICACION_PUBLICIDAD (
  id_ubicacion INT PRIMARY KEY AUTO_INCREMENT,
  nombre VARCHAR(100) NOT NULL UNIQUE,
  descripcion VARCHAR(255),
  precio_base DECIMAL(12,2) NOT NULL
) ENGINE=InnoDB;

CREATE TABLE TIPO_REPORTE (
  id_tipo_reporte INT PRIMARY KEY AUTO_INCREMENT,
  nombre VARCHAR(50) NOT NULL UNIQUE,
  descripcion VARCHAR(255)
) ENGINE=InnoDB;

CREATE TABLE PERIODO (
  id_periodo INT PRIMARY KEY AUTO_INCREMENT,
  nombre VARCHAR(50) NOT NULL UNIQUE,
  descripcion VARCHAR(255),
  fecha_inicio DATE NULL,
  fecha_fin DATE NULL
) ENGINE=InnoDB;

CREATE INDEX ix_periodo_rango ON PERIODO (fecha_inicio, fecha_fin);

CREATE TABLE DIMENSION_AMBIENTAL (
  id_dimension INT PRIMARY KEY AUTO_INCREMENT,
  codigo VARCHAR(30) NOT NULL UNIQUE,
  nombre VARCHAR(100) NOT NULL,
  unidad_base VARCHAR(20),
  descripcion VARCHAR(255)
) ENGINE=InnoDB;

-- 2) USUARIOS Y SEGURIDAD

CREATE TABLE USUARIO (
  id_usuario INT PRIMARY KEY AUTO_INCREMENT,
  id_rol INT NOT NULL,
  estado ENUM('ACTIVO','SUSPENDIDO','BLOQUEADO','ELIMINADO') NOT NULL DEFAULT 'ACTIVO',
  nombre VARCHAR(100) NOT NULL,
  apellido VARCHAR(100),
  correo VARCHAR(255) NOT NULL UNIQUE,
  telefono VARCHAR(25),
  url_perfil VARCHAR(120) UNIQUE,
  CONSTRAINT fk_usuario_rol
    FOREIGN KEY (id_rol) REFERENCES ROL(id_rol)
    ON DELETE RESTRICT ON UPDATE RESTRICT
) ENGINE=InnoDB;

CREATE TABLE ROL_PERMISO (
  id_rol INT NOT NULL,
  id_permiso INT NOT NULL,
  PRIMARY KEY (id_rol, id_permiso),
  CONSTRAINT fk_rp_rol FOREIGN KEY (id_rol) REFERENCES ROL(id_rol)
    ON DELETE CASCADE ON UPDATE RESTRICT,
  CONSTRAINT fk_rp_permiso FOREIGN KEY (id_permiso) REFERENCES PERMISO(id_permiso)
    ON DELETE CASCADE ON UPDATE RESTRICT
) ENGINE=InnoDB;

CREATE TABLE BITACORA_ACCESO (
  id_acceso INT PRIMARY KEY AUTO_INCREMENT,
  id_usuario INT NOT NULL,
  fecha DATETIME,
  direccion_ip VARCHAR(45) NOT NULL,
  user_agent VARCHAR(500),
  id_resultado INT NOT NULL,
  CONSTRAINT fk_bitacc_usuario FOREIGN KEY (id_usuario) REFERENCES USUARIO(id_usuario)
    ON DELETE RESTRICT ON UPDATE RESTRICT,
  CONSTRAINT fk_bitacc_resultado FOREIGN KEY (id_resultado) REFERENCES RESULTADO_ACCESO(id_resultado)
    ON DELETE RESTRICT ON UPDATE RESTRICT
) ENGINE=InnoDB;

CREATE INDEX ix_bitacceso_usuario_fecha ON BITACORA_ACCESO (id_usuario, fecha);

-- 3) PUBLICACIONES / PRODUCTOS / SERVICIOS

CREATE TABLE PUBLICACION (
  id_publicacion INT PRIMARY KEY AUTO_INCREMENT,
  id_usuario INT NOT NULL,
  id_categoria INT NOT NULL,
  id_tipo_publicacion INT NOT NULL,
  estado ENUM('BORRADOR','PUBLICADA','PAUSADA','AGOTADA','OCULTA','ELIMINADA') DEFAULT 'PUBLICADA',
  id_ubicacion INT NULL,
  titulo VARCHAR(200) NOT NULL,
  descripcion TEXT NOT NULL,
  valor_creditos BIGINT NOT NULL,
  imagen_url VARCHAR(500),
  CONSTRAINT fk_publicacion_usuario FOREIGN KEY (id_usuario) REFERENCES USUARIO(id_usuario)
    ON DELETE RESTRICT ON UPDATE RESTRICT,
  CONSTRAINT fk_publicacion_categoria FOREIGN KEY (id_categoria) REFERENCES CATEGORIA(id_categoria)
    ON DELETE RESTRICT ON UPDATE RESTRICT,
  CONSTRAINT fk_publicacion_tipopub FOREIGN KEY (id_tipo_publicacion) REFERENCES TIPO_PUBLICACION(id_tipo_publicacion)
    ON DELETE RESTRICT ON UPDATE RESTRICT,
  CONSTRAINT fk_publicacion_ubicacion FOREIGN KEY (id_ubicacion) REFERENCES UBICACION(id_ubicacion)
    ON DELETE SET NULL ON UPDATE RESTRICT,
  CONSTRAINT ck_pub_valor_creditos CHECK (valor_creditos > 0)
) ENGINE=InnoDB;

CREATE INDEX ix_pub_usuario_estado   ON PUBLICACION (id_usuario, estado);
CREATE INDEX ix_pub_categoria_estado ON PUBLICACION (id_categoria, estado);

CREATE TABLE PRODUCTO (
  id_producto INT PRIMARY KEY AUTO_INCREMENT,
  id_categoria INT NOT NULL,
  nombre VARCHAR(255) NOT NULL,
  descripcion VARCHAR(255),
  precio DECIMAL(12,2),
  peso DECIMAL(10,2),
  CONSTRAINT fk_producto_categoria FOREIGN KEY (id_categoria) REFERENCES CATEGORIA(id_categoria)
    ON DELETE RESTRICT ON UPDATE RESTRICT
) ENGINE=InnoDB;

CREATE TABLE SERVICIO (
  id_servicio INT PRIMARY KEY AUTO_INCREMENT,
  id_categoria INT NOT NULL,
  estado ENUM('ACTIVO','PAUSADO','INACTIVO','ELIMINADO') DEFAULT 'ACTIVO',
  nombre VARCHAR(255) NOT NULL,
  descripcion TEXT,
  precio DECIMAL(12,2),
  duracion_min SMALLINT,
  CONSTRAINT fk_servicio_categoria FOREIGN KEY (id_categoria) REFERENCES CATEGORIA(id_categoria)
    ON DELETE RESTRICT ON UPDATE RESTRICT
) ENGINE=InnoDB;

CREATE TABLE PUBLICACION_PRODUCTO (
  id_publicacion INT NOT NULL,
  id_producto INT NOT NULL,
  cantidad DECIMAL(15,4) NOT NULL,
  id_um INT NOT NULL,
  PRIMARY KEY (id_publicacion, id_producto),
  CONSTRAINT fk_pprd_publicacion FOREIGN KEY (id_publicacion) REFERENCES PUBLICACION(id_publicacion)
    ON DELETE CASCADE ON UPDATE RESTRICT,
  CONSTRAINT fk_pprd_producto FOREIGN KEY (id_producto) REFERENCES PRODUCTO(id_producto)
    ON DELETE CASCADE ON UPDATE RESTRICT,
  CONSTRAINT fk_pprd_um FOREIGN KEY (id_um) REFERENCES UNIDAD_MEDIDA(id_um)
    ON DELETE RESTRICT ON UPDATE RESTRICT
) ENGINE=InnoDB;

CREATE TABLE PUBLICACION_SERVICIO (
  id_publicacion INT NOT NULL,
  id_servicio INT NOT NULL,
  horario VARCHAR(100) NOT NULL,
  PRIMARY KEY (id_publicacion, id_servicio),
  CONSTRAINT fk_pserv_publicacion FOREIGN KEY (id_publicacion) REFERENCES PUBLICACION(id_publicacion)
    ON DELETE CASCADE ON UPDATE RESTRICT,
  CONSTRAINT fk_pserv_servicio FOREIGN KEY (id_servicio) REFERENCES SERVICIO(id_servicio)
    ON DELETE CASCADE ON UPDATE RESTRICT
) ENGINE=InnoDB;

CREATE TABLE CALIFICACION (
  id_calificacion INT PRIMARY KEY AUTO_INCREMENT,
  id_usuario INT NOT NULL,
  id_publicacion INT NOT NULL,
  estrellas TINYINT NOT NULL,
  comentario VARCHAR(300),
  UNIQUE (id_usuario, id_publicacion),
  CONSTRAINT fk_calif_usuario FOREIGN KEY (id_usuario) REFERENCES USUARIO(id_usuario)
    ON DELETE RESTRICT ON UPDATE RESTRICT,
  CONSTRAINT fk_calif_publicacion FOREIGN KEY (id_publicacion) REFERENCES PUBLICACION(id_publicacion)
    ON DELETE RESTRICT ON UPDATE RESTRICT,
  CONSTRAINT ck_calif_estrellas CHECK (estrellas BETWEEN 1 AND 5)
) ENGINE=InnoDB;

-- 4) BILLETERA / MOVIMIENTOS / COMPRAS
CREATE TABLE BILLETERA (
  id_billetera INT PRIMARY KEY AUTO_INCREMENT,
  id_usuario INT NOT NULL UNIQUE,
  estado ENUM('ACTIVA','BLOQUEADA','CERRADA') DEFAULT 'ACTIVA',
  saldo_creditos BIGINT DEFAULT 0,
  saldo_bs DECIMAL(12,2) DEFAULT 0.00,
  cuenta_bancaria VARCHAR(100),
  CONSTRAINT fk_billetera_usuario FOREIGN KEY (id_usuario) REFERENCES USUARIO(id_usuario)
    ON DELETE RESTRICT ON UPDATE RESTRICT
) ENGINE=InnoDB;

CREATE TABLE SIGNO_TIPO_MOV (
  id_tipo_movimiento INT NOT NULL,
  id_signo INT NOT NULL,
  creado_en DATETIME NULL,
  PRIMARY KEY (id_tipo_movimiento, id_signo),
  CONSTRAINT fk_sxtm_tipomov FOREIGN KEY (id_tipo_movimiento) REFERENCES TIPO_MOVIMIENTO(id_tipo_movimiento)
    ON DELETE RESTRICT ON UPDATE RESTRICT,
  CONSTRAINT fk_sxtm_signo FOREIGN KEY (id_signo) REFERENCES SIGNO_MOVIMIENTO(id_signo)
    ON DELETE RESTRICT ON UPDATE RESTRICT
) ENGINE=InnoDB;

CREATE INDEX ix_sxtm_signo ON SIGNO_TIPO_MOV (id_signo);

CREATE TABLE COMPRA_CREDITOS (
  id_compra INT PRIMARY KEY AUTO_INCREMENT,
  id_usuario INT NOT NULL,
  id_paquete INT NOT NULL,
  monto_bs DECIMAL(12,2) NOT NULL,
  estado ENUM('PENDIENTE','APROBADO','RECHAZADO','FALLIDO','REVERTIDO') DEFAULT 'PENDIENTE',
  id_transaccion_pago VARCHAR(255),
  UNIQUE (id_transaccion_pago),
  CONSTRAINT fk_compra_usuario FOREIGN KEY (id_usuario) REFERENCES USUARIO(id_usuario)
    ON DELETE RESTRICT ON UPDATE RESTRICT,
  CONSTRAINT fk_compra_paquete FOREIGN KEY (id_paquete) REFERENCES PAQUETE_CREDITOS(id_paquete)
    ON DELETE RESTRICT ON UPDATE RESTRICT,
  CONSTRAINT ck_compra_monto CHECK (monto_bs >= 0)
) ENGINE=InnoDB;

CREATE TABLE MOVIMIENTO_CREDITOS (
  id_movimiento INT PRIMARY KEY AUTO_INCREMENT,
  id_usuario INT NOT NULL,
  id_tipo_movimiento INT NOT NULL,
  id_tipo_referencia INT NOT NULL,
  cantidad BIGINT NOT NULL,
  descripcion VARCHAR(255),
  saldo_anterior BIGINT NOT NULL,
  saldo_posterior BIGINT NOT NULL,
  id_referencia INT NULL,
  CONSTRAINT fk_mov_usuario FOREIGN KEY (id_usuario) REFERENCES USUARIO(id_usuario)
    ON DELETE RESTRICT ON UPDATE RESTRICT,
  CONSTRAINT fk_mov_tipomov FOREIGN KEY (id_tipo_movimiento) REFERENCES TIPO_MOVIMIENTO(id_tipo_movimiento)
    ON DELETE RESTRICT ON UPDATE RESTRICT,
  CONSTRAINT fk_mov_tiporef FOREIGN KEY (id_tipo_referencia) REFERENCES TIPO_REFERENCIA(id_tipo_referencia)
    ON DELETE RESTRICT ON UPDATE RESTRICT,
  CONSTRAINT ck_mov_cantidad CHECK (cantidad > 0)
) ENGINE=InnoDB;

CREATE INDEX ix_mov_tiporef  ON MOVIMIENTO_CREDITOS (id_tipo_referencia);
CREATE INDEX ix_mov_creado   ON MOVIMIENTO_CREDITOS (id_movimiento);
CREATE INDEX ix_mov_usuario  ON MOVIMIENTO_CREDITOS (id_usuario, id_movimiento);

-- 5) TRANSACCIONES / BITÁCORA

CREATE TABLE TRANSACCION (
  id_transaccion INT PRIMARY KEY AUTO_INCREMENT,
  id_comprador INT NOT NULL,
  id_vendedor INT NOT NULL,
  id_publicacion INT NOT NULL,
  cantidad_creditos BIGINT NOT NULL,
  estado ENUM('SOLICITADA','ACEPTADA','RECHAZADA','CANCELADA','COMPLETADA','ANULADA') DEFAULT 'SOLICITADA',
  CONSTRAINT fk_tx_comprador FOREIGN KEY (id_comprador) REFERENCES USUARIO(id_usuario)
    ON DELETE RESTRICT ON UPDATE RESTRICT,
  CONSTRAINT fk_tx_vendedor FOREIGN KEY (id_vendedor) REFERENCES USUARIO(id_usuario)
    ON DELETE RESTRICT ON UPDATE RESTRICT,
  CONSTRAINT fk_tx_publicacion FOREIGN KEY (id_publicacion) REFERENCES PUBLICACION(id_publicacion)
    ON DELETE RESTRICT ON UPDATE RESTRICT
) ENGINE=InnoDB;

CREATE INDEX ix_trans_estado   ON TRANSACCION (estado);
CREATE INDEX ix_tx_comprador   ON TRANSACCION (id_comprador);
CREATE INDEX ix_tx_vendedor    ON TRANSACCION (id_vendedor);
CREATE INDEX ix_tx_publicacion ON TRANSACCION (id_publicacion);

CREATE TABLE BITACORA_INTERCAMBIO (
  id_bitacora INT PRIMARY KEY AUTO_INCREMENT,
  id_transaccion INT NOT NULL,
  id_usuario_origen INT NOT NULL,
  id_usuario_destino INT NOT NULL,
  cantidad_creditos BIGINT NOT NULL,
  descripcion VARCHAR(500),
  CONSTRAINT fk_bi_transaccion FOREIGN KEY (id_transaccion) REFERENCES TRANSACCION(id_transaccion)
    ON DELETE RESTRICT ON UPDATE RESTRICT,
  CONSTRAINT fk_bi_usr_origen FOREIGN KEY (id_usuario_origen) REFERENCES USUARIO(id_usuario)
    ON DELETE RESTRICT ON UPDATE RESTRICT,
  CONSTRAINT fk_bi_usr_destino FOREIGN KEY (id_usuario_destino) REFERENCES USUARIO(id_usuario)
    ON DELETE RESTRICT ON UPDATE RESTRICT
) ENGINE=InnoDB;

CREATE INDEX ix_bitacora_trx ON BITACORA_INTERCAMBIO (id_transaccion);

-- 6) PROMOCIONES / LOGROS / PUBLICIDAD

CREATE TABLE PROMOCION (
  id_promocion INT PRIMARY KEY AUTO_INCREMENT,
  id_tipo_promocion INT NOT NULL,
  nombre VARCHAR(100) NOT NULL,
  descripcion VARCHAR(255),
  creditos_otorgados BIGINT NOT NULL,
  fecha_inicio DATETIME NOT NULL,
  fecha_fin DATETIME NOT NULL,
  estado ENUM('PROGRAMADA','ACTIVA','PAUSADA','FINALIZADA','CANCELADA') DEFAULT 'PROGRAMADA',
  CONSTRAINT fk_promocion_tipo FOREIGN KEY (id_tipo_promocion) REFERENCES TIPO_PROMOCION(id_tipo_promocion)
    ON DELETE RESTRICT ON UPDATE RESTRICT
) ENGINE=InnoDB;

CREATE INDEX ix_promocion_activa ON PROMOCION (estado, fecha_inicio, fecha_fin);

CREATE TABLE PROMOCION_PUBLICACION (
  id_promocion INT NOT NULL,
  id_publicacion INT NOT NULL,
  PRIMARY KEY (id_promocion, id_publicacion),
  CONSTRAINT fk_pp_promocion FOREIGN KEY (id_promocion) REFERENCES PROMOCION(id_promocion)
    ON DELETE CASCADE ON UPDATE RESTRICT,
  CONSTRAINT fk_pp_publicacion FOREIGN KEY (id_publicacion) REFERENCES PUBLICACION(id_publicacion)
    ON DELETE CASCADE ON UPDATE RESTRICT
) ENGINE=InnoDB;

CREATE INDEX ix_promopub_pub  ON PROMOCION_PUBLICACION (id_publicacion);
CREATE INDEX ix_promopub_prom ON PROMOCION_PUBLICACION (id_promocion);

CREATE TABLE LOGRO (
  id_logro INT PRIMARY KEY AUTO_INCREMENT,
  id_tipo_logro INT NOT NULL,
  nombre VARCHAR(100) NOT NULL,
  descripcion VARCHAR(255),
  meta_requerida BIGINT NOT NULL,
  creditos_recompensa BIGINT NOT NULL,
  CONSTRAINT fk_logro_tipo FOREIGN KEY (id_tipo_logro) REFERENCES TIPO_LOGRO(id_tipo_logro)
    ON DELETE RESTRICT ON UPDATE RESTRICT
) ENGINE=InnoDB;

CREATE TABLE USUARIO_LOGRO (
  id_usuario_logro INT PRIMARY KEY AUTO_INCREMENT,
  id_usuario INT NOT NULL,
  id_logro INT NOT NULL,
  progreso_actual BIGINT DEFAULT 0,
  UNIQUE (id_usuario, id_logro),
  CONSTRAINT fk_ulogro_usuario FOREIGN KEY (id_usuario) REFERENCES USUARIO(id_usuario)
    ON DELETE RESTRICT ON UPDATE RESTRICT,
  CONSTRAINT fk_ulogro_logro FOREIGN KEY (id_logro) REFERENCES LOGRO(id_logro)
    ON DELETE RESTRICT ON UPDATE RESTRICT
) ENGINE=InnoDB;

CREATE TABLE PUBLICIDAD (
  id_publicidad INT PRIMARY KEY AUTO_INCREMENT,
  id_usuario INT NOT NULL,
  id_ubicacion INT NOT NULL,
  estado ENUM('PROGRAMADA','ACTIVA','PAUSADA','FINALIZADA','CANCELADA') DEFAULT 'PROGRAMADA',
  titulo VARCHAR(200) NOT NULL,
  descripcion VARCHAR(255),
  url_destino VARCHAR(500),
  fecha_inicio DATETIME NOT NULL,
  fecha_fin DATETIME NOT NULL,
  costo_creditos BIGINT NOT NULL,
  CONSTRAINT fk_publicidad_usuario FOREIGN KEY (id_usuario) REFERENCES USUARIO(id_usuario)
    ON DELETE RESTRICT ON UPDATE RESTRICT,
  CONSTRAINT fk_publicidad_ubipub FOREIGN KEY (id_ubicacion) REFERENCES UBICACION_PUBLICIDAD(id_ubicacion)
    ON DELETE RESTRICT ON UPDATE RESTRICT
) ENGINE=InnoDB;

-- 7) ACTIVIDADES Y REPORTES

CREATE TABLE ACTIVIDAD_SOSTENIBLE (
  id_actividad INT PRIMARY KEY AUTO_INCREMENT,
  id_usuario INT NOT NULL,
  id_tipo_actividad INT NOT NULL,
  descripcion TEXT NOT NULL,
  creditos_otorgados INT NOT NULL,
  evidencia_url VARCHAR(500),
  CONSTRAINT fk_act_usuario FOREIGN KEY (id_usuario) REFERENCES USUARIO(id_usuario)
    ON DELETE RESTRICT ON UPDATE RESTRICT,
  CONSTRAINT fk_act_tipo FOREIGN KEY (id_tipo_actividad) REFERENCES TIPO_ACTIVIDAD(id_tipo_actividad)
    ON DELETE RESTRICT ON UPDATE RESTRICT
) ENGINE=InnoDB;

CREATE TABLE REPORTE_IMPACTO (
  id_reporte INT PRIMARY KEY AUTO_INCREMENT,
  id_usuario INT NULL,
  id_tipo_reporte INT NOT NULL,
  id_periodo INT NOT NULL,
  total_co2_ahorrado DECIMAL(12,6) NOT NULL,
  total_agua_ahorrada DECIMAL(12,6) NOT NULL,
  total_energia_ahorrada DECIMAL(12,6) NOT NULL,
  total_transacciones BIGINT NOT NULL,
  total_usuarios_activos BIGINT NOT NULL,
  CONSTRAINT fk_rep_usuario FOREIGN KEY (id_usuario) REFERENCES USUARIO(id_usuario)
    ON DELETE RESTRICT ON UPDATE RESTRICT,
  CONSTRAINT fk_rep_tiporep FOREIGN KEY (id_tipo_reporte) REFERENCES TIPO_REPORTE(id_tipo_reporte)
    ON DELETE RESTRICT ON UPDATE RESTRICT,
  CONSTRAINT fk_rep_periodo FOREIGN KEY (id_periodo) REFERENCES PERIODO(id_periodo)
    ON DELETE RESTRICT ON UPDATE RESTRICT
) ENGINE=InnoDB;

CREATE INDEX ix_rep_unico_helper ON REPORTE_IMPACTO (id_tipo_reporte, id_periodo, id_usuario);

-- 8) AMBIENTAL

CREATE TABLE EQUIVALENCIA_IMPACTO (
  id_equivalencia INT PRIMARY KEY AUTO_INCREMENT,
  id_categoria INT NOT NULL,
  id_um INT NULL,
  co2_por_unidad DECIMAL(12,6) NOT NULL,
  agua_por_unidad DECIMAL(12,6) NOT NULL,
  energia_por_unidad DECIMAL(12,6) NOT NULL,
  UNIQUE (id_categoria, id_um),
  CONSTRAINT fk_eq_cat FOREIGN KEY (id_categoria) REFERENCES CATEGORIA(id_categoria)
    ON DELETE RESTRICT ON UPDATE RESTRICT,
  CONSTRAINT fk_eq_um FOREIGN KEY (id_um) REFERENCES UNIDAD_MEDIDA(id_um)
    ON DELETE RESTRICT ON UPDATE RESTRICT
) ENGINE=InnoDB;

CREATE TABLE IMPACTO_AMBIENTAL (
  id_impacto INT PRIMARY KEY AUTO_INCREMENT,
  id_usuario INT NOT NULL,
  id_transaccion INT NOT NULL,
  id_categoria INT NOT NULL,
  co2_ahorrado DECIMAL(12,6) NOT NULL,
  agua_ahorrada DECIMAL(12,6) NOT NULL,
  energia_ahorrada DECIMAL(12,6) NOT NULL,
  id_periodo INT NOT NULL,
  CONSTRAINT fk_imp_usuario FOREIGN KEY (id_usuario) REFERENCES USUARIO(id_usuario)
    ON DELETE RESTRICT ON UPDATE RESTRICT,
  CONSTRAINT fk_imp_tx FOREIGN KEY (id_transaccion) REFERENCES TRANSACCION(id_transaccion)
    ON DELETE RESTRICT ON UPDATE RESTRICT,
  CONSTRAINT fk_imp_cat FOREIGN KEY (id_categoria) REFERENCES CATEGORIA(id_categoria)
    ON DELETE RESTRICT ON UPDATE RESTRICT,
  CONSTRAINT fk_imp_periodo FOREIGN KEY (id_periodo) REFERENCES PERIODO(id_periodo)
    ON DELETE RESTRICT ON UPDATE RESTRICT
) ENGINE=InnoDB;

CREATE INDEX ix_impa_periodo          ON IMPACTO_AMBIENTAL (id_periodo);
CREATE INDEX ix_impa_usuario_periodo  ON IMPACTO_AMBIENTAL (id_usuario, id_periodo);
CREATE INDEX ix_impa_categoria        ON IMPACTO_AMBIENTAL (id_categoria);

CREATE TABLE EVENTO_AMBIENTAL (
  id_evento INT PRIMARY KEY AUTO_INCREMENT,
  id_usuario INT NOT NULL,
  id_dimension INT NOT NULL,
  fuente ENUM('PUBLICACION','TRANSACCION') NOT NULL,
  id_fuente INT NOT NULL,
  categoria VARCHAR(100),
  valor DECIMAL(18,6) NOT NULL,
  id_um INT NULL,
  contaminacion_reducida DECIMAL(18,6),
  descripcion VARCHAR(255),
  CONSTRAINT fk_ev_usuario FOREIGN KEY (id_usuario) REFERENCES USUARIO(id_usuario)
    ON DELETE RESTRICT ON UPDATE RESTRICT,
  CONSTRAINT fk_ev_dimension FOREIGN KEY (id_dimension) REFERENCES DIMENSION_AMBIENTAL(id_dimension)
    ON DELETE RESTRICT ON UPDATE RESTRICT,
  CONSTRAINT fk_ev_um FOREIGN KEY (id_um) REFERENCES UNIDAD_MEDIDA(id_um)
    ON DELETE RESTRICT ON UPDATE RESTRICT
) ENGINE=InnoDB;

-- Índices de apoyo
CREATE INDEX ix_tipomov_nombre ON TIPO_MOVIMIENTO (nombre);
CREATE INDEX ix_tiporef_nombre ON TIPO_REFERENCIA (nombre);
CREATE INDEX ix_compra_estado  ON COMPRA_CREDITOS (estado);

SET FOREIGN_KEY_CHECKS = 1;

-- 9) FUNCIONES
-- Busca el id_tipo_movimiento dado su nombre (RECARGA, INTERCAMBIO_IN, etc.).
-- Se usa en varios SP y triggers para no quemar IDs a mano.
DROP FUNCTION IF EXISTS fn_get_tipo_mov;
DELIMITER $$
CREATE FUNCTION fn_get_tipo_mov(p_nombre VARCHAR(50))
RETURNS INT
DETERMINISTIC
BEGIN
  DECLARE v_id INT;
  SELECT id_tipo_movimiento INTO v_id
  FROM TIPO_MOVIMIENTO
  WHERE nombre = p_nombre
  LIMIT 1;
  RETURN v_id;
END$$
DELIMITER ;

-- Devuelve 1 si el usuario tiene saldo_creditos ≥ monto, si no, 0.
-- Se usa para validar que el usuario pueda pagar/intercambiar.
DROP FUNCTION IF EXISTS fn_verificar_saldo;
DELIMITER $$
CREATE FUNCTION fn_verificar_saldo(p_id_usuario INT, p_monto BIGINT)
RETURNS TINYINT
DETERMINISTIC
BEGIN
  DECLARE v_saldo BIGINT DEFAULT 0;
  SELECT saldo_creditos INTO v_saldo FROM BILLETERA WHERE id_usuario = p_id_usuario;
  IF v_saldo IS NULL THEN SET v_saldo = 0; END IF;
  RETURN (v_saldo >= p_monto);
END$$
DELIMITER ;

-- 10) PROCEDIMIENTOS
/*Flujo completo de aprobación de compra de créditos:
Valida usuario y paquete.
Verifica que el id_transaccion_pago no esté repetido.
Inserta la billetera si no existe.
Inserta la compra como APROBADO con el precio del paquete.
Obtiene el tipo de movimiento RECARGA.
Inserta un MOVIMIENTO_CREDITOS por la cantidad de créditos del paquete.*/
DROP PROCEDURE IF EXISTS sp_compra_creditos_aprobar;
DELIMITER $$
CREATE PROCEDURE sp_compra_creditos_aprobar(
  IN p_id_usuario INT,
  IN p_id_paquete INT,
  IN p_id_transaccion_pago VARCHAR(255)
)
BEGIN
  DECLARE v_creditos BIGINT;
  DECLARE v_id_tipo_mov INT;

  DECLARE EXIT HANDLER FOR SQLEXCEPTION
  BEGIN ROLLBACK; RESIGNAL; END;

  IF p_id_usuario IS NULL OR p_id_paquete IS NULL THEN
    SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Usuario y paquete son obligatorios';
  END IF;

  IF p_id_transaccion_pago IS NOT NULL AND
     EXISTS (SELECT 1 FROM COMPRA_CREDITOS WHERE id_transaccion_pago = p_id_transaccion_pago) THEN
    SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Pago ya registrado';
  END IF;

  SELECT cantidad_creditos INTO v_creditos
  FROM PAQUETE_CREDITOS
  WHERE id_paquete = p_id_paquete;

  IF v_creditos IS NULL THEN
    SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Paquete no existe';
  END IF;

  START TRANSACTION;

    INSERT IGNORE INTO BILLETERA (id_usuario, estado, saldo_creditos, saldo_bs, cuenta_bancaria)
    VALUES (p_id_usuario, 'ACTIVA', 0, 0.00, NULL);

    INSERT INTO COMPRA_CREDITOS (id_usuario, id_paquete, monto_bs, estado, id_transaccion_pago)
    SELECT p_id_usuario, p_id_paquete, precio_bs, 'APROBADO', p_id_transaccion_pago
    FROM PAQUETE_CREDITOS WHERE id_paquete = p_id_paquete;

    SET v_id_tipo_mov = fn_get_tipo_mov('RECARGA');
    IF v_id_tipo_mov IS NULL THEN
      SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'TIPO_MOVIMIENTO RECARGA no existe';
    END IF;

    INSERT INTO MOVIMIENTO_CREDITOS
      (id_usuario, id_tipo_movimiento, id_tipo_referencia, cantidad, descripcion, saldo_anterior, saldo_posterior, id_referencia)
    VALUES
      (p_id_usuario, v_id_tipo_mov,
       (SELECT id_tipo_referencia FROM TIPO_REFERENCIA WHERE nombre='COMPRA' LIMIT 1),
       v_creditos, 'Recarga por compra de paquete', 0, 0, LAST_INSERT_ID());

  COMMIT;
END$$
DELIMITER ;
/*Flujo completo de aprobación de compra de créditos:
Valida usuario y paquete.
Verifica que el id_transaccion_pago no esté repetido.
Inserta la billetera si no existe.
Inserta la compra como APROBADO con el precio del paquete.
Obtiene el tipo de movimiento RECARGA.
Inserta un MOVIMIENTO_CREDITOS por la cantidad de créditos del paquete.*/
DROP PROCEDURE IF EXISTS sp_realizar_intercambio;
DELIMITER $$
CREATE PROCEDURE sp_realizar_intercambio(
  IN p_id_comprador INT,
  IN p_id_publicacion INT,
  IN p_creditos BIGINT
)
BEGIN
  DECLARE v_id_vendedor INT;
  DECLARE v_valor_creditos BIGINT;
  DECLARE v_id_tx INT;
  DECLARE v_mov_in INT;
  DECLARE v_mov_out INT;
  DECLARE v_saldo_comp BIGINT;

  DECLARE EXIT HANDLER FOR SQLEXCEPTION
  BEGIN ROLLBACK; RESIGNAL; END;

  SELECT id_usuario, valor_creditos INTO v_id_vendedor, v_valor_creditos
  FROM PUBLICACION WHERE id_publicacion = p_id_publicacion;

  IF v_id_vendedor IS NULL THEN
    SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Publicación no existe';
  END IF;
  IF p_id_comprador = v_id_vendedor THEN
    SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'No puedes intercambiar con tu propia publicación';
  END IF;

  START TRANSACTION;

    INSERT IGNORE INTO BILLETERA (id_usuario, estado, saldo_creditos, saldo_bs, cuenta_bancaria)
    VALUES (p_id_comprador, 'ACTIVA', 0, 0.00, NULL);
    INSERT IGNORE INTO BILLETERA (id_usuario, estado, saldo_creditos, saldo_bs, cuenta_bancaria)
    VALUES (v_id_vendedor, 'ACTIVA', 0, 0.00, NULL);

    SELECT saldo_creditos INTO v_saldo_comp
    FROM BILLETERA WHERE id_usuario = p_id_comprador
    FOR UPDATE;

    IF v_saldo_comp < p_creditos THEN
      SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Saldo insuficiente';
    END IF;

    INSERT INTO TRANSACCION (id_comprador, id_vendedor, id_publicacion, cantidad_creditos, estado)
    VALUES (p_id_comprador, v_id_vendedor, p_id_publicacion, p_creditos, 'ACEPTADA');
    SET v_id_tx = LAST_INSERT_ID();

    SET v_mov_in  = fn_get_tipo_mov('INTERCAMBIO_IN');
    SET v_mov_out = fn_get_tipo_mov('INTERCAMBIO_OUT');
    IF v_mov_in IS NULL OR v_mov_out IS NULL THEN
      SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Tipos de movimiento de intercambio no configurados';
    END IF;

    INSERT INTO MOVIMIENTO_CREDITOS
      (id_usuario, id_tipo_movimiento, id_tipo_referencia, cantidad, descripcion, saldo_anterior, saldo_posterior, id_referencia)
    VALUES
      (p_id_comprador, v_mov_out,
       (SELECT id_tipo_referencia FROM TIPO_REFERENCIA WHERE nombre='TRANSACCION' LIMIT 1),
       p_creditos, CONCAT('Pago por transacción #', v_id_tx), 0, 0, v_id_tx),
      (v_id_vendedor, v_mov_in,
       (SELECT id_tipo_referencia FROM TIPO_REFERENCIA WHERE nombre='TRANSACCION' LIMIT 1),
       p_creditos, CONCAT('Crédito recibido por transacción #', v_id_tx), 0, 0, v_id_tx);

    INSERT INTO BITACORA_INTERCAMBIO
      (id_transaccion, id_usuario_origen, id_usuario_destino, cantidad_creditos, descripcion)
    VALUES (v_id_tx, p_id_comprador, v_id_vendedor, p_creditos, 'Intercambio realizado');

    CALL sp_calcular_e_insertar_impacto(v_id_tx);

  COMMIT;
END$$
DELIMITER ;
/*Genera un reporte agregado en la tabla REPORTE_IMPACTO:
Suma CO₂, agua, energía, número de transacciones y usuarios activos,
para un período y opcionalmente un usuario.
Borra el reporte previo del mismo período/tipo/usuario.
Inserta el nuevo resumen.*/
DROP PROCEDURE IF EXISTS sp_generar_reporte_impacto;
DELIMITER $$
CREATE PROCEDURE sp_generar_reporte_impacto(
  IN p_id_tipo_reporte INT,
  IN p_id_periodo INT,
  IN p_id_usuario INT
)
BEGIN
  DECLARE v_total_co2 DECIMAL(12,6);
  DECLARE v_total_ag  DECIMAL(12,6);
  DECLARE v_total_en  DECIMAL(12,6);
  DECLARE v_total_tx  BIGINT;
  DECLARE v_total_users BIGINT;

  IF p_id_usuario IS NULL THEN
    SELECT IFNULL(SUM(co2_ahorrado),0),
           IFNULL(SUM(agua_ahorrada),0),
           IFNULL(SUM(energia_ahorrada),0),
           COUNT(DISTINCT id_transaccion),
           COUNT(DISTINCT id_usuario)
    INTO v_total_co2, v_total_ag, v_total_en, v_total_tx, v_total_users
    FROM IMPACTO_AMBIENTAL
    WHERE id_periodo = p_id_periodo;
  ELSE
    SELECT IFNULL(SUM(co2_ahorrado),0),
           IFNULL(SUM(agua_ahorrada),0),
           IFNULL(SUM(energia_ahorrada),0),
           COUNT(DISTINCT id_transaccion),
           COUNT(DISTINCT id_usuario)
    INTO v_total_co2, v_total_ag, v_total_en, v_total_tx, v_total_users
    FROM IMPACTO_AMBIENTAL
    WHERE id_periodo = p_id_periodo
      AND id_usuario = p_id_usuario;
  END IF;

  DELETE FROM REPORTE_IMPACTO
  WHERE id_tipo_reporte = p_id_tipo_reporte
    AND id_periodo = p_id_periodo
    AND ( (p_id_usuario IS NULL AND id_usuario IS NULL) OR id_usuario = p_id_usuario );

  INSERT INTO REPORTE_IMPACTO
    (id_usuario, id_tipo_reporte, id_periodo,
     total_co2_ahorrado, total_agua_ahorrada, total_energia_ahorrada,
     total_transacciones, total_usuarios_activos)
  VALUES
    (p_id_usuario, p_id_tipo_reporte, p_id_periodo,
     v_total_co2, v_total_ag, v_total_en, v_total_tx, v_total_users);
END$$
DELIMITER ;
/*Registra una actividad sostenible y otorga un bono de créditos:
Inserta la actividad en ACTIVIDAD_SOSTENIBLE.
Se asegura de que el usuario tenga billetera.
Obtiene tipo de movimiento BONO_ACTIVIDAD.
Inserta un MOVIMIENTO_CREDITOS positivo (créditos_otorgados).*/
DROP PROCEDURE IF EXISTS sp_registrar_actividad_sostenible;
DELIMITER $$
CREATE PROCEDURE sp_registrar_actividad_sostenible(
  IN p_id_usuario INT,
  IN p_id_tipo_actividad INT,
  IN p_descripcion TEXT,
  IN p_creditos_otorgados INT,
  IN p_evidencia_url VARCHAR(500)
)
BEGIN
  DECLARE v_mov_bono INT;

  INSERT INTO ACTIVIDAD_SOSTENIBLE (id_usuario, id_tipo_actividad, descripcion, creditos_otorgados, evidencia_url)
  VALUES (p_id_usuario, p_id_tipo_actividad, p_descripcion, p_creditos_otorgados, p_evidencia_url);

  INSERT IGNORE INTO BILLETERA (id_usuario, estado, saldo_creditos, saldo_bs, cuenta_bancaria)
  VALUES (p_id_usuario, 'ACTIVA', 0, 0.00, NULL);

  SET v_mov_bono = fn_get_tipo_mov('BONO_ACTIVIDAD');
  IF v_mov_bono IS NULL THEN
    SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'TIPO_MOVIMIENTO BONO_ACTIVIDAD no existe';
  END IF;

  INSERT INTO MOVIMIENTO_CREDITOS
    (id_usuario, id_tipo_movimiento, id_tipo_referencia, cantidad, descripcion, saldo_anterior, saldo_posterior, id_referencia)
  VALUES
    (p_id_usuario, v_mov_bono,
     (SELECT id_tipo_referencia FROM TIPO_REFERENCIA WHERE nombre='AJUSTE' LIMIT 1),
     p_creditos_otorgados, 'Bono por actividad sostenible', 0, 0, LAST_INSERT_ID());
END$$
DELIMITER ;
/*sp_obtener_historial_usuario
Devuelve un historial mixto de:
Movimientos de créditos
Transacciones del usuario (como comprador o vendedor)
En una sola consulta (con UNION ALL).*/
DROP PROCEDURE IF EXISTS sp_obtener_historial_usuario;
DELIMITER $$
CREATE PROCEDURE sp_obtener_historial_usuario(IN p_id_usuario INT)
BEGIN
  SELECT 'MOVIMIENTO' AS tipo, m.id_movimiento AS id,
         m.id_usuario, tm.nombre AS tipo_movimiento, tr.nombre AS tipo_referencia,
         m.cantidad, m.saldo_anterior, m.saldo_posterior, m.id_referencia
  FROM MOVIMIENTO_CREDITOS m
  JOIN TIPO_MOVIMIENTO tm ON tm.id_tipo_movimiento = m.id_tipo_movimiento
  JOIN TIPO_REFERENCIA tr ON tr.id_tipo_referencia = m.id_tipo_referencia
  WHERE m.id_usuario = p_id_usuario

  UNION ALL

  SELECT 'TRANSACCION' AS tipo, t.id_transaccion AS id,
         p_id_usuario AS id_usuario, 'N/A' AS tipo_movimiento, 'TRANSACCION' AS tipo_referencia,
         t.cantidad_creditos AS cantidad, NULL AS saldo_anterior, NULL AS saldo_posterior, t.id_publicacion AS id_referencia
  FROM TRANSACCION t
  WHERE t.id_comprador = p_id_usuario OR t.id_vendedor = p_id_usuario;
END$$
DELIMITER ;
/*Calcula y guarda el impacto ambiental de una transacción:
Obtiene comprador, vendedor, publicación y créditos usados.
Lee categoría y valor_creditos de la publicación.
Calcula cuántas “unidades” representa la transacción (créditos / valor_pub).
Busca equivalencias de impacto en EQUIVALENCIA_IMPACTO.
Multiplica por las unidades para obtener CO₂, agua, energía.
Toma el último PERIODO.
Inserta el registro en IMPACTO_AMBIENTAL para el comprador.*/
DROP PROCEDURE IF EXISTS sp_calcular_e_insertar_impacto;
DELIMITER $$
CREATE PROCEDURE sp_calcular_e_insertar_impacto(IN p_id_transaccion INT)
BEGIN
  DECLARE v_id_usuario_c INT;
  DECLARE v_id_usuario_v INT;
  DECLARE v_id_publicacion INT;
  DECLARE v_id_categoria INT;
  DECLARE v_creditos BIGINT;
  DECLARE v_valor_pub BIGINT;
  DECLARE v_unidades DECIMAL(18,6);
  DECLARE v_co2 DECIMAL(12,6);
  DECLARE v_agua DECIMAL(12,6);
  DECLARE v_energia DECIMAL(12,6);
  DECLARE v_id_periodo INT;

  SELECT id_comprador, id_vendedor, id_publicacion, cantidad_creditos
    INTO v_id_usuario_c, v_id_usuario_v, v_id_publicacion, v_creditos
  FROM TRANSACCION WHERE id_transaccion = p_id_transaccion;

  SELECT id_categoria, valor_creditos INTO v_id_categoria, v_valor_pub
  FROM PUBLICACION WHERE id_publicacion = v_id_publicacion;

  IF v_valor_pub IS NULL OR v_valor_pub = 0 THEN
    SET v_unidades = 1;
  ELSE
    SET v_unidades = v_creditos / v_valor_pub;
  END IF;

  SELECT IFNULL(co2_por_unidad,0), IFNULL(agua_por_unidad,0), IFNULL(energia_por_unidad,0)
    INTO v_co2, v_agua, v_energia
  FROM EQUIVALENCIA_IMPACTO
  WHERE id_categoria = v_id_categoria
  LIMIT 1;

  SET v_co2     = v_co2 * v_unidades;
  SET v_agua    = v_agua * v_unidades;
  SET v_energia = v_energia * v_unidades;

  SELECT id_periodo INTO v_id_periodo
  FROM PERIODO
  ORDER BY id_periodo DESC
  LIMIT 1;

  IF v_id_periodo IS NULL THEN
    SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'No hay PERIODO definido para registrar impacto';
  END IF;

  INSERT INTO IMPACTO_AMBIENTAL
    (id_usuario, id_transaccion, id_categoria, co2_ahorrado, agua_ahorrada, energia_ahorrada, id_periodo)
  VALUES
    (v_id_usuario_c, p_id_transaccion, v_id_categoria, v_co2, v_agua, v_energia, v_id_periodo);
END$$
DELIMITER ;

-- 11) TRIGGERS
/*Antes de insertar un MOVIMIENTO_CREDITOS:
Garantiza que el usuario tenga billetera.
Obtiene su saldo actual.
Obtiene si el movimiento es POSITIVO o NEGATIVO.
Calcula saldo_anterior y saldo_posterior.
Si es NEGATIVO y no alcanza el saldo, lanza error.*/
DROP TRIGGER IF EXISTS trg_movcred_before_ins;
DELIMITER $$
CREATE TRIGGER trg_movcred_before_ins
BEFORE INSERT ON MOVIMIENTO_CREDITOS
FOR EACH ROW
BEGIN
  DECLARE v_saldo BIGINT;
  DECLARE v_signo VARCHAR(20);

  SELECT saldo_creditos INTO v_saldo FROM BILLETERA WHERE id_usuario = NEW.id_usuario;
  IF v_saldo IS NULL THEN
    INSERT INTO BILLETERA (id_usuario, estado, saldo_creditos, saldo_bs, cuenta_bancaria)
    VALUES (NEW.id_usuario, 'ACTIVA', 0, 0.00, NULL);
    SET v_saldo = 0;
  END IF;

  SELECT sm.nombre INTO v_signo
  FROM SIGNO_TIPO_MOV sx
  JOIN SIGNO_MOVIMIENTO sm ON sm.id_signo = sx.id_signo
  WHERE sx.id_tipo_movimiento = NEW.id_tipo_movimiento
  LIMIT 1;

  IF v_signo IS NULL THEN
    SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Tipo de movimiento no tiene signo asociado';
  END IF;

  SET NEW.saldo_anterior = v_saldo;
  IF v_signo = 'NEGATIVO' THEN
    IF v_saldo < NEW.cantidad THEN
      SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Saldo insuficiente para movimiento';
    END IF;
    SET NEW.saldo_posterior = v_saldo - NEW.cantidad;
  ELSE
    SET NEW.saldo_posterior = v_saldo + NEW.cantidad;
  END IF;
END$$
DELIMITER ;
/*Después de insertar el movimiento:
Actualiza la BILLETERA con el nuevo saldo_posterior.*/
DROP TRIGGER IF EXISTS trg_movcred_after_ins;
DELIMITER $$
CREATE TRIGGER trg_movcred_after_ins
AFTER INSERT ON MOVIMIENTO_CREDITOS
FOR EACH ROW
BEGIN
  UPDATE BILLETERA
  SET saldo_creditos = NEW.saldo_posterior
  WHERE id_usuario = NEW.id_usuario;
END$$
DELIMITER ;
/*Antes de insertar una TRANSACCION:
Llama a fn_verificar_saldo para revisar si el comprador tiene créditos suficientes.
Si no, lanza error.*/
DROP TRIGGER IF EXISTS trg_trans_before_ins;
DELIMITER $$
CREATE TRIGGER trg_trans_before_ins
BEFORE INSERT ON TRANSACCION
FOR EACH ROW
BEGIN
  IF fn_verificar_saldo(NEW.id_comprador, NEW.cantidad_creditos) = 0 THEN
    SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Saldo insuficiente para crear la transacción';
  END IF;
END$$
DELIMITER ;
/*Después de insertar una TRANSACCION:
Inserta un registro en BITACORA_INTERCAMBIO (“Transacción creada”).*/
DROP TRIGGER IF EXISTS trg_trans_after_ins;
DELIMITER $$
CREATE TRIGGER trg_trans_after_ins
AFTER INSERT ON TRANSACCION
FOR EACH ROW
BEGIN
  INSERT INTO BITACORA_INTERCAMBIO (id_transaccion, id_usuario_origen, id_usuario_destino, cantidad_creditos, descripcion)
  VALUES (NEW.id_transaccion, NEW.id_comprador, NEW.id_vendedor, NEW.cantidad_creditos, 'Transacción creada');
END$$
DELIMITER ;
/*Después de actualizar una TRANSACCION:
Si cambió de estado, inserta en BITACORA_INTERCAMBIO un historial del cambio*/
DROP TRIGGER IF EXISTS trg_trans_after_upd;
DELIMITER $$
CREATE TRIGGER trg_trans_after_upd
AFTER UPDATE ON TRANSACCION
FOR EACH ROW
BEGIN
  IF (OLD.estado <> NEW.estado) THEN
    INSERT INTO BITACORA_INTERCAMBIO (id_transaccion, id_usuario_origen, id_usuario_destino, cantidad_creditos, descripcion)
    VALUES (NEW.id_transaccion, NEW.id_comprador, NEW.id_vendedor, NEW.cantidad_creditos,
            CONCAT('Estado actualizado a ', NEW.estado));
  END IF;
END$$
DELIMITER ;
/*Cuando se crea una PUBLICACION:
Suma los créditos de promociones ACTIVAS asociadas a esa publicación.
Si hay bono:
crea billetera si no existe
obtiene tipo BONO_PUBLICACION
inserta MOVIMIENTO_CREDITOS positivo con el bono.*/
DROP TRIGGER IF EXISTS trg_publicacion_after_ins_bono;
DELIMITER $$
CREATE TRIGGER trg_publicacion_after_ins_bono
AFTER INSERT ON PUBLICACION
FOR EACH ROW
BEGIN
  DECLARE v_bono_total BIGINT DEFAULT 0;
  DECLARE v_mov_bono INT;

  SELECT IFNULL(SUM(p.creditos_otorgados),0) INTO v_bono_total
  FROM PROMOCION_PUBLICACION pp
  JOIN PROMOCION p ON p.id_promocion = pp.id_promocion
  WHERE pp.id_publicacion = NEW.id_publicacion
    AND p.estado = 'ACTIVA'
    AND NOW() BETWEEN p.fecha_inicio AND p.fecha_fin;

  IF v_bono_total > 0 THEN
    INSERT IGNORE INTO BILLETERA (id_usuario, estado, saldo_creditos, saldo_bs, cuenta_bancaria)
    VALUES (NEW.id_usuario, 'ACTIVA', 0, 0.00, NULL);

    SET v_mov_bono = fn_get_tipo_mov('BONO_PUBLICACION');
    IF v_mov_bono IS NULL THEN
      SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'TIPO_MOVIMIENTO BONO_PUBLICACION no existe';
    END IF;

    INSERT INTO MOVIMIENTO_CREDITOS
      (id_usuario, id_tipo_movimiento, id_tipo_referencia, cantidad, descripcion, saldo_anterior, saldo_posterior, id_referencia)
    VALUES
      (NEW.id_usuario, v_mov_bono,
       (SELECT id_tipo_referencia FROM TIPO_REFERENCIA WHERE nombre='AJUSTE' LIMIT 1),
       v_bono_total, CONCAT('Bono por publicación #', NEW.id_publicacion), 0, 0, NEW.id_publicacion);
  END IF;
END$$
DELIMITER ;

-- NUEVO: bono al VINCULAR promoción a publicación (flujo real común)
DROP TRIGGER IF EXISTS trg_promopub_after_ins_bono;
DELIMITER $$
CREATE TRIGGER trg_promopub_after_ins_bono
AFTER INSERT ON PROMOCION_PUBLICACION
FOR EACH ROW
trg: BEGIN
  DECLARE v_id_usuario INT;
  DECLARE v_bono BIGINT;
  DECLARE v_mov_bono INT;

  SELECT p.creditos_otorgados INTO v_bono
  FROM PROMOCION p
  WHERE p.id_promocion = NEW.id_promocion
    AND p.estado = 'ACTIVA'
    AND NOW() BETWEEN p.fecha_inicio AND p.fecha_fin
  LIMIT 1;

  IF v_bono IS NULL OR v_bono <= 0 THEN
    LEAVE trg;
  END IF;

  SELECT id_usuario INTO v_id_usuario
  FROM PUBLICACION
  WHERE id_publicacion = NEW.id_publicacion;

  IF v_id_usuario IS NULL THEN
    LEAVE trg;
  END IF;

  INSERT IGNORE INTO BILLETERA (id_usuario, estado, saldo_creditos, saldo_bs, cuenta_bancaria)
  VALUES (v_id_usuario, 'ACTIVA', 0, 0.00, NULL);

  SET v_mov_bono = fn_get_tipo_mov('BONO_PUBLICACION');
  IF v_mov_bono IS NULL THEN
    SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'TIPO_MOVIMIENTO BONO_PUBLICACION no existe';
  END IF;

  INSERT INTO MOVIMIENTO_CREDITOS
    (id_usuario, id_tipo_movimiento, id_tipo_referencia, cantidad, descripcion,
     saldo_anterior, saldo_posterior, id_referencia)
  VALUES
    (v_id_usuario, v_mov_bono,
     (SELECT id_tipo_referencia FROM TIPO_REFERENCIA WHERE nombre='AJUSTE' LIMIT 1),
     v_bono, CONCAT('Bono por promo vinculada a publicación #', NEW.id_publicacion),
     0, 0, NEW.id_publicacion);
END trg$$
DELIMITER ;

-- 12) FULLTEXT (buscador)

ALTER TABLE PUBLICACION
  ADD FULLTEXT ft_pub_titulo_desc (titulo, descripcion);

-- 13) SEED FUNCIONAL (deja datos de demo listos)
-- Roles, permisos mínimos (permiso útil para admin si lo usas)
INSERT IGNORE INTO ROL (nombre, descripcion) VALUES
  ('ADMIN','Administrador'),('COMPRADOR','Comprador'),('VENDEDOR','Vendedor'),('ONG','Organización');

INSERT IGNORE INTO PERMISO (nombre, descripcion) VALUES
  ('GESTION_USUARIOS','CRUD usuarios'),('VER_REPORTES','Acceso a reportes');

INSERT IGNORE INTO ROL_PERMISO
SELECT (SELECT id_rol FROM ROL WHERE nombre='ADMIN'),
       (SELECT id_permiso FROM PERMISO WHERE nombre='GESTION_USUARIOS')
UNION ALL
SELECT (SELECT id_rol FROM ROL WHERE nombre='ADMIN'),
       (SELECT id_permiso FROM PERMISO WHERE nombre='VER_REPORTES');

INSERT IGNORE INTO RESULTADO_ACCESO (nombre, descripcion)
VALUES ('OK','Inicio de sesión correcto'),('FAIL','Credenciales inválidas');

INSERT IGNORE INTO CATEGORIA (nombre, descripcion)
VALUES ('Bicicletas','Movilidad'),('Tecnología','Electrónica');

INSERT IGNORE INTO UNIDAD_MEDIDA (nombre, simbolo)
VALUES ('Unidad','u'),('Kilogramo','kg'),('KilogramoCO2','kgCO2'),('Litro','L'),('kWh','kWh');

INSERT IGNORE INTO UBICACION (direccion, ciudad, provincia, latitud, longitud)
VALUES ('Av. Central 123','La Paz','La Paz',-16.5,-68.15),
       ('Calle 9 #456','Cochabamba','Cochabamba',-17.392,-66.159);

INSERT IGNORE INTO TIPO_PUBLICACION (nombre, descripcion)
VALUES ('PRODUCTO','Publicación de producto'),('SERVICIO','Publicación de servicio');

INSERT IGNORE INTO TIPO_REFERENCIA (nombre) VALUES ('COMPRA'),('TRANSACCION'),('AJUSTE');

INSERT IGNORE INTO TIPO_MOVIMIENTO (nombre, descripcion) VALUES
  ('RECARGA','Ingreso por compra de créditos'),
  ('INTERCAMBIO_IN','Ingreso por intercambio'),
  ('INTERCAMBIO_OUT','Egreso por intercambio'),
  ('BONO_PUBLICACION','Bono por promo/publicación'),
  ('BONO_ACTIVIDAD','Bono por actividad sostenible');

INSERT IGNORE INTO SIGNO_MOVIMIENTO (nombre) VALUES ('POSITIVO'),('NEGATIVO');

INSERT IGNORE INTO SIGNO_TIPO_MOV (id_tipo_movimiento, id_signo, creado_en)
SELECT tm.id_tipo_movimiento, sm.id_signo, NOW()
FROM TIPO_MOVIMIENTO tm
JOIN SIGNO_MOVIMIENTO sm
ON ((tm.nombre IN ('RECARGA','INTERCAMBIO_IN','BONO_PUBLICACION','BONO_ACTIVIDAD') AND sm.nombre='POSITIVO')
 OR  (tm.nombre = 'INTERCAMBIO_OUT' AND sm.nombre='NEGATIVO'));

INSERT IGNORE INTO TIPO_PROMOCION (nombre, descripcion) VALUES ('LANZAMIENTO','Promoción de lanzamiento');
INSERT IGNORE INTO TIPO_LOGRO (nombre, descripcion) VALUES ('PRIMERA_VENTA','Primer intercambio exitoso');
INSERT IGNORE INTO TIPO_ACTIVIDAD (nombre, descripcion) VALUES ('RECICLAJE','Reciclaje domiciliario');
INSERT IGNORE INTO UBICACION_PUBLICIDAD (nombre, descripcion, precio_base) VALUES ('HOME_TOP','Banner cabecera', 120.00);
INSERT IGNORE INTO TIPO_REPORTE (nombre, descripcion) VALUES ('MENSUAL','KPIs mensuales');

INSERT IGNORE INTO PERIODO (nombre, descripcion, fecha_inicio, fecha_fin)
VALUES ('2025-11','Noviembre 2025','2025-11-01','2025-11-30');

INSERT IGNORE INTO DIMENSION_AMBIENTAL (codigo, nombre, unidad_base, descripcion)
VALUES ('CO2','Dióxido de carbono','kg','CO2 evitado'),
       ('AGUA','Agua ahorrada','L','Litros ahorrados'),
       ('ENERGIA','Energía ahorrada','kWh','Energía');

-- Usuarios demo
INSERT IGNORE INTO USUARIO (id_rol, estado, nombre, apellido, correo, telefono, url_perfil)
VALUES
  ((SELECT id_rol FROM ROL WHERE nombre='COMPRADOR'),'ACTIVO','Ana','Rojas','ana@demo.com','70000001','/p/ana'),
  ((SELECT id_rol FROM ROL WHERE nombre='VENDEDOR'),'ACTIVO','Luis','Quispe','luis@demo.com','70000002','/p/luis');

INSERT IGNORE INTO BILLETERA (id_usuario, estado, saldo_creditos, saldo_bs, cuenta_bancaria)
SELECT id_usuario, 'ACTIVA', 0, 0.00, NULL FROM USUARIO;

-- Producto y servicio
INSERT IGNORE INTO PRODUCTO (id_categoria, nombre, descripcion, precio, peso)
SELECT (SELECT id_categoria FROM CATEGORIA WHERE nombre='Bicicletas'),
       'Bici Urbana', 'Marco aluminio 21v', 1200.00, 14.5;

INSERT IGNORE INTO SERVICIO (id_categoria, estado, nombre, descripcion, precio, duracion_min)
SELECT (SELECT id_categoria FROM CATEGORIA WHERE nombre='Tecnología'),
       'ACTIVO', 'Mantenimiento PC', 'Limpieza y optimización', 90.00, 60;

-- Publicación de producto (Luis)
INSERT IGNORE INTO PUBLICACION
  (id_usuario, id_categoria, id_tipo_publicacion, estado, id_ubicacion, titulo, descripcion, valor_creditos, imagen_url)
SELECT
  (SELECT id_usuario FROM USUARIO WHERE correo='luis@demo.com'),
  (SELECT id_categoria FROM CATEGORIA WHERE nombre='Bicicletas'),
  (SELECT id_tipo_publicacion FROM TIPO_PUBLICACION WHERE nombre='PRODUCTO'),
  'PUBLICADA',
  (SELECT id_ubicacion FROM UBICACION WHERE ciudad='La Paz'),
  'Bicicleta urbana aluminio',
  'Bici urbana ligera, marco de aluminio, 21 velocidades.',
  300, 'https://img/bici1.jpg';

INSERT IGNORE INTO PUBLICACION_PRODUCTO
SELECT
  (SELECT id_publicacion FROM PUBLICACION WHERE titulo='Bicicleta urbana aluminio'),
  (SELECT id_producto FROM PRODUCTO WHERE nombre='Bici Urbana'),
  1.0000,
  (SELECT id_um FROM UNIDAD_MEDIDA WHERE simbolo='u');

-- Publicación de servicio (Luis)
INSERT IGNORE INTO PUBLICACION
  (id_usuario, id_categoria, id_tipo_publicacion, estado, id_ubicacion, titulo, descripcion, valor_creditos, imagen_url)
SELECT
  (SELECT id_usuario FROM USUARIO WHERE correo='luis@demo.com'),
  (SELECT id_categoria FROM CATEGORIA WHERE nombre='Tecnología'),
  (SELECT id_tipo_publicacion FROM TIPO_PUBLICACION WHERE nombre='SERVICIO'),
  'PUBLICADA',
  (SELECT id_ubicacion FROM UBICACION WHERE ciudad='Cochabamba'),
  'Mantenimiento y limpieza de PC',
  'Servicio técnico: limpieza, cambio de pasta térmica y pruebas.',
  120, 'https://img/serv1.jpg';

INSERT IGNORE INTO PUBLICACION_SERVICIO
SELECT
  (SELECT id_publicacion FROM PUBLICACION WHERE titulo='Mantenimiento y limpieza de PC'),
  (SELECT id_servicio FROM SERVICIO WHERE nombre='Mantenimiento PC'),
  'L-V 09:00-18:00';

-- Promo activa y vinculación (dispara bono)
INSERT IGNORE INTO PROMOCION (id_tipo_promocion, nombre, descripcion, creditos_otorgados, fecha_inicio, fecha_fin, estado)
SELECT
  (SELECT id_tipo_promocion FROM TIPO_PROMOCION WHERE nombre='LANZAMIENTO'),
  'Promo Bicis', 'Bono por bicis destacadas', 50,
  NOW() - INTERVAL 1 DAY, NOW() + INTERVAL 1 DAY, 'ACTIVA';

INSERT IGNORE INTO PROMOCION_PUBLICACION
SELECT
  (SELECT id_promocion FROM PROMOCION WHERE nombre='Promo Bicis'),
  (SELECT id_publicacion FROM PUBLICACION WHERE titulo='Bicicleta urbana aluminio');

-- Equivalencia de impacto (Bicicletas por unidad)
INSERT IGNORE INTO EQUIVALENCIA_IMPACTO (id_categoria, id_um, co2_por_unidad, agua_por_unidad, energia_por_unidad)
SELECT
  (SELECT id_categoria FROM CATEGORIA WHERE nombre='Bicicletas'),
  (SELECT id_um FROM UNIDAD_MEDIDA WHERE simbolo='u'),
  12.500000, 45.000000, 5.750000;

-- Paquetes (100 y 500 créditos)
INSERT IGNORE INTO PAQUETE_CREDITOS (nombre, cantidad_creditos, precio_bs, activo)
VALUES ('Pack 100', 100, 50.00, TRUE),
       ('Pack 500', 500, 240.00, TRUE);

-- 14) PRUEBA REAL (deja datos consistentes para demo)

-- 14.1 Compra de créditos (Ana RECARGA 500)
CALL sp_compra_creditos_aprobar(
  (SELECT id_usuario FROM USUARIO WHERE correo='ana@demo.com'),
  (SELECT id_paquete FROM PAQUETE_CREDITOS WHERE nombre='Pack 500'),
  'PAY-DEMO-001'
);

-- 14.2 Intercambio: Ana compra la bicicleta (300 créditos)
CALL sp_realizar_intercambio(
  (SELECT id_usuario FROM USUARIO WHERE correo='ana@demo.com'),
  (SELECT id_publicacion FROM PUBLICACION WHERE titulo='Bicicleta urbana aluminio'),
  300
);

-- Completar transacción (bitácora AFTER UPDATE)
SET @id_last_tx = (SELECT MAX(id_transaccion) FROM TRANSACCION);
UPDATE TRANSACCION
SET estado = 'COMPLETADA'
WHERE id_transaccion = @id_last_tx;


-- 14.3 Actividad sostenible (bono)
CALL sp_registrar_actividad_sostenible(
  (SELECT id_usuario FROM USUARIO WHERE correo='ana@demo.com'),
  (SELECT id_tipo_actividad FROM TIPO_ACTIVIDAD WHERE nombre='RECICLAJE'),
  'Entregó 5kg de papel para reciclaje', 15,
  'https://evidencias/reciclaje1.jpg'
);

-- 14.4 Reporte mensual global + ranking + historial
CALL sp_generar_reporte_impacto(
  (SELECT id_tipo_reporte FROM TIPO_REPORTE WHERE nombre='MENSUAL'),
  (SELECT id_periodo FROM PERIODO WHERE nombre='2025-11'),
  NULL
);

-- Crear sp_obtener_ranking_usuarios

DROP PROCEDURE IF EXISTS sp_obtener_ranking_usuarios;
DELIMITER $$
CREATE PROCEDURE sp_obtener_ranking_usuarios(
  IN p_id_periodo INT,   -- puede ser NULL para tomar el último
  IN p_limit INT          -- top N (si es NULL, usa 10)
)
BEGIN
  DECLARE v_periodo INT;
  DECLARE v_limit INT;

  -- Determinar límite (valor por defecto si viene NULL)
  SET v_limit = IFNULL(p_limit, 10);

  -- Elegir período: el recibido o el último existente
  SET v_periodo = p_id_periodo;
  IF v_periodo IS NULL THEN
    SELECT id_periodo
      INTO v_periodo
    FROM PERIODO
    ORDER BY fecha_inicio DESC, id_periodo DESC
    LIMIT 1;
  END IF;

  -- Ranking de usuarios por CO2
  SELECT
      ia.id_usuario,
      SUM(ia.co2_ahorrado)     AS co2_total,
      SUM(ia.agua_ahorrada)    AS agua_total,
      SUM(ia.energia_ahorrada) AS energia_total,
      COUNT(DISTINCT ia.id_transaccion) AS transacciones
  FROM IMPACTO_AMBIENTAL ia
  WHERE ia.id_periodo = v_periodo
  GROUP BY ia.id_usuario
  ORDER BY co2_total DESC
  LIMIT v_limit;
END$$
DELIMITER ;


-- Ranking top 10 por CO2
CALL sp_obtener_ranking_usuarios(
  (SELECT id_periodo FROM PERIODO WHERE nombre='2025-11'), 10
);

-- Historial de Ana
CALL sp_obtener_historial_usuario(
  (SELECT id_usuario FROM USUARIO WHERE correo='ana@demo.com')
);

-- 14.5 FULLTEXT sanity
SELECT id_publicacion, titulo
FROM PUBLICACION
WHERE MATCH(titulo, descripcion) AGAINST ('Bicicleta' IN NATURAL LANGUAGE MODE);

-- 14.6 Saldos
SELECT u.correo, b.saldo_creditos
FROM USUARIO u LEFT JOIN BILLETERA b ON b.id_usuario = u.id_usuario
WHERE u.correo IN ('ana@demo.com','luis@demo.com');

SELECT '✔ Esquema + triggers + seed + prueba listos.' AS status;

-- A) CAMPOS DE FECHA MÍNIMOS PARA REPORTES


ALTER TABLE PUBLICACION
  ADD COLUMN creado_en DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP;

ALTER TABLE COMPRA_CREDITOS
  ADD COLUMN creado_en DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP;

ALTER TABLE MOVIMIENTO_CREDITOS
  ADD COLUMN creado_en DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP;

ALTER TABLE TRANSACCION
  ADD COLUMN creado_en DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP;

ALTER TABLE ACTIVIDAD_SOSTENIBLE
  ADD COLUMN creado_en DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP;

-- Índices sobre fechas para que los reportes no sean lentos

CREATE INDEX ix_pub_creado_en       ON PUBLICACION(creado_en);
CREATE INDEX ix_compra_creado_en    ON COMPRA_CREDITOS(creado_en);
CREATE INDEX ix_mov_creado_en       ON MOVIMIENTO_CREDITOS(creado_en);
CREATE INDEX ix_tx_creado_en        ON TRANSACCION(creado_en);
CREATE INDEX ix_actsost_creado_en   ON ACTIVIDAD_SOSTENIBLE(creado_en);

-- B1) vw_usuario_actividad
--    - Todas las acciones que consideramos "actividad"

DROP VIEW IF EXISTS vw_usuario_actividad;
CREATE VIEW vw_usuario_actividad AS
SELECT u.id_usuario,
       u.nombre,
       u.correo,
       b.fecha AS fecha_actividad,
       'LOGIN' AS tipo_actividad
FROM USUARIO u
JOIN BITACORA_ACCESO b ON b.id_usuario = u.id_usuario

UNION ALL

SELECT u.id_usuario,
       u.nombre,
       u.correo,
       p.creado_en AS fecha_actividad,
       'PUBLICACION' AS tipo_actividad
FROM USUARIO u
JOIN PUBLICACION p ON p.id_usuario = u.id_usuario

UNION ALL

SELECT u.id_usuario,
       u.nombre,
       u.correo,
       t.creado_en AS fecha_actividad,
       'TX_COMPRADOR' AS tipo_actividad
FROM USUARIO u
JOIN TRANSACCION t ON t.id_comprador = u.id_usuario

UNION ALL

SELECT u.id_usuario,
       u.nombre,
       u.correo,
       t.creado_en AS fecha_actividad,
       'TX_VENDEDOR' AS tipo_actividad
FROM USUARIO u
JOIN TRANSACCION t ON t.id_vendedor = u.id_usuario;

-- B2) vw_mov_creditos_signo
--    - Movimiento + signo POSITIVO/NEGATIVO ya resuelto

DROP VIEW IF EXISTS vw_mov_creditos_signo;
CREATE VIEW vw_mov_creditos_signo AS
SELECT m.*,
       sm.nombre AS signo_mov
FROM MOVIMIENTO_CREDITOS m
JOIN SIGNO_TIPO_MOV sx
  ON sx.id_tipo_movimiento = m.id_tipo_movimiento
JOIN SIGNO_MOVIMIENTO sm
  ON sm.id_signo = sx.id_signo;

-- B3) vw_transacciones_categoria
--    - Transacción + categoría de la publicación

DROP VIEW IF EXISTS vw_transacciones_categoria;
CREATE VIEW vw_transacciones_categoria AS
SELECT t.id_transaccion,
       t.id_comprador,
       t.id_vendedor,
       t.id_publicacion,
       t.cantidad_creditos,
       t.estado,
       t.creado_en,
       c.id_categoria,
       c.nombre AS categoria
FROM TRANSACCION t
JOIN PUBLICACION p
  ON p.id_publicacion = t.id_publicacion
JOIN CATEGORIA c
  ON c.id_categoria = p.id_categoria;

-- C1) Usuarios activos entre p_desde y p_hasta

DROP PROCEDURE IF EXISTS sp_rep_usuarios_activos;
DELIMITER $$
CREATE PROCEDURE sp_rep_usuarios_activos(
  IN p_desde DATETIME,
  IN p_hasta DATETIME
)
BEGIN
  SELECT id_usuario,
         nombre,
         correo,
         MIN(fecha_actividad) AS primera_actividad,
         MAX(fecha_actividad) AS ultima_actividad,
         COUNT(*) AS total_acciones
  FROM vw_usuario_actividad
  WHERE fecha_actividad BETWEEN p_desde AND p_hasta
  GROUP BY id_usuario, nombre, correo
  ORDER BY ultima_actividad DESC;
END$$
DELIMITER ;

-- C2) Usuarios abandonados (sin actividad en rango)

DROP PROCEDURE IF EXISTS sp_rep_usuarios_abandonados;
DELIMITER $$
CREATE PROCEDURE sp_rep_usuarios_abandonados(
  IN p_desde DATETIME,
  IN p_hasta DATETIME
)
BEGIN
  SELECT
    u.id_usuario,
    u.nombre,
    u.correo,
    u.estado
  FROM USUARIO u
  LEFT JOIN (
    SELECT DISTINCT id_usuario
    FROM vw_usuario_actividad
    WHERE fecha_actividad BETWEEN p_desde AND p_hasta
  ) ua
    ON ua.id_usuario = u.id_usuario
  WHERE ua.id_usuario IS NULL   -- no tuvo actividad en el rango
    AND u.estado = 'ACTIVO';
END$$
DELIMITER ;

-- C3) Ingresos por venta de créditos

DROP PROCEDURE IF EXISTS sp_rep_ingresos_creditos;
DELIMITER $$
CREATE PROCEDURE sp_rep_ingresos_creditos(
  IN p_desde DATETIME,
  IN p_hasta DATETIME
)
BEGIN
  SELECT
    DATE(c.creado_en) AS fecha,
    SUM(p.cantidad_creditos) AS total_creditos,
    SUM(c.monto_bs)          AS total_bs
  FROM COMPRA_CREDITOS c
  JOIN PAQUETE_CREDITOS p
    ON p.id_paquete = c.id_paquete
  WHERE c.estado = 'APROBADO'
    AND c.creado_en BETWEEN p_desde AND p_hasta
  GROUP BY DATE(c.creado_en)
  ORDER BY fecha;
END$$
DELIMITER ;

-- C5) Intercambios por categoría

DROP PROCEDURE IF EXISTS sp_rep_intercambios_por_categoria;
DELIMITER $$
CREATE PROCEDURE sp_rep_intercambios_por_categoria(
  IN p_desde DATETIME,
  IN p_hasta DATETIME
)
BEGIN
  SELECT categoria,
         COUNT(id_transaccion) AS total_intercambios
  FROM vw_transacciones_categoria
  WHERE creado_en BETWEEN p_desde AND p_hasta
    AND estado IN ('ACEPTADA','COMPLETADA')
  GROUP BY categoria
  ORDER BY total_intercambios DESC;
END$$
DELIMITER ;

-- C6) Publicaciones vs intercambios por categoría

DROP PROCEDURE IF EXISTS sp_rep_publicaciones_vs_intercambios;
DELIMITER $$
CREATE PROCEDURE sp_rep_publicaciones_vs_intercambios(
  IN p_desde DATETIME,
  IN p_hasta DATETIME
)
BEGIN
  -- Publicaciones por categoría en el rango
  SELECT
    pub.categoria,
    pub.publicaciones,
    COALESCE(tx.intercambios, 0) AS intercambios,
    CASE
      WHEN pub.publicaciones = 0 THEN NULL
      ELSE COALESCE(tx.intercambios, 0) / pub.publicaciones
    END AS ratio_intercambio
  FROM (
    SELECT
      c.nombre AS categoria,
      COUNT(p.id_publicacion) AS publicaciones
    FROM PUBLICACION p
    JOIN CATEGORIA c ON c.id_categoria = p.id_categoria
    WHERE p.creado_en BETWEEN p_desde AND p_hasta
    GROUP BY c.nombre
  ) AS pub
  LEFT JOIN (
    SELECT
      categoria,
      COUNT(id_transaccion) AS intercambios
    FROM vw_transacciones_categoria
    WHERE creado_en BETWEEN p_desde AND p_hasta
      AND estado IN ('ACEPTADA','COMPLETADA')
    GROUP BY categoria
  ) AS tx
    ON tx.categoria = pub.categoria

  UNION ALL

  -- Categorías con intercambios pero sin publicaciones en el rango
  SELECT
    tx_only.categoria,
    0 AS publicaciones,
    tx_only.intercambios,
    NULL AS ratio_intercambio
  FROM (
    SELECT
      categoria,
      COUNT(id_transaccion) AS intercambios
    FROM vw_transacciones_categoria
    WHERE creado_en BETWEEN p_desde AND p_hasta
      AND estado IN ('ACEPTADA','COMPLETADA')
    GROUP BY categoria
  ) AS tx_only
  LEFT JOIN (
    SELECT DISTINCT c.nombre AS categoria
    FROM PUBLICACION p
    JOIN CATEGORIA c ON c.id_categoria = p.id_categoria
    WHERE p.creado_en BETWEEN p_desde AND p_hasta
  ) AS pub_exist
    ON pub_exist.categoria = tx_only.categoria
  WHERE pub_exist.categoria IS NULL;
END$$
DELIMITER ;


-- C7) Impacto acumulado por período (lectura directa)
--     Asume que ya corriste sp_generar_reporte_impacto antes

DROP PROCEDURE IF EXISTS sp_generar_reporte_impacto;
DELIMITER $$

CREATE PROCEDURE sp_generar_reporte_impacto(
  IN p_id_tipo_reporte INT,
  IN p_id_periodo      INT,
  IN p_id_usuario      INT        -- NULL = reporte global, no NULL = por usuario
)
BEGIN
  DECLARE v_total_co2      DECIMAL(12,6) DEFAULT 0;
  DECLARE v_total_ag       DECIMAL(12,6) DEFAULT 0;
  DECLARE v_total_en       DECIMAL(12,6) DEFAULT 0;
  DECLARE v_total_tx       BIGINT        DEFAULT 0;
  DECLARE v_total_users    BIGINT        DEFAULT 0;
  DECLARE v_id_reporte_new INT;

  -- 1) Calcular totales desde IMPACTO_AMBIENTAL

  IF p_id_usuario IS NULL THEN
    -- GLOBAL (todos los usuarios)
    SELECT
      IFNULL(SUM(co2_ahorrado), 0),
      IFNULL(SUM(agua_ahorrada), 0),
      IFNULL(SUM(energia_ahorrada), 0),
      COUNT(DISTINCT id_transaccion),
      COUNT(DISTINCT id_usuario)
    INTO
      v_total_co2,
      v_total_ag,
      v_total_en,
      v_total_tx,
      v_total_users
    FROM IMPACTO_AMBIENTAL
    WHERE id_periodo = p_id_periodo;
  ELSE
    -- SOLO UN USUARIO
    SELECT
      IFNULL(SUM(co2_ahorrado), 0),
      IFNULL(SUM(agua_ahorrada), 0),
      IFNULL(SUM(energia_ahorrada), 0),
      COUNT(DISTINCT id_transaccion),
      COUNT(DISTINCT id_usuario)
    INTO
      v_total_co2,
      v_total_ag,
      v_total_en,
      v_total_tx,
      v_total_users
    FROM IMPACTO_AMBIENTAL
    WHERE id_periodo = p_id_periodo
      AND id_usuario = p_id_usuario;
  END IF;

  -- 2) Limpiar reporte anterior (si existe)
  
  DELETE FROM REPORTE_IMPACTO
  WHERE id_tipo_reporte = p_id_tipo_reporte
    AND id_periodo      = p_id_periodo
    AND (
         (p_id_usuario IS NULL AND id_usuario IS NULL)
         OR id_usuario = p_id_usuario
        );

  -- 3) Insertar nuevo registro de reporte
  
  INSERT INTO REPORTE_IMPACTO (
    id_usuario,
    id_tipo_reporte,
    id_periodo,
    total_co2_ahorrado,
    total_agua_ahorrada,
    total_energia_ahorrada,
    total_transacciones,
    total_usuarios_activos
  )
  VALUES (
    p_id_usuario,
    p_id_tipo_reporte,
    p_id_periodo,
    v_total_co2,
    v_total_ag,
    v_total_en,
    v_total_tx,
    v_total_users
  );

  SET v_id_reporte_new = LAST_INSERT_ID();

  -- 4) Devolver el registro insertado
  --    (esto es lo que verá Postman / Prisma)
  
  SELECT *
  FROM REPORTE_IMPACTO
  WHERE id_reporte = v_id_reporte_new;

END$$
DELIMITER ;

ALTER TABLE USUARIO
  ADD COLUMN password_hash VARCHAR(255) NOT NULL DEFAULT ''
  AFTER correo;
  
  ALTER TABLE BITACORA_ACCESO
  MODIFY fecha DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP;

DROP PROCEDURE IF EXISTS sp_rep_creditos_generados_vs_consumidos;

DELIMITER $$
CREATE PROCEDURE sp_rep_creditos_generados_vs_consumidos(
  IN p_desde DATETIME,
  IN p_hasta DATETIME
)
BEGIN
  SELECT
    SUM(
      CASE
        WHEN signo_mov = 'POSITIVO' THEN cantidad
        ELSE 0
      END
    ) AS creditos_generados,
    SUM(
      CASE
        WHEN signo_mov = 'NEGATIVO' THEN cantidad
        ELSE 0
      END
    ) AS creditos_consumidos
  FROM vw_mov_creditos_signo
  WHERE creado_en BETWEEN p_desde AND p_hasta;
END$$
DELIMITER ;
USE CREDITOS_VERDES2;

-- TABLA: SUSCRIPCION_PREMIUM
CREATE TABLE IF NOT EXISTS SUSCRIPCION_PREMIUM (
  id_suscripcion INT PRIMARY KEY AUTO_INCREMENT,
  id_usuario INT NOT NULL,
  fecha_inicio DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  fecha_fin DATETIME NULL,
  estado ENUM('ACTIVA','CANCELADA','VENCIDA') NOT NULL DEFAULT 'ACTIVA',
  monto_bs DECIMAL(12,2) NOT NULL,
  CONSTRAINT fk_suscrip_usuario
    FOREIGN KEY (id_usuario) REFERENCES USUARIO(id_usuario)
    ON DELETE RESTRICT ON UPDATE RESTRICT
) ENGINE=InnoDB;

CREATE INDEX ix_suscrip_usuario_estado
  ON SUSCRIPCION_PREMIUM (id_usuario, estado);

CREATE INDEX ix_suscrip_fechas
  ON SUSCRIPCION_PREMIUM (fecha_inicio, fecha_fin);

DROP PROCEDURE IF EXISTS sp_rep_usuarios_premium;
DELIMITER $$
CREATE PROCEDURE sp_rep_usuarios_premium(
  IN p_desde DATETIME,
  IN p_hasta DATETIME
)
BEGIN
  DECLARE v_total_usuarios BIGINT DEFAULT 0;
  DECLARE v_nuevos_premium BIGINT DEFAULT 0;
  DECLARE v_premium_activos BIGINT DEFAULT 0;
  DECLARE v_ingresos_bs DECIMAL(12,2) DEFAULT 0.00;

  -- Total de usuarios activos en el sistema
  SELECT COUNT(*) INTO v_total_usuarios
  FROM USUARIO
  WHERE estado = 'ACTIVO';

  -- Usuarios que ADQUIRIERON la suscripción en el rango (alta)
  SELECT COUNT(DISTINCT id_usuario) INTO v_nuevos_premium
  FROM SUSCRIPCION_PREMIUM
  WHERE fecha_inicio BETWEEN p_desde AND p_hasta;

  -- Usuarios con suscripción ACTIVA en el rango
  SELECT COUNT(DISTINCT id_usuario) INTO v_premium_activos
  FROM SUSCRIPCION_PREMIUM
  WHERE estado = 'ACTIVA'
    AND fecha_inicio <= p_hasta
    AND (fecha_fin IS NULL OR fecha_fin >= p_desde);

  -- Ingresos por suscripción en el rango
  SELECT IFNULL(SUM(monto_bs), 0.00) INTO v_ingresos_bs
  FROM SUSCRIPCION_PREMIUM
  WHERE fecha_inicio BETWEEN p_desde AND p_hasta;

  -- Resultado del reporte
  SELECT
    p_desde AS desde,
    p_hasta AS hasta,
    v_total_usuarios        AS total_usuarios_activos,
    v_nuevos_premium        AS usuarios_nuevos_premium,
    v_premium_activos       AS usuarios_premium_activos,
    v_ingresos_bs           AS ingresos_suscripcion_bs,
    CASE
      WHEN v_total_usuarios = 0 THEN NULL
      ELSE ROUND(100 * v_premium_activos / v_total_usuarios, 2)
    END AS porcentaje_adopcion_premium;
END$$
DELIMITER ;
</file>

<file path="digital-barder/backend/package.json">
{
  "name": "backend",
  "private": true,
  "version": "0.1.0",
  "type": "module",
  "scripts": {
    "dev": "node --watch src/server.js",
    "start": "node src/server.js",
    "prisma:generate": "prisma generate",
    "prisma:migrate": "prisma migrate dev --name init",
    "prisma:deploy": "prisma migrate deploy",
    "prisma:seed": "node prisma/seed.js",
    "studio": "prisma studio"
  },
  "dependencies": {
    "@prisma/client": "^6.19.0",
    "bcryptjs": "^2.4.3",
    "cors": "^2.8.5",
    "dotenv": "^16.4.5",
    "express": "^4.21.1",
    "helmet": "^7.1.0",
    "jsonwebtoken": "^9.0.2",
    "morgan": "^1.10.1",
    "multer": "^2.0.2",
    "uuid": "^13.0.0"
  },
  "devDependencies": {
    "prisma": "^6.19.0"
  }
}
</file>

<file path="digital-barder/backend/prisma/schema.prisma">
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model actividad_sostenible {
  id_actividad       Int      @id @default(autoincrement())
  id_usuario         Int
  id_tipo_actividad  Int
  descripcion        String   @db.Text
  creditos_otorgados Int
  evidencia_url      String?  @db.VarChar(500)
  creado_en          DateTime @default(now()) @db.DateTime(0)

  @@index([id_tipo_actividad], map: "fk_act_tipo")
  @@index([id_usuario], map: "fk_act_usuario")
  @@index([creado_en], map: "ix_actsost_creado_en")
}

model billetera {
  id_billetera    Int               @id @default(autoincrement())
  id_usuario      Int               @unique(map: "id_usuario")
  estado          billetera_estado? @default(ACTIVA)
  saldo_creditos  BigInt?           @default(0)
  saldo_bs        Decimal?          @default(0.00) @db.Decimal(12, 2)
  cuenta_bancaria String?           @db.VarChar(100)
}

model bitacora_acceso {
  id_acceso    Int      @id @default(autoincrement())
  id_usuario   Int
  fecha        DateTime @default(now()) @db.DateTime(0)
  direccion_ip String   @db.VarChar(45)
  user_agent   String?  @db.VarChar(500)
  id_resultado Int

  @@index([id_resultado], map: "fk_bitacc_resultado")
  @@index([id_usuario, fecha], map: "ix_bitacceso_usuario_fecha")
}

model bitacora_intercambio {
  id_bitacora        Int     @id @default(autoincrement())
  id_transaccion     Int
  id_usuario_origen  Int
  id_usuario_destino Int
  cantidad_creditos  BigInt
  descripcion        String? @db.VarChar(500)

  @@index([id_usuario_destino], map: "fk_bi_usr_destino")
  @@index([id_usuario_origen], map: "fk_bi_usr_origen")
  @@index([id_transaccion], map: "ix_bitacora_trx")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model calificacion {
  id_calificacion Int     @id @default(autoincrement())
  id_usuario      Int
  id_publicacion  Int
  estrellas       Int     @db.TinyInt
  comentario      String? @db.VarChar(300)

  @@unique([id_usuario, id_publicacion], map: "id_usuario")
  @@index([id_publicacion], map: "fk_calif_publicacion")
}

model categoria {
  id_categoria Int     @id @default(autoincrement())
  nombre       String  @unique(map: "nombre") @db.VarChar(100)
  descripcion  String? @db.VarChar(255)
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model compra_creditos {
  id_compra           Int                     @id @default(autoincrement())
  id_usuario          Int
  id_paquete          Int
  monto_bs            Decimal                 @db.Decimal(12, 2)
  estado              compra_creditos_estado? @default(PENDIENTE)
  id_transaccion_pago String?                 @unique(map: "id_transaccion_pago") @db.VarChar(255)
  creado_en           DateTime                @default(now()) @db.DateTime(0)

  @@index([id_paquete], map: "fk_compra_paquete")
  @@index([id_usuario], map: "fk_compra_usuario")
  @@index([estado], map: "ix_compra_estado")
  @@index([creado_en], map: "ix_compra_creado_en")
}

model dimension_ambiental {
  id_dimension Int     @id @default(autoincrement())
  codigo       String  @unique(map: "codigo") @db.VarChar(30)
  nombre       String  @db.VarChar(100)
  unidad_base  String? @db.VarChar(20)
  descripcion  String? @db.VarChar(255)
}

model equivalencia_impacto {
  id_equivalencia    Int     @id @default(autoincrement())
  id_categoria       Int
  id_um              Int?
  co2_por_unidad     Decimal @db.Decimal(12, 6)
  agua_por_unidad    Decimal @db.Decimal(12, 6)
  energia_por_unidad Decimal @db.Decimal(12, 6)

  @@unique([id_categoria, id_um], map: "id_categoria")
  @@index([id_um], map: "fk_eq_um")
}

model evento_ambiental {
  id_evento              Int                     @id @default(autoincrement())
  id_usuario             Int
  id_dimension           Int
  fuente                 evento_ambiental_fuente
  id_fuente              Int
  categoria              String?                 @db.VarChar(100)
  valor                  Decimal                 @db.Decimal(18, 6)
  id_um                  Int?
  contaminacion_reducida Decimal?                @db.Decimal(18, 6)
  descripcion            String?                 @db.VarChar(255)

  @@index([id_dimension], map: "fk_ev_dimension")
  @@index([id_um], map: "fk_ev_um")
  @@index([id_usuario], map: "fk_ev_usuario")
}

model impacto_ambiental {
  id_impacto       Int     @id @default(autoincrement())
  id_usuario       Int
  id_transaccion   Int
  id_categoria     Int
  co2_ahorrado     Decimal @db.Decimal(12, 6)
  agua_ahorrada    Decimal @db.Decimal(12, 6)
  energia_ahorrada Decimal @db.Decimal(12, 6)
  id_periodo       Int

  @@index([id_transaccion], map: "fk_imp_tx")
  @@index([id_categoria], map: "ix_impa_categoria")
  @@index([id_periodo], map: "ix_impa_periodo")
  @@index([id_usuario, id_periodo], map: "ix_impa_usuario_periodo")
}

model logro {
  id_logro            Int     @id @default(autoincrement())
  id_tipo_logro       Int
  nombre              String  @db.VarChar(100)
  descripcion         String? @db.VarChar(255)
  meta_requerida      BigInt
  creditos_recompensa BigInt

  @@index([id_tipo_logro], map: "fk_logro_tipo")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model movimiento_creditos {
  id_movimiento      Int      @id @default(autoincrement())
  id_usuario         Int
  id_tipo_movimiento Int
  id_tipo_referencia Int
  cantidad           BigInt
  descripcion        String?  @db.VarChar(255)
  saldo_anterior     BigInt
  saldo_posterior    BigInt
  id_referencia      Int?
  creado_en          DateTime @default(now()) @db.DateTime(0)

  @@index([id_tipo_movimiento], map: "fk_mov_tipomov")
  @@index([id_movimiento], map: "ix_mov_creado")
  @@index([id_tipo_referencia], map: "ix_mov_tiporef")
  @@index([id_usuario, id_movimiento], map: "ix_mov_usuario")
  @@index([creado_en], map: "ix_mov_creado_en")
}

model paquete_creditos {
  id_paquete        Int     @id @default(autoincrement())
  nombre            String  @unique(map: "nombre") @db.VarChar(100)
  cantidad_creditos BigInt
  precio_bs         Decimal @db.Decimal(12, 2)
  activo            Boolean @default(true)
}

model periodo {
  id_periodo   Int       @id @default(autoincrement())
  nombre       String    @unique(map: "nombre") @db.VarChar(50)
  descripcion  String?   @db.VarChar(255)
  fecha_inicio DateTime? @db.Date
  fecha_fin    DateTime? @db.Date

  @@index([fecha_inicio, fecha_fin], map: "ix_periodo_rango")
}

model permiso {
  id_permiso  Int     @id @default(autoincrement())
  nombre      String  @unique(map: "nombre") @db.VarChar(100)
  descripcion String? @db.VarChar(255)
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model producto {
  id_producto  Int      @id @default(autoincrement())
  id_categoria Int
  nombre       String   @db.VarChar(255)
  descripcion  String?  @db.VarChar(255)
  precio       Decimal? @db.Decimal(12, 2)
  peso         Decimal? @db.Decimal(10, 2)

  @@index([id_categoria], map: "fk_producto_categoria")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model promocion {
  id_promocion       Int               @id @default(autoincrement())
  id_tipo_promocion  Int
  nombre             String            @db.VarChar(100)
  descripcion        String?           @db.VarChar(255)
  creditos_otorgados BigInt
  fecha_inicio       DateTime          @db.DateTime(0)
  fecha_fin          DateTime          @db.DateTime(0)
  estado             promocion_estado? @default(PROGRAMADA)

  @@index([id_tipo_promocion], map: "fk_promocion_tipo")
  @@index([estado, fecha_inicio, fecha_fin], map: "ix_promocion_activa")
}

model promocion_publicacion {
  id_promocion   Int
  id_publicacion Int

  @@id([id_promocion, id_publicacion])
  @@index([id_promocion], map: "ix_promopub_prom")
  @@index([id_publicacion], map: "ix_promopub_pub")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model publicacion {
  id_publicacion      Int                 @id @default(autoincrement())
  id_usuario          Int
  id_categoria        Int
  id_tipo_publicacion Int
  estado              publicacion_estado? @default(PUBLICADA)
  id_ubicacion        Int?
  titulo              String              @db.VarChar(200)
  descripcion         String              @db.Text
  valor_creditos      BigInt
  imagen_url          String?             @db.VarChar(500)
  creado_en           DateTime            @default(now()) @db.DateTime(0)

  @@index([id_tipo_publicacion], map: "fk_publicacion_tipopub")
  @@index([id_ubicacion], map: "fk_publicacion_ubicacion")
  @@index([id_categoria, estado], map: "ix_pub_categoria_estado")
  @@index([id_usuario, estado], map: "ix_pub_usuario_estado")
  @@index([creado_en], map: "ix_pub_creado_en")
  @@fulltext([titulo, descripcion], map: "ft_pub_titulo_desc")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model publicacion_producto {
  id_publicacion Int
  id_producto    Int
  cantidad       Decimal @db.Decimal(15, 4)
  id_um          Int

  @@id([id_publicacion, id_producto])
  @@index([id_producto], map: "fk_pprd_producto")
  @@index([id_um], map: "fk_pprd_um")
}

model publicacion_servicio {
  id_publicacion Int
  id_servicio    Int
  horario        String @db.VarChar(100)

  @@id([id_publicacion, id_servicio])
  @@index([id_servicio], map: "fk_pserv_servicio")
}

model publicidad {
  id_publicidad  Int                @id @default(autoincrement())
  id_usuario     Int
  id_ubicacion   Int
  estado         publicidad_estado? @default(PROGRAMADA)
  titulo         String             @db.VarChar(200)
  descripcion    String?            @db.VarChar(255)
  url_destino    String?            @db.VarChar(500)
  fecha_inicio   DateTime           @db.DateTime(0)
  fecha_fin      DateTime           @db.DateTime(0)
  costo_creditos BigInt

  @@index([id_ubicacion], map: "fk_publicidad_ubipub")
  @@index([id_usuario], map: "fk_publicidad_usuario")
}

model reporte_impacto {
  id_reporte             Int     @id @default(autoincrement())
  id_usuario             Int?
  id_tipo_reporte        Int
  id_periodo             Int
  total_co2_ahorrado     Decimal @db.Decimal(12, 6)
  total_agua_ahorrada    Decimal @db.Decimal(12, 6)
  total_energia_ahorrada Decimal @db.Decimal(12, 6)
  total_transacciones    BigInt
  total_usuarios_activos BigInt

  @@index([id_periodo], map: "fk_rep_periodo")
  @@index([id_usuario], map: "fk_rep_usuario")
  @@index([id_tipo_reporte, id_periodo, id_usuario], map: "ix_rep_unico_helper")
}

model resultado_acceso {
  id_resultado Int     @id @default(autoincrement())
  nombre       String  @unique(map: "nombre") @db.VarChar(50)
  descripcion  String? @db.VarChar(255)
}

model rol {
  id_rol      Int     @id @default(autoincrement())
  nombre      String  @unique(map: "nombre") @db.VarChar(50)
  descripcion String? @db.VarChar(255)
}

model rol_permiso {
  id_rol     Int
  id_permiso Int

  @@id([id_rol, id_permiso])
  @@index([id_permiso], map: "fk_rp_permiso")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model servicio {
  id_servicio  Int              @id @default(autoincrement())
  id_categoria Int
  estado       servicio_estado? @default(ACTIVO)
  nombre       String           @db.VarChar(255)
  descripcion  String?          @db.Text
  precio       Decimal?         @db.Decimal(12, 2)
  duracion_min Int?             @db.SmallInt

  @@index([id_categoria], map: "fk_servicio_categoria")
}

model signo_movimiento {
  id_signo Int    @id @default(autoincrement())
  nombre   String @unique(map: "nombre") @db.VarChar(20)
}

model signo_tipo_mov {
  id_tipo_movimiento Int
  id_signo           Int
  creado_en          DateTime? @db.DateTime(0)

  @@id([id_tipo_movimiento, id_signo])
  @@index([id_signo], map: "ix_sxtm_signo")
}

model tipo_actividad {
  id_tipo_actividad Int     @id @default(autoincrement())
  nombre            String  @unique(map: "nombre") @db.VarChar(100)
  descripcion       String? @db.VarChar(255)
}

model tipo_logro {
  id_tipo_logro Int     @id @default(autoincrement())
  nombre        String  @unique(map: "nombre") @db.VarChar(50)
  descripcion   String? @db.VarChar(255)
}

model tipo_movimiento {
  id_tipo_movimiento Int     @id @default(autoincrement())
  nombre             String  @unique(map: "nombre") @db.VarChar(50)
  descripcion        String? @db.VarChar(255)

  @@index([nombre], map: "ix_tipomov_nombre")
}

model tipo_promocion {
  id_tipo_promocion Int     @id @default(autoincrement())
  nombre            String  @unique(map: "nombre") @db.VarChar(50)
  descripcion       String? @db.VarChar(255)
}

model tipo_publicacion {
  id_tipo_publicacion Int     @id @default(autoincrement())
  nombre              String  @unique(map: "nombre") @db.VarChar(50)
  descripcion         String? @db.VarChar(255)
}

model tipo_referencia {
  id_tipo_referencia Int    @id @default(autoincrement())
  nombre             String @unique(map: "nombre") @db.VarChar(30)

  @@index([nombre], map: "ix_tiporef_nombre")
}

model tipo_reporte {
  id_tipo_reporte Int     @id @default(autoincrement())
  nombre          String  @unique(map: "nombre") @db.VarChar(50)
  descripcion     String? @db.VarChar(255)
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model transaccion {
  id_transaccion    Int                 @id @default(autoincrement())
  id_comprador      Int
  id_vendedor       Int
  id_publicacion    Int
  cantidad_creditos BigInt
  estado            transaccion_estado? @default(SOLICITADA)
  creado_en         DateTime            @default(now()) @db.DateTime(0)

  @@index([estado], map: "ix_trans_estado")
  @@index([id_comprador], map: "ix_tx_comprador")
  @@index([id_publicacion], map: "ix_tx_publicacion")
  @@index([id_vendedor], map: "ix_tx_vendedor")
  @@index([creado_en], map: "ix_tx_creado_en")
}

model ubicacion {
  id_ubicacion Int      @id @default(autoincrement())
  direccion    String   @db.VarChar(500)
  ciudad       String?  @db.VarChar(100)
  provincia    String?  @db.VarChar(100)
  latitud      Decimal? @db.Decimal(9, 6)
  longitud     Decimal? @db.Decimal(9, 6)
}

model ubicacion_publicidad {
  id_ubicacion Int     @id @default(autoincrement())
  nombre       String  @unique(map: "nombre") @db.VarChar(100)
  descripcion  String? @db.VarChar(255)
  precio_base  Decimal @db.Decimal(12, 2)
}

model unidad_medida {
  id_um   Int    @id @default(autoincrement())
  nombre  String @unique(map: "nombre") @db.VarChar(100)
  simbolo String @unique(map: "simbolo") @db.VarChar(20)
}

model usuario {
  id_usuario    Int            @id @default(autoincrement())
  id_rol        Int
  estado        usuario_estado @default(ACTIVO)
  nombre        String         @db.VarChar(100)
  apellido      String?        @db.VarChar(100)
  correo        String         @unique(map: "correo") @db.VarChar(255)
  password_hash String         @default("") @db.VarChar(255)
  telefono      String?        @db.VarChar(25)
  url_perfil    String?        @unique(map: "url_perfil") @db.VarChar(120)

  @@index([id_rol], map: "fk_usuario_rol")
}

model usuario_logro {
  id_usuario_logro Int     @id @default(autoincrement())
  id_usuario       Int
  id_logro         Int
  progreso_actual  BigInt? @default(0)

  @@unique([id_usuario, id_logro], map: "id_usuario")
  @@index([id_logro], map: "fk_ulogro_logro")
}

model suscripcion_premium {
  id_suscripcion Int                        @id @default(autoincrement())
  id_usuario     Int
  fecha_inicio   DateTime                   @default(now()) @db.DateTime(0)
  fecha_fin      DateTime?                  @db.DateTime(0)
  estado         suscripcion_premium_estado @default(ACTIVA)
  monto_bs       Decimal                    @db.Decimal(12, 2)

  @@index([fecha_inicio, fecha_fin], map: "ix_suscrip_fechas")
  @@index([id_usuario, estado], map: "ix_suscrip_usuario_estado")
}

enum billetera_estado {
  ACTIVA
  BLOQUEADA
  CERRADA
}

enum servicio_estado {
  ACTIVO
  PAUSADO
  INACTIVO
  ELIMINADO
}

enum usuario_estado {
  ACTIVO
  SUSPENDIDO
  BLOQUEADO
  ELIMINADO
}

enum evento_ambiental_fuente {
  PUBLICACION
  TRANSACCION
}

enum publicidad_estado {
  PROGRAMADA
  ACTIVA
  PAUSADA
  FINALIZADA
  CANCELADA
}

enum compra_creditos_estado {
  PENDIENTE
  APROBADO
  RECHAZADO
  FALLIDO
  REVERTIDO
}

enum publicacion_estado {
  BORRADOR
  PUBLICADA
  PAUSADA
  AGOTADA
  OCULTA
  ELIMINADA
}

enum transaccion_estado {
  SOLICITADA
  ACEPTADA
  RECHAZADA
  CANCELADA
  COMPLETADA
  ANULADA
}

enum promocion_estado {
  PROGRAMADA
  ACTIVA
  PAUSADA
  FINALIZADA
  CANCELADA
}

enum suscripcion_premium_estado {
  ACTIVA
  CANCELADA
  VENCIDA
}
</file>

<file path="digital-barder/backend/src/app.js">
// src/app.js

// 🔧 Parche global para que JSON.stringify soporte BigInt en todas las respuestas
if (typeof BigInt !== "undefined" && !BigInt.prototype.toJSON) {
  // eslint-disable-next-line no-extend-native
  BigInt.prototype.toJSON = function () {
    return Number(this);
  };
}

import express from "express";
import cors from "cors";
import morgan from "morgan";
import routes from "./routes/index.js";
import { errorHandler } from "./middlewares/errorHandler.js";

import path from "path";
import { fileURLToPath } from "url";

const app = express();

// -------------------------------------------------------------
// Necesario para rutas absolutas (uploads y archivos estáticos)
// -------------------------------------------------------------
const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

// -------------------------------------------------------------
// Middlewares globales
// -------------------------------------------------------------
app.use(cors());                // permitir peticiones de tu frontend
app.use(morgan("dev"));         // logs en consola
app.use(express.json());        // permite JSON en body
app.use(express.urlencoded({ extended: true })); // formularios

// -------------------------------------------------------------
// Servir archivos estáticos (subidas de imágenes)
// Ruta final: http://localhost:4000/uploads/<nombre-archivo>
// -------------------------------------------------------------
app.use(
  "/uploads",
  express.static(path.join(__dirname, "..", "uploads_storage"))
);

// -------------------------------------------------------------
// Registrar todas las rutas del backend
// -------------------------------------------------------------
app.use("/api", routes);

// -------------------------------------------------------------
// Middleware para rutas no encontradas
// -------------------------------------------------------------
app.use((req, res, next) => {
  res.status(404).json({ message: "Ruta no encontrada" });
});

// -------------------------------------------------------------
// Middleware global de manejo de errores
// (Siempre debe ir al final)
// -------------------------------------------------------------
app.use(errorHandler);

export default app;
</file>

<file path="digital-barder/backend/src/modules/auth/auth.controller.js">
import {
  registrarUsuarioService,
  loginService,
  obtenerPerfilService,
} from "./auth.service.js";

export async function registerController(req, res, next) {
  try {
    const { nombre, apellido, correo, password, telefono } = req.body;

    if (!nombre || !correo || !password) {
      return res
        .status(400)
        .json({ message: "nombre, correo y password son obligatorios" });
    }

    const usuario = await registrarUsuarioService({
      nombre,
      apellido,
      correo,
      password,
      telefono,
    });

    res.status(201).json({
      message: "Usuario registrado correctamente",
      usuario,
    });
  } catch (err) {
    next(err);
  }
}

export async function loginController(req, res, next) {
  try {
    const { correo, password } = req.body;

    if (!correo || !password) {
      return res
        .status(400)
        .json({ message: "correo y password son obligatorios" });
    }

    const result = await loginService({
      correo,
      password,
      ip: req.ip,
      userAgent: req.headers["user-agent"] || "",
    });

    res.json(result); // { token, usuario }
  } catch (err) {
    next(err);
  }
}

export async function meController(req, res, next) {
  try {
    const idUsuario = req.user.id_usuario;
    const perfil = await obtenerPerfilService(idUsuario);
    res.json(perfil);
  } catch (err) {
    next(err);
  }
}
</file>

<file path="digital-barder/backend/src/modules/auth/auth.routes.js">
import { Router } from "express";
import {
    registerController,
    loginController,
    meController,
} from "./auth.controller.js";
import { authMiddleware } from "../../middlewares/auth.js";

const router = Router();

// Registro público (rol COMPRADOR)
router.post("/register", registerController);

// Login
router.post("/login", loginController);

// Datos del usuario logueado
router.get("/me", authMiddleware, meController);

export default router;
</file>

<file path="digital-barder/backend/src/modules/intercambios/intercambios.controller.js">
import {
  crearIntercambioService,
  misComprasService,
  misVentasService,
  detalleTransaccionService,
} from "./intercambios.service.js";

export const crearIntercambioController = async (req, res, next) => {
  try {
    const idComprador = req.user.id_usuario;
    const { id_publicacion, creditos } = req.body;
    const tx = await crearIntercambioService({ idComprador, id_publicacion, creditos });
    res.status(201).json({ message: "Intercambio creado", transaccion: tx });
  } catch (e) { next(e); }
};

export const misComprasController = async (req, res, next) => {
  try { res.json(await misComprasService(req.user.id_usuario)); }
  catch (e) { next(e); }
};

export const misVentasController = async (req, res, next) => {
  try { res.json(await misVentasService(req.user.id_usuario)); }
  catch (e) { next(e); }
};

export const detalleTransaccionController = async (req, res, next) => {
  try { res.json(await detalleTransaccionService(+req.params.id)); }
  catch (e) { next(e); }
};
</file>

<file path="digital-barder/backend/src/modules/intercambios/intercambios.routes.js">
import { Router } from "express";
import { authMiddleware } from "../../middlewares/auth.js";
import {
  crearIntercambioController,
  misComprasController,
  misVentasController,
  detalleTransaccionController,
} from "./intercambios.controller.js";

const router = Router();

router.use(authMiddleware);

router.post("/", crearIntercambioController);
router.get("/mis-compras", misComprasController);
router.get("/mis-ventas", misVentasController);
router.get("/:id", detalleTransaccionController);

export default router;
</file>

<file path="digital-barder/backend/src/modules/publicaciones/publicaciones.controller.js">
import {
  listarPublicacionesService,
  obtenerPublicacionService,
  crearPublicacionProductoService,
  crearPublicacionServicioService,
  misPublicacionesService,
  buscarPublicacionesService,
  crearCalificacionService,
  listarCalificacionesService,
} from "./publicaciones.service.js";

export const listarPublicacionesController = async (req, res, next) => {
  try {
    const { categoria, estado } = req.query;
    res.json(await listarPublicacionesService({ categoria, estado }));
  } catch (e) { next(e); }
};

export const obtenerPublicacionController = async (req, res, next) => {
  try { res.json(await obtenerPublicacionService(+req.params.id)); }
  catch (e) { next(e); }
};

export const crearPublicacionProductoController = async (req, res, next) => {
  try {
    const idUsuario = req.user.id_usuario;
    const pub = await crearPublicacionProductoService(idUsuario, req.body);
    res.status(201).json(pub);
  } catch (e) { next(e); }
};

export const crearPublicacionServicioController = async (req, res, next) => {
  try {
    const idUsuario = req.user.id_usuario;
    const pub = await crearPublicacionServicioService(idUsuario, req.body);
    res.status(201).json(pub);
  } catch (e) { next(e); }
};

export const misPublicacionesController = async (req, res, next) => {
  try {
    const idUsuario = req.user.id_usuario;
    res.json(await misPublicacionesService(idUsuario));
  } catch (e) { next(e); }
};

export const buscarPublicacionesController = async (req, res, next) => {
  try { res.json(await buscarPublicacionesService(req.query.q || "")); }
  catch (e) { next(e); }
};

export const crearCalificacionController = async (req, res, next) => {
  try {
    const idUsuario = req.user.id_usuario;
    const idPublicacion = +req.params.id;
    const { estrellas, comentario } = req.body;
    const calif = await crearCalificacionService({
      idUsuario, idPublicacion, estrellas, comentario,
    });
    res.status(201).json(calif);
  } catch (e) { next(e); }
};

export const listarCalificacionesController = async (req, res, next) => {
  try {
    res.json(await listarCalificacionesService(+req.params.id));
  } catch (e) { next(e); }
};
</file>

<file path="digital-barder/backend/src/modules/publicaciones/publicaciones.routes.js">
import { Router } from "express";
import { authMiddleware } from "../../middlewares/auth.js";
import {
  listarPublicacionesController,
  obtenerPublicacionController,
  crearPublicacionProductoController,
  crearPublicacionServicioController,
  misPublicacionesController,
  buscarPublicacionesController,
  crearCalificacionController,
  listarCalificacionesController,
} from "./publicaciones.controller.js";

const router = Router();

// públicas
router.get("/", listarPublicacionesController);
router.get("/busqueda", buscarPublicacionesController);
router.get("/:id", obtenerPublicacionController);
router.get("/:id/calificaciones", listarCalificacionesController);

// protegidas
router.use(authMiddleware);

router.get("/mias/listado", misPublicacionesController);
router.post("/producto", crearPublicacionProductoController);
router.post("/servicio", crearPublicacionServicioController);
router.post("/:id/calificaciones", crearCalificacionController);

export default router;
</file>

<file path="digital-barder/backend/src/modules/wallet/wallet.controller.js">
import {
  obtenerMisCreditosService,
  obtenerMisMovimientosService,
  comprarCreditosService,
  obtenerMisComprasService,
} from "./wallet.service.js";

export async function getMisCreditosController(req, res, next) {
  try {
    const idUsuario = req.user.id_usuario;
    const data = await obtenerMisCreditosService(idUsuario);
    res.json(data);
  } catch (err) {
    next(err);
  }
}

export async function getMisMovimientosController(req, res, next) {
  try {
    const idUsuario = req.user.id_usuario;
    const data = await obtenerMisMovimientosService(idUsuario);
    res.json(data);
  } catch (err) {
    next(err);
  }
}

export async function postCompraCreditosController(req, res, next) {
  try {
    const idUsuario = req.user.id_usuario;
    const { idPaquete, idTransaccionPago } = req.body;

    if (!idPaquete) {
      return res.status(400).json({ message: "idPaquete es obligatorio" });
    }

    const billetera = await comprarCreditosService({
      idUsuario,
      idPaquete,
      idTransaccionPago: idTransaccionPago || null,
    });

    res.status(201).json({
      message: "Compra aprobada",
      billetera,
    });
  } catch (err) {
    next(err);
  }
}

export async function getMisComprasController(req, res, next) {
  try {
    const idUsuario = req.user.id_usuario;
    const compras = await obtenerMisComprasService(idUsuario);
    res.json(compras);
  } catch (err) {
    next(err);
  }
}
</file>

<file path="digital-barder/backend/src/modules/wallet/wallet.routes.js">
import { Router } from "express";
import { authMiddleware } from "../../middlewares/auth.js";
import {
  getMisCreditosController,
  getMisMovimientosController,
  postCompraCreditosController,
  getMisComprasController,
} from "./wallet.controller.js";

const router = Router();

router.use(authMiddleware);

// GET /api/wallet/mis-creditos
router.get("/mis-creditos", getMisCreditosController);

// GET /api/wallet/mis-movimientos
router.get("/mis-movimientos", getMisMovimientosController);

// POST /api/wallet/compra-creditos
router.post("/compra-creditos", postCompraCreditosController);

// GET /api/wallet/compras
router.get("/compras", getMisComprasController);

export default router;
</file>

<file path="digital-barder/backend/src/routes/index.js">
// src/routes/index.js
import { Router } from 'express';

import authRoutes from '../modules/auth/auth.routes.js';
import usuariosRoutes from '../modules/usuarios/usuarios.routes.js';
import catalogosRoutes from '../modules/catalogos/catalogos.routes.js';
import walletRoutes from '../modules/wallet/wallet.routes.js';
import publicacionesRoutes from '../modules/publicaciones/publicaciones.routes.js';
import intercambiosRoutes from '../modules/intercambios/intercambios.routes.js';
import actividadesRoutes from '../modules/actividades/actividades.routes.js';
import promocionesRoutes from '../modules/promociones/promociones.routes.js';
import publicidadRoutes from '../modules/publicidad/publicidad.routes.js';
import logrosRoutes from '../modules/logros/logros.routes.js';
import premiumRoutes from '../modules/premium/premium.routes.js';
import reportesRoutes from '../modules/reportes/reportes.routes.js';
import uploadsRoutes from '../modules/uploads/uploads.routes.js';

const router = Router();

router.use('/auth', authRoutes);
router.use('/usuarios', usuariosRoutes);
router.use('/catalogos', catalogosRoutes);
router.use('/wallet', walletRoutes);
router.use('/publicaciones', publicacionesRoutes);
router.use('/intercambios', intercambiosRoutes);
router.use('/actividades-sostenibles', actividadesRoutes);
router.use('/promociones', promocionesRoutes);
router.use('/publicidad', publicidadRoutes);
router.use('/logros', logrosRoutes);
router.use('/premium', premiumRoutes);
router.use('/reportes', reportesRoutes);
router.use('/uploads', uploadsRoutes);

export default router;
</file>

<file path="digital-barder/frontend/package.json">
{
  "name": "frontend",
  "version": "0.0.1",
  "private": true,
  "scripts": {
    "dev": "vite",
    "build": "vite build",
    "preview": "vite preview"
  },
  "dependencies": {
    "react": "^18.3.1",
    "react-dom": "^18.3.1",
    "react-router-dom": "^6.28.0",
    "recharts": "^3.4.1"
  },
  "devDependencies": {
    "@vitejs/plugin-react": "^4.3.4",
    "autoprefixer": "^10.4.20",
    "postcss": "^8.4.49",
    "tailwindcss": "^3.4.14",
    "vite": "^5.4.0"
  }
}
</file>

<file path="digital-barder/frontend/src/pages/Home.jsx">
// frontend/src/pages/Home.jsx
import React, { useEffect, useState } from "react";
import { Link } from "react-router-dom";
import { getHealth } from "../services/api.js";

export default function Home() {
  const [health, setHealth] = useState(null);
  const [error, setError] = useState("");

  useEffect(() => {
    let isMounted = true;

    getHealth()
      .then((data) => {
        if (isMounted) setHealth(data);
      })
      .catch((err) => {
        if (isMounted) setError(err.message || "Error consultando API");
      });

    return () => {
      isMounted = false;
    };
  }, []);

  return (
    <div className="space-y-4">
      {/* HEADER */}
      <section className="flex flex-col sm:flex-row justify-between gap-3 items-start sm:items-center">
        <div>
          <h2 className="text-xl font-semibold text-gray-900">
            Bienvenido al panel
          </h2>
          <p className="text-sm text-gray-500">
            Aquí irán las tarjetas de saldo, publicaciones, estadísticas, etc.
          </p>
        </div>
      </section>

      {/* TARJETAS DEL HOME */}
      <section className="grid gap-4 md:grid-cols-3">
        {/* TARJETA: ESTADO API */}
        <div className="card">
          <p className="text-xs font-medium text-gray-500 uppercase tracking-wide mb-1">
            Estado de la API
          </p>
          {error && (
            <p className="text-sm text-red-600">
              Error: <span className="font-medium">{error}</span>
            </p>
          )}
          {!error && !health && (
            <p className="text-sm text-gray-500">Verificando API…</p>
          )}
          {health && (
            <div className="space-y-1 text-sm">
              <p>
                <span className="font-medium">ok:</span>{" "}
                {String(health.ok ?? health.status ?? "desconocido")}
              </p>
              {health.env && (
                <p>
                  <span className="font-medium">Entorno:</span> {health.env}
                </p>
              )}
            </div>
          )}
        </div>

        {/* TARJETA: CRÉDITOS */}
        <div className="card">
          <p className="text-xs font-medium text-gray-500 uppercase tracking-wide mb-1">
            Créditos
          </p>
          <p className="text-sm text-gray-500">
            Aquí puedes mostrar el saldo de créditos de la billetera del
            usuario.
          </p>
        </div>

        {/* TARJETA: ACTIVIDAD RECIENTE */}
        <div className="card">
          <p className="text-xs font-medium text-gray-500 uppercase tracking-wide mb-1">
            Actividad reciente
          </p>
          <p className="text-sm text-gray-500">
            Listado de últimas publicaciones, intercambios, etc.
          </p>
        </div>
        
          <Link
            to="/backend-lab"
            className="card hover:shadow-md transition"
          >
            <p className="text-xs font-medium text-gray-500 uppercase mb-1">
              Laboratorio Backend
            </p>
            <p className="text-sm font-semibold">
              Probar todos los módulos (QA)
            </p>
            <p className="text-xs text-gray-500 mt-1">
              Registro, login, wallet, publicaciones, intercambios, actividades,
              reportes y más desde una sola pantalla.
            </p>
          </Link>

        {/* ⭐ NUEVA TARJETA: REPORTES ⭐ */}
        <div className="card flex flex-col justify-between">
          <div>
            <p className="text-xs font-medium text-gray-500 uppercase tracking-wide mb-1">
              Reportes
            </p>
            <p className="text-sm text-gray-500">
              Accede a reportes de actividad, créditos e impacto ambiental.
            </p>
          </div>

          <div className="mt-3">
            <Link
              to="/reportes"
              className="text-blue-600 hover:text-blue-800 text-sm font-medium"
            >
              Ver reportes →
            </Link>
          </div>
        </div>
      </section>
    </div>
  );
}
</file>

<file path="digital-barder/frontend/src/pages/ReportesDashboard.jsx">
import { useEffect, useState, useMemo } from "react";
import {
  getReporteUsuariosActivos,
  getReporteIngresosCreditos,
  getReporteCreditosGeneradosVsConsumidos,
  getReporteIntercambiosCategoria,
  getReportePublicacionesVsIntercambios,
  getReporteImpactoAcumulado,
} from "../services/api";

import {
  ResponsiveContainer,
  BarChart,
  Bar,
  XAxis,
  YAxis,
  CartesianGrid,
  Tooltip,
  Legend,
} from "recharts";

/* Utilidades */
function hoyISO() {
  return new Date().toISOString().slice(0, 10);
}

function hace30DiasISO() {
  const d = new Date(Date.now() - 30 * 24 * 60 * 60 * 1000);
  return d.toISOString().slice(0, 10);
}

const nf = new Intl.NumberFormat("es-BO");

export default function ReportesDashboard() {
  const [desde, setDesde] = useState(hace30DiasISO());
  const [hasta, setHasta] = useState(hoyISO());

  const [usuariosActivos, setUsuariosActivos] = useState([]);
  const [ingresos, setIngresos] = useState([]);
  const [intercambiosCat, setIntercambiosCat] = useState([]);
  const [pubVsInt, setPubVsInt] = useState([]);
  const [credResumen, setCredResumen] = useState(null);
  const [impacto, setImpacto] = useState([]);

  const [tipoReporte, setTipoReporte] = useState("2"); // mensual
  const [idPeriodo, setIdPeriodo] = useState("1");

  const [loading, setLoading] = useState(false);
  const [loadingImpacto, setLoadingImpacto] = useState(false);
  const [error, setError] = useState("");

/*     Carga de datos*/

  async function cargarDatosBasicos() {
    try {
      setLoading(true);
      setError("");

      const [activos, ing, cgvc, interc, pubInt] = await Promise.all([
        getReporteUsuariosActivos({ desde, hasta }),
        getReporteIngresosCreditos({ desde, hasta }),
        getReporteCreditosGeneradosVsConsumidos({ desde, hasta }),
        getReporteIntercambiosCategoria({ desde, hasta }),
        getReportePublicacionesVsIntercambios({ desde, hasta }),
      ]);

      setUsuariosActivos(Array.isArray(activos) ? activos : []);
      setIngresos(Array.isArray(ing) ? ing : []);
      setIntercambiosCat(Array.isArray(interc) ? interc : []);
      setPubVsInt(Array.isArray(pubInt) ? pubInt : []);
      setCredResumen(cgvc || null);
    } catch (e) {
      console.error(e);
      setError("Error cargando datos de reportes");
      setUsuariosActivos([]);
      setIngresos([]);
      setIntercambiosCat([]);
      setPubVsInt([]);
      setCredResumen(null);
    } finally {
      setLoading(false);
    }
  }

  async function cargarImpacto() {
    try {
      setLoadingImpacto(true);
      setError("");

      const datos = await getReporteImpactoAcumulado({
        idTipoReporte: tipoReporte,
        idPeriodo,
      });

      setImpacto(Array.isArray(datos) ? datos : []);
    } catch (e) {
      console.error(e);
      setError("Error cargando impacto ambiental");
      setImpacto([]);
    } finally {
      setLoadingImpacto(false);
    }
  }

  function onSubmitRango(e) {
    e.preventDefault();
    cargarDatosBasicos();
  }

  useEffect(() => {
    cargarDatosBasicos();
  }, []);

  /* Datos preparados para gráficos */

  // Ingresos por día
  const ingresosChartData = useMemo(
    () =>
      ingresos.map((r) => ({
        fecha: r.fecha?.slice(0, 10) || "",
        total_bs: Number(r.total_bs ?? 0),
        total_creditos: Number(r.total_creditos ?? 0),
      })),
    [ingresos]
  );

  // Intercambios por categoría
  const intercambiosChartData = useMemo(
    () =>
      intercambiosCat.map((c) => ({
        categoria: c.categoria,
        total_intercambios: Number(c.total_intercambios ?? 0),
      })),
    [intercambiosCat]
  );

  // Publicaciones vs intercambios
  const pubVsIntChartData = useMemo(
    () =>
      pubVsInt.map((p) => ({
        categoria: p.categoria,
        publicaciones: Number(p.publicaciones ?? 0),
        intercambios: Number(p.intercambios ?? 0),
      })),
    [pubVsInt]
  );

  // Créditos generados/consumidos/saldo
  const credChartData = useMemo(() => {
    if (!credResumen) return [];
    return [
      {
        nombre: "Generados",
        valor: Number(credResumen.creditos_generados ?? 0),
      },
      {
        nombre: "Consumidos",
        valor: Number(credResumen.creditos_consumidos ?? 0),
      },
      {
        nombre: "Saldo neto",
        valor: Number(credResumen.saldo_neto ?? 0),
      },
    ];
  }, [credResumen]);

  // Impacto ambiental por usuario
  const impactoChartData = useMemo(
    () =>
      impacto.map((r) => ({
        usuario: r.id_usuario ?? "GLOBAL",
        co2: Number(r.total_co2_ahorrado ?? 0),
        agua: Number(r.total_agua_ahorrada ?? 0),
        energia: Number(r.total_energia_ahorrada ?? 0),
      })),
    [impacto]
  );

  return (
    <div className="min-h-screen bg-slate-100 px-4 py-6 lg:px-8">
      {/* HEADER */}
      <header className="mb-6 flex flex-col gap-4 border-b border-slate-200 pb-4 md:flex-row md:items-end md:justify-between">
        <div>
          <h1 className="text-2xl font-semibold text-slate-900">
            Dashboard de reportes
          </h1>
          <p className="mt-1 text-sm text-slate-500">
            Actividad del sistema, créditos e impacto ambiental.
          </p>
          <p className="mt-1 text-xs text-slate-400">
            Rango seleccionado:{" "}
            <span className="font-medium text-slate-600">{desde}</span> –{" "}
            <span className="font-medium text-slate-600">{hasta}</span>
          </p>
        </div>

        <form
          onSubmit={onSubmitRango}
          className="flex flex-wrap items-end gap-3 rounded-lg bg-white px-4 py-3 shadow-sm"
        >
          <div className="flex flex-col text-xs">
            <label className="mb-1 font-medium text-slate-600">Desde</label>
            <input
              type="date"
              value={desde}
              onChange={(e) => setDesde(e.target.value)}
              className="rounded-md border border-slate-300 px-2 py-1 text-sm focus:border-emerald-500 focus:outline-none focus:ring-1 focus:ring-emerald-500"
            />
          </div>

          <div className="flex flex-col text-xs">
            <label className="mb-1 font-medium text-slate-600">Hasta</label>
            <input
              type="date"
              value={hasta}
              onChange={(e) => setHasta(e.target.value)}
              className="rounded-md border border-slate-300 px-2 py-1 text-sm focus:border-emerald-500 focus:outline-none focus:ring-1 focus:ring-emerald-500"
            />
          </div>

          <button
            type="submit"
            className="inline-flex items-center rounded-md bg-emerald-600 px-3 py-1.5 text-sm font-medium text-white shadow-sm hover:bg-emerald-700 focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:ring-offset-1"
          >
            {loading ? "Cargando…" : "Actualizar datos"}
          </button>
        </form>
      </header>

      {error && (
        <div className="mb-4 rounded-md border border-red-200 bg-red-50 px-3 py-2 text-sm text-red-700">
          {error}
        </div>
      )}

      {/* 1) RESUMEN RÁPIDO */}
      <section className="mb-6 space-y-2">
        <h2 className="text-sm font-semibold text-slate-800">
          Resumen general
        </h2>
        <div className="grid gap-4 text-sm md:grid-cols-3">
          <div className="rounded-lg border border-slate-200 bg-white p-4 shadow-sm">
            <p className="text-xs font-medium uppercase tracking-wide text-slate-500">
              Usuarios activos
            </p>
            <p className="mt-2 text-3xl font-semibold text-slate-900">
              {nf.format(usuariosActivos.length)}
            </p>
            <p className="mt-2 text-xs text-slate-500">
              Usuarios con actividad en el rango.
            </p>
          </div>

          <div className="rounded-lg border border-slate-200 bg-white p-4 shadow-sm">
            <p className="text-xs font-medium uppercase tracking-wide text-slate-500">
              Días con ingresos
            </p>
            <p className="mt-2 text-3xl font-semibold text-slate-900">
              {nf.format(ingresosChartData.length)}
            </p>
            <p className="mt-2 text-xs text-slate-500">
              Días con ventas de créditos registradas.
            </p>
          </div>

          <div className="rounded-lg border border-slate-200 bg-white p-4 shadow-sm">
            <p className="text-xs font-medium uppercase tracking-wide text-slate-500">
              Categorías con intercambios
            </p>
            <p className="mt-2 text-3xl font-semibold text-slate-900">
              {nf.format(intercambiosChartData.length)}
            </p>
            <p className="mt-2 text-xs text-slate-500">
              Categorías en las que hubo al menos un intercambio.
            </p>
          </div>
        </div>
      </section>

      {/* 2) INGRESOS POR DÍA */}
      <section className="mb-6 space-y-2">
        <div>
          <h2 className="text-sm font-semibold text-slate-800">
            Ingresos por venta de créditos
          </h2>
          <p className="text-xs text-slate-500">
            Monto total diario en bolivianos.
          </p>
        </div>

        <div className="h-80 w-full rounded-lg border border-slate-200 bg-white p-4 shadow-sm">
          {ingresosChartData.length > 0 ? (
            <ResponsiveContainer width="100%" height="100%">
              <BarChart
                data={ingresosChartData}
                margin={{ top: 12, right: 16, left: 0, bottom: 8 }}
              >
                <CartesianGrid strokeDasharray="3 3" stroke="#e5e7eb" />
                <XAxis
                  dataKey="fecha"
                  tick={{ fontSize: 11, fill: "#6b7280" }}
                  tickLine={false}
                />
                <YAxis
                  tick={{ fontSize: 11, fill: "#6b7280" }}
                  tickLine={false}
                />
                <Tooltip />
                <Legend />
                <Bar
                  dataKey="total_bs"
                  name="Monto (Bs)"
                  fill="#22c55e"
                  radius={[6, 6, 0, 0]}
                  barSize={30}
                />
              </BarChart>
            </ResponsiveContainer>
          ) : (
            <div className="flex h-full w-full items-center justify-center text-xs text-slate-400">
              Sin datos de ingresos en el rango.
            </div>
          )}
        </div>
      </section>

      {/* 3) CRÉDITOS GENERADOS / CONSUMIDOS */}
      <section className="mb-6 space-y-2">
        <div>
          <h2 className="text-sm font-semibold text-slate-800">
            Créditos generados vs consumidos
          </h2>
          <p className="text-xs text-slate-500">
            Resumen global de créditos y saldo neto.
          </p>
        </div>

        <div className="h-80 w-full rounded-lg border border-slate-200 bg-white p-4 shadow-sm">
          {credChartData.length > 0 ? (
            <ResponsiveContainer width="100%" height="100%">
              <BarChart
                data={credChartData}
                margin={{ top: 12, right: 16, left: 0, bottom: 8 }}
              >
                <CartesianGrid strokeDasharray="3 3" stroke="#e5e7eb" />
                <XAxis
                  dataKey="nombre"
                  tick={{ fontSize: 11, fill: "#6b7280" }}
                  tickLine={false}
                />
                <YAxis
                  tick={{ fontSize: 11, fill: "#6b7280" }}
                  tickLine={false}
                />
                <Tooltip />
                <Bar
                  dataKey="valor"
                  name="Créditos"
                  fill="#22c55e"
                  radius={[6, 6, 0, 0]}
                  barSize={40}
                />
              </BarChart>
            </ResponsiveContainer>
          ) : (
            <div className="flex h-full w-full items-center justify-center text-xs text-slate-400">
              Sin datos de créditos para el rango.
            </div>
          )}
        </div>
      </section>

      {/* 4) INTERCAMBIOS POR CATEGORÍA */}
      <section className="mb-6 space-y-2">
        <div>
          <h2 className="text-sm font-semibold text-slate-800">
            Intercambios por categoría
          </h2>
          <p className="text-xs text-slate-500">
            Total de intercambios registrados por categoría.
          </p>
        </div>

        <div className="h-80 w-full rounded-lg border border-slate-200 bg-white p-4 shadow-sm">
          {intercambiosChartData.length > 0 ? (
            <ResponsiveContainer width="100%" height="100%">
              <BarChart
                data={intercambiosChartData}
                margin={{ top: 12, right: 16, left: 0, bottom: 40 }}
              >
                <CartesianGrid strokeDasharray="3 3" stroke="#e5e7eb" />
                <XAxis
                  dataKey="categoria"
                  tick={{ fontSize: 10, fill: "#6b7280" }}
                  tickLine={false}
                  interval={0}
                  angle={-20}
                  textAnchor="end"
                  height={50}
                />
                <YAxis
                  tick={{ fontSize: 11, fill: "#6b7280" }}
                  tickLine={false}
                />
                <Tooltip />
                <Bar
                  dataKey="total_intercambios"
                  name="Intercambios"
                  fill="#22c55e"
                  radius={[6, 6, 0, 0]}
                  barSize={30}
                />
              </BarChart>
            </ResponsiveContainer>
          ) : (
            <div className="flex h-full w-full items-center justify-center text-xs text-slate-400">
              No hay intercambios en el rango.
            </div>
          )}
        </div>
      </section>

      {/* 5) PUBLICACIONES VS INTERCAMBIOS */}
      <section className="mb-6 space-y-2">
        <div>
          <h2 className="text-sm font-semibold text-slate-800">
            Publicaciones vs intercambios
          </h2>
          <p className="text-xs text-slate-500">
            Comparación por categoría entre publicaciones e intercambios.
          </p>
        </div>

        <div className="h-80 w-full rounded-lg border border-slate-200 bg-white p-4 shadow-sm">
          {pubVsIntChartData.length > 0 ? (
            <ResponsiveContainer width="100%" height="100%">
              <BarChart
                data={pubVsIntChartData}
                margin={{ top: 12, right: 16, left: 0, bottom: 40 }}
              >
                <CartesianGrid strokeDasharray="3 3" stroke="#e5e7eb" />
                <XAxis
                  dataKey="categoria"
                  tick={{ fontSize: 10, fill: "#6b7280" }}
                  tickLine={false}
                  interval={0}
                  angle={-20}
                  textAnchor="end"
                  height={50}
                />
                <YAxis
                  tick={{ fontSize: 11, fill: "#6b7280" }}
                  tickLine={false}
                />
                <Tooltip />
                <Legend />
                <Bar
                  dataKey="publicaciones"
                  name="Publicaciones"
                  fill="#22c55e"
                  radius={[6, 6, 0, 0]}
                  barSize={26}
                />
                <Bar
                  dataKey="intercambios"
                  name="Intercambios"
                  fill="#16a34a"
                  radius={[6, 6, 0, 0]}
                  barSize={26}
                />
              </BarChart>
            </ResponsiveContainer>
          ) : (
            <div className="flex h-full w-full items-center justify-center text-xs text-slate-400">
              Sin datos de publicaciones/intercambios.
            </div>
          )}
        </div>
      </section>

      {/* 6) IMPACTO AMBIENTAL */}
      <section className="mb-2 space-y-3">
        <div className="flex flex-col gap-3 md:flex-row md:items-end md:justify-between">
          <div>
            <h2 className="text-sm font-semibold text-slate-800">
              Impacto ambiental acumulado
            </h2>
            <p className="text-xs text-slate-500">
              CO₂ ahorrado por usuario según el período seleccionado.
            </p>
          </div>

          <div className="flex flex-wrap items-end gap-3 rounded-lg bg-white px-4 py-3 text-sm shadow-sm">
            <div className="flex flex-col">
              <label className="mb-1 text-xs font-medium text-slate-600">
                Tipo de período
              </label>
              <select
                value={tipoReporte}
                onChange={(e) => setTipoReporte(e.target.value)}
                className="w-32 rounded-md border border-slate-300 px-2 py-1 text-sm focus:border-emerald-500 focus:outline-none focus:ring-1 focus:ring-emerald-500"
              >
                <option value="1">Diario</option>
                <option value="2">Mensual</option>
                <option value="3">Anual</option>
              </select>
            </div>

            <div className="flex flex-col">
              <label className="mb-1 text-xs font-medium text-slate-600">
                ID período
              </label>
              <input
                type="number"
                min="1"
                value={idPeriodo}
                onChange={(e) => setIdPeriodo(e.target.value)}
                className="w-24 rounded-md border border-slate-300 px-2 py-1 text-sm focus:border-emerald-500 focus:outline-none focus:ring-1 focus:ring-emerald-500"
              />
            </div>

            <button
              type="button"
              onClick={cargarImpacto}
              className="inline-flex items-center rounded-md bg-emerald-600 px-3 py-1.5 text-sm font-medium text-white shadow-sm hover:bg-emerald-700 focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:ring-offset-1"
            >
              {loadingImpacto ? "Cargando…" : "Actualizar"}
            </button>
          </div>
        </div>

        <div className="h-80 w-full rounded-lg border border-slate-200 bg-white p-4 shadow-sm">
          {impactoChartData.length > 0 ? (
            <ResponsiveContainer width="100%" height="100%">
              <BarChart
                data={impactoChartData}
                margin={{ top: 12, right: 16, left: 0, bottom: 8 }}
              >
                <CartesianGrid strokeDasharray="3 3" stroke="#e5e7eb" />
                <XAxis
                  dataKey="usuario"
                  tick={{ fontSize: 10, fill: "#6b7280" }}
                  tickLine={false}
                />
                <YAxis
                  tick={{ fontSize: 11, fill: "#6b7280" }}
                  tickLine={false}
                />
                <Tooltip />
                <Legend />
                <Bar
                  dataKey="co2"
                  name="CO₂ (kg)"
                  fill="#22c55e"
                  radius={[6, 6, 0, 0]}
                  barSize={30}
                />
                
                <Bar dataKey="agua" name="Agua (L)" fill="#0ea5e9" radius={[6,6,0,0]} />
                <Bar dataKey="energia" name="Energía (kWh)" fill="#eab308" radius={[6,6,0,0]} />
                
              </BarChart>
            </ResponsiveContainer>
          ) : (
            <div className="flex h-full w-full items-center justify-center text-xs text-slate-400">
              Sin datos de impacto para ese período.
            </div>
          )}
        </div>
      </section>
    </div>
  );
}
</file>

<file path="digital-barder/frontend/src/router.jsx">
// frontend/src/router.jsx
import React from "react";
import { Routes, Route, Navigate } from "react-router-dom";
import ProtectedRoute from "./components/ProtectedRoute.jsx";
import Layout from "./components/Layout.jsx";

// Páginas base
import Login from "./pages/Login.jsx";
import Register from "./pages/Register.jsx";
import Home from "./pages/Home.jsx";
import NotFound from "./pages/NotFound.jsx";

// Índice de reportes + botón a dashboard
import Reportes from "./pages/Reportes.jsx";

// Dashboard con gráficas (ya lo tienes creado)
import ReportesDashboard from "./pages/ReportesDashboard.jsx";

// Páginas individuales de reportes (tablas)
import ReportesUsuarios from "./pages/ReportesUsuarios.jsx";
import ReportesIngresosCreditos from "./pages/ReportesIngresosCreditos.jsx";
import ReportesCreditosGeneradosConsumidos from "./pages/ReportesCreditosGeneradosConsumidos.jsx";
import ReportesIntercambiosCategoria from "./pages/ReportesIntercambiosCategoria.jsx";
import ReportesPublicacionesVsIntercambios from "./pages/ReportesPublicacionesVsIntercambios.jsx";
import ReportesImpactoAcumulado from "./pages/ReportesImpactoAcumulado.jsx";

import ReportesRankingUsuarios from "./pages/ReportesRankingUsuarios.jsx";
import ReportesUsuariosPremium from "./pages/ReportesUsuariosPremium.jsx";
import ReportesSaldosUsuarios from "./pages/ReportesSaldosUsuarios.jsx";
import ReportesActividadesSostenibles from "./pages/ReportesActividadesSostenibles.jsx";
import ReportesImpactoCategoria from "./pages/ReportesImpactoCategoria.jsx";

import BackendLab from "./pages/BackendLab.jsx";

export default function AppRouter() {
  return (
    <Routes>
      {/* Ruta raíz → /home */}
      <Route path="/" element={<Navigate to="/home" replace />} />

      {/* Login público */}
      <Route path="/login" element={<Login />} />

      {/* Home protegido */}
      <Route
        path="/home"
        element={
          <ProtectedRoute>
            <Layout>
              <Home />
            </Layout>
          </ProtectedRoute>
        }
      />

      {/* Índice de reportes (lista de tarjetas + botón al dashboard) */}
      <Route
        path="/reportes"
        element={
          <ProtectedRoute>
            <Layout>
              <Reportes />
            </Layout>
          </ProtectedRoute>
        }
      />

      {/* Páginas individuales de reportes (tablas) */}
      <Route
        path="/reportes/usuarios"
        element={
          <ProtectedRoute>
            <Layout>
              <ReportesUsuarios />
            </Layout>
          </ProtectedRoute>
        }
      />

      <Route
        path="/reportes/ingresos-creditos"
        element={
          <ProtectedRoute>
            <Layout>
              <ReportesIngresosCreditos />
            </Layout>
          </ProtectedRoute>
        }
      />

      <Route
        path="/reportes/creditos-generados-consumidos"
        element={
          <ProtectedRoute>
            <Layout>
              <ReportesCreditosGeneradosConsumidos />
            </Layout>
          </ProtectedRoute>
        }
      />

      <Route
        path="/reportes/intercambios-categoria"
        element={
          <ProtectedRoute>
            <Layout>
              <ReportesIntercambiosCategoria />
            </Layout>
          </ProtectedRoute>
        }
      />

      <Route
        path="/reportes/publicaciones-intercambios"
        element={
          <ProtectedRoute>
            <Layout>
              <ReportesPublicacionesVsIntercambios />
            </Layout>
          </ProtectedRoute>
        }
      />

      <Route
        path="/reportes/impacto-acumulado"
        element={
          <ProtectedRoute>
            <Layout>
              <ReportesImpactoAcumulado />
            </Layout>
          </ProtectedRoute>
        }
      />

      <Route
        path="/reportes/ranking-usuarios"
        element={
          <ProtectedRoute>
            <Layout>
              <ReportesRankingUsuarios />
            </Layout>
          </ProtectedRoute>
        }
      />

      <Route
        path="/reportes/usuarios-premium"
        element={
          <ProtectedRoute>
            <Layout>
              <ReportesUsuariosPremium />
            </Layout>
          </ProtectedRoute>
        }
      />

      <Route
        path="/reportes/saldos-usuarios"
        element={
          <ProtectedRoute>
            <Layout>
              <ReportesSaldosUsuarios />
            </Layout>
          </ProtectedRoute>
        }
      />

      <Route
        path="/reportes/actividades-sostenibles"
        element={
          <ProtectedRoute>
            <Layout>
              <ReportesActividadesSostenibles />
            </Layout>
          </ProtectedRoute>
        }
      />

      <Route
        path="/reportes/impacto-categoria"
        element={
          <ProtectedRoute>
            <Layout>
              <ReportesImpactoCategoria />
            </Layout>
          </ProtectedRoute>
        }
      />

      {/* Dashboard con gráficos de reportes */}
      <Route
        path="/reportes-dashboard"
        element={
          <ProtectedRoute>
            <Layout>
              <ReportesDashboard />
            </Layout>
          </ProtectedRoute>
        }
      />

      <Route
        path="/backend-lab"
        element={
          <ProtectedRoute>
            <Layout>
              <BackendLab />
            </Layout>
          </ProtectedRoute>
        }
      />

      {/* 404 */}
      <Route path="*" element={<NotFound />} />
    </Routes>
  );
}
</file>

<file path="digital-barder/backend/src/middlewares/errorHandler.js">
// src/middlewares/errorHandler.js

// Middleware de manejo global de errores (SIEMPRE 4 parámetros)
export function errorHandler(err, req, res, next) {
  console.error("❌ Error:", err);

  // Si ya se empezó a enviar la respuesta, delega a Express
  if (res.headersSent) {
    return next(err);
  }

  const status = err.status || err.statusCode || 500;
  const message =
    err.message || "Ocurrió un error inesperado en el servidor";

  const response = { message };

  // En desarrollo podemos enviar más detalles
  if (process.env.NODE_ENV !== "production") {
    response.stack = err.stack;
    if (err.code) response.code = err.code;
  }

  res.status(status).json(response);
}
</file>

<file path="digital-barder/backend/src/modules/reportes/reportes.routes.js">
import { Router } from "express";
import { authMiddleware } from "../../middlewares/auth.js";
import { isAdmin } from "../../middlewares/isAdmin.js";
import {
  repUsuariosActivosController,
  repUsuariosAbandonadosController,
  repIngresosCreditosController,
  repCreditosGenConsController,
  repIntercambiosCategoriaController,
  repPublicacionesVsIntercambiosController,
  repImpactoAcumuladoController,
  rankingUsuariosController,
} from "./reportes.controller.js";

const router = Router();

router.use(authMiddleware, isAdmin);

router.get("/usuarios-activos", repUsuariosActivosController);
router.get("/usuarios-abandonados", repUsuariosAbandonadosController);
router.get("/ingresos-creditos", repIngresosCreditosController);
router.get("/creditos-generados-consumidos", repCreditosGenConsController);
router.get("/intercambios-categoria", repIntercambiosCategoriaController);
router.get("/publicaciones-intercambios", repPublicacionesVsIntercambiosController);
router.get("/impacto-acumulado", repImpactoAcumuladoController);
router.get("/ranking-usuarios", rankingUsuariosController);

export default router;
</file>

<file path="digital-barder/frontend/src/pages/Reportes.jsx">
// frontend/src/pages/Reportes.jsx
import { Link } from "react-router-dom";

const reportesList = [
  {
    path: "/reportes/usuarios",
    title: "Usuarios activos y abandonados",
    description: "Quiénes están usando la plataforma y quiénes no.",
  },
  {
    path: "/reportes/ingresos-creditos",
    title: "Ingresos por venta de créditos",
    description: "Créditos vendidos e ingresos en bolivianos.",
  },
  {
    path: "/reportes/creditos-generados-consumidos",
    title: "Créditos generados vs consumidos",
    description: "Balance global de créditos generados y consumidos.",
  },
  {
    path: "/reportes/intercambios-categoria",
    title: "Intercambios por categoría",
    description: "Qué categorías tienen más movimiento en los intercambios.",
  },
  {
    path: "/reportes/publicaciones-intercambios",
    title: "Publicaciones vs intercambios",
    description: "Relación entre lo publicado y lo que realmente se intercambia.",
  },
  {
    path: "/reportes/impacto-acumulado",
    title: "Impacto ambiental acumulado",
    description: "CO₂, agua y energía ahorrados en un período.",
  },
  {
    path: "/reportes/ranking-usuarios",
    title: "Ranking de usuarios por impacto",
    description: "Top de usuarios según su impacto ambiental.",
  },
  {
    path: "/reportes/usuarios-premium",
    title: "Usuarios Premium",
    description: "Adopción, actividad e ingresos por suscripciones premium.",
  },
  {
    path: "/reportes/saldos-usuarios",
    title: "Saldos de créditos por usuario",
    description: "Créditos disponibles actualmente en las billeteras.",
  },
  {
    path: "/reportes/actividades-sostenibles",
    title: "Actividades sostenibles",
    description: "Acciones ecológicas registradas por los usuarios.",
  },
  {
    path: "/reportes/impacto-categoria",
    title: "Impacto ambiental por categoría",
    description: "Impacto ecológico agrupado por categoría de publicación.",
  },
];

export default function Reportes() {
  return (
    <div className="p-4 space-y-6">
      {/* Header */}
      <header className="flex flex-col gap-3 md:flex-row md:items-center md:justify-between">
        <div>
          <h1 className="text-2xl font-bold">Reportes</h1>
          <p className="text-sm text-gray-500">
            Explora los reportes disponibles o abre el dashboard completo.
          </p>
        </div>

        <Link
          to="/reportes-dashboard"
          className="inline-flex items-center justify-center bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded text-sm font-medium transition"
        >
          Ver dashboard completo
        </Link>
      </header>

      {/* Tarjetas de reportes */}
      <section className="grid gap-4 md:grid-cols-2 xl:grid-cols-3">
        {reportesList.map((rep, idx) => (
          <div
            key={idx}
            className="border rounded-lg p-4 bg-white shadow-sm flex flex-col justify-between hover:shadow-md transition"
          >
            <div>
              <h2 className="font-semibold text-lg mb-1">{rep.title}</h2>
              <p className="text-sm text-gray-500 mb-3">{rep.description}</p>
            </div>

            <div className="flex justify-end">
              <Link
                to={rep.path}
                className="text-blue-600 hover:text-blue-800 text-sm font-medium"
              >
                Ver detalle →
              </Link>
            </div>
          </div>
        ))}
      </section>
    </div>
  );
}
</file>

<file path="digital-barder/frontend/src/services/api.js">
// frontend/src/services/api.js
const API_URL = import.meta.env.VITE_API_URL ?? "http://localhost:4000/api";

function authHeaders() {
  const token = localStorage.getItem("token");
  if (!token) return {};
  return {
    Authorization: `Bearer ${token}`,
  };
}

export async function api(path, { method = "GET", body, headers = {} } = {}) {
  const isJsonBody = body && !(body instanceof FormData);

  const res = await fetch(`${API_URL}${path}`, {
    method,
    headers: {
      ...(isJsonBody ? { "Content-Type": "application/json" } : {}),
      ...authHeaders(),
      ...headers,
    },
    body: isJsonBody ? JSON.stringify(body) : body,
  });

  const text = await res.text();

  if (!res.ok) {
    let message =
      res.statusText || `Error HTTP ${res.status}` || "Error en la solicitud";

    if (text) {
      try {
        const parsed = JSON.parse(text);
        if (parsed && parsed.message) {
          message = parsed.message;
        }
      } catch {
        message = text;
      }
    }

    throw new Error(message);
  }

  if (!text) {
    return null;
  }

  try {
    return JSON.parse(text);
  } catch {
    console.warn("Respuesta no JSON para", path, "=>", text);
    return text;
  }
}

export async function login({ correo, password }) {
  const data = await api("/auth/login", {
    method: "POST",
    body: { correo, password },
  });

  if (data?.token) {
    localStorage.setItem("token", data.token);
    if (data.usuario) {
      localStorage.setItem("usuario", JSON.stringify(data.usuario));
    }
  }

  return data;
}

export function logout() {
  localStorage.removeItem("token");
  localStorage.removeItem("usuario");
}

export async function getHealth() {
  return api("/health");
}

function buildRangeQuery(desde, hasta) {
  const params = new URLSearchParams();
  if (desde) params.append("desde", desde);
  if (hasta) params.append("hasta", hasta);
  const qs = params.toString();
  return qs ? `?${qs}` : "";
}

export async function register({ nombre, apellido, correo, password, telefono }) {
  return api("/auth/register", {
    method: "POST",
    body: { nombre, apellido, correo, password, telefono },
  });
}

//REPORTES

// Usuarios activos
export function getReporteUsuariosActivos({ desde, hasta } = {}) {
  return api(`/reportes/usuarios-activos${buildRangeQuery(desde, hasta)}`);
}

// Usuarios abandonados
export function getReporteUsuariosAbandonados({ desde, hasta } = {}) {
  return api(`/reportes/usuarios-abandonados${buildRangeQuery(desde, hasta)}`);
}

// Ingresos por venta de créditos
export function getReporteIngresosCreditos({ desde, hasta } = {}) {
  return api(`/reportes/ingresos-creditos${buildRangeQuery(desde, hasta)}`);
}

// Créditos generados vs consumidos
export function getReporteCreditosGeneradosVsConsumidos({ desde, hasta } = {}) {
  return api(
    `/reportes/creditos-generados-consumidos${buildRangeQuery(desde, hasta)}`
  );
}

// Intercambios por categoría
export function getReporteIntercambiosCategoria({ desde, hasta } = {}) {
  return api(
    `/reportes/intercambios-categoria${buildRangeQuery(desde, hasta)}`
  );
}

// Publicaciones vs intercambios
export function getReportePublicacionesVsIntercambios({ desde, hasta } = {}) {
  return api(
    `/reportes/publicaciones-vs-intercambios${buildRangeQuery(desde, hasta)}`
  );
}

// Impacto acumulado (REPORTE_IMPACTO)
export function getReporteImpactoAcumulado({ idTipoReporte, idPeriodo }) {
  const params = new URLSearchParams();
  if (idTipoReporte != null) params.append("idTipoReporte", idTipoReporte);
  if (idPeriodo != null) params.append("idPeriodo", idPeriodo);
  const qs = params.toString();
  return api(`/reportes/impacto-acumulado?${qs}`);
}

//REPORTES 

// Ranking de usuarios por impacto
export function getReporteRankingUsuarios({ idPeriodo = null, limit = 10 } = {}) {
  const params = new URLSearchParams();
  if (idPeriodo != null && idPeriodo !== "") {
    params.append("idPeriodo", idPeriodo);
  }
  if (limit != null) {
    params.append("limit", String(limit));
  }
  const qs = params.toString();
  return api(`/reportes/ranking-usuarios?${qs}`);
}

// Usuarios premium
export function getReporteUsuariosPremium({ desde, hasta } = {}) {
  return api(`/reportes/usuarios-premium${buildRangeQuery(desde, hasta)}`);
}

// Usuarios nuevos (primer login)
export function getReporteUsuariosNuevos({ desde, hasta } = {}) {
  return api(`/reportes/usuarios-nuevos${buildRangeQuery(desde, hasta)}`);
}

// Saldos de créditos por usuario (top N)
export function getReporteSaldosUsuarios({ limit = 20 } = {}) {
  const params = new URLSearchParams();
  params.append("limit", String(limit));
  const qs = params.toString();
  return api(`/reportes/saldos-usuarios?${qs}`);
}

// Actividades sostenibles por usuario
export function getReporteActividadesSostenibles({ desde, hasta } = {}) {
  return api(
    `/reportes/actividades-sostenibles${buildRangeQuery(desde, hasta)}`
  );
}

// Impacto ambiental por categoría
export function getReporteImpactoPorCategoria({ idPeriodo }) {
  const params = new URLSearchParams();
  if (idPeriodo != null) params.append("idPeriodo", idPeriodo);
  const qs = params.toString();
  return api(`/reportes/impacto-categoria?${qs}`);
}
</file>

<file path="digital-barder/backend/src/modules/reportes/reportes.controller.js">
// src/modules/reportes/reportes.controller.js
import {
  repUsuariosActivosService,
  repUsuariosAbandonadosService,
  repIngresosCreditosService,
  repCreditosGenConsService,
  repIntercambiosCategoriaService,
  repPublicacionesVsIntercambiosService,
  repImpactoAcumuladoService,
  rankingUsuariosService,
} from "./reportes.service.js";

/**
 * Helper para convertir BigInt / Date / Decimal a tipos serializables
 */
function toPlain(value) {
  if (typeof value === "bigint") return Number(value);

  if (value instanceof Date) {
    return value.toISOString().slice(0, 19).replace("T", " ");
  }

  if (value && typeof value === "object") {
    if (typeof value.toNumber === "function") return value.toNumber();

    const prim = value.valueOf?.();
    if (prim != null && typeof prim !== "object") return prim;

    if (Array.isArray(value)) return value.map((v) => toPlain(v));

    const out = {};
    for (const [k, v] of Object.entries(value)) {
      out[k] = toPlain(v);
    }
    return out;
  }

  return value;
}

function rango(req) {
  return { desde: req.query.desde, hasta: req.query.hasta };
}

export const repUsuariosActivosController = async (req, res, next) => {
  try {
    const data = await repUsuariosActivosService(rango(req));
    res.json(toPlain(data));
  } catch (e) {
    next(e);
  }
};

export const repUsuariosAbandonadosController = async (req, res, next) => {
  try {
    const data = await repUsuariosAbandonadosService(rango(req));
    res.json(toPlain(data));
  } catch (e) {
    next(e);
  }
};

export const repIngresosCreditosController = async (req, res, next) => {
  try {
    const data = await repIngresosCreditosService(rango(req));
    res.json(toPlain(data));
  } catch (e) {
    next(e);
  }
};

export const repCreditosGenConsController = async (req, res, next) => {
  try {
    const data = await repCreditosGenConsService(rango(req));
    res.json(toPlain(data));
  } catch (e) {
    next(e);
  }
};

export const repIntercambiosCategoriaController = async (req, res, next) => {
  try {
    const data = await repIntercambiosCategoriaService(rango(req));
    res.json(toPlain(data));
  } catch (e) {
    next(e);
  }
};

export const repPublicacionesVsIntercambiosController = async (
  req,
  res,
  next
) => {
  try {
    const data = await repPublicacionesVsIntercambiosService(rango(req));
    res.json(toPlain(data));
  } catch (e) {
    next(e);
  }
};

export const repImpactoAcumuladoController = async (req, res, next) => {
  try {
    const { id_tipo_reporte, id_periodo } = req.query;

    // Asegurar números (o null)
    const tipoReporte = id_tipo_reporte ? parseInt(id_tipo_reporte, 10) : null;
    const periodo     = id_periodo ? parseInt(id_periodo, 10) : null;

    const data = await repImpactoAcumuladoService(tipoReporte, periodo);
    res.json(data);
  } catch (e) {
    next(e);
  }
};

export const rankingUsuariosController = async (req, res, next) => {
  try {
    const idPeriodo = req.query.id_periodo
      ? parseInt(req.query.id_periodo, 10)
      : null;
    const limit = req.query.limit ? parseInt(req.query.limit, 10) : null;

    const data = await rankingUsuariosService(idPeriodo, limit);
    res.json(toPlain(data));
  } catch (e) {
    next(e);
  }
};
</file>

</files>
